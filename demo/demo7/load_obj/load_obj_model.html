<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>load obj model</title>
    <script src="/DYEngine/dist/dy.innerLib.js" type="text/javascript"></script>
    <script src="/DYEngine/dist/dy.debug.js" type="text/javascript"></script>
    <script src="/DYEngine/bower_components/jquery/dist/jquery.js" type="text/javascript"></script>
</head>
<body>

<canvas id="canvas" width="600" height="400"></canvas>

<script>
    window.onload = function () {
        dy.Main.setConfig({
            canvasId: "canvas"
        });

        dy.LoaderManager.getInstance().load([
//            {url: "../../res/1.jpg", id:"texture"},
//            {url: "../../res/crate.gif", id:"ground"},
            {url: "../../res/model/butterfly.obj", id:"model"}
//            {url: "../../res/model/dodge-viper-gts-obj/dodge-viper-gts.obj", id:"model"}
//            {url: "../../res/model/cube.obj", id:"model"}

        ]).subscribe(null, function(e){
            throw e;
        },
                function(){
                    init();
                });

        function init() {
            _initScene();
        }
        var directionLightComponent = dy.DirectionLight.create();
        var directionLight;

        function _initScene() {
            var director = dy.Director.getInstance();

            director.renderer.setClearColor(dy.Color.create("#aaaaff"));



            var model = dy.OBJLoader.getInstance().get("model");


            model.transform.scale = dy.Vector3.create(140, 140, 140);



            model.findChildrenByName("wing")
                    .forEach(function(wing){
                        var wingMaterial = wing.getComponent(dy.Geometry).material;
                        wingMaterial.cullMode = dy.CullMode.NONE;
//                        wingMaterial.blendSrc = dy.BlendFunc.SRC_ALPHA;
//                        wingMaterial.blendDst = dy.BlendFunc.ONE;

                        wingMaterial.blendFuncSeparate = [dy.BlendFunc.SRC_ALPHA, dy.BlendFunc.ONE_MINUS_SRC_ALPHA, dy.BlendFunc.ONE, dy.BlendFunc.ONE_MINUS_SRC_ALPHA];
                    });



            var action = dy.RepeatForever.create(dy.CallFunc.create(function(){
                model.transform.rotate(0, 1, 0);
            }));


            model.transform.rotate(0, 0, 0);

            model.addComponent(action);



                    director.stage.addChild(model);





//            director.stage.addChild(model);

//            var loader = new THREE.OBJMTLLoader();
//            loader.load( 'obj/male02/male02.obj', function ( object ) {
//
//                object.position.y = - 80;
//                scene.add( object );
//
//            }, onProgress, onError );







            var ambientLightComponent = dy.AmbientLight.create();
            ambientLightComponent.color = dy.Color.create("#444444");

            var ambientLight = dy.GameObject.create();
            ambientLight.addComponent(ambientLightComponent);




            directionLightComponent.color = dy.Color.create("#ffffff");
            directionLightComponent.intensity = 2;





            directionLight = dy.GameObject.create();
            directionLight.addComponent(directionLightComponent);


            directionLight.transform.translate(30, 30, 0);






//           console.log(
//                   dy.Matrix4.create(
//                    [ 140.0000000,  0.000000000,  0.000000000,  0.000000000,
//                        0.000000000,  140.0000000,  0.000000000,  0.000000000,
//                        0.000000000,  0.000000000,  140.0000000,  0.000000000,
//                        0.000000000,  0.000000000,  0.000000000,  1.000000000 ]
////            ).invert().transpose()
//           ).invertTo3x3().transpose()
//
////                   dy.Matrix3.create(
////                           [ 1.586032901,  0.000000000,  0.007142857,
////                               0.000000000,  0.007142857,  0.000000000,
////                               -0.007142857,  0.000000000,  1.586032901 ]
////                   )
//
////                           dy.Matrix3.create(
////                           [ 1.586032901,  0.000000000,  0.007142857,
////                           0.000000000,  0.007142857,  0.000000000,
////                           -0.007142857,  0.000000000,  1.586032901 ]
////                           )
//
//
////                           .multiplyVector4(
//                           .multiplyVector3(
//                                   dy.Vector3.create(
//                                           -0.39,-0.66, 0.63
////                                   ).toVector4()
//                           )
//                           )
////                           .toVector3()
//                           .values
//           );



            console.log(
                    dy.Matrix4.create(
                            [ 140.0000000,  0.000000000,  0.000000000,  0.000000000,
                                0.000000000,  140.0000000,  0.000000000,  0.000000000,
                                0.000000000,  0.000000000,  140.0000000,  0.000000000,
                                0.000000000,  0.000000000,  0.000000000,  1.000000000 ]


//                                    [0, 0, 140, 0,
//                                        0, 140, 0, 0,
//                                        -140, 0, 0, 0,
//                                        0, 0, -30, 1]
//            ).invert().transpose()
//                    ).invertTo3x3().transpose()
            )
                            .applyMatrix(dy.Matrix4.create(
//
                            [ 0,  0.000000000,  1.000000000,  0.000000000,
                            0.000000000,  1.000000000,  0.000000000,  0.000000000,
                            -1.000000000,  0.000000000,  0,  0.000000000,
                            0,  0.000000000, -30.00000000,  1.000000000 ]
                            ))
                            .invert().transpose()
//
//                            .invertTo3x3().transpose()
                            .values
            )

//            0.0071428571827709675, 0, 0,
//                    0, 0.0071428571827709675, 0,
//                    0, 0, 0.0071428571827709675

//            mine: [-0.0027857141103595495, -0.004714285954833031, 0.0044999998062849045]


//            three: -0.6230528354644775, -0.004714285954833031, 0.9964150190353394


//            v_normal = vec3(u_normalMatrix * vec4(a_normal, 1.0));



//            var pointLightComponent = dy.PointLight.create();
//            pointLightComponent.color = dy.Color.create("#ffffff");
//            pointLightComponent.intensity = 2;
//            pointLightComponent.rangeLevel = 10;
//
//            var pointLight = dy.GameObject.create();
//            pointLight.addComponent(pointLightComponent);
//
//
//            pointLight.transform.translate(dy.Vector3.create(-0, 40, 30));



//            director.stage.addChild(ambientLight);
            director.stage.addChild(directionLight);
//            director.stage.addChild(pointLight);













            director.stage.addChild(_createCamera());




            director.stage.addComponent(dy.Script.create("../stage.js"));



            director.start();
        }

        function _createCamera() {
            //make camera to be the same as shadowMapCamera(DirectionLight) for testing

//            var pos = directionLight.transform.position;



            var camera = dy.GameObject.create();

            var cameraComponent = dy.PerspectiveCamera.create();


            cameraComponent.fovy = 45;
            cameraComponent.aspect = canvas.width / canvas.height;
//            cameraComponent.aspect = 1.0;
            cameraComponent.near = 0.1;
            cameraComponent.far = 1000;


            camera.addComponent(cameraComponent);

//            camera.transform.translate(dy.Vector3.create(30, 40, 50));
            camera.transform.translate(dy.Vector3.create(30, 0, 0));
//            camera.transform.lookAt(0, 10, 0);
            camera.transform.lookAt(0, 0, 0);




            var script = dy.Script.create();

            script.url = "../camera.js";

            camera.addComponent(script);

            return camera;
        }

    };
</script>
</body>
</html>
