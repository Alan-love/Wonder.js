<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>仿射变幻</title>

    <script src="/project/dist/Engine.js" type="text/javascript"></script>
    <script src="/project/bower_components/jquery/dist/jquery.js" type="text/javascript"></script>
</head>
<body>
<canvas id="canvas" width="600" height="400"></canvas>

<script>
    window.onload = function(){
        var camera = null,
                scene = null;
        //todo add Event class
        var keyState = {};
        //todo move to Camera
        var isRotate = false;

        Engine3D.LoaderManager.getInstance().load([
            {url:"../vertex.glsl", id:"vs"},
            {url:"../fragment.glsl", id:"fs"}
        ]);

        function init(){
            _initContext();
            _initScene();

        }

        function _initContext(){
            Engine3D.WebGLContext.createGL("canvas");
        }

        function _initScene(){
            var geometry = null;

            camera = _createCamera();

            scene = Engine3D.Scene.create(camera,
                    Engine3D.GLSLLoader.getInstance().getGLSL("vs"),
                    Engine3D.GLSLLoader.getInstance().getGLSL("fs"));

            scene.onEnter = function(){
                bindCanvasEvent(Engine3D.WebGLContext.canvas, this.camera);
            };

            scene.onEndLoop = function(){
                setAllFalse();
                isRotate = false;
            };


            var material = Engine3D.MeshMaterial.create( { color: "#FFCDff"} );
            geometry = Engine3D.BoxGeometry.create(5, 5, 5, material);
//            geometry = Engine3D.TriangleGeometry.create(5, 5, material);
//            geometry = Engine3D.RectGeometry.create(5, 5, material);
//            geometry = Engine3D.SphereGeometry.create(5, Engine3D.SphereDrawMode.LATITUDELONGTITUDE, 20, material);

            var mesh = Engine3D.Mesh.create(geometry);

            var rotateAction = Engine3D.Rotate.create(
                    mesh.matrix, {
                        speed: 0.5,
                        axis: [Engine3D.Vector3.create(0, 1, 0)]
                    }
            );

            mesh.runAction(rotateAction);

            scene.add(mesh);


            var director = Engine3D.Director.getInstance();

            //can set renderer
//            digeometryor.renderer

            director.runWithScene(scene);
        }

        function _createCamera(){
            var camera = Engine3D.Camera.create({
                        eyeX: 0.0,
                        eyeY: 0.0,
                        eyeZ: 10.0,
                        centerX:0,
                        centerY:0,
                        centerZ: -1,
                        upX:0,
                        upY: 1,
                        upZ: 0
                    },
                    {
                        angle: 60,
                        aspect : canvas.width / canvas.height,
                        near : 0.1,
                        far : 100
                    });

            camera.onStartLoop = function(){
                move(this);
                if(isRotate){
                    this.rotate();
                }
                zoom(this);
            };

            return camera;
        }


        function move(camera){
            if(keyState["a"]){
                camera.moveLeft();
            }
            else if(keyState["d"]){
                camera.moveRight();
            }
            else if(keyState["w"]){
                camera.moveFront();
            }
            else if(keyState["s"]){
                camera.moveBack();
            }
        }

        function zoom(camera){
            if(keyState["g"]){
                camera.zoomOut();
            }
            else if(keyState["h"]){
                camera.zoomIn();
            }
        }


        function setAllFalse(){
            var i = null;

            for(i in keyState){
                if(keyState.hasOwnProperty(i)){
                    keyState[i] = false;
                }
            }
        }
        function bindCanvasEvent(canvas, camera) {
            var dragging = false;         // Dragging or not
            var lastX = -1, lastY = -1;   // Last position of the mouse

            canvas.onmousedown = function(ev) {   // Mouse is pressed
                var x = ev.clientX, y = ev.clientY;
                // Start dragging if a moue is in <canvas>
                var rect = ev.target.getBoundingClientRect();
                if (rect.left <= x && x < rect.right && rect.top <= y && y < rect.bottom) {
                    lastX = x; lastY = y;
                    dragging = true;
                }
            };

            canvas.onmouseup = function(ev) { dragging = false;  }; // Mouse is released

            canvas.onmousemove = function(ev) { // Mouse is moved
                var x = ev.clientX, y = ev.clientY;
                if (dragging) {
                    var factor = 100/canvas.height; // The rotation ratio
                    var dx = factor * (x - lastX);
                    var dy = factor * (y - lastY);

                    //此处为针对视图坐标系的角度变换！
                    camera.rotateStepY = -dx;
                    camera.rotateStepX = -dy;


                    isRotate = true;
                }
                lastX = x;
                lastY = y;
            };

            //todo 使用引擎的key模块来重构

            $("body").on("keydown", function(event){
                var keyCode = {
                    65: "a",
                    87: "w",
                    83: "s",
                    68: "d",
                    71: "g",
                    72: "h"
                };

                setAllFalse();

                keyState[keyCode[event.keyCode]] = true;
            });
        }


        Engine3D.LoaderManager.getInstance().onload = function(){
            init();
        };
    };
</script>
</body>
</html>
