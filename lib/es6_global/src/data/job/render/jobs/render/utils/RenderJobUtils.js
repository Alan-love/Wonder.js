// Generated by BUCKLESCRIPT VERSION 2.1.0, PLEASE EDIT WITH CARE
'use strict';

import * as Log$WonderLog                             from "../../../../../../../../../node_modules/wonder-log/lib/es6_global/src/Log.js";
import * as ArraySystem$Wonderjs                      from "../../../../../../structure/ArraySystem.js";
import * as GeometryAdmin$Wonderjs                    from "../../../../../../ecs/admin/component/GeometryAdmin.js";
import * as ProgramSystem$Wonderjs                    from "../../../../../../renderer/shader/program/ProgramSystem.js";
import * as GameObjectAdmin$Wonderjs                  from "../../../../../../ecs/admin/GameObjectAdmin.js";
import * as GLSLSenderSystem$Wonderjs                 from "../../../../../../renderer/shader/sender/GLSLSenderSystem.js";
import * as ArrayBufferSystem$Wonderjs                from "../../../../../../renderer/buffer/ArrayBufferSystem.js";
import * as ElementArrayBufferSystem$Wonderjs         from "../../../../../../renderer/buffer/ElementArrayBufferSystem.js";
import * as VboBufferGetStateDataUtils$Wonderjs       from "../../../../../../renderer/buffer/VboBufferGetStateDataUtils.js";
import * as GLSLSenderConfigDataHandleSystem$Wonderjs from "../../../../../../renderer/shader/sender/GLSLSenderConfigDataHandleSystem.js";

function _directlySendAttributeData(gl, shaderIndex, geometryIndex, state) {
  var match = VboBufferGetStateDataUtils$Wonderjs.getVboBufferData(state);
  var elementArrayBufferMap = match[/* elementArrayBufferMap */2];
  var normalBufferMap = match[/* normalBufferMap */1];
  var vertexBufferMap = match[/* vertexBufferMap */0];
  return ArraySystem$Wonderjs.reduceState((function (state, param) {
                var buffer = param[/* buffer */2];
                var arrayBuffer;
                switch (buffer) {
                  case "index" : 
                      arrayBuffer = ElementArrayBufferSystem$Wonderjs.getOrCreateBuffer(gl, /* tuple */[
                            geometryIndex,
                            elementArrayBufferMap
                          ], GeometryAdmin$Wonderjs.unsafeGetIndices, state);
                      break;
                  case "normal" : 
                      arrayBuffer = ArrayBufferSystem$Wonderjs.getOrCreateBuffer(gl, /* tuple */[
                            geometryIndex,
                            normalBufferMap
                          ], GeometryAdmin$Wonderjs.unsafeGetNormals, state);
                      break;
                  case "vertex" : 
                      arrayBuffer = ArrayBufferSystem$Wonderjs.getOrCreateBuffer(gl, /* tuple */[
                            geometryIndex,
                            vertexBufferMap
                          ], GeometryAdmin$Wonderjs.unsafeGetVertices, state);
                      break;
                  default:
                    arrayBuffer = Log$WonderLog.fatal(Log$WonderLog.buildFatalMessage("_sendAttributeData", "unknonw buffer: " + (String(buffer) + ""), "", "", ""));
                }
                return param[/* sendFunc */3](gl, /* tuple */[
                            param[/* size */1],
                            param[/* pos */0]
                          ], arrayBuffer, state);
              }), state, GLSLSenderConfigDataHandleSystem$Wonderjs.unsafeGetAttributeSendData(shaderIndex, state));
}

function _sendAttributeData(gl, shaderIndex, geometryIndex, state) {
  var data = GLSLSenderSystem$Wonderjs.getGLSLSenderData(state);
  var lastSendGeometry = data[/* lastSendGeometry */11];
  var exit = 0;
  if (lastSendGeometry) {
    if (lastSendGeometry[0] === geometryIndex) {
      return state;
    } else {
      exit = 1;
    }
  } else {
    exit = 1;
  }
  if (exit === 1) {
    data[/* lastSendGeometry */11] = /* Some */[geometryIndex];
    return _directlySendAttributeData(gl, shaderIndex, geometryIndex, state);
  }
  
}

function _sendUniformRenderObjectModelData(gl, shaderIndex, transformIndex, state) {
  return ArraySystem$Wonderjs.reduceState((function (state, param) {
                param[/* sendDataFunc */2](gl, param[/* pos */0], param[/* getDataFunc */1](transformIndex, state));
                return state;
              }), state, GLSLSenderConfigDataHandleSystem$Wonderjs.unsafeGetUniformRenderObjectSendModelData(shaderIndex, state));
}

function _sendUniformRenderObjectMaterialData(gl, shaderIndex, materialIndex, state) {
  return ArraySystem$Wonderjs.reduceState((function (state, param) {
                param[/* sendDataFunc */4](gl, param[/* shaderCacheMap */0], /* tuple */[
                      param[/* name */1],
                      param[/* pos */2]
                    ], param[/* getDataFunc */3](materialIndex, state));
                return state;
              }), state, GLSLSenderConfigDataHandleSystem$Wonderjs.unsafeGetUniformRenderObjectSendMaterialData(shaderIndex, state));
}

function render(gl, param, state) {
  var uid = param[2];
  var shaderIndex = param[1];
  var materialIndex = param[0];
  var transformIndex = GameObjectAdmin$Wonderjs.unsafeGetTransformComponent(uid, state);
  var geometryIndex = GameObjectAdmin$Wonderjs.unsafeGetGeometryComponent(uid, state);
  var program = ProgramSystem$Wonderjs.unsafeGetProgram(shaderIndex, state);
  var state$1 = _sendUniformRenderObjectModelData(gl, shaderIndex, transformIndex, _sendAttributeData(gl, shaderIndex, geometryIndex, ProgramSystem$Wonderjs.use(gl, program, state)));
  var data = GLSLSenderSystem$Wonderjs.getGLSLSenderData(state$1);
  var lastSendMaterial = data[/* lastSendMaterial */10];
  var state$2;
  var exit = 0;
  if (lastSendMaterial && lastSendMaterial[0] === materialIndex) {
    state$2 = state$1;
  } else {
    exit = 1;
  }
  if (exit === 1) {
    data[/* lastSendMaterial */10] = /* Some */[materialIndex];
    state$2 = _sendUniformRenderObjectMaterialData(gl, shaderIndex, materialIndex, state$1);
  }
  return /* tuple */[
          state$2,
          shaderIndex,
          geometryIndex
        ];
}

export {
  _directlySendAttributeData           ,
  _sendAttributeData                   ,
  _sendUniformRenderObjectModelData    ,
  _sendUniformRenderObjectMaterialData ,
  render                               ,
  
}
/* Log-WonderLog Not a pure module */
