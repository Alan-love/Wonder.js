// Generated by BUCKLESCRIPT VERSION 2.1.0, PLEASE EDIT WITH CARE
'use strict';

import * as Curry                                     from "../../../../../node_modules/bs-platform/lib/es6/curry.js";
import * as Js_option                                 from "../../../../../node_modules/bs-platform/lib/es6/js_option.js";
import * as Caml_array                                from "../../../../../node_modules/bs-platform/lib/es6/caml_array.js";
import * as Contract$Wonderjs                         from "../../definition/Contract.js";
import * as ArraySystem$Wonderjs                      from "../../structure/ArraySystem.js";
import * as MemoryUtils$Wonderjs                      from "../../memory/MemoryUtils.js";
import * as MaterialAdmin$Wonderjs                    from "./component/material/MaterialAdmin.js";
import * as GeometryHelper$Wonderjs                   from "../component/data/geometry/GeometryHelper.js";
import * as GeometrySystem$Wonderjs                   from "../component/system/geometry/GeometrySystem.js";
import * as MaterialSystem$Wonderjs                   from "../component/system/material/MaterialSystem.js";
import * as CpuMemorySystem$Wonderjs                  from "../../memory/CpuMemorySystem.js";
import * as ECSDisposeUtils$Wonderjs                  from "../utils/ECSDisposeUtils.js";
import * as TransformHelper$Wonderjs                  from "../component/data/transform/TransformHelper.js";
import * as TransformSystem$Wonderjs                  from "../component/system/transform/TransformSystem.js";
import * as DeviceManagerSystem$Wonderjs              from "../../renderer/device/DeviceManagerSystem.js";
import * as GameObjectStateCommon$Wonderjs            from "./GameObjectStateCommon.js";
import * as CameraControllerSystem$Wonderjs           from "../component/system/cameraController/CameraControllerSystem.js";
import * as GameObjectCreateCommon$Wonderjs           from "./GameObjectCreateCommon.js";
import * as SparseMapSystem$WonderCommonlib           from "../../../../../node_modules/wonder-commonlib/lib/es6_global/src/SparseMapSystem.js";
import * as GameObjectAddComponentCommon$Wonderjs     from "./GameObjectAddComponentCommon.js";
import * as GameObjectGetComponentCommon$Wonderjs     from "./GameObjectGetComponentCommon.js";
import * as GameObjectHasComponentCommon$Wonderjs     from "./GameObjectHasComponentCommon.js";
import * as GameObjectCloneComponentCommon$Wonderjs   from "./GameObjectCloneComponentCommon.js";
import * as GameObjectDisposeComponentCommon$Wonderjs from "./GameObjectDisposeComponentCommon.js";

function init(state) {
  return GeometrySystem$Wonderjs.init(CameraControllerSystem$Wonderjs.init(state));
}

function initDataFromState(state) {
  return GeometryHelper$Wonderjs.initData(MaterialAdmin$Wonderjs.initData(TransformHelper$Wonderjs.initData(state)));
}

function update(_, state) {
  return CameraControllerSystem$Wonderjs.update(state);
}

function create(state) {
  var match = GameObjectCreateCommon$Wonderjs.create(state);
  var uid = match[1];
  var match$1 = TransformSystem$Wonderjs.create(match[0]);
  return /* tuple */[
          GameObjectAddComponentCommon$Wonderjs.addTransformComponent(uid, match$1[1], match$1[0]),
          uid
        ];
}

function _handleByDisposeCount(data, state) {
  if (MemoryUtils$Wonderjs.isDisposeTooMany(data[/* disposeCount */1], state)) {
    data[/* disposeCount */1] = 0;
    return CpuMemorySystem$Wonderjs.reAllocateGameObject(state);
  } else {
    return state;
  }
}

function _batchDisposeCommonComponent(uidArray, disposedUidMap, state) {
  return GameObjectDisposeComponentCommon$Wonderjs.batchDisposeObjectInstanceComponent(disposedUidMap, state, GameObjectGetComponentCommon$Wonderjs.batchGetObjectInstanceComponent(uidArray, GameObjectDisposeComponentCommon$Wonderjs.batchDisposeCameraControllerComponent(disposedUidMap, state, GameObjectGetComponentCommon$Wonderjs.batchGetCameraControllerComponent(uidArray, GameObjectDisposeComponentCommon$Wonderjs.batchDisposeGeometryComponent(disposedUidMap, state, GameObjectGetComponentCommon$Wonderjs.batchGetGeometryComponent(uidArray, GameObjectDisposeComponentCommon$Wonderjs.batchDisposeMaterialComponent(disposedUidMap, state, GameObjectGetComponentCommon$Wonderjs.batchGetMaterialComponent(uidArray, GameObjectDisposeComponentCommon$Wonderjs.batchDisposeTransformComponent(disposedUidMap, state, GameObjectGetComponentCommon$Wonderjs.batchGetTransformComponent(uidArray, GameObjectDisposeComponentCommon$Wonderjs.batchDisposeMeshRendererComponent(disposedUidMap, state, GameObjectGetComponentCommon$Wonderjs.batchGetMeshRendererComponent(uidArray, state))))))))))));
}

function batchDispose(uidArray, state) {
  var data = GameObjectStateCommon$Wonderjs.getGameObjectData(state);
  var disposeCount = data[/* disposeCount */1];
  var disposedUidMap = data[/* disposedUidMap */2];
  var disposedUidMap$1 = ECSDisposeUtils$Wonderjs.buildMapFromArray(uidArray, disposedUidMap);
  data[/* disposeCount */1] = disposeCount + uidArray.length | 0;
  return _handleByDisposeCount(data, GameObjectDisposeComponentCommon$Wonderjs.batchDisposeSourceInstanceComponent(disposedUidMap$1, state, batchDispose, GameObjectGetComponentCommon$Wonderjs.batchGetSourceInstanceComponent(uidArray, _batchDisposeCommonComponent(uidArray, disposedUidMap$1, state))));
}

function _disposeComponent(uid, state) {
  var match = GameObjectGetComponentCommon$Wonderjs.getTransformComponent(uid, state);
  var state$1 = match ? GameObjectDisposeComponentCommon$Wonderjs.disposeTransformComponent(uid, match[0], state) : state;
  var match$1 = GameObjectGetComponentCommon$Wonderjs.getMeshRendererComponent(uid, state$1);
  var state$2 = match$1 ? GameObjectDisposeComponentCommon$Wonderjs.disposeMeshRendererComponent(uid, match$1[0], state$1) : state$1;
  var match$2 = GameObjectGetComponentCommon$Wonderjs.getMaterialComponent(uid, state$2);
  var state$3 = match$2 ? GameObjectDisposeComponentCommon$Wonderjs.disposeMaterialComponent(uid, match$2[0], state$2) : state$2;
  var match$3 = GameObjectGetComponentCommon$Wonderjs.getGeometryComponent(uid, state$3);
  var state$4 = match$3 ? GameObjectDisposeComponentCommon$Wonderjs.disposeGeometryComponent(uid, match$3[0], state$3) : state$3;
  var match$4 = GameObjectGetComponentCommon$Wonderjs.getCameraControllerComponent(uid, state$4);
  var state$5 = match$4 ? GameObjectDisposeComponentCommon$Wonderjs.disposeCameraControllerComponent(uid, match$4[0], state$4) : state$4;
  var match$5 = GameObjectGetComponentCommon$Wonderjs.getSourceInstanceComponent(uid, state$5);
  var state$6 = match$5 ? GameObjectDisposeComponentCommon$Wonderjs.disposeSourceInstanceComponent(uid, match$5[0], batchDispose, state$5) : state$5;
  var match$6 = GameObjectGetComponentCommon$Wonderjs.getObjectInstanceComponent(uid, state$6);
  if (match$6) {
    return GameObjectDisposeComponentCommon$Wonderjs.disposeObjectInstanceComponent(uid, match$6[0], state$6);
  } else {
    return state$6;
  }
}

function dispose(uid, state) {
  var data = GameObjectStateCommon$Wonderjs.getGameObjectData(state);
  var disposeCount = data[/* disposeCount */1];
  var disposedUidMap = data[/* disposedUidMap */2];
  data[/* disposeCount */1] = disposeCount + 1 | 0;
  SparseMapSystem$WonderCommonlib.set(uid, /* true */1, disposedUidMap);
  return _handleByDisposeCount(data, _disposeComponent(uid, state));
}

function _checkForClone(uid, state) {
  return Contract$Wonderjs.requireCheck((function () {
                Contract$Wonderjs.test("shouldn't clone sourceInstance gameObject", (function () {
                        return Contract$Wonderjs.assertFalse(GameObjectHasComponentCommon$Wonderjs.hasSourceInstanceComponent(uid, state));
                      }));
                return Contract$Wonderjs.test("shouldn't clone objectInstance gameObject", (function () {
                              return Contract$Wonderjs.assertFalse(GameObjectHasComponentCommon$Wonderjs.hasObjectInstanceComponent(uid, state));
                            }));
              }));
}

function _cloneComponent(param, param$1, state) {
  var component = param[1];
  if (component) {
    var match = Curry._3(param$1[0], component[0], param[2], state);
    return Curry._3(param$1[1], param[3], match[1], match[0]);
  } else {
    return state;
  }
}

function _clone(param, isShareMaterial, state) {
  var countRangeArr = param[2];
  var transform = param[1];
  var uid = param[0];
  var match = ArraySystem$Wonderjs.reduceOneParam((function (param, _) {
          var match = GameObjectCreateCommon$Wonderjs.create(param[0]);
          return /* tuple */[
                  match[0],
                  ArraySystem$Wonderjs.push(match[1], param[1])
                ];
        }), /* tuple */[
        state,
        /* int array */[]
      ], countRangeArr);
  var clonedGameObjectArr = match[1];
  var state$1 = match[0];
  var totalClonedGameObjectArr = ArraySystem$Wonderjs.push(clonedGameObjectArr, param[4]);
  var match$1 = GameObjectCloneComponentCommon$Wonderjs.cloneTransformComponent(transform, countRangeArr, _cloneComponent(/* tuple */[
            uid,
            GameObjectGetComponentCommon$Wonderjs.getCameraControllerComponent(uid, state$1),
            countRangeArr,
            clonedGameObjectArr
          ], /* tuple */[
            GameObjectCloneComponentCommon$Wonderjs.cloneCameraControllerComponent,
            GameObjectAddComponentCommon$Wonderjs.batchAddCameraControllerComponentForClone
          ], _cloneComponent(/* tuple */[
                uid,
                GameObjectGetComponentCommon$Wonderjs.getMaterialComponent(uid, state$1),
                countRangeArr,
                clonedGameObjectArr
              ], /* tuple */[
                (function (param, param$1, param$2) {
                    return GameObjectCloneComponentCommon$Wonderjs.cloneMaterialComponent(isShareMaterial, param, param$1, param$2);
                  }),
                (function (param, param$1, param$2) {
                    return GameObjectAddComponentCommon$Wonderjs.batchAddMaterialComponentForClone(isShareMaterial, param, param$1, param$2);
                  })
              ], _cloneComponent(/* tuple */[
                    uid,
                    GameObjectGetComponentCommon$Wonderjs.getGeometryComponent(uid, state$1),
                    countRangeArr,
                    clonedGameObjectArr
                  ], /* tuple */[
                    GameObjectCloneComponentCommon$Wonderjs.cloneGeometryComponent,
                    GameObjectAddComponentCommon$Wonderjs.batchAddGeometryComponentForClone
                  ], _cloneComponent(/* tuple */[
                        uid,
                        GameObjectGetComponentCommon$Wonderjs.getMeshRendererComponent(uid, state$1),
                        countRangeArr,
                        clonedGameObjectArr
                      ], /* tuple */[
                        GameObjectCloneComponentCommon$Wonderjs.cloneMeshRendererComponent,
                        GameObjectAddComponentCommon$Wonderjs.batchAddMeshRendererComponentForClone
                      ], state$1)))));
  var clonedTransformArr = match$1[1];
  var state$2 = GameObjectAddComponentCommon$Wonderjs.batchAddTransformComponentForClone(clonedGameObjectArr, clonedTransformArr, match$1[0]);
  ArraySystem$Wonderjs.reduceState((function (state, childTransform) {
          return _clone(/* tuple */[
                      Js_option.getExn(TransformSystem$Wonderjs.getGameObject(childTransform, state)),
                      childTransform,
                      countRangeArr,
                      clonedTransformArr,
                      totalClonedGameObjectArr
                    ], isShareMaterial, state);
        }), state$2, TransformSystem$Wonderjs.unsafeGetChildren(transform, ArraySystem$Wonderjs.reduceOneParami((function (transformData, clonedParentTransform, i) {
                  return TransformSystem$Wonderjs.setParentNotMarkDirty(/* Some */[clonedParentTransform], Caml_array.caml_array_get(clonedTransformArr, i), transformData);
                }), TransformSystem$Wonderjs.getTransformData(state$2), param[3])));
  return state$2;
}

function clone(uid, count, isShareMaterial, state) {
  _checkForClone(uid, state);
  var totalClonedGameObjectArr = /* array */[];
  return /* tuple */[
          _clone(/* tuple */[
                uid,
                Js_option.getExn(GameObjectGetComponentCommon$Wonderjs.getTransformComponent(uid, state)),
                ArraySystem$Wonderjs.range(0, count - 1 | 0),
                /* int array */[],
                totalClonedGameObjectArr
              ], isShareMaterial, state),
          totalClonedGameObjectArr
        ];
}

function isAlive(uid, state) {
  var match = GameObjectStateCommon$Wonderjs.getGameObjectData(state);
  var disposedUidMap = match[/* disposedUidMap */2];
  var transformMap = match[/* transformMap */4];
  var match$1 = SparseMapSystem$WonderCommonlib.has(uid, disposedUidMap);
  if (match$1 !== 0) {
    return /* false */0;
  } else {
    var match$2 = SparseMapSystem$WonderCommonlib.has(uid, transformMap);
    if (match$2 !== 0) {
      return /* true */1;
    } else {
      return /* false */0;
    }
  }
}

function initGameObject(uid, state) {
  var match = GameObjectGetComponentCommon$Wonderjs.getGeometryComponent(uid, state);
  var state$1 = match ? GeometrySystem$Wonderjs.handleInitComponent(match[0], state) : state;
  var match$1 = GameObjectGetComponentCommon$Wonderjs.getMaterialComponent(uid, state$1);
  if (match$1) {
    return MaterialSystem$Wonderjs.handleInitComponent(DeviceManagerSystem$Wonderjs.getGl(state$1), match$1[0], state$1);
  } else {
    return state$1;
  }
}

var hasSourceInstanceComponent = GameObjectHasComponentCommon$Wonderjs.hasSourceInstanceComponent;

var getSourceInstanceComponent = GameObjectGetComponentCommon$Wonderjs.getSourceInstanceComponent;

var addSourceInstanceComponent = GameObjectAddComponentCommon$Wonderjs.addSourceInstanceComponent;

var disposeSourceInstanceComponent = GameObjectDisposeComponentCommon$Wonderjs.disposeSourceInstanceComponent;

var hasObjectInstanceComponent = GameObjectHasComponentCommon$Wonderjs.hasObjectInstanceComponent;

var getObjectInstanceComponent = GameObjectGetComponentCommon$Wonderjs.getObjectInstanceComponent;

var addObjectInstanceComponent = GameObjectAddComponentCommon$Wonderjs.addObjectInstanceComponent;

var disposeObjectInstanceComponent = GameObjectDisposeComponentCommon$Wonderjs.disposeObjectInstanceComponent;

var hasCameraControllerComponent = GameObjectHasComponentCommon$Wonderjs.hasCameraControllerComponent;

var getCameraControllerComponent = GameObjectGetComponentCommon$Wonderjs.getCameraControllerComponent;

var addCameraControllerComponent = GameObjectAddComponentCommon$Wonderjs.addCameraControllerComponent;

var disposeCameraControllerComponent = GameObjectDisposeComponentCommon$Wonderjs.disposeCameraControllerComponent;

var hasTransformComponent = GameObjectHasComponentCommon$Wonderjs.hasTransformComponent;

var getTransformComponent = GameObjectGetComponentCommon$Wonderjs.getTransformComponent;

var unsafeGetTransformComponent = GameObjectGetComponentCommon$Wonderjs.unsafeGetTransformComponent;

var addTransformComponent = GameObjectAddComponentCommon$Wonderjs.addTransformComponent;

var disposeTransformComponent = GameObjectDisposeComponentCommon$Wonderjs.disposeTransformComponent;

var hasGeometryComponent = GameObjectHasComponentCommon$Wonderjs.hasGeometryComponent;

var getGeometryComponent = GameObjectGetComponentCommon$Wonderjs.getGeometryComponent;

var unsafeGetGeometryComponent = GameObjectGetComponentCommon$Wonderjs.unsafeGetGeometryComponent;

var addGeometryComponent = GameObjectAddComponentCommon$Wonderjs.addGeometryComponent;

var disposeGeometryComponent = GameObjectDisposeComponentCommon$Wonderjs.disposeGeometryComponent;

var hasMeshRendererComponent = GameObjectHasComponentCommon$Wonderjs.hasMeshRendererComponent;

var getMeshRendererComponent = GameObjectGetComponentCommon$Wonderjs.getMeshRendererComponent;

var addMeshRendererComponent = GameObjectAddComponentCommon$Wonderjs.addMeshRendererComponent;

var disposeMeshRendererComponent = GameObjectDisposeComponentCommon$Wonderjs.disposeMeshRendererComponent;

var hasMaterialComponent = GameObjectHasComponentCommon$Wonderjs.hasMaterialComponent;

var getMaterialComponent = GameObjectGetComponentCommon$Wonderjs.getMaterialComponent;

var unsafeGetMaterialComponent = GameObjectGetComponentCommon$Wonderjs.unsafeGetMaterialComponent;

var addMaterialComponent = GameObjectAddComponentCommon$Wonderjs.addMaterialComponent;

var disposeMaterialComponent = GameObjectDisposeComponentCommon$Wonderjs.disposeMaterialComponent;

var deepCopyStateForRestore = GameObjectStateCommon$Wonderjs.deepCopyStateForRestore;

export {
  init                             ,
  initDataFromState                ,
  update                           ,
  hasSourceInstanceComponent       ,
  getSourceInstanceComponent       ,
  addSourceInstanceComponent       ,
  disposeSourceInstanceComponent   ,
  hasObjectInstanceComponent       ,
  getObjectInstanceComponent       ,
  addObjectInstanceComponent       ,
  disposeObjectInstanceComponent   ,
  hasCameraControllerComponent     ,
  getCameraControllerComponent     ,
  addCameraControllerComponent     ,
  disposeCameraControllerComponent ,
  hasTransformComponent            ,
  getTransformComponent            ,
  unsafeGetTransformComponent      ,
  addTransformComponent            ,
  disposeTransformComponent        ,
  hasGeometryComponent             ,
  getGeometryComponent             ,
  unsafeGetGeometryComponent       ,
  addGeometryComponent             ,
  disposeGeometryComponent         ,
  hasMeshRendererComponent         ,
  getMeshRendererComponent         ,
  addMeshRendererComponent         ,
  disposeMeshRendererComponent     ,
  hasMaterialComponent             ,
  getMaterialComponent             ,
  unsafeGetMaterialComponent       ,
  addMaterialComponent             ,
  disposeMaterialComponent         ,
  create                           ,
  _handleByDisposeCount            ,
  _batchDisposeCommonComponent     ,
  batchDispose                     ,
  _disposeComponent                ,
  dispose                          ,
  _checkForClone                   ,
  _cloneComponent                  ,
  _clone                           ,
  clone                            ,
  isAlive                          ,
  initGameObject                   ,
  deepCopyStateForRestore          ,
  
}
/* ArraySystem-Wonderjs Not a pure module */
