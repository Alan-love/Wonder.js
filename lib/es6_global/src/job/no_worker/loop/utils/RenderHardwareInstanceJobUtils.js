// Generated by BUCKLESCRIPT VERSION 2.1.0, PLEASE EDIT WITH CARE
'use strict';

import * as Caml_int32                                        from "../../../../../../../node_modules/bs-platform/lib/es6/caml_int32.js";
import * as IndicesService$Wonderjs                           from "../../../../service/primitiive/geometry/IndicesService.js";
import * as GPUDetectService$Wonderjs                         from "../../../../service/record/gpu/GPUDetectService.js";
import * as TypeArrayService$Wonderjs                         from "../../../../service/primitiive/TypeArrayService.js";
import * as ArrayService$WonderCommonlib                      from "../../../../../../../node_modules/wonder-commonlib/lib/es6_global/src/ArrayService.js";
import * as DrawGLSLMainService$Wonderjs                      from "../../../../service/state/main/sender/DrawGLSLMainService.js";
import * as RenderGeometryService$Wonderjs                    from "../../../../service/record/geometry/RenderGeometryService.js";
import * as ReduceStateMainService$Wonderjs                   from "../../../../service/state/main/array/ReduceStateMainService.js";
import * as UpdateTransformService$Wonderjs                   from "../../../../service/record/transform/UpdateTransformService.js";
import * as SendGLSLDataMainService$Wonderjs                  from "../../../../service/state/main/sender/SendGLSLDataMainService.js";
import * as InstanceBufferMainService$Wonderjs                from "../../../../service/state/main/vboBuffer/InstanceBufferMainService.js";
import * as StaticSourceInstanceService$Wonderjs              from "../../../../service/record/instance/sourceInstance/StaticSourceInstanceService.js";
import * as GetComponentGameObjectService$Wonderjs            from "../../../../service/record/gameObject/GetComponentGameObjectService.js";
import * as HandleAttributeConfigDataMainService$Wonderjs     from "../../../../service/state/main/sender/attribute/HandleAttributeConfigDataMainService.js";
import * as ObjectInstanceArraySourceInstanceService$Wonderjs from "../../../../service/record/instance/sourceInstance/ObjectInstanceArraySourceInstanceService.js";

function _fillObjectInstanceData(objectInstanceArray, matricesArrayForInstance, fillMatrixTypeArrFunc, stateOffsetTuple) {
  return ArrayService$WonderCommonlib.reduceOneParam((function (stateOffsetTuple, objectInstance) {
                  return fillMatrixTypeArrFunc(objectInstance, matricesArrayForInstance, stateOffsetTuple);
                }), stateOffsetTuple, objectInstanceArray)[0];
}

function _sendTransformMatrixDataBuffer(param, param$1, state) {
  var match = param$1[0];
  var pos = match[/* pos */0];
  var gl = param[0];
  gl.vertexAttribPointer(pos, match[/* size */1], gl.FLOAT, false, param$1[1], match[/* getOffsetFunc */2](param$1[2]));
  param[1].vertexAttribDivisorANGLE(pos, 1);
  return SendGLSLDataMainService$Wonderjs.enableVertexAttribArray(gl, pos, state[/* glslSenderRecord */26][/* vertexAttribHistoryArray */9], state);
}

function _sendTransformMatrixDataBufferData(glDataTuple, shaderIndex, stride, state) {
  return ReduceStateMainService$Wonderjs.reduceStatei((function (state, sendData, index) {
                return _sendTransformMatrixDataBuffer(glDataTuple, /* tuple */[
                            sendData,
                            stride,
                            index
                          ], state);
              }), state, HandleAttributeConfigDataMainService$Wonderjs.unsafeGetInstanceAttributeSendData(shaderIndex, state));
}

function _updateAndSendTransformMatrixDataBufferData(glDataTuple, shaderIndex, param, state) {
  InstanceBufferMainService$Wonderjs.updateData(glDataTuple[0], param[1], param[2]);
  return _sendTransformMatrixDataBufferData(glDataTuple, shaderIndex, param[0], state);
}

function _sendTransformMatrixData(param, fillMatrixTypeArrFunc, state) {
  var match = param[2];
  var matrixFloat32ArrayMap = match[2];
  var matrixInstanceBufferMap = match[1];
  var matrixInstanceBufferCapacityMap = match[0];
  var match$1 = param[1];
  var defaultCapacity = match$1[2];
  var sourceInstance = match$1[1];
  var match$2 = param[0];
  var gl = match$2[0];
  var matrixInstanceBuffer = InstanceBufferMainService$Wonderjs.getOrCreateBuffer(/* tuple */[
        gl,
        sourceInstance,
        defaultCapacity
      ], /* tuple */[
        matrixInstanceBufferCapacityMap,
        matrixInstanceBufferMap
      ], state);
  var matricesArrayForInstance = InstanceBufferMainService$Wonderjs.getOrCreateMatrixFloat32Array(sourceInstance, defaultCapacity, /* tuple */[
        matrixInstanceBufferCapacityMap,
        matrixFloat32ArrayMap
      ], state);
  var match$3 = InstanceBufferMainService$Wonderjs.setCapacityAndUpdateBufferTypeArray(/* tuple */[
        gl,
        sourceInstance,
        Caml_int32.imul(match$1[6], match$1[3]),
        defaultCapacity
      ], /* tuple */[
        matrixInstanceBuffer,
        matricesArrayForInstance
      ], /* tuple */[
        matrixInstanceBufferMap,
        matrixFloat32ArrayMap,
        matrixInstanceBufferCapacityMap
      ], state);
  var matricesArrayForInstance$1 = match$3[1];
  return _updateAndSendTransformMatrixDataBufferData(/* tuple */[
              gl,
              match$2[1]
            ], match$2[2], /* tuple */[
              match$1[4],
              matricesArrayForInstance$1,
              match$3[0]
            ], _fillObjectInstanceData(match$1[5], matricesArrayForInstance$1, fillMatrixTypeArrFunc, fillMatrixTypeArrFunc(match$1[0], matricesArrayForInstance$1, /* tuple */[
                      state,
                      0
                    ])));
}

function _sendStaticTransformMatrixData(dataTuple, fillMatrixTypeArrFunc, state) {
  var match = dataTuple[2];
  var match$1 = dataTuple[1];
  var sourceInstance = match$1[1];
  var match$2 = dataTuple[0];
  var gl = match$2[0];
  var match$3 = StaticSourceInstanceService$Wonderjs.isSendTransformMatrixData(sourceInstance, state[/* sourceInstanceRecord */6]);
  if (match$3 !== 0) {
    InstanceBufferMainService$Wonderjs.bind(gl, InstanceBufferMainService$Wonderjs.getOrCreateBuffer(/* tuple */[
              gl,
              sourceInstance,
              match$1[2]
            ], /* tuple */[
              match[0],
              match[1]
            ], state));
    return _sendTransformMatrixDataBufferData(/* tuple */[
                gl,
                match$2[1]
              ], match$2[2], match$1[4], state);
  } else {
    var state$1 = _sendTransformMatrixData(dataTuple, fillMatrixTypeArrFunc, state);
    var newrecord = state$1.slice();
    newrecord[/* sourceInstanceRecord */6] = StaticSourceInstanceService$Wonderjs.markIsSendTransformMatrixData(sourceInstance, /* true */1, state$1[/* sourceInstanceRecord */6]);
    return newrecord;
  }
}

function _sendDynamicTransformMatrixData(dataTuple, fillMatrixTypeArrFunc, state) {
  var newrecord = state.slice();
  return _sendTransformMatrixData(dataTuple, fillMatrixTypeArrFunc, (newrecord[/* sourceInstanceRecord */6] = StaticSourceInstanceService$Wonderjs.markIsSendTransformMatrixData(dataTuple[1][1], /* false */0, state[/* sourceInstanceRecord */6]), newrecord));
}

function _geMatrixMapTuple(state) {
  var match = state[/* vboBufferRecord */30];
  var match$1 = state[/* sourceInstanceRecord */6];
  return /* tuple */[
          match$1[/* matrixInstanceBufferCapacityMap */2],
          match[/* matrixInstanceBufferMap */3],
          match$1[/* matrixFloat32ArrayMap */3]
        ];
}

function _renderSourceInstanceGameObject(gl, uid, renderFunc, state) {
  return renderFunc(gl, uid, state);
}

function _prepareData(gl, shaderIndex, param, state) {
  var uid = param[0];
  var extension = GPUDetectService$Wonderjs.unsafeGetInstanceExtension(state[/* gpuDetectRecord */5]);
  var sourceInstance = GetComponentGameObjectService$Wonderjs.unsafeGetSourceInstanceComponent(uid, state[/* gameObjectRecord */10]);
  var objectInstanceArray = ObjectInstanceArraySourceInstanceService$Wonderjs.getObjectInstanceArray(sourceInstance, state[/* sourceInstanceRecord */6]);
  var instanceRenderListCount = objectInstanceArray.length + 1 | 0;
  return /* tuple */[
          /* tuple */[
            gl,
            extension,
            shaderIndex
          ],
          /* tuple */[
            uid,
            sourceInstance,
            param[1],
            param[2],
            param[3],
            objectInstanceArray,
            instanceRenderListCount
          ],
          _geMatrixMapTuple(state)
        ];
}

function render(gl, param, param$1, state) {
  var fillMatrixTypeArrFunc = param$1[1];
  var uid = param[0];
  var match = _renderSourceInstanceGameObject(gl, uid, param$1[0], state);
  var state$1 = match[0];
  var dataTuple = _prepareData(gl, match[1], /* tuple */[
        uid,
        param[1],
        param[2],
        param[3]
      ], state$1);
  var match$1 = dataTuple[1];
  var match$2 = dataTuple[0];
  var gl$1 = match$2[0];
  var match$3 = StaticSourceInstanceService$Wonderjs.isTransformStatic(match$1[1], state$1[/* sourceInstanceRecord */6]);
  var state$2 = match$3 !== 0 ? _sendStaticTransformMatrixData(dataTuple, fillMatrixTypeArrFunc, state$1) : _sendDynamicTransformMatrixData(dataTuple, fillMatrixTypeArrFunc, state$1);
  DrawGLSLMainService$Wonderjs.drawElementsInstancedANGLE(/* tuple */[
        RenderGeometryService$Wonderjs.getDrawMode(gl$1),
        RenderGeometryService$Wonderjs.getIndexType(gl$1),
        RenderGeometryService$Wonderjs.getIndexTypeSize(gl$1),
        IndicesService$Wonderjs.getIndicesCount(match[2], state$2[/* boxGeometryRecord */20][/* indicesMap */3]),
        match$1[6]
      ], match$2[1]);
  return state$2;
}

function fillMatrixTypeArr(_, transform, matricesArrayForInstance, param) {
  var state = param[0];
  return TypeArrayService$Wonderjs.fillFloat32ArrayWithFloat32Array(/* tuple */[
              matricesArrayForInstance,
              param[1]
            ], /* tuple */[
              UpdateTransformService$Wonderjs.updateAndGetLocalToWorldMatrixTypeArray(transform, state[/* globalTempRecord */31], state[/* transformRecord */11]),
              0
            ], 16);
}

export {
  _fillObjectInstanceData                     ,
  _sendTransformMatrixDataBuffer              ,
  _sendTransformMatrixDataBufferData          ,
  _updateAndSendTransformMatrixDataBufferData ,
  _sendTransformMatrixData                    ,
  _sendStaticTransformMatrixData              ,
  _sendDynamicTransformMatrixData             ,
  _geMatrixMapTuple                           ,
  _renderSourceInstanceGameObject             ,
  _prepareData                                ,
  render                                      ,
  fillMatrixTypeArr                           ,
  
}
/* IndicesService-Wonderjs Not a pure module */
