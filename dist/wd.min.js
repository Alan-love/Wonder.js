!function(t,e){"undefined"!=typeof module&&module.exports?module.exports.browser=e():"function"==typeof define&&define.amd?define(e):this[t]=e()}("bowser",function(){function t(t){function n(e){var n=t.match(e);return n&&n.length>1&&n[1]||""}var r,i=n(/(ipod|iphone|ipad)/i).toLowerCase(),o=/like android/i.test(t),a=!o&&/android/i.test(t),s=n(/version\/(\d+(\.\d+)?)/i),c=/tablet/i.test(t),u=!c&&/[^-]mobi/i.test(t);/opera|opr/i.test(t)?r={name:"Opera",opera:e,version:s||n(/(?:opera|opr)[\s\/](\d+(\.\d+)?)/i)}:/windows phone/i.test(t)?r={name:"Windows Phone",windowsphone:e,msie:e,version:n(/iemobile\/(\d+(\.\d+)?)/i)}:/msie|trident/i.test(t)?r={name:"Internet Explorer",msie:e,version:n(/(?:msie |rv:)(\d+(\.\d+)?)/i)}:/chrome|crios|crmo/i.test(t)?r={name:"Chrome",chrome:e,version:n(/(?:chrome|crios|crmo)\/(\d+(\.\d+)?)/i)}:i?(r={name:"iphone"==i?"iPhone":"ipad"==i?"iPad":"iPod"},s&&(r.version=s)):/sailfish/i.test(t)?r={name:"Sailfish",sailfish:e,version:n(/sailfish\s?browser\/(\d+(\.\d+)?)/i)}:/seamonkey\//i.test(t)?r={name:"SeaMonkey",seamonkey:e,version:n(/seamonkey\/(\d+(\.\d+)?)/i)}:/firefox|iceweasel/i.test(t)?(r={name:"Firefox",firefox:e,version:n(/(?:firefox|iceweasel)[ \/](\d+(\.\d+)?)/i)},/\((mobile|tablet);[^\)]*rv:[\d\.]+\)/i.test(t)&&(r.firefoxos=e)):/silk/i.test(t)?r={name:"Amazon Silk",silk:e,version:n(/silk\/(\d+(\.\d+)?)/i)}:a?r={name:"Android",version:s}:/phantom/i.test(t)?r={name:"PhantomJS",phantom:e,version:n(/phantomjs\/(\d+(\.\d+)?)/i)}:/blackberry|\bbb\d+/i.test(t)||/rim\stablet/i.test(t)?r={name:"BlackBerry",blackberry:e,version:s||n(/blackberry[\d]+\/(\d+(\.\d+)?)/i)}:/(web|hpw)os/i.test(t)?(r={name:"WebOS",webos:e,version:s||n(/w(?:eb)?osbrowser\/(\d+(\.\d+)?)/i)},/touchpad\//i.test(t)&&(r.touchpad=e)):r=/bada/i.test(t)?{name:"Bada",bada:e,version:n(/dolfin\/(\d+(\.\d+)?)/i)}:/tizen/i.test(t)?{name:"Tizen",tizen:e,version:n(/(?:tizen\s?)?browser\/(\d+(\.\d+)?)/i)||s}:/safari/i.test(t)?{name:"Safari",safari:e,version:s}:{},/(apple)?webkit/i.test(t)?(r.name=r.name||"Webkit",r.webkit=e,!r.version&&s&&(r.version=s)):!r.opera&&/gecko\//i.test(t)&&(r.name=r.name||"Gecko",r.gecko=e,r.version=r.version||n(/gecko\/(\d+(\.\d+)?)/i)),a||r.silk?r.android=e:i&&(r[i]=e,r.ios=e);var l="";i?(l=n(/os (\d+([_\s]\d+)*) like mac os x/i),l=l.replace(/[_\s]/g,".")):a?l=n(/android[ \/-](\d+(\.\d+)*)/i):r.windowsphone?l=n(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i):r.webos?l=n(/(?:web|hpw)os\/(\d+(\.\d+)*)/i):r.blackberry?l=n(/rim\stablet\sos\s(\d+(\.\d+)*)/i):r.bada?l=n(/bada\/(\d+(\.\d+)*)/i):r.tizen&&(l=n(/tizen[\/\s](\d+(\.\d+)*)/i)),l&&(r.osversion=l);var h=l.split(".")[0];return c||"ipad"==i||a&&(3==h||4==h&&!u)||r.silk?r.tablet=e:(u||"iphone"==i||"ipod"==i||a||r.blackberry||r.webos||r.bada)&&(r.mobile=e),r.msie&&r.version>=10||r.chrome&&r.version>=20||r.firefox&&r.version>=20||r.safari&&r.version>=6||r.opera&&r.version>=10||r.ios&&r.osversion&&r.osversion.split(".")[0]>=6||r.blackberry&&r.version>=10.1?r.a=e:r.msie&&r.version<10||r.chrome&&r.version<20||r.firefox&&r.version<20||r.safari&&r.version<6||r.opera&&r.version<10||r.ios&&r.osversion&&r.osversion.split(".")[0]<6?r.c=e:r.x=e,r}var e=!0,n=t("undefined"!=typeof navigator?navigator.userAgent:"");return n._detect=t,n}),function(){"use strict";function t(t){return"function"==typeof t||"object"==typeof t&&null!==t}function e(t){return"function"==typeof t}function n(t){return"object"==typeof t&&null!==t}function r(){}function i(t,e){for(var n=0,r=t.length;r>n;n++)if(t[n]===e)return n;return-1}function o(t){var e=t._promiseCallbacks;return e||(e=t._promiseCallbacks={}),e}function a(t,e){return"onerror"===t?void Ct.on("error",e):2!==arguments.length?Ct[t]:void(Ct[t]=e)}function s(){setTimeout(function(){for(var t,e=0;e<Et.length;e++){t=Et[e];var n=t.payload;n.guid=n.key+n.id,n.childGuid=n.key+n.childId,n.error&&(n.stack=n.error.stack),Ct.trigger(t.name,t.payload)}Et.length=0},50)}function c(t,e,n){1===Et.push({name:t,payload:{key:e._guidKey,id:e._id,eventName:t,detail:e._result,childId:n&&n._id,label:e._label,timeStamp:yt(),error:Ct["instrument-with-stack"]?new Error(e._label):null}})&&s()}function u(){return new TypeError("A promises callback cannot return that same promise.")}function l(){}function h(t){try{return t.then}catch(e){return Lt.error=e,Lt}}function d(t,e,n,r){try{t.call(e,n,r)}catch(i){return i}}function p(t,e,n){Ct.async(function(t){var r=!1,i=d(n,e,function(n){r||(r=!0,e!==n?g(t,n):y(t,n))},function(e){r||(r=!0,v(t,e))},"Settle: "+(t._label||" unknown promise"));!r&&i&&(r=!0,v(t,i))},t)}function f(t,e){e._state===wt?y(t,e._result):e._state===Dt?(e._onError=null,v(t,e._result)):b(e,void 0,function(n){e!==n?g(t,n):y(t,n)},function(e){v(t,e)})}function _(t,n){if(n.constructor===t.constructor)f(t,n);else{var r=h(n);r===Lt?v(t,Lt.error):void 0===r?y(t,n):e(r)?p(t,n,r):y(t,n)}}function g(e,n){e===n?y(e,n):t(n)?_(e,n):y(e,n)}function m(t){t._onError&&t._onError(t._result),C(t)}function y(t,e){t._state===Tt&&(t._result=e,t._state=wt,0===t._subscribers.length?Ct.instrument&&St("fulfilled",t):Ct.async(C,t))}function v(t,e){t._state===Tt&&(t._state=Dt,t._result=e,Ct.async(m,t))}function b(t,e,n,r){var i=t._subscribers,o=i.length;t._onError=null,i[o]=e,i[o+wt]=n,i[o+Dt]=r,0===o&&t._state&&Ct.async(C,t)}function C(t){var e=t._subscribers,n=t._state;if(Ct.instrument&&St(n===wt?"fulfilled":"rejected",t),0!==e.length){for(var r,i,o=t._result,a=0;a<e.length;a+=3)r=e[a],i=e[a+n],r?T(n,r,i,o):i(o);t._subscribers.length=0}}function E(){this.error=null}function S(t,e){try{return t(e)}catch(n){return At.error=n,At}}function T(t,n,r,i){var o,a,s,c,l=e(r);if(l){if(o=S(r,i),o===At?(c=!0,a=o.error,o=null):s=!0,n===o)return void v(n,u())}else o=i,s=!0;n._state!==Tt||(l&&s?g(n,o):c?v(n,a):t===wt?y(n,o):t===Dt&&v(n,o))}function w(t,e){var n=!1;try{e(function(e){n||(n=!0,g(t,e))},function(e){n||(n=!0,v(t,e))})}catch(r){v(t,r)}}function D(t,e,n){return t===wt?{state:"fulfilled",value:n}:{state:"rejected",reason:n}}function L(t,e,n,r){this._instanceConstructor=t,this.promise=new t(l,r),this._abortOnReject=n,this._validateInput(e)?(this._input=e,this.length=e.length,this._remaining=e.length,this._init(),0===this.length?y(this.promise,this._result):(this.length=this.length||0,this._enumerate(),0===this._remaining&&y(this.promise,this._result))):v(this.promise,this._validationError())}function A(t,e){return new Mt(this,t,!0,e).promise}function M(t,e){function n(t){g(o,t)}function r(t){v(o,t)}var i=this,o=new i(l,e);if(!mt(t))return v(o,new TypeError("You must pass an array to race.")),o;for(var a=t.length,s=0;o._state===Tt&&a>s;s++)b(i.resolve(t[s]),void 0,n,r);return o}function O(t,e){var n=this;if(t&&"object"==typeof t&&t.constructor===n)return t;var r=new n(l,e);return g(r,t),r}function x(t,e){var n=this,r=new n(l,e);return v(r,t),r}function N(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function R(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function U(t,n){this._id=Ft++,this._label=n,this._state=void 0,this._result=void 0,this._subscribers=[],Ct.instrument&&St("created",this),l!==t&&(e(t)||N(),this instanceof U||R(),w(this,t))}function F(t,e,n){this._superConstructor(t,e,!1,n)}function I(t,e){return new F(It,t,e).promise}function B(t,e){return It.all(t,e)}function P(t,e){Jt[Gt]=t,Jt[Gt+1]=e,Gt+=2,2===Gt&&Pt()}function j(){var t=process.nextTick,e=process.versions.node.match(/^(?:(\d+)\.)?(?:(\d+)\.)?(\*|\d+)$/);return Array.isArray(e)&&"0"===e[1]&&"10"===e[2]&&(t=setImmediate),function(){t(k)}}function V(){return function(){Bt(k)}}function G(){var t=0,e=new qt(k),n=document.createTextNode("");return e.observe(n,{characterData:!0}),function(){n.data=t=++t%2}}function H(){var t=new MessageChannel;return t.port1.onmessage=k,function(){t.port2.postMessage(0)}}function W(){return function(){setTimeout(k,1)}}function k(){for(var t=0;Gt>t;t+=2){var e=Jt[t],n=Jt[t+1];e(n),Jt[t]=void 0,Jt[t+1]=void 0}Gt=0}function q(){try{var t=require,e=t("vertx");return Bt=e.runOnLoop||e.runOnContext,V()}catch(n){return W()}}function z(t){var e={};return e.promise=new It(function(t,n){e.resolve=t,e.reject=n},t),e}function X(t,n,r){return It.all(t,r).then(function(t){if(!e(n))throw new TypeError("You must pass a function as filter's second argument.");for(var i=t.length,o=new Array(i),a=0;i>a;a++)o[a]=n(t[a]);return It.all(o,r).then(function(e){for(var n=new Array(i),r=0,o=0;i>o;o++)e[o]&&(n[r]=t[o],r++);return n.length=r,n})})}function J(t,e,n){this._superConstructor(t,e,!0,n)}function K(t,e,n){this._superConstructor(t,e,!1,n)}function Y(t,e){return new K(It,t,e).promise}function Q(t,e){return new Qt(It,t,e).promise}function $(t,n,r){return It.all(t,r).then(function(t){if(!e(n))throw new TypeError("You must pass a function as map's second argument.");for(var i=t.length,o=new Array(i),a=0;i>a;a++)o[a]=n(t[a]);return It.all(o,r)})}function Z(){this.value=void 0}function tt(t){try{return t.then}catch(e){return ee.value=e,ee}}function et(t,e,n){try{t.apply(e,n)}catch(r){return ee.value=r,ee}}function nt(t,e){for(var n,r,i={},o=t.length,a=new Array(o),s=0;o>s;s++)a[s]=t[s];for(r=0;r<e.length;r++)n=e[r],i[n]=a[r+1];return i}function rt(t){for(var e=t.length,n=new Array(e-1),r=1;e>r;r++)n[r-1]=t[r];return n}function it(t,e){return{then:function(n,r){return t.call(e,n,r)}}}function ot(t,e){var n=function(){for(var n,r=this,i=arguments.length,o=new Array(i+1),a=!1,s=0;i>s;++s){if(n=arguments[s],!a){if(a=ct(n),a===ne){var c=new It(l);return v(c,ne.value),c}a&&a!==!0&&(n=it(a,n))}o[s]=n}var u=new It(l);return o[i]=function(t,n){t?v(u,t):void 0===e?g(u,n):e===!0?g(u,rt(arguments)):mt(e)?g(u,nt(arguments,e)):g(u,n)},a?st(u,o,t,r):at(u,o,t,r)};return n.__proto__=t,n}function at(t,e,n,r){var i=et(n,r,e);return i===ee&&v(t,i.value),t}function st(t,e,n,r){return It.all(e).then(function(e){var i=et(n,r,e);return i===ee&&v(t,i.value),t})}function ct(t){return t&&"object"==typeof t?t.constructor===It?!0:tt(t):!1}function ut(t,e){return It.race(t,e)}function lt(t,e){return It.reject(t,e)}function ht(t,e){return It.resolve(t,e)}function dt(t){throw setTimeout(function(){throw t}),t}function pt(t,e){Ct.async(t,e)}function ft(){Ct.on.apply(Ct,arguments)}function _t(){Ct.off.apply(Ct,arguments)}var gt;gt=Array.isArray?Array.isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)};var mt=gt,yt=Date.now||function(){return(new Date).getTime()},vt=Object.create||function(t){if(arguments.length>1)throw new Error("Second argument not supported");if("object"!=typeof t)throw new TypeError("Argument must be an object");return r.prototype=t,new r},bt={mixin:function(t){return t.on=this.on,t.off=this.off,t.trigger=this.trigger,t._promiseCallbacks=void 0,t},on:function(t,e){var n,r=o(this);n=r[t],n||(n=r[t]=[]),-1===i(n,e)&&n.push(e)},off:function(t,e){var n,r,a=o(this);return e?(n=a[t],r=i(n,e),void(-1!==r&&n.splice(r,1))):void(a[t]=[])},trigger:function(t,e){var n,r,i=o(this);if(n=i[t])for(var a=0;a<n.length;a++)(r=n[a])(e)}},Ct={instrument:!1};bt.mixin(Ct);var Et=[],St=c,Tt=void 0,wt=1,Dt=2,Lt=new E,At=new E,Mt=L;L.prototype._validateInput=function(t){return mt(t)},L.prototype._validationError=function(){return new Error("Array Methods must be provided an Array")},L.prototype._init=function(){this._result=new Array(this.length)},L.prototype._enumerate=function(){for(var t=this.length,e=this.promise,n=this._input,r=0;e._state===Tt&&t>r;r++)this._eachEntry(n[r],r)},L.prototype._eachEntry=function(t,e){var r=this._instanceConstructor;n(t)?t.constructor===r&&t._state!==Tt?(t._onError=null,this._settledAt(t._state,e,t._result)):this._willSettleAt(r.resolve(t),e):(this._remaining--,this._result[e]=this._makeResult(wt,e,t))},L.prototype._settledAt=function(t,e,n){var r=this.promise;r._state===Tt&&(this._remaining--,this._abortOnReject&&t===Dt?v(r,n):this._result[e]=this._makeResult(t,e,n)),0===this._remaining&&y(r,this._result)},L.prototype._makeResult=function(t,e,n){return n},L.prototype._willSettleAt=function(t,e){var n=this;b(t,void 0,function(t){n._settledAt(wt,e,t)},function(t){n._settledAt(Dt,e,t)})};var Ot=A,xt=M,Nt=O,Rt=x,Ut="rsvp_"+yt()+"-",Ft=0,It=U;U.cast=Nt,U.all=Ot,U.race=xt,U.resolve=Nt,U.reject=Rt,U.prototype={constructor:U,_guidKey:Ut,_onError:function(t){Ct.async(function(e){setTimeout(function(){e._onError&&Ct.trigger("error",t)},0)},this)},then:function(t,e,n){var r=this,i=r._state;if(i===wt&&!t||i===Dt&&!e)return Ct.instrument&&St("chained",this,this),this;r._onError=null;var o=new this.constructor(l,n),a=r._result;if(Ct.instrument&&St("chained",r,o),i){var s=arguments[i-1];Ct.async(function(){T(i,o,s,a)})}else b(r,o,t,e);return o},"catch":function(t,e){return this.then(null,t,e)},"finally":function(t,e){var n=this.constructor;return this.then(function(e){return n.resolve(t()).then(function(){return e})},function(e){return n.resolve(t()).then(function(){throw e})},e)}},F.prototype=vt(Mt.prototype),F.prototype._superConstructor=Mt,F.prototype._makeResult=D,F.prototype._validationError=function(){return new Error("allSettled must be called with an array")};var Bt,Pt,jt=I,Vt=B,Gt=0,Ht=({}.toString,P),Wt="undefined"!=typeof window?window:void 0,kt=Wt||{},qt=kt.MutationObserver||kt.WebKitMutationObserver,zt="undefined"!=typeof process&&"[object process]"==={}.toString.call(process),Xt="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,Jt=new Array(1e3);Pt=zt?j():qt?G():Xt?H():void 0===Wt&&"function"==typeof require?q():W();var Kt=z,Yt=X,Qt=J;J.prototype=vt(Mt.prototype),J.prototype._superConstructor=Mt,J.prototype._init=function(){this._result={}},J.prototype._validateInput=function(t){return t&&"object"==typeof t},J.prototype._validationError=function(){return new Error("Promise.hash must be called with an object")},J.prototype._enumerate=function(){var t=this.promise,e=this._input,n=[];for(var r in e)t._state===Tt&&Object.prototype.hasOwnProperty.call(e,r)&&n.push({position:r,entry:e[r]});var i=n.length;this._remaining=i;for(var o,a=0;t._state===Tt&&i>a;a++)o=n[a],this._eachEntry(o.entry,o.position)},K.prototype=vt(Qt.prototype),K.prototype._superConstructor=Mt,K.prototype._makeResult=D,K.prototype._validationError=function(){return new Error("hashSettled must be called with an object")};var $t=Y,Zt=Q,te=$,ee=new Z,ne=new Z,re=ot,ie=ut,oe=lt,ae=ht,se=dt;Ct.async=Ht;if("undefined"!=typeof window&&"object"==typeof window.__PROMISE_INSTRUMENTATION__){var ce=window.__PROMISE_INSTRUMENTATION__;a("instrument",!0);for(var ue in ce)ce.hasOwnProperty(ue)&&ft(ue,ce[ue])}var le={race:ie,Promise:It,allSettled:jt,hash:Zt,hashSettled:$t,denodeify:re,on:ft,off:_t,map:te,filter:Yt,resolve:ae,reject:oe,all:Vt,rethrow:se,defer:Kt,EventTarget:bt,configure:a,async:pt};"function"==typeof define&&define.amd?define(function(){return le}):"undefined"!=typeof module&&module.exports?module.exports=le:"undefined"!=typeof this&&(this.RSVP=le)}.call(this);var wdCb;!function(t){var e=Math.pow(2,53)-1,n=function(){function t(){}return t.isArray=function(t){var n=t&&t.length;return"number"==typeof n&&n>=0&&e>=n},t.isArrayExactly=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isNumber=function(t){return"number"==typeof t},t.isNumberExactly=function(t){return"[object Number]"===Object.prototype.toString.call(t)},t.isString=function(t){return"string"==typeof t},t.isStringExactly=function(t){return"[object String]"===Object.prototype.toString.call(t)},t.isBoolean=function(t){return t===!0||t===!1||"[boolect Boolean]"===toString.call(t)},t.isDom=function(t){return!(!t||1!==t.nodeType)},t.isObject=function(t){var e=typeof t;return"function"===e||"object"===e&&!!t},t.isDirectObject=function(t){return"[object Object]"===Object.prototype.toString.call(t)},t.isHostMethod=function(t,e){var n=typeof t[e];return"function"===n||"object"===n&&!!t[e]||"unknown"===n},t.isNodeJs=function(){return("undefined"!=typeof global&&global.module||"undefined"!=typeof module)&&"undefined"!=typeof module.exports},t.isFunction=function(t){return!0},t}();t.JudgeUtils=n,"function"!=typeof/./&&"object"!=typeof Int8Array?n.isFunction=function(t){return"function"==typeof t}:n.isFunction=function(t){return"[object Function]"===Object.prototype.toString.call(t)}}(wdCb||(wdCb={}));var wdCb;!function(t){t.JudgeUtils.isNodeJs()?t.root=global:t.root=window}(wdCb||(wdCb={}));var wdCb;!function(t){if("performance"in t.root==!1&&(t.root.performance={}),Date.now=Date.now||function(){return(new Date).getTime()},"now"in t.root.performance==!1){var e=t.root.performance.timing&&t.root.performance.timing.navigationStart?performance.timing.navigationStart:Date.now();t.root.performance.now=function(){return Date.now()-e}}}(wdCb||(wdCb={}));var wdCb;!function(t){t.$BREAK={"break":!0},t.$REMOVE=void 0}(wdCb||(wdCb={}));var wdCb;!function(t){var e=function(){function e(){}return e.log=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];this._exec("log",e)||t.root.alert(e.join(",")),this._exec("trace",e)},e.assert=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];t&&(this._exec("assert",arguments,1)||this.log.apply(this,Array.prototype.slice.call(arguments,1)))},e.error=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(t)throw new Error(Array.prototype.slice.call(arguments,1).join("\n"))},e.warn=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=this._exec("warn",arguments);n?this._exec("trace",["warn trace"]):this.log.apply(this,arguments)},e._exec=function(e,n,r){return void 0===r&&(r=0),t.root.console&&t.root.console[e]?(t.root.console[e].apply(t.root.console,Array.prototype.slice.call(n,r)),!0):!1},e.info={INVALID_PARAM:"invalid parameter",ABSTRACT_ATTRIBUTE:"abstract attribute need override",ABSTRACT_METHOD:"abstract method need override",helperFunc:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n="";return t.forEach(function(t){n+=String(t)+" "}),n.slice(0,-1)},assertion:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];if(2===t.length)return this.helperFunc(t[0],t[1]);if(3===t.length)return this.helperFunc(t[1],t[0],t[2]);throw new Error("args.length must <= 3")},FUNC_INVALID:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("invalid"),this.assertion.apply(this,t)},FUNC_MUST:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("must"),this.assertion.apply(this,t)},FUNC_MUST_BE:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("must be"),this.assertion.apply(this,t)},FUNC_MUST_NOT_BE:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("must not be"),this.assertion.apply(this,t)},FUNC_SHOULD:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("should"),this.assertion.apply(this,t)},FUNC_SHOULD_NOT:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("should not"),this.assertion.apply(this,t)},FUNC_SUPPORT:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("support"),this.assertion.apply(this,t)},FUNC_NOT_SUPPORT:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("not support"),this.assertion.apply(this,t)},FUNC_MUST_DEFINE:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("must define"),this.assertion.apply(this,t)},FUNC_MUST_NOT_DEFINE:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("must not define"),this.assertion.apply(this,t)},FUNC_UNKNOW:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("unknow"),this.assertion.apply(this,t)},FUNC_EXPECT:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("expect"),this.assertion.apply(this,t)},FUNC_UNEXPECT:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("unexpect"),this.assertion.apply(this,t)},FUNC_EXIST:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("exist"),this.assertion.apply(this,t)},FUNC_NOT_EXIST:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("not exist"),this.assertion.apply(this,t)},FUNC_ONLY:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("only"),this.assertion.apply(this,t)},FUNC_CAN_NOT:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("can't"),this.assertion.apply(this,t)}},e}();t.Log=e}(wdCb||(wdCb={}));var wdCb;!function(t){var e=function(){function e(){this.children=null}return e.prototype.getCount=function(){return this.children.length},e.prototype.hasChild=function(t){for(var e=null,n=this.children,r=0,i=n.length;i>r;r++){if(e=n[r],t.uid&&e.uid&&t.uid==e.uid)return!0;if(t===e)return!0}return!1},e.prototype.hasChildWithFunc=function(t){for(var e=0,n=this.children.length;n>e;e++)if(t(this.children[e],e))return!0;return!1},e.prototype.getChildren=function(){return this.children},e.prototype.getChild=function(t){return this.children[t]},e.prototype.addChild=function(t){return this.children.push(t),this},e.prototype.addChildren=function(n){if(t.JudgeUtils.isArray(n)){var r=n;this.children=this.children.concat(r)}else if(n instanceof e){var r=n;this.children=this.children.concat(r.getChildren())}else{var i=n;this.addChild(i)}return this},e.prototype.unShiftChild=function(t){this.children.unshift(t)},e.prototype.removeAllChildren=function(){return this.children=[],this},e.prototype.forEach=function(t,e){return this._forEach(this.children,t,e),this},e.prototype.toArray=function(){return this.children},e.prototype.copyChildren=function(){return this.children.slice(0)},e.prototype.removeChildHelper=function(e){var n=null;if(t.JudgeUtils.isFunction(e)){var r=e;n=this._removeChild(this.children,r)}else n=e.uid?this._removeChild(this.children,function(t){return t.uid?t.uid===e.uid:!1}):this._removeChild(this.children,function(t){return t===e});return n},e.prototype._forEach=function(e,n,r){var i=r,o=0,a=e.length;for(o=0;a>o&&n.call(i,e[o],o)!==t.$BREAK;o++);},e.prototype._removeChild=function(t,e){var n=this,r=[],i=[];return this._forEach(t,function(t,o){e.call(n,t)?r.push(t):i.push(t)}),this.children=i,r},e}();t.List=e}(wdCb||(wdCb={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdCb;!function(t){var e=function(e){function n(t){void 0===t&&(t=[]),e.call(this),this.children=t}return __extends(n,e),n.create=function(t){void 0===t&&(t=[]);var e=new this(t);return e},n.prototype.clone=function(e){return void 0===e&&(e=!1),e?n.create(t.ExtendUtils.extendDeep(this.children)):n.create().addChildren(this.children)},n.prototype.filter=function(t){for(var e=this.children,r=[],i=null,o=0,a=e.length;a>o;o++)i=e[o],t.call(e,i,o)&&r.push(i);return n.create(r)},n.prototype.findOne=function(e){var n=this.children,r=null;return this.forEach(function(i,o){return e.call(n,i,o)?(r=i,t.$BREAK):void 0}),r},n.prototype.reverse=function(){return n.create(this.copyChildren().reverse())},n.prototype.removeChild=function(t){return n.create(this.removeChildHelper(t))},n.prototype.sort=function(t,e){return void 0===e&&(e=!1),e?(this.children.sort(t),this):n.create(this.copyChildren().sort(t))},n.prototype.map=function(e){var r=[];return this.forEach(function(n,i){var o=e(n,i);o!==t.$REMOVE&&r.push(o)}),n.create(r)},n.prototype.removeRepeatItems=function(){var t=n.create();return this.forEach(function(e){t.hasChild(e)||t.addChild(e)}),t},n.prototype.hasRepeatItems=function(){var e=n.create(),r=!1;return this.forEach(function(n){return e.hasChild(n)?(r=!0,t.$BREAK):void e.addChild(n)}),r},n}(t.List);t.Collection=e}(wdCb||(wdCb={}));var wdCb;!function(t){var e=function(){function e(t){void 0===t&&(t={}),this._children=null,this._children=t}return e.create=function(t){void 0===t&&(t={});var e=new this(t);return e},e.prototype.getChildren=function(){return this._children},e.prototype.getCount=function(){var t=0,e=this._children,n=null;for(n in e)e.hasOwnProperty(n)&&t++;return t},e.prototype.getKeys=function(){var e=t.Collection.create(),n=this._children,r=null;for(r in n)n.hasOwnProperty(r)&&e.addChild(r);return e},e.prototype.getValues=function(){var e=t.Collection.create(),n=this._children,r=null;for(r in n)n.hasOwnProperty(r)&&e.addChild(n[r]);return e},e.prototype.getChild=function(t){return this._children[t]},e.prototype.setValue=function(t,e){return this._children[t]=e,this},e.prototype.addChild=function(t,e){return this._children[t]=e,this},e.prototype.addChildren=function(t){var n=null,r=null;r=t instanceof e?t.getChildren():t;for(n in r)r.hasOwnProperty(n)&&this.addChild(n,r[n]);return this},e.prototype.appendChild=function(e,n){if(this._children[e]instanceof t.Collection){var r=this._children[e];r.addChild(n)}else this._children[e]=t.Collection.create().addChild(n);return this},e.prototype.removeChild=function(e){var n=[];if(t.JudgeUtils.isString(e)){var r=e;n.push(this._children[r]),this._children[r]=void 0,delete this._children[r]}else if(t.JudgeUtils.isFunction(e)){var i=e,o=this;this.forEach(function(t,e){i(t,e)&&(n.push(o._children[e]),o._children[e]=void 0,delete o._children[e])})}return t.Collection.create(n)},e.prototype.removeAllChildren=function(){this._children={}},e.prototype.hasChild=function(t){return void 0!==this._children[t]},e.prototype.hasChildWithFunc=function(e){var n=!1;return this.forEach(function(r,i){return e(r,i)?(n=!0,t.$BREAK):void 0}),n},e.prototype.forEach=function(e,n){var r=this._children;for(var i in r)if(r.hasOwnProperty(i)&&e.call(n,r[i],i)===t.$BREAK)break;return this},e.prototype.filter=function(t){var n={},r=this._children,i=null;for(var o in r)r.hasOwnProperty(o)&&(i=r[o],t.call(r,i,o)&&(n[o]=i));return e.create(n)},e.prototype.findOne=function(e){var n=[],r=this,i=this._children;return this.forEach(function(o,a){return e.call(i,o,a)?(n=[a,r.getChild(a)],t.$BREAK):void 0}),n},e.prototype.map=function(n){var r={};return this.forEach(function(e,i){var o=n(e,i);o!==t.$REMOVE&&(t.Log.error(!t.JudgeUtils.isArray(o)||2!==o.length,t.Log.info.FUNC_MUST_BE("iterator","[key, value]")),r[o[0]]=o[1])}),e.create(r)},e.prototype.toCollection=function(){var e=t.Collection.create();return this.forEach(function(n,r){n instanceof t.Collection?e.addChildren(n):e.addChild(n)}),e},e.prototype.toArray=function(){var e=[];return this.forEach(function(n,r){n instanceof t.Collection?e=e.concat(n.getChildren()):e.push(n)}),e},e.prototype.clone=function(n){return void 0===n&&(n=!1),n?e.create(t.ExtendUtils.extendDeep(this._children)):e.create().addChildren(this._children)},e}();t.Hash=e}(wdCb||(wdCb={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdCb;!function(t){var e=function(t){function e(e){void 0===e&&(e=[]),t.call(this),this.children=e}return __extends(e,t),e.create=function(t){void 0===t&&(t=[]);var e=new this(t);return e},Object.defineProperty(e.prototype,"front",{get:function(){return this.children[this.children.length-1]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rear",{get:function(){return this.children[0]},enumerable:!0,configurable:!0}),e.prototype.push=function(t){this.children.unshift(t)},e.prototype.pop=function(){return this.children.pop()},e.prototype.clear=function(){this.removeAllChildren()},e}(t.List);t.Queue=e}(wdCb||(wdCb={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdCb;!function(t){var e=function(e){function n(t){void 0===t&&(t=[]),e.call(this),this.children=t}return __extends(n,e),n.create=function(t){void 0===t&&(t=[]);var e=new this(t);return e},Object.defineProperty(n.prototype,"top",{get:function(){return this.children[this.children.length-1]},enumerable:!0,configurable:!0}),n.prototype.push=function(t){this.children.push(t)},n.prototype.pop=function(){return this.children.pop()},n.prototype.clear=function(){this.removeAllChildren()},n.prototype.clone=function(e){return void 0===e&&(e=!1),e?n.create(t.ExtendUtils.extendDeep(this.children)):n.create([].concat(this.children))},n}(t.List);t.Stack=e}(wdCb||(wdCb={}));var wdCb;!function(wdCb){var AjaxUtils=function(){function AjaxUtils(){}return AjaxUtils.ajax=function(conf){var type=conf.type,url=conf.url,data=conf.data,dataType=conf.dataType,success=conf.success,error=conf.error,xhr=null,self=this;if(null===type&&(type="get"),null===dataType&&(dataType="text"),xhr=this._createAjax(error))try{xhr.open(type,url,!0),this._isSoundFile(dataType)&&(xhr.responseType="arraybuffer"),"GET"===type||"get"===type?xhr.send(null):("POST"===type||"post"===type)&&(xhr.setRequestHeader("content-type","application/x-www-form-urlencoded"),xhr.send(data)),xhr.onreadystatechange=function(){4!==xhr.readyState||200!==xhr.status&&!self._isLocalFile(xhr.status)||("text"===dataType||"TEXT"===dataType?null!==success&&success(xhr.responseText):"xml"===dataType||"XML"===dataType?null!==success&&success(xhr.responseXML):"json"===dataType||"JSON"===dataType?null!==success&&success(eval("("+xhr.responseText+")")):self._isSoundFile(dataType)&&null!==success&&success(xhr.response))}}catch(e){error(xhr,e)}},AjaxUtils._createAjax=function(t){var e=null;try{e=new ActiveXObject("microsoft.xmlhttp")}catch(n){try{e=new XMLHttpRequest}catch(r){return t(e,{message:"您的浏览器不支持ajax，请更换！"}),null}}return e},AjaxUtils._isLocalFile=function(t){return document.URL.contain("file://")&&0===t},AjaxUtils._isSoundFile=function(t){return"arraybuffer"===t},AjaxUtils}();wdCb.AjaxUtils=AjaxUtils}(wdCb||(wdCb={}));var wdCb;!function(t){var e=function(){function e(){}return e.removeRepeatItems=function(t,e){void 0===e&&(e=function(t,e){return t===e});var n=[],r=this;return t.forEach(function(t){r.contain(n,function(n){return e(n,t)})||n.push(t)}),n},e.contain=function(e,n){if(t.JudgeUtils.isFunction(n))for(var r=n,i=0,o=e.length;o>i;i++){var a=e[i];if(r.call(null,a,i))return!0}else for(var i=0,o=e.length;o>i;i++){var a=e[i];if(n===a||a.contain&&a.contain(n))return!0}return!1},e}();t.ArrayUtils=e}(wdCb||(wdCb={}));var wdCb;!function(t){var e=function(){function e(){}return e.toString=function(e){return t.JudgeUtils.isNumber(e)?String(e):t.JudgeUtils.isFunction(e)?this._convertCodeToString(e):t.JudgeUtils.isDirectObject(e)||t.JudgeUtils.isArray(e)?JSON.stringify(e):String(e)},e._convertCodeToString=function(t){return t.toString().split("\n").slice(1,-1).join("\n")+"\n"},e}();t.ConvertUtils=e}(wdCb||(wdCb={}));var wdCb;!function(t){var e=function(){function e(){}return e.bindEvent=function(t,e){return function(n){return e.call(t,n)}},e.addEvent=function(e,n,r){t.JudgeUtils.isHostMethod(e,"addEventListener")?e.addEventListener(n,r,!1):t.JudgeUtils.isHostMethod(e,"attachEvent")?e.attachEvent("on"+n,r):e["on"+n]=r},e.removeEvent=function(e,n,r){t.JudgeUtils.isHostMethod(e,"removeEventListener")?e.removeEventListener(n,r,!1):t.JudgeUtils.isHostMethod(e,"detachEvent")?e.detachEvent("on"+n,r):e["on"+n]=null},e}();t.EventUtils=e}(wdCb||(wdCb={}));var wdCb;!function(t){var e=function(){function e(){}return e.extendDeep=function(t,e,n){void 0===n&&(n=function(t,e){return!0});var r=null,i=0,o=Object.prototype.toString,a="[object Array]",s="[object Object]",c="",u=null;if(o.call(t)===a)for(u=e||[],r=0,i=t.length;i>r;r++){var l=t[r];n(l,r)&&(l.clone?u[r]=l.clone():(c=o.call(l),c===a||c===s?(u[r]=c===a?[]:{},
arguments.callee(l,u[r])):u[r]=l))}else if(o.call(t)===s){u=e||{};for(r in t){var l=t[r];n(l,r)&&(l.clone?u[r]=l.clone():(c=o.call(l),c===a||c===s?(u[r]=c===a?[]:{},arguments.callee(l,u[r])):u[r]=l))}}else u=t;return u},e.extend=function(t,e){var n="";for(n in e)t[n]=e[n];return t},e.copyPublicAttri=function(e){var n={};return this.extendDeep(e,n,function(e,n){return"_"!==n.slice(0,1)&&!t.JudgeUtils.isFunction(e)}),n},e}();t.ExtendUtils=e}(wdCb||(wdCb={}));var wdCb;!function(t){var e=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,n=function(){function t(){}return t.basename=function(t,e){var n=this._splitPath(t)[2];return e&&n.substr(-1*e.length)===e&&(n=n.substr(0,n.length-e.length)),n},t.changeExtname=function(t,e){var e=e||"",n=t.indexOf("?"),r="";return n>0&&(r=t.substring(n),t=t.substring(0,n)),n=t.lastIndexOf("."),0>n?t+e+r:t.substring(0,n)+e+r},t.changeBasename=function(t,e,n){void 0===n&&(n=!1);var r=null,i=null,o=null;return 0==e.indexOf(".")?this.changeExtname(t,e):(r=t.indexOf("?"),i="",o=n?this.extname(t):"",r>0&&(i=t.substring(r),t=t.substring(0,r)),r=t.lastIndexOf("/"),r=0>=r?0:r+1,t.substring(0,r)+e+o+i)},t.extname=function(t){return this._splitPath(t)[3]},t.dirname=function(t){var e=this._splitPath(t),n=e[0],r=e[1];return n||r?(r&&(r=r.substr(0,r.length-1)),n+r):"."},t._splitPath=function(t){return e.exec(t).slice(1)},t}();t.PathUtils=n}(wdCb||(wdCb={}));var wdCb;!function(t){var e=function(){function t(){}return t.bind=function(t,e){return function(){return e.apply(t,arguments)}},t}();t.FunctionUtils=e}(wdCb||(wdCb={}));var wdCb;!function(t){var e=function(){function e(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];return this._doms=null,t.JudgeUtils.isDom(e[0])?this._doms=[e[0]]:this._isDomEleStr(e[0])?this._doms=[this._buildDom(e[0])]:this._doms=document.querySelectorAll(e[0]),this}return e.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=new this(t[0]);return n},e.prototype.get=function(t){return this._doms[t]},e.prototype.prepend=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=null;n=this._buildDom(t[0]);for(var r=0,i=this._doms;r<i.length;r++){var o=i[r];1===o.nodeType&&o.insertBefore(n,o.firstChild)}return this},e.prototype.prependTo=function(t){var n=null;n=e.create(t);for(var r=0,i=this._doms;r<i.length;r++){var o=i[r];1===o.nodeType&&n.prepend(o)}return this},e.prototype.remove=function(){for(var t=0,e=this._doms;t<e.length;t++){var n=e[t];n&&n.parentNode&&"BODY"!=n.tagName&&n.parentNode.removeChild(n)}return this},e.prototype.css=function(t,e){for(var n=0,r=this._doms;n<r.length;n++){var i=r[n];i.style[t]=e}},e.prototype.attr=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];if(1===t.length){var n=t[0];return this.get(0).getAttribute(n)}for(var r=t[0],i=t[1],o=0,a=this._doms;o<a.length;o++){var s=a[o];s.setAttribute(r,i)}},e.prototype._isDomEleStr=function(t){return null!==t.match(/<(\w+)[^>]*><\/\1>/)},e.prototype._buildDom=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(t.JudgeUtils.isString(e[0])){var r=this._createElement("div"),i=e[0];return r.innerHTML=i,r.firstChild}return e[0]},e.prototype._createElement=function(t){return document.createElement(t)},e}();t.DomQuery=e}(wdCb||(wdCb={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.isPromise=function(e){return!!e&&!t.isFunction.call(this,e.subscribe)&&t.isFunction.call(this,e.then)},e.isEqual=function(t,e){return t.uid===e.uid},e.isIObserver=function(t){return t.next&&t.error&&t.completed},e}(wdCb.JudgeUtils);t.JudgeUtils=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){t.fromNodeCallback=function(e,n){return function(){for(var r=[],i=0;i<arguments.length;i++)r[i-0]=arguments[i];return t.createStream(function(t){var i=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];return e?void t.error(e):(n.length<=1?t.next.apply(t,n):t.next(n),void t.completed())};r.push(i),e.apply(n,r)})}},t.fromStream=function(e,n){return void 0===n&&(n="end"),e.pause(),t.createStream(function(t){var r=function(e){t.next(e)},i=function(e){t.error(e)},o=function(){t.completed()};return e.addListener("data",r),e.addListener("error",i),e.addListener(n,o),e.resume(),function(){e.removeListener("data",r),e.removeListener("error",i),e.removeListener(n,o)}})},t.fromReadableStream=function(e){return t.fromStream(e,"end")},t.fromWritableStream=function(e){return t.fromStream(e,"finish")},t.fromTransformStream=function(e){return t.fromStream(e,"finish")}}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(){function t(e){this._uid=null,this._uid=e+String(t.UID++)}return Object.defineProperty(t.prototype,"uid",{get:function(){return this._uid},set:function(t){this._uid=t},enumerable:!0,configurable:!0}),t.UID=1,t}();t.Entity=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(){function t(){}return t.isTest=!1,t}();t.Main=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){function e(t,e){void 0===e&&(e="contract error"),u.error(!t,e)}function n(e){return function(n,r,i){var o=i.value;return i.value=function(){for(var n=[],r=0;r<arguments.length;r++)n[r-0]=arguments[r];return t.Main.isTest&&e.apply(this,n),o.apply(this,n)},i}}function r(e){return function(n,r,i){var o=i.value;return i.value=function(){for(var n=[],r=0;r<arguments.length;r++)n[r-0]=arguments[r];var i=o.apply(this,n),a=[i].concat(n);return t.Main.isTest&&e.apply(this,a),i},i}}function i(e){return function(n,r,i){var o=i.get;return i.get=function(){return t.Main.isTest&&e.call(this),o.call(this)},i}}function o(e){return function(n,r,i){var o=i.set;return i.set=function(n){t.Main.isTest&&e.call(this,n),o.call(this,n)},i}}function a(e){return function(n,r,i){var o=i.get;return i.get=function(){var n=o.call(this);return t.Main.isTest&&e.call(this,n),n},i}}function s(e){return function(n,r,i){var o=i.set;return i.set=function(n){var r=o.call(this,n),i=[r,n];t.Main.isTest&&e.apply(this,i)},i}}function c(e){return function(n){t.Main.isTest&&e(n)}}var u=wdCb.Log;t.assert=e,t.require=n,t.ensure=r,t.requireGetter=i,t.requireSetter=o,t.ensureGetter=a,t.ensureSetter=s,t.invariant=c}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(t){function e(e){t.call(this,"SingleDisposable"),this._disposeHandler=null,this._disposeHandler=e}return __extends(e,t),e.create=function(t){void 0===t&&(t=function(){});var e=new this(t);return e},e.prototype.setDisposeHandler=function(t){this._disposeHandler=t},e.prototype.dispose=function(){this._disposeHandler()},e}(t.Entity);t.SingleDisposable=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(t){function e(e){t.call(this,"GroupDisposable"),this._group=wdCb.Collection.create(),e&&this._group.addChild(e)}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e.prototype.add=function(t){return this._group.addChild(t),this},e.prototype.remove=function(t){return this._group.removeChild(t),this},e.prototype.dispose=function(){this._group.forEach(function(t){t.dispose()})},e}(t.Entity);t.GroupDisposable=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(){function t(t,e){this._subject=null,this._observer=null,this._subject=t,this._observer=e}return t.create=function(t,e){var n=new this(t,e);return n},t.prototype.dispose=function(){this._subject.remove(this._observer),this._observer.dispose()},t}();t.InnerSubscription=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(){function t(){this._container=wdCb.Collection.create()}return t.create=function(){var t=new this;return t},t.prototype.addChild=function(t){this._container.addChild(t)},t.prototype.dispose=function(){this._container.forEach(function(t){t.dispose()})},t}();t.InnerSubscriptionGroup=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){t.JudgeUtils.isNodeJs()?t.root=global:t.root=window}(wdFrp||(wdFrp={}));var wdFrp;!function(t){t.ABSTRACT_ATTRIBUTE=null}(wdFrp||(wdFrp={}));var wdFrp;!function(t){t.root.RSVP&&(t.root.RSVP.onerror=function(t){throw t},t.root.RSVP.on("error",t.root.RSVP.onerror))}(wdFrp||(wdFrp={}));var wdFrp;!function(t){t.root.requestNextAnimationFrame=function(){var e=void 0,n=void 0,r=null,i=t.root.navigator&&t.root.navigator.userAgent,o=0,a=this;return n=function(e){e=t.root.performance.now(),a.callback(e)},t.root.requestAnimationFrame?requestAnimationFrame:(t.root.webkitRequestAnimationFrame&&(e=t.root.webkitRequestAnimationFrame,t.root.webkitRequestAnimationFrame=function(t,r){return a.callback=t,e(n,r)}),t.root.msRequestAnimationFrame&&(e=t.root.msRequestAnimationFrame,t.root.msRequestAnimationFrame=function(t){return a.callback=t,e(n)}),t.root.mozRequestAnimationFrame&&(o=i.indexOf("rv:"),-1!=i.indexOf("Gecko")&&(r=i.substr(o+3,3),"2.0"===r&&(t.root.mozRequestAnimationFrame=void 0))),t.root.webkitRequestAnimationFrame||t.root.mozRequestAnimationFrame||t.root.oRequestAnimationFrame||t.root.msRequestAnimationFrame||function(e,n){var r,i;t.root.setTimeout(function(){r=t.root.performance.now(),e(r),i=t.root.performance.now(),a.timeout=1e3/60-(i-r)},a.timeout)})}(),t.root.cancelNextRequestAnimationFrame=t.root.cancelRequestAnimationFrame||t.root.webkitCancelAnimationFrame||t.root.webkitCancelRequestAnimationFrame||t.root.mozCancelRequestAnimationFrame||t.root.oCancelRequestAnimationFrame||t.root.msCancelRequestAnimationFrame||clearTimeout}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var i,o=arguments.length,a=3>o?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(i=t[s])&&(a=(3>o?i(a):o>3?i(e,n,a):i(e,n))||a);return o>3&&a&&Object.defineProperty(e,n,a),a},wdFrp;!function(t){var e=wdCb.Log,n=function(n){function r(e){n.call(this,"Stream"),this.scheduler=t.ABSTRACT_ATTRIBUTE,this.subscribeFunc=null,this.subscribeFunc=e||function(){}}return __extends(r,n),r.prototype.buildStream=function(e){return t.SingleDisposable.create(this.subscribeFunc(e)||function(){})},r.prototype["do"]=function(e,n,r){return t.DoStream.create(this,e,n,r)},r.prototype.map=function(e){return t.MapStream.create(this,e)},r.prototype.flatMap=function(t){return this.map(t).mergeAll()},r.prototype.concatMap=function(t){return this.map(t).concatAll()},r.prototype.mergeAll=function(){return t.MergeAllStream.create(this)},r.prototype.concatAll=function(){return this.merge(1)},r.prototype.takeUntil=function(e){return t.TakeUntilStream.create(this,e)},r.prototype.take=function(e){void 0===e&&(e=1);var n=this;return 0===e?t.empty():t.createStream(function(t){n.subscribe(function(n){e>0&&t.next(n),e--,0>=e&&t.completed()},function(e){t.error(e)},function(){t.completed()})})},r.prototype.takeLast=function(e){void 0===e&&(e=1);var n=this;return 0===e?t.empty():t.createStream(function(t){var r=[];n.subscribe(function(t){r.push(t),r.length>e&&r.shift()},function(e){t.error(e)},function(){for(;r.length>0;)t.next(r.shift());t.completed()})})},r.prototype.takeWhile=function(e,n){void 0===n&&(n=this);var r=this,i=null;return i=wdCb.FunctionUtils.bind(n,e),t.createStream(function(t){var e=0,n=!1;r.subscribe(function(o){if(i(o,e++,r))try{t.next(o),n=!0}catch(a){return void t.error(a)}else n&&t.completed()},function(e){t.error(e)},function(){t.completed()})})},r.prototype.lastOrDefault=function(e){void 0===e&&(e=null);var n=this;return t.createStream(function(t){var r=[];n.subscribe(function(t){r.push(t),r.length>1&&r.shift()},function(e){t.error(e)},function(){if(0===r.length)t.next(e);else for(;r.length>0;)t.next(r.shift());t.completed()})})},r.prototype.filter=function(e,n){if(void 0===n&&(n=this),this instanceof t.FilterStream){var r=this;return r.internalFilter(e,n)}return t.FilterStream.create(this,e,n)},r.prototype.filterWithState=function(e,n){if(void 0===n&&(n=this),this instanceof t.FilterStream){var r=this;return r.internalFilter(e,n)}return t.FilterWithStateStream.create(this,e,n)},r.prototype.concat=function(){var e=null;return e=t.JudgeUtils.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments,0),e.unshift(this),t.ConcatStream.create(e)},r.prototype.merge=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(t.JudgeUtils.isNumber(e[0])){var r=e[0];return t.MergeStream.create(this,r)}t.JudgeUtils.isArray(e[0])&&(e=arguments[0]);var i=null;return e.unshift(this),i=t.fromArray(e).mergeAll()},r.prototype.repeat=function(e){return void 0===e&&(e=-1),t.RepeatStream.create(this,e)},r.prototype.ignoreElements=function(){return t.IgnoreElementsStream.create(this)},r.prototype.handleSubject=function(t){return this._isSubject(t)?(this._setSubject(t),!0):!1},r.prototype._isSubject=function(e){return e instanceof t.Subject},r.prototype._setSubject=function(t){t.source=this},__decorate([t.require(function(n){void 0===n&&(n=1),t.assert(n>=0,e.info.FUNC_SHOULD("count",">= 0"))})],r.prototype,"take",null),__decorate([t.require(function(n){void 0===n&&(n=1),t.assert(n>=0,e.info.FUNC_SHOULD("count",">= 0"))})],r.prototype,"takeLast",null),r}(t.Entity);t.Stream=n}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(){function e(){this._requestLoopId=null}return e.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=new this;return n},Object.defineProperty(e.prototype,"requestLoopId",{get:function(){return this._requestLoopId},set:function(t){this._requestLoopId=t},enumerable:!0,configurable:!0}),e.prototype.publishRecursive=function(t,e,n){n(e)},e.prototype.publishInterval=function(e,n,r,i){return t.root.setInterval(function(){n=i(n)},r)},e.prototype.publishIntervalRequest=function(e,n){var r=this,i=function(e){var o=n(e);o||(r._requestLoopId=t.root.requestNextAnimationFrame(i))};this._requestLoopId=t.root.requestNextAnimationFrame(i)},e.prototype.publishTimeout=function(e,n,r){return t.root.setTimeout(function(){r(n),e.completed()},n)},e}();t.Scheduler=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(t){function e(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(t.call(this,"Observer"),this._isDisposed=null,this.onUserNext=null,this.onUserError=null,this.onUserCompleted=null,this._isStop=!1,this._disposable=null,1===e.length){var r=e[0];this.onUserNext=function(t){r.next(t)},this.onUserError=function(t){r.error(t)},this.onUserCompleted=function(){r.completed()}}else{var i=e[0],o=e[1],a=e[2];this.onUserNext=i||function(t){},this.onUserError=o||function(t){throw t},this.onUserCompleted=a||function(){}}}return __extends(e,t),Object.defineProperty(e.prototype,"isDisposed",{get:function(){return this._isDisposed},set:function(t){this._isDisposed=t},enumerable:!0,configurable:!0}),e.prototype.next=function(t){return this._isStop?void 0:this.onNext(t)},e.prototype.error=function(t){this._isStop||(this._isStop=!0,this.onError(t))},e.prototype.completed=function(){this._isStop||(this._isStop=!0,this.onCompleted())},e.prototype.dispose=function(){this._isStop=!0,this._isDisposed=!0,this._disposable&&this._disposable.dispose()},e.prototype.setDisposable=function(t){this._disposable=t},e}(t.Entity);t.Observer=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(){function e(){this._source=null,this._observer=new t.SubjectObserver}return e.create=function(){var t=new this;return t},Object.defineProperty(e.prototype,"source",{get:function(){return this._source},set:function(t){this._source=t},enumerable:!0,configurable:!0}),e.prototype.subscribe=function(e,n,r){var i=e instanceof t.Observer?e:t.AutoDetachObserver.create(e,n,r);return this._observer.addChild(i),t.InnerSubscription.create(this,i)},e.prototype.next=function(t){this._observer.next(t)},e.prototype.error=function(t){this._observer.error(t)},e.prototype.completed=function(){this._observer.completed()},e.prototype.start=function(){this._source&&this._observer.setDisposable(this._source.buildStream(this))},e.prototype.remove=function(t){this._observer.removeChild(t)},e.prototype.dispose=function(){this._observer.dispose()},e}();t.Subject=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(){e.call(this,"GeneratorSubject"),this._isStart=!1,this.observer=new t.SubjectObserver}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"isStart",{get:function(){return this._isStart},set:function(t){this._isStart=t},enumerable:!0,configurable:!0}),n.prototype.onBeforeNext=function(t){},n.prototype.onAfterNext=function(t){},n.prototype.onIsCompleted=function(t){return!1},n.prototype.onBeforeError=function(t){},n.prototype.onAfterError=function(t){},n.prototype.onBeforeCompleted=function(){},n.prototype.onAfterCompleted=function(){},n.prototype.subscribe=function(e,n,r){var i=e instanceof t.Observer?e:t.AutoDetachObserver.create(e,n,r);return this.observer.addChild(i),t.InnerSubscription.create(this,i)},n.prototype.next=function(t){if(this._isStart&&!this.observer.isEmpty())try{this.onBeforeNext(t),this.observer.next(t),this.onAfterNext(t),this.onIsCompleted(t)&&this.completed()}catch(e){this.error(e)}},n.prototype.error=function(t){this._isStart&&!this.observer.isEmpty()&&(this.onBeforeError(t),this.observer.error(t),this.onAfterError(t))},n.prototype.completed=function(){this._isStart&&!this.observer.isEmpty()&&(this.onBeforeCompleted(),this.observer.completed(),this.onAfterCompleted())},n.prototype.toStream=function(){var e=this,n=null;return n=t.AnonymousStream.create(function(t){e.subscribe(t)})},n.prototype.start=function(){var e=this;this._isStart=!0,this.observer.setDisposable(t.SingleDisposable.create(function(){e.dispose()}))},n.prototype.stop=function(){this._isStart=!1},n.prototype.remove=function(t){this.observer.removeChild(t)},n.prototype.dispose=function(){this.observer.dispose()},n}(t.Entity);t.GeneratorSubject=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(t,e,n){return new this(t,e,n)},e.prototype.onNext=function(t){this.onUserNext(t)},e.prototype.onError=function(t){this.onUserError(t)},e.prototype.onCompleted=function(){this.onUserCompleted()},e}(t.Observer);t.AnonymousObserver=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return 1===t.length?new this(t[0]):new this(t[0],t[1],t[2])},e.prototype.dispose=function(){return this.isDisposed?void wdCb.Log.log("only can dispose once"):void t.prototype.dispose.call(this)},e.prototype.onNext=function(t){try{this.onUserNext(t)}catch(e){this.onError(e)}},e.prototype.onError=function(t){try{this.onUserError(t)}catch(e){throw e}finally{this.dispose()}},e.prototype.onCompleted=function(){try{this.onUserCompleted(),this.dispose()}catch(t){throw t}},e}(t.Observer);t.AutoDetachObserver=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(t){function e(e,n){t.call(this,null,null,null),this._currentObserver=null,this._selector=null,this._currentObserver=e,this._selector=n}return __extends(e,t),e.create=function(t,e){return new this(t,e)},e.prototype.onNext=function(t){var e=null;try{e=this._selector(t)}catch(n){this._currentObserver.error(n)}finally{this._currentObserver.next(e)}},e.prototype.onError=function(t){this._currentObserver.error(t)},e.prototype.onCompleted=function(){this._currentObserver.completed()},e}(t.Observer);t.MapObserver=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(t){function e(e,n){t.call(this,null,null,null),this._currentObserver=null,this._prevObserver=null,this._currentObserver=e,this._prevObserver=n}return __extends(e,t),e.create=function(t,e){return new this(t,e)},e.prototype.onNext=function(t){try{this._prevObserver.next(t)}catch(e){this._prevObserver.error(e),this._currentObserver.error(e)}finally{this._currentObserver.next(t)}},e.prototype.onError=function(t){try{this._prevObserver.error(t)}catch(e){}finally{this._currentObserver.error(t)}},e.prototype.onCompleted=function(){try{this._prevObserver.completed()}catch(t){this._prevObserver.error(t),this._currentObserver.error(t)}finally{this._currentObserver.completed()}},e}(t.Observer);t.DoObserver=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var i,o=arguments.length,a=3>o?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(i=t[s])&&(a=(3>o?i(a):o>3?i(e,n,a):i(e,n))||a);return o>3&&a&&Object.defineProperty(e,n,a),a},wdFrp;!function(t){var e=wdCb.Log,n=function(n){function i(t,e,r){n.call(this,null,null,null),this.done=!1,this.currentObserver=null,this._streamGroup=null,this._groupDisposable=null,this.currentObserver=t,this._streamGroup=e,this._groupDisposable=r}return __extends(i,n),i.create=function(t,e,n){return new this(t,e,n)},i.prototype.onNext=function(e){t.JudgeUtils.isPromise(e)&&(e=t.fromPromise(e)),this._streamGroup.addChild(e),this._groupDisposable.add(e.buildStream(r.create(this,this._streamGroup,e)))},i.prototype.onError=function(t){this.currentObserver.error(t)},i.prototype.onCompleted=function(){this.done=!0,0===this._streamGroup.getCount()&&this.currentObserver.completed()},__decorate([t.require(function(n){t.assert(n instanceof t.Stream||t.JudgeUtils.isPromise(n),e.info.FUNC_MUST_BE("innerSource","Stream or Promise"))})],i.prototype,"onNext",null),i}(t.Observer);t.MergeAllObserver=n;var r=function(e){function n(t,n,r){e.call(this,null,null,null),this._parent=null,this._streamGroup=null,this._currentStream=null,this._parent=t,this._streamGroup=n,this._currentStream=r}return __extends(n,e),n.create=function(t,e,n){var r=new this(t,e,n);return r},n.prototype.onNext=function(t){this._parent.currentObserver.next(t)},n.prototype.onError=function(t){this._parent.currentObserver.error(t)},n.prototype.onCompleted=function(){var e=this._currentStream,n=this._parent;this._streamGroup.removeChild(function(n){return t.JudgeUtils.isEqual(n,e)}),this._isAsync()&&0===this._streamGroup.getCount()&&n.currentObserver.completed()},n.prototype._isAsync=function(){return this._parent.done},n}(t.Observer)}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var i,o=arguments.length,a=3>o?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(i=t[s])&&(a=(3>o?i(a):o>3?i(e,n,a):i(e,n))||a);return o>3&&a&&Object.defineProperty(e,n,a),a},wdFrp;!function(t){var e=wdCb.Log,n=function(n){function i(t,e,r,i){n.call(this,null,null,null),this.done=!1,this.currentObserver=null,this.activeCount=0,this.q=[],this._maxConcurrent=null,this._groupDisposable=null,this._streamGroup=null,this.currentObserver=t,this._maxConcurrent=e,this._streamGroup=r,this._groupDisposable=i}return __extends(i,n),i.create=function(t,e,n,r){return new this(t,e,n,r)},i.prototype.handleSubscribe=function(e){t.JudgeUtils.isPromise(e)&&(e=t.fromPromise(e)),this._streamGroup.addChild(e),this._groupDisposable.add(e.buildStream(r.create(this,this._streamGroup,e)))},i.prototype.onNext=function(t){return this._isReachMaxConcurrent()?(this.activeCount++,void this.handleSubscribe(t)):void this.q.push(t)},i.prototype.onError=function(t){this.currentObserver.error(t)},i.prototype.onCompleted=function(){this.done=!0,0===this._streamGroup.getCount()&&this.currentObserver.completed()},i.prototype._isReachMaxConcurrent=function(){return this.activeCount<this._maxConcurrent},__decorate([t.require(function(n){t.assert(n instanceof t.Stream||t.JudgeUtils.isPromise(n),e.info.FUNC_MUST_BE("innerSource","Stream or Promise"))})],i.prototype,"onNext",null),i}(t.Observer);t.MergeObserver=n;var r=function(t){function e(e,n,r){t.call(this,null,null,null),this._parent=null,this._streamGroup=null,this._currentStream=null,this._parent=e,this._streamGroup=n,this._currentStream=r}return __extends(e,t),e.create=function(t,e,n){var r=new this(t,e,n);return r},e.prototype.onNext=function(t){this._parent.currentObserver.next(t)},e.prototype.onError=function(t){this._parent.currentObserver.error(t)},e.prototype.onCompleted=function(){var t=this._parent;this._streamGroup.removeChild(this._currentStream),t.q.length>0?(t.activeCount=0,t.handleSubscribe(t.q.shift())):this._isAsync()&&0===this._streamGroup.getCount()&&t.currentObserver.completed()},e.prototype._isAsync=function(){return this._parent.done},e}(t.Observer)}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(t){function e(e){t.call(this,null,null,null),this._prevObserver=null,this._prevObserver=e}return __extends(e,t),e.create=function(t){return new this(t)},e.prototype.onNext=function(t){this._prevObserver.completed()},e.prototype.onError=function(t){this._prevObserver.error(t)},e.prototype.onCompleted=function(){},e}(t.Observer);t.TakeUntilObserver=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(t){function e(e,n){t.call(this,null,null,null),this.currentObserver=null,this._startNextStream=null,this.currentObserver=e,this._startNextStream=n}return __extends(e,t),e.create=function(t,e){return new this(t,e)},e.prototype.onNext=function(t){this.currentObserver.next(t)},e.prototype.onError=function(t){this.currentObserver.error(t)},e.prototype.onCompleted=function(){this._startNextStream()},e}(t.Observer);t.ConcatObserver=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(){function e(){this.observers=wdCb.Collection.create(),this._disposable=null}return e.prototype.isEmpty=function(){return 0===this.observers.getCount()},e.prototype.next=function(t){this.observers.forEach(function(e){e.next(t)})},e.prototype.error=function(t){this.observers.forEach(function(e){e.error(t)})},e.prototype.completed=function(){this.observers.forEach(function(t){t.completed()})},e.prototype.addChild=function(t){this.observers.addChild(t),t.setDisposable(this._disposable)},e.prototype.removeChild=function(e){this.observers.removeChild(function(n){return t.JudgeUtils.isEqual(n,e)})},e.prototype.dispose=function(){this.observers.forEach(function(t){t.dispose()}),this.observers.removeAllChildren()},e.prototype.setDisposable=function(t){this.observers.forEach(function(e){e.setDisposable(t)}),this._disposable=t},e}();t.SubjectObserver=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(t){function e(e){t.call(this,null,null,null),this._currentObserver=null,this._currentObserver=e}return __extends(e,t),e.create=function(t){return new this(t)},e.prototype.onNext=function(t){},e.prototype.onError=function(t){this._currentObserver.error(t)},e.prototype.onCompleted=function(){this._currentObserver.completed()},e}(t.Observer);t.IgnoreElementsObserver=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(t){function e(e,n,r){t.call(this,null,null,null),this.prevObserver=null,this.source=null,this.i=0,this.predicate=null,this.prevObserver=e,this.predicate=n,this.source=r}return __extends(e,t),e.create=function(t,e,n){return new this(t,e,n)},e.prototype.onNext=function(t){try{this.predicate(t,this.i++,this.source)&&this.prevObserver.next(t)}catch(e){this.prevObserver.error(e)}},e.prototype.onError=function(t){this.prevObserver.error(t)},e.prototype.onCompleted=function(){this.prevObserver.completed()},e}(t.Observer);t.FilterObserver=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._isTrigger=!1}return __extends(n,e),n.create=function(t,e,n){return new this(t,e,n)},n.prototype.onNext=function(e){var n=null;try{this.predicate(e,this.i++,this.source)?(n=this._isTrigger?{value:e,state:t.FilterState.TRIGGER}:{value:e,state:t.FilterState.ENTER},this.prevObserver.next(n),this._isTrigger=!0):(this._isTrigger&&(n={value:e,state:t.FilterState.LEAVE},this.prevObserver.next(n)),this._isTrigger=!1)}catch(r){this.prevObserver.error(r)}},n}(t.FilterObserver);t.FilterWithStateObserver=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.prototype.subscribe=function(e,n,r){var i=null;if(!this.handleSubject(e))return i=e instanceof t.Observer?t.AutoDetachObserver.create(e):t.AutoDetachObserver.create(e,n,r),i.setDisposable(this.buildStream(i)),i},n.prototype.buildStream=function(t){return e.prototype.buildStream.call(this,t),this.subscribeCore(t);
},n}(t.Stream);t.BaseStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(n,r,i,o){e.call(this,null),this._source=null,this._observer=null,this._source=n,this._observer=t.AnonymousObserver.create(r,i,o),this.scheduler=this._source.scheduler}return __extends(n,e),n.create=function(t,e,n,r){var i=new this(t,e,n,r);return i},n.prototype.subscribeCore=function(e){return this._source.buildStream(t.DoObserver.create(e,this._observer))},n}(t.BaseStream);t.DoStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(t,n){e.call(this,null),this._source=null,this._selector=null,this._source=t,this.scheduler=this._source.scheduler,this._selector=n}return __extends(n,e),n.create=function(t,e){var n=new this(t,e);return n},n.prototype.subscribeCore=function(e){return this._source.buildStream(t.MapObserver.create(e,this._selector))},n}(t.BaseStream);t.MapStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(t,n){e.call(this,null),this._array=null,this._array=t,this.scheduler=n}return __extends(n,e),n.create=function(t,e){var n=new this(t,e);return n},n.prototype.subscribeCore=function(e){function n(t){i>t?(e.next(r[t]),arguments.callee(t+1)):e.completed()}var r=this._array,i=r.length;return this.scheduler.publishRecursive(e,0,n),t.SingleDisposable.create()},n}(t.BaseStream);t.FromArrayStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(t,n){e.call(this,null),this._promise=null,this._promise=t,this.scheduler=n}return __extends(n,e),n.create=function(t,e){var n=new this(t,e);return n},n.prototype.subscribeCore=function(e){return this._promise.then(function(t){e.next(t),e.completed()},function(t){e.error(t)},e),t.SingleDisposable.create()},n}(t.BaseStream);t.FromPromiseStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(t,n){e.call(this,null),this._addHandler=null,this._removeHandler=null,this._addHandler=t,this._removeHandler=n}return __extends(n,e),n.create=function(t,e){var n=new this(t,e);return n},n.prototype.subscribeCore=function(e){function n(t){e.next(t)}var r=this;return this._addHandler(n),t.SingleDisposable.create(function(){r._removeHandler(n)})},n}(t.BaseStream);t.FromEventPatternStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(n){e.call(this,n),this.scheduler=t.Scheduler.create()}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.subscribe=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null;if(e[0]instanceof t.Subject){var i=e[0];return void this.handleSubject(i)}if(t.JudgeUtils.isIObserver(e[0]))r=t.AutoDetachObserver.create(e[0]);else{var o=e[0],a=e[1]||null,s=e[2]||null;r=t.AutoDetachObserver.create(o,a,s)}return r.setDisposable(this.buildStream(r)),r},n}(t.Stream);t.AnonymousStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(t,n){e.call(this,null),this._interval=null,this._interval=t,this.scheduler=n}return __extends(n,e),n.create=function(t,e){var n=new this(t,e);return n.initWhenCreate(),n},n.prototype.initWhenCreate=function(){this._interval=this._interval<=0?1:this._interval},n.prototype.subscribeCore=function(e){var n=null;return n=this.scheduler.publishInterval(e,0,this._interval,function(t){return e.next(t),t+1}),t.SingleDisposable.create(function(){t.root.clearInterval(n)})},n}(t.BaseStream);t.IntervalStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(t){e.call(this,null),this._isEnd=!1,this.scheduler=t}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.subscribeCore=function(e){var n=this;return this.scheduler.publishIntervalRequest(e,function(t){return e.next(t),n._isEnd}),t.SingleDisposable.create(function(){t.root.cancelNextRequestAnimationFrame(n.scheduler.requestLoopId),n._isEnd=!0})},n}(t.BaseStream);t.IntervalRequestStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var i,o=arguments.length,a=3>o?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(i=t[s])&&(a=(3>o?i(a):o>3?i(e,n,a):i(e,n))||a);return o>3&&a&&Object.defineProperty(e,n,a),a},wdFrp;!function(t){var e=wdCb.Log,n=function(n){function r(t,e){n.call(this,null),this._time=null,this._time=t,this.scheduler=e}return __extends(r,n),r.create=function(t,e){var n=new this(t,e);return n},r.prototype.subscribeCore=function(e){var n=null;return n=this.scheduler.publishTimeout(e,this._time,function(t){e.next(t)}),t.SingleDisposable.create(function(){t.root.clearTimeout(n)})},__decorate([t.require(function(n,r){t.assert(n>0,e.info.FUNC_SHOULD("time","> 0"))})],r,"create",null),r}(t.BaseStream);t.TimeoutStream=n}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(t){e.call(this,null),this._source=null,this._observer=null,this._source=t,this.scheduler=this._source.scheduler}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.subscribeCore=function(e){var n=wdCb.Collection.create(),r=t.GroupDisposable.create();return this._source.buildStream(t.MergeAllObserver.create(e,n,r)),r},n}(t.BaseStream);t.MergeAllStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(t,n){e.call(this,null),this._source=null,this._maxConcurrent=null,this._source=t,this._maxConcurrent=n,this.scheduler=this._source.scheduler}return __extends(n,e),n.create=function(t,e){var n=new this(t,e);return n},n.prototype.subscribeCore=function(e){var n=wdCb.Collection.create(),r=t.GroupDisposable.create();return this._source.buildStream(t.MergeObserver.create(e,this._maxConcurrent,n,r)),r},n}(t.BaseStream);t.MergeStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(n,r){e.call(this,null),this._source=null,this._otherStream=null,this._source=n,this._otherStream=t.JudgeUtils.isPromise(r)?t.fromPromise(r):r,this.scheduler=this._source.scheduler}return __extends(n,e),n.create=function(t,e){var n=new this(t,e);return n},n.prototype.subscribeCore=function(e){var n=t.GroupDisposable.create(),r=t.AutoDetachObserver.create(e),i=null;return i=this._source.buildStream(e),n.add(i),r.setDisposable(i),n.add(this._otherStream.buildStream(t.TakeUntilObserver.create(r))),n},n}(t.BaseStream);t.TakeUntilStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(n){e.call(this,null),this._sources=wdCb.Collection.create();var r=this;this.scheduler=n[0].scheduler,n.forEach(function(e){t.JudgeUtils.isPromise(e)?r._sources.addChild(t.fromPromise(e)):r._sources.addChild(e)})}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.subscribeCore=function(e){function n(a){return a===i?void e.completed():void o.add(r._sources.getChild(a).buildStream(t.ConcatObserver.create(e,function(){n(a+1)})))}var r=this,i=this._sources.getCount(),o=t.GroupDisposable.create();return this.scheduler.publishRecursive(e,0,n),t.GroupDisposable.create(o)},n}(t.BaseStream);t.ConcatStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(t,n){e.call(this,null),this._source=null,this._count=null,this._source=t,this._count=n,this.scheduler=this._source.scheduler}return __extends(n,e),n.create=function(t,e){var n=new this(t,e);return n},n.prototype.subscribeCore=function(e){function n(o){return 0===o?void e.completed():void i.add(r._source.buildStream(t.ConcatObserver.create(e,function(){n(o-1)})))}var r=this,i=t.GroupDisposable.create();return this.scheduler.publishRecursive(e,this._count,n),t.GroupDisposable.create(i)},n}(t.BaseStream);t.RepeatStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(t){e.call(this,null),this._source=null,this._source=t,this.scheduler=this._source.scheduler}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.subscribeCore=function(e){return this._source.buildStream(t.IgnoreElementsObserver.create(e))},n}(t.BaseStream);t.IgnoreElementsStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(t){e.call(this,null),this._buildStreamFunc=null,this._buildStreamFunc=t}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.subscribeCore=function(e){var n=t.GroupDisposable.create();return n.add(this._buildStreamFunc().buildStream(e)),n},n}(t.BaseStream);t.DeferStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(t,n,r){e.call(this,null),this.predicate=null,this._source=null,this._source=t,this.predicate=wdCb.FunctionUtils.bind(r,n)}return __extends(n,e),n.create=function(t,e,n){var r=new this(t,e,n);return r},n.prototype.subscribeCore=function(t){return this._source.subscribe(this.createObserver(t))},n.prototype.internalFilter=function(t,e){return this.createStreamForInternalFilter(this._source,this._innerPredicate(t,this),e)},n.prototype.createObserver=function(e){return t.FilterObserver.create(e,this.predicate,this)},n.prototype.createStreamForInternalFilter=function(t,e,r){return n.create(t,e,r)},n.prototype._innerPredicate=function(t,e){var n=this;return function(r,i,o){return e.predicate(r,i,o)&&t.call(n,r,i,o)}},n}(t.BaseStream);t.FilterStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t,e,n){var r=new this(t,e,n);return r},n.prototype.createObserver=function(e){return t.FilterWithStateObserver.create(e,this.predicate,this)},n.prototype.createStreamForInternalFilter=function(t,e,r){return n.create(t,e,r)},n}(t.FilterStream);t.FilterWithStateStream=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){t.createStream=function(e){return t.AnonymousStream.create(e)},t.fromArray=function(e,n){return void 0===n&&(n=t.Scheduler.create()),t.FromArrayStream.create(e,n)},t.fromPromise=function(e,n){return void 0===n&&(n=t.Scheduler.create()),t.FromPromiseStream.create(e,n)},t.fromEventPattern=function(e,n){return t.FromEventPatternStream.create(e,n)},t.interval=function(e,n){return void 0===n&&(n=t.Scheduler.create()),t.IntervalStream.create(e,n)},t.intervalRequest=function(e){return void 0===e&&(e=t.Scheduler.create()),t.IntervalRequestStream.create(e)},t.timeout=function(e,n){return void 0===n&&(n=t.Scheduler.create()),t.TimeoutStream.create(e,n)},t.empty=function(){return t.createStream(function(t){t.completed()})},t.callFunc=function(e,n){return void 0===n&&(n=t.root),t.createStream(function(t){try{t.next(e.call(n,null))}catch(r){t.error(r)}t.completed()})},t.judge=function(t,e,n){return t()?e():n()},t.defer=function(e){return t.DeferStream.create(e)},t.just=function(e){return t.createStream(function(t){t.next(e),t.completed()})}}(wdFrp||(wdFrp={}));var wdFrp;!function(t){!function(t){t[t.TRIGGER=0]="TRIGGER",t[t.ENTER=1]="ENTER",t[t.LEAVE=2]="LEAVE"}(t.FilterState||(t.FilterState={}));t.FilterState}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(t,e){return t===e},n=function(){function t(t,n,r,i){this._time=null,this._value=null,this._actionType=null,this._comparer=null,this._time=t,this._value=n,this._actionType=r,this._comparer=i||e}return t.create=function(t,e,n,r){var i=new this(t,e,n,r);return i},Object.defineProperty(t.prototype,"time",{get:function(){return this._time},set:function(t){this._time=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"value",{get:function(){return this._value},set:function(t){this._value=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"actionType",{get:function(){return this._actionType},set:function(t){this._actionType=t},enumerable:!0,configurable:!0}),t.prototype.equals=function(t){return this._time===t.time&&this._comparer(this._value,t.value)},t}();t.Record=n}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(t){e.call(this,null,null,null),this._messages=[],this._scheduler=null,this._scheduler=t}return __extends(n,e),n.create=function(t){var e=new this(t);return e},Object.defineProperty(n.prototype,"messages",{get:function(){return this._messages},set:function(t){this._messages=t},enumerable:!0,configurable:!0}),n.prototype.onNext=function(e){var n=null;n=t.JudgeUtils.isDirectObject(e)?t.Record.create(this._scheduler.clock,e,t.ActionType.NEXT,function(t,e){var n=!0;for(var r in t)if(t.hasOwnProperty(r)&&t[r]!==e[r]){n=!1;break}return n}):t.Record.create(this._scheduler.clock,e,t.ActionType.NEXT),this._messages.push(n)},n.prototype.onError=function(e){this._messages.push(t.Record.create(this._scheduler.clock,e,t.ActionType.ERROR))},n.prototype.onCompleted=function(){this._messages.push(t.Record.create(this._scheduler.clock,null,t.ActionType.COMPLETED))},n.prototype.dispose=function(){e.prototype.dispose.call(this),this._scheduler.remove(this)},n.prototype.clone=function(){var t=n.create(this._scheduler);return t.messages=this._messages,t},n}(t.Observer);t.MockObserver=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(){function t(t,e){this._messages=[],this._scheduler=null,this._scheduler=t,this._messages=e}return t.create=function(t,e){var n=new this(t,e);return n},t.prototype.then=function(t,e,n){this._scheduler.setStreamMap(n,this._messages)},t}();t.MockPromise=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=200,n=1e3,r=function(r){function i(t){r.call(this),this._clock=null,this._isReset=!1,this._isDisposed=!1,this._timerMap=wdCb.Hash.create(),this._streamMap=wdCb.Hash.create(),this._subscribedTime=null,this._disposedTime=null,this._observer=null,this._isReset=t}return __extends(i,r),i.next=function(e,n){return t.JudgeUtils.isDirectObject(n)?t.Record.create(e,n,t.ActionType.NEXT,function(t,e){var n=!0;for(var r in t)if(t.hasOwnProperty(r)&&t[r]!==e[r]){n=!1;break}return n}):t.Record.create(e,n,t.ActionType.NEXT)},i.error=function(e,n){return t.Record.create(e,n,t.ActionType.ERROR)},i.completed=function(e){return t.Record.create(e,null,t.ActionType.COMPLETED)},i.create=function(t){void 0===t&&(t=!1);var e=new this(t);return e},Object.defineProperty(i.prototype,"clock",{get:function(){return this._clock},set:function(t){this._clock=t},enumerable:!0,configurable:!0}),i.prototype.setStreamMap=function(e,n){var r=this;n.forEach(function(n){var i=null;switch(n.actionType){case t.ActionType.NEXT:i=function(){e.next(n.value)};break;case t.ActionType.ERROR:i=function(){e.error(n.value)};break;case t.ActionType.COMPLETED:i=function(){e.completed()};break;default:wdCb.Log.error(!0,wdCb.Log.info.FUNC_UNKNOW("actionType"))}r._streamMap.addChild(String(n.time),i)})},i.prototype.remove=function(t){this._isDisposed=!0},i.prototype.publishRecursive=function(t,e,n){var r=this,i=null,o=null;this._setClock(),i=t.next,o=t.completed,t.next=function(e){i.call(t,e),r._tick(1)},t.completed=function(){o.call(t),r._tick(1)},n(e)},i.prototype.publishInterval=function(t,e,n,r){var o=10,a=[];for(this._setClock();o>0&&!this._isDisposed;)this._tick(n),a.push(i.next(this._clock,e)),e++,o--;return this.setStreamMap(t,a),NaN},i.prototype.publishIntervalRequest=function(t,e){var n=10,r=[],o=100,a=0;for(this._setClock();n>0&&!this._isDisposed;)this._tick(o),r.push(i.next(this._clock,a)),a++,n--;return this.setStreamMap(t,r),NaN},i.prototype.publishTimeout=function(t,e,n){var r=[];return this._setClock(),this._tick(e),r.push(i.next(this._clock,e),i.completed(this._clock+1)),this.setStreamMap(t,r),NaN},i.prototype._setClock=function(){this._isReset&&(this._clock=this._subscribedTime)},i.prototype.startWithTime=function(t,e,n){var r,i,o=this.createObserver(),a=this;return this._subscribedTime=e,this._disposedTime=n,this._clock=e,this._runAt(e,function(){r=t(),i=r.subscribe(o)}),this._runAt(n,function(){i.dispose(),a._isDisposed=!0}),this._observer=o,this.start(),o},i.prototype.startWithSubscribe=function(t,r){return void 0===r&&(r=e),this.startWithTime(t,r,n)},i.prototype.startWithDispose=function(t,r){return void 0===r&&(r=n),this.startWithTime(t,e,r)},i.prototype.publicAbsolute=function(t,e){this._runAt(t,function(){e()})},i.prototype.start=function(){for(var t=this._getMinAndMaxTime(),e=t[0],n=t[1],r=e;n>=r;)this._clock=r,this._exec(r,this._timerMap),this._clock=r,this._runStream(r),r++,n=this._getMinAndMaxTime()[1]},i.prototype.createStream=function(e){return t.TestStream.create(Array.prototype.slice.call(arguments,0),this)},i.prototype.createObserver=function(){return t.MockObserver.create(this)},i.prototype.createResolvedPromise=function(e,n){return t.MockPromise.create(this,[i.next(e,n),i.completed(e+1)])},i.prototype.createRejectPromise=function(e,n){return t.MockPromise.create(this,[i.error(e,n)])},i.prototype._getMinAndMaxTime=function(){var t=this._timerMap.getKeys().addChildren(this._streamMap.getKeys());return t=t.map(function(t){return Number(t)}).toArray(),[Math.min.apply(Math,t),Math.max.apply(Math,t)]},i.prototype._exec=function(t,e){var n=e.getChild(String(t));n&&n()},i.prototype._runStream=function(t){var e=this._streamMap.getChild(String(t));e&&e()},i.prototype._runAt=function(t,e){this._timerMap.addChild(String(t),e)},i.prototype._tick=function(t){this._clock+=t},i}(t.Scheduler);t.TestScheduler=r}(wdFrp||(wdFrp={}));var wdFrp;!function(t){!function(t){t[t.NEXT=0]="NEXT",t[t.ERROR=1]="ERROR",t[t.COMPLETED=2]="COMPLETED"}(t.ActionType||(t.ActionType={}));t.ActionType}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(t,n){e.call(this,null),this.scheduler=null,this._messages=null,this._messages=t,this.scheduler=n}return __extends(n,e),n.create=function(t,e){var n=new this(t,e);return n},n.prototype.subscribeCore=function(e){return this.scheduler.setStreamMap(e,this._messages),t.SingleDisposable.create()},n}(t.BaseStream);t.TestStream=e}(wdFrp||(wdFrp={}));var wd;!function(t){t.DebugConfig={isTest:!1,debugCollision:!1,showDebugPanel:!1}}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.clear=function(){this.count.renderGameObjects=0,this.count.drawCalls=0},e.init=function(){var e=this;this._startLoopSubscription=t.EventManager.fromEvent(t.EEngineEvent.STARTLOOP).subscribe(function(){t.DebugConfig.showDebugPanel&&(console.log("totalGameObjects:"+e.count.totalGameObjects+", renderGameObjects:"+e.count.renderGameObjects+", drawCalls:"+e.count.drawCalls),console.log("fps:"+e.during.fps),e.clear())})},e.dispose=function(){this._startLoopSubscription.dispose()},e.count={get totalGameObjects(){var e=0;return t.Director.getInstance().scene.getChildren().forEach(function(n){return n.hasComponent(t.SpacePartition)?void(e+=n.getComponent(t.SpacePartition).getChildren().getCount()):void e++}),e},renderGameObjects:0,drawCalls:0},e.during={get fps(){return t.Director.getInstance().fps}},e._startLoopSubscription=null,e}();t.DebugStatistics=e}(wd||(wd={}));var wdFrp;!function(t){t.fromCollection=function(e,n){void 0===n&&(n=t.Scheduler.create());var r=e.toArray();return 0===r.length?t.empty():t.fromArray(r,n)}}(wdFrp||(wdFrp={}));var wd;!function(t){t.CompileConfig={isTest:!0}}(wd||(wd={}));var wd;!function(t){function e(e,n){void 0===n&&(n="contract error"),t.Log.error(!e,n)}function n(e){return function(n,r,i){if(t.CompileConfig.isTest){var o=i.value;i.value=function(n){return t.Main.isTest&&e.apply(this,arguments),o.apply(this,arguments)}}return i}}function r(e){return function(n,r,i){if(t.CompileConfig.isTest){var o=i.value;i.value=function(n){var r=o.apply(this,arguments);if(t.Main.isTest){for(var i=[r],a=0,s=arguments.length;s>a;a++)i[a+1]=arguments[a];e.apply(this,i)}return r}}return i}}function i(e,n){return function(r,i,o){if(t.CompileConfig.isTest){var a=o.get,s=o.set;o.get=function(){return t.Main.isTest&&e.call(this),a.call(this)},o.set=function(e){t.Main.isTest&&n.call(this,e),s.call(this,e)}}return o}}function o(e){return function(n,r,i){if(t.CompileConfig.isTest){var o=i.get;i.get=function(){return t.Main.isTest&&e.call(this),o.call(this)}}return i}}function a(e){return function(n,r,i){if(t.CompileConfig.isTest){var o=i.set;i.set=function(n){t.Main.isTest&&e.call(this,n),o.call(this,n)}}return i}}function s(e,n){return function(r,i,o){if(t.CompileConfig.isTest){var a=o.get,s=o.set;o.get=function(){var n=a.call(this);return t.Main.isTest&&e.call(this,n),n},o.set=function(e){var r=s.call(this,e);if(t.Main.isTest){var i=[r,e];n.apply(this,i)}}}return o}}function c(e){return function(n,r,i){if(t.CompileConfig.isTest){var o=i.get;i.get=function(){var n=o.call(this);return t.Main.isTest&&e.call(this,n),n}}return i}}function u(e){return function(n,r,i){if(t.CompileConfig.isTest){var o=i.set;i.set=function(n){var r=o.call(this,n);if(t.Main.isTest){var i=[r,n];e.apply(this,i)}}}return i}}function l(e){return function(n){t.CompileConfig.isTest&&t.Main.isTest&&e(n)}}t.assert=e,t.require=n,t.ensure=r,t.requireGetterAndSetter=i,t.requireGetter=o,t.requireSetter=a,t.ensureGetterAndSetter=s,t.ensureGetter=c,t.ensureSetter=u,t.invariant=l}(wd||(wd={}));var wd;!function(t){function e(t,e,n){return function(r,i,o){var a=o.get;return o.get=function(){var r=null;return t.call(this)?e.call(this):(r=a.call(this),n.call(this,r),r)},o}}function n(t,e,n){return function(r,i,o){var a=o.value;return o.value=function(r){var i=null,o=null;if(t.apply(this,arguments))return e.apply(this,arguments);i=a.apply(this,arguments),o=[i];for(var s=0,c=arguments.length;c>s;s++)o[s+1]=arguments[s];return n.apply(this,o),i},o}}t.cacheGetter=e,t.cache=n}(wd||(wd={}));var wd;!function(t){function e(t,e,n){return n}t.virtual=e}(wd||(wd={}));var wd;!function(t){function e(t){return function(e,n,r){var o=r.get,a=r.set;return r.get=function(){if(this.isPhysicsEngineAdapterExist()){var e=this.getPhysicsEngineAdapter()["get"+t](this.entityObject);return null!==e?e:this["_"+i(t)]}return o.call(this)},r.set=function(e){a.call(this,e),this.isPhysicsEngineAdapterExist()&&this.getPhysicsEngineAdapter()["set"+t](this.entityObject,e)},r}}function n(e){return function(n,o,a){var s=a.get,c=a.set;return a.get=function(){var n=t.Director.getInstance().scene;if(r(n)){var o=n.physicsEngineAdapter["get"+e]();return null!==o?o:this["_"+i(e)]}return s.call(this)},a.set=function(n){var i=t.Director.getInstance().scene;c.call(this,n),r(i)&&i.physicsEngineAdapter["set"+e](n)},a}}function r(t){return t.physicsEngineAdapter&&t.physicsEngineAdapter.world}function i(t){var e=t.slice(0,1);return""+e.toLowerCase()+t.slice(1)}t.operateBodyDataGetterAndSetter=e,t.operateWorldDataGetterAndSetter=n}(wd||(wd={}));var wd;!function(t){function e(e){return function(n){t.Script.addScript(e,n)}}t.script=e}(wd||(wd={}));var wd;!function(t){function e(t){return function(e,n,r){var i=r.value;return r.value=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];return this[t]?void 0:(this[t]=!0,i.apply(this,e))},r}}t.execOnlyOnce=e}(wd||(wd={}));var wd;!function(t){t.ABSTRACT_ATTRIBUTE=null}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.isView=function(t){return!!t&&t.offset&&t.width&&t.height&&this.isFunction(t.getContext)},n.isEqual=function(t,e){return!t&&e||t&&!e?!1:t.uid&&e.uid?t.uid===e.uid:t===e},n.isPowerOfTwo=function(t){return 0===(t&t-1)&&0!==t},n.isFloatArray=function(e){return"[object Float32Array]"===t.EntityObject.prototype.toString.call(e)||"[object Float16Array]"===t.EntityObject.prototype.toString.call(e)},n.isInterface=function(t,e){return!!t[e]},n.isSpacePartitionObject=function(e){return e.hasComponent(t.SpacePartition)},n.isSelf=function(t,e){return t.uid===e.uid},n.isComponenet=function(t){return void 0!==t.entityObject},n.isDom=function(t){return null!==Object.prototype.toString.call(t).match(/\[object HTML\w+/)},n.isCollection=function(t){return t instanceof wdCb.Collection},n}(wdCb.JudgeUtils);t.JudgeUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.hasRepeatItems=function(t){for(var e=[],n=!1,r=0,i=t;r<i.length;r++){var o=i[r];if(o){if(this.contain(e,o)){n=!0;break}e.push(o)}}return n},e.contain=function(t,e){for(var n=null,r=0,i=t.length;i>r;r++){if(n=t[r],e.uid&&n.uid&&e.uid==n.uid)return!0;if(e===n)return!0}return!1},e}(wdCb.ArrayUtils);t.ArrayUtils=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var i,o=arguments.length,a=3>o?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(i=t[s])&&(a=(3>o?i(a):o>3?i(e,n,a):i(e,n))||a);return o>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(){}return e.getClassName=function(t){return t.constructor.name},__decorate([t.require(function(e){t.assert(t.JudgeUtils.isFunction(e.constructor),t.Log.info.FUNC_MUST_BE("objInstance.constructor","Function"))}),t.ensure(function(e){t.assert(!!e,t.Log.info.FUNC_CAN_NOT("get class name from objInstance.constructor.name"))})],e,"getClassName",null),e}();t.ClassUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t.insertSort=function(t,e,n){void 0===n&&(n=!1);for(var r=n?t:wdCb.ExtendUtils.extend([],t),i=1,o=r.length;o>i;i++)for(var a=i;a>0&&e(r[a],r[a-1]);a--)this._swap(r,a-1,a);return r},t.quickSort=function(t,e,n){void 0===n&&(n=!1);var r=n?t:wdCb.ExtendUtils.extend([],t),i=function(t,n){if(!(t>=n)){for(var o=t,a=n,s=r[t];a>o;){for(;a>o&&e(s,r[a]);)a--;for(a>o&&(r[o++]=r[a]);a>o&&e(r[o],s);)o++;a>o&&(r[a--]=r[o])}r[o]=s,i(t,o-1),i(o+1,n)}};return i(0,r.length-1),r},t._swap=function(t,e,n){var r=null;r=t[e],t[e]=t[n],t[n]=r},t}();t.SortUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.clamp=function(t,e,n){return e>t?e:t>n?n:t},e.bigThan=function(t,e){return e>t?e:t},e.generateZeroToOne=function(){return Math.random()},e.generateInteger=function(t,e){var e=e+1;return Math.floor(Math.random()*(e-t)+t)},e.mod=function(t,e){var n=Math.floor(t/e);return t-=n*e,0>t&&(t+=e),t},e.maxFloorIntegralMultiple=function(t,e){return 0==e?t:e>t?0:Math.floor(t/e)*e},__decorate([t.require(function(e,n){t.assert(n>e,t.Log.info.FUNC_SHOULD("min","< max"))})],e,"generateInteger",null),__decorate([t.ensure(function(e){t.assert(e>=0)})],e,"mod",null),__decorate([t.require(function(e,n){t.assert(e>=0&&n>=0,t.Log.info.FUNC_SHOULD("param",">= 0"))}),t.ensure(function(e){t.assert(e>=0)})],e,"maxFloorIntegralMultiple",null),e}();t.MathUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.convertWebGLPositionToCanvasPosition=function(e){var n=t.DeviceManager.getInstance().view;return t.Vector2.create(n.width/2+e.x,n.height/2-e.y)},e.convertCanvasPositionToWebGLPosition=function(e){var n=t.DeviceManager.getInstance().view;return t.Vector3.create(e.x-n.width/2,n.height/2-e.y,0)},e.convertLeftCornerPositionToCenterPosition=function(e,n,r){return t.Vector2.create(this.convertLeftCornerPositionXToCenterPositionX(e.x,n),this.convertLeftCornerPositionYToCenterPositionY(e.y,r))},e.convertLeftCornerPositionXToCenterPositionX=function(t,e){return t+e/2},e.convertLeftCornerPositionYToCenterPositionY=function(t,e){return t+e/2},e.convertCenterPositionToLeftCornerPosition=function(e,n,r){return t.Vector2.create(this.convertCenterPositionXToLeftCornerPositionX(e.x,n),this.convertCenterPositionYToLeftCornerPositionY(e.y,r))},e.convertCenterPositionXToLeftCornerPositionX=function(t,e){return t-e/2},e.convertCenterPositionYToLeftCornerPositionY=function(t,e){return t-e/2},__decorate([t.require(function(){t.assert(!!t.DeviceManager.getInstance().view,t.Log.info.FUNC_SHOULD("set view"))})],e,"convertWebGLPositionToCanvasPosition",null),
__decorate([t.require(function(){t.assert(!!t.DeviceManager.getInstance().view,t.Log.info.FUNC_SHOULD("set view"))})],e,"convertCanvasPositionToWebGLPosition",null),e}();t.CoordinateUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.getGameObjectRenderList=function(e){return e.filter(function(e,n){return e.isVisible&&!t.InstanceUtils.isObjectInstance(e)})},e.getGameObjectRenderListForOctree=function(t){return t.filter(function(t){return t.isVisible})},e}();t.RenderUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.isHardwareSupport=function(){return null!==t.GPUDetector.getInstance().extensionInstancedArrays},e.isInstance=function(e){return e.hasComponent(t.Instance)},e.isSourceInstance=function(e){return e.hasComponent(t.SourceInstance)},e.isObjectInstance=function(e){return e.hasComponent(t.ObjectInstance)},e.addModelMatrixShaderLib=function(n,r){return r?e.isInstance(r)?e.isHardwareSupport()?void n.addLib(t.ModelMatrixHardwareInstanceShaderLib.create()):void n.addLib(t.ModelMatrixBatchInstanceShaderLib.create()):void n.addLib(t.ModelMatrixNoInstanceShaderLib.create()):void 0},e.addNormalModelMatrixShaderLib=function(n,r){return r?e.isInstance(r)?e.isHardwareSupport()?void n.addLib(t.NormalMatrixHardwareInstanceShaderLib.create()):void n.addLib(t.NormalMatrixBatchInstanceShaderLib.create()):void n.addLib(t.NormalMatrixNoInstanceShaderLib.create()):void 0},e}();t.InstanceUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t.forEachAll=function(t,e){var n=function(t){e(t),t.forEach(function(t){n(t)})};n(t)},t}();t.IterateUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(wdCb.Log);t.Log=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.hasAnimation=function(e){return e instanceof t.ModelGeometry?e.hasAnimation():!1},e}();t.GlobalGeometryUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.handlerAfterLoadedScript=function(e){t.ScriptEngine.getInstance().execEntityObjectScriptOnlyOnce(e,"onEnter"),t.ScriptEngine.getInstance().execEntityObjectScriptOnlyOnce(e,"init")},e.addScriptToEntityObject=function(e,n){t.ScriptEngine.getInstance().addChild(e,n.name,new n["class"](e))},e}();t.GlobalScriptUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.elapsed=null,this.pauseElapsed=0,this.pauseTime=null,this.startTime=null}return e.prototype.start=function(){this.startTime=this.getNow(),this.pauseElapsed=null},e.prototype.stop=function(){this.startTime=null},e.prototype.pause=function(){this.pauseTime=this.getNow()},e.prototype.resume=function(){this.pauseElapsed+=this.getNow()-this.pauseTime,this.pauseTime=null},e.prototype.computeElapseTime=function(t){return this.pauseElapsed?this.elapsed=t-this.pauseElapsed-this.startTime:this.elapsed=t-this.startTime,this.elapsed<0&&(this.elapsed=0),this.elapsed},__decorate([t.ensure(function(){t.assert(this.elapsed>=0,t.Log.info.FUNC_SHOULD("elapsed:"+this.elapsed,">= 0"))})],e.prototype,"computeElapseTime",null),e}();t.TimeController=e}(wd||(wd={}));var wd;!function(t){var e=60,n=1e3,r=function(r){function i(){r.apply(this,arguments),this.gameTime=null,this.fps=null,this.isTimeChange=!1,this.deltaTime=null,this._lastTime=null}return __extends(i,r),i.create=function(){var t=new this;return t},i.prototype.tick=function(t){this.deltaTime=null!==this._lastTime?t-this._lastTime:t,this._updateFps(this.deltaTime),this.gameTime=t/n,this._lastTime=t},i.prototype.start=function(){r.prototype.start.call(this),this.isTimeChange=!0,this.elapsed=0},i.prototype.resume=function(){r.prototype.resume.call(this),this.isTimeChange=!0},i.prototype.getNow=function(){return t.root.performance.now()},i.prototype._updateFps=function(t){null===this._lastTime?this.fps=e:this.fps=1e3/t},i}(t.TimeController);t.DirectorTimeController=r}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.getNow=function(){return t.Director.getInstance().isTimeChange?t.Director.getInstance().elapsed:t.root.performance.now()},n}(t.TimeController);t.CommonTimeController=e}(wd||(wd={}));var wd;!function(t){function e(t){return h(p.BASIC,wdCb.ExtendUtils.extend({order:0},t))}function n(t){return h(p.CLONEABLE,wdCb.ExtendUtils.extend({order:0,isInjectTarget:!1},t))}function r(t,e){return h(p.CUSTOM,t,wdCb.ExtendUtils.extend({order:0},e))}var i="not_clone",o=function(t){return t[l(t)]},a=function(t,e){t[l(t)]=e},s=function(t){var e="__decorator_clone",n=null;for(var r in t)if(t.hasOwnProperty(r)&&r.indexOf(e)>-1){n=t[r];break}return n},c=function(e){var n="__decorator_clone_isGathered_"+t.ClassUtils.getClassName(e)+"_cloneAttributeMembers",r=wdCb.Collection.create(),i=function(e){if(e){if(e[n]){var a=o(e);return t.assert(a,t.Log.info.FUNC_NOT_EXIST(""+l(e))),void r.addChildren(a)}i(e.__proto__);var c=s(e);c&&r.addChildren(c)}},c=function(){a(e.__proto__,r),e.__proto__[n]=!0};return i(e.__proto__),c(),o(e)},u=function(t){a(t,wdCb.Collection.create())},l=function(e){return"__decorator_clone_"+t.ClassUtils.getClassName(e)+"_cloneAttributeMembers"},h=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return function(n,r){o(n)||u(n),1===e.length?o(n).addChild({memberName:r,cloneType:t,configData:e[0]}):2===e.length&&o(n).addChild({memberName:r,cloneType:t,cloneFunc:e[0],configData:e[1]})}};t.cloneAttributeAsBasicType=e,t.cloneAttributeAsCloneable=n,t.cloneAttributeAsCustomType=r;var d=function(){function e(){}return e.clone=function(e,n,r){void 0===n&&(n=null),void 0===r&&(r=null);var i=c(e).sort(function(t,e){return t.configData.order-e.configData.order}),o=t.ClassUtils.getClassName(e),a=null;return a=r?t[o].create.apply(t[o],r):t[o].create(),i?(i.forEach(function(t){var r=t.cloneType,i=t.memberName;switch(r){case p.CLONEABLE:var o=t.configData;null!==e[i]&&void 0!==e[i]&&(o.isInjectTarget===!0?a[i]=e[i].clone(a):a[i]=e[i].clone());break;case p.BASIC:a[i]=e[i];break;case p.CUSTOM:var s=t.cloneFunc;s.call(a,e,a,i,n)}}),a):a},e.cloneArray=function(t){return[].concat(t)},e.markNotClone=function(t){t.hasTag(i)||t.addTag(i)},e.isNotClone=function(t){return t.hasTag(i)},__decorate([t.require(function(e,n,r){void 0===n&&(n=null),void 0===r&&(r=null),r&&t.assert(t.JudgeUtils.isArrayExactly(r),t.Log.info.FUNC_MUST_BE("param:createDataArr","be arr"))})],e,"clone",null),e}();t.CloneUtils=d,function(t){t[t.CLONEABLE=0]="CLONEABLE",t[t.BASIC=1]="BASIC",t[t.CUSTOM=2]="CUSTOM"}(t.CloneType||(t.CloneType={}));var p=t.CloneType}(wd||(wd={}));var wd;!function(t){t.DEG_TO_RAD=Math.PI/180,t.RAD_TO_DEG=180/Math.PI}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];this.values=new Float32Array(2),t.length>0&&(this.values[0]=t[0],this.values[1]=t[1])}return t.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=null;return n=0===t.length?new this:new this(t[0],t[1])},Object.defineProperty(t.prototype,"x",{get:function(){return this.values[0]},set:function(t){this.values[0]=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this.values[1]},set:function(t){this.values[1]=t},enumerable:!0,configurable:!0}),t.prototype.set=function(t,e){this.x=t,this.y=e},t.prototype.add=function(t){return this.values[0]=this.values[0]+t.values[0],this.values[1]=this.values[1]+t.values[1],this},t.prototype.mul=function(t){return this.values[0]=this.values[0]*t.values[0],this.values[1]=this.values[1]*t.values[1],this},t.prototype.isEqual=function(t){return this.x===t.x&&this.y===t.y},t.prototype.clone=function(){return t.create(this.x,this.y)},t}();t.Vector2=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];this.values=null,this.values=new Float32Array(3),t.length>0&&(this.values[0]=t[0],this.values[1]=t[1],this.values[2]=t[2])}return e.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=null;return n=0===t.length?new this:new this(t[0],t[1],t[2])},Object.defineProperty(e.prototype,"x",{get:function(){return this.values[0]},set:function(t){this.values[0]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this.values[1]},set:function(t){this.values[1]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"z",{get:function(){return this.values[2]},set:function(t){this.values[2]=t},enumerable:!0,configurable:!0}),e.prototype.normalize=function(){var t=this.values,e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);return 0===e?(t[0]=0,t[1]=0,t[2]=0,this):(t[0]=t[0]/e,t[1]=t[1]/e,t[2]=t[2]/e,t[0]===-0&&(t[0]=0),t[1]===-0&&(t[1]=0),t[2]===-0&&(t[2]=0),this)},e.prototype.isZero=function(){var t=this.values;return 0===t[0]&&0===t[1]&&0===t[2]},e.prototype.scale=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=this.values;if(1===t.length){var r=t[0];n[0]*=r,n[1]*=r,n[2]*=r}else if(3===t.length){var i=t[0],o=t[1],a=t[2];n[0]*=i,n[1]*=o,n[2]*=a}return this},e.prototype.set=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];if(3===t.length)this.x=t[0],this.y=t[1],this.z=t[2];else{var n=t[0];this.x=n.x,this.y=n.y,this.z=n.z}},e.prototype.sub=function(t){return this.values[0]=this.values[0]-t.values[0],this.values[1]=this.values[1]-t.values[1],this.values[2]=this.values[2]-t.values[2],this},e.prototype.sub2=function(t,e){return this.values[0]=t.values[0]-e.values[0],this.values[1]=t.values[1]-e.values[1],this.values[2]=t.values[2]-e.values[2],this},e.prototype.add=function(t){return this.values[0]=this.values[0]+t.values[0],this.values[1]=this.values[1]+t.values[1],this.values[2]=this.values[2]+t.values[2],this},e.prototype.add2=function(t,e){return this.values[0]=t.values[0]+e.values[0],this.values[1]=t.values[1]+e.values[1],this.values[2]=t.values[2]+e.values[2],this},e.prototype.mul=function(t){return this.values[0]=this.values[0]*t.values[0],this.values[1]=this.values[1]*t.values[1],this.values[2]=this.values[2]*t.values[2],this},e.prototype.mul2=function(t,e){return this.values[0]=t.values[0]*e.values[0],this.values[1]=t.values[1]*e.values[1],this.values[2]=t.values[2]*e.values[2],this},e.prototype.reverse=function(){return this.values[0]=-this.values[0],this.values[1]=-this.values[1],this.values[2]=-this.values[2],this},e.prototype.clone=function(){var t=e.create(),n=0,r=this.values.length;for(n=0;r>n;n++)t.values[n]=this.values[n];return t},e.prototype.toVector4=function(){return t.Vector4.create(this.values[0],this.values[1],this.values[2],1)},e.prototype.length=function(){var t=this.values;return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])},e.prototype.cross=function(t,e){var n,r,i,o,a,s,c,u,l;return n=t.values,r=e.values,i=this.values,o=n[0],a=n[1],s=n[2],c=r[0],u=r[1],l=r[2],i[0]=a*l-u*s,i[1]=s*c-l*o,i[2]=o*u-c*a,this},e.prototype.lerp=function(t,e,n){var r=t.values,i=e.values,o=this.values;return o[0]=r[0]+n*(i[0]-r[0]),o[1]=r[1]+n*(i[1]-r[1]),o[2]=r[2]+n*(i[2]-r[2]),this},e.prototype.dot=function(t){var e=this.values,n=t.values;return e[0]*n[0]+e[1]*n[1]+e[2]*n[2]},e.prototype.min=function(t){return this.x>t.x&&(this.x=t.x),this.y>t.y&&(this.y=t.y),this.z>t.z&&(this.z=t.z),this},e.prototype.max=function(t){return this.x<t.x&&(this.x=t.x),this.y<t.y&&(this.y=t.y),this.z<t.z&&(this.z=t.z),this},e.prototype.isEqual=function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z},e.prototype.toArray=function(){return[this.x,this.y,this.z]},e.prototype.applyMatrix3=function(t){var e=this.x,n=this.y,r=this.z,i=t.values;return this.x=i[0]*e+i[3]*n+i[6]*r,this.y=i[1]*e+i[4]*n+i[7]*r,this.z=i[2]*e+i[5]*n+i[8]*r,this},e.prototype.applyMatrix4=function(t){var e=this.x,n=this.y,r=this.z,i=t.values;return this.x=i[0]*e+i[4]*n+i[8]*r+i[12],this.y=i[1]*e+i[5]*n+i[9]*r+i[13],this.z=i[2]*e+i[6]*n+i[10]*r+i[14],this},e.prototype.distanceTo=function(t){return Math.sqrt(this.distanceToSquared(t))},e.prototype.distanceToSquared=function(t){var e=this.x-t.x,n=this.y-t.y,r=this.z-t.z;return Math.pow(e,2)+Math.pow(n,2)+Math.pow(r,2)},e.up=e.create(0,1,0),e.forward=e.create(0,0,1),e.right=e.create(1,0,0),e}();t.Vector3=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];this.values=new Float32Array(4),t.length>0&&(this.values[0]=t[0],this.values[1]=t[1],this.values[2]=t[2],this.values[3]=t[3])}return e.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=null;return n=0===t.length?new this:new this(t[0],t[1],t[2],t[3])},Object.defineProperty(e.prototype,"x",{get:function(){return this.values[0]},set:function(t){this.values[0]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this.values[1]},set:function(t){this.values[1]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"z",{get:function(){return this.values[2]},set:function(t){this.values[2]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"w",{get:function(){return this.values[3]},set:function(t){this.values[3]=t},enumerable:!0,configurable:!0}),e.prototype.normalize=function(){var t=this.values,n=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]+t[3]*t[3]);return 0===n?e.create(0,0,0,0):(t[0]=t[0]/n,t[1]=t[1]/n,t[2]=t[2]/n,t[3]=t[3]/n,this)},e.prototype.isEqual=function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},e.prototype.clone=function(){return this.copyHelper(e.create())},e.prototype.toVector3=function(){return t.Vector3.create(this.values[0],this.values[1],this.values[2])},e.prototype.multiplyScalar=function(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},e.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},e.prototype.set=function(t,e,n,r){this.x=t,this.y=e,this.z=n,this.w=r},e.prototype.copyHelper=function(t){var e=t,n=0,r=this.values.length;for(n=0;r>n;n++)e.values[n]=this.values[n];return e},e}();t.Vector4=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];this.values=null,this._matrixArr=null,1===t.length?this.values=t[0]:this.values=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._matrixArr=[]}return e.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=null;return n=0===t.length?new this:new this(t[0])},e.prototype.push=function(){this._matrixArr.push(this.values)},e.prototype.pop=function(){this.values=this._matrixArr.pop()},e.prototype.set=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=this.values,r=null;if(1===t.length){var i=t[0];r=i.values}else r=[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]];return n[0]=r[0],n[1]=r[1],n[2]=r[2],n[3]=r[3],n[4]=r[4],n[5]=r[5],n[6]=r[6],n[7]=r[7],n[8]=r[8],n[9]=r[9],n[10]=r[10],n[11]=r[11],n[12]=r[12],n[13]=r[13],n[14]=r[14],n[15]=r[15],this},e.prototype.setIdentity=function(){var t=this.values;return t[0]=1,t[4]=0,t[8]=0,t[12]=0,t[1]=0,t[5]=1,t[9]=0,t[13]=0,t[2]=0,t[6]=0,t[10]=1,t[14]=0,t[3]=0,t[7]=0,t[11]=0,t[15]=1,this},e.prototype.invert=function(){var t,e,n,r,i,o,a,s,c,u,l,h,d,p,f,_,g,m,y,v,b,C,E,S,T,w,D,L,A,M;return M=this.values,t=M[0],e=M[1],n=M[2],r=M[3],i=M[4],o=M[5],a=M[6],s=M[7],c=M[8],u=M[9],l=M[10],h=M[11],d=M[12],p=M[13],f=M[14],_=M[15],g=t*o-e*i,m=t*a-n*i,y=t*s-r*i,v=e*a-n*o,b=e*s-r*o,C=n*s-r*a,E=c*p-u*d,S=c*f-l*d,T=c*_-h*d,w=u*f-l*p,D=u*_-h*p,L=l*_-h*f,A=1/(g*L-m*D+y*w+v*T-b*S+C*E),M[0]=(o*L-a*D+s*w)*A,M[1]=(-e*L+n*D-r*w)*A,M[2]=(p*C-f*b+_*v)*A,M[3]=(-u*C+l*b-h*v)*A,M[4]=(-i*L+a*T-s*S)*A,M[5]=(t*L-n*T+r*S)*A,M[6]=(-d*C+f*y-_*m)*A,M[7]=(c*C-l*y+h*m)*A,M[8]=(i*D-o*T+s*E)*A,M[9]=(-t*D+e*T-r*E)*A,M[10]=(d*b-p*y+_*g)*A,M[11]=(-c*b+u*y-h*g)*A,M[12]=(-i*w+o*S-a*E)*A,M[13]=(t*w-e*S+n*E)*A,M[14]=(-d*v+p*m-f*g)*A,M[15]=(c*v-u*m+l*g)*A,this},e.prototype.invertTo3x3=function(){var e,n,r,i,o,a,s,c,u,l,h,d,p,f=t.Matrix3.create();return l=this.values,h=f.values,e=l[10]*l[5]-l[6]*l[9],n=-l[10]*l[1]+l[2]*l[9],r=l[6]*l[1]-l[2]*l[5],i=-l[10]*l[4]+l[6]*l[8],o=l[10]*l[0]-l[2]*l[8],a=-l[6]*l[0]+l[2]*l[4],s=l[9]*l[4]-l[5]*l[8],c=-l[9]*l[0]+l[1]*l[8],u=l[5]*l[0]-l[1]*l[4],d=l[0]*e+l[1]*i+l[2]*s,0===d?(t.Log.warn("can't invert matrix, determinant is 0"),f):(p=1/d,h[0]=p*e,h[1]=p*n,h[2]=p*r,h[3]=p*i,h[4]=p*o,h[5]=p*a,h[6]=p*s,h[7]=p*c,h[8]=p*u,f)},e.prototype.transpose=function(){var t,e=this.values;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this},e.prototype.setTranslate=function(t,e,n){var r=this.values;return r[0]=1,r[4]=0,r[8]=0,r[12]=t,r[1]=0,r[5]=1,r[9]=0,r[13]=e,r[2]=0,r[6]=0,r[10]=1,r[14]=n,r[3]=0,r[7]=0,r[11]=0,r[15]=1,this},e.prototype.translate=function(t,n,r){return this.applyMatrix(e.create().setTranslate(t,n,r)),this},e.prototype.setRotate=function(t,e,n,r){var i,o,a,s,c,u,l,h,d,p,f,_,t=Math.PI*t/180;return i=this.values,o=Math.sin(t),a=Math.cos(t),0!==e&&0===n&&0===r?(0>e&&(o=-o),i[0]=1,i[4]=0,i[8]=0,i[12]=0,i[1]=0,i[5]=a,i[9]=-o,i[13]=0,i[2]=0,i[6]=o,i[10]=a,i[14]=0,i[3]=0,i[7]=0,i[11]=0,i[15]=1):0===e&&0!==n&&0===r?(0>n&&(o=-o),i[0]=a,i[4]=0,i[8]=o,i[12]=0,i[1]=0,i[5]=1,i[9]=0,i[13]=0,i[2]=-o,i[6]=0,i[10]=a,i[14]=0,i[3]=0,i[7]=0,i[11]=0,i[15]=1):0===e&&0===n&&0!==r?(0>r&&(o=-o),i[0]=a,i[4]=-o,i[8]=0,i[12]=0,i[1]=o,i[5]=a,i[9]=0,i[13]=0,i[2]=0,i[6]=0,i[10]=1,i[14]=0,i[3]=0,i[7]=0,i[11]=0,i[15]=1):(s=Math.sqrt(e*e+n*n+r*r),1!==s&&(c=1/s,e*=c,n*=c,r*=c),u=1-a,l=e*n,h=n*r,d=r*e,p=e*o,f=n*o,_=r*o,i[0]=e*e*u+a,i[1]=l*u+_,i[2]=d*u-f,i[3]=0,i[4]=l*u-_,i[5]=n*n*u+a,i[6]=h*u+p,i[7]=0,i[8]=d*u+f,i[9]=h*u-p,i[10]=r*r*u+a,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1),this},e.prototype.rotate=function(){for(var t=[],n=0;n<arguments.length;n++)t[n-0]=arguments[n];var r=t[0];if(2===t.length){var i=t[1];this.applyMatrix(e.create().setRotate(r,i.values[0],i.values[1],i.values[2]))}else if(4===t.length){var o=t[1],a=t[2],s=t[3];this.applyMatrix(e.create().setRotate(r,o,a,s))}return this},e.prototype.setScale=function(t,e,n){var r=this.values;return r[0]=t,r[4]=0,r[8]=0,r[12]=0,r[1]=0,r[5]=e,r[9]=0,r[13]=0,r[2]=0,r[6]=0,r[10]=n,r[14]=0,r[3]=0,r[7]=0,r[11]=0,r[15]=1,this},e.prototype.scale=function(t,n,r){return this.applyMatrix(e.create().setScale(t,n,r)),this},e.prototype.setLookAt=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r,i,o,a,s,c;3===e.length?(a=e[0],s=e[1],c=e[2]):9===e.length&&(a=t.Vector3.create(e[0],e[1],e[2]),s=t.Vector3.create(e[3],e[4],e[5]),c=t.Vector3.create(e[6],e[7],e[8])),r=t.Vector3.create(),o=a.clone().sub(s).normalize(),i=c.clone().normalize(),r.cross(i,o).normalize(),i.cross(o,r);var u=this.values;return u[0]=r.x,u[1]=r.y,u[2]=r.z,u[3]=0,u[4]=i.x,u[5]=i.y,u[6]=i.z,u[7]=0,u[8]=o.x,u[9]=o.y,u[10]=o.z,u[11]=0,u[12]=a.x,u[13]=a.y,u[14]=a.z,u[15]=1,this},e.prototype.lookAt=function(){for(var t=[],n=0;n<arguments.length;n++)t[n-0]=arguments[n];var r=e.create();return this.applyMatrix(r.setLookAt.apply(r,t)),this},e.prototype.setOrtho=function(t,e,n,r,i,o){var a,s,c,u=this.values;return a=1/(e-t),s=1/(r-n),c=1/(o-i),u[0]=2*a,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=2*s,u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=-2*c,u[11]=0,u[12]=-(e+t)*a,u[13]=-(r+n)*s,u[14]=-(o+i)*c,u[15]=1,this},e.prototype.ortho=function(t,n,r,i,o,a){return this.applyMatrix(e.create().setOrtho(t,n,r,i,o,a)),this},e.prototype.setPerspective=function(e,n,r,i){var o=null,a=null,s=null,c=null,e=Math.PI*e/180/2;return s=Math.sin(e),t.Log.error(0===s,t.Log.info.FUNC_MUST_NOT_BE("frustum","null")),a=1/(i-r),c=Math.cos(e)/s,o=this.values,o[0]=c/n,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=c,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=-(i+r)*a,o[11]=-1,o[12]=0,o[13]=0,o[14]=-2*r*i*a,o[15]=0,this},e.prototype.perspective=function(t,n,r,i){return this.applyMatrix(e.create().setPerspective(t,n,r,i)),this},e.prototype.applyMatrix=function(t,e){void 0===e&&(e=!1);var n=this,r=t.clone();return e?r.multiply(n):(this.values=r.multiply(n).values,this)},e.prototype.multiply=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=null,r=null,i=null;i=this.values,1===t.length?(n=this.values,r=t[0].values):2===t.length&&(n=t[0].values,r=t[1].values);var o=n[0],a=n[1],s=n[2],c=n[3],u=n[4],l=n[5],h=n[6],d=n[7],p=n[8],f=n[9],_=n[10],g=n[11],m=n[12],y=n[13],v=n[14],b=n[15],C=r[0],E=r[1],S=r[2],T=r[3],w=r[4],D=r[5],L=r[6],A=r[7],M=r[8],O=r[9],x=r[10],N=r[11],R=r[12],U=r[13],F=r[14],I=r[15];return i[0]=C*o+E*u+S*p+T*m,i[1]=C*a+E*l+S*f+T*y,i[2]=C*s+E*h+S*_+T*v,i[3]=C*c+E*d+S*g+T*b,i[4]=w*o+D*u+L*p+A*m,i[5]=w*a+D*l+L*f+A*y,i[6]=w*s+D*h+L*_+A*v,i[7]=w*c+D*d+L*g+A*b,i[8]=M*o+O*u+x*p+N*m,i[9]=M*a+O*l+x*f+N*y,i[10]=M*s+O*h+x*_+N*v,i[11]=M*c+O*d+x*g+N*b,i[12]=R*o+U*u+F*p+I*m,i[13]=R*a+U*l+F*f+I*y,i[14]=R*s+U*h+F*_+I*v,i[15]=R*c+U*d+F*g+I*b,this},e.prototype.multiplyVector4=function(e){var n=this.values,r=e.values,i=[];return i[0]=r[0]*n[0]+r[1]*n[4]+r[2]*n[8]+r[3]*n[12],i[1]=r[0]*n[1]+r[1]*n[5]+r[2]*n[9]+r[3]*n[13],i[2]=r[0]*n[2]+r[1]*n[6]+r[2]*n[10]+r[3]*n[14],i[3]=r[0]*n[3]+r[1]*n[7]+r[2]*n[11]+r[3]*n[15],t.Vector4.create(i[0],i[1],i[2],i[3])},e.prototype.multiplyVector3=function(e){var n=this.values,r=e.values,i=[];return i[0]=r[0]*n[0]+r[1]*n[4]+r[2]*n[8],i[1]=r[0]*n[1]+r[1]*n[5]+r[2]*n[9],i[2]=r[0]*n[2]+r[1]*n[6]+r[2]*n[10],t.Vector3.create(i[0],i[1],i[2])},e.prototype.multiplyPoint=function(e){var n=this.values,r=e.values,i=[];return i[0]=r[0]*n[0]+r[1]*n[4]+r[2]*n[8]+n[12],i[1]=r[0]*n[1]+r[1]*n[5]+r[2]*n[9]+n[13],i[2]=r[0]*n[2]+r[1]*n[6]+r[2]*n[10]+n[14],t.Vector3.create(i[0],i[1],i[2])},e.prototype.clone=function(){var t=e.create(),n=0,r=this.values.length;for(n=0;r>n;n++)t.values[n]=this.values[n];return t},e.prototype.cloneToArray=function(t,e){void 0===e&&(e=0);for(var n=this.values,r=0;16>r;r++)t[e+r]=n[r];return this},e.prototype.getX=function(){return t.Vector3.create(this.values[0],this.values[1],this.values[2])},e.prototype.getY=function(){return t.Vector3.create(this.values[4],this.values[5],this.values[6])},e.prototype.getZ=function(){return t.Vector3.create(this.values[8],this.values[9],this.values[10])},e.prototype.getTranslation=function(){return t.Vector3.create(this.values[12],this.values[13],this.values[14])},e.prototype.getScale=function(){return t.Vector3.create(this.getX().length(),this.getY().length(),this.getZ().length())},e.prototype.getRotation=function(){return t.Quaternion.create().setFromMatrix(this)},e.prototype.getEulerAngles=function(){var e,n,r,i,o,a,s,c,u=this.getScale();return i=u.x,o=u.y,a=u.z,s=this.values,n=Math.asin(-s[2]/i),c=.5*Math.PI,c>n?n>-c?(e=Math.atan2(s[6]/o,s[10]/a),r=Math.atan2(s[1]/i,s[0]/i)):(r=0,e=-Math.atan2(s[4]/o,s[5]/o)):(r=0,e=Math.atan2(s[4]/o,s[5]/o)),t.Vector3.create(e,n,r).scale(t.RAD_TO_DEG)},e.prototype.setTRS=function(t,e,n){var r,i,o,a,s,c,u,l,h,d,p,f,_,g,m,y,v,b,C,E,S,T,w;return r=t.x,i=t.y,o=t.z,a=e.x,s=e.y,c=e.z,u=e.w,l=n.x,h=n.y,d=n.z,p=a+a,f=s+s,_=c+c,g=a*p,m=a*f,y=a*_,v=s*f,b=s*_,C=c*_,E=u*p,S=u*f,T=u*_,w=this.values,w[0]=(1-(v+C))*l,w[1]=(m+T)*l,w[2]=(y-S)*l,w[3]=0,w[4]=(m-T)*h,w[5]=(1-(g+C))*h,w[6]=(b+E)*h,w[7]=0,w[8]=(y+S)*d,w[9]=(b-E)*d,w[10]=(1-(g+v))*d,w[11]=0,w[12]=r,w[13]=i,w[14]=o,w[15]=1,this},__decorate([t.require(function(e,n,r,i,o,a){t.assert(e!==n&&r!==i&&o!==a,t.Log.info.FUNC_MUST_NOT_BE("frustum","null"))})],e.prototype,"setOrtho",null),__decorate([t.require(function(e,n,r,i){t.assert(r!==i&&0!==n,t.Log.info.FUNC_MUST_NOT_BE("frustum","null")),t.assert(r>0,t.Log.info.FUNC_MUST("near","> 0")),t.assert(i>0,t.Log.info.FUNC_MUST("far","> 0"))})],e.prototype,"setPerspective",null),e}();t.Matrix4=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];this.values=null,1===t.length?this.values=t[0]:this.values=new Float32Array([1,0,0,0,1,0,0,0,1])}return e.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=null;return n=0===t.length?new this:new this(t[0])},Object.defineProperty(e.prototype,"a",{get:function(){return this.values[0]},set:function(t){this.values[0]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"c",{get:function(){return this.values[1]},set:function(t){this.values[1]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"b",{get:function(){return this.values[3]},set:function(t){this.values[3]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"d",{get:function(){return this.values[4]},set:function(t){this.values[4]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"tx",{get:function(){return this.values[6]},set:function(t){this.values[6]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ty",{get:function(){return this.values[7]},set:function(t){this.values[7]=t},enumerable:!0,configurable:!0}),e.prototype.setIdentity=function(){var t=this.values;return t[0]=1,t[3]=0,t[6]=0,t[1]=0,t[4]=1,t[7]=0,t[2]=0,t[5]=0,t[8]=1,this},e.prototype.invert=function(){var t=this.values[0],e=this.values[1],n=this.values[3],r=this.values[4],i=this.values[6],o=this.values[7],a=t*r-e*n;return this.values[0]=r/a,this.values[1]=-e/a,this.values[3]=-n/a,this.values[4]=t/a,this.values[6]=(n*o-r*i)/a,this.values[7]=-(t*o-e*i)/a,this},e.prototype.multiplyScalar=function(t){var e=this.values;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this},e.prototype.multiplyVector2=function(e){var n=e.x,r=e.y,i=t.Vector2.create(),o=this.values;return i.x=o[0]*n+o[3]*r,i.y=o[1]*n+o[4]*r,i},e.prototype.multiplyPoint=function(e){var n=e.x,r=e.y,i=t.Vector2.create(),o=this.values;return i.x=o[0]*n+o[3]*r+this.tx,i.y=o[1]*n+o[4]*r+this.ty,i},e.prototype.multiply=function(t){var e=this.a*t.a+this.c*t.b,n=this.b*t.a+this.d*t.b,r=this.a*t.c+this.c*t.d,i=this.b*t.c+this.d*t.d,o=this.a*t.tx+this.c*t.ty+this.tx,a=this.b*t.tx+this.d*t.ty+this.ty;return this.a=e,this.b=n,this.c=r,this.d=i,this.tx=o,this.ty=a,this},e.prototype.transpose=function(){var t,e=this.values;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this},e.prototype.clone=function(){return e.create().set(this)},e.prototype.cloneToArray=function(t,e){void 0===e&&(e=0);for(var n=this.values,r=0;9>r;r++)t[e+r]=n[r];return this},e.prototype.set=function(t){var e=this.values,n=t.values;return e[0]=n[0],e[3]=n[3],e[6]=n[6],e[1]=n[1],e[4]=n[4],e[7]=n[7],e[2]=n[2],e[5]=n[5],e[8]=n[8],this},e.prototype.setTS=function(t,e){this.setPosition(t.x,t.y),this.setScale(e.x,e.y)},e.prototype.rotate=function(e){var n=e*t.DEG_TO_RAD,r=Math.cos(n),i=Math.sin(n),o=this.a*r+this.c*i,a=this.b*r+this.d*i,s=this.a*-i+this.c*r,c=this.b*-i+this.d*r;return this.a=o,this.b=a,this.c=s,this.d=c,this},e.prototype.setRotation=function(e){var n=e*t.DEG_TO_RAD,r=Math.cos(n),i=Math.sin(n),o=this.values;return o[0]=r,o[1]=-i,o[3]=i,o[4]=r,this},e.prototype.translate=function(t,e){this.tx+=this.a*t+this.c*e,this.ty+=this.b*t+this.d*e},e.prototype.setPosition=function(t,e){this.tx=t,this.ty=e},e.prototype.scale=function(t,e){return this.a*=t,this.b*=t,this.c*=e,this.d*=e,this},e.prototype.setScale=function(t,e){var n=this.values;return n[0]=t,n[4]=e,this},e.prototype.getTranslation=function(){return t.Vector2.create(this.tx,this.ty)},e.prototype.getScale=function(){return t.Vector2.create(Math.sqrt(this.a*this.a+this.b*this.b),Math.sqrt(this.c*this.c+this.d*this.d))},e.prototype.getRotation=function(){return this._getSkewX()},e.prototype.getSkew=function(){return t.Vector2.create(this._getSkewX(),this._getSkewY())},e.prototype._getDeltaTransformPoint=function(t,e){return{x:e.x*t.a+e.y*t.c+0,y:e.x*t.b+e.y*t.d+0}},e.prototype._getSkewX=function(){var t=this._getDeltaTransformPoint(this,{x:0,y:1});return 180/Math.PI*Math.atan2(t.y,t.x)-90},e.prototype._getSkewY=function(){var t=this._getDeltaTransformPoint(this,{x:1,y:0});return 180/Math.PI*Math.atan2(t.y,t.x)},e}();t.Matrix3=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t,e,n,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===r&&(r=1),this.x=null,this.y=null,this.z=null,this.w=null,this.x=t,this.y=e,this.z=n,this.w=r}return e.create=function(t,e,n,r){var i=new this(t,e,n,r);return i},e.prototype.setFromEulerAngles=function(e){var n,r,i,o,a,s,c,u=e.x,l=e.y,h=e.z;return c=.5*t.DEG_TO_RAD,u*=c,l*=c,h*=c,n=Math.sin(u),r=Math.cos(u),i=Math.sin(l),o=Math.cos(l),a=Math.sin(h),s=Math.cos(h),this.x=n*o*s-r*i*a,this.y=r*i*s+n*o*a,this.z=r*o*a-n*i*s,this.w=r*o*s+n*i*a,this},e.prototype.multiply=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n,r,i,o,a,s,c,u,l,h,d=this;return 1===t.length?(l=this,h=t[0]):2===t.length&&(l=t[0],h=t[1]),n=l.x,r=l.y,i=l.z,o=l.w,a=h.x,s=h.y,c=h.z,u=h.w,d.x=o*a+n*u+r*c-i*s,d.y=o*s+r*u+i*a-n*c,d.z=o*c+i*u+n*s-r*a,d.w=o*u-n*a-r*s-i*c,d},e.prototype.setFromMatrix=function(t){var e,n,r,i,o,a,s,c,u,l,h,d,p,f,_,g;return g=t.values,e=g[0],n=g[1],r=g[2],i=g[4],o=g[5],a=g[6],s=g[8],c=g[9],u=g[10],p=1/Math.sqrt(e*e+n*n+r*r),f=1/Math.sqrt(i*i+o*o+a*a),_=1/Math.sqrt(s*s+c*c+u*u),e*=p,n*=p,r*=p,i*=f,o*=f,a*=f,s*=_,c*=_,u*=_,l=e+o+u,l>=0?(h=Math.sqrt(l+1),this.w=.5*h,h=.5/h,this.x=(a-c)*h,this.y=(s-r)*h,this.z=(n-i)*h):e>o?e>u?(d=e-(o+u)+1,d=Math.sqrt(d),this.x=.5*d,d=.5/d,this.w=(a-c)*d,this.y=(n+i)*d,this.z=(r+s)*d):(d=u-(e+o)+1,d=Math.sqrt(d),this.z=.5*d,d=.5/d,this.w=(n-i)*d,this.x=(s+r)*d,this.y=(c+a)*d):o>u?(d=o-(u+e)+1,d=Math.sqrt(d),this.y=.5*d,d=.5/d,this.w=(s-r)*d,this.z=(a+c)*d,this.x=(i+n)*d):(d=u-(e+o)+1,d=Math.sqrt(d),this.z=.5*d,d=.5/d,this.w=(n-i)*d,this.x=(s+r)*d,this.y=(c+a)*d),this},e.prototype.setFromAxisAngle=function(e,n){var r,i;return n=n.normalize(),e*=.5*t.DEG_TO_RAD,r=Math.sin(e),i=Math.cos(e),this.x=r*n.x,this.y=r*n.y,this.z=r*n.z,this.w=i,this},e.prototype.invert=function(){return this.conjugate().normalize()},e.prototype.conjugate=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},e.prototype.clone=function(){return e.create(this.x,this.y,this.z,this.w)},e.prototype.normalize=function(){var t=this.length();return 0===t?(this.x=this.y=this.z=0,this.w=1):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t),this},e.prototype.length=function(){var t,e,n,r;return t=this.x,e=this.y,n=this.z,r=this.w,Math.sqrt(t*t+e*e+n*n+r*r)},e.prototype.multiplyVector3=function(e){var n=this,r=e.x,i=e.y,o=e.z,a=n.x,s=n.y,c=n.z,u=n.w,l=u*r+s*o-c*i,h=u*i+c*r-a*o,d=u*o+a*i-s*r,p=-a*r-s*i-c*o;return t.Vector3.create(l*u+p*-a+h*-c-d*-s,h*u+p*-s+d*-a-l*-c,d*u+p*-c+l*-s-h*-a)},e.prototype.set=function(t,e,n,r){this.x=t,this.y=e,this.z=n,this.w=r},e.prototype.sub=function(t){var e=t.clone().invert().multiply(this);return this.set(e.x,e.y,e.z,e.w),this},e.prototype.getEulerAngles=function(){var e,n,r,i,o,a,s,c;return i=this.x,o=this.y,a=this.z,s=this.w,c=2*(s*o-i*a),-.99999>=c?(e=2*Math.atan2(i,s),n=-Math.PI/2,r=0):c>=.99999?(e=2*Math.atan2(i,s),n=Math.PI/2,r=0):(e=Math.atan2(2*(s*i+o*a),1-2*(i*i+o*o)),n=Math.asin(c),r=Math.atan2(2*(s*a+i*o),1-2*(o*o+a*a))),t.Vector3.create(e,n,r).scale(t.RAD_TO_DEG)},e.prototype.slerp=function(t,n,r){var i,o,a=r,s=t.x*n.x+t.y*n.y+t.z*n.z+t.w*n.w,c=!1;if(0>s&&(c=!0,s=-s),s>.999999)o=1-a,i=c?-a:a;else{var u=Math.acos(s),l=1/Math.sin(u);o=Math.sin((1-a)*u)*l,i=c?-Math.sin(a*u)*l:Math.sin(a*u)*l}return e.create(o*t.x+i*n.x,o*t.y+i*n.y,o*t.z+i*n.z,o*t.w+i*n.w)},e}();t.Quaternion=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(e,n,r,i){this.normal=t.Vector3.create(0,1,0),this.d=0,this.normal=t.Vector3.create(e,n,r),this.d=i}return e.create=function(t,e,n,r){var i=new this(t,e,n,r);return i},e.prototype.getReflectionMatrix=function(){this.normalize();var e=this.normal.x,n=this.normal.y,r=this.normal.z,i=-2*e,o=-2*n,a=-2*r,s=t.Matrix4.create();return s.values[0]=i*e+1,s.values[1]=o*e,s.values[2]=a*e,s.values[3]=0,
s.values[4]=i*n,s.values[5]=o*n+1,s.values[6]=a*n,s.values[7]=0,s.values[8]=i*r,s.values[9]=o*r,s.values[10]=a*r+1,s.values[11]=0,s.values[12]=i*this.d,s.values[13]=o*this.d,s.values[14]=a*this.d,s.values[15]=1,s},e.prototype.normalize=function(){var t=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z),e=0;return 0!==t&&(e=1/t),this.normal.x*=e,this.normal.y*=e,this.normal.z*=e,this.d*=e,this},e.prototype.clone=function(){return e.create(this.normal.x,this.normal.y,this.normal.z,this.d)},e.prototype.dotCoordinate=function(t){return this.normal.x*t.x+this.normal.y*t.y+this.normal.z*t.z+this.d},e}();t.Plane=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t,e){this._origin=null,this._direction=null,this._origin=t,this._direction=e}return e.create=function(t,e){var n=new this(t,e);return n},e.prototype.isIntersectWithAABB=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null,i=null,o=t.Vector3.create(),a=null,s=null,c=t.Vector3.create(),u=t.Vector3.create(),l=this._origin,h=this._direction;if(1===e.length){var d=e[0];r=d.center,i=d.halfExtents}else if(2===e.length){var p=e[0],f=e[1];r=t.AABBShape.getCenter(p,f),i=t.AABBShape.getHalfExtents(p,f)}return o.sub2(l,r),a=t.Vector3.create(Math.abs(o.x),Math.abs(o.y),Math.abs(o.z)),u.mul2(o,h),a.x>i.x&&u.x>=0?!1:a.y>i.y&&u.y>=0?!1:a.z>i.z&&u.z>=0?!1:(s=t.Vector3.create(Math.abs(h.x),Math.abs(h.y),Math.abs(h.z)),c.cross(h,o),c.set(Math.abs(c.x),Math.abs(c.y),Math.abs(c.z)),c.x>i.y*s.z+i.z*s.y?!1:c.y>i.x*s.z+i.z*s.x?!1:c.z>i.x*s.y+i.y*s.x?!1:!0)},e.prototype.isIntersectWithSphere=function(e){var n=e.center,r=e.radius,i=t.Vector3.create(),o=0,a=0,s=0,c=0,u=this._origin,l=this._direction;return i.sub2(u,n),i.dot(i)<r*r?!0:(o=l.dot(l),a=2*l.dot(i),s=n.dot(n),s+=u.dot(u),s-=2*n.dot(u),s-=r*r,c=a*a-4*o*s,0>c?!1:!0)},e}();t.Ray=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){this.uid=null,this._tagList=wdCb.Collection.create(),this.uid=t._count,t._count+=1}return t.prototype.addTag=function(t){this._tagList.addChild(t)},t.prototype.removeTag=function(t){this._tagList.removeChild(t)},t.prototype.getTagList=function(){return this._tagList},t.prototype.hasTag=function(t){return this._tagList.hasChild(t)},t.prototype.containTag=function(t){return this._tagList.hasChildWithFunc(function(e){return e.indexOf(t)>-1})},t._count=1,t}();t.Entity=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.entityObject=null}return __extends(n,e),n.prototype.init=function(){},n.prototype.dispose=function(){},n.prototype.clone=function(){return t.CloneUtils.clone(this)},Object.defineProperty(n.prototype,"transform",{get:function(){return this.entityObject?this.entityObject.transform:null},enumerable:!0,configurable:!0}),n.prototype.addToObject=function(t,e){void 0===e&&(e=!1),e||(this.entityObject&&this.entityObject.removeComponent(this),this.entityObject=t)},n.prototype.removeFromObject=function(t){},__decorate([t.virtual],n.prototype,"init",null),__decorate([t.virtual],n.prototype,"dispose",null),__decorate([t.virtual],n.prototype,"clone",null),__decorate([t.virtual],n.prototype,"addToObject",null),__decorate([t.virtual],n.prototype,"removeFromObject",null),n}(t.Entity);t.Component=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){this._scheduleCount=0,this._schedules=wdCb.Hash.create()}return t.create=function(){var t=new this;return t},t.prototype.update=function(t){var e=this;this._schedules.forEach(function(n,r){n.isStop||n.isPause||(n.update(t),n.isFinish&&e.remove(r))})},t.prototype.scheduleLoop=function(t,e){return void 0===e&&(e=[]),this._schedule(o,Array.prototype.slice.call(arguments,0))},t.prototype.scheduleFrame=function(t,e,n){return void 0===e&&(e=1),this._schedule(a,Array.prototype.slice.call(arguments,0))},t.prototype.scheduleInterval=function(t,e,n){return void 0===e&&(e=0),this._schedule(i,Array.prototype.slice.call(arguments,0))},t.prototype.scheduleTime=function(t,e,n){return void 0===e&&(e=0),this._schedule(r,Array.prototype.slice.call(arguments,0))},t.prototype.pause=function(t){if(0===arguments.length){var e=this;this._schedules.forEach(function(t,n){e.pause(n)})}else if(1===arguments.length){var n=this._schedules.getChild(arguments[0]);n.pause()}},t.prototype.resume=function(t){if(0===arguments.length){var e=this;this._schedules.forEach(function(t,n){e.resume(n)})}else if(1===arguments.length){var n=this._schedules.getChild(arguments[0]);n.resume()}},t.prototype.start=function(t){if(0===arguments.length){var e=this;this._schedules.forEach(function(t,n){e.start(n)})}else if(1===arguments.length){var n=this._schedules.getChild(arguments[0]);n.start()}},t.prototype.stop=function(t){if(0===arguments.length){var e=this;this._schedules.forEach(function(t,n){e.stop(n)})}else if(1===arguments.length){var n=this._schedules.getChild(arguments[0]);n.stop()}},t.prototype.has=function(t){return!!this._schedules.hasChild(t)},t.prototype.remove=function(t){this._schedules.removeChild(t)},t.prototype.removeAll=function(){this._schedules.removeAllChildren()},t.prototype._schedule=function(t,e){var n=this._buildId();return this._schedules.setValue(n,t.create.apply(t,e)),n},t.prototype._buildId=function(){return"Schedule_"+this._scheduleCount++},t}();t.Scheduler=e;var n=function(){function e(e,n){this.isPause=!1,this.isStop=!1,this.pauseTime=null,this.pauseElapsed=null,this.startTime=null,this.isFinish=!1,this.task=null,this.args=null,this.timeController=t.CommonTimeController.create(),this.task=e,this.args=n}return e.prototype.pause=function(){this.isPause=!0,this.timeController.pause()},e.prototype.resume=function(){this.isPause=!1,this.timeController.resume()},e.prototype.start=function(){this.isStop=!1,this.timeController.start()},e.prototype.stop=function(){this.isStop=!0,this.timeController.stop()},e.prototype.finish=function(){this.isFinish=!0},e}(),r=function(t){function e(e,n,r){void 0===n&&(n=0),void 0===r&&(r=[]),t.call(this,e,r),this._time=null,this._time=n}return __extends(e,t),e.create=function(t,e,n){void 0===e&&(e=0),void 0===n&&(n=[]);var r=new this(t,e,n);return r},e.prototype.update=function(t){var t=this.timeController.computeElapseTime(t);t>=this._time&&(this.task.apply(this,this.args),this.finish())},e}(n),i=function(t){function e(e,n,r){void 0===n&&(n=0),void 0===r&&(r=[]),t.call(this,e,r),this._intervalTime=null,this._elapsed=0,this._intervalTime=n}return __extends(e,t),e.create=function(t,e,n){void 0===e&&(e=0),void 0===n&&(n=[]);var r=new this(t,e,n);return r},e.prototype.update=function(t){var t=this.timeController.computeElapseTime(t);t-this._elapsed>=this._intervalTime&&(this.task.apply(this,this.args),this._elapsed=t)},e.prototype.start=function(){t.prototype.start.call(this),this._elapsed=0},e}(n),o=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(t,e){void 0===e&&(e=[]);var n=new this(t,e);return n},e.prototype.update=function(t){this.task.apply(this,this.args)},e}(n),a=function(t){function e(e,n,r){void 0===n&&(n=1),void 0===r&&(r=[]),t.call(this,e,r),this._frame=null,this._frame=n}return __extends(e,t),e.create=function(t,e,n){void 0===e&&(e=1),void 0===n&&(n=[]);var r=new this(t,e,n);return r},e.prototype.update=function(t){this._frame--,this._frame<=0&&(this.task.apply(this,this.args),this.finish())},e}(n)}(wd||(wd={}));var wd;!function(t){var e;!function(t){t[t.NORMAL=0]="NORMAL",t[t.STOP=1]="STOP",t[t.PAUSE=2]="PAUSE"}(e||(e={}));var n=function(){function n(){this.scene=null,this.scheduler=null,this.renderer=null,this.domEventManager=t.DomEventManager.create(),this._gameLoop=null,this._eventSubscription=null,this._gameState=e.NORMAL,this._timeController=t.DirectorTimeController.create()}return n.getInstance=function(){return null===this._instance&&(this._instance=new this,this._instance.initWhenCreate()),this._instance},Object.defineProperty(n.prototype,"gameTime",{get:function(){return this._timeController.gameTime},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"fps",{get:function(){return this._timeController.fps},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isNormal",{get:function(){return this._gameState===e.NORMAL},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isStop",{get:function(){return this._gameState===e.STOP},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isPause",{get:function(){return this._gameState===e.PAUSE},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isTimeChange",{get:function(){return this._timeController.isTimeChange},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"elapsed",{get:function(){return this._timeController.elapsed},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"view",{get:function(){return t.DeviceManager.getInstance().view},enumerable:!0,configurable:!0}),n.prototype.initWhenCreate=function(){this.scene=t.SceneDispatcher.create(),this.scheduler=t.Scheduler.create(),this.renderer=t.WebGLRenderer.create()},n.prototype.start=function(){this._gameState=e.NORMAL,this._startLoop()},n.prototype.stop=function(){this._gameLoop&&this._gameLoop.dispose(),this._gameState=e.STOP,this._timeController.stop(),this.scheduler.stop(),this._eventSubscription&&this._eventSubscription.dispose()},n.prototype.pause=function(){this._gameState!==e.PAUSE&&(this._gameState=e.PAUSE,this._timeController.pause(),this.scheduler.pause())},n.prototype.resume=function(){this._gameState=e.NORMAL,this._timeController.resume(),this.scheduler.resume()},n.prototype.getDeltaTime=function(){return this._timeController.deltaTime},n.prototype.initUIObjectScene=function(){var t=this.scene.uiObjectScene;this._initDomEvent(),t.onEnter(),t.init()},n.prototype.runUIObjectScene=function(e){var n=this.scene.uiObjectScene;t.EventManager.trigger(t.CustomEvent.create(t.EEngineEvent.STARTLOOP)),t.ScriptEngine.getInstance().execScript("onStartLoop"),n.update(e),n.render(),t.ScriptEngine.getInstance().execScript("onEndLoop"),t.EventManager.trigger(t.CustomEvent.create(t.EEngineEvent.ENDLOOP))},n.prototype._startLoop=function(){var t=this;this._gameLoop=this._buildInitStream().ignoreElements().concat(this._buildLoopStream()).subscribe(function(e){t._loopBody(e)})},n.prototype._buildInitStream=function(){var t=this;return wdFrp.callFunc(function(){t._init()},this)},n.prototype._init=function(){this._initGameObjectScene(),this.initUIObjectScene(),t.DebugStatistics.init()},n.prototype._initGameObjectScene=function(){var t=this.scene.gameObjectScene;this._initDomEvent(),t.onEnter(),t.init(),this.renderer.init(),this._timeController.start(),this.scheduler.start()},n.prototype._buildLoopStream=function(){return wdFrp.intervalRequest()},n.prototype._loopBody=function(t){var n=null;return this._gameState===e.PAUSE||this._gameState===e.STOP?!1:(n=this._timeController.computeElapseTime(t),this._run(n),!0)},n.prototype._run=function(e){this._timeController.tick(e),t.EventManager.trigger(t.CustomEvent.create(t.EEngineEvent.STARTLOOP)),t.ScriptEngine.getInstance().execScript("onStartLoop"),this._update(e),this._render(),t.ScriptEngine.getInstance().execScript("onEndLoop"),t.EventManager.trigger(t.CustomEvent.create(t.EEngineEvent.ENDLOOP))},n.prototype._update=function(e){this.scheduler.update(e),t.ScriptEngine.getInstance().execScriptWithData("update",e),t.ActionEngine.getInstance().update(e),this.scene.gameObjectScene.update(e),this.scene.uiObjectScene.update(e)},n.prototype._render=function(){this.scene.gameObjectScene.render(this.renderer),this.renderer.clear(),this.renderer.hasCommand()&&(this.renderer.webglState=t.BasicState.create(),this.renderer.render()),this.scene.uiObjectScene.render()},n.prototype._initDomEvent=function(){this._eventSubscription=this.domEventManager.initDomEvent()},n._instance=null,__decorate([t.execOnlyOnce("_isInitUIScene")],n.prototype,"initUIObjectScene",null),__decorate([t.execOnlyOnce("_isInitDomEvent")],n.prototype,"_initDomEvent",null),n}();t.Director=n}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return Object.defineProperty(e,"isTest",{get:function(){return this._isTest},set:function(t){this._isTest=t,wdFrp.Main.isTest=t},enumerable:!0,configurable:!0}),e.setConfig=function(e){var n=e.canvasId,r=void 0===n?null:n,i=e.isTest,o=void 0===i?t.DebugConfig.isTest:i,a=e.screenSize,s=void 0===a?t.EScreenSize.FULL:a,c=e.contextConfig,u=void 0===c?{options:{alpha:!0,depth:!0,stencil:!1,antialias:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!1}}:c;return this.isTest=o,this.screenSize=s,this._canvasId=r,this._contextConfig={options:wdCb.ExtendUtils.extend({alpha:!0,depth:!0,stencil:!1,antialias:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!1},u.options)},this},e.init=function(){return t.DeviceManager.getInstance().createGL(this._canvasId,this._contextConfig),t.DeviceManager.getInstance().setScreen(),t.GPUDetector.getInstance().detect(),this},e._isTest=!1,e.screenSize=null,e._canvasId=null,e._contextConfig=null,e}();t.Main=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.designatedTriggerList=null,this._lastTriggerList=null,this._isDragEventTriggering=!1,this._triggerListOfDragEvent=null}return e.create=function(){var t=new this;return t},Object.defineProperty(e.prototype,"scene",{get:function(){return t.Director.getInstance().scene},enumerable:!0,configurable:!0}),e.prototype.initDomEvent=function(){var e=this;return wdFrp.fromArray([t.EventManager.fromEvent(t.EEventName.CLICK),t.EventManager.fromEvent(t.EEventName.MOUSEDOWN),t.EventManager.fromEvent(t.EEventName.MOUSEUP),t.EventManager.fromEvent(t.EEventName.MOUSEWHEEL),this._buildMouseDragStream()]).mergeAll().filter(function(e){return!t.Director.getInstance().isPause}).map(function(t){var n=e._getMouseEventTriggerList(t);return e._isDragEventTriggering&&(e._triggerListOfDragEvent=n),e._getMouseEventTriggerListData(t,n)}).merge(this._buildMouseMoveStream()).subscribe(function(t){var n=t[0],r=t[1];n.forEach(function(t){e._trigger(r.clone(),t)})})},e.prototype._buildMouseDragStream=function(){var e=this;return t.EventManager.fromEvent(document,t.EEventName.MOUSEDOWN).flatMap(function(n){return t.EventManager.fromEvent(document,t.EEventName.MOUSEMOVE).takeUntil(t.EventManager.fromEvent(document,t.EEventName.MOUSEUP)["do"](function(t){e._isDragEventTriggering=!1}))}).map(function(n){return n.name=t.EEventName.MOUSEDRAG,e._isDragEventTriggering=!0,n})},e.prototype._buildMouseMoveStream=function(){var e=this;return t.EventManager.fromEvent(t.EEventName.MOUSEMOVE).filter(function(e){return!t.Director.getInstance().isPause}).map(function(t){var n=null;n=e.designatedTriggerList?e.designatedTriggerList:e._isDragEventTriggering?e._triggerListOfDragEvent:e._getMouseEventTriggerList(t);var r=e._getMouseOverAndMouseOutObject(n,e._lastTriggerList),i=r.mouseoverObjects,o=r.mouseoutObjects;return e._setMouseOverTag(i),e._setMouseOutTag(o),e._lastTriggerList=n.clone(),n=o.addChildren(n),e._getMouseEventTriggerListData(t,n)})},e.prototype._getMouseOverAndMouseOutObject=function(e,n){var r=wdCb.Collection.create(),i=wdCb.Collection.create();return n?(n.forEach(function(n){e.hasChildWithFunc(function(e){return t.JudgeUtils.isEqual(e,n)})||i.addChild(n)}),e.forEach(function(e){n.hasChildWithFunc(function(n){return t.JudgeUtils.isEqual(e,n)})||r.addChild(e)})):r=e,{mouseoverObjects:r,mouseoutObjects:i}},e.prototype._setMouseOverTag=function(t){t.forEach(function(t){t.addTag(n.MOUSE_OVER)})},e.prototype._setMouseOutTag=function(t){t.forEach(function(t){t.addTag(n.MOUSE_OUT)})},e.prototype._setEventNameByEventTag=function(e,r){return e.hasTag(n.MOUSE_OVER)?r.name=t.EEventName.MOUSEOVER:e.hasTag(n.MOUSE_OUT)&&(r.name=t.EEventName.MOUSEOUT),r},e.prototype._removeEventTag=function(t){t.removeTag(n.MOUSE_OVER),t.removeTag(n.MOUSE_OUT)},e.prototype._trigger=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=e[0],i=e[1],o=!1,a=null,s=null,c=null;3===e.length&&e[2]?(o=!0,a=r):(a=this._setEventNameByEventTag(i,r),this._removeEventTag(i)),c=t.EventTriggerTable.getScriptHandlerName(a.name),s=t.CustomEvent.create(t.EEngineEvent[t.EventTriggerTable.getScriptEngineEvent(a.name)]),s.getDataFromDomEvent(a),t.EventManager.trigger(i,s,a,o),a.getDataFromCustomEvent(s),t.ScriptEngine.getInstance().execEntityObjectEventScriptWithData(i,c,a),!a.isStopPropagation&&i.bubbleParent&&this._trigger(a.clone(),i.bubbleParent,!0)},e.prototype._getMouseEventTriggerList=function(t){var e=null,n=null,r=null;return this.designatedTriggerList?this.designatedTriggerList:(r=wdCb.Collection.create(),e=this._findTopGameObject(t,this.scene.gameObjectScene),n=this._findTopUIObject(t,this.scene.uiObjectScene),e&&r.addChild(e),n&&r.addChild(n),this._isSceneAsTopOne(t,r)&&r.addChild(this.scene),r)},e.prototype._isSceneAsTopOne=function(t,e){return this._isTriggerScene(t)&&0===e.getCount()},e.prototype._findTopGameObject=function(t,e){var n=this;return this._findTriggerGameObjectList(t,e).sort(function(t,e){return n._getDistanceToCamera(t)-n._getDistanceToCamera(e)}).getChild(0)},e.prototype._getDistanceToCamera=function(e){return e.transform.position.clone().sub(t.Director.getInstance().scene.currentCamera.transform.position).length()},e.prototype._findTopUIObject=function(t,e){return this._findTriggerUIObjectList(t,e).sort(function(t,e){return e.transform.zIndex-t.transform.zIndex}).getChild(0)},e.prototype._findTriggerGameObjectList=function(e,n){var r=wdCb.Collection.create(),i=this,o=function(n){n.hasComponent(t.SpacePartition)?n.getSpacePartition().getIntersectListWithRay(e).forEach(function(t){i._addTriggerObjectByQueryDetector(t,e,r)}):(i._addTriggerObjectByQueryDetector(n,e,r),n.forEach(function(t){o(t)}))};return n.forEach(function(t){o(t)}),r},e.prototype._findTriggerUIObjectList=function(t,e){var n=wdCb.Collection.create(),r=this,i=function(e){r._addTriggerObjectByQueryDetector(e,t,n),e.forEach(function(t){i(t)})};return e.forEach(function(t){i(t)}),n},e.prototype._addTriggerObjectByQueryDetector=function(e,n,r){if(e.hasComponent(t.EventTriggerDetector)){var i=e.getComponent(t.EventTriggerDetector);i.isTrigger(n)&&r.addChild(e)}},e.prototype._isTriggerScene=function(e){var n=this.scene.getComponent(t.EventTriggerDetector);return n.isTrigger(e)},e.prototype._getMouseEventTriggerListData=function(t,e){return[e,t]},e}();t.DomEventManager=e;var n;!function(t){t[t.MOUSE_OVER="MOUSE_OVER"]="MOUSE_OVER",t[t.MOUSE_OUT="MOUSE_OUT"]="MOUSE_OUT"}(n||(n={}))}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._bubbleParent=null,this.name=null,this.parent=null,this.isVisible=!0,this.scriptManager=t.ScriptManager.create(this),this._hasComponentCache=wdCb.Hash.create(),this._getComponentCache=wdCb.Hash.create(),this._componentChangeSubscription=null,this._componentManager=t.ComponentManager.create(this),this._entityObjectManager=t.EntityObjectManager.create(this)}return __extends(n,e),Object.defineProperty(n.prototype,"bubbleParent",{get:function(){return this._bubbleParent?this._bubbleParent:this.parent},set:function(t){this._bubbleParent=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"componentDirty",{set:function(t){t===!0&&this.clearCache()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"transform",{get:function(){return this._componentManager.transform},enumerable:!0,configurable:!0}),n.prototype.initWhenCreate=function(){this.addComponent(this.createTransform())},n.prototype.clone=function(e){void 0===e&&(e={});var n=null;return t.CloneUtils.isNotClone(this)?null:(e=wdCb.ExtendUtils.extend({cloneChildren:!0,shareGeometry:!1,cloneGeometry:!0},e),n=t.CloneUtils.clone(this),this.forEachComponent(function(r){return!e.cloneGeometry&&r instanceof t.Geometry?void 0:e.shareGeometry&&r instanceof t.Geometry?void n.addComponent(r,!0):void n.addComponent(r.clone())}),e.cloneChildren&&this._cloneChildren(n),n)},n.prototype.init=function(){var e=this;return this._componentChangeSubscription=t.EventManager.fromEvent(this,t.EEngineEvent.COMPONENT_CHANGE).subscribe(function(){e._onComponentChange()}),this._componentManager.init(),this._entityObjectManager.init(),this.afterInitChildren(),this},n.prototype.onEnter=function(){t.ScriptEngine.getInstance().execEntityObjectScriptOnlyOnce(this,"onEnter"),t.EventManager.trigger(this,t.CustomEvent.create(t.EEngineEvent.ENTER))},n.prototype.onExit=function(){t.ScriptEngine.getInstance().execEntityObjectScriptOnlyOnce(this,"onExit"),t.EventManager.trigger(this,t.CustomEvent.create(t.EEngineEvent.EXIT))},n.prototype.onDispose=function(){t.ScriptEngine.getInstance().execEntityObjectScriptOnlyOnce(this,"onDispose")},n.prototype.dispose=function(){this.onDispose(),this.parent&&(this.parent.removeChild(this),this.parent=null),t.EventManager.off(this),this._componentChangeSubscription&&this._componentChangeSubscription.dispose(),this._componentManager.dispose(),this._entityObjectManager.dispose()},n.prototype.hasChild=function(t){return this._entityObjectManager.hasChild(t)},n.prototype.addChild=function(t){return this._entityObjectManager.addChild(t),t.transform.parent=this.transform,this},n.prototype.addChildren=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return this._entityObjectManager.addChildren(t[0]),this},n.prototype.forEach=function(t){return this._entityObjectManager.forEach(t),this},n.prototype.filter=function(t){return this._entityObjectManager.filter(t)},n.prototype.sort=function(t,e){return void 0===e&&(e=!1),this._entityObjectManager.sort(t,e)},n.prototype.getChildren=function(){return this._entityObjectManager.getChildren()},n.prototype.getChild=function(t){return this._entityObjectManager.getChild(t)},n.prototype.findChildByUid=function(t){return this._entityObjectManager.findChildByUid(t)},n.prototype.findChildByTag=function(t){return this._entityObjectManager.findChildByTag(t)},n.prototype.findChildByName=function(t){return this._entityObjectManager.findChildByName(t)},n.prototype.findChildrenByName=function(t){return this._entityObjectManager.findChildrenByName(t)},n.prototype.removeChild=function(t){return this._entityObjectManager.removeChild(t),this},n.prototype.removeAllChildren=function(){this._entityObjectManager.removeAllChildren()},n.prototype.getComponent=function(t){return this._componentManager.getComponent(t)},n.prototype.getComponents=function(){return this._componentManager.getComponents()},n.prototype.findComponentByUid=function(t){return this._componentManager.findComponentByUid(t)},n.prototype.forEachComponent=function(t){return this._componentManager.forEachComponent(t),this},n.prototype.hasComponent=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=this._getHasComponentCacheKey(t[0]),r=this._hasComponentCache.getChild(n);return void 0!==r?r:(r=this._componentManager.hasComponent(t[0]),this._hasComponentCache.addChild(n,r),r)},n.prototype.addComponent=function(t,e){return void 0===e&&(e=!1),this._componentManager.addComponent(t,e),this.componentDirty=!0,this},n.prototype.removeComponent=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return this._componentManager.removeComponent(t[0]),this.componentDirty=!0,this},n.prototype.removeAllComponent=function(){return this.componentDirty=!0,this._componentManager.removeAllComponent()},n.prototype.render=function(t,e){var n=null,r=null;this.isVisible&&(n=this.getGeometry(),r=this._componentManager.getRendererComponent(),r&&n&&r.render(t,n,e),this.getRenderList().forEach(function(n){n.render(t,e)}))},n.prototype.update=function(t){this.forEach(function(e){e.update(t)})},n.prototype.getComponentCount=function(t){return this._componentManager.getComponentCount(t)},n.prototype.afterInitChildren=function(){},n.prototype.getRenderList=function(){return this.isVisible?this._entityObjectManager.getChildren():null},n.prototype.getGeometry=function(){return this._componentManager.getGeometry()},n.prototype.getAllChildren=function(){return this._entityObjectManager.getAllChildren()},n.prototype.clearCache=function(){this._hasComponentCache.removeAllChildren(),this._getComponentCache.removeAllChildren()},n.prototype._getHasComponentCacheKey=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(t.JudgeUtils.isComponenet(e[0])){var r=e[0];return String(r.uid)}var i=e[0];return i.name},n.prototype._onComponentChange=function(){this.clearCache()},n.prototype._cloneChildren=function(t){this.forEach(function(e){var n=e.clone();null!==n&&t.addChild(n)})},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"bubbleParent",null),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"name",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"parent",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"isVisible",void 0),__decorate([t.virtual],n.prototype,"initWhenCreate",null),__decorate([t.cache(function(t){return this._getComponentCache.hasChild(t.name)},function(t){return this._getComponentCache.getChild(t.name)},function(t,e){this._getComponentCache.addChild(e.name,t)})],n.prototype,"getComponent",null),__decorate([t.virtual],n.prototype,"afterInitChildren",null),__decorate([t.virtual],n.prototype,"getRenderList",null),__decorate([t.virtual],n.prototype,"getGeometry",null),__decorate([t.ensure(function(e){t.assert(t.JudgeUtils.isString(e),t.Log.info.FUNC_SHOULD("key:"+e,"be string"))})],n.prototype,"_getHasComponentCacheKey",null),n}(t.Entity);t.EntityObject=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t){this.transform=null,this._entityObject=null,this._components=wdCb.Collection.create(),this._rendererComponent=null,this._collider=null,this._geometry=null,this._entityObject=t}return e.create=function(t){var e=new this(t);return e},e.prototype.init=function(){for(var e=0,n=t.SortUtils.insertSort(this._components.getChildren(),function(e,n){return t.ComponentInitOrderTable.getOrder(e)<t.ComponentInitOrderTable.getOrder(n)});e<n.length;e++){var r=n[e];r.init()}},e.prototype.dispose=function(){var t=this.removeAllComponent();t.forEach(function(t){t.dispose()}),this._components.removeAllChildren()},e.prototype.removeAllComponent=function(){var t=this,e=wdCb.Collection.create();return this._components.forEach(function(n){t._removeComponentHandler(n),e.addChild(n)},this),e},e.prototype.getComponent=function(t){return this._components.findOne(function(e){return e instanceof t})},e.prototype.getComponents=function(){return this._components},e.prototype.findComponentByUid=function(t){return this._components.findOne(function(e){return e.uid===t})},e.prototype.forEachComponent=function(t){return this._components.forEach(t),this},e.prototype.hasComponent=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null;if(t.JudgeUtils.isComponenet(e[0])){var i=e[0];r=this._components.hasChild(i)}else{var o=e[0];r=this._components.hasChildWithFunc(function(t){return t instanceof o})}return r},e.prototype.addComponent=function(e,n){return void 0===n&&(n=!1),e?(e instanceof t.RendererComponent?this._rendererComponent=e:e instanceof t.Collider?this._collider=e:e instanceof t.Geometry?this._geometry=e:e instanceof t.Transform&&(this.transform&&this.removeComponent(this.transform),this.transform=e),e.addToObject(this._entityObject,n),this._components.addChild(e),this):void 0},e.prototype.removeComponent=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null;return r=e[0]instanceof t.Component?e[0]:this.getComponent(e[0]),r&&(this._components.removeChild(r),this._removeComponentHandler(r)),this},e.prototype.getComponentCount=function(t){return this._components.filter(function(e){return e instanceof t}).getCount()},e.prototype.getGeometry=function(){return this._geometry},e.prototype.getRendererComponent=function(){return this._rendererComponent},e.prototype.getCollider=function(){return this._collider},e.prototype._removeComponentHandler=function(t){t.removeFromObject(this._entityObject)},__decorate([t.require(function(e,n){void 0===n&&(n=!1),e&&t.assert(!this.hasComponent(e),t.Log.info.FUNC_EXIST("the component",", please judge whether it hasComponent(component) before addComponent(component)"))})],e.prototype,"addComponent",null),__decorate([t.require(function(){t.assert(this.getComponentCount(t.Geometry)<=1,t.Log.info.FUNC_SHOULD_NOT("entityObject","contain more than 1 geometry component"))})],e.prototype,"getGeometry",null),__decorate([t.require(function(){t.assert(this.getComponentCount(t.RendererComponent)<=1,t.Log.info.FUNC_SHOULD_NOT("entityObject","contain more than 1 rendererComponent"))})],e.prototype,"getRendererComponent",null),__decorate([t.require(function(){t.assert(this.getComponentCount(t.Collider)<=1,t.Log.info.FUNC_SHOULD_NOT("entityObject","contain more than 1 collider component"))})],e.prototype,"getCollider",null),e}();t.ComponentManager=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t){this._entityObject=null,this._children=wdCb.Collection.create(),this._entityObject=t}return e.create=function(t){var e=new this(t);return e},e.prototype.init=function(){this.forEach(function(t){t.init()})},e.prototype.dispose=function(){this.forEach(function(t){t.dispose()})},e.prototype.hasChild=function(t){return this._children.hasChild(t)},e.prototype.addChild=function(t){return t.parent&&t.parent.removeChild(t),t.parent=this._entityObject,this._children.addChild(t),t.onEnter(),this},e.prototype.addChildren=function(){for(var e=this,n=[],r=0;r<arguments.length;r++)n[r-0]=arguments[r];if(t.JudgeUtils.isArray(n[0]))for(var i=n[0],o=0,a=i;o<a.length;o++){var s=a[o];this.addChild(s)}else if(t.JudgeUtils.isCollection(n[0])){var i=n[0];i.forEach(function(t){e.addChild(t)})}else this.addChild(n[0]);return this},e.prototype.forEach=function(t){return this._children.forEach(t),this},e.prototype.filter=function(t){return this._children.filter(t)},e.prototype.sort=function(t,e){return void 0===e&&(e=!1),this._children.sort(t,e)},e.prototype.getChildren=function(){return this._children},e.prototype.getAllChildren=function(){var t=wdCb.Collection.create(),e=function(n){t.addChildren(n.getChildren()),n.forEach(function(t){e(t)})};return e(this._entityObject),t},e.prototype.getChild=function(t){return this._children.getChild(t)},e.prototype.findChildByUid=function(t){return this._children.findOne(function(e){return e.uid===t})},e.prototype.findChildByTag=function(t){return this._children.findOne(function(e){return e.hasTag(t)})},e.prototype.findChildByName=function(t){return this._children.findOne(function(e){return e.name.search(t)>-1})},e.prototype.findChildrenByName=function(t){return this._children.filter(function(e){return e.name.search(t)>-1})},e.prototype.removeChild=function(t){return t.onExit(),this._children.removeChild(t),t.parent=null,this},e.prototype.removeAllChildren=function(){var t=this;this._children.forEach(function(e){t.removeChild(e)},this)},e}();t.EntityObjectManager=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(t){this._scriptList=wdCb.Hash.create(),this._entityObject=null,this._scriptExecuteHistory=wdCb.Hash.create(),this._entityObject=t}return t.create=function(t){var e=new this(t);return e},t.prototype.addChild=function(t,e){this._scriptList.addChild(t,e)},t.prototype.getChild=function(t){return this._scriptList.getChild(t)},t.prototype.removeChild=function(t){return this._scriptList.removeChild(function(e){return e===t})},t.prototype.hasChild=function(t){return this._scriptList.hasChildWithFunc(function(e){return e===t})},t.prototype.execScriptOnlyOnce=function(t){var e=this;this._scriptList.forEach(function(n,r){e._isScriptExecuted(r,t)||(n&&n[t]&&n[t](),e._addToScriptExecuteHistory(r,t))},this)},t.prototype.execScriptWithData=function(t,e){this._scriptList.forEach(function(n){n[t]&&n[t](e)})},t.prototype.execScript=function(t){this._scriptList.forEach(function(e){
e[t]&&e[t]()})},t.prototype.execEventScriptWithData=function(t,e){this._scriptList.forEach(function(n){n&&n[t]&&n[t](e)})},t.prototype._addToScriptExecuteHistory=function(t,e){this._scriptExecuteHistory.addChild(this._buildScriptHistoryKey(t,e),!0)},t.prototype._isScriptExecuted=function(t,e){return this._scriptExecuteHistory.getChild(this._buildScriptHistoryKey(t,e))},t.prototype._buildScriptHistoryKey=function(t,e){return t+"_"+e},t}();t.ScriptManager=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){this.list=wdCb.Collection.create()}return t.prototype.addChild=function(t){this.list.addChild(t)},t.prototype.removeChild=function(t){this.list.removeChild(t)},t.prototype.removeAllChildren=function(){this.list.removeAllChildren()},t.prototype.hasChild=function(t){return this.list.hasChild(t)},t}();t.ComponentContainer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},n.prototype.createTransform=function(){return t.RectTransform.create()},n.prototype.initWhenCreate=function(){e.prototype.initWhenCreate.call(this),this.name="uiObject"+String(this.uid)},n.prototype.addComponent=function(t){return e.prototype.addComponent.call(this,t),this},n.prototype.addChild=function(t){return e.prototype.addChild.call(this,t),this},__decorate([t.require(function(e){e instanceof t.UI&&t.assert(!this.getComponent(t.UI),t.Log.info.FUNC_SHOULD("only has one UI component"))})],n.prototype,"addComponent",null),__decorate([t.require(function(e){t.assert(this.getComponent(t.UIRenderer)===e.getComponent(t.UIRenderer),t.Log.info.FUNC_MUST_BE("the UIRenderer of UIObject and its children","the same one"))})],n.prototype,"addChild",null),n}(t.EntityObject);t.UIObject=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.renderGroup=0,this.renderPriority=0}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},n.merge=function(e){var n=e[0],r=n.clone({cloneChildren:!1,cloneGeometry:!1}),i=t.ModelGeometry.create();r.removeAllChildren();for(var o=0,a=e;o<a.length;o++){var s=a[o];i.merge(s.getComponent(t.Geometry),s.transform)}return i.material=n.getComponent(t.Geometry).material.clone(),r.addComponent(i),r},n.prototype.initWhenCreate=function(){e.prototype.initWhenCreate.call(this),this.name="gameObject"+String(this.uid)},n.prototype.getSpacePartition=function(){return this.getComponent(t.SpacePartition)},n.prototype.getGeometry=function(){var n=this.getComponent(t.LOD);return n&&n.activeGeometry?n.activeGeometry:e.prototype.getGeometry.call(this)},n.prototype.createTransform=function(){return t.ThreeDTransform.create()},n.prototype.getRenderList=function(){return this.hasComponent(t.Octree)?this.getSpacePartition().getRenderList():t.RenderUtils.getGameObjectRenderList(this.getChildren())},n.prototype.afterInitChildren=function(){return this.hasComponent(t.Octree)?this.getSpacePartition().build():void 0},__decorate([t.require(function(e){var n=function(e){t.assert(e.hasComponent(t.Geometry),t.Log.info.FUNC_SHOULD("contain geometry component"))},r=function(){var r=e[0],i=null;n(r),i=t.ClassUtils.getClassName(r.getComponent(t.Geometry).material);for(var o=1,a=e.length;a>o;o++){var s=e[o];n(s),t.assert(t.ClassUtils.getClassName(s.getComponent(t.Geometry).material)===i,t.Log.info.FUNC_SHOULD("gameObjectArr","has the same material class"))}};t.assert(e.length>1,t.Log.info.FUNC_SHOULD("object count","> 1")),r()}),t.ensure(function(e){t.assert(0===e.getChildren().getCount(),t.Log.info.FUNC_SHOULD("merged object","has no children"))})],n,"merge",null),n}(t.EntityObject);t.GameObject=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.name="scene"+String(this.uid),this.uiObjectScene=t.UIObjectScene.create(),this.gameObjectScene=t.GameObjectScene.create()}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},Object.defineProperty(n.prototype,"scriptManager",{get:function(){return this.gameObjectScene.scriptManager},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"ambientLight",{get:function(){return this.gameObjectScene.ambientLight},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"directionLights",{get:function(){return this.gameObjectScene.directionLights},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"pointLights",{get:function(){return this.gameObjectScene.pointLights},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"side",{get:function(){return this.gameObjectScene.side},set:function(t){this.gameObjectScene.side=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"shadowMap",{get:function(){return this.gameObjectScene.shadowMap},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"currentCamera",{get:function(){return this.gameObjectScene.currentCamera},set:function(t){this.gameObjectScene.currentCamera=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"physics",{get:function(){return this.gameObjectScene.physics},set:function(t){this.gameObjectScene.physics=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"physicsEngineAdapter",{get:function(){return this.gameObjectScene.physicsEngineAdapter},set:function(t){this.gameObjectScene.physicsEngineAdapter=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"glslData",{get:function(){return this.gameObjectScene.glslData},set:function(t){this.gameObjectScene.glslData=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isUseShader",{get:function(){return this.gameObjectScene.isUseShader},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"currentShaderType",{get:function(){return this.gameObjectScene.currentShaderType},enumerable:!0,configurable:!0}),n.prototype.initWhenCreate=function(){e.prototype.initWhenCreate.call(this),this.addComponent(t.SceneEventTriggerDetector.create())},n.prototype.useShaderType=function(t){this.gameObjectScene.useShaderType(t)},n.prototype.unUseShader=function(){this.gameObjectScene.unUseShader()},n.prototype.addChild=function(e){return e instanceof t.GameObject?this.gameObjectScene.addChild(e):e instanceof t.UIObject&&this.uiObjectScene.addChild(e),e.parent=this,this},n.prototype.addCommonRenderTargetRenderer=function(t){return this.gameObjectScene.renderTargetRendererManager.addCommonRenderTargetRenderer(t)},n.prototype.addProceduralRenderTargetRenderer=function(t){return this.gameObjectScene.renderTargetRendererManager.addProceduralRenderTargetRenderer(t)},n.prototype.dispose=function(){this.gameObjectScene.dispose(),this.uiObjectScene.dispose()},n.prototype.hasChild=function(e){return e instanceof t.GameObject?this.gameObjectScene.hasChild(e):e instanceof t.UIObject?this.uiObjectScene.hasChild(e):void 0},n.prototype.addChildren=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(e[0]instanceof t.EntityObject){var r=e[0];this.addChild(r)}if(e[0]instanceof wdCb.Collection){var i=e[0],o=this;i.forEach(function(t){o.addChild(t)})}else if(t.JudgeUtils.isArrayExactly(e[0]))for(var i=e[0],a=0,s=i;a<s.length;a++){var r=s[a];this.addChild(r)}return this},n.prototype.getChildren=function(){return this.gameObjectScene.getChildren().addChildren(this.uiObjectScene.getChildren())},n.prototype.findChildByUid=function(t){var e=this.gameObjectScene.findChildByUid(t);return e||(e=this.uiObjectScene.findChildByUid(t)),e},n.prototype.findChildByTag=function(t){var e=this.gameObjectScene.findChildByTag(t);return e||(e=this.uiObjectScene.findChildByTag(t)),e},n.prototype.findChildByName=function(t){var e=this.gameObjectScene.findChildByName(t);return e||(e=this.uiObjectScene.findChildByName(t)),e},n.prototype.findChildrenByName=function(t){return this.gameObjectScene.findChildrenByName(t).addChildren(this.uiObjectScene.findChildrenByName(t))},n.prototype.removeChild=function(e){return e instanceof t.GameObject?this.gameObjectScene.removeChild(e):e instanceof t.UIObject?this.uiObjectScene.removeChild(e):void 0},n.prototype.onEnter=function(){this.gameObjectScene.onEnter(),this.uiObjectScene.onEnter()},n.prototype.onExit=function(){this.gameObjectScene.onExit(),this.uiObjectScene.onExit()},n.prototype.onDispose=function(){this.gameObjectScene.onDispose(),this.uiObjectScene.onDispose()},n.prototype.createTransform=function(){return null},__decorate([t.ensureGetter(function(e){e&&t.assert(e.getCount()<=4,t.Log.info.FUNC_SHOULD("direction lights' count","<= 4"))})],n.prototype,"directionLights",null),__decorate([t.ensureGetter(function(e){e&&t.assert(e.getCount()<=4,t.Log.info.FUNC_SHOULD("point lights' count","<= 4"))})],n.prototype,"pointLights",null),n}(t.EntityObject);t.SceneDispatcher=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(t.EntityObject);t.Scene=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._startLoopSubscription=null,this._endLoopSubscription=null}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},n.prototype.init=function(){var n=this;return e.prototype.init.call(this),this._startLoopSubscription=t.EventManager.fromEvent(t.EEngineEvent.STARTLOOP).subscribe(function(){n._sortSiblingChildren()}),this._endLoopSubscription=t.EventManager.fromEvent(t.EEngineEvent.ENDLOOP).subscribe(function(){n._resetAllRendererClearCanvasFlag()}),this},n.prototype.update=function(n){e.prototype.update.call(this,n),t.UIEngine.getInstance().update(n)},n.prototype.onDispose=function(){e.prototype.onDispose.call(this),this._startLoopSubscription.dispose(),this._endLoopSubscription.dispose()},n.prototype.render=function(){var e=this;this._resetAllRendererState(),this.forEach(function(n){var r=e._getUIRenderer(n);r.dirty?(r.isClearCanvas||r.clearCanvas(),r.state=t.EUIRendererState.DIRTY,r.resetDirty()):r.state!==t.EUIRendererState.DIRTY&&(r.state=t.EUIRendererState.NOT_DIRTY)}),t.UIEngine.getInstance().render()},n.prototype.createTransform=function(){return null},n.prototype._getUIRenderer=function(e){return e.getComponent(t.UIRenderer)},n.prototype._resetAllRendererClearCanvasFlag=function(){var t=this;this.forEach(function(e){var n=t._getUIRenderer(e);n.isClearCanvas=!1})},n.prototype._resetAllRendererState=function(){var e=this;this.forEach(function(n){var r=e._getUIRenderer(n);r.state=t.EUIRendererState.NORMAL})},n.prototype._sortSiblingChildren=function(){var t=function(e){e.sort(function(t,e){return t.transform.zIndex-e.transform.zIndex},!0),e.forEach(function(e){t(e)})};t(this)},__decorate([t.require(function(){this.forEach(function(e){t.assert(e instanceof t.UIObject,t.Log.info.FUNC_MUST_BE("child","UIObject")),t.assert(e.hasComponent(t.UI),t.Log.info.FUNC_SHOULD("UIObject","contain ui component"))})})],n.prototype,"render",null),__decorate([t.require(function(e){t.assert(e.getComponentCount(t.UIRenderer)<=1,t.Log.info.FUNC_SHOULD_NOT("uiObject","contain more than 1 uiRenderer component"))})],n.prototype,"_getUIRenderer",null),__decorate([t.ensure(function(){var e=this;this.getAllChildren().forEach(function(n){var r=e._getUIRenderer(n);t.assert(!r.isClearCanvas,t.Log.info.FUNC_SHOULD("reset all UIRenderers->isClearCanvas"))})})],n.prototype,"_resetAllRendererClearCanvasFlag",null),__decorate([t.ensure(function(){var e=this;this.getAllChildren().forEach(function(n){var r=e._getUIRenderer(n);t.assert(r.state===t.EUIRendererState.NORMAL,t.Log.info.FUNC_SHOULD("reset all UIRenderers->state"))})})],n.prototype,"_resetAllRendererState",null),n}(t.Scene);t.UIObjectScene=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.bindIndexBuffer=function(e){var n=null;this.lastBindedElementBuffer!==e&&(this.lastBindedElementBuffer=e,n=t.DeviceManager.getInstance().gl,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.buffer))},e.hasBuffer=function(t){return this._table.hasChild(t)},e.addBuffer=function(t,e){this._table.addChild(t,e)},e.getBuffer=function(t){return this._table.getChild(t)},e.dispose=function(){this._table.forEach(function(t){t.dispose()}),this.lastBindedArrayBufferListUidStr=null,this.lastBindedElementBuffer=null},e.clearAll=function(){this._table.removeAllChildren(),this.lastBindedArrayBufferListUidStr=null,this.lastBindedElementBuffer=null},e.resetBindedArrayBuffer=function(){var e=t.DeviceManager.getInstance().gl;e.bindBuffer(e.ARRAY_BUFFER,null),this.lastBindedArrayBufferListUidStr=null},e.resetBindedElementBuffer=function(){var e=t.DeviceManager.getInstance().gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),this.lastBindedElementBuffer=null},e.lastBindedArrayBufferListUidStr=null,e.lastBindedElementBuffer=null,e._table=wdCb.Hash.create(),e}();t.BufferTable=e,function(t){t[t.PROCEDURAL_VERTEX="PROCEDURAL_VERTEX"]="PROCEDURAL_VERTEX",t[t.PROCEDURAL_INDEX="PROCEDURAL_INDEX"]="PROCEDURAL_INDEX"}(t.BufferTableKey||(t.BufferTableKey={}));t.BufferTableKey}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t.hasProgram=function(t){return this._table.hasChild(t)},t.addProgram=function(t,e){this._table.addChild(t,e)},t.getProgram=function(t){return this._table.getChild(t)},t.dispose=function(){this._table.forEach(function(t){t.dispose()}),this.lastUsedProgram=null},t.clearAll=function(){this._table.removeAllChildren(),this.lastUsedProgram=null},t.lastUsedProgram=null,t._table=wdCb.Hash.create(),t}();t.ProgramTable=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.isCached=function(e,n){return t.JudgeUtils.isEqual(this.getActiveTexture(e),n)},e.addActiveTexture=function(t,e){this._bindTextureUnitCache[t]=e},e.getActiveTexture=function(t){return this._bindTextureUnitCache[t]},e.clearAll=function(){this._bindTextureUnitCache=[]},e.clearAllBindTextureUnitCache=function(){this._bindTextureUnitCache=[]},e.clearBindTextureUnitCache=function(t){this._bindTextureUnitCache[t]=null},e._checkUnit=function(e){var n=t.GPUDetector.getInstance().maxTextureUnit;t.assert(e>=0,t.Log.info.FUNC_SHOULD("texture unit",">= 0, but actual is "+e)),t.assert(n>e,"trying to cache "+e+" texture units, but GPU only supports "+n+" units")},e._bindTextureUnitCache=[],__decorate([t.require(function(t,e){this._checkUnit(t)})],e,"addActiveTexture",null),__decorate([t.require(function(t,e){this._checkUnit(t)})],e,"getActiveTexture",null),e}();t.TextureCache=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function i(){e.apply(this,arguments),this._currentCamera=null,this.side=null,this.shadowMap=r.create(this),this.physics=n.create(),this.physicsEngineAdapter=null,this.glslData=wdCb.Hash.create(),this.currentShaderType=null,this.renderTargetRendererManager=t.RenderTargetRendererManager.create(),this.shadowManager=t.ShadowManager.create(this),this._lightManager=t.LightManager.create(),this._cameraList=wdCb.Collection.create()}return __extends(i,e),i.create=function(){var t=new this;return t.initWhenCreate(),t},Object.defineProperty(i.prototype,"ambientLight",{get:function(){return this._lightManager.ambientLight},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"directionLights",{get:function(){return this._lightManager.directionLights},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"pointLights",{get:function(){return this._lightManager.pointLights},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"currentCamera",{get:function(){return this._currentCamera||this._cameraList.getChild(0)},set:function(e){if(t.JudgeUtils.isNumber(e)){var n=e;this._currentCamera=this._cameraList.getChild(n)}else if(e instanceof t.GameObject){var r=e;this._currentCamera=r}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isUseShader",{get:function(){return null!==this.currentShaderType},enumerable:!0,configurable:!0}),i.prototype.init=function(){return this.physics.enable&&(this.physicsEngineAdapter=t.PhysicsEngineFactory.create(this.physics.engine),this.physicsEngineAdapter.init()),this.shadowManager.init(),e.prototype.init.call(this),this.renderTargetRendererManager.init(),t.RigidBodyEngine.getInstance().initBody(),t.RigidBodyEngine.getInstance().initConstraint(),this},i.prototype.dispose=function(){e.prototype.dispose.call(this),this.shadowManager.dispose(),this.renderTargetRendererManager.dispose()},i.prototype.addChild=function(t){var n=this._getCameras(t),r=this._getLights(t);return n.getCount()>0&&this._cameraList.addChildren(n),r.getCount()>0&&this._lightManager.addChildren(r),e.prototype.addChild.call(this,t)},i.prototype.update=function(n){var r=this._getCurrentCameraComponent(),i=this.shadowManager;this.physics.enable&&this.physicsEngineAdapter.update(n),r&&r.update(n),i.update(n),t.LODEngine.getInstance().update(n),t.SpacePartitionEngine.getInstance().update(n),t.AnimationEngine.getInstance().update(n),t.ColliderEngine.getInstance().update(n),e.prototype.update.call(this,n),t.ColliderEngine.getInstance().detect(n)},i.prototype.render=function(t){this.shadowManager.setShadowRenderListForCurrentLoop(),this.renderTargetRendererManager.render(t,this.currentCamera),e.prototype.render.call(this,t,this.currentCamera)},i.prototype.useShaderType=function(t){this.currentShaderType=t},i.prototype.unUseShader=function(){this.currentShaderType=null},i.prototype.getRenderList=function(){return t.RenderUtils.getGameObjectRenderList(this.getChildren())},i.prototype.createTransform=function(){return null},i.prototype._getCameras=function(t){return this._find(t,this._isCamera)},i.prototype._getLights=function(t){return this._find(t,this._isLight)},i.prototype._find=function(t,e){var n=this,r=wdCb.Collection.create(),i=function(t){e.call(n,t)&&r.addChild(t),t.forEach(function(t){i(t)})};return i(t),r},i.prototype._isCamera=function(e){return e.hasComponent(t.CameraController)},i.prototype._isLight=function(e){return e.hasComponent(t.Light)},i.prototype._getCurrentCameraComponent=function(){return this.currentCamera?this.currentCamera.getComponent(t.CameraController):null},__decorate([t.requireSetter(function(e){if(t.JudgeUtils.isNumber(e)){var n=e;t.assert(!!this._cameraList.getChild(n),t.Log.info.FUNC_NOT_EXIST("current camera in cameraList"))}})],i.prototype,"currentCamera",null),i}(t.Scene);t.GameObjectScene=e;var n=function(){function e(){this._gravity=t.Vector3.create(0,-9.8,0),this.enable=!1,this.engine=t.EPhysicsEngineType.CANNON,this.iterations=10}return e.create=function(){var t=new this;return t},Object.defineProperty(e.prototype,"gravity",{get:function(){return this._gravity},set:function(t){this._gravity=t},enumerable:!0,configurable:!0}),__decorate([t.operateWorldDataGetterAndSetter("Gravity")],e.prototype,"gravity",null),e}();t.PhysicsConfig=n;var r=function(){function e(e){this._scene=null,this._enable=!0,this._softType=t.EShadowMapSoftType.NONE,this.shadowLayerList=t.ShadowLayerList.create(),this._scene=e}return e.create=function(t){var e=new this(t);return e},Object.defineProperty(e.prototype,"enable",{get:function(){return this._enable},set:function(t){this._enable=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"softType",{get:function(){return this._softType},set:function(e){e!==this._softType&&(t.EventManager.broadcast(this._scene,t.CustomEvent.create(t.EEngineEvent.SHADOWMAP_SOFTTYPE_CHANGE)),this._softType=e)},enumerable:!0,configurable:!0}),e.prototype.getTwoDShadowMapDataMap=function(t){return this._scene.shadowManager.getTwoDShadowMapDataMap(t)},e.prototype.getCubemapShadowMapDataMap=function(t){return this._scene.shadowManager.getCubemapShadowMapDataMap(t)},e}();t.ShadowMapModel=r}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._collisionTable=wdCb.Hash.create(),this._lastCollisionTable=wdCb.Hash.create()}return e.create=function(){var t=new this;return t},e.prototype.update=function(e){var n=t.Director.getInstance().scene.gameObjectScene,r=n.filter(function(e){return e.hasComponent(t.Collider)||t.JudgeUtils.isSpacePartitionObject(e)&&e.getSpacePartition().isCollideEnable}),i=this;0!==r.getCount()&&(this._clearCollisionTable(),r.forEach(function(e){e.hasComponent(t.RigidBody)||i._recordCollideObjects(e,r)}),this._triggerCollisionEvent())},e.prototype._recordCollideObjects=function(e,n){var r=this;if(t.JudgeUtils.isSpacePartitionObject(e)){var i=e.getSpacePartition();return void n.forEach(function(n){t.JudgeUtils.isSelf(e,n)||(t.JudgeUtils.isSpacePartitionObject(n)?r._handleCollisionBetweenSpacePartitionAndSpacePartition(n.getSpacePartition(),i):r._handleCollisionBetweenGameObjectAndSpacePartition(n.getComponent(t.Collider),i))})}var o=e.getComponent(t.Collider);o.enable&&n.forEach(function(n){t.JudgeUtils.isSelf(e,n)||(t.JudgeUtils.isSpacePartitionObject(n)?r._handleCollisionBetweenGameObjectAndSpacePartition(o,n.getSpacePartition()):r._handleCollisionBetweenGameObjectAndGameObject(o,n))})},e.prototype._isGameObjectCollideWithGameObject=function(t,e,r){return!(this._isNotTransform(t)&&this._isNotTransform(r)&&!t.hasTag(n.COLLIDED))&&e.isCollide(r)},e.prototype._clearCollisionTable=function(){this._collisionTable.removeAllChildren()},e.prototype._isCollidedInTable=function(t,e){var n=this._collisionTable,r=String(t.uid),i=String(e.uid);return n.hasChild(r)&&n.getChild(r).targetObjectMap.hasChild(i)},e.prototype._recordToTable=function(t,e){var n=this._collisionTable,r=String(t.uid),i=String(e.uid);if(!n.hasChild(r)){var o=wdCb.Hash.create();return o.addChild(i,e),void n.addChild(r,{sourceObject:t,targetObjectMap:o})}n.getChild(r).targetObjectMap.addChild(i,e)},e.prototype._handleCollisionBetweenGameObjectAndSpacePartition=function(e,n){var r=e.entityObject,i=this;e.enable&&n.getCollideObjects(e.shape).forEach(function(e){var n=e.getComponent(t.Collider);n.enable&&!i._isCollidedInTable(e,r)&&i._isGameObjectCollideWithGameObject(e,n,r)&&(i._recordToTable(e,r),i._recordToTable(r,e))})},e.prototype._handleCollisionBetweenSpacePartitionAndSpacePartition=function(e,n){var r=this;e.getChildren().forEach(function(e){var i=e.getComponent(t.Collider);i.enable&&r._handleCollisionBetweenGameObjectAndSpacePartition(i,n)},this)},e.prototype._handleCollisionBetweenGameObjectAndGameObject=function(e,n){var r=e.entityObject;n.getComponent(t.Collider).enable&&!this._isCollidedInTable(r,n)&&this._isGameObjectCollideWithGameObject(r,e,n)&&(this._recordToTable(r,n),this._recordToTable(n,r))},e.prototype._isCollisionStart=function(t){return!t.hasTag(n.COLLIDED)},e.prototype._triggerCollisionEventOfCollideObjectWhichHasRigidBody=function(e,n,r){n.hasComponent(t.RigidBody)&&e.filter(function(e){return e.hasComponent(t.RigidBody)}).forEach(function(e){for(var i=0,o=r;i<o.length;i++){var a=o[i];t.ScriptEngine.getInstance().execEntityObjectScriptWithData(e,a,wdCb.Collection.create([n]))}})},e.prototype._triggerCollisionEvent=function(){var e=this;this._collisionTable.forEach(function(r){var i=r.sourceObject,o=r.targetObjectMap,a=o.toCollection();e._isCollisionStart(i)?(t.ScriptEngine.getInstance().execEntityObjectScriptWithData(i,"onCollisionStart",a),t.ScriptEngine.getInstance().execEntityObjectScriptWithData(i,"onContact",a),e._triggerCollisionEventOfCollideObjectWhichHasRigidBody(a,i,["onCollisionStart","onContact"])):(t.ScriptEngine.getInstance().execEntityObjectScriptWithData(i,"onContact",a),e._triggerCollisionEventOfCollideObjectWhichHasRigidBody(a,i,["onContact"])),i.hasTag(n.COLLIDED)||i.addTag(n.COLLIDED)},this),this._triggerCollisionEndEvent(),this._lastCollisionTable=this._collisionTable.clone()},e.prototype._triggerCollisionEndEvent=function(){var e=this,r=this._collisionTable;this._lastCollisionTable.forEach(function(i){var o=i.sourceObject,a=i.targetObjectMap;r.hasChild(String(o.uid))||(t.ScriptEngine.getInstance().execEntityObjectScript(o,"onCollisionEnd"),e._triggerCollisionEventOfCollideObjectWhichHasRigidBody(a.toCollection(),o,["onCollisionEnd"]),o.removeTag(n.COLLIDED))})},e.prototype._isNotTransform=function(t){return!t.transform.isTransform},__decorate([t.require(function(e,n){n.forEach(function(e){t.assert(e instanceof t.GameObject,t.Log.info.FUNC_SHOULD("targetObject","be GameObject"))})})],e.prototype,"_recordCollideObjects",null),__decorate([t.require(function(e,n,r){t.assert(e instanceof t.GameObject&&r instanceof t.GameObject,t.Log.info.FUNC_SHOULD("sourceObject and targetObject","be GameObject"))})],e.prototype,"_isGameObjectCollideWithGameObject",null),e}();t.CollisionDetector=e;var n;!function(t){t[t.COLLIDED="COLLIDED"]="COLLIDED"}(n||(n={}))}(wd||(wd={}));var wd;!function(t){var e=function(){function e(e){this.gameObjectScene=null,this._shadowRenderList=null,this._endLoopSubscription=null,this._shadowMapManager=t.ShadowMapManager.create(this),this._shadowMapLayerChangeSubscription=null,this.gameObjectScene=e}return e.create=function(t){var e=new this(t);return e},Object.defineProperty(e.prototype,"twoDShadowMapDataMap",{get:function(){return this._shadowMapManager.twoDShadowMapDataMap},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"twoDShadowMapCountForGLSL",{get:function(){return this._shadowMapManager.twoDShadowMapCountForGLSL},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cubemapShadowMapDataMap",{get:function(){return this._shadowMapManager.cubemapShadowMapDataMap},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cubemapShadowMapCountForGLSL",{get:function(){return this._shadowMapManager.cubemapShadowMapCountForGLSL},enumerable:!0,configurable:!0}),e.prototype.update=function(t){this._isShadowMapEnable()&&this.gameObjectScene.shadowMap.shadowLayerList.update()},e.prototype.dispose=function(){this._endLoopSubscription&&this._endLoopSubscription.dispose(),this._shadowMapLayerChangeSubscription&&this._shadowMapLayerChangeSubscription.dispose(),this._shadowMapManager.dispose()},e.prototype.getTwoDShadowMapDataMap=function(t){return this._shadowMapManager.twoDShadowMapDataMap.getChild(t)},e.prototype.getCubemapShadowMapDataMap=function(t){return this._shadowMapManager.cubemapShadowMapDataMap.getChild(t)},e.prototype.setShadowRenderListForCurrentLoop=function(){this._isShadowMapEnable()&&(this._shadowRenderList=this._getShadowRenderList())},e.prototype.getShadowRenderListByLayer=function(e){return this._shadowRenderList.filter(function(n){return n.getComponent(t.Shadow).layer===e})},e.prototype.getShadowLayerList=function(){var e=null,n=this.gameObjectScene.shadowMap.shadowLayerList,r=this;return n.dirty?n.removeRepeatItems():(e=t.ShadowLayerList.create(),t.RenderUtils.getGameObjectRenderList(this.gameObjectScene.getChildren()).forEach(function(n){return t.JudgeUtils.isSpacePartitionObject(n)?void n.forEach(function(n){r._isCastShadow(n)&&e.addChild(n.getComponent(t.Shadow).layer)}):void(r._isCastShadow(n)&&e.addChild(n.getComponent(t.Shadow).layer))}),e.dirty=!1,e.removeRepeatItems())},e.prototype.init=function(){var e=this,n=this.gameObjectScene,r=null;this._isShadowMapEnable()&&this._hasShadow()&&(this.gameObjectScene.shadowMap.shadowLayerList=this.getShadowLayerList(),r=this.gameObjectScene.shadowMap.shadowLayerList,r.init(),this._shadowMapManager.initShadowMapData(r),this._shadowMapManager.twoDShadowMapDataMap.forEach(function(e,r){e.forEach(function(e){var i=e.shadowMap,o=e.light,a=t.TwoDShadowMapRenderTargetRenderer.create(i,o,r);n.renderTargetRendererManager.addCommonRenderTargetRenderer(a)})}),this._shadowMapManager.cubemapShadowMapDataMap.forEach(function(e,r){e.forEach(function(e){var i=e.shadowMap,o=e.light,a=t.CubemapShadowMapRenderTargetRenderer.create(i,o,r);n.renderTargetRendererManager.addCommonRenderTargetRenderer(a)})}),this._initShadowList(),this._shadowMapLayerChangeSubscription=t.EventManager.fromEvent(t.EEngineEvent.SHADOWMAP_LAYER_CHANGE).subscribe(function(){e._updateWhenShadowLayerChange()}))},e.prototype._getShadowRenderList=function(){var e=wdCb.Collection.create(),n=this;return t.RenderUtils.getGameObjectRenderList(this.gameObjectScene.getChildren()).forEach(function(r){return t.JudgeUtils.isSpacePartitionObject(r)?void e.addChildren(r.getSpacePartition().getRenderList().filter(function(t){return n._isCastShadow(t)})):void(n._isCastShadow(r)&&e.addChild(r))}),e},e.prototype._updateWhenShadowLayerChange=function(){var t=this.gameObjectScene;if(this._hasShadow()){this._shadowMapManager.updateWhenShadowLayerChange(t.shadowMap.shadowLayerList.getDiffData());var e=this._shadowMapManager.getAllDiffShadowMapDataWhenShadowLayerChange(),n=e.addTwoDShadowMapData,r=e.removeTwoDShadowMapData,i=e.addCubemapShadowMapData,o=e.removeCubemapShadowMapData;this._refreshRenderTargerRendererList(n,r,i,o)}},e.prototype._refreshRenderTargerRendererList=function(e,n,r,i){var o=this.gameObjectScene;o.renderTargetRendererManager.removeCommonRenderTargetRenderer(function(e){var r=e.texture;return n.hasChildWithFunc(function(e){return t.JudgeUtils.isEqual(e.shadowMap,r)})||i.hasChildWithFunc(function(e){return t.JudgeUtils.isEqual(e.shadowMap,r)})}).forEach(function(t){t.dispose()}),e.forEach(function(e,n){e.forEach(function(e){var r=e.shadowMap,i=e.light,a=t.TwoDShadowMapRenderTargetRenderer.create(r,i,n);a.init(),o.renderTargetRendererManager.addCommonRenderTargetRenderer(a)})}),r.forEach(function(e,n){e.forEach(function(e){var r=e.shadowMap,i=e.light,a=t.CubemapShadowMapRenderTargetRenderer.create(r,i,n);a.init(),o.renderTargetRendererManager.addCommonRenderTargetRenderer(a)})})},e.prototype._initShadowList=function(){var e=this;this._endLoopSubscription=t.EventManager.fromEvent(t.EEngineEvent.ENDLOOP).subscribe(function(){e._removeShadowMapGLSLData()})},e.prototype._isCastShadow=function(e){var n=e.getComponent(t.Shadow);return!!n&&n.cast},e.prototype._removeShadowMapGLSLData=function(){t.Director.getInstance().scene.glslData.removeChild(t.EShaderGLSLData.TWOD_SHADOWMAP),t.Director.getInstance().scene.glslData.removeChild(t.EShaderGLSLData.CUBEMAP_SHADOWMAP),t.Director.getInstance().scene.glslData.removeChild(t.EShaderGLSLData.BUILD_CUBEMAP_SHADOWMAP)},e.prototype._hasShadow=function(){var t=this.gameObjectScene;return!!t.directionLights||!!t.pointLights},e.prototype._isShadowMapEnable=function(){return this.gameObjectScene.shadowMap.enable},__decorate([t.require(function(){var e=this,n=function(){e.gameObjectScene.getChildren().filter(function(e){return!t.JudgeUtils.isSpacePartitionObject(e)}).forEach(function(e){var n=function(e){t.assert(!e.hasComponent(t.Shadow),t.Log.info.FUNC_CAN_NOT("if the first level object of gameObjectScene don't contain Shadow component, its children","contain Shadow component")),e.forEach(function(t){n(t)})};e.hasComponent(t.Shadow)||e.forEach(function(t){n(t)})})},r=function(){e.gameObjectScene.getChildren().filter(function(e){return t.JudgeUtils.isSpacePartitionObject(e)}).forEach(function(e){e.forEach(function(e){var n=function(e){t.assert(!e.hasComponent(t.Shadow),t.Log.info.FUNC_CAN_NOT("if the first level object of space partition objject don't contain Shadow component, its children","contain Shadow component")),e.forEach(function(t){n(t)})};e.hasComponent(t.Shadow)||e.forEach(function(t){n(t)})})})};n(),r()})],e.prototype,"_getShadowRenderList",null),__decorate([t.require(function(){var e=this.gameObjectScene.shadowMap.shadowLayerList;t.assert(e.dirty,t.Log.info.FUNC_SHOULD("shadowLayerList","dirty")),this._getShadowRenderList().forEach(function(n){t.assert(e.hasChild(n.getComponent(t.Shadow).layer),t.Log.info.FUNC_SHOULD("the shadow layer of shadow gameObject","exist in scene->shadowLayerList"))})})],e.prototype,"_updateWhenShadowLayerChange",null),__decorate([t.ensure(function(){t.assert(!this.gameObjectScene.renderTargetRendererManager.getCommonRenderTargetRendererList().hasRepeatItems(),t.Log.info.FUNC_SHOULD_NOT("scene->commonRenderTargetRendererList","has repeat items"))})],e.prototype,"_refreshRenderTargerRendererList",null),e}();t.ShadowManager=e}(wd||(wd={}));var wd;!function(t){var e=function(){
function e(t){this.twoDShadowMapDataMap=wdCb.Hash.create(),this.cubemapShadowMapDataMap=wdCb.Hash.create(),this._shadowManager=null,this._lastTwoDShadowMapDataMap=wdCb.Hash.create(),this._lastCubemapShadowMapDataMap=wdCb.Hash.create(),this._shadowManager=t}return e.create=function(t){var e=new this(t);return e},Object.defineProperty(e.prototype,"twoDShadowMapCountForGLSL",{get:function(){var t=0;return this.twoDShadowMapDataMap.forEach(function(e){t+=e.getCount()}),t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cubemapShadowMapCountForGLSL",{get:function(){var t=0;return this.cubemapShadowMapDataMap.forEach(function(e){t+=e.getCount()}),t},enumerable:!0,configurable:!0}),e.prototype.initShadowMapData=function(e){var n=this,r=this._shadowManager.gameObjectScene;r.directionLights&&r.directionLights.getCount()>0&&r.directionLights.forEach(function(r){var i=r.getComponent(t.DirectionLight);i.castShadow&&n._addTwoDShadowMapDataWithLayer(e,i)},this),r.pointLights&&r.pointLights.getCount()>0&&r.pointLights.forEach(function(r){var i=r.getComponent(t.PointLight);i.castShadow&&n._addCubemapShadowMapDataWithLayer(e,i)},this)},e.prototype.updateWhenShadowLayerChange=function(e){var n=this,r=e.addLayerList,i=e.removeLayerList,o=null;if(o=this._shadowManager.gameObjectScene,o.directionLights&&o.directionLights.getCount()>0){var a=this.twoDShadowMapDataMap;this._lastTwoDShadowMapDataMap=a.clone(),i.forEach(function(t){a.removeChild(t)}),o.directionLights.forEach(function(e){var i=e.getComponent(t.DirectionLight);i.castShadow&&n._addTwoDShadowMapDataWithLayer(r,i)},this)}if(o.pointLights&&o.pointLights.getCount()>0){var s=this.cubemapShadowMapDataMap;this._lastCubemapShadowMapDataMap=s.clone(),i.forEach(function(t){s.removeChild(t)}),o.pointLights.forEach(function(e){var i=e.getComponent(t.PointLight);i.castShadow&&n._addCubemapShadowMapDataWithLayer(r,i)},this)}},e.prototype.getAllDiffShadowMapDataWhenShadowLayerChange=function(){var t=this._getDiffShadowMapDataWhenShadowLayerChange(this._lastTwoDShadowMapDataMap,this.twoDShadowMapDataMap),e=this._getDiffShadowMapDataWhenShadowLayerChange(this._lastCubemapShadowMapDataMap,this.cubemapShadowMapDataMap);return{addTwoDShadowMapData:t.addShadowMapData,removeTwoDShadowMapData:t.removeShadowMapData,addCubemapShadowMapData:e.addShadowMapData,removeCubemapShadowMapData:e.removeShadowMapData}},e.prototype._getDiffShadowMapDataWhenShadowLayerChange=function(t,e){var n=wdCb.Hash.create(),r=wdCb.Collection.create();return r=t.filter(function(t,n){return!e.hasChild(n)}).toCollection(),n=e.filter(function(e,n){return!t.hasChild(n)}),{addShadowMapData:n,removeShadowMapData:r}},e.prototype._addTwoDShadowMapDataWithLayer=function(e,n){var r=this.twoDShadowMapDataMap;e.forEach(function(e){r.appendChild(e,{shadowMap:t.TwoDShadowMapTexture.create(),light:n})})},e.prototype._addCubemapShadowMapDataWithLayer=function(e,n){var r=this.cubemapShadowMapDataMap;e.forEach(function(e){r.appendChild(e,{shadowMap:t.CubemapShadowMapTexture.create(),light:n})})},e.prototype.dispose=function(){},__decorate([t.require(function(e,n){t.assert(!e.hasRepeatItems(),t.Log.info.FUNC_SHOULD_NOT("has repeat shadow layer"))})],e.prototype,"_addTwoDShadowMapDataWithLayer",null),__decorate([t.require(function(e,n){t.assert(!e.hasRepeatItems(),t.Log.info.FUNC_SHOULD_NOT("has repeat shadow layer"))})],e.prototype,"_addCubemapShadowMapDataWithLayer",null),e}();t.ShadowMapManager=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._lights=wdCb.Hash.create()}return e.create=function(){var t=new this;return t},Object.defineProperty(e.prototype,"ambientLight",{get:function(){return this._lights.getChild(t.AmbientLight.type)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"directionLights",{get:function(){return this._getLights(t.DirectionLight.type)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pointLights",{get:function(){return this._getLights(t.PointLight.type)},enumerable:!0,configurable:!0}),e.prototype.addChild=function(e){e.hasComponent(t.AmbientLight)?this._lights.addChild(t.AmbientLight.type,e):e.hasComponent(t.DirectionLight)?this._lights.appendChild(t.DirectionLight.type,e):e.hasComponent(t.PointLight)?this._lights.appendChild(t.PointLight.type,e):t.Log.error(!0,t.Log.info.FUNC_INVALID("light"))},e.prototype.addChildren=function(t){var e=this;t.forEach(function(t){e.addChild(t)})},e.prototype._getLights=function(t){return this._lights.getChild(t)},e}();t.LightManager=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){this._commonRenderTargetRendererList=wdCb.Collection.create(),this._proceduralRendererList=wdCb.Collection.create()}return t.create=function(){var t=new this;return t},t.prototype.init=function(){this._commonRenderTargetRendererList.forEach(function(t){return t.init()}),this._proceduralRendererList.forEach(function(t){return t.init()})},t.prototype.dispose=function(){this._commonRenderTargetRendererList.forEach(function(t){return t.dispose()}),this._proceduralRendererList.forEach(function(t){return t.dispose()})},t.prototype.addCommonRenderTargetRenderer=function(t){this._commonRenderTargetRendererList.addChild(t)},t.prototype.getCommonRenderTargetRendererList=function(){return this._commonRenderTargetRendererList},t.prototype.removeCommonRenderTargetRenderer=function(t){return this._commonRenderTargetRendererList.removeChild(t)},t.prototype.addProceduralRenderTargetRenderer=function(t){this._proceduralRendererList.addChild(t)},t.prototype.render=function(t,e){this._proceduralRendererList.filter(function(t){return t.needRender()}).forEach(function(e){e.render(t)}),this._commonRenderTargetRendererList.filter(function(t){return t.needRender()}).forEach(function(n){n.render(t,e)})},t}();t.RenderTargetRendererManager=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.dirty=!1,this._list=wdCb.Collection.create(),this._lastList=null}return e.create=function(){var t=new this;return t},e.prototype.init=function(){this._lastList=this._list.clone()},e.prototype.update=function(){this.dirty&&(t.EventManager.trigger(t.CustomEvent.create(t.EEngineEvent.SHADOWMAP_LAYER_CHANGE)),this.dirty=!1),this._lastList=this._list.clone()},e.prototype.getDiffData=function(){var t=this._lastList,e=this._list,n=null,r=null;return null===t?{addLayerList:this._list.clone(),removeLayerList:wdCb.Collection.create()}:(n=wdCb.Collection.create(),r=wdCb.Collection.create(),r=t.filter(function(t){return!e.hasChild(t)}),n=e.filter(function(e){return!t.hasChild(e)}),{addLayerList:n,removeLayerList:r})},e.prototype.getCount=function(){return this._list.getCount()},e.prototype.addChild=function(t){this._list.addChild(t),this.dirty=!0},e.prototype.addChildren=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];this._list.addChildren.apply(this._list,t),this.dirty=!0},e.prototype.removeChild=function(t){return this.dirty=!0,this._convertCollectionToThis(this._list.removeChild(t))},e.prototype.removeAllChildren=function(){this.dirty=!0,this._list.removeAllChildren()},e.prototype.removeRepeatItems=function(){var t=this._convertCollectionToThis(this._list.removeRepeatItems());return t.dirty=this.dirty,t},e.prototype.hasRepeatItems=function(){return this._list.hasRepeatItems()},e.prototype.forEach=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];this._list.forEach.apply(this._list,t)},e.prototype.getChildren=function(){return this._list.getChildren()},e.prototype.hasChild=function(t){return this._list.hasChild(t)},e.prototype._convertCollectionToThis=function(t){var n=e.create();return n.addChildren(t.getChildren()),n},e}();t.ShadowLayerList=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){this.listenerMap=wdCb.Hash.create()}return t.prototype.hasChild=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=t[0],r=t[1],i=this.listenerMap.getChild(this.buildKey(n,r));return i&&i.getCount()>0},t.prototype.hasChildWithFunc=function(t){return this.listenerMap.hasChildWithFunc(t)},t.prototype.appendChild=function(t,e,n){this.listenerMap.appendChild(this.buildKey(t,e),n)},t.prototype.filter=function(t){return this.listenerMap.filter(t)},t.prototype.forEach=function(t){return this.listenerMap.forEach(t)},t.prototype.getEventNameFromKey=function(t){var e=this.getEventSeparator();return t.indexOf(e)>-1?t.split(e)[1]:t},t.prototype.isEventName=function(t,e){return t.indexOf(""+this.getEventSeparator()+e)>-1||t===e},t}();t.EventListenerMap=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.getChild=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=this;if(1===e.length&&t.JudgeUtils.isString(e[0])){var i=e[0];return this.listenerMap.getChild(i)}if(1===e.length&&e[0]instanceof t.EntityObject){var o=e[0];return this.listenerMap.filter(function(t,e){return r.isTarget(e,o,t)})}if(2===e.length){var a=e[0],i=e[1];return this.listenerMap.getChild(this.buildKey(a,i))}},n.prototype.removeChild=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=this;if(1===e.length&&t.JudgeUtils.isString(e[0])){var i=e[0];this.listenerMap.removeChild(function(t,e){return r.isEventName(e,i)})}else if(1===e.length&&e[0]instanceof t.EntityObject){var o=e[0];this.listenerMap.removeChild(function(t,e){return r.isTarget(e,o,t)})}else if(2===e.length&&t.JudgeUtils.isString(e[0])){var a=e[0],s=e[1],c=null;this.listenerMap.hasChild(a)&&(c=this.listenerMap.getChild(a),wdCb.Collection.create().addChild(c.removeChild(function(t){return t.originHandler===s})),0===c.getCount()&&this.listenerMap.removeChild(a))}else if(2===e.length&&t.JudgeUtils.isNumber(e[0])){var u=e[0],a=e[1];this.listenerMap.removeChild(this.buildKey(u,a))}else if(2===e.length&&e[0]instanceof t.EntityObject){var l=e[0],a=e[1];this.listenerMap.removeChild(this.buildKey(l,a))}else if(3===e.length&&e[0]instanceof t.EntityObject){var a=e[1],h=e[2];this.listenerMap.forEach(function(t,e){return t.removeChild(function(t){return t.originHandler===h}),0===t.getCount()?wdCb.$REMOVE:void 0})}},n.prototype.getUidFromKey=function(t){var e=""+n.eventSeparator;return t.indexOf(e)>-1?Number(t.split(e)[0]):null},n.prototype.isTarget=function(t,e,n){return t.indexOf(this._buildKeyPrefix(e.uid))>-1&&void 0!==n},n.prototype.getEventSeparator=function(){return""+n.eventSeparator},n.prototype.buildKey=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(t.JudgeUtils.isNumber(e[0])){var r=e[0],i=e[1];return this._buildKeyWithUid(r,i)}if(e[0]instanceof t.EntityObject){var o=e[0],i=e[1];return this._buildKeyWithUid(o.uid,i)}if(null===e[0]){var i=e[1];return i}},n.prototype._buildKeyWithUid=function(t,e){return""+this._buildKeyPrefix(t)+n.eventSeparator+e},n.prototype._buildKeyPrefix=function(t){return""+String(t)},n.eventSeparator="@",n}(t.EventListenerMap);t.CustomEventListenerMap=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.getChild=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];if(1===t.length){var n=t[0];return this.listenerMap.getChild(n)}if(2===t.length){var r=t[0],n=t[1];return this.listenerMap.getChild(this.buildKey(r,n))}},n.prototype.removeChild=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=this,i=null;if(1===e.length&&t.JudgeUtils.isString(e[0])){var o=e[0];i=this._getEventDataOffDataList(o,this.listenerMap.removeChild(function(t,e){return r.isEventName(e,o)}))}else if(2===e.length&&t.JudgeUtils.isString(e[0])){var a=e[0],s=e[1],c=wdCb.Collection.create();this.listenerMap.forEach(function(t,e){if(r.isEventName(e,a)){var n=t.removeChild(function(t){return t.originHandler===s});if(n.getCount()>0&&c.addChild(n),0===t.getCount())return wdCb.$REMOVE}}),i=this._getEventDataOffDataList(a,c)}else if(2===e.length&&t.JudgeUtils.isDom(e[0])){var u=e[0],l=e[1];i=this._getEventDataOffDataList(l,this.listenerMap.removeChild(this.buildKey(u,l)))}else if(3===e.length&&t.JudgeUtils.isDom(e[0])){var l=e[1],h=wdCb.Collection.create(),d=e[2];this.listenerMap.forEach(function(t,e){var n=t.removeChild(function(t){return t.originHandler===d});return n.getCount()>0&&h.addChild(n),0===t.getCount()?wdCb.$REMOVE:void 0}),i=this._getEventDataOffDataList(l,h)}return i},n.prototype.isDom=function(t,e,n){return t.indexOf(this._buildKeyPrefix(e))>-1&&void 0!==n},n.prototype.getEventSeparator=function(){return""+n.eventSeparator},n.prototype.buildKey=function(t,e){return""+this._buildKeyPrefix(t)+n.eventSeparator+e},n.prototype._buildKeyPrefix=function(t){return t.id?""+t.tagName+t.id:""+t.tagName},n.prototype._getEventDataOffDataList=function(t,e){return e.map(function(e){return e.map(function(e){return{dom:e.dom,eventName:t,domHandler:e.domHandler}})})},n.eventSeparator="@",n}(t.EventListenerMap);t.DomEventListenerMap=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.MOUSE=0]="MOUSE",t[t.KEYBOARD=1]="KEYBOARD",t[t.CUSTOM=2]="CUSTOM"}(t.EEventType||(t.EEventType={}));t.EEventType}(wd||(wd={}));var wd;!function(t){var e;!function(t){t[t.FALLBACK="fallback"]="FALLBACK",t[t.FIREFOX="firefox"]="FIREFOX",t[t.CHROME="chrome"]="CHROME"}(e||(e={})),function(t){t[t.CLICK="click"]="CLICK",t[t.MOUSEOVER="mouseover"]="MOUSEOVER",t[t.MOUSEUP="mouseup"]="MOUSEUP",t[t.MOUSEOUT="mouseout"]="MOUSEOUT",t[t.MOUSEMOVE="mousemove"]="MOUSEMOVE",t[t.MOUSEDOWN="mousedown"]="MOUSEDOWN",t[t.MOUSEWHEEL="mousewheel|DOMMouseScroll*"+e.FIREFOX]="MOUSEWHEEL",t[t.MOUSEDRAG="mousedrag"]="MOUSEDRAG",t[t.KEYDOWN="keydown"]="KEYDOWN",t[t.KEYUP="keyup"]="KEYUP",t[t.KEYPRESS="keypress"]="KEYPRESS"}(t.EEventName||(t.EEventName={}));var n=(t.EEventName,"|"),r="*",i=function(){function t(){}return t.handleEventName=function(t){for(var e=t,r=null,i=[],o=null,a=0,s=e.split(n);a<s.length;a++){var c=s[a];this._isFallbackEventName(c)?r=c:i.push(c)}return o=this._getSpecifyBrowserEventName(i),null!==o?o:r},t._isFallbackEventName=function(t){return 1===t.split(r).length},t._getSpecifyBrowserEventName=function(t){for(var n=null,i=0,o=t;i<o.length;i++){var a=o[i],s=a.split(r),c=s[0],u=s[1];switch(u){case e.CHROME:bowser.chrome&&(n=c);break;case e.FIREFOX:bowser.firefox&&(n=c)}if(n)break}return n},t}();t.EventNameHandler=i}(wd||(wd={}));var wd;!function(t){!function(t){t[t.BROADCAST=0]="BROADCAST",t[t.EMIT=1]="EMIT"}(t.EEventPhase||(t.EEventPhase={}));t.EEventPhase}(wd||(wd={}));var wd;!function(t){var e=wdCb.Hash.create();e.addChild(t.EEventName.CLICK,t.EEventType.MOUSE),e.addChild(t.EEventName.MOUSEOVER,t.EEventType.MOUSE),e.addChild(t.EEventName.MOUSEOUT,t.EEventType.MOUSE),e.addChild(t.EEventName.MOUSEMOVE,t.EEventType.MOUSE),e.addChild(t.EEventName.MOUSEDOWN,t.EEventType.MOUSE),e.addChild(t.EEventName.MOUSEUP,t.EEventType.MOUSE),e.addChild(t.EEventName.MOUSEWHEEL,t.EEventType.MOUSE),e.addChild(t.EEventName.MOUSEDRAG,t.EEventType.MOUSE),e.addChild(t.EEventName.KEYDOWN,t.EEventType.KEYBOARD),e.addChild(t.EEventName.KEYPRESS,t.EEventType.KEYBOARD),e.addChild(t.EEventName.KEYUP,t.EEventType.KEYBOARD);var n=function(){function n(){}return n.getEventType=function(n){var r=e.getChild(n);return void 0===r&&(r=t.EEventType.CUSTOM),r},n}();t.EventTable=n}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t){this.p_type=null,this.name=null,this.currentTarget=null,this.isStopPropagation=!1,this.phase=null,this.name=t}return Object.defineProperty(e.prototype,"type",{get:function(){return t.Log.error(null===this.p_type,t.Log.info.ABSTRACT_ATTRIBUTE),this.p_type},enumerable:!0,configurable:!0}),e.prototype.stopPropagation=function(){this.isStopPropagation=!0},e.prototype.copyMember=function(t,e,n){return n.forEach(function(n){t[n]=e[n]}),t},e}();t.Event=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(t,n){e.call(this,n),this._event=null,this.event=t}return __extends(n,e),Object.defineProperty(n.prototype,"event",{get:function(){return this._event},set:function(e){this._event=e||t.root.event},enumerable:!0,configurable:!0}),n.prototype.preventDefault=function(){var t=this._event;bowser.msie&&Number(bowser.version)<=8?t.returnValue=!1:t.preventDefault()},n.prototype.getDataFromCustomEvent=function(t){this.target=t.target,this.currentTarget=t.currentTarget,this.isStopPropagation=t.isStopPropagation},n}(t.Event);t.DomEvent=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._location=null,this._locationInView=null,this._button=null,this.lastX=null,this.lastY=null,this.p_type=t.EEventType.MOUSE}return __extends(n,e),n.create=function(t,e){var n=new this(t,e);return n},Object.defineProperty(n.prototype,"location",{get:function(){var e=null,n=this.event;return this._location?this._location:(e=t.Point.create(),bowser.msie?(e.x=n.clientX+document.body.scrollLeft||document.documentElement.scrollLeft,e.y=n.clientY+document.body.scrollTop||document.documentElement.scrollTop):(e.x=n.pageX,e.y=n.pageY),e)},set:function(t){this._location=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"locationInView",{get:function(){var e=null,n=null;return this._locationInView?this._locationInView:(e=this.location,n=t.DeviceManager.getInstance().view.offset,t.Point.create(e.x-n.x,e.y-n.y))},set:function(t){this._locationInView=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"button",{get:function(){var e=this.event,n=null;if(this._button)return this._button;if(bowser.msie)switch(e.button){case 1:n=t.EMouseButton.LEFT;break;case 4:n=t.EMouseButton.RIGHT;break;case 2:n=t.EMouseButton.CENTER;break;default:t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("multi mouse button"))}else switch(e.button){case 0:n=t.EMouseButton.LEFT;break;case 1:n=t.EMouseButton.RIGHT;break;case 2:n=t.EMouseButton.CENTER;break;default:t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("multi mouse button"))}return n},set:function(t){this._button=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"wheel",{get:function(){var t=this.event;return t.detail?-1*t.detail:t.wheelDelta?t.wheelDelta/120:0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"movementDelta",{get:function(){var t=this.event,e=null,n=null;if(this._isPointerLocked())e=t.movementX||t.webkitMovementX||t.mozMovementX||0,n=t.movementY||t.webkitMovementY||t.mozMovementY||0;else{var r=this.location,i=this.lastX,o=this.lastY;null===i&&null===o?(e=0,n=0):(e=r.x-i,n=r.y-o)}return{x:e,y:n}},enumerable:!0,configurable:!0}),n.prototype.clone=function(){var t=n.create(this.event,this.name);return this.copyMember(t,this,["target","currentTarget","isStopPropagation","phase","lastX","lastY"])},n.prototype._isPointerLocked=function(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)},n}(t.DomEvent);t.MouseEvent=e}(wd||(wd={}));var wd;!function(t){var e={8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",61:"=",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},n={"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"},r=function(r){function i(){r.apply(this,arguments),this.p_type=t.EEventType.KEYBOARD,this.keyState=null}return __extends(i,r),i.create=function(t,e){var n=new this(t,e);return n},Object.defineProperty(i.prototype,"ctrlKey",{get:function(){return this.event.ctrlKey},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"altKey",{get:function(){return this.event.altKey},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"shiftKey",{get:function(){return this.event.shiftKey},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"metaKey",{get:function(){return this.event.metaKey},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"keyCode",{get:function(){return this.event.keyCode},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"key",{get:function(){var t=e[this.keyCode],r=null;return t?t:(r=String.fromCharCode(this.keyCode).toLowerCase(),this.shiftKey?n[r]:r)},enumerable:!0,configurable:!0}),i.prototype.clone=function(){var t=i.create(this.event,this.name);return this.copyMember(t,this,["target","currentTarget","isStopPropagation","phase","altKey","shiftKey","ctrlKey","metaKey","keyCode","key"])},i}(t.DomEvent);t.KeyboardEvent=r}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.userData=null,this.p_type=t.EEventType.CUSTOM}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.copyPublicAttri=function(e,n){return wdCb.ExtendUtils.extend(e,function(e,n){return"_"!==n.slice(0,1)&&!t.JudgeUtils.isFunction(e)}),e},n.prototype.clone=function(){var t=n.create(this.name);return this.copyMember(t,this,["target","currentTarget","isStopPropagation","phase"])},n.prototype.getDataFromDomEvent=function(t){this.target=t.target,this.currentTarget=t.currentTarget,this.isStopPropagation=t.isStopPropagation},n}(t.Event);t.CustomEvent=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.LEFT=0]="LEFT",t[t.RIGHT=1]="RIGHT",t[t.CENTER=2]="CENTER"}(t.EMouseButton||(t.EMouseButton={}));t.EMouseButton}(wd||(wd={}));var wd;!function(t){var e=function(){function t(t){this.eventType=null,this.priority=null,this.handlerDataList=wdCb.Collection.create(),this.eventType=t.eventType,this.priority=t.priority||1}return t.create=function(t){var e=new this(t);return e.initWhenCreate(t),e},t.prototype.initWhenCreate=function(t){this._setHandlerDataList(t)},t.prototype._setHandlerDataList=function(t){var e=null,n=/on\w+/;for(e in t)t.hasOwnProperty(e)&&n.test(e)&&this.handlerDataList.addChild({eventName:this._parseEventName(e),handler:t[e]})},t.prototype._parseEventName=function(t){return t.slice(2).toLowerCase()},t}();t.EventListener=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t}();t.EventHandler=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.prototype.off=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=this,i=t.DomEventRegister.getInstance(),o=null;o=i.remove.apply(i,e),o&&o.forEach(function(t){t.forEach(function(t){r._unBind(t.dom,t.eventName,t.domHandler)})})},n.prototype.trigger=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null,i=null,o=null,a=null;1===e.length?(i=e[0],r=this.getDefaultDom()):(r=e[0],i=e[1]),o=i.name,a=t.DomEventRegister.getInstance().getEventRegisterDataList(r,o),null!==a&&0!==a.getCount()&&a.forEach(function(t){var e=i.clone();t.handler(e,t.eventData)})},n.prototype.clearHandler=function(){},n.prototype.buildDomHandler=function(e,n){var r=this,i=t.root;return wdCb.EventUtils.bindEvent(i,function(t){r.triggerDomEvent(e,t,n)})},n.prototype.handler=function(e,n,r,i){var o=null,a=r;r=this.addEngineHandler(n,r),o=t.DomEventRegister.getInstance().isBinded(e,n)?t.DomEventRegister.getInstance().getDomHandler(e,n):this._bind(e,n),t.DomEventRegister.getInstance().register(e,n,this.createEventData(),r,a,o,i)},n.prototype._bind=function(e,n){var r=null;return r=this.buildDomHandler(e,n),wdCb.EventUtils.addEvent(e,t.EventNameHandler.handleEventName(n),r),r},n.prototype._unBind=function(e,n,r){wdCb.EventUtils.removeEvent(e,t.EventNameHandler.handleEventName(n),r)},__decorate([t.virtual],n.prototype,"clearHandler",null),n}(t.EventHandler);t.DomEventHandler=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.on=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=null,r=null,i=null,o=null;3===t.length?(n=this.getDefaultDom(),r=t[0],i=t[1],o=t[2]):(n=t[0],r=t[1],i=t[2],o=t[3]),this.handler(n,r,i,o)},n.prototype.getDefaultDom=function(){return document.body},n.prototype.triggerDomEvent=function(e,n,r){var i=this._createEventObject(e,n,r);t.EventManager.trigger(e,i)},n.prototype.addEngineHandler=function(e,n){var r=null;switch(e){case t.EEventName.MOUSEMOVE:r=this._handleMove(n);break;default:r=n}return r},n.prototype.createEventData=function(){var t=wdCb.Hash.create();return t.addChild("lastX",null),t.addChild("lastY",null),t},n.prototype._handleMove=function(t){var e=this;return function(n,r){e._copyEventDataToEventObject(n,r),t(n),e._saveLocation(n,r)}},n.prototype._createEventObject=function(e,n,r){var i=t.MouseEvent.create(n?n:t.root.event,r);return i.target=e,i},n.prototype._copyEventDataToEventObject=function(t,e){t.lastX=e.getChild("lastX"),t.lastY=e.getChild("lastY")},n.prototype._saveLocation=function(t,e){var n=t.location;e.addChild("lastX",n.x),e.addChild("lastY",n.y)},n._instance=null,__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(4===e.length){var r=e[0];t.assert(t.JudgeUtils.isDom(r),t.Log.info.FUNC_MUST_BE("first param","HTMLElement"))}})],n.prototype,"on",null),n}(t.DomEventHandler);t.MouseEventHandler=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.on=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null,i=null,o=null;3===e.length?(r=e[0],i=e[1],o=e[2]):(t.Log.warn("keyboard event can only bind on document.body"),r=e[1],i=e[2],o=e[3]),this.handler(this.getDefaultDom(),r,i,o)},n.prototype.triggerDomEvent=function(e,n,r){var i=this._createEventObject(e,n,r);t.EventManager.trigger(e,i)},n.prototype.getDefaultDom=function(){return document.body},n.prototype.addEngineHandler=function(e,n){var r=null;switch(e){case t.EEventName.KEYDOWN:r=this._handleKeyDown(n);break;case t.EEventName.KEYUP:r=this._handleKeyUp(n);break;default:r=n}return r},n.prototype.createEventData=function(){var t=wdCb.Hash.create();return t.addChild("keyState",{}),t},n.prototype._handleKeyDown=function(t){var e=this;return function(n,r){var i=r.getChild("keyState");e._setKeyStateAllFalse(i),i[n.key]=!0,e._copyEventDataToEventObject(n,r),t(n)}},n.prototype._handleKeyUp=function(t){var e=this;return function(n,r){e._setKeyStateAllFalse(r.getChild("keyState")),e._copyEventDataToEventObject(n,r),t(n)}},n.prototype._copyEventDataToEventObject=function(t,e){t.keyState=e.getChild("keyState")},n.prototype._setKeyStateAllFalse=function(t){for(var e in t)t.hasOwnProperty(e)&&(t[e]=!1)},n.prototype._createEventObject=function(e,n,r){var i=t.KeyboardEvent.create(n?n:t.root.event,r);return i.target=e,i},n._instance=null,n}(t.DomEventHandler);t.KeyboardEventHandler=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.on=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(3===e.length){var r=e[0],i=e[1],o=i,a=e[2];t.CustomEventRegister.getInstance().register(null,r,i,o,null,a)}else if(4===e.length){var s=e[0],r=e[1],i=e[2],o=i,a=e[3];t.CustomEventRegister.getInstance().register(s,r,i,o,null,a)}},n.prototype.off=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=t.CustomEventRegister.getInstance();r.remove.apply(r,e)},n.prototype.trigger=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=null;if(1===t.length||2===t.length){var r=null;return 1===t.length?n=t[0]:(n=t[0],r=t[1]),this._triggerEventHandler(n,r)}if(3===t.length||4===t.length){var i=null,r=null,o=null;return 3===t.length?(i=t[0],n=t[1],o=t[2]):(i=t[0],n=t[1],r=t[2],o=t[3]),this._triggerTargetAndEventHandler(i,n,r,o)}},n.prototype._triggerEventHandler=function(e,n){var r=null,i=this;return r=t.CustomEventRegister.getInstance().getEventRegisterDataList(e.name),null===r||0===r.getCount()?!1:(r.forEach(function(t){e.currentTarget=t.target,e.target=t.target,i._setUserData(e,n),t.handler(e)}),!0)},n.prototype._triggerTargetAndEventHandler=function(e,n,r,i){var o=null,a=!1,s=this;return i||(n.target=e),o=t.CustomEventRegister.getInstance().getEventRegisterDataList(e,n.name),null===o||0===o.getCount()?!1:(o.forEach(function(t){n.currentTarget=t.target,s._setUserData(n,r),t.handler(n),n.isStopPropagation&&(a=!0)}),a)},n.prototype._setUserData=function(t,e){e&&(t.userData=e)},n._instance=null,n}(t.EventHandler);t.CustomEventHandler=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t}();t.EventDispatcher=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.trigger=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=e.length;if(1===r){var i=e[0],o=i.type;return t.EventHandlerFactory.createEventHandler(o).trigger(i)}if(2===r&&t.EventUtils.isEvent(e[0])){var a=e[0],s=e[1],o=a.type;return t.EventHandlerFactory.createEventHandler(o).trigger(a,s)}if(2===r&&t.EventUtils.isEntityObject(e[0])||3===r&&t.JudgeUtils.isBoolean(e[2])){var c=e[0],u=e[1],l=void 0===e[2]?!1:e[2],o=u.type;return t.EventHandlerFactory.createEventHandler(o).trigger(c,u,l)}if(3===r||4===r){var c=e[0],h=e[1],s=e[2],l=void 0===e[3]?!1:e[3],o=h.type;return t.EventHandlerFactory.createEventHandler(o).trigger(c,h,s,l)}},n.prototype.emit=function(e,n,r){var i=!1;if(e){n.phase=t.EEventPhase.EMIT,n.target=e;do{if(i=this._triggerWithUserData(e,n,r,!0))break;e=e.bubbleParent}while(e)}},n.prototype.broadcast=function(e,n,r){var i=this,o=function(t){var e=t.getChildren();0!==e.getCount()&&e.forEach(function(t){i._triggerWithUserData(t,n,r,!0),o(t)})};e&&(n.phase=t.EEventPhase.BROADCAST,n.target=e,this._triggerWithUserData(e,n,r,!0),o(e))},n.prototype._triggerWithUserData=function(t,e,n,r){return n?this.trigger(t,e,n,r):this.trigger(t,e,r)},n._instance=null,n}(t.EventDispatcher);t.CustomEventDispatcher=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.trigger=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(1===e.length){var r=e[0],i=r.type;t.EventHandlerFactory.createEventHandler(i).trigger(r)}else if(2===e.length){var o=e[0],a=e[1],i=a.type;t.EventHandlerFactory.createEventHandler(i).trigger(o,a)}},n._instance=null,n}(t.EventDispatcher);t.DomEventDispatcher=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.listenerMap=t.ABSTRACT_ATTRIBUTE}return e.prototype.getEventRegisterDataList=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=this.listenerMap.getChild.apply(this.listenerMap,t);return n?n.sort(function(t,e){return e.priority-t.priority}):null},e.prototype.filter=function(t){return this.listenerMap.filter(t)},e.prototype.forEach=function(t){return this.listenerMap.forEach(t)},e.prototype.getChild=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];
return this.listenerMap.getChild.apply(this.listenerMap,Array.prototype.slice.call(arguments,0))},e.prototype.getEventNameFromKey=function(t){return this.listenerMap.getEventNameFromKey(t)},e}();t.EventRegister=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.listenerMap=t.CustomEventListenerMap.create()}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.register=function(t,e,n,r,i,o){this.listenerMap.appendChild(t,e,{target:t,eventName:e,handler:n,originHandler:r,domHandler:i,priority:o})},n.prototype.remove=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=e[0];if(1===e.length&&t.JudgeUtils.isString(e[0])){var i=e[0];this.listenerMap.removeChild(i)}else if(1===e.length&&e[0]instanceof t.EntityObject)this.listenerMap.removeChild(r),this._handleAfterAllEventHandlerRemoved(r);else if(2===e.length&&t.JudgeUtils.isFunction(e[1])){var i=e[0],o=e[1];this.listenerMap.removeChild(i,o)}else if(2===e.length&&t.JudgeUtils.isNumber(e[0])){var a=e[0],i=e[1];this.listenerMap.removeChild(a,i)}else(2===e.length&&e[0]instanceof t.EntityObject||3===e.length)&&(this.listenerMap.removeChild.apply(this.listenerMap,e),this._isAllEventHandlerRemoved(r)&&this._handleAfterAllEventHandlerRemoved(r))},n.prototype.setBubbleParent=function(t,e){t.bubbleParent=e},n.prototype.getUidFromKey=function(t){return this.listenerMap.getUidFromKey(t)},n.prototype.isTarget=function(t,e,n){return this.listenerMap.isTarget(t,e,n)},n.prototype._isAllEventHandlerRemoved=function(t){return!this.listenerMap.hasChildWithFunc(function(e,n){return n.indexOf(String(t.uid))>-1&&e&&e.getCount()>0})},n.prototype._handleAfterAllEventHandlerRemoved=function(t){this.setBubbleParent(t,null)},n._instance=null,n}(t.EventRegister);t.CustomEventRegister=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.listenerMap=t.DomEventListenerMap.create()}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.register=function(t,e,n,r,i,o,a){this.listenerMap.appendChild(t,e,{dom:t,eventName:e,eventData:n,handler:r,originHandler:i,domHandler:o,priority:a})},n.prototype.remove=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null;if(1===e.length&&t.JudgeUtils.isString(e[0])){var i=e[0];r=this.listenerMap.removeChild(i)}else if(2===e.length&&t.JudgeUtils.isFunction(e[1])){var i=e[0],o=e[1];r=this.listenerMap.removeChild(i,o)}else(2===e.length&&t.JudgeUtils.isDom(e[0])||3===e.length)&&(r=this.listenerMap.removeChild.apply(this.listenerMap,e));return r},n.prototype.isBinded=function(t,e){return this.listenerMap.hasChild(t,e)},n.prototype.isDom=function(t,e,n){return this.listenerMap.isDom(t,e,n)},n.prototype.getDomHandler=function(t,e){var n=this.getChild(t,e);return n&&n.getCount()>0?n.getChild(0).domHandler:void 0},n._instance=null,n}(t.EventRegister);t.DomEventRegister=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t}();t.EventBinder=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.on=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(2===e.length){var r=e[0],i=e[1];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(r)).on(r,i)}else if(3===e.length&&t.JudgeUtils.isString(e[0])){var r=e[0],i=e[1],o=e[2];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(r)).on(r,i,o)}else if(3===e.length&&e[0]instanceof t.EntityObject){var a=e[0],r=e[1],i=e[2];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(r)).on(a,r,i)}else if(4===e.length){var a=e[0],r=e[1],i=e[2],o=e[3];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(r)).on(a,r,i,o)}},n.prototype.off=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=t.CustomEventRegister.getInstance();if(0===e.length)r.forEach(function(e,n){var i=r.getEventNameFromKey(n),o=r.getUidFromKey(n);o?t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(i)).off(o,i):t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(i)).off(i)});else if(1===e.length&&t.JudgeUtils.isString(e[0])){var i=e[0];r.forEach(function(e,n){var o=r.getEventNameFromKey(n);o===i&&t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(i)).off(i)})}else if(1===e.length&&e[0]instanceof t.EntityObject){var o=e[0];r.forEach(function(e,n){var i=r.getEventNameFromKey(n);r.isTarget(n,o,e)&&t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(i)).off(o,i)})}else if(2===e.length&&t.JudgeUtils.isString(e[0])){var a=e[0],s=e[1];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(a)).off(a,s)}else if(2===e.length&&e[0]instanceof t.EntityObject){var c=e[0],a=e[1];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(a)).off(c,a)}else if(3===e.length&&e[0]instanceof t.EntityObject){var c=e[0],a=e[1],s=e[2];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(a)).off(c,a,s)}},n._instance=null,__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=function(e){t.assert(-1===e.indexOf(t.CustomEventListenerMap.eventSeparator),t.Log.info.FUNC_SHOULD_NOT("eventName","contain "+t.CustomEventListenerMap.eventSeparator))};if(1===e.length);else if(2===e.length){var i=e[0];r(i)}else if(3===e.length&&t.JudgeUtils.isString(e[0])){var i=e[0];r(i)}else if(3===e.length&&e[0]instanceof t.EntityObject){var i=e[1];r(i)}else if(4===e.length){var i=e[1];r(i)}})],n.prototype,"on",null),n}(t.EventBinder);t.CustomEventBinder=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.on=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(1===e.length){var r=e[0]instanceof t.EventListener?e[0]:t.EventListener.create(e[0]);r.handlerDataList.forEach(function(e){t.EventHandlerFactory.createEventHandler(r.eventType).on(e.eventName,e.handler,r.priority)})}else if(2===e.length&&t.JudgeUtils.isString(e[0])){var i=e[0],o=e[1];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(i)).on(i,o)}else if(2===e.length&&t.JudgeUtils.isDom(e[0])){var a=e[0],s=e[0]instanceof t.EventListener?e[0]:t.EventListener.create(e[0]);s.handlerDataList.forEach(function(e){t.EventHandlerFactory.createEventHandler(s.eventType).on(a,e.eventName,e.handler,s.priority)})}else if(3===e.length&&t.JudgeUtils.isString(e[0])){var i=e[0],o=e[1],c=e[2];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(i)).on(i,o,c)}else if(3===e.length&&t.JudgeUtils.isDom(e[0])){var u=e[0],i=e[1],o=e[2];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(i)).on(u,i,o)}else if(4===e.length){var u=e[0],i=e[1],o=e[2],c=e[3];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(i)).on(u,i,o,c)}},n.prototype.off=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=t.DomEventRegister.getInstance();if(0===e.length)r.forEach(function(e,n){var i=r.getEventNameFromKey(n);t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(i)).off(i)});else if(1===e.length&&t.JudgeUtils.isString(e[0])){var i=e[0];r.forEach(function(e,n){var o=r.getEventNameFromKey(n);o===i&&t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(i)).off(i)})}else if(1===e.length&&t.JudgeUtils.isDom(e[0])){var o=e[0];r.forEach(function(e,n){var i=r.getEventNameFromKey(n);r.isDom(n,o,e)&&t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(i)).off(o,i)})}else if(2===e.length&&t.JudgeUtils.isString(e[0])){var a=e[0],s=e[1];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(a)).off(a,s)}else if(2===e.length&&t.JudgeUtils.isDom(e[0])){var c=e[0],a=e[1];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(a)).off(c,a)}else if(3===e.length){var c=e[0],a=e[1],s=e[2];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(a)).off(c,a,s)}},n._instance=null,__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=function(e){t.assert(-1===e.indexOf(t.DomEventListenerMap.eventSeparator),t.Log.info.FUNC_SHOULD_NOT("eventName","contain "+t.DomEventListenerMap.eventSeparator))};if(1===e.length);else if(2===e.length);else if(3===e.length&&t.JudgeUtils.isString(e[0])){var i=e[0];r(i)}else if(3===e.length&&t.JudgeUtils.isDom(e[0])){var i=e[1];r(i)}else if(4===e.length){var i=e[1];r(i)}})],n.prototype,"on",null),n}(t.EventBinder);t.DomEventBinder=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.createEventHandler=function(e){var n=null;switch(e){case t.EEventType.MOUSE:n=t.MouseEventHandler.getInstance();break;case t.EEventType.KEYBOARD:n=t.KeyboardEventHandler.getInstance();break;case t.EEventType.CUSTOM:n=t.CustomEventHandler.getInstance();break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("eventType"))}return n},e}();t.EventHandlerFactory=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.createEventBinder=function(e){var n=null,r=t.EventTable.getEventType(e);switch(r){case t.EEventType.MOUSE:case t.EEventType.KEYBOARD:n=t.DomEventBinder.getInstance();break;case t.EEventType.CUSTOM:n=t.CustomEventBinder.getInstance();break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("eventName:"+e))}return n},e}();t.EventBinderFactory=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.createEventDispatcher=function(e){var n=null,r=e.type;switch(r){case t.EEventType.MOUSE:case t.EEventType.KEYBOARD:n=t.DomEventDispatcher.getInstance();break;case t.EEventType.CUSTOM:n=t.CustomEventDispatcher.getInstance();break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("event:"+e))}return n},e}();t.EventDispatcherFactory=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.isEvent=function(t){return t&&void 0!==t.currentTarget},e.isEntityObject=function(t){return t&&void 0!==t.bubbleParent},__decorate([t.ensure(function(e,n){e&&t.assert(n instanceof t.EntityObject,t.Log.info.FUNC_MUST_BE("EntityObject, but actual is "+n))})],e,"isEntityObject",null),e}();t.EventUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.on=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(1===e.length){var r=e[0],i=t.DomEventBinder.getInstance();i.on(r)}else if(2===e.length&&t.JudgeUtils.isString(e[0])){var o=e[0],a=e[1],s=1,i=t.EventBinderFactory.createEventBinder(o);i.on(o,a,s)}else if(2===e.length&&t.JudgeUtils.isDom(e[0])){var c=e[0],r=e[1],i=t.DomEventBinder.getInstance();i.on(c,r)}else if(3===e.length&&t.JudgeUtils.isString(e[0])){var o=e[0],a=e[1],s=e[2],i=t.EventBinderFactory.createEventBinder(o);i.on(o,a,s)}else if(3===e.length&&e[0]instanceof t.EntityObject){var u=e[0],o=e[1],a=e[2],s=1,i=t.CustomEventBinder.getInstance();i.on(u,o,a,s)}else if(3===e.length&&t.JudgeUtils.isDom(e[0])){var c=e[0],o=e[1],a=e[2],s=1,i=t.DomEventBinder.getInstance();i.on(c,o,a,s)}else if(4===e.length&&e[0]instanceof t.EntityObject){var u=e[0],o=e[1],a=e[2],s=e[3],i=t.CustomEventBinder.getInstance();i.on(u,o,a,s)}else if(4===e.length&&t.JudgeUtils.isDom(e[0])){var c=e[0],o=e[1],a=e[2],s=e[3],i=t.DomEventBinder.getInstance();i.on(c,o,a,s)}},e.off=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(0===e.length){var r=t.CustomEventBinder.getInstance(),i=t.DomEventBinder.getInstance();r.off(),i.off()}else if(1===e.length&&t.JudgeUtils.isString(e[0])){var o=e[0],a=t.EventBinderFactory.createEventBinder(o);a.off(o)}else if(1===e.length&&e[0]instanceof t.EntityObject){var o=e[0],a=t.CustomEventBinder.getInstance();a.off(o)}else if(1===e.length&&t.JudgeUtils.isDom(e[0])){var o=e[0],a=t.DomEventBinder.getInstance();a.off(o)}else if(2===e.length&&t.JudgeUtils.isString(e[0])){var o=e[0],s=e[1],a=t.EventBinderFactory.createEventBinder(o);a.off(o,s)}else if(2===e.length&&e[0]instanceof t.EntityObject){var c=e[0],o=e[1],a=t.CustomEventBinder.getInstance();a.off(c,o)}else if(2===e.length&&t.JudgeUtils.isDom(e[0])){var u=e[0],o=e[1],a=t.DomEventBinder.getInstance();a.off(u,o)}else if(3===e.length&&e[0]instanceof t.EntityObject){var c=e[0],o=e[1],s=e[2],a=t.CustomEventBinder.getInstance();a.off(c,o,s)}else if(3===e.length&&t.JudgeUtils.isDom(e[0])){var u=e[0],o=e[1],s=e[2],a=t.DomEventBinder.getInstance();a.off(u,o,s)}},e.trigger=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=e.length;if(1===r){var i=e[0],o=t.EventDispatcherFactory.createEventDispatcher(i);o.trigger(i)}else if(2===r&&t.EventUtils.isEvent(e[0])){var a=e[0],s=e[1],o=t.CustomEventDispatcher.getInstance();o.trigger(a,s)}else if(2===r&&t.EventUtils.isEntityObject(e[0])){var c=e[0],u=e[1],o=t.CustomEventDispatcher.getInstance();if(!c)return;o.trigger(c,u)}else if(2===r){var l=e[0],h=e[1],o=t.DomEventDispatcher.getInstance();if(!l)return;o.trigger(l,h)}else if(3===r){var c=e[0],d=e[1],s=e[2],o=t.CustomEventDispatcher.getInstance();if(!c)return;o.trigger(c,d,s)}else if(4===r){var c=e[0],p=e[1],s=e[2],f=e[3],o=t.CustomEventDispatcher.getInstance();if(!c)return;o.trigger(c,p,s,f)}},e.broadcast=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=t.CustomEventDispatcher.getInstance();r.broadcast.apply(r,e)},e.emit=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=t.CustomEventDispatcher.getInstance();r.emit.apply(r,e)},e.fromEvent=function(){for(var n=[],r=0;r<arguments.length;r++)n[r-0]=arguments[r];var i=null,o=null;if(1===n.length){var a=n[0];i=function(t){e.on(a,t)},o=function(t){e.off(a,t)}}else if(2===n.length&&t.JudgeUtils.isNumber(n[1])){var s=n[0],c=n[1];i=function(t){e.on(s,t,c)},o=function(t){e.off(s,t)}}else if(2===n.length){var u=n[1];i=function(t){e.on(n[0],u,t)},o=function(t){e.off(n[0],u,t)}}else if(3===n.length){var l=n[1],h=n[2];i=function(t){e.on(n[0],l,t,h)},o=function(t){e.off(n[0],l,t)}}return wdFrp.fromEventPattern(i,o)},e.setBubbleParent=function(e,n){t.CustomEventRegister.getInstance().setBubbleParent(e,n)},__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(e[0]instanceof t.EntityObject){var r=e[1];t.assert(t.EventTable.getEventType(r)===t.EEventType.CUSTOM,t.Log.info.FUNC_MUST_BE("event","custom event"))}else if(t.JudgeUtils.isDom(e[0])){var r=e[1],i=t.EventTable.getEventType(r);t.assert(i===t.EEventType.MOUSE||i===t.EEventType.KEYBOARD,t.Log.info.FUNC_MUST_BE("event","dom event"))}})],e,"on",null),__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(e.length>2&&e[0]instanceof t.EntityObject){var r=e[1];t.assert(t.EventTable.getEventType(r)===t.EEventType.CUSTOM,t.Log.info.FUNC_MUST_BE("event","custom event"))}else if(e.length>2&&t.JudgeUtils.isDom(e[0])){var r=e[1],i=t.EventTable.getEventType(r);t.assert(i===t.EEventType.MOUSE||i===t.EEventType.KEYBOARD,t.Log.info.FUNC_MUST_BE("event","dom event"))}})],e,"off",null),__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(2===e.length&&e[0]instanceof t.Event){var r=e[0];t.assert(r instanceof t.CustomEvent,t.Log.info.FUNC_MUST_BE("event type","CUSTOM"))}else if(2===e.length&&e[0]instanceof t.EntityObject);else if(2===e.length)e[0]&&t.assert(t.JudgeUtils.isDom(e[0]),t.Log.info.FUNC_MUST_BE("the first param","dom"));else if(e[0]instanceof t.EntityObject){var i=e[1];t.assert(i instanceof t.CustomEvent,t.Log.info.FUNC_MUST_BE("event type","CUSTOM"))}})],e,"trigger",null),__decorate([t.require(function(e,n,r){t.assert(n instanceof t.CustomEvent,t.Log.info.FUNC_MUST_BE("eventObject","CustomEvent"))})],e,"broadcast",null),__decorate([t.require(function(e,n,r){t.assert(n instanceof t.CustomEvent,t.Log.info.FUNC_MUST_BE("eventObject","CustomEvent"))})],e,"emit",null),__decorate([t.require(function(e,n){t.assert(e instanceof t.EntityObject,"only EntityObject can setBubleParent")})],e,"setBubbleParent",null),e}();t.EventManager=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.STARTLOOP="wd_startLoop"]="STARTLOOP",t[t.ENDLOOP="wd_endLoop"]="ENDLOOP",t[t.MOUSE_CLICK="wd_mouseclick"]="MOUSE_CLICK",t[t.MOUSE_DOWN="wd_mousedown"]="MOUSE_DOWN",t[t.MOUSE_UP="wd_mouseup"]="MOUSE_UP",t[t.MOUSE_MOVE="wd_mousemove"]="MOUSE_MOVE",t[t.MOUSE_OVER="wd_mouseover"]="MOUSE_OVER",t[t.MOUSE_OUT="wd_mouseout"]="MOUSE_OUT",t[t.MOUSE_WHEEL="wd_mousewheel"]="MOUSE_WHEEL",t[t.MOUSE_DRAG="wd_mousedrag"]="MOUSE_DRAG",t[t.MATERIAL_CHANGE="wd_material_change"]="MATERIAL_CHANGE",t[t.MATERIAL_COLOR_CHANGE="wd_material_color_change"]="MATERIAL_COLOR_CHANGE",t[t.UI_WIDTH_CHANGE="wd_ui_width_change"]="UI_WIDTH_CHANGE",t[t.UI_HEIGHT_CHANGE="wd_ui_height_change"]="UI_HEIGHT_CHANGE",t[t.TRANSFORM_TRANSLATE="wd_transform_translate"]="TRANSFORM_TRANSLATE",t[t.TRANSFORM_ROTATE="wd_transform_rotate"]="TRANSFORM_ROTATE",t[t.TRANSFORM_SCALE="wd_transform_scale"]="TRANSFORM_SCALE",t[t.SHADOWMAP_SOFTTYPE_CHANGE="wd_shadowMap_softType_change"]="SHADOWMAP_SOFTTYPE_CHANGE",t[t.SHADOWMAP_LAYER_CHANGE="wd_shadowMap_layer_change"]="SHADOWMAP_LAYER_CHANGE",t[t.COMPONENT_CHANGE="wd_component_change"]="COMPONENT_CHANGE",t[t.UNUSE_SCENE_SHADER="wd_unUse_scene_shader"]="UNUSE_SCENE_SHADER",t[t.EXIT="wd_exit"]="EXIT",t[t.ENTER="wd_enter"]="ENTER"}(t.EEngineEvent||(t.EEngineEvent={}));t.EEngineEvent}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.getOrder=function(e){return e instanceof t.SourceInstance?1:e instanceof t.Shadow?2:e instanceof t.Geometry?3:4},e}();t.ComponentInitOrderTable=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.activeGeometry=null,this.levelList=wdCb.Collection.create(),this._originGeometry=null}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.init=function(){var n=this.entityObject;this.activeGeometry=n.getComponent(t.Geometry),this._originGeometry=this.activeGeometry,this.levelList.filter(function(t){var e=t.geometry;t.distanceBetweenCameraAndObject;return!!e}).forEach(function(t){var e=t.geometry;t.distanceBetweenCameraAndObject;e.entityObject=n,e.init(),e.createBuffersFromGeometryData()}),e.prototype.init.call(this)},n.prototype.addToObject=function(n,r){void 0===r&&(r=!1);var i=t.LODEngine.getInstance();e.prototype.addToObject.call(this,n,r),i.hasChild(this)||i.addChild(this)},n.prototype.removeFromObject=function(n){e.prototype.removeFromObject.call(this,n),t.LODEngine.getInstance().removeChild(this)},n.prototype.addGeometryLevel=function(t,e){this.levelList.addChild({distanceBetweenCameraAndObject:t,geometry:e}),this.levelList.sort(function(t,e){return e.distanceBetweenCameraAndObject-t.distanceBetweenCameraAndObject},!0)},n.prototype.update=function(e){var n=t.Vector3.create().sub2(t.Director.getInstance().scene.currentCamera.transform.position,this.entityObject.transform.position).length(),r=!0,i=null;return this.levelList.forEach(function(t){var e=t.geometry,o=t.distanceBetweenCameraAndObject;return n>=o?(i=e,r=!1,wdCb.$BREAK):void 0}),i===t.ELODGeometryState.INVISIBLE?(this.activeGeometry=null,void(this.entityObject.isVisible=!1)):(this.entityObject.isVisible=!0,void(i&&!t.JudgeUtils.isEqual(i,this.activeGeometry)?(this.activeGeometry=i,t.EventManager.trigger(this.entityObject,t.CustomEvent.create(t.EEngineEvent.COMPONENT_CHANGE))):r&&(this.activeGeometry=this._originGeometry)))},__decorate([t.cloneAttributeAsCustomType(function(e,n,r,i){e.levelList.forEach(function(e){var r=null;r=e.geometry===t.ELODGeometryState.INVISIBLE?t.ELODGeometryState.INVISIBLE:i?e.geometry:e.geometry.clone(),n.addGeometryLevel(e.distanceBetweenCameraAndObject,r)})})],n.prototype,"levelList",void 0),__decorate([t.require(function(){t.InstanceUtils.isHardwareSupport()&&t.assert(!t.InstanceUtils.isObjectInstance(this.entityObject),t.Log.info.FUNC_SHOULD_NOT("if hardware support instance, object instance","add lod component"))})],n.prototype,"update",null),n}(t.Component);t.LOD=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.INVISIBLE=0]="INVISIBLE"}(t.ELODGeometryState||(t.ELODGeometryState={}));t.ELODGeometryState}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.prototype.addToObject=function(t,n){void 0===n&&(n=!1),e.prototype.addToObject.call(this,t,n)},n.prototype.clone=function(){return t.CloneUtils.clone(this)},__decorate([t.require(function(e){t.assert(e instanceof t.GameObject,t.Log.info.FUNC_SHOULD("Instance component","add to GameObject"))})],n.prototype,"addToObject",null),n}(t.Component);t.Instance=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._instanceBuffer=null,this.instanceList=wdCb.Collection.create(),this._toRenderInstanceList=wdCb.Collection.create(),this._endLoopSubscription=null,this._isAddSourceInstanceToChildren=!1,this._enterSubscription=null,this._exitSubscription=null}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"toRenderInstanceListForDraw",{get:function(){return this.hasToRenderInstance()||(this._toRenderInstanceList=this.defaultToRenderInstanceList),this._toRenderInstanceList},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"defaultToRenderInstanceList",{get:function(){return wdCb.Collection.create().addChild(this.entityObject).addChildren(this.instanceList)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"instanceBuffer",{get:function(){return null===this._instanceBuffer&&(this._instanceBuffer=t.InstanceBuffer.create()),this._instanceBuffer},enumerable:!0,configurable:!0}),n.prototype.init=function(){var e=this;this._isAddSourceInstanceToChildren||this._addSourceInstanceToChildren(),this._endLoopSubscription=t.EventManager.fromEvent(t.EEngineEvent.ENDLOOP).subscribe(function(){e._toRenderInstanceList.removeAllChildren()}),this._enterSubscription=t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.ENTER).subscribe(function(){e._addAllInstances()}),this._exitSubscription=t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.EXIT).subscribe(function(){e._removeAllInstances()})},n.prototype.dispose=function(){this._endLoopSubscription.dispose(),this._enterSubscription.dispose(),this._exitSubscription.dispose(),this.instanceList.forEach(function(t){t.dispose()})},n.prototype.cloneInstance=function(e){var r=this,i=this,o=function(e,a){var s=t.GameObject.create(),c=t.ObjectInstance.create(),u=null;return u=a.getComponent(n).instanceList,s.name=e,r._addComponentsFromSourceToObject(a,s),c.sourceObject=a,s.addComponent(c),s.bubbleParent=a.bubbleParent,s.parent=a.parent,s.isVisible=a.isVisible,a.getTagList().forEach(function(t){s.addTag(t)}),u.addChild(s),a.forEach(function(t){s.addChild(o(i._buildInstanceChildName(e,t.name),t))}),s};return this._addSourceInstanceToChildren(),this._isAddSourceInstanceToChildren=!0,o(e,this.entityObject)},n.prototype.hasToRenderInstance=function(){return this._toRenderInstanceList&&this._toRenderInstanceList.getCount()>0},n.prototype.addToRenderIntance=function(t){this._toRenderInstanceList.addChild(t)},n.prototype.forEachToRenderInstanceList=function(t){this._toRenderInstanceList.forEach(t)},n.prototype._addComponentsFromSourceToObject=function(e,r){r.removeComponent(t.Transform),e.forEachComponent(function(e){e instanceof n||e instanceof t.LOD||(e instanceof t.Geometry||e instanceof t.Script?r.addComponent(e,!0):r.addComponent(e.clone()))})},n.prototype._addSourceInstanceToChildren=function(){var e=function(r){if(!t.InstanceUtils.isSourceInstance(r)){var i=n.create();r.hasComponent(n)||r.addComponent(i),r.forEach(function(t){e(t)})}};this.entityObject.forEach(function(t){e(t)})},n.prototype._addAllInstances=function(){var e=this.entityObject.parent,n=t.EInstanceTag.isAddSourceInstance;this.instanceList.forEach(function(t){t.addTag(n),e.addChild(t),t.removeTag(n)})},n.prototype._removeAllInstances=function(){var e=t.EInstanceTag.isRemoveSourceInstance;this.instanceList.forEach(function(t){t.addTag(e),t.parent.removeChild(t),t.removeTag(e)})},n.prototype._buildInstanceChildName=function(t,e){return t+"_"+e},__decorate([t.ensureGetter(function(e){var n=this;t.assert(e.getCount()>0,t.Log.info.FUNC_SHOULD("contain one at least")),e.forEach(function(e){t.assert(t.JudgeUtils.isEqual(e,n.entityObject)||n.instanceList.hasChild(e),t.Log.info.FUNC_SHOULD("render self entityObject or the entityObject in instanceList"))}),t.assert(!e.hasRepeatItems(),t.Log.info.FUNC_SHOULD_NOT("has repeat instance which is to render"))})],n.prototype,"toRenderInstanceListForDraw",null),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"instanceList",void 0),__decorate([t.ensure(function(){this.entityObject.forEach(function(e){t.IterateUtils.forEachAll(e,function(e){t.assert(t.InstanceUtils.isSourceInstance(e),t.Log.info.FUNC_SHOULD("children","contain SourceInstance component"))})})})],n.prototype,"init",null),__decorate([t.require(function(){var e=this,n=function(){var n=null,r=null,i=!0;0!==e.instanceList.getCount()&&(n=t.Director.getInstance().scene,r=wdCb.Collection.create(),t.IterateUtils.forEachAll(n.gameObjectScene,function(t){r.addChild(t)}),e.instanceList.forEach(function(t){return r.hasChild(t)?void 0:(i=!1,wdCb.$BREAK)}),t.assert(i,t.Log.info.FUNC_SHOULD("instance","not only in instanceList, but also in the main loop")))};n()})],n.prototype,"dispose",null),__decorate([t.require(function(){var e=this.entityObject;t.assert(!e.getSpacePartition(),t.Log.info.FUNC_NOT_SUPPORT("space partition","instance"))}),t.ensure(function(e){t.assert(t.InstanceUtils.isObjectInstance(e))})],n.prototype,"cloneInstance",null),__decorate([t.ensure(function(e,n,r){t.assert(r.hasComponent(t.ThreeDTransform),t.Log.info.FUNC_SHOULD("instance","contain ThreeDTransform component"))})],n.prototype,"_addComponentsFromSourceToObject",null),__decorate([t.ensure(function(){t.IterateUtils.forEachAll(this.entityObject,function(e){t.assert(1===e.getComponents().filter(function(t){return t instanceof n}).getCount(),t.Log.info.FUNC_SHOULD("children","contain only one SourceInstance component"))})})],n.prototype,"_addSourceInstanceToChildren",null),__decorate([t.ensure(function(){this.instanceList.forEach(function(e){t.assert(!e.hasTag(t.EInstanceTag.isAddSourceInstance),t.Log.info.FUNC_SHOULD_NOT("instance","add EInstanceTag.isAddSourceInstance tag here"))})})],n.prototype,"_addAllInstances",null),__decorate([t.ensure(function(){this.instanceList.forEach(function(e){t.assert(!e.hasTag(t.EInstanceTag.isRemoveSourceInstance),t.Log.info.FUNC_SHOULD_NOT("instance","add EInstanceTag.isRemoveSourceInstance tag here"))})})],n.prototype,"_removeAllInstances",null),n}(t.Instance);t.SourceInstance=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.sourceObject=null,this._enterSubscription=null,this._exitSubscription=null}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.init=function(){var e=this,n=this.entityObject;this._enterSubscription=t.EventManager.fromEvent(n,t.EEngineEvent.ENTER).subscribe(function(){n.hasTag(t.EInstanceTag.isAddSourceInstance)||e._addToSourceAndItsChildren()}),this._exitSubscription=t.EventManager.fromEvent(n,t.EEngineEvent.EXIT).subscribe(function(){n.hasTag(t.EInstanceTag.isRemoveSourceInstance)||e._removeFromSourceAndItsChildren()})},n.prototype.dispose=function(){this._enterSubscription.dispose(),this._exitSubscription.dispose(),this._removeFromSourceAndItsChildren()},n.prototype._addToSourceAndItsChildren=function(){var e=function(n,r){n.getComponent(t.SourceInstance).instanceList.addChild(r),r.forEach(function(t,r){e(n.getChild(r),t)})};e(this.sourceObject,this.entityObject)},n.prototype._removeFromSourceAndItsChildren=function(){var e=function(n,r){n.getComponent(t.SourceInstance).instanceList.removeChild(r),r.forEach(function(t,r){e(n.getChild(r),t)})};e(this.sourceObject,this.entityObject)},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"sourceObject",void 0),n}(t.Instance);t.ObjectInstance=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.isRemoveSourceInstance="isRemoveSourceInstance"]="isRemoveSourceInstance",t[t.isAddSourceInstance="isAddSourceInstance"]="isAddSourceInstance"}(t.EInstanceTag||(t.EInstanceTag={}));t.EInstanceTag}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.prototype.clone=function(){return t.CloneUtils.clone(this)},n}(t.Component);t.EventTriggerDetector=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.isTrigger=function(e){var n=this.entityObject.transform,r=n.width,i=n.height,o=n.position,a=e.locationInView,s=null;return s=t.Vector2.create(o.x-r/2,o.y-i/2),t.EventTriggerDetectorUtils.isInRect(a,s,r,i)},n}(t.EventTriggerDetector);t.UIEventTriggerDetector=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.isTrigger=function(e){var n=t.Director.getInstance().scene,r=n.currentCamera.getComponent(t.CameraController),i=e.locationInView;return r.isIntersectWithRay(this.entityObject,i.x,i.y)},n}(t.EventTriggerDetector);t.RayCasterEventTriggerDetector=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.isTrigger=function(e){var n=t.DeviceManager.getInstance().view,r=n.width,i=n.height,o=e.locationInView,a=t.Vector2.create(0,0);return t.EventTriggerDetectorUtils.isInRect(o,a,r,i)},n}(t.EventTriggerDetector);t.SceneEventTriggerDetector=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t.isInRect=function(t,e,n,r){return t.x>=e.x&&t.x<=e.x+n&&t.y>=e.y&&t.y<=e.y+r},t}();t.EventTriggerDetectorUtils=e}(wd||(wd={}));var wd;!function(t){var e=wdCb.Hash.create(),n=wdCb.Hash.create();e.addChild(t.EEventName.CLICK,"onMouseClick"),e.addChild(t.EEventName.MOUSEOVER,"onMouseOver"),e.addChild(t.EEventName.MOUSEOUT,"onMouseOut"),e.addChild(t.EEventName.MOUSEMOVE,"onMouseMove"),e.addChild(t.EEventName.MOUSEDOWN,"onMouseDown"),e.addChild(t.EEventName.MOUSEUP,"onMouseUp"),e.addChild(t.EEventName.MOUSEWHEEL,"onMouseWheel"),e.addChild(t.EEventName.MOUSEDRAG,"onMouseDrag"),n.addChild(t.EEventName.CLICK,"MOUSE_CLICK"),n.addChild(t.EEventName.MOUSEDOWN,"MOUSE_DOWN"),n.addChild(t.EEventName.MOUSEUP,"MOUSE_UP"),n.addChild(t.EEventName.MOUSEMOVE,"MOUSE_MOVE"),n.addChild(t.EEventName.MOUSEOVER,"MOUSE_OVER"),n.addChild(t.EEventName.MOUSEOUT,"MOUSE_OUT"),n.addChild(t.EEventName.MOUSEWHEEL,"MOUSE_WHEEL"),n.addChild(t.EEventName.MOUSEDRAG,"MOUSE_DRAG");var r=function(){function t(){}return t.getScriptHandlerName=function(t){var n=e.getChild(t);return n},t.getScriptEngineEvent=function(t){var e=n.getChild(t);return e},t}();t.EventTriggerTable=r}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(t){void 0===t&&(t=null),e.call(this),this.url=null,this._subscription=null,this.url=t}return __extends(n,e),n.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];if(0===t.length)return new this;if(1===t.length){var n=t[0];return new this(n)}},n.addScript=function(t,e){this.scriptList.push({name:t,"class":e})},n.prototype.dispose=function(){this._subscription.dispose()},n.prototype.createLoadJsStream=function(){return t.Log.error(!this.url,t.Log.info.FUNC_MUST_DEFINE("url")),t.LoaderManager.getInstance().load(this.url).map(function(){return n.scriptList.pop();
})},n.prototype.addToObject=function(n,r){void 0===r&&(r=!1),e.prototype.addToObject.call(this,n,r),this._subscription=this.createLoadJsStream().subscribe(function(e){t.GlobalScriptUtils.addScriptToEntityObject(n,e),t.GlobalScriptUtils.handlerAfterLoadedScript(n)})},n.scriptList=wdCb.Stack.create(),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"url",void 0),n}(t.Component);t.Script=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.p_parent=null,this._isTranslate=!1,this._isRotate=!1,this._isScale=!1,this.dirtyLocal=!0,this.children=wdCb.Collection.create(),this._endLoopSubscription=null}return __extends(n,e),Object.defineProperty(n.prototype,"parent",{get:function(){return this.p_parent},set:function(t){this.setParent(t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isTransform",{get:function(){return this.isTranslate||this.isRotate||this.isScale},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isTranslate",{get:function(){return this._isTranslate},set:function(e){this._setGlobalTransformState(t.ETransformState.ISTRANSLATE,e)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isRotate",{get:function(){return this._isRotate},set:function(e){this._setGlobalTransformState(t.ETransformState.ISROTATE,e)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isScale",{get:function(){return this._isScale},set:function(e){this._setGlobalTransformState(t.ETransformState.ISSCALE,e)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isLocalTranslate",{set:function(e){this._setLocalTransformState(t.ETransformState.ISLOCALTRANSLATE,e)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isLocalRotate",{set:function(e){this._setLocalTransformState(t.ETransformState.ISLOCALROTATE,e)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isLocalScale",{set:function(e){this._setLocalTransformState(t.ETransformState.ISLOCALSCALE,e)},enumerable:!0,configurable:!0}),n.prototype.init=function(){var e=this;this._endLoopSubscription=t.EventManager.fromEvent(t.EEngineEvent.ENDLOOP).subscribe(function(){e._resetTransformFlag()})},n.prototype.dispose=function(){e.prototype.dispose.call(this),this._endLoopSubscription&&this._endLoopSubscription.dispose()},n.prototype.addChild=function(t){this.children.addChild(t)},n.prototype.removeChild=function(t){this.children.removeChild(t)},n.prototype.setChildrenTransformState=function(t,e){e&&this.children.forEach(function(e){e[t]=!0})},n.prototype.handleWhenSetTransformState=function(t){},n.prototype.setParent=function(t){return this.p_parent&&this.p_parent.removeChild(this),t?(this.p_parent=t,void this.p_parent.addChild(this)):void(this.p_parent=null)},n.prototype.getMatrix=function(t,e){var n=wdCb.Collection.create(),r=this.p_parent;for(n.addChild(this);null!==r;)n.addChild(r),r=r.parent;return n.reverse().forEach(function(e){e[t]()}),this[e]},n.prototype._setGlobalTransformState=function(t,e){this["_"+t]=e,e&&(this.dirtyLocal=!0,this.clearCache(),this.handleWhenSetTransformState(t)),e&&this.setChildrenTransformState(t,e)},n.prototype._setLocalTransformState=function(t,e){e&&(this.dirtyLocal=!0,this.clearCache()),e&&this.setChildrenTransformState(t,e)},n.prototype._resetTransformFlag=function(){this.isTranslate=!1,this.isScale=!1,this.isRotate=!1},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"parent",null),__decorate([t.virtual],n.prototype,"handleWhenSetTransformState",null),n}(t.Component);t.Transform=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._localToWorldMatrix=null,this._position=t.Vector3.create(),this._rotation=t.Quaternion.create(0,0,0,1),this._scale=t.Vector3.create(1,1,1),this._eulerAngles=null,this._localPosition=t.Vector3.create(0,0,0),this._localRotation=t.Quaternion.create(0,0,0,1),this._localEulerAngles=null,this._localScale=t.Vector3.create(1,1,1),this.dirtyWorld=null,this._localToParentMatrix=t.Matrix4.create(),this._localToWorldMatrixCache=null,this._positionCache=null,this._rotationCache=null,this._scaleCache=null,this._eulerAnglesCache=null,this._localEulerAnglesCache=null,this._normalMatrixCache=null}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"localToWorldMatrix",{get:function(){return this.getMatrix("sync","_localToWorldMatrix")},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"normalMatrix",{get:function(){return this.localToWorldMatrix.invertTo3x3().transpose()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"position",{get:function(){return this._position=this.localToWorldMatrix.getTranslation(),this._position},set:function(t){null===this.p_parent?this._localPosition=t:this._localPosition=this.p_parent.localToWorldMatrix.clone().invert().multiplyPoint(t),this.isTranslate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"rotation",{get:function(){return this._rotation.setFromMatrix(this.localToWorldMatrix),this._rotation},set:function(t){null===this.p_parent?this._localRotation=t:this._localRotation=this.p_parent.rotation.clone().invert().multiply(t),this.isRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"scale",{get:function(){return this._scale=this.localToWorldMatrix.getScale(),this._scale},set:function(t){null===this.p_parent?this._localScale=t:this._localScale=this.p_parent.localToWorldMatrix.clone().invert().multiplyVector3(t),this.isScale=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"eulerAngles",{get:function(){return this._eulerAngles=this.localToWorldMatrix.getEulerAngles(),this._eulerAngles},set:function(t){this._localRotation.setFromEulerAngles(t),null!==this.p_parent&&(this._localRotation=this.p_parent.rotation.clone().invert().multiply(this._localRotation)),this.isRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"localPosition",{get:function(){return this._localPosition},set:function(t){this._localPosition=t,this.isLocalTranslate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"localRotation",{get:function(){return this._localRotation},set:function(t){this._localRotation=t,this.isLocalRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"localEulerAngles",{get:function(){return this._localEulerAngles=this._localRotation.getEulerAngles(),this._localEulerAngles},set:function(t){this._localRotation.setFromEulerAngles(t),this.isLocalRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"localScale",{get:function(){return this._localScale},set:function(t){this._localScale=t,this.isLocalScale=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"up",{get:function(){return this.localToWorldMatrix.getY().normalize()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"right",{get:function(){return this.localToWorldMatrix.getX().normalize()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"forward",{get:function(){return this.localToWorldMatrix.getZ().normalize().scale(-1)},enumerable:!0,configurable:!0}),n.prototype.sync=function(){this.dirtyLocal&&(this._localToParentMatrix.setTRS(this._localPosition,this._localRotation,this._localScale),this.dirtyLocal=!1,this.dirtyWorld=!0),this.dirtyWorld&&(null===this.p_parent?this._localToWorldMatrix=this._localToParentMatrix.clone():this._localToWorldMatrix=this.p_parent.localToWorldMatrix.clone().multiply(this._localToParentMatrix),this.dirtyWorld=!1,this.children.forEach(function(t){t.dirtyWorld=!0}))},n.prototype.translateLocal=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null;return r=3===e.length?t.Vector3.create(e[0],e[1],e[2]):e[0],this._localPosition=this._localPosition.add(this._localRotation.multiplyVector3(r)),this.isTranslate=!0,this},n.prototype.translate=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null;return r=3===e.length?t.Vector3.create(e[0],e[1],e[2]):e[0],this.position=r.add(this.position),this},n.prototype.rotate=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null,i=t.Quaternion.create();return r=3===e.length?t.Vector3.create(e[0],e[1],e[2]):e[0],i.setFromEulerAngles(r),null===this.p_parent?this._localRotation=i.multiply(this._localRotation):(i=this.p_parent.rotation.clone().invert().multiply(i),this._localRotation=i.multiply(this.rotation)),this.isRotate=!0,this},n.prototype.rotateLocal=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null,i=t.Quaternion.create();return r=3===e.length?t.Vector3.create(e[0],e[1],e[2]):e[0],i.setFromEulerAngles(r),this._localRotation.multiply(i),this.isRotate=!0,this},n.prototype.rotateAround=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null,i=null,o=null,a=null,s=null;return 3===e.length?(r=e[0],i=e[1],o=e[2]):(r=e[0],i=t.Vector3.create(e[1],e[2],e[3]),o=t.Vector3.create(e[4],e[5],e[6])),a=t.Quaternion.create().setFromAxisAngle(r,o),s=this.position.clone().sub(i),s=a.multiplyVector3(s),this.position=i.add(s),this.rotation=a.multiply(this.rotation),this},n.prototype.lookAt=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null,i=null;return 1===e.length?(r=e[0],i=t.Vector3.up):2===e.length?(r=e[0],i=e[1]):3===e.length?(r=t.Vector3.create(e[0],e[1],e[2]),i=t.Vector3.up):(r=t.Vector3.create(e[0],e[1],e[2]),i=t.Vector3.create(e[3],e[4],e[5])),this.rotation=t.Quaternion.create().setFromMatrix(t.Matrix4.create().setLookAt(this.position,r,i)),this},n.prototype.clearCache=function(){this._localToWorldMatrixCache=null,this._normalMatrixCache=null,this._positionCache=null,this._rotationCache=null,this._scaleCache=null,this._eulerAnglesCache=null,this._localEulerAnglesCache=null},n.prototype.handleWhenSetTransformState=function(e){var n=null;switch(e){case t.ETransformState.ISTRANSLATE:n=t.EEngineEvent.TRANSFORM_TRANSLATE;break;case t.ETransformState.ISROTATE:n=t.EEngineEvent.TRANSFORM_ROTATE;break;case t.ETransformState.ISSCALE:n=t.EEngineEvent.TRANSFORM_SCALE;break;default:t.Log.error(!0,t.Log.info.FUNC_UNKNOW("transformState:"+e))}t.EventManager.trigger(this.entityObject,t.CustomEvent.create(n))},__decorate([t.cacheGetter(function(){return null!==this._localToWorldMatrixCache},function(){return this._localToWorldMatrixCache},function(t){this._localToWorldMatrixCache=t})],n.prototype,"localToWorldMatrix",null),__decorate([t.cacheGetter(function(){return null!==this._normalMatrixCache},function(){return this._normalMatrixCache},function(t){this._normalMatrixCache=t})],n.prototype,"normalMatrix",null),__decorate([t.cloneAttributeAsCloneable(),t.cacheGetter(function(){return null!==this._positionCache},function(){return this._positionCache},function(t){this._positionCache=t})],n.prototype,"position",null),__decorate([t.cloneAttributeAsCloneable(),t.cacheGetter(function(){return null!==this._rotationCache},function(){return this._rotationCache},function(t){this._rotationCache=t})],n.prototype,"rotation",null),__decorate([t.cloneAttributeAsCloneable(),t.cacheGetter(function(){return null!==this._scaleCache},function(){return this._scaleCache},function(t){this._scaleCache=t})],n.prototype,"scale",null),__decorate([t.cacheGetter(function(){return null!==this._eulerAnglesCache},function(){return this._eulerAnglesCache},function(t){this._eulerAnglesCache=t})],n.prototype,"eulerAngles",null),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"localPosition",null),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"localRotation",null),__decorate([t.cacheGetter(function(){return null!==this._localEulerAnglesCache},function(){return this._localEulerAnglesCache},function(t){this._localEulerAnglesCache=t})],n.prototype,"localEulerAngles",null),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"localScale",null),n}(t.Transform);t.ThreeDTransform=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._rotationMatrix=null,this._localPositionAndScaleMatrix=t.Matrix3.create(),this._position=t.Vector2.create(),this._rotation=0,this._scale=t.Vector2.create(1,1),this._localPosition=t.Vector2.create(0,0),this._localScale=t.Vector2.create(1,1),this._anchorX=t.Vector2.create(.5,.5),this._anchorY=t.Vector2.create(.5,.5),this._width=null,this._height=null,this.dirtyRotation=!0,this.dirtyPositionAndScale=!0,this.pivot=t.Vector2.create(0,0),this.zIndex=1,this._localRotationMatrix=t.Matrix3.create(),this._localToParentMatrix=t.Matrix3.create(),this._rotationMatrixCache=null,this._localPositionAndScaleMatrixCache=null}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"rotationMatrix",{get:function(){return this.getMatrix("syncRotation","_rotationMatrix")},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"localPositionAndScaleMatrix",{get:function(){return this.getMatrix("syncPositionAndScale","_localPositionAndScaleMatrix")},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"position",{get:function(){return this._position=this.localPositionAndScaleMatrix.getTranslation(),this._position},set:function(t){null===this.p_parent?this._localPosition=t:this._localPosition=this.p_parent.localPositionAndScaleMatrix.clone().invert().multiplyPoint(t),this.isTranslate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"rotation",{get:function(){return this._rotation=this.rotationMatrix.getRotation(),this._rotation},set:function(t){this.resetRotation(),this.rotate(t),this.dirtyRotation=!0,this.isRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"scale",{get:function(){return this._scale=this.localPositionAndScaleMatrix.getScale(),this._scale},set:function(t){null===this.p_parent?this._localScale=t:this._localScale=this.p_parent.localPositionAndScaleMatrix.clone().invert().multiplyVector2(t),this.isScale=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"localPosition",{get:function(){return this._localPosition},set:function(t){this._localPosition=t,this.isLocalTranslate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"localScale",{get:function(){return this._localScale},set:function(t){this._localScale=t,this.isLocalScale=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"anchorX",{get:function(){return this._anchorX},set:function(e){var n=null;if(!this._anchorX.isEqual(e)){if(this._anchorX=e,e.x===e.y){var r=(e.x-.5)*this._getParentWidth();return void(this.position=t.Vector2.create(this._getParentPosition().x+r,this.position.y))}n=this._getParentWidth(),this.position=t.Vector2.create(this._getParentPosition().x+(e.x+e.y-1)/2*n,this.position.y),this.width=n/this._getParentScale().x*(e.y-e.x)*this.scale.x}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"anchorY",{get:function(){return this._anchorY},set:function(e){var n=null;if(!this._anchorY.isEqual(e)){if(this._anchorY=e,e.x===e.y){var r=(e.x-.5)*this._getParentHeight();return void(this.position=t.Vector2.create(this.position.x,this._getParentPosition().y+r))}n=this._getParentHeight(),this.position=t.Vector2.create(this.position.x,this._getParentPosition().y+(e.x+e.y-1)/2*n),this.height=n/this._getParentScale().y*(e.y-e.x)*this.scale.y}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"width",{get:function(){return this._width*this.scale.x},set:function(e){this._width!==e&&(this._width=e,this.entityObject&&t.EventManager.trigger(this.entityObject,t.CustomEvent.create(t.EEngineEvent.UI_WIDTH_CHANGE)))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"height",{get:function(){return this._height*this.scale.y},set:function(e){this._height!==e&&(this._height=e,this.entityObject&&t.EventManager.trigger(this.entityObject,t.CustomEvent.create(t.EEngineEvent.UI_HEIGHT_CHANGE)))},enumerable:!0,configurable:!0}),n.prototype.syncRotation=function(){this.dirtyRotation&&(null===this.p_parent?this._rotationMatrix=this._localRotationMatrix.clone():this._rotationMatrix=this.p_parent.rotationMatrix.clone().multiply(this._localRotationMatrix),this.children.forEach(function(t){t.dirtyRotation=!0}))},n.prototype.syncPositionAndScale=function(){this.dirtyLocal&&(this._localToParentMatrix.setTS(this._localPosition,this._localScale),this.dirtyLocal=!1,this.dirtyPositionAndScale=!0),this.dirtyPositionAndScale&&(null===this.p_parent?this._localPositionAndScaleMatrix=this._localToParentMatrix.clone():this._localPositionAndScaleMatrix=this.p_parent.localPositionAndScaleMatrix.clone().multiply(this._localToParentMatrix),this.dirtyLocal=!1,this.children.forEach(function(t){t.dirtyPositionAndScale=!0}))},n.prototype.translate=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null;return r=2===e.length?t.Vector2.create(e[0],e[1]):e[0],this.position=r.add(this.position),this},n.prototype.rotate=function(t){var e=this.position;return this.rotateAround(t,e.x+this.pivot.x,e.y-this.pivot.y),this.dirtyRotation=!0,this.isRotate=!0,this},n.prototype.rotateAround=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null,i=null,o=null,a=null;return 2===e.length?(r=e[0],i=e[1]):(r=e[0],i=t.Vector2.create(e[1],e[2])),o=i.x,a=i.y,this._translateInRotationMatrix(o,a),this._rotateAroundCanvasOriginPoint(r),this._translateInRotationMatrix(-o,-a),this},n.prototype._translateInRotationMatrix=function(t,e){return this._localRotationMatrix.translate(t,e),this},n.prototype.resetPosition=function(){this.position=t.Vector2.create(0,0)},n.prototype.resetScale=function(){this.scale=t.Vector2.create(1,1)},n.prototype.resetRotation=function(){this._localRotationMatrix.setIdentity()},n.prototype.handleWhenSetTransformState=function(e){var n=null;switch(e){case t.ETransformState.ISTRANSLATE:n=t.EEngineEvent.TRANSFORM_TRANSLATE;break;case t.ETransformState.ISROTATE:n=t.EEngineEvent.TRANSFORM_ROTATE;break;case t.ETransformState.ISSCALE:n=t.EEngineEvent.TRANSFORM_SCALE;break;default:t.Log.error(!0,t.Log.info.FUNC_UNKNOW("transformState:"+e))}t.EventManager.trigger(this.entityObject,t.CustomEvent.create(n))},n.prototype.clearCache=function(){this._rotationMatrixCache=null,this._localPositionAndScaleMatrixCache=null},n.prototype._rotateAroundCanvasOriginPoint=function(t){return this._localRotationMatrix.rotate(t),this.dirtyRotation=!0,this},n.prototype._getParentWidth=function(){return null===this.p_parent?t.DeviceManager.getInstance().view.width:this.p_parent.width},n.prototype._getParentHeight=function(){return null===this.p_parent?t.DeviceManager.getInstance().view.height:this.p_parent.height},n.prototype._getParentPosition=function(){if(null===this.p_parent){var e=t.DeviceManager.getInstance().view;return t.Vector2.create(e.width/2,e.height/2)}return this.p_parent.position},n.prototype._getParentScale=function(){return null===this.p_parent?t.Vector2.create(1,1):this.p_parent.scale},__decorate([t.cacheGetter(function(){return null!==this._rotationMatrixCache},function(){return this._rotationMatrixCache},function(t){this._rotationMatrixCache=t})],n.prototype,"rotationMatrix",null),__decorate([t.cacheGetter(function(){return null!==this._localPositionAndScaleMatrixCache},function(){return this._localPositionAndScaleMatrixCache},function(t){this._localPositionAndScaleMatrixCache=t})],n.prototype,"localPositionAndScaleMatrix",null),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"position",null),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"rotation",null),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"scale",null),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"localPosition",null),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"localScale",null),__decorate([t.requireSetter(function(e){t.assert(e.x<=e.y,t.Log.info.FUNC_SHOULD("minX","<= maxY")),t.assert(e.x>=0&&e.x<=1,t.Log.info.FUNC_SHOULD("minX",">= 0 && <= 1")),t.assert(e.y>=0&&e.y<=1,t.Log.info.FUNC_SHOULD("maxX",">= 0 && <= 1"))}),t.cloneAttributeAsCloneable()],n.prototype,"anchorX",null),__decorate([t.requireSetter(function(e){t.assert(e.x<=e.y,t.Log.info.FUNC_SHOULD("minY","<= maxY")),t.assert(e.x>=0&&e.x<=1,t.Log.info.FUNC_SHOULD("minY",">= 0 && <= 1")),t.assert(e.y>=0&&e.y<=1,t.Log.info.FUNC_SHOULD("maxY",">= 0 && <= 1"))}),t.cloneAttributeAsCloneable()],n.prototype,"anchorY",null),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"width",null),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"height",null),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"pivot",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"zIndex",void 0),n}(t.Transform);t.RectTransform=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.ISTRANSLATE="isTranslate"]="ISTRANSLATE",t[t.ISROTATE="isRotate"]="ISROTATE",t[t.ISSCALE="isScale"]="ISSCALE",t[t.ISLOCALTRANSLATE="isLocalTranslate"]="ISLOCALTRANSLATE",t[t.ISLOCALROTATE="isLocalRotate"]="ISLOCALROTATE",t[t.ISLOCALSCALE="isLocalScale"]="ISLOCALSCALE"}(t.ETransformState||(t.ETransformState={}));t.ETransformState}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._receive=!0,this._cast=!0,this._layer=t.EShadowLayer.DEFAULT,this._shadowMapLayerChangeSubscription=null,this._isInit=!1}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"receive",{get:function(){return this._receive},set:function(e){if(this._isInit&&this._receive!==e){if(t.InstanceUtils.isObjectInstance(this.entityObject))return void(this._receive=e);e?(this._addShadowMapsToObjectAndChildren(),this._switchToShadowMapShaderLib(this.entityObject)):(this._removeShadowMapsOfObjectAndChildren(),this._switchToNoShadowMapShaderLib(this.entityObject))}this._receive=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"cast",{get:function(){return this._cast},set:function(t){this._cast=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"layer",{get:function(){return t.InstanceUtils.isObjectInstance(this.entityObject)&&!t.InstanceUtils.isHardwareSupport()&&(this._layer=this.entityObject.getComponent(t.ObjectInstance).sourceObject.getComponent(n).layer),this._layer},set:function(t){t&&this._layer!==t&&(this._layer=t)},enumerable:!0,configurable:!0}),n.prototype.addToObject=function(t,n){void 0===n&&(n=!1),e.prototype.addToObject.call(this,t,n)},n.prototype.init=function(){var e=this;if(this._isInit=!0,!t.InstanceUtils.isObjectInstance(this.entityObject)&&this._isFirstLevelObjectOfSceneOrSpacePartition())if(this._shadowMapLayerChangeSubscription=t.EventManager.fromEvent(t.EEngineEvent.SHADOWMAP_LAYER_CHANGE).subscribe(function(){e.receive&&e._addShadowMapsToObjectAndChildren()}),this.cast&&this.receive)this._addBuildShadowMapShaderAndShadowMapsToObjectAndChildren();else{if(this.cast)return void this._addBuildShadowMapShaderToObjectAndChildren();this.receive&&this._addShadowMapsToObjectAndChildren()}},n.prototype.dispose=function(){this._shadowMapLayerChangeSubscription&&this._shadowMapLayerChangeSubscription.dispose()},n.prototype._addAllShadowMaps=function(t,e,n){t.forEach(function(t){t.forEach(function(t){var e=t.shadowMap;n.addTwoDShadowMap(e)})}),e.forEach(function(t){t.forEach(function(t){var e=t.shadowMap;n.addCubemapShadowMap(e)})})},n.prototype._isFirstLevelObjectOfSceneOrSpacePartition=function(){var e=this.entityObject.parent;return e?t.JudgeUtils.isEqual(e,t.Director.getInstance().scene)||t.JudgeUtils.isSpacePartitionObject(e):!1},n.prototype._addBuildShadowMapShaderAndShadowMapsToObjectAndChildren=function(){var e=this,n=this,r=t.Director.getInstance().scene.gameObjectScene.shadowManager.twoDShadowMapDataMap,i=t.Director.getInstance().scene.gameObjectScene.shadowManager.cubemapShadowMapDataMap,o=function(a){if(a.hasComponent(t.Geometry)){var s=a.getComponent(t.Geometry),c=s.material,u=c.mapManager;n._addBuildTwoDShadowMapShader(c,e._createBuildTwoDShadowMapShader(a,s)),n._addBuildCubemapShadowMapShader(c,e._createBuildCubemapShadowMapShader(a,s)),c.shader.libDirty=!0,u.removeAllShdaowMaps(),n._addAllShadowMaps(r,i,u)}a.forEach(function(t){o(t)})};o(this.entityObject)},n.prototype._addBuildShadowMapShaderToObjectAndChildren=function(){var e=this,n=this,r=function(i){if(i.hasComponent(t.Geometry)){var o=i.getComponent(t.Geometry),a=o.material;n._addBuildTwoDShadowMapShader(a,e._createBuildTwoDShadowMapShader(i,o)),n._addBuildCubemapShadowMapShader(a,e._createBuildCubemapShadowMapShader(i,o))}i.forEach(function(t){r(t)})};r(this.entityObject)},n.prototype._addBuildTwoDShadowMapShader=function(e,n){e.addShader(t.EShaderTypeOfScene.BUILD_TWOD_SHADOWMAP,n)},n.prototype._addBuildCubemapShadowMapShader=function(e,n){e.addShader(t.EShaderTypeOfScene.BUILD_CUBEMAP_SHADOWMAP,n)},n.prototype._createBuildTwoDShadowMapShader=function(e,n){var r=this._createBuildShadowMapShader(e,n);return r.addLib(t.BuildTwoDShadowMapShaderLib.create()),r},n.prototype._createBuildCubemapShadowMapShader=function(e,n){var r=this._createBuildShadowMapShader(e,n);return r.addLib(t.BuildCubemapShadowMapShaderLib.create()),r},n.prototype._createBuildShadowMapShader=function(e,n){var r=t.CommonShader.create();return r.addLib(t.CommonShaderLib.create()),t.GlobalGeometryUtils.hasAnimation(n)?(r.addLib(t.CommonMorphShaderLib.create()),r.addLib(t.VerticeMorphShaderLib.create())):r.addLib(t.VerticeCommonShaderLib.create()),t.InstanceUtils.addModelMatrixShaderLib(r,e),r.addLib(t.EndShaderLib.create()),r},n.prototype._addShadowMapsToObjectAndChildren=function(){var e=this,n=t.Director.getInstance().scene.gameObjectScene.shadowManager.twoDShadowMapDataMap,r=t.Director.getInstance().scene.gameObjectScene.shadowManager.cubemapShadowMapDataMap,i=function(o){if(o.hasComponent(t.Geometry)){var a=o.getComponent(t.Geometry).material,s=a.mapManager;a.shader.libDirty=!0,s.removeAllShdaowMaps(),e._addAllShadowMaps(n,r,s)}o.forEach(function(t){i(t)})};i(this.entityObject)},n.prototype._removeShadowMapsOfObjectAndChildren=function(){var e=function(n){if(n.hasComponent(t.Geometry)){var r=n.getComponent(t.Geometry).material,i=r.mapManager;r.shader.libDirty=!0,i.removeAllShdaowMaps()}n.forEach(function(t){e(t)})};e(this.entityObject)},n.prototype._switchToShadowMapShaderLib=function(e){var n=e.getComponent(t.Geometry).material,r=n.shader,i=n.mapManager;r.removeLib(function(e){return e instanceof t.NoShadowMapShaderLib}),this._isTwoDShadowMap(i)&&r.addLib(t.TwoDShadowMapShaderLib.create()),this._isCubemapShadowMap(i)&&r.addLib(t.CubemapShadowMapShaderLib.create()),r.addLib(t.TotalShadowMapShaderLib.create())},n.prototype._switchToNoShadowMapShaderLib=function(e){var n=e.getComponent(t.Geometry).material,r=n.shader;r.removeLib(function(e){return e instanceof t.TwoDShadowMapShaderLib||e instanceof t.CubemapShadowMapShaderLib||e instanceof t.TotalShadowMapShaderLib}),r.hasLib(t.NoShadowMapShaderLib)||r.addLib(t.NoShadowMapShaderLib.create())},n.prototype._isTwoDShadowMap=function(t){return t.getTwoDShadowMapList().getCount()>0},n.prototype._isCubemapShadowMap=function(t){return t.getCubemapShadowMapList().getCount()>0},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"receive",null),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"cast",null),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"layer",null),__decorate([t.require(function(e,n){void 0===n&&(n=!1),t.assert(e instanceof t.GameObject,t.Log.info.FUNC_SHOULD("add to GameObject"))})],n.prototype,"addToObject",null),__decorate([t.require(function(e,n){t.assert(!e.hasShader(t.EShaderTypeOfScene.BUILD_TWOD_SHADOWMAP),t.Log.info.FUNC_SHOULD_NOT("material","exist build twoD shadow map shader"))})],n.prototype,"_addBuildTwoDShadowMapShader",null),__decorate([t.require(function(e,n){t.assert(!e.hasShader(t.EShaderTypeOfScene.BUILD_CUBEMAP_SHADOWMAP),t.Log.info.FUNC_SHOULD_NOT("material","exist build cubemap shadow map shader"))})],n.prototype,"_addBuildCubemapShadowMapShader",null),__decorate([t.ensure(function(e,n){var r=n.getComponent(t.Geometry).material,i=r.shader;t.assert(!i.hasLib(t.NoShadowMapShaderLib),t.Log.info.FUNC_SHOULD_NOT("contain NoShadowMapShaderLib")),t.assert(i.getLibs().filter(function(e){return e instanceof t.TwoDShadowMapShaderLib}).getCount()<=1,t.Log.info.FUNC_SHOULD_NOT("has duplicate TwoDShadowMapShaderLib")),t.assert(i.getLibs().filter(function(e){return e instanceof t.CubemapShadowMapShaderLib}).getCount()<=1,t.Log.info.FUNC_SHOULD_NOT("has duplicate CubemapShadowMapShaderLib"))})],n.prototype,"_switchToShadowMapShaderLib",null),__decorate([t.ensure(function(e,n){var r=n.getComponent(t.Geometry).material,i=r.shader;t.assert(!i.hasLib(t.TwoDShadowMapShaderLib),t.Log.info.FUNC_SHOULD_NOT("contain TwoDShadowMapShaderLib")),t.assert(!i.hasLib(t.CubemapShadowMapShaderLib),t.Log.info.FUNC_SHOULD_NOT("contain CubemapShadowMapShaderLib")),t.assert(i.getLibs().filter(function(e){return e instanceof t.NoShadowMapShaderLib}).getCount()<=1,t.Log.info.FUNC_SHOULD_NOT("has duplicate NoShadowMapShaderLib"))})],n.prototype,"_switchToNoShadowMapShaderLib",null),n}(t.Component);t.Shadow=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.isReceive=function(e){var n=null,r=e,i=!1;do{if(n=r.getComponent(t.Shadow),n&&n.receive){i=!0;break}r=r.parent}while(r);return i},e}();t.ShadowUtils=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.DEFAULT="default"]="DEFAULT"}(t.EShadowLayer||(t.EShadowLayer={}));t.EShadowLayer}(wd||(wd={}));var wd;!function(t){!function(t){t[t.NONE=0]="NONE",t[t.PCF=1]="PCF"}(t.EShadowMapSoftType||(t.EShadowMapSoftType={}));t.EShadowMapSoftType}(wd||(wd={}));var wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.isFrameChange=!1,this.state=n.DEFAULT,this.pauseTime=null,this.resumeTime=null,this.pauseDuration=null,this.frameCount=null,this._isResume=!1}return __extends(r,e),Object.defineProperty(r.prototype,"isStart",{get:function(){return this.state===n.RUN},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isStop",{get:function(){return this.state===n.STOP},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isPause",{get:function(){return this.state===n.PAUSE},enumerable:!0,configurable:!0}),r.prototype.addToObject=function(n,r){void 0===r&&(r=!1);var i=t.AnimationEngine.getInstance();e.prototype.addToObject.call(this,n,r),i.hasChild(this)||i.addChild(this)},r.prototype.removeFromObject=function(n){e.prototype.removeFromObject.call(this,n),t.AnimationEngine.getInstance().removeChild(this)},r.prototype.clone=function(){return t.CloneUtils.clone(this)},r.prototype.pause=function(){this.state=n.PAUSE,this.pauseTime=this.getPauseTime()},r.prototype.resume=function(){this.state=n.RUN,this._isResume=!0,this.resumeTime=this.getResumeTime()},r.prototype.stop=function(){this.state=n.STOP},r.prototype.update=function(t){if(this.state!==n.DEFAULT&&!this.isStop){if(this.isPause)return void this.handleWhenPause(t);this._isResume&&(this._isResume=!1,this.continueFromPausePoint(t)),this.handleBeforeJudgeWhetherCurrentFrameFinish(t),this.isCurrentFrameFinish(t)?this.handleWhenCurrentFrameFinish(t):this.isFrameChange=!1,this.handleAfterJudgeWhetherCurrentFrameFinish(t)}},r.prototype.getPauseTime=function(){return this.getCurrentTime()},r.prototype.getResumeTime=function(){return this.getCurrentTime()},r.prototype.getCurrentTime=function(){return t.Director.getInstance().elapsed},r.prototype.continueFromPausePoint=function(t){this.pauseDuration+=this.resumeTime-this.pauseTime},r}(t.Component);t.Animation=e,function(t){t[t.DEFAULT=0]="DEFAULT",t[t.RUN=1]="RUN",t[t.STOP=2]="STOP",t[t.PAUSE=3]="PAUSE"}(t.EAnimationState||(t.EAnimationState={}));var n=t.EAnimationState}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.interpolation=0,this.currentFrame=0,this.duration=null,
this.fps=null,this.currentAnimName=null,this._prevFrameEndTime=null}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"nextFrame",{get:function(){var t=this.currentFrame+1;return t>=this.frameCount&&(t=0),t},enumerable:!0,configurable:!0}),n.prototype.init=function(){},n.prototype.dispose=function(){},n.prototype.play=function(e,n){var r=this.entityObject.getComponent(t.ModelGeometry);this.currentAnimName=e,this.fps=n,this.duration=1/n*1e3,this.frameCount=r.morphTargets.getChild(e).getCount(),this.resetAnim(),this.state=t.EAnimationState.RUN},n.prototype.handleWhenPause=function(t){},n.prototype.handleWhenCurrentFrameFinish=function(e){this.isFrameChange=!0,this._prevFrameEndTime=t.MathUtils.maxFloorIntegralMultiple(e-this.pauseDuration,this.duration),this.currentFrame++,this._isFinishAllFrames()&&(this.currentFrame=0)},n.prototype.handleBeforeJudgeWhetherCurrentFrameFinish=function(t){null===this._prevFrameEndTime&&(this._prevFrameEndTime=this.getCurrentTime())},n.prototype.isCurrentFrameFinish=function(t){return t-this._prevFrameEndTime-this.pauseDuration>this.duration},n.prototype.handleAfterJudgeWhetherCurrentFrameFinish=function(t){this._computeInterpolation(t)},n.prototype.resetAnim=function(){this._prevFrameEndTime=null,this.currentFrame=0,this.pauseDuration=0},n.prototype._computeInterpolation=function(t){this.interpolation=this.fps*(t-this._prevFrameEndTime-this.pauseDuration)/1e3},n.prototype._isFinishAllFrames=function(){return this.currentFrame>=this.frameCount},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"interpolation",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"currentFrame",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"duration",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"fps",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"currentAnimName",void 0),__decorate([t.require(function(e,n){var r=this.entityObject.getComponent(t.ModelGeometry);t.assert(r,t.Log.info.FUNC_SHOULD("this entityObject","add ModelGeometry component")),t.assert(r.morphTargets.getChild(e)&&r.morphTargets.getChild(e).getCount()>0,t.Log.info.FUNC_NOT_EXIST('"'+e+'" animation'))}),t.ensure(function(){t.assert(this.frameCount>1,t.Log.info.FUNC_SHOULD("frames.count","> 1"))})],n.prototype,"play",null),__decorate([t.require(function(e){t.assert(e-this._prevFrameEndTime-this.pauseDuration>=0,t.Log.info.FUNC_SHOULD("elapsed of current frame:"+(e-this._prevFrameEndTime-this.pauseDuration),">= 0"))})],n.prototype,"isCurrentFrameFinish",null),__decorate([t.ensure(function(){var e=this.interpolation;t.assert(e>=0&&1>=e,t.Log.info.FUNC_SHOULD("interpolation("+e,">= 0 && <= 1"))})],n.prototype,"_computeInterpolation",null),n}(t.Animation);t.MorphAnimation=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.data=null,this._currentFrame=null,this._currentAnimName=null,this._beginElapsedTimeOfFirstFrame=null,this._prevFrameTime=null,this._currentAnimData=null,this._currentFrameData=null,this._prevFrameData=null,this._startFrameDataMap=wdCb.Hash.create()}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.init=function(){},n.prototype.dispose=function(){},n.prototype.play=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(t.JudgeUtils.isNumber(e[0])){var r=e[0],i=0,o=this;this.data.forEach(function(t,e){return r===i?(o._currentAnimName=e,o._currentAnimData=t,wdCb.$BREAK):void i++})}else if(t.JudgeUtils.isString(e[0])){var a=e[0];this._currentAnimName=a,this._currentAnimData=this.data.getChild(a)}this.resetAnim(),this._saveStartFrameData(this.entityObject.transform),this.frameCount=this._currentAnimData.getCount(),this.state=t.EAnimationState.RUN},n.prototype.handleWhenPause=function(t){},n.prototype.handleWhenCurrentFrameFinish=function(t){this.isFrameChange=!0,this._updateFrame(t),this._saveStartFrameData(this._prevFrameData)},n.prototype.handleBeforeJudgeWhetherCurrentFrameFinish=function(t){null===this._beginElapsedTimeOfFirstFrame&&(this._beginElapsedTimeOfFirstFrame=this.getCurrentTime())},n.prototype.isCurrentFrameFinish=function(t){return t-this._beginElapsedTimeOfFirstFrame-this.pauseDuration>this._currentFrameData.time},n.prototype.handleAfterJudgeWhetherCurrentFrameFinish=function(t){this._updateTargets(t)},n.prototype.resetAnim=function(){this._beginElapsedTimeOfFirstFrame=null,this._prevFrameTime=0,this.pauseDuration=0,this._currentFrame=0,this._prevFrameData=null,this._updateCurrentFrameData(),this._startFrameDataMap.removeAllChildren()},n.prototype._updateTargets=function(e){var n=this,r=this.entityObject.transform,i=this._startFrameDataMap;this._currentFrameData.targets.forEach(function(o){var a=o.data,s=i.getChild(o.target),c=n._computeInterpolation(e,o.interpolationMethod);switch(o.target){case t.EArticulatedAnimationTarget.TRANSLATION:r.localPosition=t.Vector3.create().lerp(s,a,c);break;case t.EArticulatedAnimationTarget.ROTATION:r.localRotation=t.Quaternion.create().slerp(s,a,c);break;case t.EArticulatedAnimationTarget.SCALE:r.localScale=t.Vector3.create().lerp(s,a,c);break;default:t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("EArticulatedAnimationTarget:"+o.target))}})},n.prototype._computeInterpolation=function(e,n){var r=null;switch(n){case t.EKeyFrameInterpolation.LINEAR:r=this._currentFrameData.time-this._prevFrameTime===0?1:(e-this._beginElapsedTimeOfFirstFrame-this.pauseDuration-this._prevFrameTime)/(this._currentFrameData.time-this._prevFrameTime);break;default:t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("interpolationMethod:"+n))}return r},n.prototype._saveStartFrameData=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=this._startFrameDataMap;if(this._isFrameData(e[0])){var i=e[0];i.targets.forEach(function(t){r.addChild(t.target,t.data)})}else{var o=e[0];r.addChild(t.EArticulatedAnimationTarget.TRANSLATION,o.localPosition),r.addChild(t.EArticulatedAnimationTarget.ROTATION,o.localRotation),r.addChild(t.EArticulatedAnimationTarget.SCALE,o.localScale)}},n.prototype._updateCurrentFrameData=function(){this._currentFrameData=this._currentAnimData.getChild(this._currentFrame)},n.prototype._updateFrame=function(t){this._updateCurrentFrameIndex(t),this._isFinishAllFrames()?(this._currentFrame=0,this._beginElapsedTimeOfFirstFrame=this._getBeginElapsedTimeOfFirstFrameWhenFinishAllFrames(t),this._prevFrameTime=0,this._prevFrameData=this._currentAnimData.getChild(this.frameCount-1),this._updateCurrentFrameData()):this._prevFrameTime=this._currentAnimData.getChild(this._currentFrame-1).time},n.prototype._getBeginElapsedTimeOfFirstFrameWhenFinishAllFrames=function(e){return t.MathUtils.maxFloorIntegralMultiple(e,this._currentAnimData.getChild(this.frameCount-1).time)},n.prototype._isFinishAllFrames=function(){return this._currentFrame>=this.frameCount},n.prototype._updateCurrentFrameIndex=function(t){do this._currentFrame++,this._prevFrameData=this._currentFrameData,this._updateCurrentFrameData();while(!this._isFinishAllFrames()&&this.isCurrentFrameFinish(t))},n.prototype._isFrameData=function(t){return void 0!==t.time&&void 0!==t.targets},__decorate([t.cloneAttributeAsCloneable()],n.prototype,"data",void 0),__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(t.JudgeUtils.isNumber(e[0])){var r=e[0];t.assert(this.data.getCount()>=r+1,t.Log.info.FUNC_NOT_EXIST("animation index:"+r))}else if(t.JudgeUtils.isString(e[0])){var i=e[0];t.assert(this.data.hasChild(i),t.Log.info.FUNC_NOT_EXIST("animation name:"+i))}}),t.ensure(function(){t.assert(!!this._currentAnimData,t.Log.info.FUNC_NOT_EXIST("animation name:"+this._currentAnimName)),this._currentAnimData.forEach(function(e){t.assert(e.time>=0,t.Log.info.FUNC_SHOULD("time",">= 0")),t.assert(e.targets.getCount()>0,t.Log.info.FUNC_SHOULD("ArticulatedAnimationFrameData->targets.getCount()","> 0")),e.targets.forEach(function(e){var n=e.data;switch(e.target){case t.EArticulatedAnimationTarget.TRANSLATION:t.assert(n instanceof t.Vector3,t.Log.info.FUNC_MUST_BE("if target:EArticulatedAnimationTarget === TRANSLATION, its data","Vector3"));break;case t.EArticulatedAnimationTarget.ROTATION:t.assert(n instanceof t.Quaternion,t.Log.info.FUNC_MUST_BE("if target:EArticulatedAnimationTarget ===ROTATION, its data","Quaternion"));break;case t.EArticulatedAnimationTarget.SCALE:t.assert(n instanceof t.Vector3,t.Log.info.FUNC_MUST_BE("if target:EArticulatedAnimationTarget === SCALE, its data","Vector3"));break;default:t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("EArticulatedAnimationTarget:"+e.target))}})})})],n.prototype,"play",null),__decorate([t.require(function(e){t.assert(e-this._beginElapsedTimeOfFirstFrame-this.pauseDuration>=0,t.Log.info.FUNC_SHOULD("elapsed of current frame:"+(e-this._beginElapsedTimeOfFirstFrame-this.pauseDuration),">= 0"))})],n.prototype,"isCurrentFrameFinish",null),__decorate([t.ensure(function(e,n,r){t.assert(e>=0&&1>=e,t.Log.info.FUNC_SHOULD("interpolation:"+e,">= 0 && <= 1"))})],n.prototype,"_computeInterpolation",null),__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(this._isFrameData(e[0])){var r=e[0];t.assert(null!==this._currentFrameData,t.Log.info.FUNC_SHOULD("set currentFrameData")),this._currentFrameData.targets.forEach(function(e,n){t.assert(r.targets.getChild(n).target===e.target,t.Log.info.FUNC_SHOULD("the current frame and the start frame","modify the same targets"))})}})],n.prototype,"_saveStartFrameData",null),__decorate([t.require(function(e){var n=this._currentAnimData.getChild(this.frameCount-1).time;t.assert(e>=n,t.Log.info.FUNC_SHOULD("elapsed:"+e,">= lastEndFrameTime:"+n))})],n.prototype,"_getBeginElapsedTimeOfFirstFrameWhenFinishAllFrames",null),n}(t.Animation);t.ArticulatedAnimation=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.LINEAR=0]="LINEAR"}(t.EKeyFrameInterpolation||(t.EKeyFrameInterpolation={}));t.EKeyFrameInterpolation}(wd||(wd={}));var wd;!function(t){!function(t){t[t.TRANSLATION="position"]="TRANSLATION",t[t.ROTATION="rotation"]="ROTATION",t[t.SCALE="scale"]="SCALE"}(t.EArticulatedAnimationTarget||(t.EArticulatedAnimationTarget={}));t.EArticulatedAnimationTarget}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._material=null,this.buffers=null,this.vaoManager=t.GPUDetector.getInstance().extensionVAO?t.VAOManager.create():null,this.drawMode=t.EDrawMode.TRIANGLES}return __extends(n,e),Object.defineProperty(n.prototype,"material",{get:function(){return this._material},set:function(e){t.JudgeUtils.isEqual(e,this._material)||(this._material=e,this._material.geometry=this,this.entityObject&&t.EventManager.trigger(this.entityObject,t.CustomEvent.create(t.EEngineEvent.MATERIAL_CHANGE)))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"geometryData",{get:function(){return null===this.buffers?null:this.buffers.geometryData},enumerable:!0,configurable:!0}),n.prototype.init=function(){var t=null,e=this.computeData(),n=e.vertices,r=e.faces,i=e.texCoords,o=e.colors,a=e.morphTargets;this.buffers=this.createBufferContainer(),t=this.createGeometryData(n,r,i,o,a),this.buffers.geometryData=t,this.buffers.init(),this._material.init(),this.computeNormals(),this.vaoManager&&this.vaoManager.init()},n.prototype.hasFaceNormals=function(){return this.buffers.geometryData.hasFaceNormals()},n.prototype.hasVertexNormals=function(){return this.buffers.geometryData.hasVertexNormals()},n.prototype.isSmoothShading=function(){return this._material.shading===t.EShading.SMOOTH},n.prototype.dispose=function(){this.buffers.dispose(),this._material.dispose(),this.vaoManager&&this.vaoManager.dispose()},n.prototype.computeFaceNormals=function(){this.buffers.geometryData.computeFaceNormals()},n.prototype.computeVertexNormals=function(){this.buffers.geometryData.computeVertexNormals()},n.prototype.createBuffersFromGeometryData=function(){this.buffers.createBuffersFromGeometryData()},n.prototype.computeNormals=function(){this.isSmoothShading()?this.hasVertexNormals()||this.computeVertexNormals():this.hasFaceNormals()||this.computeFaceNormals()},n.prototype.createBufferContainer=function(){return t.CommonBufferContainer.create(this.entityObject)},n.prototype.createGeometryData=function(t,e,n,r,i){return this.createCommonGeometryData(t,e,n,r)},n.prototype.createCommonGeometryData=function(e,n,r,i){var o=t.CommonGeometryData.create(this);return o.vertices=e,o.faces=n,o.texCoords=r,o.colors=i,o},__decorate([t.cloneAttributeAsCloneable()],n.prototype,"material",null),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"drawMode",void 0),__decorate([t.ensure(function(){var e=this.buffers.geometryData;t.assert(e.vertices.length>0,t.Log.info.FUNC_MUST("vertices.count","> 0")),t.assert(3*e.faces.length===e.indices.length,t.Log.info.FUNC_SHOULD("faces.count","be "+e.indices.length/3+", but actual is "+e.faces.length))}),t.execOnlyOnce("_isInit")],n.prototype,"init",null),__decorate([t.require(function(){t.assert(this.buffers&&this.buffers.geometryData,t.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],n.prototype,"hasFaceNormals",null),__decorate([t.require(function(){t.assert(this.buffers&&this.buffers.geometryData,t.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],n.prototype,"hasVertexNormals",null),__decorate([t.require(function(){t.assert(this.buffers&&this.buffers.geometryData,t.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],n.prototype,"computeFaceNormals",null),__decorate([t.require(function(){t.assert(!!this.buffers,t.Log.info.FUNC_NOT_EXIST("buffers"))})],n.prototype,"createBuffersFromGeometryData",null),__decorate([t.virtual],n.prototype,"computeNormals",null),__decorate([t.virtual],n.prototype,"createBufferContainer",null),__decorate([t.virtual],n.prototype,"createGeometryData",null),n}(t.Component);t.Geometry=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._vaoMap=wdCb.Hash.create(),this._extension=null}return e.create=function(){var t=new this;return t},e.prototype.init=function(){this._extension=t.GPUDetector.getInstance().extensionVAO},e.prototype.dispose=function(){this._vaoMap.removeAllChildren()},e.prototype.getVAOData=function(t){var e=!1,n=this._vaoMap.getChild(t);return n?e=!0:(n=this._extension.createVertexArrayOES(),this._vaoMap.addChild(t,n),e=!1),{vao:n,isSetted:e}},e.prototype.sendAllBufferData=function(e,n){var r=this.getVAOData(e),i=r.vao,o=r.isSetted;if(t.BufferTable.lastBindedElementBuffer=null,this._extension.bindVertexArrayOES(i),!o)for(var a=0,s=n.length;s>a;a++){var c=n[a];if(c){var u=t.DeviceManager.getInstance().gl;u.bindBuffer(u.ARRAY_BUFFER,c.buffer),u.vertexAttribPointer(a,c.size,u[c.type],!1,0,0),u.enableVertexAttribArray(a)}}},__decorate([t.require(function(){t.assert(!!t.GPUDetector.getInstance().extensionVAO,t.Log.info.FUNC_SHOULD("hardware","support vao extension"))})],e.prototype,"init",null),e}();t.VAOManager=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.convertToFaces=function(e,n){for(var r=this.hasData(n),i=[],o=0,a=e.length;a>o;o+=3){var s=e[o],c=e[o+1],u=e[o+2],l=t.Face3.create(s,c,u);r&&(l.vertexNormals.addChildren([this.getThreeComponent(n,s),this.getThreeComponent(n,c),this.getThreeComponent(n,u)]),l.faceNormal=l.vertexNormals.getChild(0).clone()),i.push(l)}return i},e.hasData=function(t){return t&&(t.length&&t.length>0||t.getCount&&t.getCount()>0)},e.getThreeComponent=function(e,n){var r=3*n;return t.Vector3.create(e[r],e[r+1],e[r+2])},e.iterateThreeComponent=function(e,n){for(var r=0,i=e.length;i>r;r+=3)n(t.Vector3.create(e[r],e[r+1],e[r+2]))},e.setThreeComponent=function(e,n,r){n instanceof t.Vector3?(e[3*r]=n.x,e[3*r+1]=n.y,e[3*r+2]=n.z):(e[3*r]=n[0],e[3*r+1]=n[1],e[3*r+2]=n[2])},__decorate([t.require(function(e){e&&t.assert(e instanceof wdCb.Collection||e instanceof wdCb.Hash||t.JudgeUtils.isArrayExactly(e),t.Log.info.FUNC_SHOULD("data","be Array or Collection or Hash"))})],e,"hasData",null),__decorate([t.require(function(e,n){t.assert(e.length%3===0,t.Log.info.FUNC_SHOULD("dataArr.length","times of three"))})],e,"iterateThreeComponent",null),e}();t.GeometryUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._vertices=[],this._texCoords=[],this._colors=[],this._indices=[],this._normals=[]}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"vertices",{get:function(){return this._vertices},set:function(e){this._vertices=e,this.buffers&&(this.buffers.geometryData.vertices=e,this.buffers.removeCache(t.EBufferDataType.VERTICE))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"texCoords",{get:function(){return this._texCoords},set:function(e){this._texCoords=e,this.buffers&&(this.buffers.geometryData.texCoords=e,this.buffers.removeCache(t.EBufferDataType.TEXCOORD))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"colors",{get:function(){return this._colors},set:function(e){this._colors=e,this.buffers&&(this.buffers.geometryData.colors=e,this.buffers.removeCache(t.EBufferDataType.COLOR))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"indices",{get:function(){return this._indices},set:function(e){this._indices=e,this.buffers&&(this.buffers.geometryData.faces=t.GeometryUtils.convertToFaces(e,this.normals),this.buffers.removeCache(t.EBufferDataType.INDICE))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"normals",{get:function(){return this._normals},set:function(e){this._normals=e,this.buffers&&(this.buffers.geometryData.faces=t.GeometryUtils.convertToFaces(this.indices,e),this.buffers.removeCache(t.EBufferDataType.NORMAL))},enumerable:!0,configurable:!0}),n.prototype.computeData=function(){return{vertices:this.vertices,faces:t.GeometryUtils.convertToFaces(this.indices,this.normals),texCoords:this.texCoords,colors:this.colors}},__decorate([t.cloneAttributeAsCustomType(function(e,n,r){n[r]=t.CloneUtils.cloneArray(e[r])})],n.prototype,"vertices",null),__decorate([t.cloneAttributeAsCustomType(function(e,n,r){n[r]=t.CloneUtils.cloneArray(e[r])})],n.prototype,"texCoords",null),__decorate([t.cloneAttributeAsCustomType(function(e,n,r){n[r]=t.CloneUtils.cloneArray(e[r])})],n.prototype,"colors",null),__decorate([t.cloneAttributeAsCustomType(function(e,n,r){n[r]=t.CloneUtils.cloneArray(e[r])})],n.prototype,"indices",null),__decorate([t.cloneAttributeAsCustomType(function(e,n,r){n[r]=t.CloneUtils.cloneArray(e[r])})],n.prototype,"normals",null),n}(t.Geometry);t.CustomGeometry=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.vertices=null,this.colors=null,this.texCoords=null,this.faces=null,this.morphTargets=null,this.morphFaceNormals=wdCb.Hash.create(),this.morphVertexNormals=wdCb.Hash.create()}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.hasAnimation=function(){return this._hasMorphTargets()&&this.entityObject&&this.entityObject.hasComponent(t.MorphAnimation)},n.prototype.hasMorphFaceNormals=function(){return this.buffers.geometryData.hasMorphFaceNormals()},n.prototype.hasMorphVertexNormals=function(){return this.buffers.geometryData.hasMorphVertexNormals()},n.prototype.computeMorphNormals=function(){this.buffers.geometryData.computeMorphNormals()},n.prototype.merge=function(t,e){var n=this._getSourceGeometryData(),r=this._getTargetGeometryData(t);n=this._initGeometryData(n),this.faces=this._mergeTransformedFace(n.faces,r.faces,e,n.vertices.length/3),this.vertices=this._mergeData(n.vertices,this._transformVertices(r.vertices,e)),this.texCoords=this._mergeData(n.texCoords,r.texCoords),this.colors=this._mergeData(n.colors,r.colors)},n.prototype._getSourceGeometryData=function(){return null!==this.geometryData?this.geometryData:{vertices:this.vertices,texCoords:this.texCoords,colors:this.colors,faces:this.faces}},n.prototype._initGeometryData=function(t){return{vertices:t.vertices||[],texCoords:t.texCoords||[],colors:t.colors||[],faces:t.faces||[]}},n.prototype._getTargetGeometryData=function(t){return null!==t.geometryData?t.geometryData:t instanceof n?{vertices:t.vertices,texCoords:t.texCoords,colors:t.colors,faces:t.faces}:t.computeData()},n.prototype._transformVertices=function(e,n){for(var r=n.localToWorldMatrix,i=[],o=0,a=e.length;a>o;o+=3){var s=t.Vector3.create(e[o],e[o+1],e[o+2]).applyMatrix4(r);i.push(s.x,s.y,s.z)}return i},n.prototype._mergeTransformedFace=function(e,n,r,i){var o=null;if(!n)return e;o=r.normalMatrix;for(var a=function(n){var r=t.Face3.create(n.aIndex+i,n.bIndex+i,n.cIndex+i);if(n.hasFaceNormal()&&(r.faceNormal=n.faceNormal.clone().applyMatrix3(o)),n.vertexNormals){var a=wdCb.Collection.create();n.vertexNormals.forEach(function(t){a.addChild(t.clone().applyMatrix3(o))}),r.vertexNormals=a}e.push(r)},s=0,c=n;s<c.length;s++){var u=c[s];a(u)}return e},n.prototype._mergeData=function(t,e){return e?t.concat(e):t},n.prototype._mergeFace=function(t,e){if(!e)return t;for(var n=0,r=e;n<r.length;n++){var i=r[n];t.push(i.clone())}return t},n.prototype.computeNormals=function(){e.prototype.computeNormals.call(this),this._hasMorphTargets()&&(this.isSmoothShading()?this.hasMorphVertexNormals()||this.computeMorphNormals():this.hasMorphFaceNormals()||this.computeMorphNormals())},n.prototype.computeData=function(){return{vertices:this.vertices,faces:this.faces,texCoords:this.texCoords,colors:this.colors,morphTargets:this.morphTargets}},n.prototype.createBufferContainer=function(){return this.hasAnimation()?t.MorphBufferContainer.create(this.entityObject,this.entityObject.getComponent(t.MorphAnimation)):t.CommonBufferContainer.create(this.entityObject)},n.prototype.createGeometryData=function(e,n,r,i,o){if(this.hasAnimation()){var a=t.MorphGeometryData.create(this);return a.vertices=e,a.faces=n,a.texCoords=r,a.colors=i,a.morphTargets=o,a}return this.createCommonGeometryData(e,n,r,i)},n.prototype._hasMorphTargets=function(){return this.morphTargets&&this.morphTargets.getCount()>0},n.prototype._getDeepCloneMorphData=function(t){var e=wdCb.Hash.create();return t&&t.forEach(function(t,n){e.addChild(n,t.clone(!0))}),e},__decorate([t.cloneAttributeAsCustomType(function(e,n,r){n[r]=t.CloneUtils.cloneArray(e[r])})],n.prototype,"vertices",void 0),__decorate([t.cloneAttributeAsCustomType(function(e,n,r){n[r]=t.CloneUtils.cloneArray(e[r])})],n.prototype,"colors",void 0),__decorate([t.cloneAttributeAsCustomType(function(e,n,r){n[r]=t.CloneUtils.cloneArray(e[r])})],n.prototype,"texCoords",void 0),__decorate([t.cloneAttributeAsCustomType(function(t,e,n){e[n]=this._mergeFace([],t[n])})],n.prototype,"faces",void 0),__decorate([t.cloneAttributeAsCustomType(function(t,e,n){e[n]=this._getDeepCloneMorphData(t[n])})],n.prototype,"morphTargets",void 0),__decorate([t.cloneAttributeAsCustomType(function(t,e,n){e[n]=this._getDeepCloneMorphData(t[n])})],n.prototype,"morphFaceNormals",void 0),__decorate([t.cloneAttributeAsCustomType(function(t,e,n){e[n]=this._getDeepCloneMorphData(t[n])})],n.prototype,"morphVertexNormals",void 0),__decorate([t.require(function(){t.assert(this.buffers&&this.buffers.geometryData,t.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],n.prototype,"hasMorphFaceNormals",null),__decorate([t.require(function(){t.assert(this.buffers&&this.buffers.geometryData,t.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],n.prototype,"hasMorphVertexNormals",null),__decorate([t.require(function(){t.assert(this.buffers&&this.buffers.geometryData,t.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],n.prototype,"computeMorphNormals",null),__decorate([t.require(function(e,n){t.assert(e&&e.length>0,t.Log.info.FUNC_MUST("vertices.count","> 0"))})],n.prototype,"_transformVertices",null),__decorate([t.require(function(){this.hasAnimation()&&t.assert(this.entityObject.getComponent(t.MorphAnimation),t.Log.info.FUNC_SHOULD("entityObject with ModelGeometry","add MorphAnimation component"))})],n.prototype,"createBufferContainer",null),n}(t.Geometry);t.ModelGeometry=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.width=null,this.height=null,this.depth=null,this.widthSegments=1,this.heightSegments=1,this.depthSegments=1}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.computeData=function(){function e(e,n,r){var i,o,a,s,c=d.length/3;for(a=0;n>=a;a++)for(s=0;r>=s;s++){var g=t.Vector3.create(),m=t.Vector3.create(),y=t.Vector3.create(),v=t.Vector3.create();g.lerp(h[u[e][0]],h[u[e][1]],a/n),m.lerp(h[u[e][0]],h[u[e][2]],s/r),y.sub2(m,h[u[e][0]]),v.add2(g,y),i=a/n,o=s/r,d.push(v.x,v.y,v.z),p.push(l[e][0],l[e][1],l[e][2]),f.push(i,o),n>a&&r>s&&(_.push(c+s+a*(n+1),c+s+(a+1)*(n+1),c+s+a*(n+1)+1),_.push(c+s+(a+1)*(n+1),c+s+(a+1)*(n+1)+1,c+s+a*(n+1)+1))}}var n=this.width,r=this.height,i=this.depth,o=this.widthSegments,a=this.heightSegments,s=this.depthSegments,c={FRONT:0,BACK:1,TOP:2,BOTTOM:3,RIGHT:4,LEFT:5},u=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],l=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],h=[t.Vector3.create(-n,-r,i),t.Vector3.create(n,-r,i),t.Vector3.create(n,r,i),t.Vector3.create(-n,r,i),t.Vector3.create(n,-r,-i),t.Vector3.create(-n,-r,-i),t.Vector3.create(-n,r,-i),t.Vector3.create(n,r,-i)],d=[],p=[],f=[],_=[];return e(c.FRONT,o,a),e(c.BACK,o,a),e(c.TOP,o,s),e(c.BOTTOM,o,s),e(c.RIGHT,s,a),e(c.LEFT,s,a),{vertices:d,faces:t.GeometryUtils.convertToFaces(_,p),texCoords:f}},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"width",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"height",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"depth",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"widthSegments",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"heightSegments",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"depthSegments",void 0),n}(t.Geometry);t.BoxGeometry=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.width=null,this.height=null}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.computeData=function(){var e=this.width,n=this.height,r=-e/2,i=e/2,o=n/2,a=-n/2,s=[],c=[],u=[],l=[];return s=[i,o,0,r,o,0,r,a,0,i,a,0],u=[0,1,2,0,2,3],c=[1,1,0,1,0,0,1,0],l=[0,0,1,0,0,1,0,0,1,0,0,1],{vertices:s,faces:t.GeometryUtils.convertToFaces(u,l),texCoords:c}},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"width",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"height",void 0),n}(t.Geometry);t.RectGeometry=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.width=null,this.height=null,this.widthSegments=1,this.heightSegments=1}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.computeData=function(){var e=this.width,n=this.height,r=this.widthSegments,i=this.heightSegments,o=null,a=null,s=null,c=null,u=null,l=null,h=null,d=[],p=[],f=[],_=[];for(l=0;r>=l;l++)for(h=0;i>=h;h++)o=-e+2*e*l/r,a=0,s=-(-n+2*n*h/i),c=l/r,u=h/i,d.push(o,a,s),f.push(0,1,0),p.push(c,u),r>l&&i>h&&(_.push(h+l*(r+1),h+(l+1)*(r+1),h+l*(r+1)+1),_.push(h+(l+1)*(r+1),h+(l+1)*(r+1)+1,h+l*(r+1)+1));return{vertices:d,faces:t.GeometryUtils.convertToFaces(_,f),texCoords:p}},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"width",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"height",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"widthSegments",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"heightSegments",void 0),n}(t.Geometry);t.PlaneGeometry=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.LATITUDELONGTITUDE=0]="LATITUDELONGTITUDE"}(t.ESphereDrawMode||(t.ESphereDrawMode={}));t.ESphereDrawMode}(wd||(wd={}));var wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.radius=1,this.sphereDrawMode=t.ESphereDrawMode.LATITUDELONGTITUDE,this.segments=20}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.computeData=function(){var e=this.radius,r=(this.sphereDrawMode,this.segments),i=n.create(e,r).getData(),o=i.vertices,a=i.indices,s=i.normals,c=i.texCoords;return{vertices:o,faces:t.GeometryUtils.convertToFaces(a,s),texCoords:c}},__decorate([t.cloneAttributeAsBasicType()],r.prototype,"radius",void 0),__decorate([t.cloneAttributeAsBasicType()],r.prototype,"sphereDrawMode",void 0),__decorate([t.cloneAttributeAsBasicType()],r.prototype,"segments",void 0),__decorate([t.require(function(){t.assert(this.sphereDrawMode===t.ESphereDrawMode.LATITUDELONGTITUDE,t.Log.info.FUNC_MUST_BE("sphereDrawMode","ESphereDrawMode.LATITUDELONGTITUDE"))})],r.prototype,"computeData",null),r}(t.Geometry);t.SphereGeometry=e;var n=function(){function t(t,e){this._radius=null,this._latitudeBands=null,this._longitudeBands=null,this._radius=t,this._latitudeBands=e,this._longitudeBands=e}return t.create=function(t,e){var n=new this(t,e);return n},t.prototype.getData=function(){for(var t=[],e=[],n=[],r=[],i=0;i<=this._latitudeBands;i++)for(var o=i*Math.PI/this._latitudeBands,a=Math.sin(o),s=Math.cos(o),c=0;c<=this._longitudeBands;c++){var u=2*c*Math.PI/this._longitudeBands,l=Math.sin(u),h=Math.cos(u),d=this._radius*h*a,p=this._radius*s,f=this._radius*l*a,_=1-c/this._longitudeBands,g=1-i/this._latitudeBands;e.push(d),e.push(p),e.push(f),n.push(_),n.push(g),t.push(d),t.push(p),t.push(f)}for(var i=0;i<this._latitudeBands;i++)for(var c=0;c<this._longitudeBands;c++){var m=i*(this._longitudeBands+1)+c,y=m+this._longitudeBands+1;r.push(m+1),r.push(y),r.push(m),r.push(m+1),r.push(y+1),r.push(y)}return{vertices:t,indices:r,normals:e,texCoords:n}},t}()}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.width=null,this.height=null}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.computeData=function(){var e=this.width,n=this.height,r=-e/2,i=e/2,o=n/2,a=-n/2,s=null,c=null,u=null,l=null;return s=[0,o,0,r,a,0,i,a,0],u=[0,1,2],c=[.5,1,0,0,1,0],l=[0,0,1,0,0,1,0,0,1],{vertices:s,faces:t.GeometryUtils.convertToFaces(u,l),texCoords:c}},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"width",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"height",void 0),n}(t.Geometry);t.TriangleGeometry=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.subdivisions=1,this.range={width:10,height:10},this.minHeight=0,this.maxHeight=10,this.heightMapAsset=null}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.computeData=function(){var t=this.heightMapAsset.source,e=t.width,n=t.height;return this._createGroundFromHeightMap(this._readHeightMapData(t,e,n),e,n)},n.prototype._readHeightMapData=function(t,e,n){var r=document.createElement("canvas"),i=r.getContext("2d");return r.width=e,r.height=n,i.drawImage(t,0,0),i.getImageData(0,0,e,n).data},n.prototype._createGroundFromHeightMap=function(e,n,r){for(var i=[],o=[],a=[],s=this.subdivisions,c=this.range.width,u=this.range.height,l=0;s>=l;l++)for(var h=0;s>=h;h++){var d=h*c/s-c/2,p=(s-l)*u/s-u/2;i.push(d,this._getHeight(d,p,e,n,r),p),a.push(h/s,1-l/s)}return{vertices:i,faces:t.GeometryUtils.convertToFaces(this._getIndices(),o),texCoords:a}},n.prototype._getHeight=function(t,e,n,r,i){var o=this.range.width,a=this.range.height,s=(t+o/2)/o*(r-1)|0,c=(1-(e+a/2)/a)*(i-1)|0,u=4*(s+c*r),l=n[u]/255,h=n[u+1]/255,d=n[u+2]/255,p=.3*l+.59*h+.11*d,f=this.minHeight,_=this.maxHeight;return f+(_-f)*p},n.prototype._getIndices=function(){for(var t=[],e=this.subdivisions,n=0;e>n;n++)for(var r=0;e>r;r++)t.push(r+n*(e+1)),t.push(r+1+n*(e+1)),t.push(r+1+(n+1)*(e+1)),t.push(r+n*(e+1)),t.push(r+1+(n+1)*(e+1)),t.push(r+(n+1)*(e+1));return t},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"subdivisions",void 0),__decorate([t.cloneAttributeAsCustomType(function(t,e,n){e[n].width=t[n].width,e[n].height=t[n].height;
})],n.prototype,"range",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"minHeight",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"maxHeight",void 0),__decorate([t.cloneAttributeAsCustomType(function(e,n,r){e[r]&&(n[r]=t.ImageTextureAsset.create(e[r].source))})],n.prototype,"heightMapAsset",void 0),n}(t.Geometry);t.TerrainGeometry=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t){this._vertices=null,this._faces=null,this._texCoords=null,this._colors=null,this._tangents=null,this.tangentDirty=!0,this.colorDirty=!0,this.geometry=null,this._normalCache=null,this._normalFromFaceCache=null,this._normalFromVertexCache=null,this._indiceCache=null,this._colorCache=null,this._normalDirty=!0,this._indiceDirty=!0,this._materialColorChangeSubscription=null,this.geometry=t}return Object.defineProperty(e.prototype,"vertices",{get:function(){return this._vertices},set:function(e){this._vertices=e,this.tangentDirty=!0,this.geometry.buffers.removeCache(t.EBufferDataType.VERTICE)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"normals",{get:function(){var t=this.geometry;return t.isSmoothShading()?(this.hasVertexNormals()||this.computeVertexNormals(),this.normalsFromVertexNormals):(this.hasFaceNormals()||this.computeFaceNormals(),this.normalsFromFaceNormal)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"normalsFromFaceNormal",{get:function(){var e=null;return this.hasFaceNormals()?(e=[],this._faces.forEach(function(n){var r=n.faceNormal;t.GeometryUtils.setThreeComponent(e,r,n.aIndex),t.GeometryUtils.setThreeComponent(e,r,n.bIndex),t.GeometryUtils.setThreeComponent(e,r,n.cIndex)}),this._fillEmptyData(e),e):[]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"normalsFromVertexNormals",{get:function(){var e=null;return this.hasVertexNormals()?(e=[],this._faces.forEach(function(n){t.GeometryUtils.setThreeComponent(e,n.vertexNormals.getChild(0),n.aIndex),t.GeometryUtils.setThreeComponent(e,n.vertexNormals.getChild(1),n.bIndex),t.GeometryUtils.setThreeComponent(e,n.vertexNormals.getChild(2),n.cIndex)}),this._fillEmptyData(e),e):[]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"indices",{get:function(){for(var t=[],e=0,n=this._faces;e<n.length;e++){var r=n[e];t.push(r.aIndex,r.bIndex,r.cIndex)}return t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"faces",{get:function(){return this._faces},set:function(e){this._faces=e,this.geometry.buffers.removeCache(t.EBufferDataType.NORMAL),this.geometry.buffers.removeCache(t.EBufferDataType.INDICE),this.onChangeFace()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"texCoords",{get:function(){return this._texCoords},set:function(e){this._texCoords=e,this.tangentDirty=!0,this.geometry.buffers.removeCache(t.EBufferDataType.TEXCOORD)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"colors",{get:function(){return this._needGetColorsFromMaterial()?this._getColorsFromMaterial(this._vertices):this._colors},set:function(e){this._colors=e,this.colorDirty=!0,this.geometry.buffers.removeCache(t.EBufferDataType.COLOR)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"tangents",{get:function(){return this.tangentDirty&&(this.tangentDirty=!1,t.GeometryUtils.hasData(this.normals)&&t.GeometryUtils.hasData(this.texCoords)&&t.GeometryUtils.hasData(this.indices)&&(this._tangents=this._calculateTangents(this._vertices,this.normals,this.texCoords,this.indices))),this._tangents},enumerable:!0,configurable:!0}),e.prototype.init=function(){var e=this;this._materialColorChangeSubscription=wdFrp.fromArray([t.EventManager.fromEvent(this.geometry.entityObject,t.EEngineEvent.MATERIAL_COLOR_CHANGE),t.EventManager.fromEvent(this.geometry.entityObject,t.EEngineEvent.MATERIAL_CHANGE)]).subscribe(function(){e._needGetColorsFromMaterial()&&(e.colorDirty=!0)})},e.prototype.dispose=function(){this._materialColorChangeSubscription&&this._materialColorChangeSubscription.dispose()},e.prototype.computeFaceNormals=function(){for(var t=this._vertices,e=0,n=this._faces;e<n.length;e++){var r=n[e];r.faceNormal=this.computeFaceNormalsHelper(t,r.aIndex,r.bIndex,r.cIndex)}},e.prototype.computeVertexNormals=function(){var t=null;this.hasFaceNormals()||this.computeFaceNormals(),t=this.computeVertexNormalsHelper(this._vertices);for(var e=0,n=this._faces;e<n.length;e++){var r=n[e];r.vertexNormals=wdCb.Collection.create([t[r.aIndex],t[r.bIndex],t[r.cIndex]])}},e.prototype.hasFaceNormals=function(){for(var t=0,e=this._faces;t<e.length;t++){var n=e[t];if(!n.hasFaceNormal())return!1}return!0},e.prototype.hasVertexNormals=function(){for(var t=0,e=this._faces;t<e.length;t++){var n=e[t];if(!n.hasVertexNormal())return!1}return!0},e.prototype.onChangeFace=function(){this.tangentDirty=!0,this._normalDirty=!0,this._indiceDirty=!0},e.prototype.computeFaceNormalsHelper=function(e,n,r,i){var o=t.GeometryUtils.getThreeComponent(e,n),a=t.GeometryUtils.getThreeComponent(e,r),s=t.GeometryUtils.getThreeComponent(e,i),c=t.Vector3.create().sub2(s,a),u=t.Vector3.create().sub2(o,a);return t.Vector3.create().cross(c,u).normalize()},e.prototype.computeVertexNormalsHelper=function(e){var n=e.length/3,r=null;r=new Array(n);for(var i=0;n>i;i++)r[i]=t.Vector3.create();for(var o=0,a=this._faces;o<a.length;o++){var s=a[o],c=null;c=s.faceNormal,r[s.aIndex].add(c),r[s.bIndex].add(c),r[s.cIndex].add(c)}for(var i=0;n>i;i++)r[i].normalize();return r},e.prototype._getColorsFromMaterial=function(t){var e=[],n=0,r=this.geometry.material.color,i=r.r,o=r.g,a=r.b,s=null;for(s=t.length/3,n=0;s>n;n++)e.push(i,o,a);return e},e.prototype._fillEmptyData=function(t){for(var e=0,n=t.length;n>e;e++)isNaN(t[e])&&(t[e]=0)},e.prototype._calculateTangents=function(e,n,r,i){var o,a,s,c,u,l,h,d,p,f,_,g,m,y,v,b=i.length/3,C=e.length/3,E=t.Vector3.create(),S=t.Vector3.create(),T=t.Vector3.create(),w=t.Vector3.create(),D=t.Vector3.create(),L=t.Vector2.create(),A=t.Vector2.create(),M=t.Vector2.create(),O=new Float32Array(3*C),x=new Float32Array(3*C),N=t.Vector3.create(),R=t.Vector3.create(),U=[];for(v=0;b>v;v++)o=i[3*v],a=i[3*v+1],s=i[3*v+2],T.set(e[3*o],e[3*o+1],e[3*o+2]),w.set(e[3*a],e[3*a+1],e[3*a+2]),D.set(e[3*s],e[3*s+1],e[3*s+2]),L.set(r[2*o],r[2*o+1]),A.set(r[2*a],r[2*a+1]),M.set(r[2*s],r[2*s+1]),c=w.x-T.x,u=D.x-T.x,l=w.y-T.y,h=D.y-T.y,d=w.z-T.z,p=D.z-T.z,f=A.x-L.x,_=M.x-L.x,g=A.y-L.y,m=M.y-L.y,y=1/(f*m-_*g),E.set((m*c-g*u)*y,(m*l-g*h)*y,(m*d-g*p)*y),S.set((f*u-_*c)*y,(f*h-_*l)*y,(f*p-_*d)*y),O[3*o+0]+=E.x,O[3*o+1]+=E.y,O[3*o+2]+=E.z,O[3*a+0]+=E.x,O[3*a+1]+=E.y,O[3*a+2]+=E.z,O[3*s+0]+=E.x,O[3*s+1]+=E.y,O[3*s+2]+=E.z,x[3*o+0]+=S.x,x[3*o+1]+=S.y,x[3*o+2]+=S.z,x[3*a+0]+=S.x,x[3*a+1]+=S.y,x[3*a+2]+=S.z,x[3*s+0]+=S.x,x[3*s+1]+=S.y,x[3*s+2]+=S.z;for(g=t.Vector3.create(),m=t.Vector3.create(),v=0;C>v;v++){var F=null;N.set(n[3*v],n[3*v+1],n[3*v+2]),g.set(O[3*v],O[3*v+1],O[3*v+2]),m.set(x[3*v],x[3*v+1],x[3*v+2]),F=N.dot(g),R=N.clone().scale(F),R.sub2(g,R).normalize(),U[4*v]=R.x,U[4*v+1]=R.y,U[4*v+2]=R.z,R.cross(N,g),U[4*v+3]=R.dot(m)<0?-1:1}return U},e.prototype._needGetColorsFromMaterial=function(){var t=this._colors;return!t||0===t.length},__decorate([t.requireGetter(function(){t.assert(this._faces.length>0,t.Log.info.FUNC_SHOULD("faces.count","> 0"));for(var e=0,n=this._faces;e<n.length;e++){var r=n[e];this.geometry.isSmoothShading()&&t.assert(r.vertexNormals&&3===r.vertexNormals.getCount(),t.Log.info.FUNC_SHOULD("faces->vertexNormals.count","=== 3"))}}),t.cacheGetter(function(){return!this._normalDirty&&this._normalCache},function(){return this._normalCache},function(t){this._normalCache=t,this._normalDirty=!1})],e.prototype,"normals",null),__decorate([t.requireGetter(function(){t.assert(this._faces.length>0,t.Log.info.FUNC_SHOULD("geometry","has faces"))}),t.ensureGetter(function(e){for(var n=0,r=e;n<r.length;n++){var i=r[n];t.assert(t.JudgeUtils.isNumber(i),t.Log.info.FUNC_SHOULD("normals data","be number"))}}),t.cacheGetter(function(){return!this._normalDirty&&this._normalFromFaceCache},function(){return this._normalFromFaceCache},function(t){this._normalFromFaceCache=t,this._normalDirty=!1})],e.prototype,"normalsFromFaceNormal",null),__decorate([t.requireGetter(function(){t.assert(this._faces.length>0,t.Log.info.FUNC_SHOULD("geometry","has faces"))}),t.ensureGetter(function(e){for(var n=0,r=e;n<r.length;n++){var i=r[n];t.assert(t.JudgeUtils.isNumber(i),t.Log.info.FUNC_SHOULD("normals data","be number"))}}),t.cacheGetter(function(){return!this._normalDirty&&this._normalFromVertexCache},function(){return this._normalFromVertexCache},function(t){this._normalFromVertexCache=t,this._normalDirty=!1})],e.prototype,"normalsFromVertexNormals",null),__decorate([t.cacheGetter(function(){return!this._indiceDirty&&this._indiceCache},function(){return this._indiceCache},function(t){this._indiceCache=t,this._indiceDirty=!1})],e.prototype,"indices",null),__decorate([t.ensureGetter(function(e){t.assert(e.length===this._vertices.length,t.Log.info.FUNC_SHOULD("colors.length:"+e.length,"=== vertices.length:"+this._vertices.length))}),t.cacheGetter(function(){return!this.colorDirty&&this._colorCache},function(){return this._colorCache},function(t){this._colorCache=t,this.colorDirty=!1})],e.prototype,"colors",null),__decorate([t.require(function(){t.assert(t.GeometryUtils.hasData(this.vertices),t.Log.info.FUNC_MUST("contain vertices"))}),t.ensure(function(){for(var e=0,n=this._faces;e<n.length;e++){var r=n[e];t.assert(r.faceNormal instanceof t.Vector3,t.Log.info.FUNC_SHOULD_NOT("faceNormal","be null"))}})],e.prototype,"computeFaceNormals",null),__decorate([t.virtual],e.prototype,"onChangeFace",null),e}();t.GeometryData=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e}(t.GeometryData);t.CommonGeometryData=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._morphTargets=null,this._morphNormalCache=null,this._morphNormalDirty=!0}return __extends(n,e),n.create=function(t){var e=new this(t);return e},Object.defineProperty(n.prototype,"morphNormals",{get:function(){var t=this.geometry;return this._morphNormalDirty=!1,t.isSmoothShading()?(this.hasMorphVertexNormals()||this.computeMorphNormals(),t.morphVertexNormals):(this.hasMorphFaceNormals()||this.computeMorphNormals(),t.morphFaceNormals)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"morphTargets",{get:function(){return this._morphTargets},set:function(t){this._morphTargets=t,this._morphNormalDirty=!0},enumerable:!0,configurable:!0}),n.prototype.computeMorphNormals=function(){var t=this.geometry,e=this;this._morphTargets.forEach(function(r,i){var o=wdCb.Collection.create(),a=wdCb.Collection.create();r.forEach(function(r){var i=n.create(t),s=null,c=null;i.vertices=r,i.faces=e._copyFaces(t.faces),i.computeFaceNormals(),i.computeVertexNormals(),u=e._getMorphNormals(i),s=u[0],c=u[1],o.addChild(s),a.addChild(c);var u}),t.morphFaceNormals.addChild(i,o),t.morphVertexNormals.addChild(i,a)})},n.prototype.hasMorphFaceNormals=function(){return this.geometry.morphFaceNormals.getCount()>0},n.prototype.hasMorphVertexNormals=function(){return this.geometry.morphVertexNormals.getCount()>0},n.prototype.onChangeFace=function(){this._morphNormalDirty=!0},n.prototype._copyFaces=function(t){for(var e=[],n=0,r=t;n<r.length;n++){var i=r[n];e.push(i.clone())}return e},n.prototype._getMorphNormals=function(t){return[t.normalsFromFaceNormal,t.normalsFromVertexNormals]},__decorate([t.cacheGetter(function(){return!this._morphNormalDirty&&this._morphNormalCache},function(){return this._morphNormalCache},function(t){this._morphNormalCache=t})],n.prototype,"morphNormals",null),n}(t.GeometryData);t.MorphGeometryData=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t){this.geometryData=null,this.entityObject=null,this.container=wdCb.Hash.create(),this._colorBuffer=null,this._texCoordBuffer=null,this._tangentBuffer=null,this._indiceBuffer=null,this._materialChangeSubscription=null,this.entityObject=t}return e.prototype.init=function(){var e=this;this._materialChangeSubscription=t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.MATERIAL_CHANGE).subscribe(function(){e.removeCache(t.EBufferDataType.COLOR),e.geometryData.colorDirty=!0}),this.geometryData.init()},e.prototype.removeCache=function(t){this.container.removeChild(t)},e.prototype.getChild=function(e){var n=null;switch(e){case t.EBufferDataType.VERTICE:n=this.getVertice(e);break;case t.EBufferDataType.NORMAL:n=this.getNormal(e);break;case t.EBufferDataType.TANGENT:n=this._getTangent(e);break;case t.EBufferDataType.COLOR:n=this._getColor(e);break;case t.EBufferDataType.INDICE:n=this._getIndice(e);break;case t.EBufferDataType.TEXCOORD:n=this._getTexCoord(e);break;default:wdCb.Log.error(!0,wdCb.Log.info.FUNC_UNKNOW("EBufferDataType: "+e))}return n},e.prototype.dispose=function(){this.container.forEach(function(t){t.dispose()}),this.geometryData.dispose(),this._materialChangeSubscription&&this._materialChangeSubscription.dispose()},e.prototype.createBuffersFromGeometryData=function(){this.getChild(t.EBufferDataType.VERTICE),this.getChild(t.EBufferDataType.NORMAL),this.getChild(t.EBufferDataType.TANGENT),this.getChild(t.EBufferDataType.COLOR),this.getChild(t.EBufferDataType.INDICE),this.getChild(t.EBufferDataType.TEXCOORD)},e.prototype.createOnlyOnceAndUpdateArrayBuffer=function(e,n,r,i,o,a){void 0===i&&(i=t.EBufferType.FLOAT),void 0===o&&(o=0),void 0===a&&(a=t.EBufferUsage.STATIC_DRAW);var s=this[e];return s?void s.resetData(n,r,i,o):void(this[e]=t.ArrayBuffer.create(n,r,i,a))},e.prototype.createOnlyOnceAndUpdateElememntBuffer=function(e,n,r,i,o){void 0===r&&(r=null),void 0===i&&(i=0),void 0===o&&(o=t.EBufferUsage.STATIC_DRAW);var a=this[e];return a?void a.resetData(n,r,i):void(this[e]=t.ElementBuffer.create(n,r,o))},e.prototype.hasData=function(t){return t&&t.length>0},e.prototype._getTangent=function(e){var n=null;return n=this.geometryData[t.BufferDataTable.getGeometryDataName(e)],this.hasData(n)?(this.createOnlyOnceAndUpdateArrayBuffer("_tangentBuffer",n,3),this._tangentBuffer):null},e.prototype._getColor=function(e){var n=null;return n=this.geometryData[t.BufferDataTable.getGeometryDataName(e)],this.hasData(n)?(this.createOnlyOnceAndUpdateArrayBuffer("_colorBuffer",n,3),this._colorBuffer):null},e.prototype._getIndice=function(e){var n=null;return n=this.geometryData[t.BufferDataTable.getGeometryDataName(e)],this.hasData(n)?(this.createOnlyOnceAndUpdateElememntBuffer("_indiceBuffer",n),this._indiceBuffer):null},e.prototype._getTexCoord=function(e){var n=null;return n=this.geometryData[t.BufferDataTable.getGeometryDataName(e)],this.hasData(n)?(this.createOnlyOnceAndUpdateArrayBuffer("_texCoordBuffer",n,2),this._texCoordBuffer):null},e.prototype._needReCalcuteTangent=function(e){return this.geometryData.tangentDirty&&e===t.EBufferDataType.TANGENT},__decorate([t.cache(function(t){return this.container.hasChild(t)&&!this._needReCalcuteTangent(t)},function(t){return this.container.getChild(t)},function(t,e){this.container.addChild(e,t)})],e.prototype,"_getTangent",null),__decorate([t.cache(function(t){return this.container.hasChild(t)},function(t){return this.container.getChild(t)},function(t,e){this.container.addChild(e,t)})],e.prototype,"_getColor",null),__decorate([t.cache(function(t){return this.container.hasChild(t)},function(t){return this.container.getChild(t)},function(t,e){this.container.addChild(e,t)})],e.prototype,"_getIndice",null),__decorate([t.cache(function(t){return this.container.hasChild(t)},function(t){return this.container.getChild(t)},function(t,e){this.container.addChild(e,t)})],e.prototype,"_getTexCoord",null),e}();t.BufferContainer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._verticeBuffer=null,this._normalBuffer=null}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.getBufferForRenderSort=function(){var e=this.getChild(t.EBufferDataType.VERTICE);return e?e:null},n.prototype.getVertice=function(e){var n=this.geometryData[t.BufferDataTable.getGeometryDataName(e)];return this.hasData(n)?(this.createOnlyOnceAndUpdateArrayBuffer("_verticeBuffer",n,3),this._verticeBuffer):null},n.prototype.getNormal=function(e){var n=this.geometryData[t.BufferDataTable.getGeometryDataName(e)];return this.hasData(n)?(this.createOnlyOnceAndUpdateArrayBuffer("_normalBuffer",n,3),this._normalBuffer):null},__decorate([t.cache(function(t){return this.container.hasChild(t)},function(t){return this.container.getChild(t)},function(t,e){this.container.addChild(e,t)})],n.prototype,"getVertice",null),__decorate([t.cache(function(t){return this.container.hasChild(t)},function(t){return this.container.getChild(t)},function(t,e){this.container.addChild(e,t)})],n.prototype,"getNormal",null),n}(t.BufferContainer);t.CommonBufferContainer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(t,n){e.call(this,t),this._animation=null,this._isCacheChangeFlag={},this._isCacheChangeInLastLoop={},this._currentVerticeBuffer=null,this._nextVerticeBuffer=null,this._currentNormalBuffer=null,this._nextNormalBuffer=null,this._animation=n}return __extends(n,e),n.create=function(t,e){var n=new this(t,e);return n},n.prototype.getBufferForRenderSort=function(){return null},n.prototype.getVertice=function(t){return this._getMorphData(t,this.geometryData.morphTargets)},n.prototype.getNormal=function(t){return this._getMorphData(t,this.geometryData.morphNormals)},n.prototype._getMorphData=function(t,e){var n=null,r=null,i=null;if(this._isNotPlayAnimation())return this._getStaticData(t);if(0===e.getCount())return null;if(r=this._getFrames(e),n=this.container.getChild(t))if(this._animation.isFrameChange&&(this._isCacheChangeInLastLoop[t]||this._isCacheNotChange(t))){var o=n[0],a=n[1],s=null,c=null;s=a,c=o.resetData(r.getChild(this._animation.nextFrame)),i=[s,c],this.container.addChild(t,i),this._isCacheChangeFlag[t]=!0,this._isCacheChangeInLastLoop[t]=!0}else this._isCacheChangeFlag[t]=!1,this._isCacheChangeInLastLoop[t]=!1,i=n;else{var o=this._getCurrentBufferWhichIsCreatedOnlyOnce(t,r.getChild(this._animation.currentFrame),3),a=this._getNextBufferWhichIsCreatedOnlyOnce(t,r.getChild(this._animation.nextFrame),3);i=[o,a],this.container.addChild(t,i),this._isCacheChangeInLastLoop[t]=!1}return i},n.prototype._getFrames=function(t){return t.getChild(this._animation.currentAnimName)},n.prototype._getCurrentBufferWhichIsCreatedOnlyOnce=function(e,n,r){return e===t.EBufferDataType.VERTICE?(this.createOnlyOnceAndUpdateArrayBuffer("_currentVerticeBuffer",n,r,t.EBufferType.FLOAT,0,t.EBufferUsage.DYNAMIC_DRAW),this._currentVerticeBuffer):(this.createOnlyOnceAndUpdateArrayBuffer("_currentNormalBuffer",n,r,t.EBufferType.FLOAT,0,t.EBufferUsage.DYNAMIC_DRAW),this._currentNormalBuffer)},n.prototype._getNextBufferWhichIsCreatedOnlyOnce=function(e,n,r){return e===t.EBufferDataType.VERTICE?(this.createOnlyOnceAndUpdateArrayBuffer("_nextVerticeBuffer",n,r,t.EBufferType.FLOAT,0,t.EBufferUsage.DYNAMIC_DRAW),this._nextVerticeBuffer):(this.createOnlyOnceAndUpdateArrayBuffer("_nextNormalBuffer",n,r,t.EBufferType.FLOAT,0,t.EBufferUsage.DYNAMIC_DRAW),this._nextNormalBuffer)},n.prototype._isCacheNotChange=function(t){return!this._isCacheChangeFlag[t]},n.prototype._isNotPlayAnimation=function(){return null===this._animation.currentAnimName},n.prototype._getStaticData=function(e){var n=null,r=null;switch(e){case t.EBufferDataType.VERTICE:n=this.geometryData.vertices;break;case t.EBufferDataType.NORMAL:n=this.geometryData.normals;break;default:t.Log.error(!0,t.Log.info.FUNC_SHOULD("type","be EBufferDataType.VERTICE or EBufferDataType.NORMAL"))}return this.hasData(n)?(this._animation.interpolation=0,r=[this._getCurrentBufferWhichIsCreatedOnlyOnce(e,n,3),this._getNextBufferWhichIsCreatedOnlyOnce(e,n,3)]):null},n.prototype._getStaticDataCacheData=function(t){return"static_"+t},__decorate([t.require(function(e){t.assert(this.geometryData.morphTargets&&this.geometryData.morphTargets.getCount()>0,t.Log.info.FUNC_SHOULD("set morphTargets"))})],n.prototype,"getVertice",null),__decorate([t.require(function(e){t.assert(this.geometryData.morphTargets&&this.geometryData.morphTargets.getCount()>0,t.Log.info.FUNC_SHOULD("set morphTargets"))})],n.prototype,"getNormal",null),__decorate([t.ensure(function(t){wdCb.Log.error(!t,wdCb.Log.info.FUNC_SHOULD('"'+this._animation.currentAnimName+'" animation',"contain frame data"))})],n.prototype,"_getFrames",null),__decorate([t.require(function(e,n,r){t.assert(e===t.EBufferDataType.VERTICE||e===t.EBufferDataType.NORMAL,t.Log.info.FUNC_SHOULD("type","be EBufferDataType.VERTICE or EBufferDataType.NORMAL"))})],n.prototype,"_getCurrentBufferWhichIsCreatedOnlyOnce",null),__decorate([t.require(function(e,n,r){t.assert(e===t.EBufferDataType.VERTICE||e===t.EBufferDataType.NORMAL,t.Log.info.FUNC_SHOULD("type","be EBufferDataType.VERTICE or EBufferDataType.NORMAL"))})],n.prototype,"_getNextBufferWhichIsCreatedOnlyOnce",null),__decorate([t.cache(function(t){return this.container.hasChild(this._getStaticDataCacheData(t))},function(t){return this.container.getChild(this._getStaticDataCacheData(t))},function(t,e){this.container.addChild(this._getStaticDataCacheData(e),t)})],n.prototype,"_getStaticData",null),n}(t.BufferContainer);t.MorphBufferContainer=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._worldToCameraMatrix=null,this._near=null,this._far=null,this.pMatrix=t.Matrix4.create(),this.entityObject=null,this.dirty=!1}return Object.defineProperty(e.prototype,"cameraToWorldMatrix",{get:function(){return this.entityObject.transform.localToWorldMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"worldToCameraMatrix",{get:function(){return this._worldToCameraMatrix?this._worldToCameraMatrix:this.cameraToWorldMatrix.clone().invert()},set:function(t){this._worldToCameraMatrix=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"near",{get:function(){return this._near},set:function(t){this._near=t,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"far",{get:function(){return this._far},set:function(t){this._far=t,this.dirty=!0},enumerable:!0,configurable:!0}),e.prototype.init=function(){this.dirty&&(this.updateProjectionMatrix(),this.dirty=!1)},e.prototype.dispose=function(){},e.prototype.clone=function(){return t.CloneUtils.clone(this)},e.prototype.update=function(t){this.dirty&&(this.updateProjectionMatrix(),this.dirty=!1)},e.prototype.getInvViewProjMat=function(){return this.pMatrix.clone().multiply(this.worldToCameraMatrix).invert()},__decorate([t.requireGetter(function(){t.assert(this.entityObject,t.Log.info.FUNC_MUST_DEFINE("entityObject"))})],e.prototype,"cameraToWorldMatrix",null),__decorate([t.cloneAttributeAsBasicType()],e.prototype,"near",null),__decorate([t.cloneAttributeAsBasicType()],e.prototype,"far",null),__decorate([t.cloneAttributeAsCloneable()],e.prototype,"pMatrix",void 0),__decorate([t.virtual],e.prototype,"init",null),__decorate([t.virtual],e.prototype,"dispose",null),e}();t.Camera=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._left=null,this._right=null,this._bottom=null,this._top=null}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"left",{get:function(){return this._left},set:function(t){this._left=t,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"right",{get:function(){return this._right},set:function(t){this._right=t,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"bottom",{get:function(){return this._bottom},set:function(t){this._bottom=t,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"top",{get:function(){return this._top},set:function(t){this._top=t,this.dirty=!0},enumerable:!0,configurable:!0}),n.prototype.convertScreenToWorld=function(e,n,r){var i=t.DeviceManager.getInstance(),o=i.view.width,a=i.view.height,s=t.Vector3.create(2*e/o-1,(a-n)/a*2-1,(r-this.far)/(this.far-this.near)*2+1);return this.getInvViewProjMat().multiplyPoint(s)},n.prototype.updateProjectionMatrix=function(){this.pMatrix.setOrtho(this._left,this._right,this._bottom,this._top,this.near,this.far)},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"left",null),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"right",null),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"bottom",null),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"top",null),n}(t.Camera);t.OrthographicCamera=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._fovy=null,this._aspect=null}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"fovy",{get:function(){return this._fovy},set:function(t){this._fovy=t,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"aspect",{get:function(){return this._aspect},set:function(t){this._aspect=t,this.dirty=!0},enumerable:!0,configurable:!0}),n.prototype.zoomIn=function(t,e){void 0===e&&(e=1),this.fovy=Math.max(this.fovy-t,e)},n.prototype.zoomOut=function(t,e){void 0===e&&(e=179),this.fovy=Math.min(this.fovy+t,e)},n.prototype.convertScreenToWorld=function(e,n,r){var i=t.DeviceManager.getInstance(),o=i.view.width,a=i.view.height,s=t.Vector3.create(2*e/o-1,1-2*n/a,1),c=this.getInvViewProjMat(),u=null,l=null;return u=c.multiplyPoint(s),l=s.x*c.values[3]+s.y*c.values[7]+s.z*c.values[11]+c.values[15],u.scale(1/l),t.Vector3.create().lerp(this.entityObject.transform.position,u,r/this.far)},n.prototype.updateProjectionMatrix=function(){this.pMatrix.setPerspective(this._fovy,this._aspect,this.near,this.far)},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"fovy",null),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"aspect",null),n}(t.Camera);t.PerspectiveCamera=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(t){e.call(this),this.camera=null,this._worldToCameraMatrixCache=null,this._clearCacheSubscription=null,this.camera=t}return __extends(n,e),Object.defineProperty(n.prototype,"cameraToWorldMatrix",{get:function(){return this.camera.cameraToWorldMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"worldToCameraMatrix",{get:function(){return this._getWorldToCameraMatrix()},set:function(t){this.camera.worldToCameraMatrix=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"pMatrix",{get:function(){return this.camera.pMatrix},set:function(t){this.camera.pMatrix=t},enumerable:!0,configurable:!0}),n.prototype.init=function(){this.camera.entityObject=this.entityObject,this.camera.init(),this.bindClearCacheEvent()},n.prototype.update=function(t){this.camera.update(t)},n.prototype.dispose=function(){this.camera.dispose(),this.disposeClearCacheEvent()},n.prototype.clone=function(){return t.CloneUtils.clone(this)},n.prototype.isIntersectWithRay=function(e,n,r){var i=null;return e.hasComponent(t.Collider)?(i=e.getComponent(t.Collider).shape,i.isIntersectWithRay(this.createRay(n,r))):!1},n.prototype.createRay=function(e,n){var r=this.convertScreenToWorld(e,n,this.camera.near),i=this.convertScreenToWorld(e,n,this.camera.far);return t.Ray.create(r,i.sub(r))},n.prototype.convertScreenToWorld=function(t,e,n){return this.camera.convertScreenToWorld(t,e,n)},n.prototype.getPlanes=function(){for(var e=[],n=this.worldToCameraMatrix.applyMatrix(this.pMatrix,!0),r=0;6>r;r++)e.push(t.Plane.create(0,0,0,0));return this._setPlanes(n,e),e},n.prototype.bindClearCacheEvent=function(){var e=this;this._clearCacheSubscription=wdFrp.fromArray([t.EventManager.fromEvent(t.EEngineEvent.ENDLOOP),t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.TRANSFORM_TRANSLATE),t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.TRANSFORM_ROTATE),t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.TRANSFORM_SCALE)]).mergeAll().subscribe(function(){e._clearCache()})},n.prototype.disposeClearCacheEvent=function(){this._clearCacheSubscription&&this._clearCacheSubscription.dispose()},n.prototype._setPlanes=function(t,e){e[0].normal.x=t.values[3]+t.values[2],e[0].normal.y=t.values[7]+t.values[6],e[0].normal.z=t.values[11]+t.values[10],e[0].d=t.values[15]+t.values[14],e[0].normalize(),e[1].normal.x=t.values[3]-t.values[2],e[1].normal.y=t.values[7]-t.values[6],e[1].normal.z=t.values[11]-t.values[10],e[1].d=t.values[15]-t.values[14],e[1].normalize(),e[2].normal.x=t.values[3]+t.values[0],e[2].normal.y=t.values[7]+t.values[4],e[2].normal.z=t.values[11]+t.values[8],e[2].d=t.values[15]+t.values[12],e[2].normalize(),e[3].normal.x=t.values[3]-t.values[0],e[3].normal.y=t.values[7]-t.values[4],e[3].normal.z=t.values[11]-t.values[8],e[3].d=t.values[15]-t.values[12],e[3].normalize(),e[4].normal.x=t.values[3]-t.values[1],e[4].normal.y=t.values[7]-t.values[5],e[4].normal.z=t.values[11]-t.values[9],e[4].d=t.values[15]-t.values[13],e[4].normalize(),e[5].normal.x=t.values[3]+t.values[1],e[5].normal.y=t.values[7]+t.values[5],e[5].normal.z=t.values[11]+t.values[9],e[5].d=t.values[15]+t.values[13],e[5].normalize()},n.prototype._clearCache=function(){this._worldToCameraMatrixCache=null},n.prototype._getWorldToCameraMatrix=function(){return this.camera.worldToCameraMatrix},__decorate([t.cacheGetter(function(){return null!==this._worldToCameraMatrixCache},function(){return this._worldToCameraMatrixCache},function(t){this._worldToCameraMatrixCache=t})],n.prototype,"worldToCameraMatrix",null),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"camera",void 0),__decorate([t.virtual],n.prototype,"bindClearCacheEvent",null),__decorate([t.virtual],n.prototype,"disposeClearCacheEvent",null),n}(t.Component);t.CameraController=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e.prototype.bindClearCacheEvent=function(){},e.prototype.disposeClearCacheEvent=function(){},e}(t.CameraController);t.RenderTargetRendererCameraController=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e}(t.CameraController);t.BasicCameraController=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(n){e.call(this,n),this._control=null,n instanceof t.PerspectiveCamera?this._control=t.FlyPerspectiveCameraControl.create(n):this._control=t.FlyOrthographicCameraControl.create(n)}return __extends(n,e),n.create=function(t){var e=new this(t);return e},Object.defineProperty(n.prototype,"moveSpeed",{get:function(){return this._control.moveSpeed},set:function(t){this._control.moveSpeed=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"rotateSpeed",{get:function(){return this._control.rotateSpeed},set:function(t){this._control.rotateSpeed=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"zoomSpeed",{get:function(){return this._control.zoomSpeed},set:function(t){this._control.zoomSpeed=t},enumerable:!0,configurable:!0}),n.prototype.init=function(){e.prototype.init.call(this),this._control.init(this.entityObject)},n.prototype.update=function(t){e.prototype.update.call(this,t),this._control.update(t)},n.prototype.dispose=function(){e.prototype.dispose.call(this),this._control.dispose()},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"moveSpeed",null),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"rotateSpeed",null),__decorate([t.requireGetterAndSetter(function(){t.assert(this._control instanceof t.FlyPerspectiveCameraControl,t.Log.info.FUNC_MUST_BE("FlyPerspectiveCameraControl"))},function(){t.assert(this._control instanceof t.FlyPerspectiveCameraControl,t.Log.info.FUNC_MUST_BE("FlyPerspectiveCameraControl"));
}),t.cloneAttributeAsBasicType()],n.prototype,"zoomSpeed",null),n}(t.CameraController);t.FlyCameraController=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t){this.moveSpeed=1.2,this.rotateSpeed=100,this.cameraComponent=null,this._rotateX=0,this._rotateY=0,this._isRotate=!1,this._mouseDragSubscription=null,this._keydownSubscription=null,this._gameObject=null,this.cameraComponent=t}return e.prototype.init=function(t){var e=t.transform.eulerAngles;this._rotateX=e.x,this._rotateY=e.y,this._gameObject=t,this._bindCanvasEvent()},e.prototype.update=function(e){this._isRotate&&(this._isRotate=!1,this._gameObject.transform.eulerAngles=t.Vector3.create(this._rotateX,this._rotateY,0))},e.prototype.dispose=function(){this._removeEvent()},e.prototype._move=function(e){var n=this.moveSpeed,r=this._gameObject,i=e.keyState;i.a||i.left?r.transform.translateLocal(t.Vector3.create(-n,0,0)):i.d||i.right?r.transform.translateLocal(t.Vector3.create(n,0,0)):i.w||i.up?r.transform.translateLocal(t.Vector3.create(0,0,-n)):(i.s||i.down)&&r.transform.translateLocal(t.Vector3.create(0,0,n))},e.prototype._bindCanvasEvent=function(){var e=this,n=this.rotateSpeed,r=t.EventManager.fromEvent(t.Director.getInstance().scene,t.EEngineEvent.MOUSE_DRAG),i=t.EventManager.fromEvent(t.EEventName.KEYDOWN),o=t.Director.getInstance().view;this._mouseDragSubscription=r.map(function(t){var r=t.userData.movementDelta,i=null,a=null,s=n/o.height;return i=s*r.x,a=s*r.y,e._isRotate=!0,{dx:i,dy:a}}).subscribe(function(t){e._rotateY-=t.dx,e._rotateX-=t.dy}),this._keydownSubscription=i.subscribe(function(t){e._move(t),e.zoom(t)})},e.prototype._removeEvent=function(){this._mouseDragSubscription.dispose(),this._keydownSubscription.dispose()},e}();t.FlyCameraControl=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.zoomSpeed=10}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e.prototype.zoom=function(t){var e=this.zoomSpeed,n=t.keyState;n.g?this.cameraComponent.zoomIn(e):n.h&&this.cameraComponent.zoomOut(e)},e}(t.FlyCameraControl);t.FlyPerspectiveCameraControl=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e.prototype.zoom=function(t){},e}(t.FlyCameraControl);t.FlyOrthographicCameraControl=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.moveSpeedX=1,this.moveSpeedY=1,this.rotateSpeed=1,this.wheelSpeed=1,this.distance=10,this.phi=Math.PI/2,this.theta=Math.PI/2,this.target=t.Vector3.create(0,0,0),this.thetaMargin=.05,this.minDistance=.05,this._isChange=!0,this._mouseDragSubscription=null,this._mouseWheelSubscription=null,this._keydownSubscription=null}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.init=function(){e.prototype.init.call(this),this._bindCanvasEvent()},n.prototype.update=function(n){var r=null,i=null,o=null;e.prototype.update.call(this,n),this._isChange&&(this._isChange=!1,r=this.distance*Math.cos(this.phi)*Math.sin(this.theta)+this.target.x,o=this.distance*Math.sin(this.phi)*Math.sin(this.theta)+this.target.z,i=this.distance*Math.cos(this.theta)+this.target.y,this.entityObject.transform.position=t.Vector3.create(r,i,o),this.entityObject.transform.lookAt(this.target))},n.prototype.dispose=function(){e.prototype.dispose.call(this),this._removeEvent()},n.prototype._bindCanvasEvent=function(){var e=this,n=t.Director.getInstance().scene,r=t.EventManager.fromEvent(n,t.EEngineEvent.MOUSE_WHEEL),i=t.EventManager.fromEvent(n,t.EEngineEvent.MOUSE_DRAG),o=t.EventManager.fromEvent(t.EEventName.KEYDOWN);this._mouseDragSubscription=i.subscribe(function(t){e._changeOrbit(t.userData)}),this._mouseWheelSubscription=r.subscribe(function(t){var n=t.userData;n.preventDefault(),e._changeDistance(n)}),this._keydownSubscription=o.subscribe(function(t){e._changeTarget(t)})},n.prototype._changeOrbit=function(t){var e=t.movementDelta;this._isChange=!0,this.phi+=e.x/(100/this.rotateSpeed),this.theta-=e.y/(100/this.rotateSpeed),this._contrainTheta()},n.prototype._changeTarget=function(e){var n=this.moveSpeedX,r=this.moveSpeedY,i=null,o=null,a=e.keyState,s=this.entityObject.transform;this._isChange=!0,a.a||a.left?i=-n:a.d||a.right?i=n:a.w||a.up?o=r:(a.s||a.down)&&(o=-r),this.target.add(t.Vector3.create(s.right.x*i,0,s.right.z*i)),this.target.add(t.Vector3.create(s.up.x*o,s.up.y*o,0))},n.prototype._changeDistance=function(t){this._isChange=!0,this.distance-=this.wheelSpeed*t.wheel,this._contrainDistance()},n.prototype._contrainDistance=function(){this.distance=t.MathUtils.bigThan(this.distance,this.minDistance)},n.prototype._contrainTheta=function(){this.theta=t.MathUtils.clamp(this.theta,this.thetaMargin,Math.PI-this.thetaMargin)},n.prototype._removeEvent=function(){this._mouseDragSubscription.dispose(),this._mouseWheelSubscription.dispose(),this._keydownSubscription.dispose()},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"moveSpeedX",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"moveSpeedY",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"rotateSpeed",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"wheelSpeed",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"distance",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"phi",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"theta",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"target",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"thetaMargin",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"minDistance",void 0),n}(t.CameraController);t.ArcballCameraController=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.p_target=null,this.isFinish=!1}return __extends(n,e),Object.defineProperty(n.prototype,"isStart",{get:function(){return!this.isStop},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isStop",{get:function(){return t.Log.error(!0,t.Log.info.ABSTRACT_ATTRIBUTE)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isPause",{get:function(){return t.Log.error(!0,t.Log.info.ABSTRACT_ATTRIBUTE)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"target",{get:function(){return this.p_target},set:function(t){this.p_target=t},enumerable:!0,configurable:!0}),n.prototype.clone=function(){return t.CloneUtils.clone(this)},n.prototype.reset=function(){this.isFinish=!1},n.prototype.addToObject=function(n,r){void 0===r&&(r=!1);var i=t.ActionEngine.getInstance();e.prototype.addToObject.call(this,n,r),this.target=n,i.hasChild(this)||i.addChild(this)},n.prototype.removeFromObject=function(n){e.prototype.removeFromObject.call(this,n),t.ActionEngine.getInstance().removeChild(this)},n.prototype.init=function(){this.start()},n.prototype.finish=function(){this.isFinish=!0,this.stop()},n}(t.Component);t.Action=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),Object.defineProperty(e.prototype,"isStop",{get:function(){return!1},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isPause",{get:function(){return!1},enumerable:!0,configurable:!0}),e.prototype.start=function(){},e.prototype.stop=function(){},e.prototype.pause=function(){},e.prototype.resume=function(){},e}(t.Action);t.ActionInstant=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(n,r,i){e.call(this),this._context=null,this._callFunc=null,this._dataArr=null,this._context=r||t.root,this._callFunc=n,this._dataArr=wdCb.Collection.create(i)}return __extends(n,e),n.create=function(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];var i=Array.prototype.slice.call(arguments,2),o=new this(t,e,i);return o},n.prototype.reverse=function(){return this},n.prototype.update=function(t){this._callFunc&&this._callFunc.call(this._context,this.p_target,this._dataArr),this.finish()},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"_context",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"_callFunc",void 0),__decorate([t.cloneAttributeAsCustomType(function(t,e,n,r){e[n]=t[n].clone(!0)})],n.prototype,"_dataArr",void 0),n}(t.ActionInstant);t.CallFunc=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.elapsed=null,this.duration=null,this._isStop=!0,this._isPause=!1,this._timeController=t.CommonTimeController.create()}return __extends(n,e),Object.defineProperty(n.prototype,"isStop",{get:function(){return this._isStop},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isPause",{get:function(){return this._isPause},enumerable:!0,configurable:!0}),n.prototype.update=function(t){t<this._timeController.startTime||(this.elapsed=this._convertToRatio(this._timeController.computeElapseTime(t)),this.updateBody(t),1===this.elapsed&&this.finish())},n.prototype.start=function(){this._isStop=!1,this._timeController.start()},n.prototype.stop=function(){this._isStop=!0,this._timeController.stop()},n.prototype.reset=function(){e.prototype.reset.call(this),this._isStop=!0},n.prototype.pause=function(){this._isPause=!0,this._timeController.pause()},n.prototype.resume=function(){this._isPause=!1,this._timeController.resume()},n.prototype.updateBody=function(t){},n.prototype._convertToRatio=function(t){var e=t/this.duration;return e>1?1:e},__decorate([t.virtual],n.prototype,"updateBody",null),n}(t.Action);t.ActionInterval=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),Object.defineProperty(e.prototype,"target",{set:function(t){this.p_target=t,this.getInnerActions().forEach(function(e){e.target=t})},enumerable:!0,configurable:!0}),e.prototype.init=function(){t.prototype.init.call(this),this.iterate("init")},e.prototype.reverse=function(){return this.iterate("reverse"),this},e.prototype.reset=function(){return t.prototype.reset.call(this),this.iterate("reset"),this},e.prototype.iterate=function(t,e){this.getInnerActions().forEach(function(n){n[t].apply(n,e)})},e}(t.ActionInterval);t.Control=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(t){e.call(this),this._actions=wdCb.Collection.create(),this._currentAction=null,this._actionIndex=0,this._actions.addChildren(t)}return __extends(n,e),n.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=new this(t);return n.initWhenCreate(),n},n.prototype.initWhenCreate=function(){this._currentAction=this._actions.getChild(0)},n.prototype.update=function(t){return this._actionIndex===this._actions.getCount()?void this.finish():(this._currentAction=this._actions.getChild(this._actionIndex),this._currentAction.isFinish?void this._startNextActionAndJudgeFinish():(this._currentAction.update(t),this._currentAction.isFinish&&this._startNextActionAndJudgeFinish(),null))},n.prototype.reset=function(){return e.prototype.reset.call(this),this._actionIndex=0,this._currentAction=this._actions.getChild(this._actionIndex),this},n.prototype.start=function(){return e.prototype.start.call(this),this._currentAction.start(),this},n.prototype.stop=function(){return e.prototype.stop.call(this),this._currentAction.stop(),this},n.prototype.pause=function(){return e.prototype.pause.call(this),this._currentAction.pause(),this},n.prototype.resume=function(){return e.prototype.resume.call(this),this._currentAction.resume(),this},n.prototype.reverse=function(){return this._actions=this._actions.reverse(),e.prototype.reverse.call(this),this},n.prototype.getInnerActions=function(){return this._actions},n.prototype._startNextActionAndJudgeFinish=function(){return this._actionIndex++,this._actionIndex===this._actions.getCount()?void this.finish():void this._actions.getChild(this._actionIndex).start()},__decorate([t.cloneAttributeAsCustomType(function(t,e,n,r){e[n]=t[n].clone(!0)})],n.prototype,"_actions",void 0),__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];t.Log.assert(e.length>=2,"Sequence should has two actions at least")})],n,"create",null),n}(t.Control);t.Sequence=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(t){e.call(this),this._actions=wdCb.Collection.create(),this._actions.addChildren(t)}return __extends(n,e),n.create=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null;return t.Log.assert(e.length>=2,"Sequence should has two actions at least"),r=new this(e)},n.prototype.update=function(t){return this._isFinish()?void this.finish():(this.iterate("update",[t]),void(this._isFinish()&&this.finish()))},n.prototype.start=function(){return e.prototype.start.call(this),this.iterate("start"),this},n.prototype.stop=function(){return e.prototype.stop.call(this),this.iterate("stop"),this},n.prototype.pause=function(){return e.prototype.pause.call(this),this.iterate("pause"),this},n.prototype.resume=function(){return e.prototype.resume.call(this),this.iterate("resume"),this},n.prototype.reset=function(){return e.prototype.reset.call(this),this.iterate("reset"),this},n.prototype.reverse=function(){return this._actions=this._actions.reverse(),e.prototype.reverse.call(this),this},n.prototype.getInnerActions=function(){return this._actions},n.prototype.iterate=function(t,e){this._actions.forEach(function(n){n[t].apply(n,e)})},n.prototype._isFinish=function(){var t=!0;return this._actions.forEach(function(e){return e.isFinish?void 0:(t=!1,wdCb.$BREAK)}),t},__decorate([t.cloneAttributeAsCustomType(function(t,e,n,r){e[n]=t[n].clone(!0)})],n.prototype,"_actions",void 0),n}(t.Control);t.Spawn=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(t){e.call(this),this.duration=t}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.reverse=function(){return this},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"duration",void 0),n}(t.ActionInterval);t.DelayTime=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(t,n){e.call(this),this._innerAction=null,this._originTimes=null,this._times=null,this._innerAction=t,this._times=n}return __extends(n,e),n.create=function(t,e){var n=new this(t,e);return n.initWhenCreate(),n},n.prototype.initWhenCreate=function(){this._originTimes=this._times},n.prototype.update=function(t){if(0===this._times)return void this.finish();if(this._innerAction.update(t),this._innerAction.isFinish){if(this._times-=1,0!==this._times)return this._innerAction.reset(),void this._innerAction.start();this.finish()}},n.prototype.reset=function(){return e.prototype.reset.call(this),this._times=this._originTimes,this},n.prototype.start=function(){e.prototype.start.call(this),this._innerAction.start()},n.prototype.stop=function(){e.prototype.stop.call(this),this._innerAction.stop()},n.prototype.pause=function(){e.prototype.pause.call(this),this._innerAction.pause()},n.prototype.resume=function(){e.prototype.resume.call(this),this._innerAction.resume()},n.prototype.getInnerActions=function(){return wdCb.Collection.create([this._innerAction])},__decorate([t.cloneAttributeAsCloneable()],n.prototype,"_innerAction",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"_times",void 0),n}(t.Control);t.Repeat=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(t){e.call(this),this._innerAction=null,this._innerAction=t}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.update=function(t){this._innerAction.update(t),this._innerAction.isFinish&&(this._innerAction.reset(),this._innerAction.start())},n.prototype.start=function(){e.prototype.start.call(this),this._innerAction.start()},n.prototype.stop=function(){e.prototype.stop.call(this),this._innerAction.stop()},n.prototype.pause=function(){e.prototype.pause.call(this),this._innerAction.pause()},n.prototype.resume=function(){e.prototype.resume.call(this),this._innerAction.resume()},n.prototype.getInnerActions=function(){return wdCb.Collection.create([this._innerAction])},__decorate([t.cloneAttributeAsCloneable()],n.prototype,"_innerAction",void 0),n}(t.Control);t.RepeatForever=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._object=null,this._valuesStart=wdCb.Hash.create(),this._valuesEnd=wdCb.Hash.create(),this._easingFunction=n.Easing.Linear.None,this._interpolationFunction=n.Interpolation.Linear,this._onStartCallback=null,this._onStartCallbackFired=!1,this._onUpdateCallback=null,this._onFinishCallback=null,this._onStopCallback=null}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.updateBody=function(e){var n=this,r=null;return this._onStartCallbackFired===!1&&(null!==this._onStartCallback&&this._onStartCallback.call(this._object.getChildren()),this._onStartCallbackFired=!0),r=this._easingFunction(this.elapsed),this._valuesEnd.forEach(function(e,i){var o=n._valuesStart.getChild(i),a=e;a instanceof Array?n._object.setValue(i,n._interpolationFunction(a,r)):(t.JudgeUtils.isString(a)&&(a=o+t.root.parseFloat(a,10)),t.JudgeUtils.isNumber(a)&&n._object.setValue(i,o+(a-o)*r))}),null!==this._onUpdateCallback&&this._onUpdateCallback.call(this._object.getChildren(),r),!0},n.prototype.from=function(e){var n=this;return this._object=wdCb.Hash.create(e),this._object.forEach(function(e,r){n._valuesStart.addChild(r,t.root.parseFloat(e,10))}),this},n.prototype.to=function(t,e){return void 0===e&&(e=1e3),this.duration=e,this._valuesEnd=wdCb.Hash.create(t),this},n.prototype.init=function(){var t=this;e.prototype.init.call(this),this._valuesEnd.forEach(function(e,n){if(e instanceof Array){if(0===e.length)return;t._valuesEnd.setValue(n,[t._object.getChild(n)].concat(t._valuesEnd.getChild(n)))}t._valuesStart.setValue(n,t._object.getChild(n)),t._valuesStart.getChild(n)instanceof Array==!1&&t._valuesStart.setValue(n,1*t._valuesStart.getChild(n))})},n.prototype.start=function(){return e.prototype.start.call(this),this._onStartCallbackFired=!1,this},n.prototype.stop=function(){return e.prototype.stop.call(this),null!==this._onStopCallback&&this._onStopCallback.call(this._object.getChildren()),this},n.prototype.reverse=function(){var t=this._valuesStart;this._valuesStart=this._valuesEnd,this._valuesEnd=t},n.prototype.easing=function(t){return this._easingFunction=t,this},n.prototype.interpolation=function(t){return this._interpolationFunction=t,this},n.prototype.onUpdate=function(t){return this._onUpdateCallback=t,this},n.prototype.onFinish=function(t){return this._onFinishCallback=t,this},n.prototype.onStart=function(t){return this._onStartCallback=t,this},n.prototype.onStop=function(t){return this._onStopCallback=t,this},n.prototype.finish=function(){e.prototype.finish.call(this),null!==this._onFinishCallback&&this._onFinishCallback.call(this._object.getChildren())},n.Easing={Linear:{None:function(t){return t}},Quadratic:{In:function(t){return t*t},Out:function(t){return t*(2-t)},InOut:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)}},Cubic:{In:function(t){return t*t*t},Out:function(t){return--t*t*t+1},InOut:function(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)}},Quartic:{In:function(t){return t*t*t*t},Out:function(t){return 1- --t*t*t*t},InOut:function(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)}},Quintic:{In:function(t){return t*t*t*t*t},Out:function(t){return--t*t*t*t*t+1},InOut:function(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)}},Sinusoidal:{In:function(t){return 1-Math.cos(t*Math.PI/2)},Out:function(t){return Math.sin(t*Math.PI/2)},InOut:function(t){return.5*(1-Math.cos(Math.PI*t))}},Exponential:{In:function(t){return 0===t?0:Math.pow(1024,t-1)},Out:function(t){return 1===t?1:1-Math.pow(2,-10*t)},InOut:function(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(-Math.pow(2,-10*(t-1))+2)}},Circular:{In:function(t){return 1-Math.sqrt(1-t*t)},Out:function(t){return Math.sqrt(1- --t*t)},InOut:function(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)}},Elastic:{In:function(t){var e,n=.1,r=.4;return 0===t?0:1===t?1:(!n||1>n?(n=1,e=r/4):e=r*Math.asin(1/n)/(2*Math.PI),-(n*Math.pow(2,10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/r)))},Out:function(t){var e,n=.1,r=.4;return 0===t?0:1===t?1:(!n||1>n?(n=1,e=r/4):e=r*Math.asin(1/n)/(2*Math.PI),n*Math.pow(2,-10*t)*Math.sin((t-e)*(2*Math.PI)/r)+1)},InOut:function(t){var e,n=.1,r=.4;return 0===t?0:1===t?1:(!n||1>n?(n=1,e=r/4):e=r*Math.asin(1/n)/(2*Math.PI),(t*=2)<1?-.5*(n*Math.pow(2,10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/r)):n*Math.pow(2,-10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/r)*.5+1)}},Back:{In:function(t){var e=1.70158;return t*t*((e+1)*t-e)},Out:function(t){var e=1.70158;return--t*t*((e+1)*t+e)+1},InOut:function(t){var e=2.5949095;return(t*=2)<1?.5*(t*t*((e+1)*t-e)):.5*((t-=2)*t*((e+1)*t+e)+2)}},Bounce:{In:function(t){return 1-n.Easing.Bounce.Out(1-t)},Out:function(t){return 1/2.75>t?7.5625*t*t:2/2.75>t?7.5625*(t-=1.5/2.75)*t+.75:2.5/2.75>t?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},InOut:function(t){return.5>t?.5*n.Easing.Bounce.In(2*t):.5*n.Easing.Bounce.Out(2*t-1)+.5}}},n.Interpolation={Linear:function(t,e){var r=t.length-1,i=r*e,o=Math.floor(i),a=n.Interpolation.Utils.Linear;return 0>e?a(t[0],t[1],i):e>1?a(t[r],t[r-1],r-i):a(t[o],t[o+1>r?r:o+1],i-o)},Bezier:function(t,e){var r,i=0,o=t.length-1,a=n.Interpolation.Utils.Bernstein;for(r=0;o>=r;r++)i+=Math.pow(1-e,o-r)*Math.pow(e,r)*t[r]*a(o,r);return i},CatmullRom:function(t,e){var r=t.length-1,i=r*e,o=Math.floor(i),a=n.Interpolation.Utils.CatmullRom;return t[0]===t[r]?(0>e&&(o=Math.floor(i=r*(1+e))),a(t[(o-1+r)%r],t[o],t[(o+1)%r],t[(o+2)%r],i-o)):0>e?t[0]-(a(t[0],t[0],t[1],t[1],-i)-t[0]):e>1?t[r]-(a(t[r],t[r],t[r-1],t[r-1],i-r)-t[r]):a(t[o?o-1:0],t[o],t[o+1>r?r:o+1],t[o+2>r?r:o+2],i-o)},Utils:{Linear:function(t,e,n){return(e-t)*n+t},Bernstein:function(t,e){var r=n.Interpolation.Utils.Factorial;return r(t)/r(e)/r(t-e)},Factorial:function(){var t=[1];return function(e){var n,r=1;if(t[e])return t[e];for(n=e;n>1;n--)r*=n;return t[e]=r}}(),CatmullRom:function(t,e,n,r,i){var o=.5*(n-t),a=.5*(r-e),s=i*i,c=i*s;return(2*e-2*n+o+a)*c+(-3*e+3*n-2*o-a)*s+o*i+e}}},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"duration",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"_valuesStart",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"_valuesEnd",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"_easingFunction",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"_interpolationFunction",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"_onStartCallback",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"_onStartCallbackFired",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"_onUpdateCallback",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"_onFinishCallback",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"_onStopCallback",void 0),n}(t.ActionInterval);t.Tween=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(t.Component);t.RendererComponent=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.render=function(t,e,n){t.addCommand(this.createDrawCommand(e,n))},n.prototype.createDrawCommand=function(e,n){var r=null,i=n.getComponent(t.CameraController),o=e.material,a=this.entityObject.transform.position,s=e.entityObject;return r=this._createCommand(s,o),r.target=s,r.buffers=e.buffers,r.vaoManager=e.vaoManager,r.drawMode=e.drawMode,r.vMatrix=i.worldToCameraMatrix,r.pMatrix=i.pMatrix,r.material=o,r.z=a.z,r.blend=o.blend,r},n.prototype._createCommand=function(e,n){var r=null,i=null,o=n.shader.getInstanceState(),a=o.isModelMatrixInstance,s=o.isNormalMatrixInstance,c=o.isHardwareInstance,u=o.isBatchInstance;return i=this._getInstanceGLSLData(a,s),c?r=this._createHardwareInstanceCommand(e,n,i):u?r=this._createBatchInstanceCommand(e,n,i):(r=t.SingleDrawCommand.create(),r.mMatrix=this.entityObject.transform.localToWorldMatrix,r.normalMatrix=this.entityObject.transform.normalMatrix),r},n.prototype._getInstanceGLSLData=function(e,n){return n?t.EInstanceGLSLData.NORMALMATRIX_MODELMATRIX:t.EInstanceGLSLData.MODELMATRIX},n.prototype._createHardwareInstanceCommand=function(e,n,r){var i=e.getComponent(t.SourceInstance),o=t.HardwareInstanceCommand.create();return o.instanceList=i.toRenderInstanceListForDraw,o.instanceBuffer=i.instanceBuffer,o.glslData=r,o},n.prototype._createBatchInstanceCommand=function(e,n,r){var i=e.getComponent(t.SourceInstance),o=t.BatchInstanceCommand.create();return o.instanceList=i.toRenderInstanceListForDraw,o.glslData=r,o},__decorate([t.require(function(e,n){var r=n.getComponent(t.CameraController);t.assert(!!r&&!!r.camera,t.Log.info.FUNC_MUST("camera","add Camera Component")),t.assert(!!e,t.Log.info.FUNC_MUST("Mesh","add geometry component"))})],n.prototype,"createDrawCommand",null),__decorate([t.require(function(e){t.InstanceUtils.isInstance(e)&&t.assert(t.InstanceUtils.isSourceInstance(e),t.Log.info.FUNC_SHOULD("if use instance to batch draw, target","be SourceInstance"))}),t.ensure(function(e,n){e instanceof t.HardwareInstanceCommand?t.assert(t.InstanceUtils.isHardwareSupport(),t.Log.info.FUNC_SHOULD("hardware","support instance")):e instanceof t.BatchInstanceCommand&&t.assert(!t.InstanceUtils.isHardwareSupport(),t.Log.info.FUNC_SHOULD_NOT("hardware","support instance"))})],n.prototype,"_createCommand",null),n}(t.RendererComponent);t.MeshRenderer=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.render=function(t,e,n){t.skyboxCommand=this.createDrawCommand(e,n)},e}(t.MeshRenderer);t.SkyboxRenderer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._zIndex=1,this._dirty=!0,this.isClearCanvas=!1,this.state=t.EUIRendererState.NORMAL,this.context=null,this.canvas=null,this._referenceList=wdCb.Collection.create()}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},Object.defineProperty(n.prototype,"zIndex",{get:function(){return this._zIndex},set:function(t){t!==this._zIndex&&(this._zIndex=t,this.canvas&&wdCb.DomQuery.create(this.canvas).css("zIndex",t))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"dirty",{get:function(){return this._dirty},set:function(t){t?this._dirty=!0:this.resetDirty()},enumerable:!0,configurable:!0}),n.prototype.resetDirty=function(){this._dirty=!1},n.prototype.addToObject=function(t){this._referenceList.addChild(t),this.entityObject=t},n.prototype.removeFromObject=function(t){this._referenceList.removeChild(t),this._referenceList.getCount()>0||e.prototype.removeFromObject.call(this,t)},n.prototype.init=function(){},n.prototype.initWhenCreate=function(){this._createOverlayCanvas()},n.prototype.dispose=function(){this._referenceList.getCount()>0||wdCb.DomQuery.create(this.canvas).remove()},n.prototype.render=function(t,e,n){},n.prototype.clearCanvas=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.isClearCanvas=!0},n.prototype._createOverlayCanvas=function(){var e=null,n=null;this.canvas||(e=wdCb.DomQuery.create("<canvas></canvas>").prependTo("body"),n=t.DeviceManager.getInstance().view,e.css("position","absolute"),e.css("left",n.x+"px"),e.css("top",n.y+"px"),e.css("zIndex",this.zIndex),e.attr("width",n.width),e.attr("height",n.height),this.canvas=e.get(0),this.context=this.canvas.getContext("2d"))},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"zIndex",null),__decorate([t.execOnlyOnce("_isInit")],n.prototype,"init",null),n}(t.RendererComponent);t.UIRenderer=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.NORMAL=0]="NORMAL",t[t.DIRTY=1]="DIRTY",t[t.NOT_DIRTY=2]="NOT_DIRTY"}(t.EUIRendererState||(t.EUIRendererState={}));t.EUIRendererState}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.isCollideEnable=!0}return __extends(n,e),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"isCollideEnable",void 0),n}(t.Component);t.SpacePartition=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.maxDepth=2,this.maxNodeCapacity=64,this._root=null,this._selectionList=wdCb.Collection.create(),this._renderListCache=null}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.addToObject=function(n,r){void 0===r&&(r=!1);var i=t.SpacePartitionEngine.getInstance();e.prototype.addToObject.call(this,n,r),i.hasChild(this)||i.addChild(this)},n.prototype.removeFromObject=function(n){e.prototype.removeFromObject.call(this,n),t.SpacePartitionEngine.getInstance().removeChild(this)},n.prototype.init=function(){e.prototype.init.call(this)},n.prototype.update=function(t){this._renderListCache=this._getRenderListForCurrentLoop()},n.prototype.getRenderList=function(){return this._renderListCache},n.prototype.build=function(){var e=this.getChildren(),n=0,r=this.maxNodeCapacity,i=this.maxDepth,o=function(e,n,a,s,c){for(var u=new t.Vector3((n.x-e.x)/2,(n.y-e.y)/2,(n.z-e.z)/2),l=0;2>l;l++)for(var h=0;2>h;h++)for(var d=0;2>d;d++){var p=e.clone().add(u.clone().scale(l,h,d)),f=e.clone().add(u.clone().scale(l+1,h+1,d+1)),_=t.OctreeNode.create(p,f,r,a+1,i);_.addGameObjects(s),_.gameObjectCount>r&&i>a&&o(p,f,a+1,s,_),c.addNode(_)}};this._updateColliderForFirstCheck(e);var a=this._getWorldExtends(e),s=a.worldMin,c=a.worldMax;this._root=t.OctreeNode.create(s,c,r,n+1,i),o(s,c,n,e,this._root)},n.prototype.getRenderListByFrustumCull=function(){var e=t.Director.getInstance().scene.currentCamera;return e?this._visitRoot("findAndAddToRenderList",[e.getComponent(t.CameraController).getPlanes(),this._selectionList]):wdCb.Collection.create()},n.prototype.getIntersectListWithRay=function(e){var n=e.locationInView;return this._visitRoot("findAndAddToIntersectList",[t.Director.getInstance().scene.currentCamera.getComponent(t.CameraController).createRay(n.x,n.y),this._selectionList])},n.prototype.getCollideObjects=function(t){return this._visitRoot("findAndAddToCollideList",[t,this._selectionList])},n.prototype.getChildren=function(){return this.entityObject.getChildren()},n.prototype._visitRoot=function(t,e){return this._selectionList.removeAllChildren(),this._root.nodeList.forEach(function(n){n[t].apply(n,e)}),this._selectionList=this._selectionList.removeRepeatItems(),this._selectionList},n.prototype._updateColliderForFirstCheck=function(e){var n=null,r=this;e.forEach(function(e){e.hasComponent(t.ColliderForFirstCheck)?n=e.getComponent(t.BoxColliderForFirstCheck):(n=r._createCollider(),e.addComponent(n),n.init()),n.update(null)})},n.prototype._getWorldExtends=function(e){var n=t.Vector3.create(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),r=t.Vector3.create(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),i=this;return e.forEach(function(e){var o=null,a=null,s=null,c=null;s=e.getComponent(t.BoxColliderForFirstCheck),c=s.shape,o=c.getMin(),a=c.getMax(),i._checkExtends(o,n,r),i._checkExtends(a,n,r)}),{worldMin:n,worldMax:r}},n.prototype._createCollider=function(){return t.BoxColliderForFirstCheck.create()},n.prototype._checkExtends=function(t,e,n){t.x<e.x&&(e.x=t.x),t.y<e.y&&(e.y=t.y),t.z<e.z&&(e.z=t.z),t.x>n.x&&(n.x=t.x),t.y>n.y&&(n.y=t.y),t.z>n.z&&(n.z=t.z)},n.prototype._setToRenderInstanceListOfChildren=function(e,n){var r=function(e,n){e.forEach(function(e,i){var o=e.getComponent(t.SourceInstance);n.forEachToRenderInstanceList(function(t){o.addToRenderIntance(t.getChild(i))}),r(e,o)})};r(e,n)},n.prototype._addSelfToToRenderInstanceList=function(t,e){e.addToRenderIntance(t)},n.prototype._getRenderListForCurrentLoop=function(){var e=this,n=this.getRenderListByFrustumCull(),r=wdCb.Collection.create(),i=wdCb.Hash.create();
return n.forEach(function(n){if(!t.InstanceUtils.isInstance(n))return void r.addChild(n);if(t.InstanceUtils.isSourceInstance(n)){var o=n.getComponent(t.SourceInstance);return e._addSelfToToRenderInstanceList(n,o),void i.addChild(String(n.uid),n)}var a=n.getComponent(t.ObjectInstance).sourceObject,s=a.getComponent(t.SourceInstance);e._addSelfToToRenderInstanceList(n,s),i.addChild(String(a.uid),a)},this),i.forEach(function(n,i){var o=n.getComponent(t.SourceInstance);e._setToRenderInstanceListOfChildren(n,o),r.addChild(n)},this),r},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"maxDepth",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"maxNodeCapacity",void 0),__decorate([t.require(function(e){t.assert(e instanceof t.GameObject,t.Log.info.FUNC_SHOULD("Octree component","add to GameObject"))})],n.prototype,"addToObject",null),__decorate([t.require(function(){t.assert(t.JudgeUtils.isEqual(this.entityObject.parent,t.Director.getInstance().scene)&&t.Director.getInstance().scene.gameObjectScene.hasChild(this.entityObject),t.Log.info.FUNC_SHOULD("be added to the one which is the firstLevel child of gameObjectScene"))})],n.prototype,"init",null),__decorate([t.ensure(function(e){t.assert(!!e&&e instanceof wdCb.Collection,t.Log.info.FUNC_NOT_EXIST("renderList"))})],n.prototype,"getRenderList",null),__decorate([t.require(function(){t.assert(!!t.Director.getInstance().scene.currentCamera.getComponent(t.CameraController),t.Log.info.FUNC_SHOULD("contain CameraController component"))})],n.prototype,"getRenderListByFrustumCull",null),__decorate([t.require(function(){t.assert(!!t.Director.getInstance().scene.currentCamera.getComponent(t.CameraController),t.Log.info.FUNC_SHOULD("contain CameraController component"))})],n.prototype,"getIntersectListWithRay",null),__decorate([t.require(function(e,n){t.assert(n.hasToRenderInstance(),t.Log.info.FUNC_SHOULD("top SourceInstance","has to render instance"))})],n.prototype,"_setToRenderInstanceListOfChildren",null),__decorate([t.require(function(e,n){t.assert(n instanceof t.SourceInstance,t.Log.info.FUNC_ONLY("SourceInstance has toRenderList")),n.forEachToRenderInstanceList(function(n){t.assert(!t.JudgeUtils.isEqual(n,e),t.Log.info.FUNC_SHOULD_NOT("toRenderInstanceList","contain self"))})})],n.prototype,"_addSelfToToRenderInstanceList",null),n}(t.SpacePartition);t.Octree=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t,e,n,r,i){this.gameObjectList=wdCb.Collection.create(),this.nodeList=wdCb.Collection.create(),this._depth=null,this._maxDepth=null,this._capacity=null,this._minPoint=null,this._maxPoint=null,this._boundingVectors=null,this._capacity=n,this._depth=r,this._maxDepth=i,this._minPoint=t,this._maxPoint=e}return e.create=function(t,e,n,r,i){var o=new this(t,e,n,r,i);return o.initWhenCreate(),o},Object.defineProperty(e.prototype,"gameObjectCount",{get:function(){return this.gameObjectList.getCount()},enumerable:!0,configurable:!0}),e.prototype.initWhenCreate=function(){this._boundingVectors=t.BoundingRegionUtils.buildBoundingVectors(this._minPoint,this._maxPoint)},e.prototype.addGameObjects=function(e){var n=this,r=this._minPoint,i=this._maxPoint;e.forEach(function(e){e.getComponent(t.BoxColliderForFirstCheck).shape.isIntersectWithBox(r,i)&&n.gameObjectList.addChild(e)})},e.prototype.addNode=function(t){this.nodeList.addChild(t)},e.prototype.findAndAddToRenderList=function(e,n){if(t.BoundingRegionUtils.isAABBIntersectFrustum(this._boundingVectors,e)){if(this._hasNode())return void this.nodeList.forEach(function(t){t.findAndAddToRenderList(e,n)});n.addChildren(t.RenderUtils.getGameObjectRenderListForOctree(this.gameObjectList))}},e.prototype.findAndAddToIntersectList=function(t,e){if(t.isIntersectWithAABB(this._minPoint,this._maxPoint)){if(this._hasNode())return void this.nodeList.forEach(function(n){n.findAndAddToIntersectList(t,e)});e.addChildren(this.gameObjectList)}},e.prototype.findAndAddToCollideList=function(t,e){if(t.isIntersectWithBox(this._minPoint,this._maxPoint)){if(this._hasNode())return void this.nodeList.forEach(function(n){n.findAndAddToCollideList(t,e)});e.addChildren(this.gameObjectList)}},e.prototype._hasNode=function(){return this.nodeList.getCount()>0},__decorate([t.require(function(e){e.forEach(function(e){t.assert(e instanceof t.GameObject,t.Log.info.FUNC_SHOULD("add gameObjects"))})})],e.prototype,"addGameObjects",null),e}();t.OctreeNode=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.prototype.clone=function(){return t.CloneUtils.clone(this)},n}(t.Component);t.ColliderForFirstCheck=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._collider=t.BoxCollider.create()}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"shape",{get:function(){return this._collider.shape},enumerable:!0,configurable:!0}),n.prototype.init=function(){this._collider.entityObject=this.entityObject,this._collider.init()},n.prototype.update=function(t){this._collider.update(t)},__decorate([t.cloneAttributeAsCloneable()],n.prototype,"_collider",void 0),n}(t.ColliderForFirstCheck);t.BoxColliderForFirstCheck=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.enable=!0,this.boundingRegion=null,this.type=t.ABSTRACT_ATTRIBUTE}return __extends(n,e),Object.defineProperty(n.prototype,"shape",{get:function(){return this.boundingRegion.shape},enumerable:!0,configurable:!0}),n.prototype.init=function(){this.boundingRegion=this.createBoundingRegion(),this.boundingRegion.init(),this.buildBoundingRegion()},n.prototype.addToObject=function(n,r){void 0===r&&(r=!1);var i=t.ColliderEngine.getInstance();e.prototype.addToObject.call(this,n,r),i.hasChild(this)||i.addChild(this)},n.prototype.removeFromObject=function(n){e.prototype.removeFromObject.call(this,n),t.ColliderEngine.getInstance().removeChild(this)},n.prototype.clone=function(){return t.CloneUtils.clone(this)},n.prototype.update=function(t){this.boundingRegion.update()},n.prototype.updateShape=function(){this.boundingRegion.updateShape()},n.prototype.isIntersectWith=function(e){return e instanceof t.BoxCollider?this.boundingRegion.isIntersectWithBox(e.boundingRegion):e instanceof t.SphereCollider?this.boundingRegion.isIntersectWithSphere(e.boundingRegion):void t.Log.warn(t.Log.info.FUNC_NOT_SUPPORT(this.type+" collider","intersect with "+e.type+" collider"))},n.prototype.isCollide=function(e){var r=null;return r=e.getComponent(n),e.hasComponent(t.RigidBody)&&r.updateShape(),this.isIntersectWith(r)},n.prototype._isSelf=function(e){return t.JudgeUtils.isSelf(this.entityObject,e)},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"enable",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"boundingRegion",void 0),__decorate([t.require(function(e){t.assert(e instanceof n,t.Log.info.FUNC_SHOULD("target","be collider"))})],n.prototype,"isIntersectWith",null),__decorate([t.require(function(e){t.assert(!this._isSelf(e),t.Log.info.FUNC_SHOULD_NOT("targetObject","be self")),t.assert(e.hasComponent(n),t.Log.info.FUNC_SHOULD("targetObject","contain Collider component"))})],n.prototype,"isCollide",null),n}(t.Component);t.Collider=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.center=t.Vector3.create(0,0,0),this.halfExtents=null,this.type=t.EColliderType.BOX}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.createBoundingRegion=function(){return t.BoxBoundingRegion.create(this.entityObject)},n.prototype.buildBoundingRegion=function(){this.boundingRegion.build(this.center,this.halfExtents)},__decorate([t.cloneAttributeAsCloneable()],n.prototype,"center",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"halfExtents",void 0),n}(t.Collider);t.BoxCollider=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.center=t.Vector3.create(0,0,0),this.radius=null,this.type=t.EColliderType.SPHERE}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.createBoundingRegion=function(){return t.SphereBoundingRegion.create(this.entityObject)},n.prototype.buildBoundingRegion=function(){this.boundingRegion.build(this.center,this.radius)},__decorate([t.cloneAttributeAsCloneable()],n.prototype,"center",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"radius",void 0),n}(t.Collider);t.SphereCollider=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t){this.shape=null,this.entityObject=null,this.isUserSpecifyTheRegion=!1,this.originShape=null,this.debugObject=null,this.entityObject=t}return e.prototype.init=function(){this.shape=this.createShape()},e.prototype.clone=function(){return t.CloneUtils.clone(this)},e.prototype.build=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];var i=Array.prototype.slice.call(arguments,0);this.isBuildUserSpecifyBoundingRegion.apply(this,i)?(this.isUserSpecifyTheRegion=!0,this.shape.setFromShapeParam.apply(this.shape,i)):this.shape.setFromPoints(t.ColliderUtils.getVertices(this.entityObject)),this.originShape=this.shape.clone(),t.DebugConfig.debugCollision&&(this.debugObject=this.buildDebugObjectFromShape(this.shape),t.Director.getInstance().scene.addChild(this.debugObject))},e.prototype.update=function(){this.isNotTransformed()||(t.DebugConfig.debugCollision?(this.updateShape(),this.updateDebugObjectFromShape(this.shape)):this.entityObject.hasComponent(t.RigidBody)||this.updateShape())},e.prototype.isIntersectWithSphere=function(t){return this.shape.isIntersectWithSphere(t.shape)},e.prototype.isIntersectWithBox=function(t){return this.shape.isIntersectWithBox(t.shape)},e.prototype.buildDebugObjectFromShape=function(e){var n=null,r=null,i=null,o=null;return n=t.BasicMaterial.create(),n.color=t.Color.create("rgb(255,0,0)"),r=t.CustomGeometry.create(),r.material=n,r.drawMode=t.EDrawMode.LINES,this.setDebugObjectGeometry(r,e),i=t.MeshRenderer.create(),o=t.GameObject.create(),o.addComponent(r),o.addComponent(i),o.transform.translate(e.center),o.name="debugBoundingRegion"+this.entityObject.uid,o.init(),o},__decorate([t.cloneAttributeAsCloneable()],e.prototype,"shape",void 0),__decorate([t.ensure(function(e,n){for(var r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];this.isBuildUserSpecifyBoundingRegion.apply(this,Array.prototype.slice.call(arguments,1))&&t.assert(this.shape.center.isEqual(n),t.Log.info.FUNC_SHOULD_NOT("transform shape when build"))})],e.prototype,"build",null),e}();t.BoundingRegion=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.updateShape=function(){var t=this.entityObject.transform;this.isUserSpecifyTheRegion?this.shape.setFromTranslationAndScale(this.originShape,t.localToWorldMatrix):t.isRotate?this.shape.setFromObject(this.entityObject):this.shape.setFromTranslationAndScale(this.originShape,t.localToWorldMatrix)},n.prototype.createShape=function(){return t.AABBShape.create()},n.prototype.updateDebugObjectFromShape=function(e){var n=this.debugObject.getComponent(t.CustomGeometry);this.setDebugObjectGeometry(n,e),this.debugObject.transform.position=e.center},n.prototype.setDebugObjectGeometry=function(t,e){var n=e.halfExtents,r=n.x,i=n.y,o=n.z;t.vertices=[-r,-i,-o,-r,-i,o,r,-i,o,r,-i,-o,-r,i,-o,-r,i,o,r,i,o,r,i,-o],t.indices=[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]},n.prototype.isBuildUserSpecifyBoundingRegion=function(t,e){return!!t&&!!e},n.prototype.isNotTransformed=function(){var t=this.entityObject.transform;return!t.isRotate&&!t.isTranslate&&!t.isScale},__decorate([t.require(function(e){t.assert(this.debugObject,t.Log.info.FUNC_SHOULD("build debugObject"))})],n.prototype,"updateDebugObjectFromShape",null),__decorate([t.require(function(e,n){t.assert(n.halfExtents&&!n.halfExtents.isZero(),t.Log.info.FUNC_SHOULD_NOT("halfExtents","be zero"))})],n.prototype,"setDebugObjectGeometry",null),n}(t.BoundingRegion);t.BoxBoundingRegion=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.updateShape=function(){var t=this.entityObject.transform;this.shape.setFromTranslationAndScale(this.originShape,t.localToWorldMatrix)},n.prototype.createShape=function(){return t.SphereShape.create()},n.prototype.updateDebugObjectFromShape=function(e){this.debugObject.transform.position=e.center;var n=e.radius/this.originShape.radius;this.debugObject.transform.scale=t.Vector3.create(n,n,n)},n.prototype.isNotTransformed=function(){var t=this.entityObject.transform;return!t.isTranslate&&!t.isScale},n.prototype.isBuildUserSpecifyBoundingRegion=function(t,e){return!!t&&!!e},n.prototype.setDebugObjectGeometry=function(t,e){for(var n=40,r=3,i=e.radius,o=[],a=0,s=0;r>s;s++){var c=0,u=1,l=2,h=null;1===s?(c=1,u=0,l=2):2===s&&(c=0,u=2,l=1);for(var d=0;n>d;d++)h=2*Math.PI*(d/n),o[a+c]=i*Math.cos(h),o[a+u]=0,o[a+l]=i*Math.sin(h),a+=3,h=2*Math.PI*((d+1)/n),o[a+c]=i*Math.cos(h),o[a+u]=0,o[a+l]=i*Math.sin(h),a+=3}t.vertices=o},__decorate([t.require(function(e){t.assert(this.debugObject,t.Log.info.FUNC_SHOULD("build debugObject"))})],n.prototype,"updateDebugObjectFromShape",null),__decorate([t.require(function(e,n){t.assert(n.radius>0,t.Log.info.FUNC_SHOULD("radius","> 0"))})],n.prototype,"setDebugObjectGeometry",null),n}(t.BoundingRegion);t.SphereBoundingRegion=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t.isAABBInFrustum=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=null,r=null;if(2===t.length)n=t[0],r=t[1];else if(3===t.length){var i=t[0],o=t[1];n=this.buildBoundingVectors(i,o),r=t[2]}for(var a=0;6>a;a++)for(var s=0;8>s;s++)if(r[a].dotCoordinate(n[s])<0)return!1;return!0},t.isAABBIntersectFrustum=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=null,r=null;if(2===t.length)n=t[0],r=t[1];else if(3===t.length){var i=t[0],o=t[1];n=this.buildBoundingVectors(i,o),r=t[2]}for(var a=0;6>a;a++){for(var s=8,c=0;8>c&&r[a].dotCoordinate(n[c])<0;c++)s--;if(0===s)return!1}return!0},t.buildBoundingVectors=function(t,e){var n=[];return n.push(t.clone()),n.push(e.clone()),n.push(t.clone()),n[2].x=e.x,n.push(t.clone()),n[3].y=e.y,n.push(t.clone()),n[4].z=e.z,n.push(e.clone()),n[5].z=t.z,n.push(e.clone()),n[6].x=t.x,n.push(e.clone()),n[7].y=t.y,n},t}();t.BoundingRegionUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.center=t.Vector3.create(0,0,0)}return e.prototype.clone=function(){return t.CloneUtils.clone(this)},e.prototype.isBoxAndSphereIntersected=function(t,e){var n=e.center,r=e.radius;return n.distanceToSquared(t.closestPointTo(n))<Math.pow(r,2)},__decorate([t.cloneAttributeAsCloneable()],e.prototype,"center",void 0),e}();t.Shape=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.halfExtents=t.Vector3.create(.5,.5,.5)}return __extends(n,e),n.create=function(){var t=new this;return t},n.getCenter=function(e,n){return t.Vector3.create().add2(n,e).scale(.5)},n.getHalfExtents=function(e,n){return t.Vector3.create().sub2(n,e).scale(.5)},n.prototype.setMinMax=function(t,e){this.center=n.getCenter(t,e),this.halfExtents=n.getHalfExtents(t,e)},n.prototype.getMin=function(){return this.center.clone().sub(this.halfExtents)},n.prototype.getMax=function(){return this.center.clone().add(this.halfExtents)},n.prototype.setFromShapeParam=function(t,e){this.center=t,this.halfExtents=e},n.prototype.setFromPoints=function(e){var n=this,r=this._getEmptyMin(),i=this._getEmptyMax();return t.GeometryUtils.iterateThreeComponent(e,function(t){n._expandByPoint(t,r,i)}),this.setMinMax(r,i),this},n.prototype.setFromTransformedAABB=function(t,e){var n=this.center,r=this.halfExtents,i=t.center.values,o=t.halfExtents.values,a=e.values,s=a[0],c=a[4],u=a[8],l=a[1],h=a[5],d=a[9],p=a[2],f=a[6],_=a[10],g=Math.abs(s),m=Math.abs(c),y=Math.abs(u),v=Math.abs(l),b=Math.abs(h),C=Math.abs(d),E=Math.abs(p),S=Math.abs(f),T=Math.abs(_);n.set(a[12]+s*i[0]+c*i[1]+u*i[2],a[13]+l*i[0]+h*i[1]+d*i[2],a[14]+p*i[0]+f*i[1]+_*i[2]),r.set(g*o[0]+m*o[1]+y*o[2],v*o[0]+b*o[1]+C*o[2],E*o[0]+S*o[1]+T*o[2])},n.prototype.setFromTranslationAndScale=function(t,e){var n=e.getTranslation(),r=e.getScale();this.center=t.center.clone().add(n),this.halfExtents=t.halfExtents.clone().mul(r)},n.prototype.setFromObject=function(e){var n=e.transform.localToWorldMatrix,r=t.ColliderUtils.getVertices(e),i=this,o=this._getEmptyMin(),a=this._getEmptyMax();t.GeometryUtils.iterateThreeComponent(r,function(t){t.applyMatrix4(n),i._expandByPoint(t,o,a)}),this.setMinMax(o,a)},n.prototype.isIntersectWithBox=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=this.getMax(),r=this.getMin(),i=null,o=null;if(1===t.length){var a=t[0];o=a.getMin(),i=a.getMax()}else 2===t.length&&(o=t[0],i=t[1]);return r.x<=i.x&&n.x>=o.x&&r.y<=i.y&&n.y>=o.y&&r.z<=i.z&&n.z>=o.z},n.prototype.isIntersectWithSphere=function(t){return this.isBoxAndSphereIntersected(this,t)},n.prototype.isIntersectWithRay=function(t){return t.isIntersectWithAABB(this)},n.prototype.closestPointTo=function(e){var n=this.getMin(),r=this.getMax(),i=t.Vector3.create();return e.x<n.x?i.x=n.x:e.x>r.x?i.x=r.x:i.x=e.x,e.y<n.y?i.y=n.y:e.y>r.y?i.y=r.y:i.y=e.y,e.z<n.z?i.z=n.z:e.z>r.z?i.z=r.z:i.z=e.z,i},n.prototype.containPoint=function(t){for(var e=this.getMin(),n=this.getMax(),r=0;3>r;++r)if(t.values[r]<e.values[r]||t.values[r]>n.values[r])return!1;return!0},n.prototype._getEmptyMin=function(){return t.Vector3.create(1/0,1/0,1/0)},n.prototype._getEmptyMax=function(){return t.Vector3.create(-(1/0),-(1/0),-(1/0))},n.prototype._expandByPoint=function(t,e,n){e.min(t),n.max(t)},__decorate([t.cloneAttributeAsCloneable()],n.prototype,"halfExtents",void 0),__decorate([t.require(function(e){var n=t.ColliderUtils.getVertices(e);t.assert(n&&n.length>0,t.Log.info.FUNC_MUST_DEFINE("vertices"))})],n.prototype,"setFromObject",null),n}(t.Shape);t.AABBShape=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.radius=1}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.setFromShapeParam=function(t,e){this.center=t,this.radius=e},n.prototype.setFromPoints=function(e){var n=t.AABBShape.create();this.center=n.setFromPoints(e).center,this.radius=this._findMaxDistanceOfPointsToCenter(e)},n.prototype.setFromTranslationAndScale=function(t,e){var n=e.getTranslation(),r=e.getScale();this.center=t.center.clone().add(n),this.radius=t.radius*Math.max(r.x,r.y,r.z)},n.prototype.isIntersectWithSphere=function(t){var e=this.radius+t.radius;return t.center.distanceToSquared(this.center)<=Math.pow(e,2)},n.prototype.isIntersectWithBox=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null;if(1===e.length)r=e[0];else if(2===e.length){var i=e[0],o=e[1];r=t.AABBShape.create(),r.setMinMax(i,o)}return this.isBoxAndSphereIntersected(r,this)},n.prototype.isIntersectWithRay=function(t){return t.isIntersectWithSphere(this)},n.prototype.containPoint=function(t){return t.distanceToSquared(this.center)<=Math.pow(this.radius,2)},n.prototype._findMaxDistanceOfPointsToCenter=function(e){var n=0,r=this.center;return t.GeometryUtils.iterateThreeComponent(e,function(t){n=Math.max(n,r.distanceToSquared(t))}),Math.sqrt(n)},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"radius",void 0),n}(t.Shape);t.SphereShape=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.BOX="box"]="BOX",t[t.SPHERE="sphere"]="SPHERE"}(t.EColliderType||(t.EColliderType={}));t.EColliderType}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.getVertices=function(e){return e.hasComponent(t.Geometry)?e.getComponent(t.Geometry).geometryData.vertices:e.hasTag(t.EWDTag.CONTAINER)?e.getChild(0).getComponent(t.Geometry).vertices:null},__decorate([t.require(function(e){if(!e.hasComponent(t.Geometry)&&e.hasTag(t.EWDTag.CONTAINER)){var n=e.getChild(0).getComponent(t.Geometry).vertices,r=e.getChild(1).getComponent(t.Geometry).vertices;t.assert(!!n&&n.length===r.length,t.Log.info.FUNC_SHOULD("if entityObject is EWDTag.CONTAINER, then its children should has its vertices"))}})],e,"getVertices",null),e}();t.ColliderUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._friction=0,this._restitution=0,this._children=wdCb.Collection.create(),this.lockConstraint=t.LockConstraint.create(this),this.distanceConstraint=t.DistanceConstraint.create(this),this.hingeConstraint=t.HingeConstraint.create(this),this.pointToPointConstraintList=t.PointToPointConstraintList.create(this)}return __extends(n,e),Object.defineProperty(n.prototype,"friction",{get:function(){return this._friction},set:function(t){this._friction=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"restitution",{get:function(){return this._restitution},set:function(t){this._restitution=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"children",{get:function(){return this._children},set:function(e){if(t.JudgeUtils.isArrayExactly(e)){var n=e;this._children=wdCb.Collection.create(n)}else{var r=e;this._children=r}this._children.forEach(function(t){t.addTag("isRigidbodyChild")})},enumerable:!0,configurable:!0}),n.prototype.addToObject=function(n,r){void 0===r&&(r=!1);var i=t.RigidBodyEngine.getInstance();e.prototype.addToObject.call(this,n,r),i.hasChild(this)||i.addChild(this)},n.prototype.addConstraint=function(){var t=this,e=this.getPhysicsEngineAdapter();this.lockConstraint&&this.lockConstraint.connectedBody&&e.addLockConstraint(this.entityObject,this.lockConstraint),this.distanceConstraint&&this.distanceConstraint.connectedBody&&e.addDistanceConstraint(this.entityObject,this.distanceConstraint),this.hingeConstraint&&this.hingeConstraint.connectedBody&&e.addHingeConstraint(this.entityObject,this.hingeConstraint),this.pointToPointConstraintList&&this.pointToPointConstraintList.getCount()>0&&this.pointToPointConstraintList.forEach(function(n){e.addPointToPointConstraint(t.entityObject,n)},this)},n.prototype.removeFromObject=function(n){var r=this.getPhysicsEngineAdapter();r&&(this.getPhysicsEngineAdapter().removeGameObject(n),this.getPhysicsEngineAdapter().removeConstraints(n)),e.prototype.removeFromObject.call(this,n),t.RigidBodyEngine.getInstance().removeChild(this)},n.prototype.dispose=function(){this._children.forEach(function(t){t.removeTag("isRigidbodyChild")},this)},n.prototype.getPhysicsEngineAdapter=function(){return t.Director.getInstance().scene.physicsEngineAdapter},n.prototype.isPhysicsEngineAdapterExist=function(){return!!t.Director.getInstance().scene&&!!t.Director.getInstance().scene.physicsEngineAdapter},n.prototype.initBody=function(){this.addBody()},n.prototype.initConstraint=function(){this.addConstraint()},n.prototype.addBodyToPhysicsEngine=function(t,e){void 0===e&&(e={});var n=this.getPhysicsEngineAdapter(),r=this.entityObject.transform.position,i=this.entityObject.transform.rotation;n[t](this.entityObject,wdCb.ExtendUtils.extend({position:r,rotation:i,children:this._children,lockConstraint:this.lockConstraint,onContact:wdCb.FunctionUtils.bind(this,this._onContact),onCollisionStart:wdCb.FunctionUtils.bind(this,this._onCollisionStart),onCollisionEnd:wdCb.FunctionUtils.bind(this,this._onCollisionEnd),friction:this.friction,restitution:this.restitution},e))},n.prototype._onContact=function(e){t.ScriptEngine.getInstance().execEntityObjectScriptWithData(this.entityObject,"onContact",wdCb.Collection.create([e]))},n.prototype._onCollisionStart=function(e){t.ScriptEngine.getInstance().execEntityObjectScriptWithData(this.entityObject,"onCollisionStart",wdCb.Collection.create([e]))},n.prototype._onCollisionEnd=function(){t.ScriptEngine.getInstance().execEntityObjectScript(this.entityObject,"onCollisionEnd")},n.prototype._isContainer=function(t){var e=t.getComponent(n);return e.children.getCount()>0},__decorate([t.operateBodyDataGetterAndSetter("Friction"),t.cloneAttributeAsBasicType()],n.prototype,"friction",null),__decorate([t.operateBodyDataGetterAndSetter("Restitution"),t.cloneAttributeAsBasicType()],n.prototype,"restitution",null),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"children",null),__decorate([t.cloneAttributeAsCloneable({isInjectTarget:!0})],n.prototype,"lockConstraint",void 0),__decorate([t.cloneAttributeAsCloneable({isInjectTarget:!0})],n.prototype,"distanceConstraint",void 0),__decorate([t.cloneAttributeAsCloneable({isInjectTarget:!0})],n.prototype,"hingeConstraint",void 0),__decorate([t.cloneAttributeAsCloneable({isInjectTarget:!0})],n.prototype,"pointToPointConstraintList",void 0),__decorate([t.execOnlyOnce("_initBody")],n.prototype,"initBody",null),__decorate([t.execOnlyOnce("_initConstraint")],n.prototype,"initConstraint",null),__decorate([t.require(function(){this._isContainer(this.entityObject)?t.assert(!this.entityObject.getComponent(t.Collider),t.Log.info.FUNC_SHOULD_NOT("container","add collider component in the case of compound")):(t.assert(!!this.entityObject.getComponent(t.Collider),t.Log.info.FUNC_MUST_DEFINE("collider component when add rigid body component")),t.assert(!!this.entityObject.getComponent(t.Collider).shape,t.Log.info.FUNC_SHOULD("create collider.shape before adding rigid body component")))})],n.prototype,"addBodyToPhysicsEngine",null),n}(t.Component);t.RigidBody=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._linearDamping=0,this._angularDamping=0,this._velocity=t.Vector3.create(0,0,0),this._angularVelocity=t.Vector3.create(0,0,0),this._mass=1,this.impulse=null,this.force=null,this.hitPoint=null}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"linearDamping",{get:function(){return this._linearDamping},set:function(t){this._linearDamping=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"angularDamping",{get:function(){return this._angularDamping},set:function(t){this._angularDamping=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"velocity",{get:function(){return this._velocity},set:function(t){this._velocity=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"angularVelocity",{get:function(){return this._angularVelocity},set:function(t){this._angularVelocity=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"mass",{get:function(){return this._mass},set:function(t){this._mass=t},enumerable:!0,configurable:!0}),n.prototype.addBody=function(){this.addBodyToPhysicsEngine("addDynamicBody",{mass:this.mass,linearDamping:this.linearDamping,angularDamping:this.angularDamping,velocity:this.velocity,angularVelocity:this.angularVelocity,impulse:this.impulse,force:this.force,hitPoint:this.hitPoint})},__decorate([t.operateBodyDataGetterAndSetter("LinearDamping"),t.cloneAttributeAsBasicType()],n.prototype,"linearDamping",null),__decorate([t.operateBodyDataGetterAndSetter("AngularDamping"),t.cloneAttributeAsBasicType()],n.prototype,"angularDamping",null),__decorate([t.operateBodyDataGetterAndSetter("Velocity"),t.cloneAttributeAsCloneable()],n.prototype,"velocity",null),__decorate([t.operateBodyDataGetterAndSetter("AngularVelocity"),t.cloneAttributeAsCloneable()],n.prototype,"angularVelocity",null),__decorate([t.operateBodyDataGetterAndSetter("Mass"),t.cloneAttributeAsBasicType()],n.prototype,"mass",null),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"impulse",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"force",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"hitPoint",void 0),n}(t.RigidBody);t.DynamicRigidBody=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._velocity=t.Vector3.create(0,0,0),this._angularVelocity=t.Vector3.create(0,0,0),this._mass=1}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"velocity",{get:function(){return this._velocity},set:function(t){this._velocity=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"angularVelocity",{get:function(){return this._angularVelocity},set:function(t){this._angularVelocity=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"mass",{get:function(){return this._mass},set:function(t){this._mass=t},enumerable:!0,configurable:!0}),n.prototype.addBody=function(){this.addBodyToPhysicsEngine("addKinematicBody",{mass:this.mass,velocity:this.velocity,angularVelocity:this.angularVelocity})},__decorate([t.operateBodyDataGetterAndSetter("Velocity"),t.cloneAttributeAsCloneable()],n.prototype,"velocity",null),__decorate([t.operateBodyDataGetterAndSetter("AngularVelocity"),t.cloneAttributeAsCloneable()],n.prototype,"angularVelocity",null),__decorate([t.operateBodyDataGetterAndSetter("Mass"),t.cloneAttributeAsBasicType()],n.prototype,"mass",null),n}(t.RigidBody);t.KinematicRigidBody=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.addBody=function(){this.addBodyToPhysicsEngine("addStaticBody")},e}(t.RigidBody);t.StaticRigidBody=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t){this.maxForce=null,this.rigidBody=null,this.rigidBody=t}return e.prototype.clone=function(e){return t.CloneUtils.clone(this,null,[e])},__decorate([t.cloneAttributeAsBasicType()],e.prototype,"maxForce",void 0),e}();t.PhysicsConstraint=e;var n=function(e){function n(){e.apply(this,arguments),this._connectedBody=null}return __extends(n,e),n.create=function(t){var e=new this(t);return e},Object.defineProperty(n.prototype,"connectedBody",{get:function(){return this._connectedBody},set:function(t){var e=null;this._connectedBody=t,this.rigidBody.isPhysicsEngineAdapterExist()&&(e=this.rigidBody.getPhysicsEngineAdapter(),e.removeLockConstraint(this.rigidBody.entityObject),this.rigidBody.addConstraint())},enumerable:!0,configurable:!0}),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"connectedBody",null),n}(e);t.LockConstraint=n;var r=function(e){function n(){e.apply(this,arguments),this._connectedBody=null,this.distance=null}return __extends(n,e),n.create=function(t){var e=new this(t);return e},Object.defineProperty(n.prototype,"connectedBody",{get:function(){return this._connectedBody},set:function(t){var e=null;this._connectedBody=t,this.rigidBody.isPhysicsEngineAdapterExist()&&(e=this.rigidBody.getPhysicsEngineAdapter(),e.removeDistanceConstraint(this.rigidBody.entityObject),this.rigidBody.addConstraint())},enumerable:!0,configurable:!0}),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"connectedBody",null),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"distance",void 0),n}(e);t.DistanceConstraint=r;var i=function(e){function n(){e.apply(this,arguments),this._connectedBody=null,this.pivotA=null,this.pivotB=null,this.axisA=null,this.axisB=null}return __extends(n,e),n.create=function(t){var e=new this(t);return e},Object.defineProperty(n.prototype,"connectedBody",{get:function(){return this._connectedBody},set:function(t){var e=null;this._connectedBody=t,this.rigidBody.isPhysicsEngineAdapterExist()&&(e=this.rigidBody.getPhysicsEngineAdapter(),e.removeHingeConstraint(this.rigidBody.entityObject),this.rigidBody.addConstraint())},enumerable:!0,configurable:!0}),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"connectedBody",null),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"pivotA",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"pivotB",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"axisA",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"axisB",void 0),n}(e);t.HingeConstraint=i;var o=function(e){function n(){e.apply(this,arguments),
this.connectedBody=null,this.pivotA=null,this.pivotB=null}return __extends(n,e),n.create=function(){var t=new this(null);return t},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"connectedBody",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"pivotA",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"pivotB",void 0),n}(e);t.PointToPointConstraint=o;var a=function(){function e(t){this._rigidBody=null,this._list=wdCb.Collection.create(),this._rigidBody=t}return e.create=function(t){var e=new this(t);return e},e.prototype.clone=function(e){return t.CloneUtils.clone(this,null,[e])},e.prototype.forEach=function(e,n){void 0===n&&(n=t.root),this._list.forEach(e,n)},e.prototype.getCount=function(){return this._list.getCount()},e.prototype.getChildren=function(){return this._list},e.prototype.getChild=function(t){return this._list.getChild(t)},e.prototype.addChild=function(t){var e=null;this._list.addChild(t),this._rigidBody.isPhysicsEngineAdapterExist()&&(e=this._rigidBody.getPhysicsEngineAdapter(),e.addPointToPointConstraint(this._rigidBody.entityObject,t))},e.prototype.addChildren=function(e){var n=this;if(t.JudgeUtils.isArrayExactly(e))for(var r=0,i=e;r<i.length;r++){var o=i[r];this.addChild(o)}else{var a=e;a.forEach(function(t){n.addChild(t)},this)}},e.prototype.removeChild=function(t){var e=null;this._list.removeChild(t),this._rigidBody.isPhysicsEngineAdapterExist()&&(e=this._rigidBody.getPhysicsEngineAdapter(),e.removePointToPointConstraint(t))},__decorate([t.cloneAttributeAsCustomType(function(t,e,n){e[n]=t[n].clone(!0)})],e.prototype,"_list",void 0),e}();t.PointToPointConstraintList=a}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.create=function(e){var n=null;switch(e){case t.EPhysicsEngineType.CANNON:n=t.CannonAdapter.create();break;default:wdCb.Log.error(!0,wdCb.Log.info.FUNC_UNEXPECT("physics engine type"))}return n},e}();t.PhysicsEngineFactory=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.CANNON=0]="CANNON"}(t.EPhysicsEngineType||(t.EPhysicsEngineType={}));t.EPhysicsEngineType}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.dataList=wdCb.Collection.create()}return e.prototype.getCount=function(){return this.dataList.getCount()},e.prototype.removeByGameObject=function(e){this.dataList.removeChild(function(n){var r=n.entityObject;n.body;return t.JudgeUtils.isEqual(r,e)})},e}();t.CannonDataList=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.remove=function(t){this.removeByGameObject(t)},n.prototype.updateBodyTransformData=function(){this.dataList.forEach(function(e){var n=e.entityObject,r=e.body,i=n.transform;(i.isTranslate||i.isRotate)&&(r.position=t.CannonUtils.convertToCannonVector3(n.transform.position),r.quaternion=t.CannonUtils.convertToCannonQuaternion(n.transform.rotation))})},n.prototype.updateGameObjectTransformData=function(){this.dataList.forEach(function(e){var n=e.entityObject,r=e.body;n.hasTag("isRigidbodyChild")||(n.transform.position=t.CannonUtils.convertToWonderVector3(r.position),n.transform.rotation=t.CannonUtils.convertToWonderQuaternion(r.quaternion))})},n.prototype.add=function(t,e){this.dataList.addChild({entityObject:t,body:e})},n.prototype.findGameObjectByBody=function(t){var e=this.dataList.findOne(function(e){var n=(e.entityObject,e.body);return n===t});return null!==e?e.entityObject:null},n.prototype.findBodyByGameObject=function(e){var n=this.dataList.findOne(function(n){var r=n.entityObject;n.body;return t.JudgeUtils.isEqual(r,e)});return null!==n?n.body:null},n}(t.CannonDataList);t.CannonGameObjectDataList=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.remove=function(t){this.removeByGameObject(t)},n.prototype.findMaterialByGameObject=function(e){var n=this.dataList.findOne(function(n){var r=n.entityObject;n.material;return t.JudgeUtils.isEqual(r,e)});return null!==n?n.material:null},n.prototype.add=function(t,e){this.dataList.addChild({entityObject:t,material:e})},n.prototype.addContactMaterial=function(t,e,n,r){this.dataList.forEach(function(i){var o=(i.entityObject,i.material);t.addContactMaterial(new CANNON.ContactMaterial(o,e,{friction:n,restitution:r}))})},n.prototype.getContactMaterialData=function(t,e,n){var r=null;return this.dataList.forEach(function(i){var o=(i.entityObject,i.material),a=t.getContactMaterial(o,e);return a?(r=a[n],wdCb.$BREAK):void 0}),r},n.prototype.getContactMaterials=function(t,e){var n=[];return this.dataList.forEach(function(r){var i=(r.entityObject,r.material),o=t.getContactMaterial(i,e);o&&n.push(o)}),n},n.prototype.setContactMaterialData=function(t,e,n,r){this.dataList.forEach(function(i){var o=(i.entityObject,i.material),a=t.getContactMaterial(o,e);a&&(a[n]=r)})},n}(t.CannonDataList);t.CannonMaterialList=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(t.CannonDataList);t.CannonConstraintDataList=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.prototype.add=function(t,e){this.dataList.addChild({entityObject:t,constraint:e})},n.prototype.remove=function(t){this.removeByGameObject(t)},n.prototype.findConstraintByGameObject=function(e){var n=this.dataList.findOne(function(n){var r=n.entityObject;return t.JudgeUtils.isEqual(r,e)});return null!==n?n.constraint:null},n}(t.CannonConstraintDataList);t.CannonSingleConstraintDataList=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e}(t.CannonSingleConstraintDataList);t.CannonLockConstraintDataList=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.filter=function(t){return this.dataList.filter(t)},n.prototype.forEach=function(t){this.dataList.forEach(t)},n.prototype.add=function(t,e,n){this.dataList.addChild({entityObject:t,pointToPointConstraint:e,cannonConstraint:n})},n.prototype.remove=function(e){this.dataList.removeChild(function(n){var r=n.pointToPointConstraint;return t.JudgeUtils.isEqual(r,e)})},n.prototype.findCannonConstraintByPointToPointConstraint=function(e){var n=this.dataList.findOne(function(n){var r=n.pointToPointConstraint;return t.JudgeUtils.isEqual(r,e)});return null!==n?n.cannonConstraint:null},n}(t.CannonConstraintDataList);t.CannonPointToPointConstraintDataList=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e}(t.CannonSingleConstraintDataList);t.CannonDistanceConstraintDataList=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e}(t.CannonSingleConstraintDataList);t.CannonHingeConstraintDataList=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.convertToCannonVector3=function(t){return new CANNON.Vec3(t.x,t.y,t.z)},e.convertToCannonQuaternion=function(t){return new CANNON.Quaternion(t.x,t.y,t.z,t.w)},e.convertToWonderVector3=function(e){return t.Vector3.create(e.x,e.y,e.z)},e.convertToWonderQuaternion=function(e){return t.Quaternion.create(e.x,e.y,e.z,e.w)},e}();t.CannonUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.world=null,this._materialList=t.CannonMaterialList.create(),this._gameObjectDataList=t.CannonGameObjectDataList.create(),this._lockConstraintDataList=t.CannonLockConstraintDataList.create(),this._distanceConstraintDataList=t.CannonDistanceConstraintDataList.create(),this._hingeConstraintDataList=t.CannonHingeConstraintDataList.create(),this._pointToPointConstraintDataList=t.CannonPointToPointConstraintDataList.create(),this._dynamicBody=null,this._kinematicBody=null,this._staticBody=null,this._lockConstraint=null,this._distanceConstraint=null,this._hingeConstraint=null,this._pointToPointConstraint=null}return e.create=function(){var t=new this;return t},e.prototype.getGravity=function(e){return t.CannonUtils.convertToWonderVector3(this.world.gravity)},e.prototype.setGravity=function(e){this.world.gravity=t.CannonUtils.convertToCannonVector3(e)},e.prototype.getFriction=function(t,e){return this._getMaterialData(t,"friction")},e.prototype.setFriction=function(t,e){this._setMaterialData(t,"friction",e)},e.prototype.getRestitution=function(t,e){return this._getMaterialData(t,"restitution")},e.prototype.setRestitution=function(t,e){this._setMaterialData(t,"restitution",e)},e.prototype.getLinearDamping=function(t){return this._getNumberData(t,"linearDamping")},e.prototype.setLinearDamping=function(t,e){return this._setNumberData(t,"linearDamping",e)},e.prototype.getAngularDamping=function(t){return this._getNumberData(t,"angularDamping")},e.prototype.setAngularDamping=function(t,e){return this._setNumberData(t,"angularDamping",e)},e.prototype.getMass=function(t){return this._getNumberData(t,"mass")},e.prototype.setMass=function(t,e){return this._setNumberData(t,"mass",e)},e.prototype.getVelocity=function(t){return this._getVec3Data(t,"velocity")},e.prototype.setVelocity=function(t,e){this._setVec3Data(t,"velocity",e)},e.prototype.getAngularVelocity=function(t){return this._getVec3Data(t,"angularVelocity")},e.prototype.setAngularVelocity=function(t,e){this._setVec3Data(t,"angularVelocity",e)},e.prototype.init=function(){var e=t.Director.getInstance().scene.physics,n=e.gravity,r=e.iterations;this.world=new CANNON.World,this.world.broadphase=new CANNON.NaiveBroadphase,this.world.solver.iterations=r,this.world.gravity.set(n.x,n.y,n.z),this._dynamicBody=t.CannonDynamicBody.create(this.world,this._gameObjectDataList,this._materialList),this._kinematicBody=t.CannonKinematicBody.create(this.world,this._gameObjectDataList,this._materialList),this._staticBody=t.CannonStaticBody.create(this.world,this._gameObjectDataList,this._materialList),this._lockConstraint=t.CannonLockConstraint.create(this.world,this._gameObjectDataList,this._lockConstraintDataList),this._distanceConstraint=t.CannonDistanceConstraint.create(this.world,this._gameObjectDataList,this._distanceConstraintDataList),this._hingeConstraint=t.CannonHingeConstraint.create(this.world,this._gameObjectDataList,this._hingeConstraintDataList),this._pointToPointConstraint=t.CannonPointToPointConstraint.create(this.world,this._gameObjectDataList,this._pointToPointConstraintDataList)},e.prototype.addDynamicBody=function(t,e){this._dynamicBody.addBody(t,e)},e.prototype.addKinematicBody=function(t,e){this._kinematicBody.addBody(t,e)},e.prototype.addStaticBody=function(t,e){this._staticBody.addBody(t,e)},e.prototype.addLockConstraint=function(t,e){this._lockConstraint.addConstraint(t,e)},e.prototype.removeLockConstraint=function(t){this._lockConstraint.removeConstraint(t)},e.prototype.addDistanceConstraint=function(t,e){this._distanceConstraint.addConstraint(t,e)},e.prototype.removeDistanceConstraint=function(t){this._distanceConstraint.removeConstraint(t)},e.prototype.addHingeConstraint=function(t,e){this._hingeConstraint.addConstraint(t,e)},e.prototype.removeHingeConstraint=function(t){this._hingeConstraint.removeConstraint(t)},e.prototype.addPointToPointConstraint=function(t,e){this._pointToPointConstraint.addConstraint(t,e)},e.prototype.removePointToPointConstraint=function(t){this._pointToPointConstraint.removeConstraint(t)},e.prototype.removeGameObject=function(t){var e=(this._getMaterial(t),this._gameObjectDataList.findBodyByGameObject(t));e&&this.world.remove(e),this._gameObjectDataList.remove(t),this._materialList.remove(t)},e.prototype.removeConstraints=function(e){var n=this;this._lockConstraint.removeConstraint(e),this._distanceConstraint.removeConstraint(e),this._hingeConstraint.removeConstraint(e),this._pointToPointConstraintDataList.filter(function(n){var r=n.entityObject;return t.JudgeUtils.isEqual(r,e)}).forEach(function(t){var e=t.pointToPointConstraint;n._pointToPointConstraint.removeConstraint(e)})},e.prototype.update=function(e){this._gameObjectDataList.updateBodyTransformData(),this.world.step(t.Director.getInstance().getDeltaTime()/1e3),this._gameObjectDataList.updateGameObjectTransformData()},e.prototype._getMaterial=function(t){return this._materialList.findMaterialByGameObject(t)},e.prototype._getNumberData=function(t,e){var n=this._gameObjectDataList.findBodyByGameObject(t);return n?n[e]:null},e.prototype._setNumberData=function(t,e,n){var r=this._gameObjectDataList.findBodyByGameObject(t);return r?void(r[e]=n):null},e.prototype._getVec3Data=function(e,n){var r=this._gameObjectDataList.findBodyByGameObject(e);return r?t.CannonUtils.convertToWonderVector3(r[n]):null},e.prototype._setVec3Data=function(e,n,r){var i=this._gameObjectDataList.findBodyByGameObject(e);return i?void(i[n]=t.CannonUtils.convertToCannonVector3(r)):null},e.prototype._getMaterialData=function(t,e){var n=this._getMaterial(t);return n?this._materialList.getContactMaterialData(this.world,n,e):null},e.prototype._setMaterialData=function(e,n,r){var i=(this.world,this._getMaterial(e));return i?void this._materialList.setContactMaterialData(this.world,i,n,r):void t.Log.warn("no material find, please add material first")},__decorate([t.require(function(e,n){var r=[],i=null,o=this._getMaterial(e);if(!o)return null;r=this._materialList.getContactMaterials(this.world,o),i=r[0];for(var a=0,s=r;a<s.length;a++){var c=s[a];t.assert(c===i,t.Log.info.FUNC_SHOULD("the data of contact material which contains the same material","be the same"))}})],e.prototype,"_getMaterialData",null),e}();t.CannonAdapter=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t,e,n){this.world=null,this.materialList=null,this.gameObjectList=null,this.world=t,this.gameObjectList=e,this.materialList=n}return e.prototype.addBody=function(e,n){var r=this.createBody(n);return n.children.getCount()>0?this._addCompounds(e,n.children,r):r.addShape(this._createShape(e.getComponent(t.Collider).shape)),this.afterAddShape(r,n),r.material=this._createMaterial(e,n.friction,n.restitution),r.position=t.CannonUtils.convertToCannonVector3(n.position),r.quaternion=t.CannonUtils.convertToCannonQuaternion(n.rotation),this.world.addBody(r),this.gameObjectList.add(e,r),this._bindCollideEvent(r,n.onCollisionStart,n.onContact,n.onCollisionEnd),r},e.prototype.afterAddShape=function(t,e){},e.prototype._createShape=function(e){var n=null;return e instanceof t.AABBShape?n=new CANNON.Box(t.CannonUtils.convertToCannonVector3(e.halfExtents)):e instanceof t.SphereShape&&(n=new CANNON.Sphere(e.radius)),n},e.prototype._bindCollideEvent=function(t,e,n,r){var i=this;t.addEventListener("collide",function(t){var o=i.gameObjectList.findGameObjectByBody(t.body),a=null;o&&(a=o,e(a),n(a),r(a))})},e.prototype._createMaterial=function(t,e,n){var r=null,i=null;return(r=this._getMaterial(t))?r:(i=new CANNON.Material("material"),this._addMaterial(t,i,e,n),i)},e.prototype._getMaterial=function(t){return this.materialList.findMaterialByGameObject(t)},e.prototype._addMaterial=function(t,e,n,r){this.materialList.add(t,e),this.materialList.addContactMaterial(this.world,e,n,r)},e.prototype._addCompounds=function(e,n,r){var i=this,o=e.transform.position,a=e.transform.rotation;n.forEach(function(e){r.addShape(i._createShape(e.getComponent(t.Collider).shape),t.CannonUtils.convertToCannonVector3(e.transform.position.clone().sub(o)),t.CannonUtils.convertToCannonQuaternion(e.transform.rotation.clone().sub(a)))},this)},__decorate([t.virtual],e.prototype,"afterAddShape",null),__decorate([t.require(function(e,n,r){n.forEach(function(e){t.assert(!!e.getComponent(t.Collider),t.Log.info.FUNC_MUST_DEFINE("collider component")),t.assert(!!e.getComponent(t.Collider).shape,t.Log.info.FUNC_SHOULD("create collider.shape"))})})],e.prototype,"_addCompounds",null),e}();t.CannonBody=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t,e,n){var r=new this(t,e,n);return r},n.prototype.createBody=function(e){var n=e.mass,r=e.linearDamping,i=e.angularDamping,o=e.velocity,a=e.angularVelocity;return new CANNON.Body({mass:n,linearDamping:r,angularDamping:i,velocity:t.CannonUtils.convertToCannonVector3(o),angularVelocity:t.CannonUtils.convertToCannonVector3(a)})},n.prototype.afterAddShape=function(e,n){var r=n.impulse,i=n.force,o=n.hitPoint;r&&o&&e.applyImpulse(t.CannonUtils.convertToCannonVector3(r),t.CannonUtils.convertToCannonVector3(o)),i&&o&&e.applyForce(t.CannonUtils.convertToCannonVector3(i),t.CannonUtils.convertToCannonVector3(o))},n}(t.CannonBody);t.CannonDynamicBody=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t,e,n){var r=new this(t,e,n);return r},n.prototype.createBody=function(e){var n=e.mass,r=e.velocity,i=e.angularVelocity;return new CANNON.Body({type:CANNON.Body.KINEMATIC,mass:n,velocity:t.CannonUtils.convertToCannonVector3(r),angularVelocity:t.CannonUtils.convertToCannonVector3(i)})},n}(t.CannonBody);t.CannonKinematicBody=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(t,e,n){var r=new this(t,e,n);return r},e.prototype.createBody=function(t){return new CANNON.Body({mass:0})},e}(t.CannonBody);t.CannonStaticBody=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t,e,n){this.world=null,this.gameObjectList=null,this.constraintDataList=null,this.world=t,this.gameObjectList=e,this.constraintDataList=n}return e.prototype.addConstraint=function(t,e){var n=null,r=this.gameObjectList.findBodyByGameObject(t);n=this.createCannonConstraint(r,e),this.world.addConstraint(n),this.addToConstraintDataList(t,e,n)},e.prototype.findBody=function(t){return this.gameObjectList.findBodyByGameObject(t.entityObject)},__decorate([t.require(function(e,n){t.assert(null!==this.gameObjectList.findBodyByGameObject(e),t.Log.info.FUNC_SHOULD("add rigid body")),t.assert(this.findBody(n.connectedBody),t.Log.info.FUNC_SHOULD("add connectedBody"))})],e.prototype,"addConstraint",null),e}();t.CannonConstraint=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.removeConstraint=function(t){var e=this.constraintDataList.findConstraintByGameObject(t);e&&this.world.removeConstraint(e),this.constraintDataList.remove(t)},e.prototype.addToConstraintDataList=function(t,e,n){this.constraintDataList.add(t,n)},e}(t.CannonConstraint);t.CannonSingleConstraint=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(t,e,n){var r=new this(t,e,n);return r},e.prototype.createCannonConstraint=function(t,e){var n=null,r=this.findBody(e.connectedBody);return n=e.maxForce?new CANNON.LockConstraint(t,r,e.maxForce):new CANNON.LockConstraint(t,r)},e}(t.CannonSingleConstraint);t.CannonLockConstraint=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t,e,n){var r=new this(t,e,n);return r},n.prototype.removeConstraint=function(t){var e=this.constraintDataList.findCannonConstraintByPointToPointConstraint(t);e&&this.world.removeConstraint(e),this.constraintDataList.remove(t)},n.prototype.createCannonConstraint=function(e,n){var r=null,i=this.findBody(n.connectedBody),o=t.CannonUtils.convertToCannonVector3(n.pivotA),a=t.CannonUtils.convertToCannonVector3(n.pivotB);return r=n.maxForce?new CANNON.PointToPointConstraint(e,o,i,a,n.maxForce):new CANNON.PointToPointConstraint(e,o,i,a)},n.prototype.addToConstraintDataList=function(t,e,n){this.constraintDataList.add(t,e,n)},n}(t.CannonConstraint);t.CannonPointToPointConstraint=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(t,e,n){var r=new this(t,e,n);return r},e.prototype.createCannonConstraint=function(t,e){var n=null,r=this.findBody(e.connectedBody);return n=new CANNON.DistanceConstraint(t,r,null!==e.distance?e.distance:void 0,null!==e.maxForce?e.maxForce:void 0)},e}(t.CannonSingleConstraint);t.CannonDistanceConstraint=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t,e,n){var r=new this(t,e,n);return r},n.prototype.createCannonConstraint=function(e,n){var r=null,i=this.findBody(n.connectedBody),o=t.CannonUtils.convertToCannonVector3(n.pivotA),a=t.CannonUtils.convertToCannonVector3(n.axisA),s=t.CannonUtils.convertToCannonVector3(n.pivotB),c=t.CannonUtils.convertToCannonVector3(n.axisB),u={};return n.pivotA&&(u.pivotA=o),n.axisA&&(u.axisA=a),n.pivotB&&(u.pivotB=s),n.axisB&&(u.axisB=c),n.maxForce&&(u.maxForce=n.maxForce),r=new CANNON.HingeConstraint(e,i,u)},n}(t.CannonSingleConstraint);t.CannonHingeConstraint=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._shadowMapWidth=null,this._shadowMapHeight=null,this.color=t.Color.create("#ffffff"),this.castShadow=!1,this.shadowCameraNear=.1,this.shadowCameraFar=5e3,this.shadowBias=t.ShaderChunk.NULL,this.shadowDarkness=0}return __extends(n,e),Object.defineProperty(n.prototype,"position",{get:function(){return this.entityObject.transform.position},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"shadowMapWidth",{get:function(){var e=t.GPUDetector.getInstance().maxCubemapTextureSize;return!this._shadowMapWidth||this._shadowMapWidth>e?e:this._shadowMapWidth},set:function(t){this._shadowMapWidth=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"shadowMapHeight",{get:function(){var e=t.GPUDetector.getInstance().maxCubemapTextureSize;return!this._shadowMapHeight||this._shadowMapHeight>e?e:this._shadowMapHeight},set:function(t){this._shadowMapHeight=t},enumerable:!0,configurable:!0}),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"shadowMapWidth",null),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"shadowMapHeight",null),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"color",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"castShadow",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"shadowCameraNear",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"shadowCameraFar",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"shadowBias",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"shadowDarkness",void 0),n}(t.Component);t.Light=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e.type="ambientLight",e}(t.Light);t.AmbientLight=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.intensity=1}return __extends(n,e),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"intensity",void 0),n}(t.Light);t.SourceLight=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.shadowCameraLeft=-1e3,this.shadowCameraRight=1e3,this.shadowCameraTop=1e3,this.shadowCameraBottom=-1e3}return __extends(n,e),n.create=function(){var t=new this;return t},n.type="directionLight",n.defaultPosition=t.Vector3.create(0,0,1),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"shadowCameraLeft",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"shadowCameraRight",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"shadowCameraTop",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"shadowCameraBottom",void 0),n}(t.SourceLight);t.DirectionLight=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._rangeLevel=null,this._attenuation=t.Attenuation.create()}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"rangeLevel",{get:function(){return this._rangeLevel},set:function(t){this._rangeLevel=t,this._attenuation.rangeLevel=this._rangeLevel},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"range",{get:function(){return this._attenuation.range},set:function(t){this._attenuation.range=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"constant",{get:function(){return this._attenuation.constant},set:function(t){this._attenuation.constant=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"linear",{get:function(){return this._attenuation.linear},set:function(t){this._attenuation.linear=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"quadratic",{get:function(){return this._attenuation.quadratic},set:function(t){this._attenuation.quadratic=t},enumerable:!0,configurable:!0}),n.type="pointLight",__decorate([t.cloneAttributeAsBasicType()],n.prototype,"rangeLevel",null),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"range",null),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"constant",null),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"linear",null),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"quadratic",null),n}(t.SourceLight);t.PointLight=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._constant=1,this._range=null,this._linear=0,this._quadratic=0,this._rangeLevel=0}return e.create=function(){var t=new this;return t},Object.defineProperty(e.prototype,"constant",{get:function(){return this._constant},set:function(t){this._constant=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"range",{get:function(){return this._range},set:function(t){this._range=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"linear",{get:function(){return this._linear},set:function(t){this._linear=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"quadratic",{get:function(){return this._quadratic},set:function(t){this._quadratic=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rangeLevel",{get:function(){return this._rangeLevel},set:function(t){t&&(this._rangeLevel=t,this.setByRangeLevel())},enumerable:!0,configurable:!0}),e.prototype.setByRangeLevel=function(){switch(this._rangeLevel){case 0:this._range=7,this._linear=.7,this._quadratic=1.8;break;case 1:this._range=13,this._linear=.35,this._quadratic=.44;break;case 2:this._range=20,this._linear=.22,this._quadratic=.2;break;case 3:this._range=32,this._linear=.14,this._quadratic=.07;break;case 4:this._range=50,this._linear=.09,this._quadratic=.032;break;case 5:this._range=65,this._linear=.07,this._quadratic=.017;break;case 6:this._range=100,this._linear=.045,this._quadratic=.0075;break;case 7:this._range=160,this._linear=.027,this._quadratic=.0028;break;case 8:this._range=200,this._linear=.022,this._quadratic=.0019;break;case 9:this._range=325,this._linear=.014,this._quadratic=7e-4;break;case 10:this._range=600,this._linear=.007,this._quadratic=2e-4;break;case 11:this._range=3250,this._linear=.0014,this._quadratic=7e-6;break;default:t.Log.error(!0,"over light range")}},e}();t.Attenuation=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.PHONG="PHONG"]="PHONG",t[t.BLINN="BLINN"]="BLINN",t[t.LAMBERT="LAMBERT"]="LAMBERT",t[t.CONSTANT="CONSTANT"]="CONSTANT"}(t.ELightModel||(t.ELightModel={}));t.ELightModel}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.context=null}return __extends(n,e),Object.defineProperty(n.prototype,"dirty",{get:function(){var t=this.getUIRenderer();return t?t.dirty:!0},set:function(t){if(t){var e=this.getUIRenderer();if(!e)return;e.dirty=t}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"width",{get:function(){return this.entityObject?this.entityObject.transform.width:null},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"height",{get:function(){return this.entityObject?this.entityObject.transform.height:null},enumerable:!0,configurable:!0}),n.prototype.update=function(t){},n.prototype.init=function(){this.context=this.getContext()},n.prototype.addToObject=function(n,r){void 0===r&&(r=!1);var i=t.UIEngine.getInstance();e.prototype.addToObject.call(this,n,r),i.hasChild(this)||i.addChild(this)},n.prototype.removeFromObject=function(n){e.prototype.removeFromObject.call(this,n),t.UIEngine.getInstance().removeChild(this)},n.prototype.render=function(){var t=this.context;this.shouldNotRender()||(t.save(),this._setCanvasTransformForRotation(),this.draw(),t.restore())},n.prototype.draw=function(){},n.prototype.shouldNotRender=function(){return!1},n.prototype.getContext=function(){return this.getUIRenderer().context},n.prototype.getCanvas=function(){return this.getUIRenderer().canvas},n.prototype.getUIRenderer=function(){return this.entityObject?this.entityObject.getComponent(t.UIRenderer):null},n.prototype.drawInCenterPoint=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=t[0],r=t[1];if(5===t.length){var i=t[2],o=t[3],a=t[4];n.drawImage(r,i.x-o/2,i.y-a/2,o,a)}else if(9===t.length){var s=t[2],c=t[3],u=t[4],l=t[5],i=t[6],o=t[7],a=t[8];n.drawImage(r,s,c,u,l,i.x-o/2,i.y-a/2,o,a)}},n.prototype._setCanvasTransformForRotation=function(){var t=this.entityObject.transform.rotationMatrix;this.context.setTransform(t.a,t.b,t.c,t.d,t.tx,t.ty)},__decorate([t.virtual],n.prototype,"dirty",null),__decorate([t.virtual],n.prototype,"update",null),__decorate([t.require(function(e){t.assert(e instanceof t.UIObject,t.Log.info.FUNC_SHOULD("Octree component","add to GameObject"))})],n.prototype,"addToObject",null),__decorate([t.require(function(){t.assert(null!==this.context,t.Log.info.FUNC_SHOULD("set context"))})],n.prototype,"render",null),__decorate([t.virtual],n.prototype,"draw",null),__decorate([t.virtual],n.prototype,"shouldNotRender",null),n}(t.Component);t.UI=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.LEFT=0]="LEFT",t[t.CENTER=1]="CENTER",t[t.RIGHT=2]="RIGHT"}(t.EFontXAlignment||(t.EFontXAlignment={}));t.EFontXAlignment}(wd||(wd={}));var wd;!function(t){!function(t){t[t.TOP=0]="TOP",t[t.MIDDLE=1]="MIDDLE",t[t.BOTTOM=2]="BOTTOM"}(t.EFontYAlignment||(t.EFontYAlignment={}));t.EFontYAlignment}(wd||(wd={}));var wd;!function(t){!function(t){t[t.AUTO="auto"]="AUTO"}(t.EFontDimension||(t.EFontDimension={}));t.EFontDimension}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.needFormat=!1,this._isFirstUpdate=!0,this._sizeChangeEventSubscription=null}return __extends(n,e),n.prototype.init=function(){var n=this;e.prototype.init.call(this),this._sizeChangeEventSubscription=t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.UI_WIDTH_CHANGE).merge(t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.UI_HEIGHT_CHANGE)).subscribe(function(){n.dirty=!0,n.needFormat=!0})},n.prototype.dispose=function(){this._sizeChangeEventSubscription&&this._sizeChangeEventSubscription.dispose()},n.prototype.update=function(t){this._isFirstUpdate?this._isFirstUpdate=!1:this.needFormat&&this.reFormat(),this.needFormat=!1},n.prototype.reFormat=function(){},n.prototype.getLeftCornerPosition=function(){var e=this.entityObject.transform,n=e.position;return t.Vector2.create(n.x-e.width/2,n.y-e.height/2)},__decorate([t.virtual],n.prototype,"reFormat",null),n}(t.UI);t.Font=e}(wd||(wd={}));var wd;!function(t){var e=/([a-zA-Z0-9]+|\S)/,n=/^[a-zA-Z0-9]/,r=/[a-zA-Z0-9]+$/,i=/\s+$/,o=function(o){function a(){o.apply(this,arguments),this._text="",this._fontSize=10,this._fontFamily="sans-serif",this._xAlignment=t.EFontXAlignment.LEFT,this._yAlignment=t.EFontYAlignment.TOP,this._fillEnabled=!0,this._fillStyle="rgba(0, 0, 0, 1)",this._strokeEnabled=!1,this._strokeStyle=null,this._strokeSize=null,
this._fontClientHeightCache=wdCb.Hash.create(),this._lineHeight=null,this._strArr=[]}return __extends(a,o),a.create=function(){var t=new this;return t},Object.defineProperty(a.prototype,"text",{get:function(){return this._text},set:function(t){this._text!==t&&(this._text=t,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"fontSize",{get:function(){return this._fontSize},set:function(t){this._fontSize!==t&&(this._fontSize=t,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"fontFamily",{get:function(){return this._fontFamily},set:function(t){this._fontFamily!==t&&(this._fontFamily=t,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"xAlignment",{get:function(){return this._xAlignment},set:function(t){this._xAlignment!==t&&(this._xAlignment=t,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"yAlignment",{get:function(){return this._yAlignment},set:function(t){this._yAlignment!==t&&(this._yAlignment=t,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),a.prototype.init=function(){o.prototype.init.call(this),this._formatText(),this._lineHeight||(this._lineHeight=this._getDefaultLineHeight())},a.prototype.setFillStyle=function(t){this._fillStyle=t},a.prototype.enableStroke=function(t,e){this._strokeEnabled=!0,this._fillEnabled=!1,this._strokeStyle=t,this._strokeSize=e},a.prototype.enableFill=function(t){this._fillEnabled=!0,this._strokeEnabled=!1,this._fillStyle=t},a.prototype.setLineHeight=function(t){this._lineHeight=t},a.prototype.reFormat=function(){this._formatText(),this._lineHeight=this._getDefaultLineHeight()},a.prototype.draw=function(){var t=this.context;t.font=this.fontSize+"px '"+this.fontFamily+"'",t.textBaseline="top",t.textAlign="start",this._strArr.length>1?this._drawMultiLine():this._drawSingleLine()},a.prototype._formatText=function(){var t=this.width;if(this._trimStr(),0!==t){this._strArr=this._text.split("\n");for(var e=0;e<this._strArr.length;e++){var n=this._strArr[e],r=this._measure(n);r>t&&n.length>1&&this._formatMultiLine(e,n,r,t)}}},a.prototype._trimStr=function(){this._text=this._text.replace(i,"")},a.prototype._formatMultiLine=function(t,i,o,a){var s=this,c=100,u=this,l=null,h=i.length*(a/o)|0,d=i.substr(h),p=0,f=o-this._measure(d),_=0,g=function(){for(;f>a&&c>p;)h*=a/f,h=Math.floor(h),d=i.substr(h),f=o-s._measure(d),p+=1;p=0},m=function(){for(;a>f&&c>p;){if(d){var t=e.exec(d);_=t?t[0].length:1}h+=_,d=i.substr(h),f=o-s._measure(d),p+=1}},y=function(){if(n.test(d)){var t=i.substr(0,h),e=r.exec(t);e&&(h-=e[0].length)}else h-=_;0===h&&(h=1)},v=function(){d=i.substr(h),l=i.substr(0,h),u._strArr[t]=d,u._strArr.splice(t,0,l)};g(),m(),y(),v()},a.prototype._measure=function(t){var e=this.context;return e.font=this.fontSize+"px '"+this.fontFamily+"'",e.measureText(t).width},a.prototype._getDefaultLineHeight=function(){return this._computeLineHeight("normal")},a.prototype._computeLineHeight=function(t){var e=wdCb.DomQuery.create("<div></div>"),n=e.get(0),r=null;return n.style.cssText="\n             font-family: "+this.fontFamily+";\n             font-size: "+this.fontSize+"px;\n             position: absolute;\n             left: -100px;\n             top: -100px;\n             line-height: "+t+";\n             ",e.prependTo("body"),n.innerHTML="abc!",r=n.clientHeight,e.remove(),r},a.prototype._getFontClientHeight=function(){var t=this.fontSize,e=this.fontFamily,n=t+"."+e,r=this._fontClientHeightCache.getChild(n),i=null;return r?r:(i=this._computeLineHeight(1),this._fontClientHeightCache.addChild(n,i),i)},a.prototype._drawMultiLine=function(){var e=this.context,n=this.getLeftCornerPosition(),r=n.x,i=n.y,o=this._lineHeight,a=this._getFontClientHeight(),s=this,c=this._strArr.length,u=(c-1)*o+a;s.yAlignment===t.EFontYAlignment.BOTTOM?i=i+s.height-u:s.yAlignment===t.EFontYAlignment.MIDDLE&&(i+=(s.height-u)/2);for(var l=0,h=this._strArr;l<h.length;l++){var d=h[l];s.xAlignment===t.EFontXAlignment.RIGHT?r=r+s.width-s._measure(d):s.xAlignment==t.EFontXAlignment.CENTER&&(r+=(s.width-s._measure(d))/2),s._fillEnabled?(e.fillStyle=s._fillStyle,e.fillText(d,r,i)):s._strokeEnabled&&(e.strokeStyle=s._strokeStyle,e.lineWidth=s._strokeSize,e.strokeText(d,r,i)),r=n.x,i+=o}},a.prototype._drawSingleLine=function(){var e=this.context,n=this.getLeftCornerPosition(),r=n.x,i=n.y,o=this._getFontClientHeight(),a=this,s=o,c=this._strArr[0];a.yAlignment===t.EFontYAlignment.BOTTOM?i=i+a.height-s:a.yAlignment===t.EFontYAlignment.MIDDLE&&(i+=(a.height-s)/2),a.xAlignment===t.EFontXAlignment.RIGHT?r=r+a.width-a._measure(c):a.xAlignment==t.EFontXAlignment.CENTER&&(r+=(a.width-a._measure(c))/2),a._fillEnabled?(e.fillStyle=a._fillStyle,e.fillText(c,r,i)):a._strokeEnabled&&(e.strokeStyle=a._strokeStyle,e.lineWidth=a._strokeSize,e.strokeText(c,r,i))},__decorate([t.cloneAttributeAsBasicType()],a.prototype,"text",null),__decorate([t.cloneAttributeAsBasicType()],a.prototype,"fontSize",null),__decorate([t.cloneAttributeAsBasicType()],a.prototype,"fontFamily",null),__decorate([t.cloneAttributeAsBasicType()],a.prototype,"xAlignment",null),__decorate([t.cloneAttributeAsBasicType()],a.prototype,"yAlignment",null),__decorate([t.cloneAttributeAsBasicType()],a.prototype,"_fillEnabled",void 0),__decorate([t.cloneAttributeAsBasicType()],a.prototype,"_fillStyle",void 0),__decorate([t.cloneAttributeAsBasicType()],a.prototype,"_strokeEnabled",void 0),__decorate([t.cloneAttributeAsBasicType()],a.prototype,"_strokeStyle",void 0),__decorate([t.cloneAttributeAsBasicType()],a.prototype,"_strokeSize",void 0),__decorate([t.cloneAttributeAsBasicType()],a.prototype,"_lineHeight",void 0),a}(t.Font);t.PlainFont=o}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._text="",this._xAlignment=t.EFontXAlignment.LEFT,this.fntId=null,this.bitmapId=null,this._charFontList=wdCb.Collection.create()}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"text",{get:function(){return this._text},set:function(t){this._text!==t&&(this._text=t,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"xAlignment",{get:function(){return this._xAlignment},set:function(t){this._xAlignment!==t&&(this._xAlignment=t,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),n.prototype.init=function(){var n=this._getFntObj(),r=this._getImageAsset();return n?r?(e.prototype.init.call(this),this._createAndAddFontCharUIObjects(n,r.source),void this._formatText(n)):(t.Log.log("impossible to create font: not find bitmap file"),!1):(t.Log.log("impossible to create font: not find fnt file"),!1)},n.prototype.dispose=function(){e.prototype.dispose.call(this),this._removeAllCharFont()},n.prototype.reFormat=function(){var e=this._getFntObj(),n=this._getImageAsset();return this._removeAllCharFont(),e?n?(this._createAndAddFontCharUIObjects(e,n.source),void this._formatText(e)):(t.Log.log("impossible to create font: not find bitmap file"),!1):(t.Log.log("impossible to create font: not find fnt file"),!1)},n.prototype._getFntObj=function(){return t.LoaderManager.getInstance().get(this.fntId)},n.prototype._getImageAsset=function(){return t.LoaderManager.getInstance().get(this.bitmapId)},n.prototype._createAndAddFontCharUIObjects=function(e,n){for(var r=this.text,i=e.fontDefDictionary,o=0,a=0,s=this.getLeftCornerPosition(),c=this.getUIRenderer(),u=null,l=null,h=0,d=r.length;d>h;h++){var p=String(r.charCodeAt(h)),f=r[h];if(this._isNewLine(f)){var _=this._createAndAddFontCharObjectOfNewLineChar(h,f,c);u=_.charFontUIObject,l=_.charFont,this._setCharFontUIObjectPosition(u,s.x+o,s.y+a),l.startPosX=o,l.xAdvance=0,o=0,a+=e.commonHeight}else{var g=this._getFontDef(i,p),m=null;g?(m=this._createAndAddFontCharObjectOfCommonChar(g,n,h,f,c),u=m.charFontUIObject,l=m.charFont,this._setCharFontUIObjectPosition(u,s.x+o+g.xOffset,s.y+a+g.yOffset),l.startPosX=o,l.xAdvance=g.xAdvance,o+=g.xAdvance):t.Log.log("character not found "+f)}}},n.prototype._createAndAddFontCharObjectOfNewLineChar=function(e,n,r){var i=this._findCharFontUIObject(e),o=null;if(i)o=i.getComponent(t.CharFont);else{var a=this._createCharFont(e,r);i=a.charFontUIObject,o=a.charFont,this._addCharFontUIObject(i)}return o["char"]=n,{charFontUIObject:i,charFont:o}},n.prototype._createAndAddFontCharObjectOfCommonChar=function(e,n,r,i,o){var a=t.RectRegion.create(e.rect.x,e.rect.y,e.rect.width,e.rect.height),s=this._findCharFontUIObject(r),c=null;if(s)c=s.getComponent(t.CharFont);else{var u=this._createCharFont(r,o),l=null;s=u.charFontUIObject,l=s.transform,c=u.charFont,c.image=n,c.rectRegion=a,l.width=a.width,l.height=a.height,this._addCharFontUIObject(s)}return c["char"]=i,{charFontUIObject:s,charFont:c}},n.prototype._formatText=function(t){this.width>0&&this._formatMultiLine(t),this._formatAlign()},n.prototype._formatMultiLine=function(e){for(var n=(this.entityObject,null),r=null,i=this.getLeftCornerPosition(),o=0,a=0,s=e.commonHeight,c=1,u=this.text.length;u>c;c++)if(n=this._findCharFontUIObject(c),r=n.getComponent(t.CharFont),this._isNewLine(r["char"])&&(r.isNewLine=!0,r.isFullLine=!1,this._translateCharFontUIObject(n,-o,a),o=0),this._isExceedWidth(i,r,o)){var l=this._findCharFontUIObject(c-1);if(l){var h=l.getComponent(t.CharFont);h.isNewLine=!0,this._isSpaceUnicode(h["char"])||(h.isFullLine=!0)}o=this._getLetterPosXLeft(r),a+=s,this._translateCharFontUIObject(n,-o,a)}else this._translateCharFontUIObject(n,-o,a)},n.prototype._formatAlign=function(){var e=this.getLeftCornerPosition(),n=this;if(this._xAlignment!=t.EFontXAlignment.LEFT){var r=[];this._charFontList.forEach(function(i){var o=i.getComponent(t.CharFont);return o.isNewLine?o.isNewLine&&o.isFullLine?void(r=[]):(n._alignLine(e,r,r[r.length-1]),void(r=[])):void r.push(o)}),r.length>0&&n._alignLine(e,r,r[r.length-1])}},n.prototype._createCharFont=function(e,n){var r=t.UIObject.create(),i=t.CharFont.create();return r.addComponent(i),r.addComponent(n),r.addTag(String(e)),r.init(),{charFontUIObject:r,charFont:i}},n.prototype._addCharFontUIObject=function(t){this._charFontList.addChild(t),this.entityObject.addChild(t)},n.prototype._findCharFontUIObject=function(t){return this.entityObject.findChildByTag(String(t))},n.prototype._isSpaceUnicode=function(t){var e=t.charCodeAt(0);return 32==e||133==e||160==e||5760==e||e>=8192&&8202>=e||8232==e||8233==e||8239==e||8287==e||12288==e},n.prototype._isNewLine=function(t){return 10==t.charCodeAt(0)},n.prototype._getLetterPosXLeft=function(t){return t.startPosX},n.prototype._getLetterPosXRight=function(e,n){return t.CoordinateUtils.convertCenterPositionXToLeftCornerPositionX(n.x,n.width)-e.x+n.xAdvance},n.prototype._getFontDef=function(t,e){return t[e]},n.prototype._isExceedWidth=function(t,e,n){return this._getLetterPosXRight(t,e)-n>this.width},n.prototype._alignLine=function(e,n,r){var i=this;n=this._trimBottomSpaceChar(n),r=n[n.length-1],n.forEach(function(n){var o=null,a=i._getLetterPosXRight(e,r);switch(i._xAlignment){case t.EFontXAlignment.CENTER:o=(i.width-a)/2;break;case t.EFontXAlignment.RIGHT:o=i.width-a}n.x=n.x+o})},n.prototype._trimBottomSpaceChar=function(t){var e=t.length-1;for(this._isNewLine(t[e]["char"])&&(e-=1);e>=0&&this._isSpaceUnicode(t[e]["char"]);)e-=1;return t=t.splice(0,e+1)},n.prototype._setCharFontUIObjectPosition=function(e,n,r){var i=e.transform;e.transform.position=t.CoordinateUtils.convertLeftCornerPositionToCenterPosition(t.Vector2.create(n,r),i.width,i.height)},n.prototype._translateCharFontUIObject=function(t,e,n){t.transform.translate(e,n)},n.prototype._removeAllCharFont=function(){this._charFontList.forEach(function(t){t.dispose()}),this._charFontList.removeAllChildren()},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"text",null),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"xAlignment",null),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"fntId",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"bitmapId",void 0),__decorate([t.require(function(e){if(this.width>0)for(var n=1,r=this.text.length;r>n;n++){var i=this.entityObject.findChildByTag(String(n));t.assert(!!i,"char not has corresponding entityObject"),t.assert(i.hasComponent(t.CharFont),t.Log.info.FUNC_SHOULD("char entityObject","contain CharFont component"))}})],n.prototype,"_formatText",null),n}(t.Font);t.BitmapFont=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._char=null,this.startPosX=null,this.xAdvance=null,this.image=null,this.rectRegion=null,this.isNewLine=!1,this.isFullLine=!1,this._subscription=null}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"x",{get:function(){return this.entityObject.transform.position.x},set:function(e){var n=this.entityObject.transform.position;this.entityObject.transform.position=t.Vector2.create(e,n.y)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"y",{get:function(){return this.entityObject.transform.position.y},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"char",{get:function(){return this._char},set:function(e){return null!==this._char?void t.Log.log(t.Log.info.FUNC_NOT_SUPPORT("change char")):void(this._char=e)},enumerable:!0,configurable:!0}),n.prototype.clone=function(){return t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("clone")),null},n.prototype.init=function(){var n=this;e.prototype.init.call(this),this._subscription=wdFrp.fromArray([t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.TRANSFORM_TRANSLATE),t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.TRANSFORM_ROTATE),t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.TRANSFORM_SCALE)]).mergeAll().subscribe(function(){n.dirty=!0})},n.prototype.dispose=function(){e.prototype.dispose.call(this),this._subscription.dispose()},n.prototype.shouldNotRender=function(){return null===this.rectRegion||0===this.width&&0===this.height},n.prototype.draw=function(){var t=null,e=null,n=null,r=null;t=this.entityObject.transform,e=t.position,n=this.width,r=this.height,this.drawInCenterPoint(this.context,this.image,this.rectRegion.x,this.rectRegion.y,this.rectRegion.width,this.rectRegion.height,e,n,r)},__decorate([t.execOnlyOnce("_isInit")],n.prototype,"init",null),n}(t.Font);t.CharFont=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._percent=0,this.borderStyle="rgba(0, 0, 0, 1)",this.fillStyle="rgba(255, 0, 0, 1)",this.radius=5,this._offScreenCanvas=null,this._offScreenContext=null}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"percent",{get:function(){return this._percent},set:function(t){this._percent!==t&&(this._percent=t,this.dirty=!0)},enumerable:!0,configurable:!0}),n.prototype.init=function(){e.prototype.init.call(this),this._createOffScreenCanvas(),this._drawProgressBar()},n.prototype.shouldNotRender=function(){return this.percent<=0},n.prototype.draw=function(){var t=this.entityObject.transform.position;this._drawFromLeft(t),this._drawBorder(t)},n.prototype._drawFromLeft=function(e){var n=this._offScreenCanvas,r=this.width*this.percent;this.drawInCenterPoint(this.context,n,0,0,r,this.height,t.Vector2.create(e.x-this.width/2+r/2,e.y),r,this.height)},n.prototype._drawBorder=function(e){t.RoundedRectUtils.drawRoundedRect(this.context,this.borderStyle,null,e.x-this.width/2,e.y-this.height/2,this.width,this.height,this.radius)},n.prototype._createOffScreenCanvas=function(){var t=wdCb.DomQuery.create("<canvas></canvas>");t.attr("width",this.context.canvas.width),t.attr("height",this.context.canvas.height),this._offScreenCanvas=t.get(0),this._offScreenContext=this._offScreenCanvas.getContext("2d")},n.prototype._drawProgressBar=function(){this._offScreenContext.clearRect(0,0,this._offScreenCanvas.width,this._offScreenCanvas.height),t.RoundedRectUtils.drawRoundedRect(this._offScreenContext,this.borderStyle,this.fillStyle,0,0,this.width,this.height,this.radius)},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"percent",null),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"borderStyle",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"fillStyle",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"radius",void 0),__decorate([t.require(function(){t.assert(this.percent>=0&&this.percent<=1,t.Log.info.FUNC_SHOULD("percent"," >= 0 and <= 1"))})],n.prototype,"draw",null),n}(t.UI);t.ProgressBar=e}(wd||(wd={}));var wd;!function(t){function e(){var t=null,e=null;return"undefined"==typeof document?!1:(t=document.createElement("canvas"),t.width=1,t.height=1,e=t.getContext("2d"),e.fillStyle="#000",e.fillRect(0,0,1,1),e.globalCompositeOperation="multiply",e.fillStyle="#fff",e.fillRect(0,0,1,1),0===e.getImageData(0,0,1,1).data[0])}var n=function(n){function r(){n.apply(this,arguments),this._source=null,this.color=null,this.targetSource=null,this.targetColor=null}return __extends(r,n),r.create=function(){var t=new this;return t},Object.defineProperty(r.prototype,"source",{get:function(){return this._source},set:function(t){t!==this._source&&(this._source=t,this.dirty=!0)},enumerable:!0,configurable:!0}),r.prototype.shouldNotRender=function(){return null===this._getDrawSource()&&null===this._getDrawColor()},r.prototype.draw=function(){var t=this._getDrawColor(),e=this._getDrawSource();if(null!==t){var n=this.entityObject.transform.position;this._setFillStyle(t.toString()),t.a<1&&this._setGlobalAlpha(this.context,t.a),this.context.fillRect(n.x-this.width/2,n.y-this.height/2,this.width,this.height),e&&this._blendColorWithSource()}else this.drawInCenterPoint(this.context,e.source,this.entityObject.transform.position,this.width,this.height)},r.prototype._setFillStyle=function(t){this.context.fillStyle=t},r.prototype._getDrawSource=function(){return this.targetSource?this.targetSource:this.source},r.prototype._getDrawColor=function(){return this.targetColor?this.targetColor:this.color},r.prototype._blendByMultiply=function(){this._setGlobalCompositeOperation(this.context,"multiply"),this.drawInCenterPoint(this.context,this._getDrawSource().source,this.entityObject.transform.position,this.width,this.height)},r.prototype._blendByPerPixel=function(){var t=this.context,e=this.getCanvas(),n=this.color.r,r=this.color.g,i=this.color.b,o=null,a=null;t.globalCompositeOperation="clone",this.drawInCenterPoint(this.context,this._getDrawSource().source,this.entityObject.transform.position,this.width,this.height),o=t.getImageData(0,0,e.width,e.height),a=o.data;for(var s=0,c=a.length;c>s;s+=4)a[s]*=n,a[s+1]*=r,a[s+2]*=i;t.putImageData(o,0,0)},r.prototype._setGlobalCompositeOperation=function(t,e){t.globalCompositeOperation=e},r.prototype._setGlobalAlpha=function(t,e){t.globalAlpha=e},r.constructorForBlend=function(t){return t._blendColorWithSource=e()?t._blendByMultiply:t._blendByPerPixel,!0},r.constructorInitForBlend=r.constructorForBlend(r.prototype),__decorate([t.cloneAttributeAsCloneable()],r.prototype,"source",null),__decorate([t.cloneAttributeAsCloneable()],r.prototype,"color",void 0),__decorate([t.cloneAttributeAsCustomType(function(e,n,r){e[r]&&(n[r]=t.ImageTextureAsset.create(e[r].source))})],r.prototype,"targetSource",void 0),__decorate([t.cloneAttributeAsCloneable()],r.prototype,"targetColor",void 0),__decorate([t.require(function(){t.assert(!!this._getDrawSource(),t.Log.info.FUNC_SHOULD("source","exist"))})],r.prototype,"_blendByMultiply",null),__decorate([t.require(function(){t.assert(!!this._getDrawSource(),t.Log.info.FUNC_SHOULD("source","exist"))})],r.prototype,"_blendByPerPixel",null),r}(t.UI);t.Image=n}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.p_transitionMode=null,this.transitionManager=t.TransitionManager.create(this)}return __extends(n,e),Object.defineProperty(n.prototype,"transitionMode",{get:function(){return this.p_transitionMode},set:function(t){this.p_transitionMode=t},enumerable:!0,configurable:!0}),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"transitionMode",null),__decorate([t.cloneAttributeAsCloneable({isInjectTarget:!0})],n.prototype,"transitionManager",void 0),n}(t.UI);t.InteractionUI=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._text=null,this._mousedownSubscription=null,this._mouseupSubscription=null,this._mouseoverSubscription=null,this._mouseoutSubscription=null,this._stateMachine=t.UIStateMachine.create(this)}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},Object.defineProperty(n.prototype,"text",{get:function(){var e=null;return null===this.entityObject?this._text:(e=this.getObject(t.EButtonObjectName.TEXT),e?e.getComponent(t.PlainFont).text:null)},set:function(e){var n=null;this._text=e,null!==this.entityObject&&this.getUIRenderer()&&(n=this.getObject(t.EButtonObjectName.TEXT),n?n.getComponent(t.PlainFont).text=e:this.entityObject.addChild(this._createFontObject()))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isDisabled",{get:function(){return this._stateMachine.currentState===t.EUIState.DISABLED},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"currentState",{get:function(){return this._stateMachine.currentState},enumerable:!0,configurable:!0}),n.prototype.initWhenCreate=function(){this.transitionMode=t.ETransitionMode.SPRITE,this.text="button"},n.prototype.init=function(){e.prototype.init.call(this),this.entityObject.addChild(this._createBackgroundObject()),this._hasFontObject()||this.entityObject.addChild(this._createFontObject()),this._bindEvent()},n.prototype.dispose=function(){e.prototype.dispose.call(this),this._mousedownSubscription.dispose(),this._mouseupSubscription.dispose(),this._mouseoverSubscription.dispose(),this._mouseoutSubscription.dispose()},n.prototype.getObject=function(t){return this.entityObject.findChildByName(t)},n.prototype.getObjectTransition=function(t){return this.transitionManager.getObjectTransition(t)},n.prototype.enable=function(){this._stateMachine.changeState(t.EUIState.NORMAL)},n.prototype.disable=function(){this._stateMachine.changeState(t.EUIState.DISABLED)},n.prototype.update=function(e){var n=this.transitionManager.getObjectTarget(t.EButtonObjectName.BACKGROUND);if(n)switch(this.p_transitionMode){case t.ETransitionMode.SPRITE:this.getObject(t.EButtonObjectName.BACKGROUND).getComponent(t.Image).targetSource=n;break;case t.ETransitionMode.COLOR:this.getObject(t.EButtonObjectName.BACKGROUND).getComponent(t.Image).targetColor=n;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("transitionMode"))}else{var r=this.getObject(t.EButtonObjectName.BACKGROUND).getComponent(t.Image);switch(this.p_transitionMode){case t.ETransitionMode.SPRITE:r.targetSource=null;break;case t.ETransitionMode.COLOR:r.targetColor=null;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("transitionMode"))}}},n.prototype.render=function(){},n.prototype._createBackgroundObject=function(){var e=t.UIObject.create(),n=t.Image.create(),r=this.entityObject.transform;return e.addComponent(n),e.addComponent(this.getUIRenderer()),e.transform.width=r.width,e.transform.height=r.height,e.transform.zIndex=1,e.name=t.EButtonObjectName.BACKGROUND,t.CloneUtils.markNotClone(e),e},n.prototype._createFontObject=function(){var e=t.UIObject.create(),n=t.PlainFont.create(),r=this.entityObject.transform;return n.text=this._text,n.enableFill("#000000"),n.xAlignment=t.EFontXAlignment.CENTER,n.yAlignment=t.EFontYAlignment.MIDDLE,e.addComponent(n),e.addComponent(this.getUIRenderer()),e.transform.width=r.width,e.transform.height=r.height,e.transform.zIndex=2,e.name=t.EButtonObjectName.TEXT,t.CloneUtils.markNotClone(e),e},n.prototype._hasFontObject=function(){return!!this.getObject(t.EButtonObjectName.TEXT)},n.prototype._bindEvent=function(){var e=this;this._mousedownSubscription=t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.MOUSE_DOWN).filter(function(t){return!e.isDisabled}).subscribe(function(n){e._stateMachine.changeState(t.EUIState.PRESSED)}),this._mouseupSubscription=t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.MOUSE_UP).filter(function(t){return!e.isDisabled}).subscribe(function(t){e._stateMachine.backState()}),this._mouseoverSubscription=t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.MOUSE_OVER).filter(function(t){return!e.isDisabled}).subscribe(function(n){e._stateMachine.changeState(t.EUIState.HIGHLIGHT)}),this._mouseoutSubscription=t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.MOUSE_OUT).filter(function(t){return!e.isDisabled}).subscribe(function(t){e._stateMachine.backState()})},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"_text",void 0),__decorate([t.cloneAttributeAsCloneable({isInjectTarget:!0})],n.prototype,"_stateMachine",void 0),__decorate([t.require(function(){t.assert(this.getObject(t.EButtonObjectName.BACKGROUND).hasComponent(t.Image),t.Log.info.FUNC_SHOULD("Button UIObject","contain Image component"))})],n.prototype,"update",null),n}(t.InteractionUI);t.Button=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.BACKGROUND="background"]="BACKGROUND",t[t.TEXT="text"]="TEXT"}(t.EButtonObjectName||(t.EButtonObjectName={}));t.EButtonObjectName}(wd||(wd={}));var wd;!function(t){!function(t){t[t.NORMAL=0]="NORMAL",t[t.HIGHLIGHT=1]="HIGHLIGHT",t[t.PRESSED=2]="PRESSED",t[t.DISABLED=3]="DISABLED"}(t.EUIState||(t.EUIState={}));t.EUIState}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t){this._ui=null,this._stateHistory=wdCb.Stack.create(),this._ui=t}return e.create=function(t){var e=new this(t);return e},Object.defineProperty(e.prototype,"transitionManager",{get:function(){return this._ui.transitionManager},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"currentState",{get:function(){return this._stateHistory.top||t.EUIState.NORMAL},enumerable:!0,configurable:!0}),e.prototype.clone=function(e){return t.CloneUtils.clone(this,null,[e])},e.prototype.changeState=function(t){this._stateHistory.push(t),this.transitionManager.changeState(t),this._ui.dirty=!0},e.prototype.backState=function(){var e=null;this._stateHistory.pop(),e=this._stateHistory.top,e||(e=t.EUIState.NORMAL),this.transitionManager.changeState(e),this._ui.dirty=!0},__decorate([t.cloneAttributeAsCloneable()],e.prototype,"_stateHistory",void 0),e}();t.UIStateMachine=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._target=null}return Object.defineProperty(e.prototype,"target",{get:function(){return null===this._target&&this.changeState(t.EUIState.NORMAL),this._target},set:function(t){this._target=t},enumerable:!0,configurable:!0}),e.prototype.clone=function(){return t.CloneUtils.clone(this)},e}();t.Transition=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.normalSprite=null,this.highlightSprite=null,this.pressedSprite=null,this.disabledSprite=null}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.changeState=function(e){switch(e){case t.EUIState.NORMAL:this.target=this.normalSprite;break;case t.EUIState.HIGHLIGHT:this.target=this.highlightSprite;break;case t.EUIState.PRESSED:this.target=this.pressedSprite;break;case t.EUIState.DISABLED:this.target=this.disabledSprite;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("state"))}},__decorate([t.cloneAttributeAsCloneable()],n.prototype,"normalSprite",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"highlightSprite",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"pressedSprite",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"disabledSprite",void 0),n}(t.Transition);t.SpriteTransition=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.normalColor=null,this.highlightColor=null,this.pressedColor=null,this.disabledColor=null}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.changeState=function(e){switch(e){case t.EUIState.NORMAL:this.target=this.normalColor;break;case t.EUIState.HIGHLIGHT:this.target=this.highlightColor;break;case t.EUIState.PRESSED:this.target=this.pressedColor;break;case t.EUIState.DISABLED:this.target=this.disabledColor;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("state"))}},__decorate([t.cloneAttributeAsCloneable()],n.prototype,"normalColor",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"highlightColor",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"pressedColor",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"disabledColor",void 0),n}(t.Transition);t.ColorTransition=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.SPRITE=0]="SPRITE",t[t.COLOR=1]="COLOR"}(t.ETransitionMode||(t.ETransitionMode={}));t.ETransitionMode}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t){this._ui=null,this._spriteTransitionMap=wdCb.Hash.create(),this._colorTransitionMap=wdCb.Hash.create(),this._ui=t}return e.create=function(t){var e=new this(t);return e},e.prototype.clone=function(e){return t.CloneUtils.clone(this,null,[e])},e.prototype.getObjectTransition=function(t){var e=this._getTransitionMap().getChild(t);return e||(e=this._createTransitionInstance(),this._getTransitionMap().addChild(t,e)),e},e.prototype.getObjectTarget=function(t){return this.getObjectTransition(t).target},e.prototype.changeState=function(t){wdFrp.fromArray([this._spriteTransitionMap,this._colorTransitionMap]).subscribe(function(e){e.forEach(function(e){e.changeState(t)})})},e.prototype._getTransitionMap=function(){var e=null;switch(this._ui.transitionMode){case t.ETransitionMode.SPRITE:e=this._spriteTransitionMap;break;case t.ETransitionMode.COLOR:e=this._colorTransitionMap;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("transitionMode"))}return e},e.prototype._createTransitionInstance=function(){var e=null;switch(this._ui.transitionMode){case t.ETransitionMode.SPRITE:e=t.SpriteTransition.create();break;case t.ETransitionMode.COLOR:e=t.ColorTransition.create();break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("transitionMode"))}return e},__decorate([t.cloneAttributeAsCustomType(function(t,e,n){e[n]=t[n].clone(!0)})],e.prototype,"_spriteTransitionMap",void 0),__decorate([t.cloneAttributeAsCustomType(function(t,e,n){e[n]=t[n].clone(!0)})],e.prototype,"_colorTransitionMap",void 0),e}();t.TransitionManager=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t.drawRoundedRect=function(t,e,n,r,i,o,a,s){t.save(),t.beginPath(),o>0?t.moveTo(r+s,i):t.moveTo(r-s,i),t.arcTo(r+o,i,r+o,i+a,s),t.arcTo(r+o,i+a,r,i+a,s),t.arcTo(r,i+a,r,i,s),o>0?t.arcTo(r,i,r+s,i,s):t.arcTo(r,i,r-s,i,s),t.closePath(),t.strokeStyle=e,t.fillStyle=n,e&&t.stroke(),n&&t.fill(),t.restore()},t}();t.RoundedRectUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t){this.texture=null,this.frameBufferOperator=null,this._isRenderListEmpty=!1,this._renderCount=0,this.texture=t}return e.prototype.initWhenCreate=function(){this.frameBufferOperator=t.FrameBuffer.create(this.texture.width,this.texture.height)},e.prototype.init=function(){this.texture.createEmptyTexture(),this.initFrameBuffer()},e.prototype.needRender=function(){var t=this.texture.renderRate,e=!1;return e=0===t?this._shouldRenderOnce():this._shouldRenderAtRate(t),this._renderCount++,e},e.prototype.render=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=t[0],r=this.getRenderList();if(this._isRenderListEmpty=this.isRenderListEmpty(r),this.beforeRender(),1===t.length)this.renderFrameBufferTexture(r,n);else{var i=t[1];this.renderFrameBufferTexture(r,n,i)}this.afterRender()},e.prototype.dispose=function(){this.frameBufferOperator.dispose(),this.disposeFrameBuffer(),this.texture.dispose()},e.prototype.beforeRender=function(){},e.prototype.afterRender=function(){},
e.prototype.isRenderListEmptyWhenRender=function(){return this._isRenderListEmpty},e.prototype._shouldRenderOnce=function(){return 0===this._renderCount},e.prototype._shouldRenderAtRate=function(t){var e=this._renderCount;return 0===e?!0:e===t?(this._renderCount=0,!0):!1},__decorate([t.require(function(){t.assert(this.texture.renderRate>=0,t.Log.info.FUNC_SHOULD("renderTargetTexture->renderRate",">= 0, but actual is "+this.texture.renderRate))}),t.virtual],e.prototype,"needRender",null),__decorate([t.virtual],e.prototype,"beforeRender",null),__decorate([t.virtual],e.prototype,"afterRender",null),__decorate([t.ensure(function(e){e&&t.assert(this.isRenderListEmpty(this.getRenderList()),t.Log.info.FUNC_SHOULD("renderList","be empty"))})],e.prototype,"isRenderListEmptyWhenRender",null),e}();t.RenderTargetRenderer=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(t.RenderTargetRenderer);t.CommonRenderTargetRenderer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.frameBuffer=null,this._renderBuffer=null,this._lastCamera=null}return __extends(n,e),n.prototype.isNeedCreateCamera=function(){return!0},n.prototype.createCamera=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return null},n.prototype.setFrameBufferTexture=function(){var e=this.frameBufferOperator,n=t.DeviceManager.getInstance().gl;e.attachTexture(n.TEXTURE_2D,this.texture.glTexture,t.EFrameBufferAttachType.COLOR_ATTACHMENT0)},n.prototype.createAndAttachDepthBuffer=function(){var e=this.frameBufferOperator;t.DeviceManager.getInstance().gl;this._renderBuffer=e.createRenderBuffer(),e.attachRenderBuffer("DEPTH_ATTACHMENT",this._renderBuffer)},n.prototype.deleteRenderBuffer=function(){var e=t.DeviceManager.getInstance().gl;e.deleteRenderbuffer(this._renderBuffer)},n.prototype.isRenderListEmpty=function(t){return 0===t.getCount()},n.prototype.initFrameBuffer=function(){var t=this.frameBufferOperator;this.frameBuffer=t.createFrameBuffer(),t.bindFrameBuffer(this.frameBuffer),this.setFrameBufferTexture(),this.createAndAttachDepthBuffer(),t.check(),t.unBindAll()},n.prototype.renderFrameBufferTexture=function(t,e,n){var r=null;this.isRenderListEmptyWhenRender()||(this.texture.bindToUnit(0),this.isNeedCreateCamera()?(r=this.createCamera(n),this._lastCamera&&this._lastCamera.dispose(),this._lastCamera=r):r=n,this.beforeRenderFrameBufferTexture(r),this.frameBufferOperator.bindFrameBuffer(this.frameBuffer),this.frameBufferOperator.setViewport(),t.forEach(function(t){t.render(e,r)}),e.clear(),this.renderRenderer(e),this.frameBufferOperator.unBindFrameBuffer(),this.frameBufferOperator.restoreViewport())},n.prototype.disposeFrameBuffer=function(){var e=t.DeviceManager.getInstance().gl;e.deleteFramebuffer(this.frameBuffer),this.deleteRenderBuffer()},__decorate([t.virtual],n.prototype,"isNeedCreateCamera",null),__decorate([t.virtual],n.prototype,"createCamera",null),__decorate([t.virtual],n.prototype,"setFrameBufferTexture",null),__decorate([t.virtual],n.prototype,"createAndAttachDepthBuffer",null),__decorate([t.virtual],n.prototype,"deleteRenderBuffer",null),__decorate([t.require(function(e,n,r){t.assert(!!r,t.Log.info.FUNC_SHOULD("pass param->camera"))})],n.prototype,"renderFrameBufferTexture",null),n}(t.CommonRenderTargetRenderer);t.TwoDRenderTargetRenderer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t){var e=new this(t);return e.initWhenCreate(),e},n.prototype.beforeRenderFrameBufferTexture=function(t){},n.prototype.getRenderList=function(){return this.texture.renderList},n.prototype.renderRenderer=function(e){this._setSceneSide(t.ESide.FRONT),e.webglState=t.BasicState.create(),e.render(),this._setSceneSide(null)},n.prototype.beforeRender=function(){this.isRenderListEmptyWhenRender()?t.Director.getInstance().scene.glslData.addChild(t.EShaderGLSLData.MIRROR,{isRenderListEmpty:!0}):t.Director.getInstance().scene.glslData.addChild(t.EShaderGLSLData.MIRROR,{isRenderListEmpty:!1})},n.prototype.createCamera=function(e){var n=null,r=null,i=e.getComponent(t.CameraController),o=null,a=null;return r=this.texture.getPlane(),o=r.getReflectionMatrix().applyMatrix(i.worldToCameraMatrix),a=this._setClipPlane(o,i.pMatrix,r),n=t.PerspectiveCamera.create(),n.worldToCameraMatrix=o.clone(),n.pMatrix=a,t.GameObject.create().addComponent(t.RenderTargetRendererCameraController.create(n)).init()},n.prototype._setSceneSide=function(e){var n=t.Director.getInstance().scene;n.side=e},n.prototype._setClipPlane=function(e,n,r){var i=n.clone(),o=t.Vector4.create(),a=this._getClipPlaneInCameraSpace(e,r),s=t.Vector4.create();return o.x=(Math.sign(a.x)+i.values[8])/i.values[0],o.y=(Math.sign(a.y)+i.values[9])/i.values[5],o.z=-1,o.w=(1+i.values[10])/i.values[14],s=a.multiplyScalar(2/a.dot(o)),i.values[2]=s.x,i.values[6]=s.y,i.values[10]=s.z+1,i.values[14]=s.w,i},n.prototype._getClipPlaneInCameraSpace=function(e,n){var r=t.Vector4.create(),i=e.multiplyPoint(this.texture.getPosition()),o=e.clone().invert().transpose().multiplyPoint(n.normal).normalize();return r.set(o.x,o.y,o.z,-i.dot(o)),r},n}(t.TwoDRenderTargetRenderer);t.MirrorRenderTargetRenderer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t){var e=new this(t);return e.initWhenCreate(),e},n.prototype.beforeRenderFrameBufferTexture=function(t){},n.prototype.getRenderList=function(){return this.texture.renderList},n.prototype.renderRenderer=function(e){e.webglState=t.BasicState.create(),e.render()},n.prototype.beforeRender=function(){this.isRenderListEmptyWhenRender()?t.Director.getInstance().scene.glslData.addChild(t.EShaderGLSLData.REFRACTION,{isRenderListEmpty:!0}):t.Director.getInstance().scene.glslData.addChild(t.EShaderGLSLData.REFRACTION,{isRenderListEmpty:!1})},n.prototype.isNeedCreateCamera=function(){return!1},n}(t.TwoDRenderTargetRenderer);t.RefractionRenderTargetRenderer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(t,n,r){e.call(this,t),this._light=null,this._layer=null,this._shadowMapRendererUtils=null,this._light=n,this._layer=r}return __extends(n,e),n.create=function(t,e,n){var r=new this(t,e,n);return r.initWhenCreate(),r},n.prototype.initWhenCreate=function(){this._shadowMapRendererUtils=t.TwoDShadowMapRenderTargetRendererUtils.create(this._light,this.texture),e.prototype.initWhenCreate.call(this)},n.prototype.beforeRenderFrameBufferTexture=function(e){t.Director.getInstance().scene.glslData.appendChild(t.EShaderGLSLData.TWOD_SHADOWMAP,{camera:e.getComponent(t.CameraController),light:this._light,isRenderListEmpty:!1})},n.prototype.getRenderList=function(){return t.Director.getInstance().scene.gameObjectScene.shadowManager.getShadowRenderListByLayer(this._layer)},n.prototype.renderRenderer=function(t){this._shadowMapRendererUtils.renderRenderer(t)},n.prototype.beforeRender=function(){return this.isRenderListEmptyWhenRender()?void t.Director.getInstance().scene.glslData.appendChild(t.EShaderGLSLData.TWOD_SHADOWMAP,{isRenderListEmpty:!0}):void this._shadowMapRendererUtils.beforeRender(t.EShaderTypeOfScene.BUILD_TWOD_SHADOWMAP)},n.prototype.afterRender=function(){this.isRenderListEmptyWhenRender()||this._shadowMapRendererUtils.afterRender()},n.prototype.createCamera=function(){var e=t.OrthographicCamera.create(),n=this._light,r=t.GameObject.create();return e.left=n.shadowCameraLeft,e.right=n.shadowCameraRight,e.top=n.shadowCameraTop,e.bottom=n.shadowCameraBottom,e.near=n.shadowCameraNear,e.far=n.shadowCameraFar,r.addComponent(t.RenderTargetRendererCameraController.create(e)),r.transform.translate(n.position),r.transform.lookAt(0,0,0),r.init(),r},n.prototype.setFrameBufferTexture=function(){if(t.GPUDetector.getInstance().extensionDepthTexture){var n=this.frameBufferOperator,r=t.DeviceManager.getInstance().gl;return n.attachTexture(r.TEXTURE_2D,this._createEmptyColorTexture(),t.EFrameBufferAttachType.COLOR_ATTACHMENT0),void n.attachTexture(r.TEXTURE_2D,this.texture.glTexture,t.EFrameBufferAttachType.DEPTH_ATTACHMENT)}e.prototype.setFrameBufferTexture.call(this)},n.prototype.createAndAttachDepthBuffer=function(){t.GPUDetector.getInstance().extensionDepthTexture||e.prototype.createAndAttachDepthBuffer.call(this)},n.prototype.deleteRenderBuffer=function(){t.GPUDetector.getInstance().extensionDepthTexture||e.prototype.deleteRenderBuffer.call(this)},n.prototype._createEmptyColorTexture=function(){var e=t.DeviceManager.getInstance().gl,n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.texture.width,this.texture.height,0,e.RGBA,e.UNSIGNED_BYTE,null),n},n}(t.TwoDRenderTargetRenderer);t.TwoDShadowMapRenderTargetRenderer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._frameBufferList=wdCb.Collection.create(),this._renderBufferList=wdCb.Collection.create(),this._lastCameraList=null,this._lastPosition=null}return __extends(n,e),n.prototype.renderRenderer=function(e){e.webglState=t.BasicState.create(),e.render()},n.prototype.beforeRenderFrameBufferTexture=function(t){},n.prototype.initFrameBuffer=function(){for(var e=this.frameBufferOperator,n=t.DeviceManager.getInstance().gl,r=0;6>r;r++){var i=e.createFrameBuffer(),o=e.createRenderBuffer();this._frameBufferList.addChild(i),this._renderBufferList.addChild(o),e.bindFrameBuffer(i),e.attachTexture(n.TEXTURE_CUBE_MAP_POSITIVE_X+r,this.texture.glTexture),e.attachRenderBuffer("DEPTH_ATTACHMENT",o),e.check()}e.unBindAll()},n.prototype.renderFrameBufferTexture=function(t,e,n){var r=null,i=null,o=null,a=null,s=null;if(!this.isRenderListEmptyWhenRender()){this.texture.bindToUnit(0),a=this.getPosition(),s=this._isNeedCreateCamera(a),s&&(o=wdCb.Collection.create());for(var c=0;6>c;c++)i=t.getChild(this._convertIndexToFaceKey(c)),this._isEmpty(i)||(s?(r=this.createCamera(c),o.addChild(r)):r=this._lastCameraList.getChild(c),this.beforeRenderFrameBufferTexture(r),this.frameBufferOperator.bindFrameBuffer(this._frameBufferList.getChild(c)),this.frameBufferOperator.setViewport(),i.forEach(function(t){t.render(e,r)}),e.clear(),this.renderRenderer(e));s&&(this._lastCameraList&&this._lastCameraList.forEach(function(t){t.dispose()}),this._lastCameraList=o,this._lastPosition=a),this.frameBufferOperator.unBindFrameBuffer(),this.frameBufferOperator.restoreViewport()}},n.prototype.disposeFrameBuffer=function(){var e=t.DeviceManager.getInstance().gl;this._frameBufferList.forEach(function(t){return e.deleteFramebuffer(t)}),this._renderBufferList.forEach(function(t){return e.deleteRenderbuffer(t)})},n.prototype.createCamera=function(e){var n=t.PerspectiveCamera.create(),r=t.GameObject.create(),i=this.getPosition();return n.fovy=90,this.setCamera(n),r.addComponent(t.RenderTargetRendererCameraController.create(n)),r.transform.translate(i),this._lookAtFace(r,i,e),r.init(),r},n.prototype.isRenderListEmpty=function(t){var e=this,n=!0;return t.forEach(function(t){return e._isEmpty(t)?void 0:(n=!1,wdCb.$BREAK)},this),n},n.prototype._isEmpty=function(t){return void 0===t?!0:0===t.getCount()},n.prototype._convertIndexToFaceKey=function(t){var e=null;switch(t){case 0:e="px";break;case 1:e="nx";break;case 2:e="py";break;case 3:e="ny";break;case 4:e="pz";break;case 5:e="nz"}return e},n.prototype._lookAtFace=function(t,e,n){switch(n){case 0:t.transform.lookAt(e.x+1,e.y,e.z,0,-1,0);break;case 1:t.transform.lookAt(e.x-1,e.y,e.z,0,-1,0);break;case 2:t.transform.lookAt(e.x,e.y+1,e.z,0,0,1);break;case 3:t.transform.lookAt(e.x,e.y-1,e.z,0,0,-1);break;case 4:t.transform.lookAt(e.x,e.y,e.z+1,0,-1,0);break;case 5:t.transform.lookAt(e.x,e.y,e.z-1,0,-1,0)}},n.prototype._isNeedCreateCamera=function(t){return null===this._lastPosition||null===this._lastCameraList||0===this._lastCameraList.getCount()?!0:!t.isEqual(this._lastPosition)},__decorate([t.virtual],n.prototype,"renderRenderer",null),__decorate([t.virtual],n.prototype,"beforeRenderFrameBufferTexture",null),__decorate([t.require(function(e,n,r){t.assert(!!r,t.Log.info.FUNC_SHOULD("pass param->camera"))})],n.prototype,"renderFrameBufferTexture",null),n}(t.CommonRenderTargetRenderer);t.CubemapRenderTargetRenderer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(t,n,r){e.call(this,t),this._light=null,this._layer=null,this._shadowMapRendererUtils=null,this._light=n,this._layer=r}return __extends(n,e),n.create=function(t,e,n){var r=new this(t,e,n);return r.initWhenCreate(),r},n.prototype.initWhenCreate=function(){this._shadowMapRendererUtils=t.CubemapShadowMapRenderTargetRendererUtils.create(this._light,this.texture),e.prototype.initWhenCreate.call(this)},n.prototype.getRenderList=function(){var e=t.Director.getInstance().scene.gameObjectScene.shadowManager.getShadowRenderListByLayer(this._layer);return wdCb.Hash.create({px:e,nx:e,py:e,ny:e,pz:e,nz:e})},n.prototype.renderRenderer=function(t){this._shadowMapRendererUtils.renderRenderer(t)},n.prototype.beforeRender=function(){var e=null;return this.isRenderListEmptyWhenRender()?void t.Director.getInstance().scene.glslData.appendChild(t.EShaderGLSLData.CUBEMAP_SHADOWMAP,{light:this._light,isRenderListEmpty:!0}):(t.Director.getInstance().scene.glslData.appendChild(t.EShaderGLSLData.CUBEMAP_SHADOWMAP,{light:this._light,isRenderListEmpty:!1}),e=t.Director.getInstance().scene,e.glslData.appendChild(t.EShaderGLSLData.BUILD_CUBEMAP_SHADOWMAP,{light:this._light}),void this._shadowMapRendererUtils.beforeRender(t.EShaderTypeOfScene.BUILD_CUBEMAP_SHADOWMAP))},n.prototype.afterRender=function(){this.isRenderListEmptyWhenRender()||this._shadowMapRendererUtils.afterRender()},n.prototype.setCamera=function(t){var e=this._light;t.aspect=e.shadowMapWidth/e.shadowMapHeight,t.near=e.shadowCameraNear,t.far=e.shadowCameraFar},n.prototype.getPosition=function(){return this._light.position},n}(t.CubemapRenderTargetRenderer);t.CubemapShadowMapRenderTargetRenderer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t){var e=new this(t);return e.initWhenCreate(),e},n.prototype.getRenderList=function(){return this.texture.renderList},n.prototype.setCamera=function(t){t.aspect=1,t.near=this.texture.near,t.far=this.texture.far},n.prototype.getPosition=function(){return this.texture.getPosition()},n.prototype.beforeRender=function(){this.isRenderListEmptyWhenRender()?t.Director.getInstance().scene.glslData.addChild(t.EShaderGLSLData.DYNAMIC_CUBEMAP,{isRenderListEmpty:!0}):t.Director.getInstance().scene.glslData.addChild(t.EShaderGLSLData.DYNAMIC_CUBEMAP,{isRenderListEmpty:!1})},n}(t.CubemapRenderTargetRenderer);t.DynamicCubemapRenderTargetRenderer=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t,e){this._texture=null,this._light=null,this._light=t,this._texture=e}return e.prototype.initWhenCreate=function(){this._texture.width=this._light.shadowMapWidth,this._texture.height=this._light.shadowMapHeight},e.prototype.beforeRender=function(e){t.Director.getInstance().scene.useShaderType(e)},e.prototype.afterRender=function(){t.Director.getInstance().scene.unUseShader()},e.prototype.renderRenderer=function(t){this.setWebglState(t),t.render()},e}();t.ShadowMapRenderTargetRendererUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t,e){var n=new this(t,e);return n.initWhenCreate(),n},n.prototype.setWebglState=function(e){e.webglState=t.BuildCubemapShadowMapState.create()},n}(t.ShadowMapRenderTargetRendererUtils);t.CubemapShadowMapRenderTargetRendererUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t,e){var n=new this(t,e);return n.initWhenCreate(),n},n.prototype.setWebglState=function(e){e.webglState=t.BuildTwoDShadowMapState.create()},n}(t.ShadowMapRenderTargetRendererUtils);t.TwoDShadowMapRenderTargetRendererUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._webglState=null,this.skyboxCommand=null}return Object.defineProperty(e.prototype,"webglState",{get:function(){return this._webglState?this._webglState:t.BasicState.create()},set:function(t){this._webglState=t},enumerable:!0,configurable:!0}),e.prototype.init=function(){},__decorate([t.virtual],e.prototype,"init",null),e}();t.Renderer=e}(wd||(wd={}));var wd;!function(t){var e=31,n=31,r=1024,i=1024,o=1024,a=30,s=a-5,c=a-5-5,u=a-5-5-10,l=function(a){function l(){a.apply(this,arguments),this._commandQueue=wdCb.Collection.create(),this._clearOptions={color:t.Color.create("#000000")}}return __extends(l,a),l.create=function(){var t=new this;return t},l.prototype.addCommand=function(t){this._commandQueue.addChild(t),t.init()},l.prototype.hasCommand=function(){return this._commandQueue.getCount()>0||!!this.skyboxCommand},l.prototype.clear=function(){t.DeviceManager.getInstance().clear(this._clearOptions)},l.prototype.render=function(){var e=this,n=t.DeviceManager.getInstance(),r=this.webglState,i=[],o=[];if(this._commandQueue.forEach(function(n){n.webglState=r,n.blend?i.push(n):n instanceof t.QuadCommand?(e._buildOpaqueCommandSortId(n),o.push(n)):n.execute()},this),o.length>0){this._sortOpaqueQuadCommand(o);for(var a=0,s=o;a<s.length;a++){var c=s[a];c.execute()}}i.length>0&&(n.depthWrite=!1,this._renderSortedTransparentCommands(i),n.depthWrite=!0),this.skyboxCommand&&(n.depthFunc=t.EDepthFunction.LEQUAL,this.skyboxCommand.webglState=r,this.skyboxCommand.execute(),n.depthFunc=t.EDepthFunction.LESS),this._clearCommand(),this.webglState=null},l.prototype.init=function(){var e=t.DeviceManager.getInstance();e.depthTest=!0,e.blend=!1,e.setColorWrite(!0,!0,!0,!0),e.side=t.ESide.FRONT,e.depthWrite=!0},l.prototype.setClearColor=function(t){this._setClearOptions({color:t})},l.prototype._renderSortedTransparentCommands=function(e){for(var n=this,r=t.Director.getInstance().scene.currentCamera.transform.position.z,i=0,o=t.SortUtils.insertSort(e,function(t,e){return n._getObjectToCameraZDistance(r,e)<n._getObjectToCameraZDistance(r,t)});i<o.length;i++){var a=o[i];a.execute()}},l.prototype._getObjectToCameraZDistance=function(t,e){return t-e.z},l.prototype._clearCommand=function(){this._commandQueue.forEach(function(t){t.dispose()}),this._commandQueue.removeAllChildren(),this.skyboxCommand&&(this.skyboxCommand.dispose(),this.skyboxCommand=null)},l.prototype._setClearOptions=function(t){wdCb.ExtendUtils.extend(this._clearOptions,t)},l.prototype._buildOpaqueCommandSortId=function(t){var e=t.target,n=t.material;t.sortId=(e.renderGroup<<s|e.renderPriority<<c|this._buildShaderSortId(n.shader)<<u|this._mapEntityIdToRenderId(this._getTargetTexture(n),i))*o+this._mapEntityIdToRenderId(this._getTargetBuffer(n),o)},l.prototype._buildShaderSortId=function(t){return this._mapEntityIdToRenderId(t.program,r)},l.prototype._getTargetTexture=function(t){return t.getTextureForRenderSort()},l.prototype._getTargetBuffer=function(t){return t.geometry.buffers.getBufferForRenderSort()},l.prototype._mapEntityIdToRenderId=function(t,e){return t?t.uid%e:1},l.prototype._sortOpaqueQuadCommand=function(e){t.SortUtils.quickSort(e,function(t,e){return t.sortId<e.sortId},!0)},__decorate([t.ensure(function(){t.assert(!this._commandQueue.hasRepeatItems(),t.Log.info.FUNC_SHOULD_NOT("has duplicate render command"))})],l.prototype,"addCommand",null),__decorate([t.require(function(){t.assert(!!this.webglState,t.Log.info.FUNC_MUST_DEFINE("webglState"))})],l.prototype,"render",null),__decorate([t.require(function(e){t.assert(!!t.Director.getInstance().scene.currentCamera,t.Log.info.FUNC_NOT_EXIST("current camera"));for(var n=0,r=e;n<r.length;n++){var i=r[n];t.assert(i instanceof t.QuadCommand,t.Log.info.FUNC_MUST_BE("transparent command","QuadCommand"))}})],l.prototype,"_renderSortedTransparentCommands",null),__decorate([t.require(function(r){var i=r.target;t.assert(i.renderGroup<=e&&i.renderGroup>=0,t.Log.info.FUNC_SHOULD("renderGroup:"+i.renderGroup,"in range:[0, "+e+"]")),t.assert(i.renderPriority<=n&&i.renderPriority>=0,t.Log.info.FUNC_SHOULD("renderPriority:"+i.renderPriority,"in range:[0, "+n+"]"))})],l.prototype,"_buildOpaqueCommandSortId",null),__decorate([t.ensure(function(e,n,r){t.assert(e>=0&&r>=e,t.Log.info.FUNC_SHOULD("mappedId:"+e,"in range:[0, "+r+"]"))})],l.prototype,"_mapEntityIdToRenderId",null),__decorate([t.require(function(e){for(var n=0,r=e;n<r.length;n++){var i=r[n];t.assert(i instanceof t.QuadCommand,t.Log.info.FUNC_MUST_BE("command","QuadCommand")),t.assert(i.blend===!1,t.Log.info.FUNC_MUST_BE("command","opaque command"))}})],l.prototype,"_sortOpaqueQuadCommand",null),l}(t.Renderer);t.WebGLRenderer=l}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.prototype.getSide=function(e){var n=t.Director.getInstance().scene;return n.side?n.side:e.side},e}();t.WebGLState=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.setState=function(e){var n=t.DeviceManager.getInstance();n.setColorWrite(e.redWrite,e.greenWrite,e.blueWrite,e.alphaWrite),n.polygonOffsetMode=e.polygonOffsetMode,n.side=this.getSide(e),n.blend=e.blend,e.blendFuncSeparate&&e.blendEquationSeparate?(n.setBlendFuncSeparate(e.blendFuncSeparate),n.setBlendEquationSeparate(e.blendEquationSeparate)):(n.setBlendFunc(e.blendSrc,e.blendDst),n.setBlendEquation(e.blendEquation))},__decorate([t.require(function(e){e.blendFuncSeparate&&e.blendEquationSeparate||t.assert(!!e.blendSrc&&!!e.blendDst&&!!e.blendEquation,wdCb.Log.info.FUNC_MUST("material.blendSrc && material.blendDst && material.blendEquation","be set"))})],n.prototype,"setState",null),n}(t.WebGLState);t.BasicState=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.prototype.setState=function(e){var n=t.DeviceManager.getInstance();n.side=this.getSide(e),n.blend=!1},n}(t.WebGLState);t.BuildShadowMapState=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.setState=function(n){var r=t.DeviceManager.getInstance();e.prototype.setState.call(this,n),t.GPUDetector.getInstance().extensionDepthTexture&&r.setColorWrite(!1,!1,!1,!1)},n}(t.BuildShadowMapState);t.BuildTwoDShadowMapState=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e}(t.BuildShadowMapState);t.BuildCubemapShadowMapState=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.POINTS="POINTS"]="POINTS",t[t.LINES="LINES"]="LINES",t[t.LINE_LOOP="LINE_LOOP"]="LINE_LOOP",t[t.LINE_STRIP="LINE_STRIP"]="LINE_STRIP",t[t.TRIANGLES="TRIANGLES"]="TRIANGLES",t[t.TRIANGLE_STRIP="TRIANGLE_STRIP"]="TRIANGLE_STRIP",t[t.TRANGLE_FAN="TRIANGLE_FAN"]="TRANGLE_FAN"}(t.EDrawMode||(t.EDrawMode={}));t.EDrawMode}(wd||(wd={}));var wd;!function(t){!function(t){t[t.BYTE="BYTE"]="BYTE",t[t.UNSIGNED_BYTE="UNSIGNED_BYTE"]="UNSIGNED_BYTE",t[t.SHORT="SHORT"]="SHORT",t[t.UNSIGNED_SHORT="UNSIGNED_SHORT"]="UNSIGNED_SHORT",t[t.INT="INT"]="INT",t[t.UNSIGNED_INT="UNSIGNED_INT"]="UNSIGNED_INT",t[t.FLOAT="FLOAT"]="FLOAT"}(t.EBufferType||(t.EBufferType={}));t.EBufferType}(wd||(wd={}));var wd;!function(t){!function(t){t[t.VERTICE="VERTICE"]="VERTICE",t[t.INDICE="INDICE"]="INDICE",t[t.NORMAL="NORMAL"]="NORMAL",t[t.TEXCOORD="TEXCOORD"]="TEXCOORD",t[t.TANGENT="TANGENT"]="TANGENT",t[t.COLOR="COLOR"]="COLOR"}(t.EBufferDataType||(t.EBufferDataType={}));t.EBufferDataType}(wd||(wd={}));var wd;!function(t){!function(t){t[t.STREAM_DRAW="STREAM_DRAW"]="STREAM_DRAW",t[t.STATIC_DRAW="STATIC_DRAW"]="STATIC_DRAW",t[t.DYNAMIC_DRAW="DYNAMIC_DRAW"]="DYNAMIC_DRAW"}(t.EBufferUsage||(t.EBufferUsage={}));t.EBufferUsage}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.buffer=null}return __extends(n,e),n.prototype.dispose=function(){t.DeviceManager.getInstance().gl.deleteBuffer(this.buffer),delete this.buffer},n}(t.Entity);t.Buffer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._capacity=2048}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},Object.defineProperty(n.prototype,"float32InstanceArraySize",{get:function(){return this._capacity/4},enumerable:!0,configurable:!0}),n.prototype.initWhenCreate=function(){this.buffer=this._createBuffer()},n.prototype.setCapacity=function(e){for(var n=this._capacity;e>n;)n*=2;this._capacity<n&&(this._capacity=n,this.buffer&&t.DeviceManager.getInstance().gl.deleteBuffer(this.buffer),this.buffer=this._createBuffer())},n.prototype.resetData=function(e,n){var r=t.DeviceManager.getInstance().gl;r.bindBuffer(r.ARRAY_BUFFER,this.buffer),r.bufferSubData(r.ARRAY_BUFFER,0,e)},n.prototype._createBuffer=function(){var e=t.DeviceManager.getInstance().gl,n=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,n),e.bufferData(e.ARRAY_BUFFER,this._capacity,e.DYNAMIC_DRAW),t.BufferTable.resetBindedArrayBuffer(),n},n}(t.Buffer);t.InstanceBuffer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type=null,this.count=null,this.usage=null}return __extends(n,e),n.prototype.resetBufferData=function(e,n,r){void 0===r&&(r=0);var i=t.DeviceManager.getInstance().gl;return this.usage===t.EBufferUsage.STATIC_DRAW&&0===r?void i.bufferData(i[e],n,i.DYNAMIC_DRAW):void i.bufferSubData(i[e],r,n)},n}(t.Buffer);t.CommonBuffer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.data=null}return __extends(n,e),n.create=function(e,n,r){void 0===n&&(n=null),void 0===r&&(r=t.EBufferUsage.STATIC_DRAW);var i=new this;return i.initWhenCreate(e,n,r),i},Object.defineProperty(n.prototype,"typeSize",{get:function(){return this.data.BYTES_PER_ELEMENT},enumerable:!0,configurable:!0}),n.prototype.initWhenCreate=function(e,n,r){var i=t.DeviceManager.getInstance().gl,o=null,a=null;return this.buffer=i.createBuffer(),this.buffer?e?(o=this._checkIsNeed32Bits(e,n),a=this._convertToTypedArray(o,e),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.buffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,a,i[r]),t.BufferTable.resetBindedElementBuffer(),this._saveData(a,this._getType(o,n),r),this.buffer):null:(t.Log.warn("Failed to create the this.buffer object"),null)},n.prototype.resetData=function(e,n,r){void 0===n&&(n=null),void 0===r&&(r=0);var i=t.DeviceManager.getInstance().gl,o=this._checkIsNeed32Bits(e,n),a=this._convertToTypedArray(o,e);return i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.buffer),this.resetBufferData("ELEMENT_ARRAY_BUFFER",a,r),this._saveData(a,this._getType(o,n),t.EBufferUsage.DYNAMIC_DRAW),this},n.prototype._convertToTypedArray=function(t,e){return t?new Uint32Array(e):new Uint16Array(e)},n.prototype._checkIsNeed32Bits=function(e,n){var r=!1;if(null!==n)return n===t.EBufferType.UNSIGNED_INT?!0:!1;if(t.GPUDetector.getInstance().extensionUintIndices)for(var i=0,o=e;i<o.length;i++){var a=o[i];if(a>65535){r=!0;break}}else r=!1;return r},n.prototype._getType=function(e,n){return null===n?e?t.EBufferType.UNSIGNED_INT:t.EBufferType.UNSIGNED_SHORT:n},n.prototype._saveData=function(t,e,n){this.type=e,this.count=t.length,this.data=t,this.usage=n},__decorate([t.ensureGetter(function(e){t.assert(e>0,t.Log.info.FUNC_SHOULD("typeSize","> 0, but actual is "+e))})],n.prototype,"typeSize",null),__decorate([t.require(function(e,n,r){void 0===n&&(n=null),void 0===r&&(r=0),t.assert(this.buffer,t.Log.info.FUNC_MUST("create gl buffer"))})],n.prototype,"resetData",null),__decorate([t.require(function(e,n){null!==n&&(e?t.assert(n===t.EBufferType.UNSIGNED_INT,t.Log.info.FUNC_MUST_BE("type","UNSIGNED_SHORT, but actual is "+n)):t.assert(n===t.EBufferType.UNSIGNED_SHORT||n===t.EBufferType.UNSIGNED_INT,t.Log.info.FUNC_MUST_BE("type","UNSIGNED_SHORT or UNSIGNED_INT, but actual is "+n)))})],n.prototype,"_getType",null),n}(t.CommonBuffer);t.ElementBuffer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.size=null,this.data=null}return __extends(n,e),n.create=function(e,n,r,i){void 0===r&&(r=t.EBufferType.FLOAT),void 0===i&&(i=t.EBufferUsage.STATIC_DRAW);var o=new this;return o.initWhenCreate(e,n,r,i),o},n.prototype.initWhenCreate=function(e,n,r,i){var o=t.DeviceManager.getInstance().gl,a=null;return this.buffer=o.createBuffer(),this.buffer?e?(a=this._convertToTypedArray(e,r),o.bindBuffer(o.ARRAY_BUFFER,this.buffer),o.bufferData(o.ARRAY_BUFFER,a,o[i]),t.BufferTable.resetBindedArrayBuffer(),this._saveData(a,n,r,i),this.buffer):null:(t.Log.warn("Failed to create the this.buffer object"),null)},n.prototype.resetData=function(e,n,r,i){void 0===n&&(n=this.size),void 0===r&&(r=this.type),void 0===i&&(i=0);var o=t.DeviceManager.getInstance().gl,a=this._convertToTypedArray(e,r);return o.bindBuffer(o.ARRAY_BUFFER,this.buffer),this.resetBufferData("ARRAY_BUFFER",a,i),this._saveData(a,n,r,t.EBufferUsage.DYNAMIC_DRAW),this},n.prototype._convertToTypedArray=function(t,e){return new Float32Array(t)},n.prototype._saveData=function(t,e,n,r){this.size=e,this.type=n,this.count=t.length/e,this.usage=r,this.data=t},__decorate([t.require(function(e,n,r,i){void 0===n&&(n=this.size),void 0===r&&(r=this.type),void 0===i&&(i=0),t.assert(this.buffer,t.Log.info.FUNC_MUST("create gl buffer"))})],n.prototype,"resetData",null),n}(t.CommonBuffer);t.ArrayBuffer=e}(wd||(wd={}));var wd;!function(t){var e=wdCb.Hash.create();e.addChild(t.EBufferDataType.VERTICE,"vertices"),e.addChild(t.EBufferDataType.INDICE,"indices"),e.addChild(t.EBufferDataType.NORMAL,"normals"),e.addChild(t.EBufferDataType.TEXCOORD,"texCoords"),e.addChild(t.EBufferDataType.COLOR,"colors"),e.addChild(t.EBufferDataType.TANGENT,"tangents");var n=function(){function n(){}return n.getGeometryDataName=function(t){var n=e.getChild(t);return n},__decorate([t.ensure(function(e,n){t.Log.error(void 0===e,t.Log.info.FUNC_NOT_EXIST(n,"in BufferDataTable"))})],n,"getGeometryDataName",null),n}();t.BufferDataTable=n}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.glProgram=null,this._getAttribLocationCache=wdCb.Hash.create(),this._sender=t.GLSLDataSender.create(this)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.use=function(){t.JudgeUtils.isEqual(this,t.ProgramTable.lastUsedProgram)||(t.ProgramTable.lastUsedProgram=this,t.DeviceManager.getInstance().gl.useProgram(this.glProgram),this._sender.disableVertexAttribArray(),t.BufferTable.lastBindedArrayBufferListUidStr=null)},n.prototype.getAttribLocation=function(e){var n=null,r=t.DeviceManager.getInstance().gl;return n=this._getAttribLocationCache.getChild(e),void 0!==n?n:(n=r.getAttribLocation(this.glProgram,e),this._getAttribLocationCache.addChild(e,n),n)},n.prototype.getUniformLocation=function(t){return this._sender.getUniformLocation(t)},n.prototype.sendUniformData=function(e,n,r){if(null!==r)switch(n){case t.EVariableType.FLOAT_1:this._sender.sendFloat1(e,r);break;case t.EVariableType.FLOAT_2:this._sender.sendFloat2(e,r);break;case t.EVariableType.FLOAT_3:this._sender.sendFloat3(e,r);break;case t.EVariableType.FLOAT_4:this._sender.sendFloat4(e,r);break;case t.EVariableType.VECTOR_2:this._sender.sendVector2(e,r);break;case t.EVariableType.VECTOR_3:this._sender.sendVector3(e,r);break;case t.EVariableType.VECTOR_4:this._sender.sendVector4(e,r);break;case t.EVariableType.FLOAT_MAT3:this._sender.sendMatrix3(e,r);break;case t.EVariableType.FLOAT_MAT4:this._sender.sendMatrix4(e,r);break;case t.EVariableType.NUMBER_1:case t.EVariableType.SAMPLER_CUBE:case t.EVariableType.SAMPLER_2D:this._sender.sendNum1(e,r);break;case t.EVariableType.SAMPLER_ARRAY:this._sender.sendSampleArray(e,r);break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("EVariableType:",n))}},n.prototype.sendAttributeBuffer=function(t,e,n){
var r=null;r=this.getAttribLocation(t),-1!==r&&this._sender.addBufferToToSendList(r,n)},n.prototype.sendStructureData=function(t,e,n){this.sendUniformData(t,e,n)},n.prototype.sendFloat1=function(t,e){this._sender.sendFloat1(t,e)},n.prototype.sendFloat2=function(t,e){this._sender.sendFloat2(t,e)},n.prototype.sendFloat3=function(t,e){this._sender.sendFloat3(t,e)},n.prototype.sendFloat4=function(t,e){this._sender.sendFloat4(t,e)},n.prototype.sendVector2=function(t,e){this._sender.sendVector2(t,e)},n.prototype.sendVector3=function(t,e){this._sender.sendVector3(t,e)},n.prototype.sendVector4=function(t,e){this._sender.sendVector4(t,e)},n.prototype.sendColor4=function(t,e){this._sender.sendColor4(t,e)},n.prototype.sendNum1=function(t,e){this._sender.sendNum1(t,e)},n.prototype.sendMatrix3=function(t,e){this._sender.sendMatrix3(t,e)},n.prototype.sendMatrix4=function(t,e){this._sender.sendMatrix4(t,e)},n.prototype.sendSampleArray=function(t,e){this._sender.sendSampleArray(t,e)},n.prototype.sendAllBufferData=function(t){this._sender.sendAllBufferData(t),this._sender.clearBufferList()},n.prototype.initWithShader=function(e){var n=t.DeviceManager.getInstance().gl,r=null,i=null;return this.glProgram&&this.dispose(),this.glProgram=t.DeviceManager.getInstance().gl.createProgram(),r=e.createVsShader(),i=e.createFsShader(),n.attachShader(this.glProgram,r),n.attachShader(this.glProgram,i),n.bindAttribLocation(this.glProgram,0,"a_position"),n.linkProgram(this.glProgram),t.Log.error(n.getProgramParameter(this.glProgram,n.LINK_STATUS)===!1,n.getProgramInfoLog(this.glProgram)),n.deleteShader(r),n.deleteShader(i),this},n.prototype.dispose=function(){var e=t.DeviceManager.getInstance().gl;e.deleteProgram(this.glProgram),this.glProgram=null,this._sender.dispose(),this._clearAllCache()},n.prototype._clearAllCache=function(){this._getAttribLocationCache.removeAllChildren(),this._sender.clearAllCache()},__decorate([t.require(function(e,n,r){t.assert(r instanceof t.ArrayBuffer,t.Log.info.FUNC_MUST_BE("ArrayBuffer")),t.assert(n===t.EVariableType.BUFFER,t.Log.info.FUNC_SHOULD("type","be EVariableType.BUFFER, but actual is "+n))})],n.prototype,"sendAttributeBuffer",null),n}(t.Entity);t.Program=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t){this._program=null,this._uniformCache={},this._vertexAttribHistory=[],this._getUniformLocationCache={},this._toSendBufferArr=[],this._toSendBuffersUidStr="",this._program=t}return e.create=function(t){var e=new this(t);return e},e.prototype.sendFloat1=function(e,n){var r=null,i=null;this._uniformCache[e]!=n&&(this._recordUniformData(e,n),r=t.DeviceManager.getInstance().gl,i=this.getUniformLocation(e),this._isUniformDataNotExistByLocation(i)||r.uniform1f(i,Number(n)))},e.prototype.sendFloat2=function(e,n){var r=null,i=null,o=this._uniformCache[e];o&&o[0]===n[0]&&o[1]===n[1]||(this._recordUniformData(e,n),r=t.DeviceManager.getInstance().gl,i=this.getUniformLocation(e),this._isUniformDataNotExistByLocation(i)||r.uniform2f(i,n[0],n[1]))},e.prototype.sendFloat3=function(e,n){var r=null,i=null,o=this._uniformCache[e];o&&o[0]===n[0]&&o[1]===n[1]&&o[2]===n[2]||(this._recordUniformData(e,n),r=t.DeviceManager.getInstance().gl,i=this.getUniformLocation(e),this._isUniformDataNotExistByLocation(i)||r.uniform3f(i,n[0],n[1],n[2]))},e.prototype.sendFloat4=function(e,n){var r=null,i=null,o=this._uniformCache[e];o&&o[0]===n[0]&&o[1]===n[1]&&o[2]===n[2]&&o[3]===n[3]||(this._recordUniformData(e,n),r=t.DeviceManager.getInstance().gl,i=this.getUniformLocation(e),this._isUniformDataNotExistByLocation(i)||r.uniform4f(i,n[0],n[1],n[2],n[3]))},e.prototype.sendVector2=function(e,n){var r=null,i=null,o=this._uniformCache[e];if(!o||o[0]!=n.x||o[1]!=n.y){var a=n.x,s=n.y;this._recordUniformData(e,[a,s]),r=t.DeviceManager.getInstance().gl,i=this.getUniformLocation(e),this._isUniformDataNotExistByLocation(i)||r.uniform2f(i,a,s)}},e.prototype.sendVector3=function(e,n){var r=null,i=null,o=this._uniformCache[e];if(!o||o[0]!=n.x||o[1]!=n.y||o[2]!=n.z){var a=n.x,s=n.y,c=n.z;this._recordUniformData(e,[a,s,c]),r=t.DeviceManager.getInstance().gl,i=this.getUniformLocation(e),this._isUniformDataNotExistByLocation(i)||r.uniform3f(i,a,s,c)}},e.prototype.sendVector4=function(e,n){var r=null,i=null,o=this._uniformCache[e];if(!o||o[0]!=n.x||o[1]!=n.y||o[2]!=n.z||o[3]!=n.w){var a=n.x,s=n.y,c=n.z,u=n.w;this._recordUniformData(e,[a,s,c,u]),r=t.DeviceManager.getInstance().gl,i=this.getUniformLocation(e),this._isUniformDataNotExistByLocation(i)||r.uniform4f(i,a,s,c,u)}},e.prototype.sendColor4=function(e,n){var r=null,i=null,o=this._uniformCache[e];if(!o||o[0]!=n.r||o[1]!=n.g||o[2]!=n.b||o[3]!=n.a){var a=n.r,s=n.g,c=n.b,u=n.a;this._recordUniformData(e,[a,s,c,u]),r=t.DeviceManager.getInstance().gl,i=this.getUniformLocation(e),this._isUniformDataNotExistByLocation(i)||r.uniform4f(i,a,s,c,u)}},e.prototype.sendNum1=function(e,n){var r=null,i=null;this._uniformCache[e]!==n&&(this._recordUniformData(e,n),r=t.DeviceManager.getInstance().gl,i=this.getUniformLocation(e),this._isUniformDataNotExistByLocation(i)||r.uniform1i(i,n))},e.prototype.sendMatrix3=function(e,n){var r=t.DeviceManager.getInstance().gl,i=this.getUniformLocation(e);this._isUniformDataNotExistByLocation(i)||r.uniformMatrix3fv(i,!1,n.values)},e.prototype.sendMatrix4=function(e,n){var r=t.DeviceManager.getInstance().gl,i=this.getUniformLocation(e);this._isUniformDataNotExistByLocation(i)||r.uniformMatrix4fv(i,!1,n.values)},e.prototype.sendSampleArray=function(e,n){var r=null,i=null,o=this._uniformCache[e],a=!0;if(o){for(var s=0,c=n.length;c>s;s++)if(o[s]!==n[s]){a=!1;break}if(a)return}this._recordUniformData(e,n),r=t.DeviceManager.getInstance().gl,i=this.getUniformLocation(e),this._isUniformDataNotExistByLocation(i)||r.uniform1iv(i,n)},e.prototype.getUniformLocation=function(e){var n=null,r=t.DeviceManager.getInstance().gl;return n=this._getUniformLocationCache[e],void 0!==n?n:(n=r.getUniformLocation(this._program.glProgram,e),this._getUniformLocationCache[e]=n,n)},e.prototype.addBufferToToSendList=function(t,e){this._toSendBufferArr[t]=e,this._toSendBuffersUidStr+=String(e.uid)},e.prototype.sendAllBufferData=function(t){var e=this._toSendBufferArr;if(t)return void t.sendAllBufferData(this._toSendBuffersUidStr,e);for(var n=0,r=e.length;r>n;n++){var i=e[n];i&&this.sendBuffer(n,i)}},e.prototype.clearBufferList=function(){this._toSendBufferArr=[],this._toSendBuffersUidStr=""},e.prototype.sendBuffer=function(e,n){var r=t.DeviceManager.getInstance().gl;r.bindBuffer(r.ARRAY_BUFFER,n.buffer),r.vertexAttribPointer(e,n.size,r[n.type],!1,0,0),this._vertexAttribHistory[e]!==!0&&(r.enableVertexAttribArray(e),this._vertexAttribHistory[e]=!0)},e.prototype.disableVertexAttribArray=function(){var e=t.DeviceManager.getInstance().gl;for(var n in this._vertexAttribHistory){var r=+n;r>e.VERTEX_ATTRIB_ARRAY_ENABLED||!this._vertexAttribHistory[r]||(this._vertexAttribHistory[r]=!1,e.disableVertexAttribArray(r))}this._vertexAttribHistory=[]},e.prototype.clearAllCache=function(){this._getUniformLocationCache={},this._uniformCache={}},e.prototype.dispose=function(){this.disableVertexAttribArray()},e.prototype._recordUniformData=function(t,e){this._uniformCache[t]=e},e.prototype._isUniformDataNotExistByLocation=function(t){return null===t},__decorate([t.require(function(e,n){t.assert(t.JudgeUtils.isNumber(n),t.Log.info.FUNC_MUST_BE("data","be number"))})],e.prototype,"sendNum1",null),__decorate([t.require(function(e,n){t.assert(t.JudgeUtils.isArrayExactly(n),t.Log.info.FUNC_SHOULD("data","be array, but actual is "+n));for(var r=0,i=n;r<i.length;r++){var o=i[r];t.assert(t.JudgeUtils.isNumber(o),t.Log.info.FUNC_SHOULD("data","be Array<number>, but actual is "+n))}})],e.prototype,"sendSampleArray",null),__decorate([t.require(function(){t.assert(!t.ArrayUtils.hasRepeatItems(this._toSendBufferArr),t.Log.info.FUNC_SHOULD_NOT("_toSendBufferArr","has repeat buffer"))}),t.cache(function(){return t.BufferTable.lastBindedArrayBufferListUidStr===this._toSendBuffersUidStr},function(){},function(){t.BufferTable.lastBindedArrayBufferListUidStr=this._toSendBuffersUidStr})],e.prototype,"sendAllBufferData",null),e}();t.GLSLDataSender=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._webglState=null,this.drawMode=t.EDrawMode.TRIANGLES,this.blend=!1,this.vaoManager=null}return Object.defineProperty(e.prototype,"webglState",{get:function(){return this._webglState?this._webglState:t.BasicState.create()},set:function(t){this._webglState=t},enumerable:!0,configurable:!0}),e.prototype.init=function(){},e.prototype.dispose=function(){},e.prototype.drawElements=function(e){var n=0,r=t.DeviceManager.getInstance().gl;t.BufferTable.bindIndexBuffer(e),t.GlUtils.drawElements(r[this.drawMode],e.count,r[e.type],e.typeSize*n)},e.prototype.drawArray=function(e){var n=0,r=t.DeviceManager.getInstance().gl;t.GlUtils.drawArrays(r[this.drawMode],n,e.count)},__decorate([t.virtual],e.prototype,"init",null),__decorate([t.virtual],e.prototype,"dispose",null),e}();t.RenderCommand=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.vMatrix=null,this.pMatrix=null,this.buffers=null,this.material=null,this.z=null,this.target=null,this.sortId=null}return __extends(e,t),Object.defineProperty(e.prototype,"program",{get:function(){return this.material.program},enumerable:!0,configurable:!0}),e.prototype.execute=function(){var t=this.material;t.updateShader(this),this.draw(t)},e}(t.RenderCommand);t.QuadCommand=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._mMatrix=null,this.normalMatrix=null}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"mvpMatrix",{get:function(){return this.mMatrix.applyMatrix(this.vMatrix,!0).applyMatrix(this.pMatrix,!1)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"mMatrix",{get:function(){return this._mMatrix},set:function(t){this._mMatrix=t},enumerable:!0,configurable:!0}),n.prototype.draw=function(e){var n=null,r=this.buffers.getChild(t.EBufferDataType.INDICE);this.webglState.setState(e),r?this.drawElements(r):(n=this.buffers.getChild(t.EBufferDataType.VERTICE),this.drawArray(n))},__decorate([t.requireGetter(function(){t.assert(!!this.mMatrix&&!!this.vMatrix&&!!this.pMatrix,t.Log.info.FUNC_NOT_EXIST("mMatrix or vMatrix or pMatrix"))})],n.prototype,"mvpMatrix",null),n}(t.QuadCommand);t.SingleDrawCommand=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.MODELMATRIX=0]="MODELMATRIX",t[t.NORMALMATRIX_MODELMATRIX=1]="NORMALMATRIX_MODELMATRIX"}(t.EInstanceGLSLData||(t.EInstanceGLSLData={}));t.EInstanceGLSLData}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(t.QuadCommand);t.InstanceCommand=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.instanceList=null,this.instanceBuffer=null,this.glslData=t.EInstanceGLSLData.MODELMATRIX}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.draw=function(e){var n=null;if(this._hasInstance()){switch(this.webglState.setState(e),this.glslData){case t.EInstanceGLSLData.MODELMATRIX:n=t.ModelMatrixHardwareInstanceDrawer.getInstance();break;case t.EInstanceGLSLData.NORMALMATRIX_MODELMATRIX:n=t.NormalMatrixModelMatrixHardwareInstanceDrawer.getInstance()}n.draw(this.instanceList,this.instanceBuffer,this.program,this.buffers,this.drawMode)}},n.prototype._hasInstance=function(){return!!this.instanceList&&this.instanceList.getCount()>0},__decorate([t.ensure(function(e){t.assert(t.JudgeUtils.isBoolean(e),t.Log.info.FUNC_SHOULD("return boolean value")),e&&(t.assert(t.InstanceUtils.isHardwareSupport(),t.Log.info.FUNC_SHOULD("hardware","support instance")),t.assert(!!this.instanceBuffer,t.Log.info.FUNC_MUST_DEFINE("instanceBuffer")))})],n.prototype,"_hasInstance",null),n}(t.InstanceCommand);t.HardwareInstanceCommand=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.shader=null,this.indexBuffer=null,this.vertexBuffer=null}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.init=function(){this.blend=!1,this.drawMode=t.EDrawMode.TRIANGLES},n.prototype.execute=function(){this.shader.update(this),this.drawElements(this.indexBuffer)},n}(t.RenderCommand);t.ProceduralCommand=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t}();t.InstanceDrawer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.prototype.draw=function(e,n,r,i,o){var a=null,s=this.getOffsetLocationArray(r);if(this.setCapacity(e,n),this.sendGLSLData(e,n,s),a=i.getChild(t.EBufferDataType.INDICE))this._drawElementsInstancedANGLE(a,e.getCount(),o);else{var c=i.getChild(t.EBufferDataType.VERTICE);this._drawArraysInstancedANGLE(c,e.getCount(),o)}this._unBind(n,s)},n.prototype._unBind=function(e,n){var r=t.DeviceManager.getInstance().gl,i=t.GPUDetector.getInstance().extensionInstancedArrays;r.bindBuffer(r.ARRAY_BUFFER,e.buffer);for(var o=0,a=n;o<a.length;o++){var s=a[o];r.disableVertexAttribArray(s),i.vertexAttribDivisorANGLE(s,0)}},n.prototype._drawElementsInstancedANGLE=function(e,n,r){var i=0,o=t.DeviceManager.getInstance().gl;t.BufferTable.bindIndexBuffer(e),t.GlUtils.drawElementsInstancedANGLE(o[r],e.count,o[e.type],e.typeSize*i,n)},n.prototype._drawArraysInstancedANGLE=function(e,n,r){var i=0,o=t.DeviceManager.getInstance().gl;t.GlUtils.drawArraysInstancedANGLE(o[r],i,e.count,n)},__decorate([t.require(function(){t.assert(t.InstanceUtils.isHardwareSupport(),t.Log.info.FUNC_SHOULD("hardware","support instance"))})],n.prototype,"draw",null),n}(t.InstanceDrawer);t.HardwareInstanceDrawer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.getOffsetLocationArray=function(t){return[t.getAttribLocation("a_mVec4_0"),t.getAttribLocation("a_mVec4_1"),t.getAttribLocation("a_mVec4_2"),t.getAttribLocation("a_mVec4_3")]},n.prototype.setCapacity=function(t,e){e.setCapacity(64*t.getCount())},n.prototype.sendGLSLData=function(e,n,r){var i=new Float32Array(n.float32InstanceArraySize),o=0,a=t.DeviceManager.getInstance().gl,s=t.GPUDetector.getInstance().extensionInstancedArrays;e.forEach(function(t){var e=t.transform.localToWorldMatrix;e.cloneToArray(i,o),o+=16}),n.resetData(i,r);for(var c=0;4>c;c++){var u=r[c];a.enableVertexAttribArray(u),a.vertexAttribPointer(u,4,a.FLOAT,!1,64,16*c),s.vertexAttribDivisorANGLE(u,1)}},n._instance=null,n}(t.HardwareInstanceDrawer);t.ModelMatrixHardwareInstanceDrawer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.getOffsetLocationArray=function(t){return[t.getAttribLocation("a_mVec4_0"),t.getAttribLocation("a_mVec4_1"),t.getAttribLocation("a_mVec4_2"),t.getAttribLocation("a_mVec4_3"),t.getAttribLocation("a_normalVec4_0"),t.getAttribLocation("a_normalVec4_1"),t.getAttribLocation("a_normalVec4_2")]},n.prototype.setCapacity=function(t,e){e.setCapacity(112*t.getCount())},n.prototype.sendGLSLData=function(e,n,r){var i=new Float32Array(n.float32InstanceArraySize),o=0,a=t.DeviceManager.getInstance().gl,s=t.GPUDetector.getInstance().extensionInstancedArrays;e.forEach(function(t){var e=t.transform.localToWorldMatrix,n=t.transform.normalMatrix;e.cloneToArray(i,o),o+=16,n.cloneToArray(i,o),o+=9}),n.resetData(i,r);for(var c=0;4>c;c++){var u=r[c];a.enableVertexAttribArray(u),a.vertexAttribPointer(u,4,a.FLOAT,!1,100,16*c),s.vertexAttribDivisorANGLE(u,1)}for(var c=4;7>c;c++){var u=r[c];a.enableVertexAttribArray(u),a.vertexAttribPointer(u,3,a.FLOAT,!1,100,12*(c-4)+64),s.vertexAttribDivisorANGLE(u,1)}},n._instance=null,n}(t.HardwareInstanceDrawer);t.NormalMatrixModelMatrixHardwareInstanceDrawer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.instanceList=null,this.glslData=t.EInstanceGLSLData.MODELMATRIX}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.draw=function(e){var n=null;if(this._hasInstance()){switch(this.webglState.setState(e),this.glslData){case t.EInstanceGLSLData.MODELMATRIX:n=t.ModelMatrixBatchInstanceDrawer.getInstance();break;case t.EInstanceGLSLData.NORMALMATRIX_MODELMATRIX:n=t.NormalMatrixModelMatrixBatchInstanceDrawer.getInstance()}n.draw(this.instanceList,this.program,this.buffers,this.drawMode)}},n.prototype._hasInstance=function(){return!!this.instanceList&&this.instanceList.getCount()>0},__decorate([t.ensure(function(e){t.assert(t.JudgeUtils.isBoolean(e),t.Log.info.FUNC_SHOULD("return boolean value")),e&&t.assert(!t.InstanceUtils.isHardwareSupport(),t.Log.info.FUNC_SHOULD_NOT("hardware","support instance"))})],n.prototype,"_hasInstance",null),n}(t.InstanceCommand);t.BatchInstanceCommand=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.prototype.draw=function(e,n,r,i){var o=this,a=null,s=null,c=t.DeviceManager.getInstance().gl;if(s=this.getUniformDataNameArray(n),a=r.getChild(t.EBufferDataType.INDICE))t.BufferTable.bindIndexBuffer(a),e.forEach(function(e){var r=0;o.sendGLSLData(n,e,s),t.GlUtils.drawElements(c[i],a.count,c[a.type],a.typeSize*r)},this);else{var u=r.getChild(t.EBufferDataType.VERTICE);e.forEach(function(e){var r=0;o.sendGLSLData(n,e,s),t.GlUtils.drawArrays(c[i],r,u.count)},this)}},__decorate([t.require(function(){t.assert(!t.InstanceUtils.isHardwareSupport(),t.Log.info.FUNC_SHOULD("hardware","not support instance"))})],n.prototype,"draw",null),n}(t.InstanceDrawer);t.BatchInstanceDrawer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.getUniformDataNameArray=function(t){return["u_mMatrix"]},n.prototype.sendGLSLData=function(e,n,r){var i=r[0];e.sendUniformData(i,t.EVariableType.FLOAT_MAT4,n.transform.localToWorldMatrix)},n._instance=null,n}(t.BatchInstanceDrawer);t.ModelMatrixBatchInstanceDrawer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.getUniformDataNameArray=function(t){return["u_mMatrix","u_normalMatrix"]},n.prototype.sendGLSLData=function(e,n,r){var i=r[0],o=r[1];e.sendUniformData(i,t.EVariableType.FLOAT_MAT4,n.transform.localToWorldMatrix),e.sendUniformData(o,t.EVariableType.FLOAT_MAT3,n.transform.normalMatrix)},n._instance=null,n}(t.BatchInstanceDrawer);t.NormalMatrixModelMatrixBatchInstanceDrawer=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.drawElements=function(e,n,r,i){t.DebugStatistics.count.drawCalls++,t.DebugStatistics.count.renderGameObjects++,this._getGl().drawElements(e,n,r,i)},e.drawArrays=function(e,n,r){t.DebugStatistics.count.drawCalls++,t.DebugStatistics.count.renderGameObjects++,this._getGl().drawArrays(e,n,r)},e.drawElementsInstancedANGLE=function(e,n,r,i,o){var a=t.GPUDetector.getInstance().extensionInstancedArrays;t.DebugStatistics.count.drawCalls++,t.DebugStatistics.count.renderGameObjects+=o,a.drawElementsInstancedANGLE(e,n,r,i,o)},e.drawArraysInstancedANGLE=function(e,n,r,i){var o=t.GPUDetector.getInstance().extensionInstancedArrays;t.DebugStatistics.count.drawCalls++,t.DebugStatistics.count.renderGameObjects+=i,o.drawArraysInstancedANGLE(e,n,r,i)},e._getGl=function(){return t.DeviceManager.getInstance().gl},e}();t.GlUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t,e){this.width=null,this.height=null,this._originScissorTest=null,this._glTarget=null,this.width=t,this.height=e}return e.create=function(t,e){var n=new this(t,e);return n},Object.defineProperty(e.prototype,"gl",{get:function(){return t.DeviceManager.getInstance().gl},enumerable:!0,configurable:!0}),e.prototype.createFrameBuffer=function(){return this.gl.createFramebuffer()},e.prototype.bindFrameBuffer=function(t){var e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,t)},e.prototype.setViewport=function(){var e=t.DeviceManager.getInstance();e.setViewport(0,0,this.width,this.height),this._originScissorTest=e.scissorTest,e.scissorTest=!1},e.prototype.restoreViewport=function(){var e=t.DeviceManager.getInstance(),n=e.view;e.setViewport(0,0,n.width,n.height),e.scissorTest=this._originScissorTest},e.prototype.dispose=function(){this.unBindAll()},e.prototype.unBindAll=function(){var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null)},e.prototype.unBindFrameBuffer=function(){var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,null)},e.prototype.createRenderBuffer=function(){var t=this.gl,e=t.createRenderbuffer();return e},e.prototype.attachTexture=function(e,n,r){void 0===r&&(r=t.EFrameBufferAttachType.COLOR_ATTACHMENT0);var i=this.gl;i.framebufferTexture2D(i.FRAMEBUFFER,i[r],e,n,0),this._glTarget=e},e.prototype.attachRenderBuffer=function(t,e){var n=this.gl;n.bindRenderbuffer(n.RENDERBUFFER,e),n.renderbufferStorage(n.RENDERBUFFER,n.DEPTH_COMPONENT16,this.width,this.height),n.framebufferRenderbuffer(n.FRAMEBUFFER,n[t],n.RENDERBUFFER,e)},e.prototype.check=function(){var e=this.gl,n=e.checkFramebufferStatus(e.FRAMEBUFFER);n!==e.FRAMEBUFFER_COMPLETE&&t.Log.error(!0,"Frame buffer object is incomplete:"+n.toString())},__decorate([t.ensure(function(){var e=t.DeviceManager.getInstance();t.assert(null!==e.scissorTest,t.Log.info.FUNC_SHOULD_NOT("DeviceManager->scissorTest","be null"))})],e.prototype,"restoreViewport",null),__decorate([t.require(function(){})],e.prototype,"unBindAll",null),__decorate([t.ensure(function(e){t.Log.assert(!!e,t.Log.info.FUNC_NOT_EXIST("renderbuffer object"))})],e.prototype,"createRenderBuffer",null),e}();t.FrameBuffer=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.COLOR_ATTACHMENT0="COLOR_ATTACHMENT0"]="COLOR_ATTACHMENT0",t[t.DEPTH_ATTACHMENT="DEPTH_ATTACHMENT"]="DEPTH_ATTACHMENT"}(t.EFrameBufferAttachType||(t.EFrameBufferAttachType={}));t.EFrameBufferAttachType}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._attributes=wdCb.Hash.create(),this._uniforms=wdCb.Hash.create(),this._vsSource="",this._fsSource="",this.libDirty=!1,this.definitionDataDirty=!1,this.mapManager=t.MapManager.create(),this.libs=wdCb.Collection.create(),this.sourceBuilder=this.createShaderSourceBuilder(),this._programCache=null,this._instanceStateCache=null}return Object.defineProperty(e.prototype,"attributes",{get:function(){return this._attributes},set:function(t){this._isNotEqual(t,this._attributes)&&(this.definitionDataDirty=!0),this._attributes=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"uniforms",{get:function(){return this._uniforms},set:function(t){this._isNotEqual(t,this._uniforms)&&(this.definitionDataDirty=!0),this._uniforms=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"vsSource",{get:function(){return this._vsSource},set:function(t){t!==this._vsSource&&(this.definitionDataDirty=!0),this._vsSource=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fsSource",{get:function(){return this._fsSource},set:function(t){t!==this._fsSource&&(this.definitionDataDirty=!0),this._fsSource=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dirty",{get:function(){return this.libDirty||this.definitionDataDirty},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"program",{get:function(){return t.ProgramTable.getProgram(this._getProgramTableKey())},enumerable:!0,configurable:!0}),e.prototype.createVsShader=function(){var e=t.DeviceManager.getInstance().gl;return this._initShader(e.createShader(e.VERTEX_SHADER),this.vsSource)},e.prototype.createFsShader=function(){var e=t.DeviceManager.getInstance().gl;return this._initShader(e.createShader(e.FRAGMENT_SHADER),this.fsSource)},e.prototype.init=function(t){this.libs.forEach(function(t){t.init()}),this.judgeRefreshShader(null,t),this.mapManager.init()},e.prototype.dispose=function(){this.attributes.removeAllChildren(),this.uniforms.removeAllChildren(),this.libs.forEach(function(t){t.dispose()}),this.mapManager.dispose(),this._clearAllCache()},e.prototype.hasLib=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(e[0]instanceof t.ShaderLib){var r=e[0];return this.libs.hasChild(r)}var i=e[0];return this.libs.hasChildWithFunc(function(t){return t instanceof i})},e.prototype.addLib=function(t){this.libs.addChild(t),t.shader=this,this.libDirty=!0},e.prototype.addShaderLibToTop=function(t){this.libs.unShiftChild(t),t.shader=this,this.libDirty=!0},e.prototype.getLib=function(t){return this.libs.findOne(function(e){return e instanceof t})},e.prototype.getLibs=function(){return this.libs},e.prototype.removeLib=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return this.libDirty=!0,this.libs.removeChild(t[0])},e.prototype.removeAllLibs=function(){this.libDirty=!0,this.libs.removeAllChildren()},e.prototype.sortLib=function(t){this.libDirty=!0,this.libs.sort(t,!0)},e.prototype.getInstanceState=function(){var e=!1,n=!1,r=!1,i=!1;return this.libs.forEach(function(o){return o instanceof t.InstanceShaderLib?o instanceof t.NormalMatrixHardwareInstanceShaderLib?(n=!0,r=!0,wdCb.$BREAK):o instanceof t.NormalMatrixBatchInstanceShaderLib?(n=!0,i=!0,wdCb.$BREAK):o instanceof t.ModelMatrixHardwareInstanceShaderLib?(e=!0,void(r=!0)):o instanceof t.ModelMatrixBatchInstanceShaderLib?(e=!0,void(i=!0)):void 0:void 0}),{isModelMatrixInstance:e,isNormalMatrixInstance:n,isHardwareInstance:r,isBatchInstance:i}},e.prototype.judgeRefreshShader=function(t,e){this.libDirty&&(this._instanceStateCache=null,this.buildDefinitionData(t,e)),this.definitionDataDirty&&(this._programCache=null,this._registerAndUpdateProgram(),this._programCache=null),this.libDirty=!1,this.definitionDataDirty=!1},e.prototype._registerAndUpdateProgram=function(){var e=this._getProgramTableKey();t.ProgramTable.hasProgram(e)||(t.ProgramTable.addProgram(e,t.Program.create()),this._updateProgram())},e.prototype._updateProgram=function(){this.program.initWithShader(this)},e.prototype._getProgramTableKey=function(){return this.vsSource+"\n"+this.fsSource},e.prototype._initShader=function(e,n){var r=t.DeviceManager.getInstance().gl;return r.shaderSource(e,n),r.compileShader(e),r.getShaderParameter(e,r.COMPILE_STATUS)?e:(t.Log.log(r.getShaderInfoLog(e)),t.Log.log("attributes:\n",this.attributes),t.Log.log("uniforms:\n",this.uniforms),t.Log.log("source:\n",n),void 0)},e.prototype._isNotEqual=function(t,e){var n=!1;return t.forEach(function(t,r){var i=e.getChild(r);return i&&t.type===i.type&&t.value===i.value?void 0:(n=!0,wdCb.$BREAK)}),n},e.prototype._clearAllCache=function(){this._programCache=null,this._instanceStateCache=null},__decorate([t.ensureGetter(function(e){t.assert(!!e,t.Log.info.FUNC_NOT_EXIST("program\nits table key is:"+this._getProgramTableKey()))}),t.cacheGetter(function(){return null!==this._programCache},function(){return this._programCache},function(t){this._programCache=t})],e.prototype,"program",null),__decorate([t.execOnlyOnce("_isInit")],e.prototype,"init",null),__decorate([t.ensure(function(){var e=this;this.libs.forEach(function(n){t.assert(t.JudgeUtils.isEqual(n.shader,e),t.Log.info.FUNC_SHOULD("set ShaderLib.shader to be this"))}),t.assert(this.libDirty===!0,t.Log.info.FUNC_SHOULD("libDirty","be true"))})],e.prototype,"addLib",null),__decorate([t.ensure(function(e,n){var r=this;t.assert(t.JudgeUtils.isEqual(n,this.libs.getChild(0)),t.Log.info.FUNC_SHOULD("add shader lib to the top")),this.libs.forEach(function(e){t.assert(t.JudgeUtils.isEqual(e.shader,r),t.Log.info.FUNC_SHOULD("set ShaderLib.shader to be this"))}),t.assert(this.libDirty===!0,t.Log.info.FUNC_SHOULD("libDirty","be true"))})],e.prototype,"addShaderLibToTop",null),__decorate([t.ensure(function(e){var n=e.isModelMatrixInstance,r=e.isNormalMatrixInstance,i=e.isHardwareInstance,o=e.isBatchInstance;r&&t.assert(n===!0,t.Log.info.FUNC_MUST_BE("modelMatrixInstance if is normalMatrixInstance")),t.assert(!(i&&o),t.Log.info.FUNC_SHOULD_NOT("both be hardware insstance and batch instance"))}),t.cache(function(){return this._instanceStateCache},function(){return this._instanceStateCache},function(t){this._instanceStateCache=t})],e.prototype,"getInstanceState",null),e}();t.Shader=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.update=function(t,e){var n=null;this.judgeRefreshShader(t,e),n=this.program,n.use(),this.libs.forEach(function(r){r.sendShaderVariables(n,t,e)}),this.mapManager.bindAndUpdate(),this.mapManager.sendData(n)},n.prototype.read=function(t){this.sourceBuilder.clearShaderDefinition(),this.sourceBuilder.read(t),this.libDirty=!0},n.prototype.getSampler2DUniformsAfterRead=function(){return this.sourceBuilder.uniforms.filter(function(e,n){return e.type===t.EVariableType.SAMPLER_2D})},n.prototype.buildDefinitionData=function(t,e){this.sourceBuilder.build(),this.attributes=this.sourceBuilder.attributes,this.uniforms=this.sourceBuilder.uniforms,this.vsSource=this.sourceBuilder.vsSource,this.fsSource=this.sourceBuilder.fsSource},n.prototype.createShaderSourceBuilder=function(){return t.CustomShaderSourceBuilder.create()},n}(t.Shader);t.CustomShader=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.prototype.buildDefinitionData=function(t,e){this.libs.forEach(function(n){n.setShaderDefinition(t,e)}),this.sourceBuilder.clearShaderDefinition(),this.sourceBuilder.build(this.libs),this.attributes=this.sourceBuilder.attributes,this.uniforms=this.sourceBuilder.uniforms,this.vsSource=this.sourceBuilder.vsSource,this.fsSource=this.sourceBuilder.fsSource},n.prototype.createShaderSourceBuilder=function(){return t.EngineShaderSourceBuilder.create()},n}(t.Shader);t.EngineShader=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.update=function(t,e){var n=null;this.judgeRefreshShader(t,e),n=this.program,n.use(),this.libs.forEach(function(r){r.sendShaderVariables(n,t,e)}),this.mapManager.bindAndUpdate(),this.mapManager.sendData(n)},e}(t.EngineShader);t.CommonShader=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.prototype.init=function(){this.addLib(t.CommonProceduralShaderLib.create()),e.prototype.init.call(this,null)},n.prototype.update=function(t){var e=null;this.judgeRefreshShader(t,null),e=this.program,e.use(),this.libs.forEach(function(n){n.sendShaderVariables(e,t)})},n}(t.EngineShader);t.ProceduralShader=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e}(t.ProceduralShader);t.CommonProceduralShader=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(e){t.call(this),this._texture=null,this._texture=e}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e.prototype.update=function(e){t.prototype.update.call(this,e),this._texture.mapManager.bindAndUpdate(),this._texture.mapManager.sendData(this.program)},e}(t.ProceduralShader);t.CustomProceduralShader=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.MIRROR="MIRROR"]="MIRROR",t[t.DYNAMIC_CUBEMAP="DYNAMIC_CUBEMAP"]="DYNAMIC_CUBEMAP",t[t.REFRACTION="REFRACTION"]="REFRACTION",t[t.TWOD_SHADOWMAP="TWOD_SHADOWMAP"]="TWOD_SHADOWMAP",t[t.BUILD_CUBEMAP_SHADOWMAP="BUILD_CUBEMAP_SHADOWMAP"]="BUILD_CUBEMAP_SHADOWMAP",
t[t.CUBEMAP_SHADOWMAP="CUBEMAP_SHADOWMAP"]="CUBEMAP_SHADOWMAP"}(t.EShaderGLSLData||(t.EShaderGLSLData={}));t.EShaderGLSLData}(wd||(wd={}));var wd;!function(t){!function(t){t[t.BUILD_TWOD_SHADOWMAP="BUILD_TWOD_SHADOWMAP"]="BUILD_TWOD_SHADOWMAP",t[t.BUILD_CUBEMAP_SHADOWMAP="BUILD_CUBEMAP_SHADOWMAP"]="BUILD_CUBEMAP_SHADOWMAP"}(t.EShaderTypeOfScene||(t.EShaderTypeOfScene={}));t.EShaderTypeOfScene}(wd||(wd={}));var wd;!function(t){!function(t){t[t.BUILD_TWOD_SHADOWMAP_INSTANCE="BUILD_TWOD_SHADOWMAP_INSTANCE"]="BUILD_TWOD_SHADOWMAP_INSTANCE",t[t.BUILD_TWOD_SHADOWMAP_NO_INSTANCE="BUILD_TWOD_SHADOWMAP_NO_INSTANCE"]="BUILD_TWOD_SHADOWMAP_NO_INSTANCE",t[t.BUILD_CUBEMAP_SHADOWMAP_INSTANCE="BUILD_CUBEMAP_SHADOWMAP_INSTANCE"]="BUILD_CUBEMAP_SHADOWMAP_INSTANCE",t[t.BUILD_CUBEMAP_SHADOWMAP_NO_INSTANCE="BUILD_CUBEMAP_SHADOWMAP_NO_INSTANCE"]="BUILD_CUBEMAP_SHADOWMAP_NO_INSTANCE"}(t.EShaderMapKeyOfScene||(t.EShaderMapKeyOfScene={}));t.EShaderMapKeyOfScene}(wd||(wd={}));var wd;!function(t){!function(t){t[t.DEFAULT="DEFAULT"]="DEFAULT"}(t.EShaderMapKey||(t.EShaderMapKey={}));t.EShaderMapKey}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._material=null,this._textureDirty=!1,this._allMapsCache=null,this._allSingleMapsCache=null,this._shadowMapController=t.ShadowMapController.create(),this._arrayMapController=t.MapArrayController.create(),this._envMapController=t.EnvMapController.create(),this._commonMapController=t.CommonMapController.create()}return e.create=function(){var t=new this;return t},Object.defineProperty(e.prototype,"material",{get:function(){return this._material},set:function(t){this._material=t,this._envMapController.material=t,this._commonMapController.material=t},enumerable:!0,configurable:!0}),e.prototype.init=function(){for(var t=this._getAllMaps(),e=0,n=t.length;n>e;e++){var r=t[e];r.init()}},e.prototype.addMap=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null;if(e[0]instanceof t.TextureAsset){var i=e[0];r=i.toTexture()}else e[0]instanceof t.Texture&&(r=e[0]);1===e.length?this._commonMapController.addMap(r):this._commonMapController.addMap(r,e[1]),this._textureDirty=!0},e.prototype.addMapArray=function(t,e){this._arrayMapController.addMapArray(t,e),this._textureDirty=!0},e.prototype.addTwoDShadowMap=function(t){this._shadowMapController.addTwoDShadowMap(t),this._textureDirty=!0},e.prototype.getTwoDShadowMapList=function(){return this._shadowMapController.getTwoDShadowMapList()},e.prototype.hasTwoDShadowMap=function(t){return this._shadowMapController.hasTwoDShadowMap(t)},e.prototype.addCubemapShadowMap=function(t){this._shadowMapController.addCubemapShadowMap(t),this._textureDirty=!0},e.prototype.getCubemapShadowMapList=function(){return this._shadowMapController.getCubemapShadowMapList()},e.prototype.hasCubemapShadowMap=function(t){return this._shadowMapController.hasCubemapShadowMap(t)},e.prototype.getMapList=function(){return this._commonMapController.getMapList()},e.prototype.hasMap=function(t){return this._commonMapController.hasMap(t)},e.prototype.getMapCount=function(){return this.getMapList().getCount()},e.prototype.getEnvMap=function(){return this._envMapController.getEnvMap()},e.prototype.setEnvMap=function(t){return t?(this._envMapController.setEnvMap(t),void(this._textureDirty=!0)):(this._envMapController.setEnvMap(null),void(this._textureDirty=!0))},e.prototype.removeChild=function(t){for(var e=0,n=this._getAllControllerArr();e<n.length;e++){var r=n[e];r.removeChild(t)}this._textureDirty=!0},e.prototype.removeAllChildren=function(){for(var t=0,e=this._getAllControllerArr();t<e.length;t++){var n=e[t];n.removeAllChildren()}this._textureDirty=!0},e.prototype.removeAllShdaowMaps=function(){this._shadowMapController.removeAllChildren(),this._textureDirty=!0},e.prototype.dispose=function(){for(var t=this._getAllMaps(),e=0,n=t.length;n>e;e++){var r=t[e];r.dispose()}this.removeAllChildren()},e.prototype.bindAndUpdate=function(){for(var t=this._getAllMaps(),e=0,n=t.length;n>e;e++){var r=t[e];r.bindToUnit(e),r.needUpdate&&r.update(e)}},e.prototype.sendData=function(t){this._sendSingleMapData(t),this._arrayMapController.sendMapData(t,this._getMaxUnitOfBindedSingleMap())},e.prototype._sendSingleMapData=function(t){for(var e=this._getAllSingleMaps(),n=e.length,r=0;n>r;r++){var i=e[r];i.sendData(t,i.getSamplerName(r),r)}},e.prototype._getAllMaps=function(){return[].concat(this._getAllSingleMaps(),this._arrayMapController.getAllMapArr())},e.prototype._getMaxUnitOfBindedSingleMap=function(){return this._getAllSingleMaps().length},e.prototype._getAllSingleMaps=function(){for(var t=[],e=0,n=this._getAllSingleMapControllerArr();e<n.length;e++){var r=n[e];t=t.concat(r.getAllMapArr())}return t},e.prototype._getAllSingleMapControllerArr=function(){return[this._shadowMapController,this._envMapController,this._commonMapController]},e.prototype._getAllControllerArr=function(){return[this._shadowMapController,this._envMapController,this._arrayMapController,this._commonMapController]},__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];t.assert(e[0]instanceof t.TextureAsset||e[0]instanceof t.Texture,t.Log.info.FUNC_SHOULD("arguments[0]","be TextureAsset || Texture"))})],e.prototype,"addMap",null),__decorate([t.require(function(e,n){t.assert(t.JudgeUtils.isArrayExactly(n),t.Log.info.FUNC_SHOULD("second param","be array"));for(var r=0,i=n;r<i.length;r++){var o=i[r];t.assert(o instanceof t.Texture,t.Log.info.FUNC_SHOULD(t.Log.info.FUNC_SHOULD("second param","be Array<Texture>")))}})],e.prototype,"addMapArray",null),__decorate([t.require(function(e){t.assert(!this._shadowMapController.hasTwoDShadowMap(e),t.Log.info.FUNC_SHOULD_NOT("add the shadowMap which is already exist"))})],e.prototype,"addTwoDShadowMap",null),__decorate([t.require(function(e){t.assert(!this._shadowMapController.hasCubemapShadowMap(e),t.Log.info.FUNC_SHOULD_NOT("add the shadowMap which is already exist"))})],e.prototype,"addCubemapShadowMap",null),__decorate([t.ensure(function(e){e.forEach(function(e){t.assert(e instanceof t.BasicTexture||e instanceof t.ProceduralTexture,t.Log.info.FUNC_SHOULD("mapList","only contain BasicTexture or ProceduralTexture"))})})],e.prototype,"getMapList",null),__decorate([t.require(function(e){for(var n={},r=this._getAllMaps(),i=0,o=r.length;o>i;i++){var a=r[i],s=a.getSamplerName(i);t.assert(1!==n[s],t.Log.info.FUNC_SHOULD_NOT("has duplicate maps, but actual has the ones with the same samplerName:"+s)),n[s]=1}})],e.prototype,"sendData",null),__decorate([t.ensure(function(e){for(var n=0,r=e;n<r.length;n++){var i=r[n];t.assert(i instanceof t.Texture,t.Log.info.FUNC_SHOULD("each element","be Texture"))}}),t.cache(function(){return!this._textureDirty&&this._allMapsCache},function(){return this._allMapsCache},function(t){this._allMapsCache=t,this._textureDirty=!1})],e.prototype,"_getAllMaps",null),__decorate([t.cache(function(){return!this._textureDirty&&this._allSingleMapsCache},function(){return this._allSingleMapsCache},function(t){this._allSingleMapsCache=t,this._textureDirty=!1})],e.prototype,"_getAllSingleMaps",null),e}();t.MapManager=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t.prototype.hasMapHelper=function(t,e){return t?t.hasChild(e):!1},t.prototype.setMapOption=function(t,e){t.variableData=e},t}();t.MapController=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this._twoDShadowMapList=wdCb.Collection.create(),this._cubemapShadowMapList=wdCb.Collection.create()}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.addTwoDShadowMap=function(t){this.setMapOption(t,{samplerData:this._twoDShadowMapList.getCount()}),this._twoDShadowMapList.addChild(t)},e.prototype.addCubemapShadowMap=function(t){this.setMapOption(t,{samplerData:this._cubemapShadowMapList.getCount()}),this._cubemapShadowMapList.addChild(t)},e.prototype.hasTwoDShadowMap=function(t){return this.hasMapHelper(this._twoDShadowMapList,t)},e.prototype.hasCubemapShadowMap=function(t){return this.hasMapHelper(this._cubemapShadowMapList,t)},e.prototype.getTwoDShadowMapList=function(){return this._twoDShadowMapList},e.prototype.getCubemapShadowMapList=function(){return this._cubemapShadowMapList},e.prototype.getAllMapArr=function(){return this._twoDShadowMapList.clone(!1).addChildren(this._cubemapShadowMapList).toArray()},e.prototype.removeChild=function(t){this._twoDShadowMapList.removeChild(t),this._cubemapShadowMapList.removeChild(t)},e.prototype.removeAllChildren=function(){this._twoDShadowMapList.removeAllChildren(),this._cubemapShadowMapList.removeAllChildren()},e}(t.MapController);t.ShadowMapController=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.material=null,this._map=null}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.setEnvMap=function(t){return t?(t.material=this.material,void(this._map=t)):void(this._map=null)},n.prototype.getEnvMap=function(){return this._map},n.prototype.getAllMapArr=function(){return null!==this._map?[this._map]:[]},n.prototype.removeChild=function(e){t.JudgeUtils.isEqual(this._map,e)&&(this._map=null)},n.prototype.removeAllChildren=function(){this._map=null},n}(t.MapController);t.EnvMapController=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._mapArrayList=wdCb.Collection.create()}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.addMapArray=function(t,e){this._mapArrayList.addChild({samplerName:t,mapArray:e})},n.prototype.sendMapData=function(e,n){var r=this;this._mapArrayList.forEach(function(i){var o=i.mapArray.length;e.sendUniformData(i.samplerName+"[0]",t.EVariableType.SAMPLER_ARRAY,r._generateMapArrayUnitArray(n,n+o)),n+=o})},n.prototype.getAllMapArr=function(){var t=[];return this._mapArrayList.forEach(function(e){t=t.concat(e.mapArray)}),t},n.prototype.removeChild=function(t){this._mapArrayList.removeChild(t)},n.prototype.removeAllChildren=function(){this._mapArrayList.removeAllChildren()},n.prototype._generateMapArrayUnitArray=function(t,e){for(var n=[];e>t;)n.push(t),t++;return n},__decorate([t.ensure(function(e){for(var n=0,r=e;n<r.length;n++){var i=r[n];t.assert(i instanceof t.Texture,t.Log.info.FUNC_SHOULD("each element","be Texture"))}})],n.prototype,"getAllMapArr",null),__decorate([t.ensure(function(e,n,r){t.assert(e.length===r-n,t.Log.info.FUNC_SHOULD("length","be "+(r-n)+", but actual is "+e.length)),e.length>0&&(t.assert(e[0]===n,t.Log.info.FUNC_SHOULD("first element","be "+n+", but actual is "+e[0])),t.assert(e[e.length-1]===r-1,t.Log.info.FUNC_SHOULD("last element","be "+(r-1)+", but actual is "+e[e.length-1])))})],n.prototype,"_generateMapArrayUnitArray",null),n}(t.MapController);t.MapArrayController=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.material=null,this._list=wdCb.Collection.create()}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.addMap=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=t[0];if(2===t.length){var r=t[1];this.setMapOption(n,r)}n.material=this.material,this._list.addChild(n)},n.prototype.getAllMapArr=function(){return this._list.toArray()},n.prototype.getMapList=function(){return this._list.filter(function(e){return e instanceof t.BasicTexture||e instanceof t.ProceduralTexture})},n.prototype.hasMap=function(t){return this.hasMapHelper(this._list,t)},n.prototype.removeChild=function(t){this._list.removeChild(t)},n.prototype.removeAllChildren=function(){this._list.removeAllChildren()},n}(t.MapController);t.CommonMapController=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.attributes=wdCb.Hash.create(),this.uniforms=wdCb.Hash.create(),this.vsSource=null,this.fsSource=null}return e.prototype.dispose=function(){this.clearShaderDefinition()},e.prototype.convertAttributesData=function(){var e=this;this.attributes.filter(function(e){return e.value!==t.EVariableCategory.ENGINE&&t.JudgeUtils.isArrayExactly(e.value)}).forEach(function(t,n){t.value=e._convertArrayToArrayBuffer(t.type,t.value)})},e.prototype._convertArrayToArrayBuffer=function(e,n){var r=this._getBufferSize(e);return t.ArrayBuffer.create(n,r,t.EBufferType.FLOAT)},e.prototype._getBufferSize=function(e){var n=null;switch(e){case t.EVariableType.FLOAT_1:case t.EVariableType.NUMBER_1:n=1;break;case t.EVariableType.FLOAT_2:n=2;break;case t.EVariableType.FLOAT_3:n=3;break;case t.EVariableType.FLOAT_4:n=4;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("EVariableType",e))}return n},__decorate([t.require(function(){this.attributes.forEach(function(e){t.assert(!t.JudgeUtils.isFloatArray(e.value),t.Log.info.FUNC_SHOULD_NOT("attribute->value","be Float array"))})})],e.prototype,"convertAttributesData",null),__decorate([t.require(function(e,n){t.assert(t.JudgeUtils.isArrayExactly(n),t.Log.info.FUNC_SHOULD("value:"+n,"be array"))})],e.prototype,"_convertArrayToArrayBuffer",null),e}();t.ShaderSourceBuilder=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.read=function(e){e.attributes&&(this.attributes=wdCb.Hash.create(e.attributes)),e.uniforms&&(this.uniforms=wdCb.Hash.create(e.uniforms)),this.vsSource=t.LoaderManager.getInstance().get(e.vsSourceId),this.fsSource=t.LoaderManager.getInstance().get(e.fsSourceId)},n.prototype.build=function(){this.convertAttributesData()},n.prototype.clearShaderDefinition=function(){this.attributes.removeAllChildren(),this.uniforms.removeAllChildren(),this.vsSource=null,this.fsSource=null},n}(t.ShaderSourceBuilder);t.CustomShaderSourceBuilder=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.vsSourceTop="",this.vsSourceDefine="",this.vsSourceVarDeclare="",this.vsSourceFuncDeclare="",this.vsSourceFuncDefine="",this.vsSourceBody="",this.fsSourceTop="",this.fsSourceDefine="",this.fsSourceVarDeclare="",this.fsSourceFuncDeclare="",this.fsSourceFuncDefine="",this.fsSourceBody="",this.vsSourceDefineList=wdCb.Collection.create(),this.fsSourceDefineList=wdCb.Collection.create()}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.build=function(t){this._readLibSource(t),null===this.vsSource&&this._buildVsSource(),null===this.fsSource&&this._buildFsSource(),this.convertAttributesData()},n.prototype.clearShaderDefinition=function(){this.attributes.removeAllChildren(),this.uniforms.removeAllChildren(),this.vsSourceDefineList.removeAllChildren(),this.fsSourceDefineList.removeAllChildren(),this.vsSourceTop="",this.vsSourceDefine="",this.vsSourceVarDeclare="",this.vsSourceFuncDeclare="",this.vsSourceFuncDefine="",this.vsSourceBody="",this.vsSource=null,this.fsSourceTop="",this.fsSourceDefine="",this.fsSourceVarDeclare="",this.fsSourceFuncDeclare="",this.fsSourceFuncDefine="",this.fsSourceBody="",this.fsSource=null},n.prototype._readLibSource=function(t){var e=t.filter(function(t){return null!==t.vsSource||null!==t.fsSource});this._judgeAndSetVsSource(e),this._judgeAndSetFsSource(e),this._judgeAndSetPartSource(t)},n.prototype._judgeAndSetVsSource=function(t){var e=t.findOne(function(t){return null!==t.vsSource});e&&(this.vsSource=e.vsSource)},n.prototype._judgeAndSetFsSource=function(t){var e=t.findOne(function(t){return null!==t.fsSource});e&&(this.fsSource=e.fsSource)},n.prototype._judgeAndSetPartSource=function(t){var e=this.vsSource,n=this.fsSource,r=this.attributes,i=this.uniforms,o=this.vsSourceDefineList,a=this.fsSourceDefineList,s="",c="",u="",l="",h="",d="",p="",f="",_="",g="",m="",y="";t.forEach(function(t){r.addChildren(t.attributes),i.addChildren(t.uniforms),null===e&&(s+=t.vsSourceTop,c+=t.vsSourceDefine,u+=t.vsSourceVarDeclare,l+=t.vsSourceFuncDeclare,h+=t.vsSourceFuncDefine,d+=t.vsSourceBody,o.addChildren(t.vsSourceDefineList)),null===n&&(p+=t.fsSourceTop,f+=t.fsSourceDefine,_+=t.fsSourceVarDeclare,g+=t.fsSourceFuncDeclare,m+=t.fsSourceFuncDefine,y+=t.fsSourceBody,a.addChildren(t.fsSourceDefineList))}),null===e&&(this.vsSourceTop=s,this.vsSourceDefine=c,this.vsSourceVarDeclare=u,this.vsSourceFuncDeclare=l,this.vsSourceFuncDefine=h,this.vsSourceBody=d),null===n&&(this.fsSourceTop=p,this.fsSourceDefine=f,this.fsSourceVarDeclare=_,this.fsSourceFuncDeclare=g,this.fsSourceFuncDefine=m,this.fsSourceBody=y)},n.prototype._buildVsSource=function(){this.vsSource=this._buildVsSourceTop()+this._buildVsSourceDefine()+this._buildVsSourceVarDeclare()+this._buildVsSourceFuncDeclare()+this._buildVsSourceFuncDefine()+this._buildVsSourceBody()},n.prototype._buildFsSource=function(){this.fsSource=this._buildFsSourceTop()+this._buildFsSourceDefine()+this._buildFsSourceVarDeclare()+this._buildFsSourceFuncDeclare()+this._buildFsSourceFuncDefine()+this._buildFsSourceBody()},n.prototype._buildVsSourceTop=function(){return this._getPrecisionSource()+this.vsSourceTop},n.prototype._buildVsSourceDefine=function(){return this._buildSourceDefine(this.vsSourceDefineList)+this.vsSourceDefine},n.prototype._buildVsSourceVarDeclare=function(){return this._generateAttributeSource()+this._generateUniformSource(this.vsSourceVarDeclare,this.vsSourceFuncDefine,this.vsSourceBody)+this.vsSourceVarDeclare},n.prototype._buildVsSourceFuncDeclare=function(){return this.vsSourceFuncDeclare},n.prototype._buildVsSourceFuncDefine=function(){return this.vsSourceFuncDefine},n.prototype._buildVsSourceBody=function(){return t.ShaderSnippet.main_begin+this.vsSourceBody+t.ShaderSnippet.main_end},n.prototype._buildFsSourceTop=function(){return this._getPrecisionSource()+this.fsSourceTop},n.prototype._buildFsSourceDefine=function(){return this._buildSourceDefine(this.fsSourceDefineList)+this.fsSourceDefine},n.prototype._buildFsSourceVarDeclare=function(){return this._generateUniformSource(this.fsSourceVarDeclare,this.fsSourceFuncDefine,this.fsSourceBody)+this.fsSourceVarDeclare},n.prototype._buildFsSourceFuncDeclare=function(){return this.fsSourceFuncDeclare},n.prototype._buildFsSourceFuncDefine=function(){return this.fsSourceFuncDefine},n.prototype._buildFsSourceBody=function(){return t.ShaderSnippet.main_begin+this.fsSourceBody+t.ShaderSnippet.main_end},n.prototype._buildSourceDefine=function(t){var e="";return t.forEach(function(t){e+=void 0===t.value?"#define "+t.name+"\n":"#define "+t.name+" "+t.value+"\n"}),e},n.prototype._getPrecisionSource=function(){var e=t.GPUDetector.getInstance().precision,n=null;switch(e){case t.EGPUPrecision.HIGHP:n=t.ShaderChunk.highp_fragment.top;break;case t.EGPUPrecision.MEDIUMP:n=t.ShaderChunk.mediump_fragment.top;break;case t.EGPUPrecision.LOWP:n=t.ShaderChunk.lowp_fragment.top;break;default:n=""}return n},n.prototype._generateAttributeSource=function(){var e="";return this.attributes.filter(function(t,e){return!!t}).forEach(function(n,r){e+="attribute "+t.VariableTypeTable.getVariableType(n.type)+" "+r+";\n"}),e},n.prototype._generateUniformSource=function(e,n,r){var i="",o=this;return this.uniforms.filter(function(i,a){return!!i&&i.type!==t.EVariableType.STRUCTURE&&i.type!==t.EVariableType.STRUCTURES&&!o._isExistInSource(a,e)&&(o._isExistInSource(a,n)||o._isExistInSource(a,r))}).forEach(function(e,n){i+="uniform "+t.VariableTypeTable.getVariableType(e.type)+" "+n+";\n"}),i},n.prototype._isExistInSource=function(t,e){return-1!==e.indexOf(t)},__decorate([t.require(function(e){t.assert(null===this.vsSource,t.Log.info.FUNC_SHOULD("vsSource","be null")),t.assert(null===this.fsSource,t.Log.info.FUNC_SHOULD("fsSource","be null"))})],n.prototype,"build",null),n}(t.ShaderSourceBuilder);t.EngineShaderSourceBuilder=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.FLOAT_1="FLOAT_1"]="FLOAT_1",t[t.FLOAT_2="FLOAT_2"]="FLOAT_2",t[t.FLOAT_3="FLOAT_3"]="FLOAT_3",t[t.FLOAT_4="FLOAT_4"]="FLOAT_4",t[t.VECTOR_2="VECTOR_2"]="VECTOR_2",t[t.VECTOR_3="VECTOR_3"]="VECTOR_3",t[t.VECTOR_4="VECTOR_4"]="VECTOR_4",t[t.FLOAT_MAT3="FLOAT_MAT3"]="FLOAT_MAT3",t[t.FLOAT_MAT4="FLOAT_MAT4"]="FLOAT_MAT4",t[t.BUFFER="BUFFER"]="BUFFER",t[t.SAMPLER_CUBE="SAMPLER_CUBE"]="SAMPLER_CUBE",t[t.SAMPLER_2D="SAMPLER_2D"]="SAMPLER_2D",t[t.NUMBER_1="NUMBER_1"]="NUMBER_1",t[t.STRUCTURE="STRUCTURE"]="STRUCTURE",t[t.STRUCTURES="STRUCTURES"]="STRUCTURES",t[t.SAMPLER_ARRAY="SAMPLER_ARRAY"]="SAMPLER_ARRAY"}(t.EVariableType||(t.EVariableType={}));t.EVariableType}(wd||(wd={}));var wd;!function(t){!function(t){t[t.POSITION="POSITION"]="POSITION",t[t.NORMAL="NORMAL"]="NORMAL",t[t.TEXCOORD="TEXCOORD"]="TEXCOORD",t[t.TANGENT="TANGENT"]="TANGENT",t[t.COLOR="COLOR"]="COLOR",t[t.MODEL="MODEL"]="MODEL",t[t.VIEW="VIEW"]="VIEW",t[t.PROJECTION="PROJECTION"]="PROJECTION",t[t.MODEL_VIEW="MODEL_VIEW"]="MODEL_VIEW",t[t.MODEL_VIEW_PROJECTION="MODEL_VIEW_PROJECTION"]="MODEL_VIEW_PROJECTION",t[t.MODEL_INVERSE="MODEL_INVERSE"]="MODEL_INVERSE",t[t.VIEW_INVERSE="VIEW_INVERSE"]="VIEW_INVERSE",t[t.PROJECTION_INVERSE="PROJECTION_INVERSE"]="PROJECTION_INVERSE",t[t.MODEL_VIEW_INVERSE="MODEL_VIEW_INVERSE"]="MODEL_VIEW_INVERSE",t[t.MODEL_VIEW_PROJECTION_INVERSE="MODEL_VIEW_PROJECTION_INVERSE"]="MODEL_VIEW_PROJECTION_INVERSE",t[t.MODEL_INVERSE_TRANSPOSE="MODEL_INVERSE_TRANSPOSE"]="MODEL_INVERSE_TRANSPOSE",t[t.MODEL_VIEW_INVERSE_TRANSPOSE="MODEL_VIEW_INVERSE_TRANSPOSE"]="MODEL_VIEW_INVERSE_TRANSPOSE",t[t.VIEWPORT="VIEWPORT"]="VIEWPORT"}(t.EVariableSemantic||(t.EVariableSemantic={}));t.EVariableSemantic}(wd||(wd={}));var wd;!function(t){!function(t){t[t.ENGINE="ENGINE"]="ENGINE",t[t.CUSTOM="CUSTOM"]="CUSTOM"}(t.EVariableCategory||(t.EVariableCategory={}));t.EVariableCategory}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.a_position={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.a_positionVec2={type:t.EVariableType.FLOAT_2,value:t.EVariableCategory.ENGINE},e.a_currentFramePosition={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.a_nextFramePosition={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.a_normal={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.a_currentFrameNormal={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.a_nextFrameNormal={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.a_color={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.a_texCoord={type:t.EVariableType.FLOAT_2,value:t.EVariableCategory.ENGINE},e.a_tangent={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.u_mMatrix={type:t.EVariableType.FLOAT_MAT4,value:t.EVariableCategory.ENGINE},e.u_vMatrix={type:t.EVariableType.FLOAT_MAT4,value:t.EVariableCategory.ENGINE},e.u_pMatrix={type:t.EVariableType.FLOAT_MAT4,value:t.EVariableCategory.ENGINE},e.u_normalMatrix={type:t.EVariableType.FLOAT_MAT3,value:t.EVariableCategory.ENGINE},e.u_samplerCube0={type:t.EVariableType.SAMPLER_CUBE,value:t.EVariableCategory.ENGINE},e.u_sampler2D0={type:t.EVariableType.SAMPLER_2D,value:t.EVariableCategory.ENGINE},e.u_sampler2D1={type:t.EVariableType.SAMPLER_2D,value:t.EVariableCategory.ENGINE},e.u_lightMapSampler={type:t.EVariableType.SAMPLER_2D,value:t.EVariableCategory.ENGINE},e.u_diffuseMapSampler={type:t.EVariableType.SAMPLER_2D,value:t.EVariableCategory.ENGINE},e.u_specularMapSampler={type:t.EVariableType.SAMPLER_2D,value:t.EVariableCategory.ENGINE},e.u_emissionMapSampler={type:t.EVariableType.SAMPLER_2D,value:t.EVariableCategory.ENGINE},e.u_normalMapSampler={type:t.EVariableType.SAMPLER_2D,value:t.EVariableCategory.ENGINE},e.u_reflectionMapSampler={type:t.EVariableType.SAMPLER_2D,value:t.EVariableCategory.ENGINE},e.u_refractionMapSampler={type:t.EVariableType.SAMPLER_2D,value:t.EVariableCategory.ENGINE},e.u_cameraPos={type:t.EVariableType.VECTOR_3,value:t.EVariableCategory.ENGINE},e.u_refractionRatio={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_reflectivity={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_map0SourceRegion={type:t.EVariableType.VECTOR_4,value:t.EVariableCategory.ENGINE},e.u_map1SourceRegion={type:t.EVariableType.VECTOR_4,value:t.EVariableCategory.ENGINE},e.u_diffuseSourceRegion={type:t.EVariableType.VECTOR_4,value:t.EVariableCategory.ENGINE},e.u_map0RepeatRegion={type:t.EVariableType.VECTOR_4,value:t.EVariableCategory.ENGINE},e.u_map1RepeatRegion={type:t.EVariableType.VECTOR_4,value:t.EVariableCategory.ENGINE},e.u_diffuseRepeatRegion={type:t.EVariableType.VECTOR_4,value:t.EVariableCategory.ENGINE},e.u_combineMode={type:t.EVariableType.NUMBER_1,value:t.EVariableCategory.ENGINE},e.u_mixRatio={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_lightMapIntensity={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_diffuse={type:t.EVariableType.VECTOR_4,value:t.EVariableCategory.ENGINE},e.u_specular={type:t.EVariableType.VECTOR_4,value:t.EVariableCategory.ENGINE},e.u_emission={type:t.EVariableType.VECTOR_4,value:t.EVariableCategory.ENGINE},e.u_shininess={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_lightModel={type:t.EVariableType.NUMBER_1,value:t.EVariableCategory.ENGINE},e.u_isBothSide={type:t.EVariableType.NUMBER_1,value:t.EVariableCategory.ENGINE},e.u_opacity={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_ambient={type:t.EVariableType.VECTOR_4,value:t.EVariableCategory.ENGINE},e.u_directionLights={type:t.EVariableType.STRUCTURES,value:t.EVariableCategory.ENGINE},e.u_pointLights={type:t.EVariableType.STRUCTURES,value:t.EVariableCategory.ENGINE},e.u_vpMatrixFromLight={type:t.EVariableType.FLOAT_MAT4,value:t.EVariableCategory.ENGINE},e.u_lightPos={type:t.EVariableType.VECTOR_3,value:t.EVariableCategory.ENGINE},e.u_farPlane={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_interpolation={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_tilesHeightNumber={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_tilesWidthNumber={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_amplitude={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_jointColor={type:t.EVariableType.VECTOR_3,value:t.EVariableCategory.ENGINE},e.u_time={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_speed={type:t.EVariableType.VECTOR_2,value:t.EVariableCategory.ENGINE},e.u_shift={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_alphaThreshold={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_fireColor={type:t.EVariableType.STRUCTURE,value:t.EVariableCategory.ENGINE},e.u_layerHeightDatas={type:t.EVariableType.STRUCTURES,value:t.EVariableCategory.ENGINE},e.u_layerSampler2Ds={type:t.EVariableType.SAMPLER_ARRAY,value:t.EVariableCategory.ENGINE},e.u_herb1Color={type:t.EVariableType.VECTOR_3,value:t.EVariableCategory.ENGINE},e.u_herb2Color={type:t.EVariableType.VECTOR_3,value:t.EVariableCategory.ENGINE},e.u_herb3Color={type:t.EVariableType.VECTOR_3,value:t.EVariableCategory.ENGINE},e.u_groundColor={type:t.EVariableType.VECTOR_3,value:t.EVariableCategory.ENGINE},e.u_ampScale={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_woodColor={type:t.EVariableType.VECTOR_3,value:t.EVariableCategory.ENGINE},e.u_roadColor={type:t.EVariableType.VECTOR_3,value:t.EVariableCategory.ENGINE},e.u_skyColor={type:t.EVariableType.VECTOR_4,value:t.EVariableCategory.ENGINE},e.u_cloudColor={type:t.EVariableType.VECTOR_4,value:t.EVariableCategory.ENGINE},e.u_brickColor={type:t.EVariableType.VECTOR_3,value:t.EVariableCategory.ENGINE},e.u_waveData={type:t.EVariableType.STRUCTURE,value:t.EVariableCategory.ENGINE},e.u_windMatrix={type:t.EVariableType.FLOAT_MAT4,value:t.EVariableCategory.ENGINE},e.u_bumpMapSampler={type:t.EVariableType.SAMPLER_2D,value:t.EVariableCategory.ENGINE},e.u_levelData={type:t.EVariableType.STRUCTURE,value:t.EVariableCategory.ENGINE},e.a_mVec4_0={type:t.EVariableType.FLOAT_4,value:t.EVariableCategory.ENGINE},e.a_mVec4_1={type:t.EVariableType.FLOAT_4,value:t.EVariableCategory.ENGINE},e.a_mVec4_2={type:t.EVariableType.FLOAT_4,value:t.EVariableCategory.ENGINE},e.a_mVec4_3={type:t.EVariableType.FLOAT_4,value:t.EVariableCategory.ENGINE},e.a_normalVec4_0={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.a_normalVec4_1={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.a_normalVec4_2={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.u_isRenderListEmpty={type:t.EVariableType.NUMBER_1,value:t.EVariableCategory.ENGINE},e.u_isReflectionRenderListEmpty={type:t.EVariableType.NUMBER_1,value:t.EVariableCategory.ENGINE},e.u_isRefractionRenderListEmpty={type:t.EVariableType.NUMBER_1,value:t.EVariableCategory.ENGINE},e}();t.VariableLib=e}(wd||(wd={}));var wd;!function(t){var e=wdCb.Hash.create();e.addChild(t.EVariableType.FLOAT_1,"float"),e.addChild(t.EVariableType.FLOAT_2,"vec2"),e.addChild(t.EVariableType.FLOAT_3,"vec3"),e.addChild(t.EVariableType.FLOAT_4,"vec4"),e.addChild(t.EVariableType.VECTOR_2,"vec2"),e.addChild(t.EVariableType.VECTOR_3,"vec3"),e.addChild(t.EVariableType.VECTOR_4,"vec4"),e.addChild(t.EVariableType.FLOAT_MAT3,"mat3"),e.addChild(t.EVariableType.FLOAT_MAT4,"mat4"),e.addChild(t.EVariableType.NUMBER_1,"int"),e.addChild(t.EVariableType.SAMPLER_CUBE,"samplerCube"),e.addChild(t.EVariableType.SAMPLER_2D,"sampler2D");var n=function(){function n(){}return n.getVariableType=function(n){var r=e.getChild(n);return t.Log.error(void 0===r,t.Log.info.FUNC_NOT_EXIST(n,"in VariableTypeTable")),r},n}();t.VariableTypeTable=n}(wd||(wd={}));var wd;!function(t){var e=wdCb.Hash.create();e.addChild("lightMap","u_lightMapSampler"),e.addChild("diffuseMap","u_diffuseMapSampler"),e.addChild("specularMap","u_specularMapSampler"),e.addChild("emissionMap","u_emissionMapSampler"),e.addChild("normalMap","u_normalMapSampler"),e.addChild("reflectionMap","u_reflectionMapSampler"),e.addChild("refractionMap","u_refractionMapSampler"),e.addChild("bumpMap","u_bumpMapSampler");var n=function(){function n(){}return n.getVariableName=function(n){var r=e.getChild(n);return t.Log.error(void 0===r,t.Log.info.FUNC_NOT_EXIST(n,"in VariableNameTable")),r},n}();t.VariableNameTable=n}(wd||(wd={}));var wd;!function(t){t.POINT_LIGHT_GLSLDATA_STRUCTURE_MEMBER_NAME=[{position:"u_pointLights[0].position",color:"u_pointLights[0].color",intensity:"u_pointLights[0].intensity",constant:"u_pointLights[0].constant",linear:"u_pointLights[0].linear",quadratic:"u_pointLights[0].quadratic",range:"u_pointLights[0].range"},{position:"u_pointLights[1].position",color:"u_pointLights[1].color",intensity:"u_pointLights[1].intensity",constant:"u_pointLights[1].constant",linear:"u_pointLights[1].linear",quadratic:"u_pointLights[1].quadratic",range:"u_pointLights[1].range"},{position:"u_pointLights[2].position",color:"u_pointLights[2].color",intensity:"u_pointLights[2].intensity",constant:"u_pointLights[2].constant",linear:"u_pointLights[2].linear",quadratic:"u_pointLights[2].quadratic",range:"u_pointLights[2].range"},{position:"u_pointLights[3].position",color:"u_pointLights[3].color",intensity:"u_pointLights[3].intensity",constant:"u_pointLights[3].constant",linear:"u_pointLights[3].linear",quadratic:"u_pointLights[3].quadratic",range:"u_pointLights[3].range"}],t.DIRECTION_LIGHT_GLSLDATA_STRUCTURE_MEMBER_NAME=[{position:"u_directionLights[0].position",color:"u_directionLights[0].color",intensity:"u_directionLights[0].intensity"},{position:"u_directionLights[1].position",color:"u_directionLights[1].color",intensity:"u_directionLights[1].intensity"},{position:"u_directionLights[2].position",color:"u_directionLights[2].color",intensity:"u_directionLights[2].intensity"},{position:"u_directionLights[3].position",color:"u_directionLights[3].color",intensity:"u_directionLights[3].intensity"}]}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.shader=null}return e.prototype.sendShaderVariables=function(t,e,n){},e.prototype.init=function(){},e.prototype.dispose=function(){},__decorate([t.virtual],e.prototype,"sendShaderVariables",null),
__decorate([t.virtual],e.prototype,"init",null),__decorate([t.virtual],e.prototype,"dispose",null),e}();t.ShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(e,n,r){var i=this.shader;i.attributes.forEach(function(r,i){t.CustomShaderLibUtils.sendAttributeBufferWithSemantic(i,r.type,r.value,e,n)}),i.uniforms.forEach(function(r,i){r.type!==t.EVariableType.SAMPLER_2D&&t.CustomShaderLibUtils.sendUniformDataWithSemantic(i,r.type,r.value,e,n)})},n}(t.ShaderLib);t.CustomShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.type=null,this.attributes=wdCb.Hash.create(),this.uniforms=wdCb.Hash.create(),this.vsSourceTop="",this.vsSourceDefine="",this.vsSourceVarDeclare="",this.vsSourceFuncDeclare="",this.vsSourceFuncDefine="",this.vsSourceBody="",this.vsSource=null,this.fsSourceTop="",this.fsSourceDefine="",this.fsSourceVarDeclare="",this.fsSourceFuncDeclare="",this.fsSourceFuncDefine="",this.fsSourceBody="",this.fsSource=null,this.vsSourceDefineList=wdCb.Collection.create(),this.fsSourceDefineList=wdCb.Collection.create()}return __extends(r,e),r.prototype.setShaderDefinition=function(t,e){var n=null,r=null;this._clearShaderDefinition(),n=this.getVsChunk(),r=this.getFsChunk(),n&&this.setVsSource(n),r&&this.setFsSource(r)},r.prototype.sendAttributeBuffer=function(e,n,r){e.sendAttributeBuffer(n,t.EVariableType.BUFFER,r)},r.prototype.sendUniformData=function(e,n,r){e.sendUniformData(n,t.VariableLib[n].type,r)},r.prototype.getVsChunk=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=0===t.length?this.type:t[0];return this._getChunk(r,n.vs)},r.prototype.getFsChunk=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=0===t.length?this.type:t[0];return this._getChunk(r,n.fs)},r.prototype.setVsSource=function(e,r){void 0===r&&(r="="),t.JudgeUtils.isString(e)?this.vsSource=e:this._setSource(e,n.vs,r)},r.prototype.setFsSource=function(e,r){void 0===r&&(r="="),t.JudgeUtils.isString(e)?this.fsSource=e:this._setSource(e,n.fs,r)},r.prototype.addAttributeVariable=function(t){this._addVariable(this.attributes,t)},r.prototype.addUniformVariable=function(t){this._addVariable(this.uniforms,t)},r.prototype._addVariable=function(e,n){n.forEach(function(n){t.Log.assert(t.VariableLib[n],t.Log.info.FUNC_SHOULD(n,"exist in VariableLib")),e.addChild(n,t.VariableLib[n])})},r.prototype._clearShaderDefinition=function(){this.attributes.removeAllChildren(),this.uniforms.removeAllChildren(),this.vsSourceDefineList.removeAllChildren(),this.fsSourceDefineList.removeAllChildren(),this.vsSourceTop="",this.vsSourceDefine="",this.vsSourceVarDeclare="",this.vsSourceFuncDeclare="",this.vsSourceFuncDefine="",this.vsSourceBody="",this.vsSource=null,this.fsSourceTop="",this.fsSourceDefine="",this.fsSourceVarDeclare="",this.fsSourceFuncDeclare="",this.fsSourceFuncDefine="",this.fsSourceBody="",this.fsSource=null},r.prototype._getChunk=function(e,r){var i=null;return e?(i=e.indexOf(".glsl")>-1?""+wdCb.PathUtils.basename(e,".glsl"):r===n.vs?e+"_vertex":e+"_fragment",t.ShaderChunk[i]?t.ShaderChunk[i]:t.ShaderChunk.empty):null},r.prototype._setSource=function(e,n,r){if(e)switch(r){case"+":this[n+"SourceTop"]+=e.top,this[n+"SourceDefine"]+=e.define,this[n+"SourceVarDeclare"]+=e.varDeclare,this[n+"SourceFuncDeclare"]+=e.funcDeclare,this[n+"SourceFuncDefine"]+=e.funcDefine,this[n+"SourceBody"]+=e.body;break;case"=":this[n+"SourceTop"]=e.top,this[n+"SourceDefine"]=e.define,this[n+"SourceVarDeclare"]=e.varDeclare,this[n+"SourceFuncDeclare"]=e.funcDeclare,this[n+"SourceFuncDefine"]=e.funcDefine,this[n+"SourceBody"]=e.body;break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("opertor:",r))}},__decorate([t.virtual],r.prototype,"setShaderDefinition",null),__decorate([t.require(function(e,n,r){t.assert(!!t.VariableLib[n],n+" should exist in VariableLib")})],r.prototype,"sendUniformData",null),__decorate([t.require(function(){t.assert(null===this.vsSource,t.Log.info.FUNC_SHOULD("vsSource","be null"))})],r.prototype,"setVsSource",null),__decorate([t.require(function(){t.assert(null===this.fsSource,t.Log.info.FUNC_SHOULD("fsSource","be null"))})],r.prototype,"setFsSource",null),r}(t.ShaderLib);t.EngineShaderLib=e;var n;!function(t){t[t.vs="vs"]="vs",t[t.fs="fs"]="fs"}(n||(n={}))}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="common"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(t,e,n){this.sendUniformData(t,"u_vMatrix",e.vMatrix),this.sendUniformData(t,"u_pMatrix",e.pMatrix)},n.prototype.setShaderDefinition=function(n,r){e.prototype.setShaderDefinition.call(this,n,r),this.addUniformVariable(["u_vMatrix","u_pMatrix"]),this.vsSourceDefine=t.ShaderChunk.common_define.define+t.ShaderChunk.common_vertex.define,this.vsSourceFuncDefine=t.ShaderChunk.common_function.funcDefine+t.ShaderChunk.common_vertex.funcDefine,this.fsSourceDefine=t.ShaderChunk.common_define.define+t.ShaderChunk.common_fragment.define,this.fsSourceFuncDefine=t.ShaderChunk.common_function.funcDefine+t.ShaderChunk.common_fragment.funcDefine},n}(t.EngineShaderLib);t.CommonShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="end"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){t.sendAllBufferData(e.vaoManager)},e}(t.EngineShaderLib);t.EndShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="vertice_common"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(t,e,n){this._sendAttributeVariables(t,e)},n.prototype.setShaderDefinition=function(t,n){e.prototype.setShaderDefinition.call(this,t,n),this.addAttributeVariable(["a_position"])},n.prototype._sendAttributeVariables=function(e,n){var r=n.buffers.getChild(t.EBufferDataType.VERTICE);r&&this.sendAttributeBuffer(e,"a_position",r)},n}(t.EngineShaderLib);t.VerticeCommonShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="normal_common"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(t,e,n){this._sendAttributeVariables(t,e)},n.prototype.setShaderDefinition=function(t,n){e.prototype.setShaderDefinition.call(this,t,n),this.addAttributeVariable(["a_normal"])},n.prototype._sendAttributeVariables=function(e,n){var r=n.buffers.getChild(t.EBufferDataType.NORMAL);r&&this.sendAttributeBuffer(e,"a_normal",r)},n}(t.EngineShaderLib);t.NormalCommonShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="basic"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(e,n,r){var i=n.buffers.getChild(t.EBufferDataType.COLOR);i&&(this.sendAttributeBuffer(e,"a_color",i),this.sendUniformData(e,"u_opacity",r.opacity))},n.prototype.setShaderDefinition=function(n,r){e.prototype.setShaderDefinition.call(this,n,r),this.addAttributeVariable(["a_color"]),this.addUniformVariable(["u_opacity"]),this.vsSourceBody=t.ShaderSnippet.setPos_mvp+t.ShaderChunk.basic_vertex.body},n}(t.EngineShaderLib);t.BasicShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="end_basic"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){},e}(t.EngineShaderLib);t.EndBasicShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="common_morph"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(e,n,r){var i=n.target.getComponent(t.MorphAnimation);this.sendUniformData(e,"u_interpolation",i.interpolation)},n.prototype.setShaderDefinition=function(t,n){e.prototype.setShaderDefinition.call(this,t,n),this.addUniformVariable(["u_interpolation"])},__decorate([t.require(function(e,n,r){t.assert(n.target.hasComponent(t.MorphAnimation),t.Log.info.FUNC_SHOULD("entityObject","has MorphAnimation component"))})],n.prototype,"sendShaderVariables",null),n}(t.EngineShaderLib);t.CommonMorphShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="vertice_morph"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(e,n,r){var i=n.buffers.getChild(t.EBufferDataType.VERTICE);i&&(this.sendAttributeBuffer(e,"a_currentFramePosition",i[0]),this.sendAttributeBuffer(e,"a_nextFramePosition",i[1]))},n.prototype.setShaderDefinition=function(t,n){e.prototype.setShaderDefinition.call(this,t,n),this.addAttributeVariable(["a_currentFramePosition","a_nextFramePosition"])},__decorate([t.require(function(e,n,r){t.assert(n.target.hasComponent(t.MorphAnimation),t.Log.info.FUNC_SHOULD("entityObject","has MorphAnimation component"))})],n.prototype,"sendShaderVariables",null),n}(t.EngineShaderLib);t.VerticeMorphShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="normal_morph"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(e,n,r){var i=n.buffers.getChild(t.EBufferDataType.NORMAL);i&&(this.sendAttributeBuffer(e,"a_currentFrameNormal",i[0]),this.sendAttributeBuffer(e,"a_nextFrameNormal",i[1]))},n.prototype.setShaderDefinition=function(t,n){e.prototype.setShaderDefinition.call(this,t,n),this.addAttributeVariable(["a_currentFrameNormal","a_nextFrameNormal"])},n}(t.EngineShaderLib);t.NormalMorphShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="skybox"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.addUniformVariable(["u_samplerCube0"])},e}(t.EngineShaderLib);t.SkyboxShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.addUniformVariable(["u_samplerCube0"]),this.vsSourceBody=this.getVsChunk().body},e}(t.EngineShaderLib);t.EnvMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="common_envMap"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(e,n,r){t.RenderTargerRendererShaderLibUtils.judgeAndSendIsRenderListEmptyVariable(e,t.EShaderGLSLData.DYNAMIC_CUBEMAP)},n.prototype.setShaderDefinition=function(t,n){e.prototype.setShaderDefinition.call(this,t,n),this.addUniformVariable(["u_isRenderListEmpty"])},n}(t.EnvMapShaderLib);t.CommonEnvMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.prototype.sendShaderVariables=function(n,r,i){e.prototype.sendShaderVariables.call(this,n,r,i),this.sendUniformData(n,"u_cameraPos",t.Director.getInstance().scene.currentCamera.transform.position)},n.prototype.setShaderDefinition=function(t,n){e.prototype.setShaderDefinition.call(this,t,n),this.addUniformVariable(["u_cameraPos"])},n.prototype.setEnvMapSource=function(){var t=this.getVsChunk("forBasic_envMap"),e=this.getFsChunk("forBasic_envMap");this.vsSourceTop=t.top,this.vsSourceDefine=t.define,this.vsSourceVarDeclare=t.varDeclare,this.vsSourceFuncDeclare=t.funcDeclare,this.vsSourceFuncDefine=t.funcDefine,this.vsSourceBody+=t.body,this.setFsSource(e)},n}(t.EnvMapShaderLib);t.ForBasicEnvMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="basic_forBasic_envMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e}(t.ForBasicEnvMapShaderLib);t.BasicForBasicEnvMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="reflection_forBasic_envMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},e}(t.ForBasicEnvMapShaderLib);t.ReflectionForBasicEnvMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="refraction_forBasic_envMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(e,n,r){t.prototype.sendShaderVariables.call(this,e,n,r),this.sendUniformData(e,"u_refractionRatio",r.refractionRatio)},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.addUniformVariable(["u_refractionRatio"]),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},e}(t.ForBasicEnvMapShaderLib);t.RefractionForBasicEnvMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="fresnel_forBasic_envMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(e,n,r){t.prototype.sendShaderVariables.call(this,e,n,r),this.sendUniformData(e,"u_refractionRatio",r.refractionRatio),this.sendUniformData(e,"u_reflectivity",r.reflectivity)},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.addUniformVariable(["u_refractionRatio","u_reflectivity"]),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},e}(t.ForBasicEnvMapShaderLib);t.FresnelForBasicEnvMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.setEnvMapSource=function(){var t=this.getVsChunk("forLight_envMap"),e=this.getFsChunk("forLight_envMap");this.vsSourceTop=t.top,this.vsSourceDefine=t.define,this.vsSourceVarDeclare=t.varDeclare,this.vsSourceFuncDeclare=t.funcDeclare,this.vsSourceFuncDefine=t.funcDefine,this.vsSourceBody+=t.body,this.setFsSource(e)},e}(t.EnvMapShaderLib);t.ForLightEnvMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="basic_forLight_envMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e}(t.ForLightEnvMapShaderLib);t.BasicForLightEnvMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="reflection_forLight_envMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},e}(t.ForLightEnvMapShaderLib);t.ReflectionForLightEnvMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="refraction_forLight_envMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(e,n,r){t.prototype.sendShaderVariables.call(this,e,n,r),this.sendUniformData(e,"u_refractionRatio",r.refractionRatio)},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.addUniformVariable(["u_refractionRatio"]),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},e}(t.ForLightEnvMapShaderLib);t.RefractionForLightEnvMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="fresnel_forLight_envMap"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(n,r,i){e.prototype.sendShaderVariables.call(this,n,r,i),null!==i.reflectivity?this.sendUniformData(n,"u_reflectivity",i.reflectivity):(this.sendUniformData(n,"u_reflectivity",t.ShaderChunk.NULL),this.sendUniformData(n,"u_refractionRatio",i.refractionRatio))},n.prototype.setShaderDefinition=function(t,n){e.prototype.setShaderDefinition.call(this,t,n),this.addUniformVariable(["u_refractionRatio","u_reflectivity"]),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},n}(t.ForLightEnvMapShaderLib);t.FresnelForLightEnvMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.prototype.sendShaderVariables=function(e,n,r){var i=n.buffers.getChild(t.EBufferDataType.TEXCOORD),o=null,a=null;i&&(this.sendAttributeBuffer(e,"a_texCoord",i),o=r.mapList,a=o.getChild(0),this.sendUniformData(e,"u_map0SourceRegion",a.sourceRegionForGLSL),this.sendUniformData(e,"u_map0RepeatRegion",a.repeatRegion),this.sendMapShaderVariables(e,n,r))},n.prototype.setShaderDefinition=function(t,n){e.prototype.setShaderDefinition.call(this,t,n),this.addAttributeVariable(["a_texCoord"]),this.addUniformVariable(["u_sampler2D0","u_map0SourceRegion","u_map0RepeatRegion"]),this._setMapSource()},n.prototype.sendMapShaderVariables=function(t,e,n){},n.prototype._setMapSource=function(){var t=this.getVsChunk("map_forBasic"),e=this.getFsChunk("map_forBasic");this.vsSourceTop=t.top,this.vsSourceDefine=t.define,this.vsSourceVarDeclare=t.varDeclare,this.vsSourceFuncDeclare=t.funcDeclare,this.vsSourceFuncDefine=t.funcDefine,this.vsSourceBody=t.body,this.setFsSource(e)},__decorate([t.virtual],n.prototype,"sendMapShaderVariables",null),n}(t.EngineShaderLib);t.MapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="map_forBasic"}return __extends(e,t),e.create=function(){var t=new this;return t},e}(t.MapShaderLib);t.BasicMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="multi_map_forBasic"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendMapShaderVariables=function(t,e,n){var r=n.mapList,i=r.getChild(1);this.sendUniformData(t,"u_combineMode",n.mapCombineMode),this.sendUniformData(t,"u_mixRatio",n.mapMixRatio),this.sendUniformData(t,"u_map1SourceRegion",i.sourceRegionForGLSL),this.sendUniformData(t,"u_map1RepeatRegion",i.repeatRegion)},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.addUniformVariable(["u_sampler2D1","u_combineMode","u_mixRatio","u_map1SourceRegion","u_map1RepeatRegion"]),this.vsSourceVarDeclare+=this.getVsChunk().varDeclare,this.vsSourceBody+=this.getVsChunk().body,this.fsSourceVarDeclare=this.getFsChunk().varDeclare,this.fsSourceFuncDefine=this.getFsChunk().funcDefine,this.fsSourceBody=this.getFsChunk().body},e}(t.MapShaderLib);t.MultiMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="lightCommon"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.setVsSource(this.getVsChunk("light_common.glsl")),this.setVsSource(this.getVsChunk(),"+"),this.setFsSource(this.getFsChunk("light_common.glsl")),this.setFsSource(this.getFsChunk(),"+")},e}(t.EngineShaderLib);t.LightCommonShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="light"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(e,n,r){this.sendUniformData(e,"u_cameraPos",t.Director.getInstance().scene.currentCamera.transform.position),this.sendUniformData(e,"u_shininess",r.shininess),this.sendUniformData(e,"u_opacity",r.opacity),this.sendUniformData(e,"u_lightModel",this._convertLightModelToGLSLVariable(r.lightModel)),this._sendLightVariables(e)},n.prototype.setShaderDefinition=function(t,n){e.prototype.setShaderDefinition.call(this,t,n),this.addUniformVariable(["u_normalMatrix","u_cameraPos","u_shininess","u_ambient","u_opacity","u_isBothSide","u_lightModel"]),this._setLightDefinition(n)},n.prototype._sendLightVariables=function(e){var n=t.Director.getInstance().scene,r=n.directionLights,i=n.ambientLight,o=n.pointLights;i&&this.sendUniformData(e,"u_ambient",i.getComponent(t.AmbientLight).color.toVector4()),o&&this._sendPointLightVariables(e,o),r&&this._sendDirectionLightVariables(e,r)},n.prototype._sendPointLightVariables=function(e,n){n.forEach(function(n,r){var i=n.getComponent(t.PointLight),o=t.POINT_LIGHT_GLSLDATA_STRUCTURE_MEMBER_NAME[r];e.sendVector3(o.position,i.position),e.sendColor4(o.color,i.color),e.sendFloat1(o.intensity,i.intensity),e.sendFloat1(o.constant,i.constant),e.sendFloat1(o.linear,i.linear),e.sendFloat1(o.quadratic,i.quadratic),null!==i.range?e.sendFloat1(o.range,i.range):e.sendFloat1(o.range,t.ShaderChunk.NULL)})},n.prototype._sendDirectionLightVariables=function(e,n){var r=this;n.forEach(function(n,i){var o=n.getComponent(t.DirectionLight),a=t.DIRECTION_LIGHT_GLSLDATA_STRUCTURE_MEMBER_NAME[i];r._isZero(o.position)?e.sendVector3(a.position,t.DirectionLight.defaultPosition):e.sendVector3(a.position,o.position),e.sendColor4(a.color,o.color),e.sendFloat1(a.intensity,o.intensity)})},n.prototype._isZero=function(t){var e=t.values;return 0===e[0]&&0===e[1]&&0===e[2]},n.prototype._setLightDefinition=function(e){var n=t.Director.getInstance().scene,r=n.directionLights,i=n.pointLights,o=0,a=0;r&&(this.addUniformVariable(["u_directionLights"]),o=r.getCount()),i&&(this.addUniformVariable(["u_pointLights"]),a=i.getCount()),this._addDefine(this.vsSourceDefineList,o,a),this._addDefine(this.fsSourceDefineList,o,a),e.side===t.ESide.BOTH&&this.fsSourceDefineList.addChildren([{name:"BOTH_SIDE"}])},n.prototype._addDefine=function(t,e,n){t.addChildren([{name:"DIRECTION_LIGHTS_COUNT",value:e},{name:"POINT_LIGHTS_COUNT",value:n}])},n.prototype._convertLightModelToGLSLVariable=function(e){switch(e){case t.ELightModel.BLINN:return 1;case t.ELightModel.PHONG:return 2;case t.ELightModel.CONSTANT:return 3;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("lightModel:"+e))}},__decorate([t.require(function(e){t.assert(e!==t.ELightModel.LAMBERT,t.Log.info.FUNC_SHOULD_NOT("lightModel","=== ELightModel.LAMBERT"))})],n.prototype,"_convertLightModelToGLSLVariable",null),n}(t.EngineShaderLib);t.LightShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="lightEnd"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){},e}(t.EngineShaderLib);t.LightEndShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.sendShaderVariables=function(t,e,n){},e}(t.EngineShaderLib);t.BaseLightMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(e,n,r){var i=n.buffers.getChild(t.EBufferDataType.TEXCOORD);i&&this.sendAttributeBuffer(e,"a_texCoord",i)},n.prototype.setShaderDefinition=function(t,n){e.prototype.setShaderDefinition.call(this,t,n),this.addAttributeVariable(["a_texCoord"])},n}(t.EngineShaderLib);t.CommonLightMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="lightMap"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(t,e,n){this.sendUniformData(t,"u_lightMapIntensity",n.lightMapIntensity)},n.prototype.setShaderDefinition=function(n,r){e.prototype.setShaderDefinition.call(this,n,r),this.addUniformVariable([t.VariableNameTable.getVariableName("lightMap"),"u_lightMapIntensity"])},n}(t.BaseLightMapShaderLib);t.LightMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="diffuseMap"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(t,e,n){var r=n.diffuseMap;return this.sendUniformData(t,"u_diffuseSourceRegion",r.sourceRegionForGLSL),this.sendUniformData(t,"u_diffuseRepeatRegion",r.repeatRegion),this},n.prototype.setShaderDefinition=function(n,r){e.prototype.setShaderDefinition.call(this,n,r),this.addUniformVariable([t.VariableNameTable.getVariableName("diffuseMap"),"u_diffuseSourceRegion","u_diffuseRepeatRegion"])},__decorate([t.require(function(e,n,r){var i=r.diffuseMap;t.assert(!!i,t.Log.info.FUNC_MUST_DEFINE("diffuseMap")),t.assert(!!i.sourceRegionForGLSL&&!!i.repeatRegion,t.Log.info.FUNC_SHOULD("material.diffuseMap","has sourceRegionForGLSL,repeatRegion data"))})],n.prototype,"sendShaderVariables",null),n}(t.BaseLightMapShaderLib);t.DiffuseMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="specularMap"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.setShaderDefinition=function(n,r){e.prototype.setShaderDefinition.call(this,n,r),this.addUniformVariable([t.VariableNameTable.getVariableName("specularMap")])},n}(t.BaseLightMapShaderLib);t.SpecularMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="emissionMap"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.setShaderDefinition=function(n,r){e.prototype.setShaderDefinition.call(this,n,r),this.addUniformVariable([t.VariableNameTable.getVariableName("emissionMap")])},n}(t.BaseLightMapShaderLib);t.EmissionMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="normalMap"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(n,r,i){var o=null;e.prototype.sendShaderVariables.call(this,n,r,i),o=r.buffers.getChild(t.EBufferDataType.TANGENT),o&&this.sendAttributeBuffer(n,"a_tangent",o)},n.prototype.setShaderDefinition=function(n,r){e.prototype.setShaderDefinition.call(this,n,r),this.addAttributeVariable(["a_tangent"]),this.addUniformVariable([t.VariableNameTable.getVariableName("normalMap")])},n}(t.BaseLightMapShaderLib);t.NormalMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="noLightMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){},e}(t.EngineShaderLib);t.NoLightMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="noDiffuseMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){this.sendUniformData(t,"u_diffuse",n.color.toVector4())},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.addUniformVariable(["u_diffuse"])},e}(t.EngineShaderLib);t.NoDiffuseMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="noSpecularMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){this.sendUniformData(t,"u_specular",n.specularColor.toVector4())},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.addUniformVariable(["u_specular"])},e}(t.EngineShaderLib);t.NoSpecularMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="noEmissionMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){this.sendUniformData(t,"u_emission",n.emissionColor.toVector4())},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.addUniformVariable(["u_emission"])},e}(t.EngineShaderLib);t.NoEmissionMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="noNormalMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){},e}(t.EngineShaderLib);t.NoNormalMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.setFsSource(this.getFsChunk("commonBuildShadowMap_fragment.glsl")),this.setFsSource(this.getFsChunk(),"+")},e}(t.EngineShaderLib);t.BuildShadowMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="buildTwoDShadowMap"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(t,e,n){t.sendMatrix4("u_vpMatrixFromLight",e.vMatrix.applyMatrix(e.pMatrix,!0))},n.prototype.setShaderDefinition=function(n,r){var i=null;e.prototype.setShaderDefinition.call(this,n,r),this.addUniformVariable(["u_vpMatrixFromLight"]),i=t.GPUDetector.getInstance().extensionDepthTexture?this.getFsChunk("buildTwoDShadowMap_depthMap"):this.getFsChunk("buildTwoDShadowMap_packDepth"),this.fsSourceBody=i.body},n}(t.BuildShadowMapShaderLib);t.BuildTwoDShadowMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="buildCubemapShadowMap"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(e,n,r){t.Director.getInstance().scene.glslData.getChild(t.EShaderGLSLData.BUILD_CUBEMAP_SHADOWMAP).forEach(function(t,n){var r=t.light;e.sendVector3("u_lightPos",r.position),e.sendFloat1("u_farPlane",r.shadowCameraFar)})},n.prototype.setShaderDefinition=function(t,n){e.prototype.setShaderDefinition.call(this,t,n),this.addUniformVariable(["u_lightPos","u_farPlane"])},n}(t.BuildShadowMapShaderLib);t.BuildCubemapShadowMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="totalShadowMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){},e}(t.EngineShaderLib);t.TotalShadowMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._softTypeChangeSubscription=null}return __extends(n,e),n.prototype.init=function(){var e=this.shader;this._softTypeChangeSubscription=t.EventManager.fromEvent(t.Director.getInstance().scene.gameObjectScene,t.EEngineEvent.SHADOWMAP_SOFTTYPE_CHANGE).subscribe(function(){e.libDirty=!0})},n.prototype.dispose=function(){this._softTypeChangeSubscription&&this._softTypeChangeSubscription.dispose()},n.prototype.setShaderDefinition=function(t,n){e.prototype.setShaderDefinition.call(this,t,n),this._setShadowMapSource()},n.prototype._setShadowMapSource=function(){var e=t.Director.getInstance().scene,n=e.gameObjectScene.shadowManager,r=n.twoDShadowMapCountForGLSL,i=n.cubemapShadowMapCountForGLSL;e.shadowMap.softType===t.EShadowMapSoftType.PCF&&this.fsSourceDefineList.addChildren([{name:"SHADOWMAP_TYPE_PCF"}]),this.vsSourceDefineList.addChild({name:"TWOD_SHADOWMAP_COUNT",value:r}),this.fsSourceDefineList.addChildren([{name:"TWOD_SHADOWMAP_COUNT",value:r},{name:"CUBEMAP_SHADOWMAP_COUNT",value:i}])},n}(t.EngineShaderLib);t.ShadowMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="twoDShadowMap"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(e,n,r){var i=null;i=t.Director.getInstance().scene.glslData.getChild(t.EShaderGLSLData.TWOD_SHADOWMAP),i&&i.forEach(function(t,n){var r=t.camera,i=t.light;return t.isRenderListEmpty?void e.sendNum1("u_isTwoDRenderListEmpty["+n+"]",1):(e.sendNum1("u_isTwoDRenderListEmpty["+n+"]",0),
e.sendMatrix4("u_vpMatrixFromLight["+n+"]",r.worldToCameraMatrix.applyMatrix(r.pMatrix,!0)),e.sendFloat2("u_twoDShadowSize["+n+"]",[i.shadowMapWidth,i.shadowMapHeight]),e.sendFloat1("u_twoDShadowBias["+n+"]",i.shadowBias),e.sendFloat1("u_twoDShadowDarkness["+n+"]",i.shadowDarkness),void e.sendVector3("u_twoDLightPos["+n+"]",i.position))})},n.prototype.setShaderDefinition=function(n,r){var i=null;e.prototype.setShaderDefinition.call(this,n,r),i=t.GPUDetector.getInstance().extensionDepthTexture?this.getFsChunk("twoDShadowMap_depthMap"):this.getFsChunk("twoDShadowMap_unpackDepth"),this.fsSourceFuncDeclare+=i.funcDeclare,this.fsSourceFuncDefine+=i.funcDefine},n}(t.ShadowMapShaderLib);t.TwoDShadowMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="cubemapShadowMap"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(e,n,r){var i=t.Director.getInstance().scene.glslData.getChild(t.EShaderGLSLData.CUBEMAP_SHADOWMAP);i&&i.forEach(function(t,n){var r=t.light;t.isRenderListEmpty?e.sendNum1("u_isCubemapRenderListEmpty["+n+"]",1):e.sendNum1("u_isCubemapRenderListEmpty["+n+"]",0),e.sendVector3("u_cubemapLightPos["+n+"]",r.position),e.sendFloat1("u_farPlane["+n+"]",r.shadowCameraFar),e.sendFloat1("u_cubemapShadowBias["+n+"]",r.shadowBias),e.sendFloat1("u_cubemapShadowDarkness["+n+"]",r.shadowDarkness)})},n}(t.ShadowMapShaderLib);t.CubemapShadowMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="noShadowMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){},e}(t.EngineShaderLib);t.NoShadowMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.sendUniformData=function(e,n,r,i){n===t.EVariableType.STRUCTURE?this._sendStructureData(e,r,i):i.sendUniformData(e,n,r)},e.sendUniformDataWithSemantic=function(e,n,r,i,o){n===t.EVariableType.STRUCTURE?this._sendStructureDataWithSemantic(e,r,i,o):i.sendUniformData(e,n,this._getUniformData(r,o))},e.sendAttributeBufferWithSemantic=function(t,e,n,r,i){r.sendAttributeBuffer(t,this._getAttributeType(e),this._getAttributeData(n,e,i))},e._sendStructureData=function(t,e,n){for(var r in e)if(e.hasOwnProperty(r)){var i=e[r];n.sendStructureData(t+"."+r,i.type,i.value)}},e._sendStructureDataWithSemantic=function(t,e,n,r){for(var i in e)if(e.hasOwnProperty(i)){var o=e[i];n.sendStructureData(t+"."+i,o.type,this._getUniformData(o.value,r))}},e._getAttributeData=function(e,n,r){switch(e){case t.EVariableSemantic.POSITION:return r.buffers.getChild(t.EBufferDataType.VERTICE);case t.EVariableSemantic.TEXCOORD:return r.buffers.getChild(t.EBufferDataType.TEXCOORD);case t.EVariableSemantic.COLOR:return r.buffers.getChild(t.EBufferDataType.COLOR);case t.EVariableSemantic.NORMAL:return r.buffers.getChild(t.EBufferDataType.NORMAL);case t.EVariableSemantic.TANGENT:return r.buffers.getChild(t.EBufferDataType.TANGENT);default:return e}},e._getAttributeType=function(e){return t.EVariableType.BUFFER},e._getUniformData=function(e,n){switch(e){case t.EVariableSemantic.MODEL:return n.mMatrix;case t.EVariableSemantic.VIEW:return n.vMatrix;case t.EVariableSemantic.PROJECTION:return n.pMatrix;case t.EVariableSemantic.MODEL_VIEW_PROJECTION:return n.mvpMatrix;case t.EVariableSemantic.MODEL_INVERSE:return n.mMatrix.clone().invert();case t.EVariableSemantic.VIEW_INVERSE:return n.vMatrix.clone().invert();case t.EVariableSemantic.PROJECTION_INVERSE:return n.pMatrix.clone().invert();case t.EVariableSemantic.MODEL_VIEW_INVERSE:return n.mMatrix.applyMatrix(n.vMatrix,!0).invert();case t.EVariableSemantic.MODEL_VIEW_PROJECTION_INVERSE:return n.mMatrix.applyMatrix(n.vMatrix,!0).applyMatrix(n.pMatrix,!1).invert();case t.EVariableSemantic.MODEL_INVERSE_TRANSPOSE:return n.normalMatrix;case t.EVariableSemantic.MODEL_VIEW_INVERSE_TRANSPOSE:return n.mMatrix.applyMatrix(n.vMatrix,!0).invertTo3x3().transpose();case t.EVariableSemantic.VIEWPORT:return t.DeviceManager.getInstance().getViewport();default:return e}},__decorate([t.require(function(e,n,r,i){t.assert(n!==t.EVariableType.SAMPLER_2D&&n!==t.EVariableType.SAMPLER_CUBE,t.Log.info.FUNC_SHOULD_NOT("type","be SAMPLER_2D or SAMPLER_CUBE, but actual is "+n)),t.assert(n!==t.EVariableType.STRUCTURES,t.Log.info.FUNC_NOT_SUPPORT("type === STRUCTURES")),n===t.EVariableType.STRUCTURE&&t.assert(t.JudgeUtils.isDirectObject(r),t.Log.info.FUNC_MUST_BE("value","object when type === STRUCTURE"))})],e,"sendUniformData",null),__decorate([t.require(function(e,n,r,i,o){t.assert(n!==t.EVariableType.SAMPLER_2D&&n!==t.EVariableType.SAMPLER_CUBE,t.Log.info.FUNC_SHOULD_NOT("type","be SAMPLER_2D or SAMPLER_CUBE, but actual is "+n)),t.assert(n!==t.EVariableType.STRUCTURES,t.Log.info.FUNC_NOT_SUPPORT("type === STRUCTURES")),n===t.EVariableType.STRUCTURE&&t.assert(t.JudgeUtils.isDirectObject(r),t.Log.info.FUNC_MUST_BE("value","object when type === STRUCTURE"))})],e,"sendUniformDataWithSemantic",null),__decorate([t.require(function(e,n,r){switch(t.assert("INDICE"!==e,t.Log.info.FUNC_NOT_SUPPORT("semantic:INDICE")),e){case"POSITION":case"COLOR":case"NORMAL":case"TANGENT":t.assert(n===t.EVariableType.FLOAT_3,t.Log.info.FUNC_SHOULD("type","be EVariableType.FLOAT_3"));break;case"TEXCOORD":t.assert(n===t.EVariableType.FLOAT_2,t.Log.info.FUNC_SHOULD("type","be EVariableType.FLOAT_2"))}}),t.ensure(function(e){t.assert(e&&e instanceof t.Buffer,t.Log.info.FUNC_SHOULD("attributeData","be Buffer, but actual is "+e))})],e,"_getAttributeData",null),e}();t.CustomShaderLibUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.judgeAndSendIsRenderListEmptyVariable=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null,i=e[0],o=e[1],a=null;r=t.Director.getInstance().scene.glslData.getChild(o),r&&(a=3===e.length?e[2]:"u_isRenderListEmpty",r.isRenderListEmpty?i.sendUniformData(a,t.EVariableType.NUMBER_1,1):i.sendUniformData(a,t.EVariableType.NUMBER_1,0))},e}();t.RenderTargerRendererShaderLibUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(t.EngineShaderLib);t.InstanceShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(t.EngineShaderLib);t.NoInstanceShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(t.InstanceShaderLib);t.ModelMatrixInstanceShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(t.InstanceShaderLib);t.NormalMatrixModelMatrixInstanceShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="modelMatrix_hardware_instance"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.addAttributeVariable(["a_mVec4_0","a_mVec4_1","a_mVec4_2","a_mVec4_3"])},e}(t.ModelMatrixInstanceShaderLib);t.ModelMatrixHardwareInstanceShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="normalMatrix_hardware_instance"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.addAttributeVariable(["a_normalVec4_0","a_normalVec4_1","a_normalVec4_2"])},e}(t.NormalMatrixModelMatrixInstanceShaderLib);t.NormalMatrixHardwareInstanceShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="modelMatrix_batch_instance"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.addUniformVariable(["u_mMatrix"])},e}(t.ModelMatrixInstanceShaderLib);t.ModelMatrixBatchInstanceShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="normalMatrix_batch_instance"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.addUniformVariable(["u_normalMatrix"])},e}(t.NormalMatrixModelMatrixInstanceShaderLib);t.NormalMatrixBatchInstanceShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="modelMatrix_noInstance"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){this.sendUniformData(t,"u_mMatrix",e.mMatrix)},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.addUniformVariable(["u_mMatrix"])},e}(t.NoInstanceShaderLib);t.ModelMatrixNoInstanceShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="normalMatrix_noInstance"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){this.sendUniformData(t,"u_normalMatrix",e.normalMatrix)},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.addUniformVariable(["u_normalMatrix"])},e}(t.NoInstanceShaderLib);t.NormalMatrixNoInstanceShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t.main_begin="void main(void){\n",t.main_end="}\n",t.setPos_mvp="gl_Position = u_pMatrix * u_vMatrix * mMatrix * vec4(a_position, 1.0);\n",t}();t.ShaderSnippet=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._blendType=null,this._blendSrc=t.EBlendFunc.ONE,this._blendDst=t.EBlendFunc.ZERO,this._blendEquation=t.EBlendEquation.ADD,this._color=t.Color.create("#ffffff"),this.redWrite=!0,this.greenWrite=!0,this.blueWrite=!0,this.alphaWrite=!0,this.polygonOffsetMode=t.EPolygonOffsetMode.NONE,this.side=t.ESide.FRONT,this.blend=!1,this.blendFuncSeparate=null,this.blendEquationSeparate=[t.EBlendEquation.ADD,t.EBlendEquation.ADD],this.shading=t.EShading.FLAT,this.geometry=null,this._shaderManager=t.ShaderManager.create(this)}return Object.defineProperty(e.prototype,"program",{get:function(){return this.shader.program},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"blendType",{get:function(){return this._blendType},set:function(e){if(null!==e){switch(e){case t.EBlendType.NONE:this.blend=!1,this.blendSrc=t.EBlendFunc.ONE,this.blendDst=t.EBlendFunc.ZERO,this.blendEquation=t.EBlendEquation.ADD;break;case t.EBlendType.NORMAL:this.blend=!0,this.blendSrc=t.EBlendFunc.SRC_ALPHA,this.blendDst=t.EBlendFunc.ONE_MINUS_SRC_ALPHA,this.blendEquation=t.EBlendEquation.ADD;break;case t.EBlendType.PREMULTIPLIED:this.blend=!0,this.blendSrc=t.EBlendFunc.ONE,this.blendDst=t.EBlendFunc.ONE_MINUS_SRC_ALPHA,this.blendEquation=t.EBlendEquation.ADD;break;case t.EBlendType.ADDITIVE:this.blend=!0,this.blendSrc=t.EBlendFunc.ONE,this.blendDst=t.EBlendFunc.ONE,this.blendEquation=t.EBlendEquation.ADD;break;case t.EBlendType.ADDITIVEALPHA:this.blend=!0,this.blendSrc=t.EBlendFunc.SRC_ALPHA,this.blendDst=t.EBlendFunc.ONE,this.blendEquation=t.EBlendEquation.ADD;break;case t.EBlendType.MULTIPLICATIVE:this.blend=!0,this.blendSrc=t.EBlendFunc.DST_COLOR,this.blendDst=t.EBlendFunc.ZERO,this.blendEquation=t.EBlendEquation.ADD;break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("blendType"))}this._blendType=e}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"envMap",{get:function(){return this.mapManager.getEnvMap()},set:function(t){this.mapManager.setEnvMap(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"blendSrc",{get:function(){return this._blendSrc},set:function(t){this._blendSrc!==t&&(this._blendSrc=t,this.blendFuncSeparate=null)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"blendDst",{get:function(){return this._blendDst},set:function(t){this._blendDst!==t&&(this._blendDst=t,this.blendFuncSeparate=null)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"blendEquation",{get:function(){return this._blendEquation},set:function(t){this._blendEquation!==t&&(this._blendEquation=t,this.blendEquationSeparate=null)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"color",{get:function(){return this._color},set:function(e){this._color.isEqual(e)||(this.geometry&&this.geometry.entityObject&&t.EventManager.trigger(this.geometry.entityObject,t.CustomEvent.create(t.EEngineEvent.MATERIAL_COLOR_CHANGE)),this._color=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"mapManager",{get:function(){return this._shaderManager.mapManager},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"shader",{get:function(){return this._shaderManager.shader},enumerable:!0,configurable:!0}),e.prototype.clone=function(){return t.CloneUtils.clone(this)},e.prototype.initWhenCreate=function(){this._shaderManager.setShader(this.createShader())},e.prototype.init=function(){this._shaderManager.init()},e.prototype.dispose=function(){this._shaderManager.dispose()},e.prototype.updateShader=function(t){this._shaderManager.update(t)},e.prototype.addShader=function(t,e){this._shaderManager.addShader(t,e)},e.prototype.hasShader=function(t){return this._shaderManager.hasShader(t)},e.prototype.getShader=function(t){return this._shaderManager.getShader(t)},e.prototype.hasMap=function(t){return this.mapManager.hasMap(t)},__decorate([t.cloneAttributeAsBasicType({order:1})],e.prototype,"blendType",null),__decorate([t.cloneAttributeAsCloneable()],e.prototype,"envMap",null),__decorate([t.cloneAttributeAsBasicType()],e.prototype,"blendSrc",null),__decorate([t.cloneAttributeAsBasicType()],e.prototype,"blendDst",null),__decorate([t.cloneAttributeAsBasicType()],e.prototype,"blendEquation",null),__decorate([t.cloneAttributeAsCloneable()],e.prototype,"color",null),__decorate([t.cloneAttributeAsBasicType()],e.prototype,"redWrite",void 0),__decorate([t.cloneAttributeAsBasicType()],e.prototype,"greenWrite",void 0),__decorate([t.cloneAttributeAsBasicType()],e.prototype,"blueWrite",void 0),__decorate([t.cloneAttributeAsBasicType()],e.prototype,"alphaWrite",void 0),__decorate([t.cloneAttributeAsBasicType()],e.prototype,"polygonOffsetMode",void 0),__decorate([t.cloneAttributeAsBasicType()],e.prototype,"side",void 0),__decorate([t.cloneAttributeAsBasicType()],e.prototype,"blend",void 0),__decorate([t.cloneAttributeAsBasicType({order:-1})],e.prototype,"blendFuncSeparate",void 0),__decorate([t.cloneAttributeAsBasicType()],e.prototype,"blendEquationSeparate",void 0),__decorate([t.cloneAttributeAsBasicType()],e.prototype,"shading",void 0),__decorate([t.cloneAttributeAsBasicType()],e.prototype,"geometry",void 0),e}();t.Material=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.refractionRatio=0,this.reflectivity=null,this.mapCombineMode=t.ETextureCombineMode.MIX,this.mapMixRatio=.5}return __extends(n,e),n.prototype.init=function(){this._addTopShaderLib(),this.addShaderLib(),this._addEndShaderLib(),e.prototype.init.call(this)},n.prototype.addShaderLib=function(){},n.prototype.addNormalShaderLib=function(){t.GlobalGeometryUtils.hasAnimation(this.geometry)&&!this.shader.hasLib(t.NormalMorphShaderLib)?this._addShaderLibToTop(t.NormalMorphShaderLib.create()):this.shader.hasLib(t.NormalCommonShaderLib)||this._addShaderLibToTop(t.NormalCommonShaderLib.create())},n.prototype.setBlendByOpacity=function(t){1>t&&t>=0?this.blend=!0:this.blend=!1},n.prototype.createShader=function(){return t.CommonShader.create()},n.prototype._addTopShaderLib=function(){this.shader.addLib(t.CommonShaderLib.create()),t.InstanceUtils.addModelMatrixShaderLib(this.shader,this.geometry.entityObject),t.GlobalGeometryUtils.hasAnimation(this.geometry)?(this.shader.addLib(t.CommonMorphShaderLib.create()),this.shader.addLib(t.VerticeMorphShaderLib.create())):this.shader.addLib(t.VerticeCommonShaderLib.create())},n.prototype._addShaderLibToTop=function(t){this.shader.addShaderLibToTop(t)},n.prototype._addEndShaderLib=function(){this.shader.addLib(t.EndShaderLib.create())},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"refractionRatio",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"reflectivity",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"mapCombineMode",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"mapMixRatio",void 0),__decorate([t.virtual],n.prototype,"addShaderLib",null),n}(t.Material);t.EngineMaterial=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._lightMap=null,this._diffuseMap=null,this._specularMap=null,this._emissionMap=null,this._normalMap=null,this._shininess=32,this._opacity=1,this.lightModel=t.ELightModel.PHONG,this.specularColor=t.Color.create("#ffffff"),this.emissionColor=t.Color.create("rgba(0,0,0,0)"),this.lightMapIntensity=1}return __extends(n,e),Object.defineProperty(n.prototype,"lightMap",{get:function(){return this._lightMap},set:function(e){this.mapManager.addMap(e,{samplerVariableName:t.VariableNameTable.getVariableName("lightMap")}),this._lightMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"diffuseMap",{get:function(){return this._diffuseMap},set:function(e){this.mapManager.addMap(e,{samplerVariableName:t.VariableNameTable.getVariableName("diffuseMap")}),this._diffuseMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"specularMap",{get:function(){return this._specularMap},set:function(e){this.mapManager.addMap(e,{samplerVariableName:t.VariableNameTable.getVariableName("specularMap")}),this._specularMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"emissionMap",{get:function(){return this._emissionMap},set:function(e){this.mapManager.addMap(e,{samplerVariableName:t.VariableNameTable.getVariableName("emissionMap")}),this._emissionMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"normalMap",{get:function(){return this._normalMap},set:function(e){this.mapManager.addMap(e,{samplerVariableName:t.VariableNameTable.getVariableName("normalMap")}),this._normalMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"shininess",{get:function(){return Number(this._shininess)<=0?32:this._shininess},set:function(t){this._shininess=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"opacity",{get:function(){return this._opacity},set:function(t){this.setBlendByOpacity(t),this._opacity=t},enumerable:!0,configurable:!0}),n.prototype.getTextureForRenderSort=function(){return this.diffuseMap},n.prototype.addExtendShaderLib=function(){},n.prototype.addShaderLib=function(){var e=null;t.InstanceUtils.addNormalModelMatrixShaderLib(this.shader,this.geometry.entityObject),this.addNormalShaderLib(),this.shader.addLib(t.LightCommonShaderLib.create()),this._setLightMapShaderLib(),this.shader.addLib(t.LightShaderLib.create()),e=this.envMap,e&&this._setEnvMapShaderLib(e),this.addExtendShaderLib(),this.shader.addLib(t.LightEndShaderLib.create())},n.prototype._setLightMapShaderLib=function(){var e=t.Director.getInstance().scene;if(this.shader.addLib(t.CommonLightMapShaderLib.create()),this._lightMap?this.shader.addLib(t.LightMapShaderLib.create()):this.shader.addLib(t.NoLightMapShaderLib.create()),this._diffuseMap?this.shader.addLib(t.DiffuseMapShaderLib.create()):this.shader.addLib(t.NoDiffuseMapShaderLib.create()),this._specularMap?this.shader.addLib(t.SpecularMapShaderLib.create()):this.shader.addLib(t.NoSpecularMapShaderLib.create()),this._emissionMap?this.shader.addLib(t.EmissionMapShaderLib.create()):this.shader.addLib(t.NoEmissionMapShaderLib.create()),this._normalMap?this.shader.addLib(t.NormalMapShaderLib.create()):this.shader.addLib(t.NoNormalMapShaderLib.create()),e.shadowMap.enable){var n=!1,r=!1;this._hasTwoDShadowMap()&&(n=!0,this.shader.addLib(t.TwoDShadowMapShaderLib.create())),this._hasCubemapShadowMap()&&(r=!0,this.shader.addLib(t.CubemapShadowMapShaderLib.create())),n||r?this.shader.addLib(t.TotalShadowMapShaderLib.create()):this.shader.addLib(t.NoShadowMapShaderLib.create())}else this.shader.addLib(t.NoShadowMapShaderLib.create())},n.prototype._setEnvMapShaderLib=function(e){switch(this.shader.addLib(t.CommonEnvMapShaderLib.create()),e.mode){case t.EEnvMapMode.BASIC:this.shader.addLib(t.BasicForLightEnvMapShaderLib.create());break;case t.EEnvMapMode.REFLECTION:this.shader.addLib(t.ReflectionForLightEnvMapShaderLib.create());break;case t.EEnvMapMode.REFRACTION:this.shader.addLib(t.RefractionForLightEnvMapShaderLib.create());break;case t.EEnvMapMode.FRESNEL:this.shader.addLib(t.FresnelForLightEnvMapShaderLib.create());break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("EEnvMapMode"))}},n.prototype._hasTwoDShadowMap=function(){return t.ShadowUtils.isReceive(this.geometry.entityObject)&&this.mapManager.getTwoDShadowMapList().getCount()>0},n.prototype._hasCubemapShadowMap=function(){return t.ShadowUtils.isReceive(this.geometry.entityObject)&&this.mapManager.getCubemapShadowMapList().getCount()>0},__decorate([t.requireSetter(function(e){t.assert(e instanceof t.ImageTexture||e instanceof t.ProceduralTexture,t.Log.info.FUNC_SHOULD("lightMap","be ImageTexture or ProceduralTexture"))}),t.cloneAttributeAsCloneable()],n.prototype,"lightMap",null),__decorate([t.requireSetter(function(e){t.assert(e instanceof t.ImageTexture||e instanceof t.ProceduralTexture,t.Log.info.FUNC_SHOULD("diffuseMap","be ImageTexture or ProceduralTexture"))}),t.cloneAttributeAsCloneable()],n.prototype,"diffuseMap",null),__decorate([t.requireSetter(function(e){t.assert(e instanceof t.ImageTexture||e instanceof t.ProceduralTexture,t.Log.info.FUNC_SHOULD("specularMap","be ImageTexture or ProceduralTexture"))}),t.cloneAttributeAsCloneable()],n.prototype,"specularMap",null),__decorate([t.requireSetter(function(e){t.assert(e instanceof t.ImageTexture||e instanceof t.ProceduralTexture,t.Log.info.FUNC_SHOULD("emissionMap","be ImageTexture or ProceduralTexture"))}),t.cloneAttributeAsCloneable()],n.prototype,"emissionMap",null),__decorate([t.requireSetter(function(e){t.assert(e instanceof t.ImageTexture,t.Log.info.FUNC_SHOULD("normalMap","be ImageTexture"))}),t.cloneAttributeAsCloneable()],n.prototype,"normalMap",null),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"shininess",null),__decorate([t.cloneAttributeAsBasicType({order:1})],n.prototype,"opacity",null),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"lightModel",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"specularColor",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"emissionColor",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"lightMapIntensity",void 0),__decorate([t.virtual],n.prototype,"addExtendShaderLib",null),n}(t.EngineMaterial);t.StandardLightMaterial=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._opacity=1}return __extends(n,e),Object.defineProperty(n.prototype,"mapList",{get:function(){return this.mapManager.getMapList()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"map",{set:function(e){if(e instanceof t.Texture||e instanceof t.TextureAsset)this.mapManager.addMap(e);else for(var n=arguments[0],r=0,i=n;r<i.length;r++){var o=i[r];this.mapManager.addMap(o)}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"opacity",{get:function(){return this._opacity},set:function(t){this.setBlendByOpacity(t),this._opacity=t},enumerable:!0,configurable:!0}),n.prototype.getTextureForRenderSort=function(){return this.mapList.getChild(0)},n.prototype.addShaderLib=function(){var e=null;this.shader.addLib(t.BasicShaderLib.create()),this._setMapShaderLib(),e=this.envMap,e&&(t.InstanceUtils.addNormalModelMatrixShaderLib(this.shader,this.geometry.entityObject),this._setEnvMapShaderLib(e)),this.shader.addLib(t.EndBasicShaderLib.create())},n.prototype._setMapShaderLib=function(){var e=this.mapManager,n=e.getMapCount();n>0&&(n>1?this.shader.addLib(t.MultiMapShaderLib.create()):this.shader.addLib(t.BasicMapShaderLib.create()))},n.prototype._setEnvMapShaderLib=function(e){switch(this.addNormalShaderLib(),this.shader.addLib(t.CommonEnvMapShaderLib.create()),e.mode){case t.EEnvMapMode.BASIC:this.shader.addLib(t.BasicForBasicEnvMapShaderLib.create());break;case t.EEnvMapMode.REFLECTION:this.shader.addLib(t.ReflectionForBasicEnvMapShaderLib.create());break;case t.EEnvMapMode.REFRACTION:this.shader.addLib(t.RefractionForBasicEnvMapShaderLib.create());break;case t.EEnvMapMode.FRESNEL:this.shader.addLib(t.FresnelForBasicEnvMapShaderLib.create());break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("EEnvMapMode"))}},__decorate([t.ensureGetter(function(e){t.assert(e.getCount()<=2,wdCb.Log.info.FUNC_SUPPORT("only","map.count <= 2"))}),t.cloneAttributeAsCustomType(function(t,e,n){t[n].forEach(function(t){e.mapManager.addMap(t.clone())})})],n.prototype,"mapList",null),__decorate([t.requireSetter(function(e){if(e instanceof t.Texture||e instanceof t.TextureAsset);else{var n=e;t.assert(t.JudgeUtils.isArrayExactly(n),t.Log.info.FUNC_MUST_BE("array")),t.assert(n.length<=2,t.Log.info.FUNC_SUPPORT("only","map.count <= 2"))}})],n.prototype,"map",null),__decorate([t.cloneAttributeAsBasicType({order:1})],n.prototype,"opacity",null),n}(t.EngineMaterial);t.StandardBasicMaterial=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t.initWhenCreate(),t},e}(t.StandardBasicMaterial);t.BasicMaterial=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},n.prototype.initWhenCreate=function(){e.prototype.initWhenCreate.call(this),this.side=t.ESide.BACK},n.prototype.getTextureForRenderSort=function(){return null},n.prototype.addShaderLib=function(){this.shader.addLib(t.SkyboxShaderLib.create())},n}(t.EngineMaterial);t.SkyboxMaterial=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t.initWhenCreate(),t},e}(t.StandardLightMaterial);t.LightMaterial=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},n.prototype.init=function(){this.shader.addLib(t.CustomShaderLib.create()),this.shader.addLib(t.EndShaderLib.create()),e.prototype.init.call(this)},n.prototype.getTextureForRenderSort=function(){return null},n.prototype.read=function(e){var n=this;this.shader.read(t.LoaderManager.getInstance().get(e)),this.shader.getSampler2DUniformsAfterRead().forEach(function(e,r){n.mapManager.addMap(t.LoaderManager.getInstance().get(e.textureId),{samplerVariableName:r})})},n.prototype.createShader=function(){return t.CustomShader.create()},__decorate([t.ensure(function(){t.assert(2===this.shader.getLibs().getCount()&&this.shader.hasLib(t.CustomShaderLib),t.Log.info.FUNC_SHOULD("only has CustomShaderLib and EndShaderLib, not has other shader libs"))})],n.prototype,"init",null),n}(t.Material);t.ShaderMaterial=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.FLAT=0]="FLAT",t[t.SMOOTH=1]="SMOOTH"}(t.EShading||(t.EShading={}));t.EShading}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t){this._material=null,this._otherShaderMap=wdCb.Hash.create(),this._mainShader=null,this._material=t}return e.create=function(t){var e=new this(t);return e},Object.defineProperty(e.prototype,"shader",{get:function(){var e=t.Director.getInstance().scene;return e.isUseShader?this._otherShaderMap.getChild(e.currentShaderType):this._mainShader},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"mapManager",{get:function(){return this.shader.mapManager},enumerable:!0,configurable:!0}),e.prototype.setShader=function(t){this._mainShader=t,this._mainShader.mapManager.material=this._material},e.prototype.init=function(){var t=this._material;this._otherShaderMap.forEach(function(e){e.init(t)}),this._mainShader.init(t)},e.prototype.dispose=function(){this._otherShaderMap.forEach(function(t){t.dispose()}),this._mainShader.dispose()},e.prototype.update=function(t){this.shader.update(t,this._material)},e.prototype.addShader=function(t,e){this._otherShaderMap.addChild(t,e)},e.prototype.hasShader=function(t){return this._otherShaderMap.hasChild(t)},e.prototype.getShader=function(t){return this._otherShaderMap.getChild(t)},__decorate([t.ensureGetter(function(e){t.assert(!!e,t.Log.info.FUNC_NOT_EXIST("shader"))})],e.prototype,"shader",null),e}();t.ShaderManager=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.UNKNOW=0]="UNKNOW",t[t.FONT=1]="FONT"}(t.EAssetType||(t.EAssetType={}));t.EAssetType}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._container=wdCb.Hash.create()}return e.prototype.load=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=e[0],i=null,o=this,a=null,s=null;return i=1===e.length?t.JudgeUtils.isArrayExactly(r)?r.join("-"):r:e[1],a=this._container.getChild(i),s=a?wdFrp.just(a):this.loadAsset(r,i)["do"](function(e){o._container.addChild(i,e),t.LoaderManager.getInstance().add(i,o)},function(t){o._errorHandle(r,t)},null)},e.prototype.get=function(t){return this._container.getChild(t)},e.prototype.has=function(t){return this._container.hasChild(t)},e.prototype.dispose=function(){this._container.removeAllChildren()},e.prototype._errorHandle=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null,i=null;r=t.JudgeUtils.isArrayExactly(e[0])?e[0].join(","):e[0],i=e[1],t.Log.log("load "+r+" asset fail:"+i)},e}();t.Loader=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.loadAsset=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=e[0];return t.AjaxLoader.load(r,"text")},n._instance=null,__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];t.assert(!t.JudgeUtils.isArrayExactly(e[0]),t.Log.info.FUNC_MUST_BE("url","string"))})],n.prototype,"loadAsset",null),n}(t.Loader);t.GLSLLoader=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.loadAsset=function(){for(var t=this,e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=this,i=e[0];return wdFrp.fromPromise(new RSVP.Promise(function(e,n){var o=r._createScript();o.async=!1,o.addEventListener("error",function(t){n("load js file error. url:"+i)}),o.readyState?o.onreadystatechange=function(){("loaded"===o.readyState||"complete"===o.readyState)&&(o.onreadystatechange=null,e(i))}:o.onload=function(){e(i)},o.src=i,t._appendScript(o)}))},n.prototype._createScript=function(){var t=document.createElement("script");return t.type="text/javascript",t},n.prototype._appendScript=function(t){document.getElementsByTagName("head")[0].appendChild(t)},n._instance=null,__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];t.assert(!t.JudgeUtils.isArrayExactly(e[0]),t.Log.info.FUNC_MUST_BE("url","string"))})],n.prototype,"loadAsset",null),n}(t.Loader);t.JsLoader=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){
e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.loadAsset=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=e[0];return t.AjaxLoader.load(r,"json")},n._instance=null,__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];t.assert(!t.JudgeUtils.isArrayExactly(e[0]),t.Log.info.FUNC_MUST_BE("url","string"))})],n.prototype,"loadAsset",null),n}(t.Loader);t.JSONLoader=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.loadAsset=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null;return r=t.JudgeUtils.isString(e[0])?[e[0]]:e[0],wdFrp.fromPromise(new RSVP.Promise(function(e,n){t.Video.create({urlArr:r,onLoad:function(n){e(t.VideoTextureAsset.create(n))},onError:function(t){n(t)}})}))},n._instance=null,n}(t.Loader);t.VideoLoader=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.loadAsset=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null,i=null,o=e[0];switch(r=wdCb.PathUtils.extname(o).toLowerCase()){case".jpg":case".jpeg":case".gif":case".bmp":i=t.ImageLoader.load(o).map(function(e){var n=t.ImageTextureAsset.create(e);return n.format=t.ETextureFormat.RGB,n});break;case".png":i=t.ImageLoader.load(o).map(function(e){return t.ImageTextureAsset.create(e)});break;case".dds":i=t.CompressedTextureLoader.load(o);break;default:t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT(r))}return i},n._instance=null,__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];t.assert(!t.JudgeUtils.isArrayExactly(e[0]),t.Log.info.FUNC_MUST_BE("url","string"))})],n.prototype,"loadAsset",null),n}(t.Loader);t.TextureLoader=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.load=function(e){return wdFrp.fromPromise(new RSVP.Promise(function(n,r){var i=null;i=new t.root.Image,i.onload=function(){this.onload=null,n(i)},i.onerror=function(){r("error")},i.src=e}))},e}();t.ImageLoader=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t.load=function(t,e){return wdFrp.fromPromise(new RSVP.Promise(function(n,r){wdCb.AjaxUtils.ajax({type:"get",url:t,contentType:"text/plain; charset=utf-8",dataType:e,success:function(t){n(t)},error:function(e,n){r("url:"+t+"\nreadyState:"+e.readyState+"\nstatus:"+e.status+"\nmessage:"+n.message+"\nresponseText:"+e.responseText)}})}))},t}();t.AjaxLoader=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t.getPath=function(t,e){return wdCb.PathUtils.dirname(t)+"/"+e},t}();t.ModelLoaderUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.load=function(e){var n=this;return t.AjaxLoader.load(e,"arraybuffer").map(function(e){var r=t.DDSParser.parse(e,!0),i=t.CompressedTextureAsset.create();return i.width=r.width,i.height=r.height,i.mipmaps=r.mipmaps,1==r.mipmapCount&&(i.minFilter=t.ETextureFilterMode.LINEAR),i.format=n._getCompressedFormat(r.format),i})},e._getCompressedFormat=function(e){var n=t.GPUDetector.getInstance().extensionCompressedTextureS3TC;if(e===t.ETextureFormat.RGBA)return e;if(!n)return null;switch(e){case t.ETextureFormat.RGB_S3TC_DXT1:e=n.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case t.ETextureFormat.RGBA_S3TC_DXT1:e=n.COMPRESSED_RGBA_S3TC_DXT1_EXT;break;case t.ETextureFormat.RGBA_S3TC_DXT3:e=n.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case t.ETextureFormat.RGBA_S3TC_DXT5:e=n.COMPRESSED_RGBA_S3TC_DXT5_EXT}return e},e}();t.CompressedTextureLoader=e}(wd||(wd={}));var wd;!function(t){var e=542327876,n=131072,r=512,i=4,o=function(){function o(){}return o.parse=function(o,s){void 0===s&&(s=!0);var c=new a,u=this._fourCCToInt32("DXT1"),l=this._fourCCToInt32("DXT3"),h=this._fourCCToInt32("DXT5"),d=31,p=0,f=1,_=2,g=3,m=4,y=7,v=20,b=21,C=22,E=23,S=24,T=25,w=26,D=28,L=new Int32Array(o,0,d),A=null,M=null,O=null,x=null,N=null,R=null,U=null;if(L[p]!==e)return t.Log.error(!0,"Invalid magic number in DDS header."),c;if(!L[v]&i)return t.Log.error(!0,"Unsupported format, must contain a FourCC code."),c;switch(M=L[b],O=!1,M){case u:A=8,c.format=t.ETextureFormat.RGB_S3TC_DXT1;break;case l:A=16,c.format=t.ETextureFormat.RGBA_S3TC_DXT3;break;case h:A=16,c.format=t.ETextureFormat.RGBA_S3TC_DXT5;break;default:if(!(32==L[C]&&16711680&L[E]&&65280&L[S]&&255&L[T]&&4278190080&L[w]))return t.Log.error(!0,"Unsupported FourCC code "+this._int32ToFourCC(M)),c;O=!0,A=64,c.format=t.ETextureFormat.RGBA}c.mipmapCount=1,L[_]&n&&s!==!1&&(c.mipmapCount=Math.max(1,L[y])),c.isCubemap=L[D]&r?!0:!1,c.width=L[m],c.height=L[g],x=L[f]+4,N=c.width,R=c.height,U=c.isCubemap?6:1;for(var F=0;U>F;F++){for(var I=0;I<c.mipmapCount;I++){var B=null,P=null,j=null;O?(P=this._loadARGBMip(o,x,N,R),j=P.length):(j=Math.max(4,N)/4*Math.max(4,R)/4*A,P=new Uint8Array(o,x,j)),B={data:P,width:N,height:R},c.mipmaps.addChild(B),x+=j,N=Math.max(.5*N,1),R=Math.max(.5*R,1)}N=c.width,R=c.height}return c},o._fourCCToInt32=function(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)},o._int32ToFourCC=function(t){return String.fromCharCode(255&t,t>>8&255,t>>16&255,t>>24&255)},o._loadARGBMip=function(t,e,n,r){for(var i=n*r*4,o=new Uint8Array(t,e,i),a=new Uint8Array(i),s=0,c=0,u=0;r>u;u++)for(var l=0;n>l;l++){var h=null,d=null,p=null,f=null;h=o[c],c++,d=o[c],c++,p=o[c],c++,f=o[c],c++,a[s]=p,s++,a[s]=d,s++,a[s]=h,s++,a[s]=f,s++}return a},o}();t.DDSParser=o;var a=function(){function t(){this.mipmaps=wdCb.Collection.create(),this.width=0,this.height=0,this.format=null,this.mipmapCount=1,this.isCubemap=!1}return t}();t.DDSData=a}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._width=null,this._height=null,this.generateMipmaps=!0,this.sourceRegionMethod=t.ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL,this.format=t.ETextureFormat.RGBA,this.source=e.defaultTexture,this.repeatRegion=t.RectRegion.create(0,0,1,1),this.sourceRegion=null,this.sourceRegionMapping=t.ETextureSourceRegionMapping.CANVAS,this.packAlignment=4,this.unpackAlignment=4,this.flipY=!0,this.premultiplyAlpha=!1,this.colorspaceConversion=t.DeviceManager.getInstance().gl.BROWSER_DEFAULT_WEBGL,this.wrapS=t.ETextureWrapMode.CLAMP_TO_EDGE,this.wrapT=t.ETextureWrapMode.CLAMP_TO_EDGE,this.magFilter=t.ETextureFilterMode.LINEAR,this.minFilter=t.ETextureFilterMode.LINEAR_MIPMAP_LINEAR,this.type=t.ETextureType.UNSIGNED_BYTE,this.mipmaps=wdCb.Collection.create(),this.anisotropy=0,this.needUpdate=!0}return Object.defineProperty(e.prototype,"width",{get:function(){return null===this._width?this.source?this.source.width:null:this._width},set:function(t){this._width=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return null===this._height?this.source?this.source.height:null:this._height},set:function(t){this._height=t},enumerable:!0,configurable:!0}),e.prototype.clone=function(){return t.CloneUtils.clone(this)},e.prototype.cloneToCubemapTexture=function(e){e.generateMipmaps=this.generateMipmaps,e.minFilter=this.minFilter,e.magFilter=this.magFilter,e.width=this.width,e.height=this.height,e.wrapS=this.wrapS,e.wrapT=this.wrapT,e.anisotropy=this.anisotropy,e.premultiplyAlpha=this.premultiplyAlpha,e.flipY=!1,e.unpackAlignment=this.unpackAlignment,e.packAlignment=this.packAlignment,e.colorspaceConversion=this.colorspaceConversion,e.needUpdate=this.needUpdate,e.mode=t.EEnvMapMode.BASIC},e.prototype.cloneTo=function(e){return t.Log.error(!e,t.Log.info.FUNC_MUST_DEFINE("texture")),e.source=this.source,e.width=this.width,e.height=this.height,e.mipmaps=this.mipmaps.clone(),e.wrapS=this.wrapS,e.wrapT=this.wrapT,e.magFilter=this.magFilter,e.minFilter=this.minFilter,e.anisotropy=this.anisotropy,e.format=this.format,e.type=this.type,e.repeatRegion=this.repeatRegion.clone(),e.sourceRegion=this.sourceRegion&&this.sourceRegion.clone(),e.sourceRegionMapping=this.sourceRegionMapping,e.sourceRegionMethod=this.sourceRegionMethod,e.generateMipmaps=this.generateMipmaps,e.premultiplyAlpha=this.premultiplyAlpha,e.flipY=this.flipY,e.unpackAlignment=this.unpackAlignment,e.packAlignment=this.packAlignment,e.colorspaceConversion=this.colorspaceConversion,e.needUpdate=this.needUpdate,e},e.defaultTexture=null,__decorate([t.cloneAttributeAsBasicType()],e.prototype,"source",void 0),e}();t.TextureAsset=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(t){e.call(this),this.source=t}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.toTexture=function(){return t.ImageTexture.create(this)},n.prototype.toCubemapFaceTexture=function(){return t.CubemapFaceImageTexture.create(this)},n.prototype.cloneToCubemapFaceTexture=function(e){e.source=this.source,e.type=this.type,e.format=this.format,e.width=this.width,e.height=this.height,e.sourceRegion=this.sourceRegion,e.sourceRegionMethod=t.ETextureSourceRegionMethod.DRAW_IN_CANVAS},n}(t.TextureAsset);t.ImageTextureAsset=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(t){e.call(this),this.video=null,this.video=t,this.source=this.video.source}return __extends(n,e),n.create=function(t){var e=new this(t);return e.initWhenCreate(),e},n.prototype.initWhenCreate=function(){this.width=0,this.height=0,this.generateMipmaps=!1,this.minFilter=null,this.magFilter=null,this.sourceRegion=null,this.sourceRegionMethod=null},n.prototype.toTexture=function(){return t.VideoTexture.create(this)},n.prototype.toCubemapFaceTexture=function(){return t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("video texture","cubemap"))},n.prototype.cloneToCubemapFaceTexture=function(e){t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("video texture","cubemap"))},n}(t.TextureAsset);t.VideoTextureAsset=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},n.prototype.initWhenCreate=function(){this.generateMipmaps=!1,this.flipY=!1},n.prototype.toTexture=function(){return t.CompressedTexture.create(this)},n.prototype.toCubemapFaceTexture=function(){return t.CubemapFaceCompressedTexture.create(this)},n.prototype.cloneToCubemapFaceTexture=function(t){t.type=this.type,t.format=this.format,t.width=this.width,t.height=this.height,t.mipmaps=this.mipmaps,t.minFilter=this.minFilter},n}(t.TextureAsset);t.CompressedTextureAsset=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.NEAREST="NEAREST"]="NEAREST",t[t.NEAREST_MIPMAP_MEAREST="NEAREST_MIPMAP_MEAREST"]="NEAREST_MIPMAP_MEAREST",t[t.NEAREST_MIPMAP_LINEAR="NEAREST_MIPMAP_LINEAR"]="NEAREST_MIPMAP_LINEAR",t[t.LINEAR="LINEAR"]="LINEAR",t[t.LINEAR_MIPMAP_NEAREST="LINEAR_MIPMAP_NEAREST"]="LINEAR_MIPMAP_NEAREST",t[t.LINEAR_MIPMAP_LINEAR="LINEAR_MIPMAP_LINEAR"]="LINEAR_MIPMAP_LINEAR"}(t.ETextureFilterMode||(t.ETextureFilterMode={}));t.ETextureFilterMode}(wd||(wd={}));var wd;!function(t){!function(t){t[t.REPEAT="REPEAT"]="REPEAT",t[t.MIRRORED_REPEAT="MIRRORED_REPEAT"]="MIRRORED_REPEAT",t[t.CLAMP_TO_EDGE="CLAMP_TO_EDGE"]="CLAMP_TO_EDGE"}(t.ETextureWrapMode||(t.ETextureWrapMode={}));t.ETextureWrapMode}(wd||(wd={}));var wd;!function(t){!function(t){t[t.RGB="RGB"]="RGB",t[t.RGBA="RGBA"]="RGBA",t[t.ALPHA="ALPHA"]="ALPHA",t[t.LUMINANCE="LUMINANCE"]="LUMINANCE",t[t.LUMINANCE_ALPHA="LUMINANCE_ALPHA"]="LUMINANCE_ALPHA",t[t.RGB_S3TC_DXT1="RGB_S3TC_DXT1"]="RGB_S3TC_DXT1",t[t.RGBA_S3TC_DXT1="RGBA_S3TC_DXT1"]="RGBA_S3TC_DXT1",t[t.RGBA_S3TC_DXT3="RGBA_S3TC_DXT3"]="RGBA_S3TC_DXT3",t[t.RGBA_S3TC_DXT5="RGBA_S3TC_DXT5"]="RGBA_S3TC_DXT5"}(t.ETextureFormat||(t.ETextureFormat={}));t.ETextureFormat}(wd||(wd={}));var wd;!function(t){!function(t){t[t.UNSIGNED_BYTE="UNSIGNED_BYTE"]="UNSIGNED_BYTE",t[t.UNSIGNED_SHORT_5_6_5="UNSIGNED_SHORT_5_6_5"]="UNSIGNED_SHORT_5_6_5",t[t.UNSIGNED_SHORT_4_4_4_4="UNSIGNED_SHORT_4_4_4_4"]="UNSIGNED_SHORT_4_4_4_4",t[t.UNSIGNED_SHORT_5_5_5_1="UNSIGNED_SHORT_5_5_5_1"]="UNSIGNED_SHORT_5_5_5_1"}(t.ETextureType||(t.ETextureType={}));t.ETextureType}(wd||(wd={}));var wd;!function(t){!function(t){t[t.BASIC=0]="BASIC",t[t.REFLECTION=1]="REFLECTION",t[t.REFRACTION=2]="REFRACTION",t[t.FRESNEL=3]="FRESNEL"}(t.EEnvMapMode||(t.EEnvMapMode={}));t.EEnvMapMode}(wd||(wd={}));var wd;!function(t){!function(t){t[t.MIX=0]="MIX",t[t.MULTIPLY=1]="MULTIPLY",t[t.ADD=2]="ADD"}(t.ETextureCombineMode||(t.ETextureCombineMode={}));t.ETextureCombineMode}(wd||(wd={}));var wd;!function(t){!function(t){t[t.CANVAS=0]="CANVAS",t[t.UV=1]="UV"}(t.ETextureSourceRegionMapping||(t.ETextureSourceRegionMapping={}));t.ETextureSourceRegionMapping}(wd||(wd={}));var wd;!function(t){!function(t){t[t.CHANGE_TEXCOORDS_IN_GLSL=0]="CHANGE_TEXCOORDS_IN_GLSL",t[t.DRAW_IN_CANVAS=1]="DRAW_IN_CANVAS"}(t.ETextureSourceRegionMethod||(t.ETextureSourceRegionMethod={}));t.ETextureSourceRegionMethod}(wd||(wd={}));var wd;!function(t){!function(t){t[t.TEXTURE_2D="TEXTURE_2D"]="TEXTURE_2D",t[t.TEXTURE_CUBE_MAP="TEXTURE_CUBE_MAP"]="TEXTURE_CUBE_MAP"}(t.ETextureTarget||(t.ETextureTarget={}));t.ETextureTarget}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.assetCount=0,this.currentLoadedCount=0,this._assetTable=wdCb.Hash.create()}return e.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},e.prototype.load=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=this;if(t.JudgeUtils.isString(e[0])){var i=e[0],o=i;return this._createLoadSingleAssetStream(i,o)}var a=e[0];return wdFrp.fromArray(a).concatMap(function(e){return r._createLoadMultiAssetStream(e.type||t.EAssetType.UNKNOW,e.url,e.id)})},e.prototype.reset=function(){this.assetCount=0,this.currentLoadedCount=0},e.prototype.dispose=function(){this.reset(),t.LoaderFactory.createAllLoader().forEach(function(t){t.dispose()})},e.prototype.get=function(t){var e=this._assetTable.getChild(t);return e?e.get(t):null},e.prototype.add=function(t,e){this._assetTable.addChild(t,e)},e.prototype._createLoadMultiAssetStream=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=t[0],r=t[1],i=t[2],o=this._getLoader(n,r),a=this;return o.has(i)||a.assetCount++,o.load(r,i).map(function(){return a.currentLoadedCount++,{currentLoadedCount:a.currentLoadedCount,assetCount:a.assetCount}})},e.prototype._createLoadSingleAssetStream=function(e,n){var r=this._getLoader(t.EAssetType.UNKNOW,e);return r.load(e,n)},e.prototype._getLoader=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=e[0],i=null;return i=t.JudgeUtils.isArrayExactly(e[1])?wdCb.PathUtils.extname(e[1][0]):wdCb.PathUtils.extname(e[1]),t.LoaderFactory.create(r,i.toLowerCase())},e._instance=null,e}();t.LoaderManager=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.create=function(e,n){var r=null;switch(e){case t.EAssetType.FONT:r=t.FontLoader.getInstance();break;case t.EAssetType.UNKNOW:r=this._getLoaderByExtname(n);break;default:wdCb.Log.error(!0,wdCb.Log.info.FUNC_UNKNOW("asset type:"+e))}return r},e.createAllLoader=function(){return wdCb.Collection.create([t.JsLoader.getInstance(),t.GLSLLoader.getInstance(),t.TextureLoader.getInstance(),t.VideoLoader.getInstance(),t.FontLoader.getInstance(),t.FntLoader.getInstance()])},e._getLoaderByExtname=function(e){var n=null;switch(e){case".json":n=t.JSONLoader.getInstance();break;case".js":n=t.JsLoader.getInstance();break;case".glsl":n=t.GLSLLoader.getInstance();break;case".jpg":case".jpeg":case".png":case".dds":case".gif":case".bmp":n=t.TextureLoader.getInstance();break;case".mp4":case".ogv":case".webm":n=t.VideoLoader.getInstance();break;case".gltf":n=t.GLTFLoader.getInstance();break;case".wd":n=t.WDLoader.getInstance();break;case".eot":case".ttf":case".woff":case".svg":n=t.FontLoader.getInstance();break;case".fnt":n=t.FntLoader.getInstance();break;default:t.Log.error(!0,t.Log.info.FUNC_UNKNOW("extname:"+e))}return n},e}();t.LoaderFactory=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._arrayBufferMap=wdCb.Hash.create(),this._imageMap=wdCb.Hash.create()}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.loadAsset=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=e[0],i=this,o=null;return t.AjaxLoader.load(r,"json").flatMap(function(t){return o=t,i._createLoadAllAssetsStream(r,t)}).lastOrDefault().map(function(){return t.GLTFAssembler.create().build(t.GLTFParser.create().parse(o,i._arrayBufferMap,i._imageMap))})},n.prototype._createLoadAllAssetsStream=function(t,e){return wdFrp.fromArray([this._createLoadBuffersStream(t,e),this._createLoadImageAssetStream(t,e)]).mergeAll()},n.prototype._createLoadBuffersStream=function(e,n){var r=this._arrayBufferMap;return this._createLoadAssetStream(e,n,n.buffers,r,function(e,n){return t.AjaxLoader.load(n,"arraybuffer")["do"](function(n){t.Log.error(!(n instanceof ArrayBuffer),t.Log.info.FUNC_SHOULD("Buffer:"+e,"be an array buffer")),t.Log.error(n.byteLength!==n.byteLength,t.Log.info.FUNC_SHOULD("Buffer:"+e+"'s length is "+n.byteLength+", but it","be "+n.byteLength)),r.addChild(e,n)})})},n.prototype._createLoadImageAssetStream=function(e,n){var r=this._imageMap;return this._createLoadAssetStream(e,n,n.images,r,function(e,n){return t.ImageLoader.load(n)["do"](function(t){r.addChild(e,t)})})},n.prototype._createLoadAssetStream=function(e,n,r,i,o){var a=[];if(r){var s=null;for(s in r)if(r.hasOwnProperty(s)){var c=r[s];if(t.GLTFUtils.isBase64(c.uri))i.addChild(s,t.GLTFUtils.decodeArrayBuffer(c.uri));else{var u=t.ModelLoaderUtils.getPath(e,c.uri);a.push(o(s,u))}}}return wdFrp.fromArray(a).mergeAll()},n._instance=null,__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];t.assert(!t.JudgeUtils.isArrayExactly(e[0]),t.Log.info.FUNC_MUST_BE("url","string"))})],n.prototype,"loadAsset",null),n}(t.Loader);t.GLTFLoader=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._result=wdCb.Hash.create()}return e.create=function(){var t=new this;return t},e.prototype.build=function(t){return this._buildMetadata(t),this._buildModels(t),this._result},e.prototype._buildMetadata=function(t){var e=wdCb.Hash.create();for(var n in t.metadata)t.metadata.hasOwnProperty(n)&&e.addChild(n,t.metadata[n]);this._result.addChild("metadata",e)},e.prototype._buildModels=function(e){var n=wdCb.Collection.create(),r=this,i=function(e){var n=t.GameObject.create();return e.name&&(n.name=e.name),r._isModelContainer(e)&&n.addTag(t.EWDTag.CONTAINER),r._addComponentsFromGLTF(n,e.components),n.addComponent(t.MeshRenderer.create()),e.children&&e.children.forEach(function(t){n.addChild(i(t))}),n};e.objects&&(e.objects.forEach(function(t){n.addChild(i(t))}),this._result.addChild("models",n))},e.prototype._isModelContainer=function(t){return t.isContainer},e.prototype._addComponentsFromGLTF=function(t,e){var n=this;e.forEach(function(e){n._isTransform(e)?t.addComponent(n._createTransform(e)):n._isCamera(e)?t.addComponent(n._createCamera(e)):n._isLight(e)?t.addComponent(n._createLight(e)):n._isGeometry(e)?t.addComponent(n._createGeometry(e)):n._isArticulatedAnimation(e)&&t.addComponent(n._createArticulatedAnimation(e))})},e.prototype._isTransform=function(t){return!!t.matrix||!!t.position},e.prototype._isCamera=function(t){return!!t.camera},e.prototype._isLight=function(t){return!!t.lightColor&&!!t.type},e.prototype._isGeometry=function(t){return!!t.material},e.prototype._isArticulatedAnimation=function(e){return t.GLTFUtils.isIGLTFArticulatedAnimation(e)},e.prototype._createTransform=function(e){var n=t.ThreeDTransform.create();return e.matrix?(n.localPosition=e.matrix.getTranslation(),n.localRotation=e.matrix.getRotation(),n.localScale=e.matrix.getScale()):(n.localPosition=e.position,n.localRotation=e.rotation,n.localScale=e.scale),n},e.prototype._createCamera=function(e){return t.BasicCameraController.create(e.camera)},e.prototype._createLight=function(e){var n=null;switch(e.type){case"ambient":n=t.AmbientLight.create(),n.color=e.lightColor;break;case"directional":n=t.DirectionLight.create(),n.color=e.lightColor;break;case"point":n=t.PointLight.create(),n.color=e.lightColor,t.GLTFUtils.addData(n,"range",e.distance),t.GLTFUtils.addData(n,"constant",e.constantAttenuation),t.GLTFUtils.addData(n,"linear",e.linearAttenuation),t.GLTFUtils.addData(n,"quadratic",e.quadraticAttenuation)}return n},e.prototype._createGeometry=function(e){var n=t.ModelGeometry.create();return n.vertices=e.vertices,n.faces=e.faces,t.GLTFUtils.addData(n,"colors",e.colors),t.GLTFUtils.addData(n,"texCoords",e.texCoords),n.drawMode=e.drawMode,n.material=this._createMaterial(e.material),n},e.prototype._createMaterial=function(e){var n=null;switch(e.type){case"BasicMaterial":n=this._createBasicMaterial(e);break;case"LightMaterial":n=this._createLightMaterial(e);break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("material type:"+e.type))}return n},e.prototype._createBasicMaterial=function(e){var n=t.BasicMaterial.create();return this._setBasicDataOfMaterial(n,e),n},e.prototype._createLightMaterial=function(e){var n=t.LightMaterial.create();return this._setBasicDataOfMaterial(n,e),e.transparent===!0&&void 0!==e.opacity&&(n.opacity=e.opacity,n.blendType=t.EBlendType.NORMAL),e.lightModel===t.ELightModel.LAMBERT?(t.Log.log(t.Log.info.FUNC_NOT_SUPPORT("LAMBERT light model, use PHONG light model instead")),n.lightModel=t.ELightModel.PHONG):n.lightModel=e.lightModel,t.GLTFUtils.addData(n,"color",e.diffuseColor),t.GLTFUtils.addData(n,"specularColor",e.specularColor),t.GLTFUtils.addData(n,"emissionColor",e.emissionColor),t.GLTFUtils.addData(n,"diffuseMap",e.diffuseMap),t.GLTFUtils.addData(n,"specularMap",e.specularMap),t.GLTFUtils.addData(n,"emissionMap",e.emissionMap),t.GLTFUtils.addData(n,"shininess",e.shininess),n},e.prototype._setBasicDataOfMaterial=function(e,n){n.doubleSided&&n.doubleSided===!0?e.side=t.ESide.BOTH:e.side=t.ESide.FRONT},e.prototype._createArticulatedAnimation=function(e){var n=t.ArticulatedAnimation.create();return n.data=wdCb.Hash.create(e),n},e}();t.GLTFAssembler=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._data={},this._arrayBufferMap=null,this._imageMap=null,this._json=null,this._geometryParser=t.GLTFGeometryParser.create(),this._articulatedAnimationParser=t.GLTFArticulatedAnimationParser.create()}return e.create=function(){var t=new this;return t},e.prototype.parse=function(t,e,n){return this._json=t,this._arrayBufferMap=e,this._imageMap=n,t.asset&&this._parseMetadata(),this._parseObjects(),t.animations&&this._articulatedAnimationParser.parse(t,this._data.objects,this._arrayBufferMap),this._data},e.prototype._parseMetadata=function(){var t={},e=this._json;for(var n in e.asset)e.asset.hasOwnProperty(n)&&(t[n]=e.asset[n]);this._data.metadata=t},e.prototype._parseObjects=function(){var e=this,n=this._json,r=wdCb.Collection.create(),i=function(r,o){var a=t.GLTFUtils.createObjectData();if(a.id=r,o.name&&(a.name=o.name),o.meshes&&o.meshes.length>0){var s=null;o.meshes.length>1&&t.Log.warn(t.Log.info.FUNC_NOT_SUPPORT("multi mesh(geometry), just use the first mesh(geometry)")),s=n.meshes[o.meshes[0]],!o.name&&s.name&&(a.name=s.name),e._geometryParser.parse(n,a,s,e._arrayBufferMap,e._imageMap)}if(o.extensions&&o.extensions.KHR_materials_common&&o.extensions.KHR_materials_common.light&&a.components.addChild(e._parseLight(o.extensions.KHR_materials_common.light)),o.camera&&a.components.addChild(e._parseCamera(o.camera)),o.matrix?a.components.addChild(e._parseTransform(o.matrix)):o.rotation&&o.scale&&o.translation&&a.components.addChild(e._parseTransform(o.translation,o.rotation,o.scale)),o.children)for(var c=0,u=o.children;c<u.length;c++){var l=u[c];a.children.addChild(i(l,n.nodes[l]))}return a};if(!n.scenes[n.scene])return void(this._data.objects=r);for(var o=0,a=n.scenes[n.scene].nodes;o<a.length;o++){var s=a[o];r.addChild(i(s,n.nodes[s]))}this._data.objects=r},e.prototype._parseLight=function(e){var n=this._json.extensions.KHR_materials_common.lights[e],r={};return t.GLTFUtils.addData(r,"type",n.type),this._parseLightDataByType(r,n,r.type),r},e.prototype._parseLightDataByType=function(e,n,r){var i=n[r];switch(r){case"ambient":case"directional":e.lightColor=t.GLTFUtils.getColor(i.color);break;case"point":e.lightColor=t.GLTFUtils.getColor(i.color),t.GLTFUtils.addData(e,"distance",i.distance),t.GLTFUtils.addData(e,"constantAttenuation",i.constantAttenuation),t.GLTFUtils.addData(e,"linearAttenuation",i.linearAttenuation),t.GLTFUtils.addData(e,"quadraticAttenuation",i.quadraticAttenuation)}},e.prototype._parseCamera=function(t){var e=this._json.cameras[t],n={};return this._parseCameraDataByType(n,e),n},e.prototype._parseCameraDataByType=function(e,n){var r=null,i=n.type,o=n[i];switch(i){case"perspective":if(o=n[i],r=t.PerspectiveCamera.create(),r.near=o.znear,r.far=o.zfar,o.aspectRatio)r.aspect=o.aspectRatio;else{var a=t.DeviceManager.getInstance().view;r.aspect=a.width/a.height}r.fovy=o.yfov,e.camera=r;break;case"orthographic":r=t.OrthographicCamera.create(),r.near=o.znear,r.far=o.zfar,r.left=-o.xmag,r.right=o.xmag,r.top=o.ymag,r.bottom=-o.ymag,e.camera=r;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("camera type:"+i))}},e.prototype._parseTransform=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r={};if(1===e.length){var i=e[0];r.matrix=t.Matrix4.create(new Float32Array(i))}else if(3===e.length){var o=e[0],a=e[1],s=e[2];r.position=t.Vector3.create(o[0],o[1],o[2]),r.rotation=t.Quaternion.create(a[0],a[1],a[2],a[3]),r.scale=t.Vector3.create(s[0],s[1],s[2])}return r},__decorate([t.require(function(e){var n=this._json.extensions.KHR_materials_common.lights;t.assert(n&&n[e],t.Log.info.FUNC_NOT_EXIST("lightId:"+e))})],e.prototype,"_parseLight",null),__decorate([t.require(function(e){var n=this._json.cameras;t.assert(n&&n[e],t.Log.info.FUNC_NOT_EXIST("cameraId:"+e))})],e.prototype,"_parseCamera",null),e}();t.GLTFParser=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._arrayBufferMap=null,this._imageMap=null,this._json=null,this._materialParser=t.GLTFMaterialParser.create()}return e.create=function(){var t=new this;return t},e.prototype.parse=function(e,n,r,i,o){if(this._json=e,this._arrayBufferMap=i,this._imageMap=o,r.primitives.length>1){for(var a=0,s=r.primitives;a<s.length;a++){var c=s[a],u=t.GLTFUtils.createObjectData();this._setChildObjectNameWithMultiPrimitives(u,c),u.components.addChild(this._parseGeometry(c)),n.children.addChild(u)}n.isContainer=!0}else 1===r.primitives.length&&n.components.addChild(this._parseGeometry(r.primitives[0]))},e.prototype._setChildObjectNameWithMultiPrimitives=function(t,e){t.name=e.material},e.prototype._parseGeometry=function(e){var n=this._json,r=this._arrayBufferMap,i=null,o=null,a={},s=null,c=null,u=null,l=null,h=null;for(var d in e.attributes)if(e.attributes.hasOwnProperty(d)){var p=e.attributes[d];if(i=n.accessors[p],o=t.GLTFUtils.getBufferArrFromAccessor(n,i,r),"POSITION"===d)s=[],this._addGeometryData(s,o);else if(d.indexOf("TEXCOORD_")>-1)c=[],this._addGeometryData(c,o),this._normalizeTexCoords(c);else if("NORMAL"===d){l=[];for(var f=0,_=o;f<_.length;f++){var g=_[f];l.push(g)}}else"COLOR"===d&&(u=[],this._addGeometryData(u,o))}return h=this._getFaces(n,e.indices,l),t.GLTFUtils.addData(a,"vertices",s),t.GLTFUtils.addData(a,"colors",u),t.GLTFUtils.addData(a,"texCoords",c),t.GLTFUtils.addData(a,"faces",h),t.GLTFUtils.addData(a,"drawMode",this._parseDrawMode(e.mode)),a.material=this._materialParser.parse(n,e.material,this._imageMap),a},e.prototype._addGeometryData=function(t,e){for(var n=0,r=e.length;r>n;n++)t.push(e[n])},e.prototype._getFaces=function(e,n,r){var i=null,o=null,a=null,s=[];if(!n)return[];i=e.accessors[n],o=t.GLTFUtils.getBufferArrFromAccessor(e,i,this._arrayBufferMap);for(var c=0,u=o.length;u>c;c+=3){var l=o[c],h=o[c+1],d=o[c+2],p=[l,h,d];a=t.Face3.create(l,h,d),t.GeometryUtils.hasData(r)&&this._addNormalData(a.vertexNormals,r,p),s.push(a)}return s},e.prototype._addNormalData=function(t,e,n){var r=n[0],i=n[1],o=n[2];t.addChildren([this._getThreeComponentData(e,r),this._getThreeComponentData(e,i),this._getThreeComponentData(e,o)])},e.prototype._getThreeComponentData=function(e,n){var r=3*n;return t.Vector3.create(e[r],e[r+1],e[r+2])},e.prototype._parseDrawMode=function(e){var n=null;if(!e)return null;switch(e){case 0:n=t.EDrawMode.POINTS;break;case 1:n=t.EDrawMode.LINES;break;case 2:n=t.EDrawMode.LINE_LOOP;break;case 3:n=t.EDrawMode.LINE_STRIP;break;case 4:n=t.EDrawMode.TRIANGLES;break;case 5:n=t.EDrawMode.TRIANGLE_STRIP;break;case 6:n=t.EDrawMode.TRANGLE_FAN;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("mode:"+e))}return n},e.prototype._normalizeTexCoords=function(t){if(t)for(var e=0,n=t.length/2;n>e;e++)t[2*e+1]=1-t[2*e+1]},__decorate([t.require(function(e,n,r){var i=null,o=null;return n?(i=e.accessors[n],o=t.GLTFUtils.getBufferArrFromAccessor(e,i,this._arrayBufferMap),void t.assert(o.length%3===0,t.Log.info.FUNC_SHOULD("indices' count","3 times"))):[]})],e.prototype,"_getFaces",null),e}();t.GLTFGeometryParser=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._imageMap=null,this._json=null}return e.create=function(){var t=new this;return t},e.prototype.parse=function(e,n,r){var i=null,o=null;if(this._json=e,this._imageMap=r,!this._isUseKHRMaterialExtension()){t.Log.log("no KHR_materials_common extension found, will use default material instead");var a={type:"BasicMaterial",doubleSided:!1};return a}var s={};return i=e.materials[n],t.Log.error(!i.extensions||!i.extensions.KHR_materials_common,t.Log.info.FUNC_SHOULD("materials","define KHR_materials_common extensions")),o=i.extensions.KHR_materials_common,t.GLTFUtils.addData(s,"doubleSided",o.doubleSided),t.GLTFUtils.addData(s,"transparent",Boolean(o.transparent)),s.type=this._getMaterialType(o.technique),s.lightModel=this._getLightModel(o.technique),this._addMaterialExtensionValues(s,o.values),s},e.prototype._isUseKHRMaterialExtension=function(){var t=this._json.extensionsUsed;return t?t.indexOf("KHR_materials_common")>-1:!1},e.prototype._getMaterialType=function(e){var n=null;switch(e){case"PHONG":case"BLINN":case"CONSTANT":case"LAMBERT":n="LightMaterial";break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("technique:"+e))}return n},e.prototype._getLightModel=function(e){var n=null;switch(e){case"PHONG":n=t.ELightModel.PHONG;break;case"BLINN":n=t.ELightModel.BLINN;break;case"CONSTANT":n=t.ELightModel.CONSTANT;break;case"LAMBERT":n=t.ELightModel.LAMBERT;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("technique:"+e))}return n},e.prototype._addMaterialExtensionValues=function(e,n){n&&(n.ambient&&t.Log.warn(t.Log.info.FUNC_NOT_SUPPORT("ambient of material")),this._addMaterialLightColor(e,"diffuse",n.diffuse),this._addMaterialLightColor(e,"specular",n.specular),this._addMaterialLightColor(e,"emission",n.emission),n.shininess&&(e.shininess=n.shininess.value),n.transparency&&(e.opacity=n.transparency.value))},e.prototype._addMaterialLightColor=function(e,n,r){r&&(t.JudgeUtils.isArrayExactly(r)?e[n+"Color"]=t.GLTFUtils.getColor(r):this._isColor(r.type)?e[n+"Color"]=t.GLTFUtils.getColor(r.value):e[n+"Map"]=this._getTexture(r.value))},e.prototype._isColor=function(t){return 35666===Number(t)},e.prototype._getTexture=function(e){var n=null,r=null;return this._json.textures&&this._json.textures[e]?(n=this._json.textures[e],r=this._createTextureAsset(n.target,n.source),n.internalFormat!==n.format&&t.Log.warn("texture.internalFormat("+n.internalFormat+") !== texture.format("+n.format+"), here take texture.format value as their value"),n.format&&(r.format=this._getTextureFormat(n.format)),
n.type&&(r.type=this._getTextureType(n.type)),this._addTextureSampler(r,n.sampler),r.toTexture()):null},e.prototype._createTextureAsset=function(e,n){var r=null,i=this._imageMap.getChild(n);switch(i||t.Log.warn("no image found in loader(id:"+n+")"),e){case 3553:r=t.ImageTextureAsset.create(i);break;default:t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("target except TEXTURE_2D"))}return r},e.prototype._getTextureType=function(e){var n=null;switch(e){case 5121:n=t.ETextureType.UNSIGNED_BYTE;break;case 33635:n=t.ETextureType.UNSIGNED_SHORT_5_6_5;break;case 32819:n=t.ETextureType.UNSIGNED_SHORT_4_4_4_4;break;case 32820:n=t.ETextureType.UNSIGNED_SHORT_5_5_5_1;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("texture->type:"+e))}return n},e.prototype._getTextureFormat=function(e){var n=null;switch(e){case 6406:n=t.ETextureFormat.ALPHA;break;case 6407:n=t.ETextureFormat.RGB;break;case 6408:n=t.ETextureFormat.RGBA;break;case 6409:n=t.ETextureFormat.LUMINANCE;break;case 6410:n=t.ETextureFormat.LUMINANCE_ALPHA;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("texture->format:"+e))}return n},e.prototype._addTextureSampler=function(t,e){var n=this._json.samplers[e];t.wrapT=this._getTextureWrap(n.wrapT),t.wrapS=this._getTextureWrap(n.wrapS),t.minFilter=this._getTextureFilter(n.minFilter),t.magFilter=this._getTextureFilter(n.magFilter)},e.prototype._getTextureFilter=function(e){var n=null;switch(e){case 9728:n=t.ETextureFilterMode.NEAREST;break;case 9729:n=t.ETextureFilterMode.LINEAR;break;case 9984:n=t.ETextureFilterMode.NEAREST_MIPMAP_MEAREST;break;case 9985:n=t.ETextureFilterMode.LINEAR_MIPMAP_NEAREST;break;case 9986:n=t.ETextureFilterMode.NEAREST_MIPMAP_LINEAR;break;case 9987:n=t.ETextureFilterMode.LINEAR_MIPMAP_LINEAR;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("texture filter:"+e))}return n},e.prototype._getTextureWrap=function(e){var n=null;switch(e){case 33071:n=t.ETextureWrapMode.CLAMP_TO_EDGE;break;case 33648:n=t.ETextureWrapMode.MIRRORED_REPEAT;break;case 10497:n=t.ETextureWrapMode.REPEAT;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("texture wrap:"+e))}return n},__decorate([t.require(function(e,n){t.assert(!!this._json.samplers[n],t.Log.info.FUNC_NOT_EXIST("samplerId:"+n))})],e.prototype,"_addTextureSampler",null),e}();t.GLTFMaterialParser=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._arrayBufferMap=null,this._json=null,this._translationArrayOffset=null,this._rotationArrayOffset=null,this._scaleArrayOffset=null}return e.create=function(){var t=new this;return t},e.prototype.parse=function(e,n,r){var i=this,o=wdCb.Hash.create(),a=this;this._json=e,this._arrayBufferMap=r;var s=function(s){if(e.animations.hasOwnProperty(s)){for(var c=e.animations[s],u=wdCb.Hash.create(),l=0,h=c.channels.length;h>l;l++){var d=c.channels[l],p=d.target.id;u.appendChild(p,d)}u.forEach(function(u,l){var h=wdCb.Collection.create(),d=a._findNode(n,l),p=null,f=null;if(null===d)return void t.Log.warn("can't find node whose id is "+l+" to attach to animation named "+s);a._addAnimationToNode(o,l,d,a._getAnimName(c,s),h),p=a._getInputData(c,u),f=t.GLTFUtils.getBufferArrFromAccessor(e,e.accessors[p],r),i._translationArrayOffset=0,i._rotationArrayOffset=0,i._scaleArrayOffset=0;for(var _=0;_<f.length;_++){var g={};g.time=i._convertSecondToMillisecond(f[_]),g.targets=i._getKeyFrameDataTargets(c,u),h.addChild(g)}})}};for(var c in e.animations)s(c);this._addAnimationComponent(o)},e.prototype._getAnimName=function(t,e){return t.name?t.name:e},e.prototype._getInputData=function(t,e){var n=null;return e.forEach(function(e){var r=t.samplers[e.sampler];return r?(n=t.parameters[r.input],wdCb.$BREAK):void 0}),n},e.prototype._addAnimationToNode=function(t,e,n,r,i){t.hasChild(e)||t.addChild(e,{node:n,animationData:{}}),t.getChild(e).animationData[r]=i},e.prototype._getKeyFrameDataTargets=function(e,n){var r=this,i=wdCb.Collection.create();return n.forEach(function(n){var o=e.samplers[n.sampler],a=null,s=null,c=null,u={};if(o){switch(c=n.target.path,a=e.parameters[o.output],s=t.GLTFUtils.getBufferArrFromAccessor(r._json,r._json.accessors[a],r._arrayBufferMap),u.interpolationMethod=r._convertTointerpolationMethod(o.interpolation),c){case"translation":u.target=t.EArticulatedAnimationTarget.TRANSLATION,u.data=t.Vector3.create(s[r._translationArrayOffset],s[r._translationArrayOffset+1],s[r._translationArrayOffset+2]),r._translationArrayOffset+=3;break;case"rotation":u.target=t.EArticulatedAnimationTarget.ROTATION,u.data=t.Quaternion.create(s[r._rotationArrayOffset],s[r._rotationArrayOffset+1],s[r._rotationArrayOffset+2],s[r._rotationArrayOffset+3]),r._rotationArrayOffset+=4;break;case"scale":u.target=t.EArticulatedAnimationTarget.SCALE,u.data=t.Vector3.create(s[r._scaleArrayOffset],s[r._scaleArrayOffset+1],s[r._scaleArrayOffset+2]),r._scaleArrayOffset+=3;break;default:t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("path:"+c))}i.addChild(u)}}),i},e.prototype._findNode=function(t,e){var n=function(t){var r=t.findOne(function(t){return t.id===e});return r?r:(t.forEach(function(t){return r=n(t.children),r?wdCb.$BREAK:void 0}),r)};return n(t)},e.prototype._addAnimationComponent=function(t){t.forEach(function(t){var e=t.node,n=t.animationData;e.components.addChild(n)})},e.prototype._convertSecondToMillisecond=function(t){return 1e3*t},e.prototype._convertTointerpolationMethod=function(e){switch(e){case"LINEAR":return t.EKeyFrameInterpolation.LINEAR;default:t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("interpolation:"+e))}},__decorate([t.require(function(e,n){var r=wdCb.Collection.create();for(var i in e.samplers)if(e.samplers.hasOwnProperty(i)){var o=e.samplers[i];r.addChild(o.input)}t.assert(1===r.removeRepeatItems().getCount(),t.Log.info.FUNC_SHOULD("all sampler->input","be the same"))})],e.prototype,"_getInputData",null),__decorate([t.ensure(function(e,n){n.forEach(function(e){var n=e.node;e.animationData;t.assert(n.components.filter(function(e){return t.GLTFUtils.isIGLTFArticulatedAnimation(e)}).getCount()<=1,t.Log.info.FUNC_SHOULD("node","only has 1 IGLTFArticulatedAnimation component"))})})],e.prototype,"_addAnimationComponent",null),e}();t.GLTFArticulatedAnimationParser=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.addData=function(t,e,n){void 0!==n&&null!==n&&(t[e]=n)},e.isBase64=function(t){return t.length<5?!1:"data:"===t.substr(0,5)},e.decodeArrayBuffer=function(t){for(var e=t.split(",")[1],n=atob(e),r=n.length,i=new Uint8Array(new ArrayBuffer(r)),o=0;r>o;o++)i[o]=n.charCodeAt(o);return i.buffer},e.createObjectData=function(){return{id:null,isContainer:!1,components:wdCb.Collection.create(),children:wdCb.Collection.create()}},e.getColor=function(e){var n=t.Color.create();return n.r=Number(e[0]),n.g=Number(e[1]),n.b=Number(e[2]),4===e.length&&(n.a=Number(e[3])),n},e.getBufferArrFromAccessor=function(e,n,r){var i=e.bufferViews[n.bufferView],o=r.getChild(i.buffer),a=n.byteOffset+i.byteOffset,s=n.count*this.getAccessorTypeSize(n);switch(n.componentType){case 5120:return new Int8Array(o,a,s);case 5121:return new Uint8Array(o,a,s);case 5122:return new Int16Array(o,a,s);case 5123:return new Uint16Array(o,a,s);case 5126:return new Float32Array(o,a,s);default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("componentType:"+n.componentType))}},e.getAccessorTypeSize=function(t){var e=t.type;switch(e){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}},e.isIGLTFArticulatedAnimation=function(e){if(!t.JudgeUtils.isDirectObject(e))return!1;for(var n in e)return e[n]instanceof wdCb.Collection&&e[n].getCount()>0&&void 0!==e[n].getChild(0).time},e}();t.GLTFUtils=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.CONTAINER="CONTAINER"]="CONTAINER"}(t.EWDTag||(t.EWDTag={}));t.EWDTag}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._parseData=null}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.loadAsset=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=e[0],i=this;return t.AjaxLoader.load(r,"json").flatMap(function(e){return i._parseData=t.WDParser.create().parse(e),i._createLoadMapStream(r,i._parseData)}).lastOrDefault().map(function(){return t.WDBuilder.create().build(i._parseData)})},n.prototype._createLoadMapStream=function(e,n){var r=[];return n.materials.forEach(function(t){var e=[];t.diffuseMapUrl&&e.push(["diffuseMap",t.diffuseMapUrl,t]),t.specularMapUrl&&e.push(["specularMap",t.specularMapUrl,t]),t.normalMapUrl&&e.push(["normalMap",t.normalMapUrl,t]),r=r.concat(e)}),wdFrp.fromArray(r).flatMap(function(n){var r=n[0],i=n[1],o=n[2];return t.TextureLoader.getInstance().load(t.ModelLoaderUtils.getPath(e,i))["do"](function(t){o[r]=t.toTexture()})})},n._instance=null,__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];t.assert(!t.JudgeUtils.isArrayExactly(e[0]),t.Log.info.FUNC_MUST_BE("url","string"))})],n.prototype,"loadAsset",null),n}(t.Loader);t.WDLoader=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._data={},this._objectParser=t.WDObjectParser.create()}return e.create=function(){var t=new this;return t},e.prototype.parse=function(t){return this._parseMetadata(t),this._parseScene(t),this._parseMaterial(t),this._parseObject(t),this._data},e.prototype._parseMetadata=function(t){this._data.metadata=t.metadata},e.prototype._parseObject=function(t){this._objectParser.parse(this._data,t)},e.prototype._parseScene=function(t){this._data.scene=t.scene,t.scene.ambientColor&&(this._data.scene.ambientColor=this._createColor(t.scene.ambientColor))},e.prototype._parseMaterial=function(t){var e=this;this._data.materials=wdCb.Hash.create(t.materials),this._data.materials.forEach(function(t){t.diffuseColor&&(t.diffuseColor=e._createColor(t.diffuseColor)),t.specularColor&&(t.specularColor=e._createColor(t.specularColor))})},e.prototype._createColor=function(e){return t.Color.create("rgb("+e.join(",").replace(/^(\d+),/g,"$1.0,").replace(/,(\d+),/g,",$1.0,").replace(/,(\d+)$/g,",$1.0")+")")},e}();t.WDParser=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.create=function(){var t=new this;return t},e.prototype.parse=function(t,e){var n=null,r=this;t.objects=wdCb.Collection.create(e.objects),n=function(t){r._isObjectContainer(t)?t.isContainer=!0:(t.isContainer=!1,r._parseFromIndices(t)),t.children&&(t.children=wdCb.Collection.create(t.children),t.children.forEach(function(e){e.parent=t,n(e)}))},t.objects.forEach(function(t){t.parent=null,n(t),r._removeObjectContainerData(t)})},e.prototype._isObjectContainer=function(e){return!t.GeometryUtils.hasData(e.verticeIndices)},e.prototype._parseFromIndices=function(t){this._duplicateVertexWithDifferentUvs(t),this._parseObjectFromIndices(t),this._removeRebundantIndiceData(t)},e.prototype._duplicateVertexWithDifferentUvs=function(e){var n=[],r=wdCb.Hash.create(),i=e.verticeIndices,o=e.uvIndices;if(t.GeometryUtils.hasData(o))for(var a=0,s=i.length;s>a;a++){var c=i[a];this._isSameVertexWithDifferentUvsByCompareToFirstOne(n,o[a],c)&&(this._isUvIndiceEqualTheOneOfAddedVertex(r,c,o[a])?i[a]=this._getVerticeIndexOfAddedVertexByFindContainer(r,c,o[a]):this._addVertexData(e,r,c,a),c=i[a]),n[c]=o[a]}},e.prototype._isSameVertexWithDifferentUvsByCompareToFirstOne=function(t,e,n){return void 0!==t[n]&&t[n]!==e},e.prototype._addVertexData=function(e,n,r,i){var o=e.verticeIndices,a=e.uvIndices,s=e.normalIndices,c=this._findData(e,"vertices"),u=this._findData(e,"normals"),l=this._findData(e,"morphTargets"),h=null;if(this._addThreeComponent(c,r),h=this._getVerticeIndexOfAddedVertex(c),o[i]=h,t.GeometryUtils.hasData(l))for(var d=0,p=l;d<p.length;d++){var f=p[d];this._addThreeComponent(f.vertices,r),t.GeometryUtils.hasData(f.normals)&&this._addDuplicateNormalOfAddedVertex(f.normals,s,i,r)}t.GeometryUtils.hasData(u)&&(this._addDuplicateNormalOfAddedVertex(u,s,i,r),t.GeometryUtils.hasData(s)&&(s[i]=h)),n.appendChild(String(r),[a[i],h])},e.prototype._addDuplicateNormalOfAddedVertex=function(e,n,r,i){return t.GeometryUtils.hasData(n)?void this._addThreeComponent(e,e,n[r]):void this._addThreeComponent(e,e,i)},e.prototype._isUvIndiceEqualTheOneOfAddedVertex=function(t,e,n){var r=t.getChild(String(e));return r?r.hasChildWithFunc(function(t){var e=t[0];t[1];return e===n}):!1},e.prototype._getVerticeIndexOfAddedVertexByFindContainer=function(t,e,n){var r=t.getChild(String(e));return r.findOne(function(t){var e=t[0];t[1];return e===n})[1]},e.prototype._getVerticeIndexOfAddedVertex=function(t){return t.length/3-1},e.prototype._addThreeComponent=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];if(2===t.length){var n=t[0],r=t[1];n.push(n[3*r],n[3*r+1],n[3*r+2])}else{var i=t[0],o=t[1],r=t[2];i.push(o[3*r],o[3*r+1],o[3*r+2])}},e.prototype._parseObjectFromIndices=function(e){for(var n=[],r=[],i=null,o=this._findData(e,"vertices"),a=this._findData(e,"uvs"),s=this._findData(e,"normals"),c=this._findData(e,"colors"),u=0,l=e.verticeIndices.length;l>u;u+=3){var h=e.verticeIndices[u],d=e.verticeIndices[u+1],p=e.verticeIndices[u+2],f=[u,u+1,u+2],_=[h,d,p];i=t.Face3.create(h,d,p),t.GeometryUtils.hasData(e.uvIndices)&&t.GeometryUtils.hasData(a)&&this._setUV(n,a,e.uvIndices,f,_),t.GeometryUtils.hasData(s)&&this._setNormal(i.vertexNormals,s,e.normalIndices,f,_),r.push(i)}e.vertices=o,t.GeometryUtils.hasData(e.uvIndices)?e.uvs=n:e.uvs=a,e.colors=c,e.faces=r,this._setMorphTargets(e,e.verticeIndices,e.normalIndices)},e.prototype._getAnimName=function(t){var e=/([a-z]+)_?(\d+)/,n="default",r=t.match(e);return r&&r.length>1?r[1]:n},e.prototype._removeRebundantIndiceData=function(t){delete t.verticeIndices,delete t.uvIndices,delete t.normalIndices},e.prototype._removeObjectContainerData=function(t){var e=null;(e=function(t){t.isContainer&&(delete t.vertices,delete t.uvs,delete t.colors),t.children&&t.children.forEach(function(t){e(t)})})(t)},e.prototype._findData=function(t,e){var n=null;do n=t[e];while(!n&&null!==(t=t.parent));return n},e.prototype._setUV=function(t,e,n,r,i){var o=null,a=null,s=null,c=r[0],u=r[1],l=r[2],h=i[0],d=i[1],p=i[2];o=n[c],a=n[u],s=n[l],this._setTwoComponentData(t,e,h,o),this._setTwoComponentData(t,e,d,a),this._setTwoComponentData(t,e,p,s)},e.prototype._setTwoComponentData=function(t,e,n,r){t[2*n]=e[2*r],t[2*n+1]=e[2*r+1]},e.prototype._setThreeComponentData=function(t,e,n,r){t[3*n]=e[3*r],t[3*n+1]=e[3*r+1],t[3*n+2]=e[3*r+2]},e.prototype._getThreeComponentData=function(e,n){var r=3*n;return t.Vector3.create(e[r],e[r+1],e[r+2])},e.prototype._setNormal=function(e,n,r,i,o){var a=i[0],s=i[1],c=i[2];return t.GeometryUtils.hasData(r)?void this._addNormalData(e,n,[r[a],r[s],r[c]]):void this._addNormalData(e,n,o)},e.prototype._addNormalData=function(t,e,n){var r=n[0],i=n[1],o=n[2];if(t instanceof wdCb.Collection)t.addChildren([this._getThreeComponentData(e,r),this._getThreeComponentData(e,i),this._getThreeComponentData(e,o)]);else for(var a=t,s=0,c=[this._getThreeComponentData(e,r),this._getThreeComponentData(e,i),this._getThreeComponentData(e,o)];s<c.length;s++){var u=c[s];a.push(u.x,u.y,u.z)}},e.prototype._setMorphTargets=function(e,n,r){var i=this._findData(e,"morphTargets"),o=null,a=null;if(t.GeometryUtils.hasData(i)){o=wdCb.Hash.create(),a=wdCb.Hash.create();for(var s=0,c=i;s<c.length;s++){var u=c[s],l=this._getAnimName(u.name);if(o.appendChild(l,u.vertices),t.GeometryUtils.hasData(u.normals))if(t.GeometryUtils.hasData(r)){for(var h=[],d=0,p=n.length;p>d;d++)this._setThreeComponentData(h,u.normals,n[d],r[d]);a.appendChild(l,h)}else a.appendChild(l,u.normals)}}e.morphTargets=o,e.morphNormals=a},__decorate([t.require(function(e,n,r){t.assert(this._isUvIndiceEqualTheOneOfAddedVertex(e,n,r),t.Log.info.FUNC_SHOULD("uvIndex","equal the one of added vertex"))})],e.prototype,"_getVerticeIndexOfAddedVertexByFindContainer",null),__decorate([t.ensure(function(e,n){t.assert(!n.verticeIndices,t.Log.info.FUNC_SHOULD("object.verticeIndices","be removed")),t.assert(!n.uvIndices,t.Log.info.FUNC_SHOULD("object.uvIndices","be removed")),t.assert(!n.normalIndices,t.Log.info.FUNC_SHOULD("object.normalIndices","be removed"))})],e.prototype,"_removeRebundantIndiceData",null),e}();t.WDObjectParser=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._result=wdCb.Hash.create()}return e.create=function(){var t=new this;return t},e.prototype.build=function(t){return this._buildMetadata(t),this._buildScene(t),this._buildModels(t),this._result},e.prototype._buildMetadata=function(t){var e=wdCb.Hash.create();for(var n in t.metadata)t.metadata.hasOwnProperty(n)&&e.addChild(n,t.metadata[n]);this._result.addChild("metadata",e)},e.prototype._buildScene=function(t){var e=wdCb.Hash.create();t.scene.ambientColor&&e.addChild("ambientColor",t.scene.ambientColor),this._result.addChild("scene",e)},e.prototype._buildModels=function(e){var n=wdCb.Collection.create(),r=this,i=null;i=function(n,o){n.forEach(function(n){var a=null,s=null;s=t.GameObject.create(),r._isModelContainer(n)?s.addTag(t.EWDTag.CONTAINER):(a=t.ModelGeometry.create(),a.vertices=n.vertices,a.faces=n.faces,a.texCoords=n.uvs,a.colors=n.colors,n.material&&(a.material=r._buildMaterial(n.material,e.materials)),a.morphTargets=n.morphTargets,a.morphFaceNormals=n.morphNormals,a.morphVertexNormals=n.morphNormals,t.GeometryUtils.hasData(a.morphTargets)&&s.addComponent(t.MorphAnimation.create()),s.addComponent(a)),s.name=n.name,s.addComponent(t.MeshRenderer.create()),o.addChild(s),n.children&&i(n.children,s)})},i(e.objects,n),this._result.addChild("models",n)},e.prototype._isModelContainer=function(t){return t.isContainer},e.prototype._buildMaterial=function(e,n){var r="LightMaterial",i=null,o=null,a=null;return s=n.findOne(function(t,n){return n===e}),i=s[1],o=i.type||r,wdCb.Log.error(!t[o],wdCb.Log.info.FUNC_NOT_EXIST("materialClass:"+o)),a=t[o].create(),a.name=e,i.diffuseColor&&(a.color=i.diffuseColor),i.specularColor&&(a.specularColor=i.specularColor),i.diffuseMap&&(a.diffuseMap=i.diffuseMap),i.specularMap&&(a.specularMap=i.specularMap),i.normalMap&&(a.normalMap=i.normalMap),null!==i.shininess&&(a.shininess=i.shininess),null!==i.opacity&&(a.opacity=i.opacity),a;var s},e}();t.WDBuilder=e}(wd||(wd={}));var wd;!function(t){var e={".eot":"embedded-opentype",".ttf":"truetype",".woff":"woff",".svg":"svg"},n=function(n){function r(){n.apply(this,arguments),this._familyName=null}return __extends(r,n),r.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},r.prototype.dispose=function(){n.prototype.dispose.call(this),wdCb.DomQuery.create("#"+this._familyName).remove()},r.prototype.loadAsset=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=e[1],i=this;return this._familyName=r,wdFrp.fromPromise(new RSVP.Promise(function(n,o){i._addStyleElement(e,r),document.fonts?document.fonts.load("1em "+r).then(function(){n()},function(t){o(t)}):(t.Log.warn("your browser not support document.fonts api, so it can't ensure that the font is loaded"),n())}))},r.prototype._getType=function(t){return e[wdCb.PathUtils.extname(t).toLowerCase()]},r.prototype._addStyleElement=function(e,n){var r=wdCb.DomQuery.create('<style id="'+n+'"></style>'),i=null;if(r.prependTo("body"),i="@font-face { font-family:"+n+"; src:",t.JudgeUtils.isArrayExactly(e[0])){for(var o=e[0],a=0,s=o;a<s.length;a++){var c=s[a];i+="url('"+c+"') format('"+this._getType(c)+"'),"}i=i.replace(/,$/,";")}else{var c=e[0];i+="url('"+c+"') format('"+this._getType(c)+"');"}r.get(0).textContent+=i+"};"},r._instance=null,__decorate([t.require(function(n){var r=wdCb.PathUtils.extname(n).toLowerCase();t.assert(!!e[r],t.Log.info.FUNC_UNKNOW("type:"+r))})],r.prototype,"_getType",null),r}(t.Loader);t.FontLoader=n}(wd||(wd={}));var wd;!function(t){var e=/common [^\n]*(\n|$)/gi,n=/page [^\n]*(\n|$)/gi,r=/char [^\n]*(\n|$)/gi,i=/\w+=[^ \r\n]+/gi,o=/^[\-]?\d+$/,a=function(){function a(){}return a.create=function(){var t=new this;return t},a.prototype.parseFnt=function(r,i){var o={},a=null,s=null;return a=this._parseStrToObj(r.match(e)[0]),o.commonHeight=a.lineHeight,1!==a.pages&&t.Log.log("only supports 1 page"),s=this._parseStrToObj(r.match(n)[0]),0!==s.id&&t.Log.log("file could not be found"),o.atlasName=wdCb.PathUtils.changeBasename(i,s.file),this._parseChar(r,o),o},a.prototype._parseStrToObj=function(t){var e=t.match(i),n={};if(e)for(var r=0,a=e;r<a.length;r++){var s=a[r],c=s.indexOf("="),u=s.substring(0,c),l=s.substring(c+1);l.match(o)?l=parseInt(l):'"'==l[0]&&(l=l.substring(1,l.length-1)),n[u]=l}return n},a.prototype._parseChar=function(t,e){for(var n=t.match(r),i={},o=0,a=n;o<a.length;o++){var s=a[o],c=this._parseStrToObj(s),u=c.id;i[u]={rect:{x:c.x,y:c.y,width:c.width,height:c.height},xOffset:c.xoffset,yOffset:c.yoffset,xAdvance:c.xadvance}}e.fontDefDictionary=i},a}();t.FntParser=a}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._parser=t.FntParser.create()}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.loadAsset=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=e[0],i=this;return t.AjaxLoader.load(r,"text").map(function(t){return i._parser.parseFnt(t,r)})},n._instance=null,__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];t.assert(!t.JudgeUtils.isArrayExactly(e[0]),t.Log.info.FUNC_MUST_BE("url","string"))})],n.prototype,"loadAsset",null),n}(t.Loader);t.FntLoader=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.view=null,this.gl=null,this._scissorTest=!1,this._depthTest=null,this._depthFunc=null,this._side=null,this.polygonOffset=null,this._polygonOffsetMode=null,this._depthWrite=null,this._blend=null,this._writeRed=null,this._writeGreen=null,this._writeBlue=null,this._writeAlpha=null,this._blendSrc=null,this._blendDst=null,this._blendEquation=null,this._blendFuncSeparate=null,this._blendEquationSeparate=null,this._scissorRegion=t.RectRegion.create(),this._viewport=t.RectRegion.create(),this._clearColor=null}return e.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},Object.defineProperty(e.prototype,"scissorTest",{get:function(){return this._scissorTest},set:function(t){var e=this.gl;this._scissorTest!==t&&(t?e.enable(e.SCISSOR_TEST):e.disable(e.SCISSOR_TEST),this._scissorTest=t)},enumerable:!0,configurable:!0}),e.prototype.setScissor=function(t,e,n,r){(this._scissorRegion.y!==e||this._scissorRegion.width!==n||this._scissorRegion.height!==r)&&(this.gl.scissor(t,e,n,r),this._scissorRegion.set(t,e,n,r),this.scissorTest=!0)},e.prototype.setViewport=function(t,e,n,r){(this._viewport.x!==t||this._viewport.y!==e||this._viewport.width!==n||this._viewport.height!==r)&&(this._viewport.set(t,e,n,r),this.gl.viewport(t,e,n,r))},e.prototype.getViewport=function(){return this._viewport},Object.defineProperty(e.prototype,"depthTest",{get:function(){return this._depthTest},set:function(t){var e=this.gl;this._depthTest!==t&&(t?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._depthTest=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"depthFunc",{get:function(){return this._depthFunc},set:function(t){var e=this.gl;this._depthFunc!==t&&(e.depthFunc(e[t]),this._depthFunc=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"side",{get:function(){return this._side},set:function(e){var r=this.gl;if(this._side!==e){switch(e){case n.NONE:r.enable(r.CULL_FACE),r.cullFace(r.FRONT_AND_BACK);break;case n.BOTH:r.disable(r.CULL_FACE);break;case n.FRONT:r.enable(r.CULL_FACE),r.cullFace(r.BACK);break;case n.BACK:r.enable(r.CULL_FACE),r.cullFace(r.FRONT);break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("side",e))}this._side=e}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"polygonOffsetMode",{get:function(){return this._polygonOffsetMode},set:function(e){var n=this.gl;if(this._polygonOffsetMode!==e){switch(e){case r.NONE:n.polygonOffset(0,0),n.disable(n.POLYGON_OFFSET_FILL);break;case r.IN:n.enable(n.POLYGON_OFFSET_FILL),n.polygonOffset(1,1);break;case r.OUT:n.enable(n.POLYGON_OFFSET_FILL),n.polygonOffset(-1,-1);break;case r.CUSTOM:n.enable(n.POLYGON_OFFSET_FILL),t.Log.error(!this.polygonOffset,t.Log.info.FUNC_MUST_DEFINE("polygonOffset")),n.polygonOffset(this.polygonOffset.x,this.polygonOffset.y)}this._polygonOffsetMode=e}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"depthWrite",{get:function(){return this._depthWrite},set:function(t){this._depthWrite!==t&&(this.gl.depthMask(t),this._depthWrite=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"blend",{get:function(){return this._blend},set:function(t){var e=this.gl;this._blend!==t&&(t?e.enable(e.BLEND):e.disable(e.BLEND),this._blend=t)},enumerable:!0,configurable:!0}),e.prototype.setBlendFunc=function(t,e){(this._blendSrc!==t||this._blendDst!==e)&&(this._blend&&this.gl.blendFunc(this.gl[t],this.gl[e]),this._blendSrc=t,this._blendDst=e)},e.prototype.setBlendEquation=function(t){this._blendEquation!==t&&(this._blend&&this.gl.blendEquation(this.gl[t]),this._blendEquation=t)},e.prototype.setBlendFuncSeparate=function(t){var e=this.gl;this._blendFuncSeparate&&this._blendFuncSeparate[0]===t[0]&&this._blendFuncSeparate[1]===t[1]||(this._blend&&e.blendFuncSeparate(e[t[0]],e[t[1]],e[t[2]],e[t[3]]),this._blendFuncSeparate=t)},e.prototype.setBlendEquationSeparate=function(t){var e=this.gl;this._blendEquationSeparate&&this._blendEquationSeparate[0]===t[0]&&this._blendEquationSeparate[1]===t[1]||(this._blend&&e.blendEquationSeparate(e[t[0]],e[t[1]]),this._blendEquationSeparate=t)},e.prototype.setColorWrite=function(t,e,n,r){(this._writeRed!==t||this._writeGreen!==e||this._writeBlue!==n||this._writeAlpha!==r)&&(this.gl.colorMask(t,e,n,r),this._writeRed=t,this._writeGreen=e,this._writeBlue=n,this._writeAlpha=r)},e.prototype.clear=function(t){var e=this.gl,n=t.color;this._setClearColor(n),this.setColorWrite(!0,!0,!0,!0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT)},e.prototype.createGL=function(e,n){var r=null;r=e?wdCb.DomQuery.create(e).get(0):wdCb.DomQuery.create("<canvas></canvas>").prependTo("body").get(0),this.view=t.ViewWebGL.create(r),this.gl=this.view.getContext(n)},e.prototype.setScreen=function(){var e=t.Main.screenSize,n=null,r=null,i=null,o=null,a=null,s=null;e===t.EScreenSize.FULL?(n=0,r=0,i=t.root.innerWidth,o=t.root.innerHeight,a="100%",s="100%",wdCb.DomQuery.create("body").css("margin","0")):(n=e.x||0,r=e.y||0,i=e.width||t.root.innerWidth,o=e.height||t.root.innerHeight,a=i+"px",s=o+"px"),this.view.initCanvas(),this.view.x=n,this.view.y=r,this.view.width=i,this.view.height=o,this.view.styleWidth=a,this.view.styleHeight=s,this.setViewport(0,0,i,o)},e.prototype.setHardwareScaling=function(t){var e=this.view.width/t,n=this.view.height/t;this.view.width=e,this.view.height=n,this.setViewport(0,0,e,n)},e.prototype._setClearColor=function(t){this._clearColor&&this._clearColor.isEqual(t)||(this.gl.clearColor(t.r,t.g,t.b,t.a),this._clearColor=t)},e._instance=null,__decorate([t.require(function(){t.assert(null!==t.Main.screenSize,t.Log.info.FUNC_NOT_EXIST("Main.screenSize"))})],e.prototype,"setScreen",null),__decorate([t.require(function(e){t.assert(e>0,t.Log.info.FUNC_SHOULD("level","> 0, but actual is "+e))})],e.prototype,"setHardwareScaling",null),e}();t.DeviceManager=e,function(t){t[t.NEVER="NEVER"]="NEVER",t[t.ALWAYS="ALWAYS"]="ALWAYS",t[t.LESS="LESS"]="LESS",t[t.LEQUAL="LEQUAL"]="LEQUAL",t[t.EQUAL="EQUAL"]="EQUAL",t[t.GEQUAL="GEQUAL"]="GEQUAL",t[t.GREATER="GREATER"]="GREATER",t[t.NOTEQUAL="NOTEQUAL"]="NOTEQUAL"}(t.EDepthFunction||(t.EDepthFunction={}));t.EDepthFunction;!function(t){t[t.NONE=0]="NONE",t[t.BOTH=1]="BOTH",t[t.BACK=2]="BACK",t[t.FRONT=3]="FRONT"}(t.ESide||(t.ESide={}));var n=t.ESide;!function(t){t[t.NONE=0]="NONE",t[t.IN=1]="IN",t[t.OUT=2]="OUT",t[t.CUSTOM=3]="CUSTOM"}(t.EPolygonOffsetMode||(t.EPolygonOffsetMode={}));var r=t.EPolygonOffsetMode;!function(t){t[t.ZERO="ZEOR"]="ZERO",t[t.ONE="ONE"]="ONE",t[t.SRC_COLOR="SRC_COLOR"]="SRC_COLOR",t[t.ONE_MINUS_SRC_COLOR="ONE_MINUS_SRC_COLOR"]="ONE_MINUS_SRC_COLOR",t[t.DST_COLOR="DST_COLOR"]="DST_COLOR",t[t.ONE_MINUS_DST_COLOR="ONE_MINUS_DST_COLOR"]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA="SRC_ALPHA"]="SRC_ALPHA",t[t.SRC_ALPHA_SATURATE="SRC_ALPHA_SATURATE"]="SRC_ALPHA_SATURATE",t[t.ONE_MINUS_SRC_ALPHA="ONE_MINUS_SRC_ALPHA"]="ONE_MINUS_SRC_ALPHA",t[t.DST_ALPHA="DST_ALPHA"]="DST_ALPHA",t[t.ONE_MINUS_DST_ALPH="ONE_MINUS_DST_ALPHA"]="ONE_MINUS_DST_ALPH"}(t.EBlendFunc||(t.EBlendFunc={}));t.EBlendFunc;!function(t){t[t.ADD="FUNC_ADD"]="ADD",t[t.SUBTRACT="FUNC_SUBTRACT"]="SUBTRACT",t[t.REVERSE_SUBTRAC="FUNC_REVERSE_SUBTRACT"]="REVERSE_SUBTRAC"}(t.EBlendEquation||(t.EBlendEquation={}));t.EBlendEquation;!function(t){t[t.NONE=0]="NONE",t[t.NORMAL=1]="NORMAL",t[t.ADDITIVE=2]="ADDITIVE",t[t.ADDITIVEALPHA=3]="ADDITIVEALPHA",t[t.MULTIPLICATIVE=4]="MULTIPLICATIVE",t[t.PREMULTIPLIED=5]="PREMULTIPLIED"}(t.EBlendType||(t.EBlendType={}));t.EBlendType;!function(t){t[t.UI="UI"]="UI"}(t.ECanvasType||(t.ECanvasType={}));t.ECanvasType}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.maxTextureUnit=null,this.maxTextureSize=null,this.maxCubemapTextureSize=null,this.maxAnisotropy=null,this.extensionCompressedTextureS3TC=null,this.extensionTextureFilterAnisotropic=null,this.extensionInstancedArrays=null,this.extensionUintIndices=null,this.extensionDepthTexture=null,this.extensionVAO=null,this.precision=null,this._isDetected=!1}return e.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},Object.defineProperty(e.prototype,"gl",{get:function(){return t.DeviceManager.getInstance().gl},enumerable:!0,configurable:!0}),e.prototype.detect=function(){this._isDetected=!0,this._detectExtension(),this._detectCapabilty()},e.prototype._detectExtension=function(){this.extensionCompressedTextureS3TC=this._getExtension("WEBGL_compressed_texture_s3tc"),this.extensionTextureFilterAnisotropic=this._getExtension("EXT_texture_filter_anisotropic"),this.extensionInstancedArrays=this._getExtension("ANGLE_instanced_arrays"),this.extensionUintIndices=this._getExtension("element_index_uint"),this.extensionDepthTexture=this._getExtension("depth_texture"),this.extensionVAO=this._getExtension("vao")},e.prototype._detectCapabilty=function(){var t=this.gl;this.maxTextureUnit=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxCubemapTextureSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxAnisotropy=this._getMaxAnisotropy(),this._detectPrecision()},e.prototype._getExtension=function(t){var e,n=this.gl;switch(t){case"EXT_texture_filter_anisotropic":e=n.getExtension("EXT_texture_filter_anisotropic")||n.getExtension("MOZ_EXT_texture_filter_anisotropic")||n.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":e=n.getExtension("WEBGL_compressed_texture_s3tc")||n.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||n.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":e=n.getExtension("WEBGL_compressed_texture_pvrtc")||n.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;case"ANGLE_instanced_arrays":e=n.getExtension("ANGLE_instanced_arrays");break;case"element_index_uint":e=null!==this._getExtension("OES_element_index_uint");break;case"depth_texture":e=null!==this._getExtension("WEBKIT_WEBGL_depth_texture")||null!==this._getExtension("WEBGL_depth_texture");break;case"vao":e=this._getExtension("OES_vertex_array_object");break;default:e=n.getExtension(t)}return e},e.prototype._getMaxAnisotropy=function(){var t=this.extensionTextureFilterAnisotropic,e=this.gl;return null!==t?e.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0;
},e.prototype._detectPrecision=function(){var e=this.gl,r=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT),i=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT),o=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT),a=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT),s=r.precision>0&&o.precision>0,c=i.precision>0&&a.precision>0;s?this.precision=n.HIGHP:c?(this.precision=n.MEDIUMP,t.Log.warn(t.Log.info.FUNC_NOT_SUPPORT("gpu","highp, using mediump"))):(this.precision=n.LOWP,t.Log.warn(t.Log.info.FUNC_NOT_SUPPORT("gpu","highp and mediump, using lowp")))},e._instance=null,e}();t.GPUDetector=e,function(t){t[t.HIGHP=0]="HIGHP",t[t.MEDIUMP=1]="MEDIUMP",t[t.LOWP=2]="LOWP"}(t.EGPUPrecision||(t.EGPUPrecision={}));var n=t.EGPUPrecision}(wd||(wd={}));var wd;!function(t){!function(t){t[t.FULL=0]="FULL"}(t.EScreenSize||(t.EScreenSize={}));t.EScreenSize}(wd||(wd={}));var wd;!function(t){var e=function(){function t(t,e){void 0===t&&(t=null),void 0===e&&(e=null),this.x=null,this.y=null,this.x=t,this.y=e}return t.create=function(t,e){void 0===t&&(t=null),void 0===e&&(e=null);var n=new this(t,e);return n},t}();t.Point=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t,e,n,r,i){this._faceNormal=null,this.aIndex=null,this.bIndex=null,this.cIndex=null,this.vertexNormals=null,this.aIndex=t,this.bIndex=e,this.cIndex=n,this._faceNormal=r,this.vertexNormals=i}return e.create=function(t,e,n,r,i){void 0===r&&(r=null),void 0===i&&(i=wdCb.Collection.create());var o=new this(t,e,n,r,i);return o},Object.defineProperty(e.prototype,"faceNormal",{get:function(){return null!==this._faceNormal?this._faceNormal:t.Vector3.create(0,0,0)},set:function(t){this._faceNormal=t},enumerable:!0,configurable:!0}),e.prototype.clone=function(){return t.CloneUtils.clone(this)},e.prototype.hasFaceNormal=function(){return null!==this._faceNormal},e.prototype.hasVertexNormal=function(){return this.vertexNormals.getCount()>0},__decorate([t.cloneAttributeAsCloneable()],e.prototype,"_faceNormal",void 0),__decorate([t.cloneAttributeAsBasicType()],e.prototype,"aIndex",void 0),__decorate([t.cloneAttributeAsBasicType()],e.prototype,"bIndex",void 0),__decorate([t.cloneAttributeAsBasicType()],e.prototype,"cIndex",void 0),__decorate([t.cloneAttributeAsCustomType(function(t,e,n){e[n]=t[n].clone(!0)})],e.prototype,"vertexNormals",void 0),e}();t.Face3=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),Object.defineProperty(e.prototype,"width",{get:function(){return this.z},set:function(t){this.z=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this.w},set:function(t){this.w=t},enumerable:!0,configurable:!0}),e.prototype.clone=function(){return this.copyHelper(e.create())},e.prototype.isNotEmpty=function(){return 0!==this.x||0!==this.y||0!==this.width||0!==this.height},e}(t.Vector4);t.RectRegion=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(t){this._dom=null,this._dom=t}return t.create=function(t){var e=new this(t);return e},Object.defineProperty(t.prototype,"offset",{get:function(){for(var t=this._dom,e={x:t.offsetLeft,y:t.offsetTop};t=t.offsetParent;)e.x+=t.offsetLeft,e.y+=t.offsetTop;return e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dom",{get:function(){return this._dom},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return this._dom.clientWidth},set:function(t){this._dom.width=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this._dom.clientHeight},set:function(t){this._dom.height=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"styleWidth",{get:function(){return this._dom.style.width},set:function(t){this._dom.style.width=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"styleHeight",{get:function(){return this._dom.style.height},set:function(t){this._dom.style.height=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"x",{get:function(){return Number(this._dom.style.left.slice(0,-2))},set:function(t){this._dom.style.left=t+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return Number(this._dom.style.top.slice(0,-2))},set:function(t){this._dom.style.top=t+"px"},enumerable:!0,configurable:!0}),t.prototype.initCanvas=function(){this._dom.style.cssText="position:absolute;left:0;top:0;"},t.prototype.getContext=function(t){return this._dom.getContext("webgl",t.options)||this._dom.getContext("experimental-webgl",t.options)},t}();t.ViewWebGL=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._r=null,this._g=null,this._b=null,this._a=null,this._colorString=null,this._colorVec3Cache=null,this._colorVec4Cache=null}return e.create=function(t){var e=new this;return e.initWhenCreate(t),e},Object.defineProperty(e.prototype,"dirty",{set:function(t){t&&this._clearCache()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"r",{get:function(){return this._r},set:function(t){this._r!==t&&(this.dirty=!0,this._r=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"g",{get:function(){return this._g},set:function(t){this._g!==t&&(this.dirty=!0,this._g=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"b",{get:function(){return this._b},set:function(t){this._b!==t&&(this.dirty=!0,this._b=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"a",{get:function(){return this._a},set:function(t){this._a!==t&&(this.dirty=!0,this._a=t)},enumerable:!0,configurable:!0}),e.prototype.initWhenCreate=function(t){t&&(this._colorString=t,this._setColor(t))},e.prototype.toVector3=function(){return t.Vector3.create(this.r,this.g,this.b)},e.prototype.toVector4=function(){return t.Vector4.create(this.r,this.g,this.b,this.a)},e.prototype.toString=function(){return this._colorString},e.prototype.clone=function(){return e.create(this._colorString)},e.prototype.isEqual=function(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a},e.prototype._setColor=function(t){var e=/^rgba\((\d+),\s*(\d+),\s*(\d+),\s*([^\)]+)\)$/i,n=/^rgba\((\d+\.\d+),\s*(\d+\.\d+),\s*(\d+\.\d+),\s*([^\)]+)\)$/i,r=/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/i,i=/^rgb\((\d+\.\d+),\s*(\d+\.\d+),\s*(\d+\.\d+)\)$/i,o=/^\#([0-9a-f]{6})$/i,a=null;return e.test(t)?(a=e.exec(t),this.r=this._getColorValue(a,1),this.g=this._getColorValue(a,2),this.b=this._getColorValue(a,3),this.a=Number(a[4]),this):n.test(t)?(a=n.exec(t),this.r=parseFloat(a[1]),this.g=parseFloat(a[2]),this.b=parseFloat(a[3]),this.a=Number(a[4]),this):r.test(t)?(a=r.exec(t),this.r=this._getColorValue(a,1),this.g=this._getColorValue(a,2),this.b=this._getColorValue(a,3),this.a=1,this):i.test(t)?(a=i.exec(t),this.r=parseFloat(a[1]),this.g=parseFloat(a[2]),this.b=parseFloat(a[3]),this.a=1,this):o.test(t)?(a=o.exec(t),this._setHex(parseInt(a[1],16)),this):void 0},e.prototype._getColorValue=function(t,e,n){return void 0===n&&(n=255),Math.min(n,parseInt(t[e],10))/n},e.prototype._setHex=function(t){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(255&t)/255,this.a=1,this},e.prototype._clearCache=function(){this._colorVec3Cache=null,this._colorVec4Cache=null},__decorate([t.ensureGetter(function(e){t.assert(e>=0,t.Log.info.FUNC_SHOULD("r",">= 0, but actual is "+e))})],e.prototype,"r",null),__decorate([t.ensureGetter(function(e){t.assert(e>=0,t.Log.info.FUNC_SHOULD("g",">= 0, but actual is "+e))})],e.prototype,"g",null),__decorate([t.ensureGetter(function(e){t.assert(e>=0,t.Log.info.FUNC_SHOULD("b",">= 0, but actual is "+e))})],e.prototype,"b",null),__decorate([t.ensureGetter(function(e){t.assert(e>=0,t.Log.info.FUNC_SHOULD("a",">= 0, but actual is "+e))})],e.prototype,"a",null),__decorate([t.cache(function(){return null!==this._colorVec3Cache},function(){return this._colorVec3Cache},function(t){this._colorVec3Cache=t})],e.prototype,"toVector3",null),__decorate([t.cache(function(){return null!==this._colorVec4Cache},function(){return this._colorVec4Cache},function(t){this._colorVec4Cache=t})],e.prototype,"toVector4",null),e}();t.Color=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.name="",this.material=null,this.width=null,this.height=null,this.variableData=null,this.wrapS=null,this.wrapT=null,this.magFilter=null,this.minFilter=null,this.glTexture=null,this.needUpdate=null,this.target=t.ETextureTarget.TEXTURE_2D}return __extends(n,e),Object.defineProperty(n.prototype,"geometry",{get:function(){return this.material.geometry},enumerable:!0,configurable:!0}),n.prototype.clone=function(){return t.CloneUtils.clone(this)},n.prototype.bindToUnit=function(e){var n=t.DeviceManager.getInstance().gl;if(!t.TextureCache.isCached(e,this))return t.TextureCache.addActiveTexture(e,this),n.activeTexture(n["TEXTURE"+String(e)]),n.bindTexture(n[this.target],this.glTexture),this},n.prototype.sendData=function(t,e,n){t.sendUniformData(e,this.getSamplerType(),n)},n.prototype.dispose=function(){var e=t.DeviceManager.getInstance().gl;e.deleteTexture(this.glTexture),delete this.glTexture,this._unBindAllUnit()},n.prototype.filterFallback=function(e){return e===t.ETextureFilterMode.NEAREST||e===t.ETextureFilterMode.NEAREST_MIPMAP_MEAREST||e===t.ETextureFilterMode.NEAREST_MIPMAP_LINEAR?t.ETextureFilterMode.NEAREST:t.ETextureFilterMode.LINEAR},n.prototype.getSamplerNameByVariableData=function(e,n){var r=null;return this.variableData?this.variableData.samplerVariableName&&(r=this.variableData.samplerVariableName):r=n===t.EVariableType.SAMPLER_2D?"u_sampler2D"+e:"u_samplerCube"+e,r},n.prototype.getSamplerType=function(){var e=null;switch(this.target){case t.ETextureTarget.TEXTURE_2D:e=t.EVariableType.SAMPLER_2D;break;case t.ETextureTarget.TEXTURE_CUBE_MAP:e=t.EVariableType.SAMPLER_CUBE}return e},n.prototype.isSourcePowerOfTwo=function(){return t.TextureUtils.isPowerOfTwo(this.width,this.height)},n.prototype.setTextureParameters=function(e,n){var r=t.DeviceManager.getInstance().gl;n?(r.texParameteri(e,r.TEXTURE_WRAP_S,r[this.wrapS]),r.texParameteri(e,r.TEXTURE_WRAP_T,r[this.wrapT]),r.texParameteri(e,r.TEXTURE_MAG_FILTER,r[this.magFilter]),r.texParameteri(e,r.TEXTURE_MIN_FILTER,r[this.minFilter])):(r.texParameteri(e,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(e,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(e,r.TEXTURE_MAG_FILTER,r[this.filterFallback(this.magFilter)]),r.texParameteri(e,r.TEXTURE_MIN_FILTER,r[this.filterFallback(this.minFilter)]))},n.prototype._unBindAllUnit=function(){for(var e=t.DeviceManager.getInstance().gl,n=t.GPUDetector.getInstance().maxTextureUnit,r=0;n>r;r++)e.activeTexture(e["TEXTURE"+r]),e.bindTexture(e.TEXTURE_2D,null),e.bindTexture(e.TEXTURE_CUBE_MAP,null);t.TextureCache.clearAllBindTextureUnitCache()},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"name",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"material",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"width",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"height",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"variableData",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"wrapS",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"wrapT",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"magFilter",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"minFilter",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"needUpdate",void 0),__decorate([t.require(function(e,n){var r=t.GPUDetector.getInstance().maxTextureUnit;t.assert(e>=0,t.Log.info.FUNC_SHOULD("texture unit",">= 0, but actual is "+e)),t.assert(r>e,"trying to cache "+e+" texture units, but GPU only supports "+r+" units")})],n.prototype,"bindToUnit",null),__decorate([t.virtual],n.prototype,"isSourcePowerOfTwo",null),n}(t.Entity);t.Texture=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.isPowerOfTwo=function(e,n){return t.JudgeUtils.isPowerOfTwo(e)&&t.JudgeUtils.isPowerOfTwo(n)},e}();t.TextureUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.isDrawPartOfTexture=function(e,n){return e&&e.isNotEmpty()&&n===t.ETextureSourceRegionMethod.DRAW_IN_CANVAS},n.drawPartOfTextureByCanvas=function(t,e,n,r,i,o,a,s,c,u,l){var h=wdCb.DomQuery.create("<canvas></canvas>").get(0),d=null;return h.width=e,h.height=n,d=h.getContext("2d"),d.drawImage(t,r,i,o,a,s,c,u,l),h},n.isSourcePowerOfTwo=function(t,e,n,r){return this.isDrawPartOfTexture(t,e)?this.isPowerOfTwo(t.width,t.height):this.isPowerOfTwo(n,r)},n.needClampMaxSize=function(t,e,n){return e>t||n>t},n.clampToMaxSize=function(e,n){var r=null,i=null,o=null,a=null;return r=Math.max(e.width,e.height),i=Math.floor(e.width*n/r),o=Math.floor(e.height*n/r),a=this.drawPartOfTextureByCanvas(e,i,o,0,0,e.width,e.height,0,0,i,o),t.Log.log("source is too big (width:"+e.width+", height:"+e.height+"), resize it to be width:"+a.width+", height:"+a.height+"."),a},n}(t.TextureUtils);t.BasicTextureUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._renderRate=1}return __extends(n,e),Object.defineProperty(n.prototype,"renderRate",{get:function(){return this._renderRate},set:function(t){this._renderRate=t},enumerable:!0,configurable:!0}),n.prototype.initWhenCreate=function(){this.needUpdate=!1,this.minFilter=t.ETextureFilterMode.LINEAR,this.magFilter=t.ETextureFilterMode.LINEAR,this.wrapS=t.ETextureWrapMode.CLAMP_TO_EDGE,this.wrapT=t.ETextureWrapMode.CLAMP_TO_EDGE},n.prototype.init=function(){},n.prototype.update=function(){},n.prototype.getPosition=function(){return this.geometry.entityObject.transform.position},n.prototype.setEmptyTexture=function(e){var n=t.DeviceManager.getInstance().gl;n.bindTexture(n[this.target],e),this.setTextureParameters(n[this.target],this.isSourcePowerOfTwo())},__decorate([t.require(function(e){t.Log.assert(!!e,t.Log.info.FUNC_NOT_EXIST("texture object"))})],n.prototype,"setEmptyTexture",null),n}(t.Texture);t.RenderTargetTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._renderList=null}return __extends(n,e),Object.defineProperty(n.prototype,"renderList",{get:function(){return this._renderList},set:function(e){t.JudgeUtils.isArrayExactly(e)?this._renderList=wdCb.Collection.create(e):this._renderList=e},enumerable:!0,configurable:!0}),n.prototype.initWhenCreate=function(){e.prototype.initWhenCreate.call(this),this.width=256,this.height=256},n.prototype.createEmptyTexture=function(){var e=t.DeviceManager.getInstance().gl,n=e.createTexture();this.setEmptyTexture(n),this.texImageEmpty(),this.glTexture=n},n.prototype.texImageEmpty=function(){var e=t.DeviceManager.getInstance().gl;e.texImage2D(e[this.target],0,e.RGBA,this.width,this.height,0,e.RGBA,e.UNSIGNED_BYTE,null)},__decorate([t.requireSetter(function(e){t.assert(t.JudgeUtils.isArrayExactly(e)||t.JudgeUtils.isCollection(e),t.Log.info.FUNC_MUST_BE("renderList","array or collection"))}),t.cloneAttributeAsCloneable()],n.prototype,"renderList",null),__decorate([t.virtual],n.prototype,"texImageEmpty",null),n}(t.RenderTargetTexture);t.TwoDRenderTargetTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.setTextureParameters=function(e){var n=t.DeviceManager.getInstance().gl,r=t.Director.getInstance().scene;r.shadowMap.softType===t.EShadowMapSoftType.PCF&&(n.texParameteri(e,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(e,n.TEXTURE_MIN_FILTER,n.NEAREST))},e}();t.ShadowMapTextureUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._plane=null}return __extends(n,e),n.prototype.getSamplerName=function(e){return this.getSamplerNameByVariableData(e,t.EVariableType.SAMPLER_2D)},n.prototype.getPlane=function(){var e=null,n=null,r=null;return this._plane&&!this.geometry.entityObject.transform.dirtyLocal?this._plane:(t.Log.error(!(this.geometry instanceof t.PlaneGeometry),t.Log.info.FUNC_MUST_BE("geometry","PlaneGeometry")),e=this.geometry.geometryData.normals,n=this.geometry.entityObject.transform.localRotation.multiplyVector3(t.Vector3.create(e[0],e[1],e[2])).normalize(),r=this.getPosition(),this._plane=t.Plane.create(n.x,n.y,n.z,-r.dot(n)),this._plane)},n}(t.TwoDRenderTargetTexture);t.LightEffectTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},n.prototype.init=function(){return e.prototype.init.call(this),t.Director.getInstance().scene.addCommonRenderTargetRenderer(t.MirrorRenderTargetRenderer.create(this)),this},n}(t.LightEffectTexture);t.MirrorTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},n.prototype.init=function(){return e.prototype.init.call(this),t.Director.getInstance().scene.addCommonRenderTargetRenderer(t.RefractionRenderTargetRenderer.create(this)),this},n}(t.LightEffectTexture);t.RefractionTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},n.prototype.getSamplerName=function(t){return"u_twoDShadowMapSampler["+this.variableData.samplerData+"]"},n.prototype.setTextureParameters=function(n,r){e.prototype.setTextureParameters.call(this,n,r),t.ShadowMapTextureUtils.setTextureParameters(n)},n.prototype.texImageEmpty=function(){if(t.GPUDetector.getInstance().extensionDepthTexture){var n=t.DeviceManager.getInstance().gl;return void n.texImage2D(n[this.target],0,n.DEPTH_COMPONENT,this.width,this.height,0,n.DEPTH_COMPONENT,n.UNSIGNED_SHORT,null)}e.prototype.texImageEmpty.call(this)},__decorate([t.require(function(e){t.assert(t.JudgeUtils.isNumber(this.variableData.samplerData),t.Log.info.FUNC_MUST_BE("shadowMapTexture->variableData.samplerData","samplerIndex"))})],n.prototype,"getSamplerName",null),n}(t.TwoDRenderTargetTexture);t.TwoDShadowMapTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.target=t.ETextureTarget.TEXTURE_CUBE_MAP}return __extends(n,e),n.prototype.createEmptyTexture=function(){var e=t.DeviceManager.getInstance().gl,n=e.createTexture(),r=null;for(this.setEmptyTexture(n),r=0;6>r;r++)e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+r,0,e.RGBA,this.width,this.height,0,e.RGBA,e.UNSIGNED_BYTE,null);this.glTexture=n},n}(t.RenderTargetTexture);t.CubemapRenderTargetTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},n.prototype.getSamplerName=function(t){return"u_cubemapShadowMapSampler["+this.variableData.samplerData+"]"},__decorate([t.require(function(e){t.assert(t.JudgeUtils.isNumber(this.variableData.samplerData),t.Log.info.FUNC_MUST_BE("shadowMapTexture->variableData.samplerData","samplerIndex"))})],n.prototype,"getSamplerName",null),n}(t.CubemapRenderTargetTexture);t.CubemapShadowMapTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._renderList=null,this.size=256,this.near=.1,this.far=100,this.mode=null}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},Object.defineProperty(n.prototype,"renderList",{get:function(){return this._renderList},set:function(e){var n=wdCb.Hash.create();e instanceof wdCb.Hash||(t.JudgeUtils.isDirectObject(e)?e=wdCb.Hash.create(e):t.Log.error(!0,t.Log.info.FUNC_MUST_BE("renderList","array or wdCb.Collection"))),e.forEach(function(e,r){t.JudgeUtils.isArrayExactly(e)?n.addChild(r,wdCb.Collection.create(e)):t.JudgeUtils.isCollection(e)?n.addChild(r,e):t.Log.error(!0,t.Log.info.FUNC_MUST_BE("faceRenderList","array or wdCb.Collection"))}),this._renderList=n},enumerable:!0,configurable:!0}),n.prototype.init=function(){return e.prototype.init.call(this),this.width=this.size,this.height=this.size,t.Director.getInstance().scene.addCommonRenderTargetRenderer(t.DynamicCubemapRenderTargetRenderer.create(this)),this},n.prototype.getSamplerName=function(e){return this.getSamplerNameByVariableData(e,t.EVariableType.SAMPLER_CUBE)},__decorate([t.cloneAttributeAsCustomType(function(t,e,n){var r=null;null!==t[n]&&(r=wdCb.Hash.create(),t[n].forEach(function(t,e){r.addChild(e,t.clone())}),e[n]=r)})],n.prototype,"renderList",null),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"size",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"near",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"far",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"mode",void 0),n}(t.CubemapRenderTargetTexture);t.DynamicCubemapTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.p_sourceRegionMethod=null,this._sourceRegion=null,this.generateMipmaps=null,this.format=null,this.source=null,this.repeatRegion=null,this.sourceRegionMapping=null,this.packAlignment=null,this.unpackAlignment=null,this.flipY=null,this.premultiplyAlpha=null,this.colorspaceConversion=null,this.type=null,this.mipmaps=null,this.anisotropy=null,this._sourceRegionDirty=!1,this._sourceRegionForGLSLCache=null}return __extends(n,e),Object.defineProperty(n.prototype,"sourceRegionMethod",{get:function(){return this.p_sourceRegionMethod},set:function(t){this.p_sourceRegionMethod=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"sourceRegion",{get:function(){return this._sourceRegion},set:function(t){this._sourceRegion=t,this._sourceRegionDirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"sourceRegionForGLSL",{get:function(){return this.sourceRegion&&this.sourceRegionMethod===t.ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL?this._convertSourceRegionToUV(this.sourceRegion):t.RectRegion.create(0,0,1,1)},enumerable:!0,configurable:!0}),n.prototype.initWhenCreate=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=t.DeviceManager.getInstance().gl;this.glTexture=r.createTexture(),this.needUpdate=!0},n.prototype.init=function(){},n.prototype.dispose=function(){e.prototype.dispose.call(this),this._sourceRegionForGLSLCache=null},n.prototype.update=function(){var e=t.DeviceManager.getInstance().gl,n=this.isSourcePowerOfTwo();return e.pixelStorei(e.PACK_ALIGNMENT,this.packAlignment),e.pixelStorei(e.UNPACK_ALIGNMENT,this.unpackAlignment),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,this.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,this.colorspaceConversion),this.needClampMaxSize()&&(this.clampToMaxSize(),n=this.isSourcePowerOfTwo(),n||t.Log.warn("texture size is not power of two after clampToMaxSize()")),this.setTextureParameters(e[this.target],n),this.allocateSourceToTexture(n),this.generateMipmaps&&n&&e.generateMipmap(e[this.target]),this.needUpdate=!1,this},n.prototype.getSamplerName=function(e){return this.getSamplerNameByVariableData(e,t.EVariableType.SAMPLER_2D)},n.prototype.needClampMaxSize=function(){return this.source?t.BasicTextureUtils.needClampMaxSize(t.GPUDetector.getInstance().maxTextureSize,this.source.width,this.source.height):!1},n.prototype.clampToMaxSize=function(){this.source=t.BasicTextureUtils.clampToMaxSize(this.source,t.GPUDetector.getInstance().maxTextureSize)},n.prototype.setTextureParameters=function(t,n){e.prototype.setTextureParameters.call(this,t,n),this._setAnisotropy(t)},n.prototype.isSourcePowerOfTwo=function(){return t.BasicTextureUtils.isSourcePowerOfTwo(this.sourceRegion,this.sourceRegionMethod,this.width,this.height)},n.prototype._setAnisotropy=function(e){var n=t.GPUDetector.getInstance(),r=t.DeviceManager.getInstance().gl;n.extensionTextureFilterAnisotropic&&this.anisotropy>1&&r.texParameterf(e,n.extensionTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(this.anisotropy,n.maxAnisotropy))},n.prototype._convertSourceRegionCanvasMapToUV=function(e){var n=this.width,r=this.height,i=null;return i=t.RectRegion.create(e.x/n,e.y/r,e.width/n,e.height/r),i.y=1-i.y-i.height,i},n.prototype._convertSourceRegionToUV=function(e){return this.sourceRegionMapping===t.ETextureSourceRegionMapping.CANVAS?this._convertSourceRegionCanvasMapToUV(e):this.sourceRegionMapping===t.ETextureSourceRegionMapping.UV?e:void 0},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"sourceRegionMethod",null),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"sourceRegion",null),__decorate([t.cacheGetter(function(){return!this._sourceRegionDirty&&null!==this._sourceRegionForGLSLCache},function(){return this._sourceRegionForGLSLCache},function(t){this._sourceRegionForGLSLCache=t,this._sourceRegionDirty=!1})],n.prototype,"sourceRegionForGLSL",null),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"generateMipmaps",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"format",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"source",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"repeatRegion",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"sourceRegionMapping",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"packAlignment",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"unpackAlignment",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"flipY",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"premultiplyAlpha",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"colorspaceConversion",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"type",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"mipmaps",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"anisotropy",void 0),__decorate([t.virtual],n.prototype,"needClampMaxSize",null),n}(t.Texture);t.BasicTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(t){e.call(this),this.asset=null,this.asset=t}return __extends(n,e),n.prototype.clone=function(){return t.CloneUtils.clone(this,null,[this.asset])},n.prototype.initWhenCreate=function(){e.prototype.initWhenCreate.call(this),this.asset.cloneTo(this)},n}(t.BasicTexture);t.TwoDTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.prototype.allocateSourceToTexture=function(e){var n=null,r=null,i=t.DeviceManager.getInstance().gl;e&&this.mipmaps.getCount()>0?(n=t.DrawMipmapTwoDTextureCommand.create(),n.mipmaps=this.mipmaps,n.format=this.format,n.type=this.type,n.sourceRegion=this.sourceRegion,n.sourceRegionMethod=this.sourceRegionMethod,n.glTarget=i.TEXTURE_2D,n.execute(),this.generateMipmaps=!1):(r=t.DrawNoMipmapTwoDTextureCommand.create(),r.source=this.source,r.format=this.format,r.type=this.type,r.sourceRegion=this.sourceRegion,r.sourceRegionMethod=this.sourceRegionMethod,r.glTarget=i.TEXTURE_2D,r.execute())},n}(t.TwoDTexture);t.CommonTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(n){if(n instanceof t.ImageTextureAsset){var r=n;e.call(this,r)}else{var i=n;e.call(this,t.ImageTextureAsset.create(i))}}return __extends(n,e),n.create=function(t){var e=new this(t);return e.initWhenCreate(),e},n}(t.CommonTexture);t.ImageTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._video=null,this._startLoopSubscription=null}return __extends(n,e),n.create=function(t){var e=new this(t);return e.initWhenCreate(),e},n.prototype.initWhenCreate=function(){e.prototype.initWhenCreate.call(this),this._video=this.asset.video},n.prototype.init=function(){var n=this;return e.prototype.init.call(this),this._startLoopSubscription=t.EventManager.fromEvent(t.EEngineEvent.STARTLOOP).subscribe(function(){n._video.isStop?n.needUpdate=!1:n.needUpdate=!0}),this},n.prototype.dispose=function(){this._startLoopSubscription&&this._startLoopSubscription.dispose()},n.prototype.needClampMaxSize=function(){return!1},n}(t.CommonTexture);t.VideoTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(n){e.call(this),this.assets=null,this.textures=wdCb.Collection.create(),this.mode=null,this.target=t.ETextureTarget.TEXTURE_CUBE_MAP,this._areAllCompressedAsset=!1,this.assets=n}return __extends(n,e),n.create=function(t){var e=new this(t);return e.initWhenCreate(t),e},n.prototype.clone=function(){var e=null;return e=null!==this.assets?[].concat(this.assets):null,t.CloneUtils.clone(this,null,[e])},n.prototype.initWhenCreate=function(t){e.prototype.initWhenCreate.call(this),this._areAssetsAllCompressedAsset(t)?this._areAllCompressedAsset=!0:this._areAllCompressedAsset=!1,this._createTextures(t),this._getRepresentAsset(t).cloneToCubemapTexture(this),this._areAllCompressedAsset?(this.generateMipmaps=!1,this._hasNoMipmapCompressedAsset()&&(this.minFilter=this.filterFallback(this.minFilter))):this.generateMipmaps=!0,this.flipY=!1},n.prototype.getSamplerName=function(e){return this.getSamplerNameByVariableData(e,t.EVariableType.SAMPLER_CUBE)},n.prototype.allocateSourceToTexture=function(t){this._areAllCompressedAsset?this.textures.forEach(function(t,e){t.draw(e)}):this.textures.forEach(function(t,e){t.draw(e)})},n.prototype.needClampMaxSize=function(){var t=!1;return this.textures.forEach(function(e){return e.needClampMaxSize()?(t=!0,wdCb.$BREAK):void 0}),t},n.prototype.isSourcePowerOfTwo=function(){var t=!0;return this.textures.forEach(function(e){return e.isSourcePowerOfTwo()?void 0:(t=!1,wdCb.$BREAK)}),t},n.prototype.clampToMaxSize=function(){this.textures.forEach(function(t){t.clampToMaxSize()})},n.prototype._hasNoMipmapCompressedAsset=function(){var t=this;return this._areAllCompressedAsset?this.textures.filter(function(e){return!t._isMipmapFilter(e.minFilter)}).getCount()>0:!1},n.prototype._isMipmapFilter=function(e){return e===t.ETextureFilterMode.LINEAR_MIPMAP_LINEAR||e===t.ETextureFilterMode.LINEAR_MIPMAP_NEAREST||e===t.ETextureFilterMode.NEAREST_MIPMAP_LINEAR||e===t.ETextureFilterMode.NEAREST_MIPMAP_MEAREST},n.prototype._getRepresentAsset=function(t){return t[0].asset},n.prototype._areAssetsAllImageAssets=function(e){for(var n=[],r=0,i=e;r<i.length;r++){var o=i[r];o.asset instanceof t.ImageTextureAsset&&n.push(o)}return 6===n.length},n.prototype._areAssetsAllCompressedAsset=function(e){for(var n=[],r=0,i=e;r<i.length;r++){var o=i[r];o.asset instanceof t.CompressedTextureAsset&&n.push(o)}return 6===n.length},n.prototype._createTextures=function(e){for(var n=this,r=0,i=e;r<i.length;r++){var o=i[r],a=o.asset.toCubemapFaceTexture();if(o.sourceRegion&&a instanceof t.CubemapFaceImageTexture){var s=a;s.sourceRegion=o.sourceRegion}o.type&&(a.type=o.type),n.textures.addChild(a)}},n.prototype._areTextureSizOfAllFaceseEqual=function(t){for(var e=[],n=[],r=0,i=t;r<i.length;r++){var o=i[r];o.sourceRegion?(e.push(o.sourceRegion.width),n.push(o.sourceRegion.height)):(e.push(o.asset.width),n.push(o.asset.height))}return this._areAllElementsEqual(e)&&this._areAllElementsEqual(n)},n.prototype._hasSourceRegion=function(t){for(var e=0,n=t;e<n.length;e++){var r=n[e];if(r.sourceRegion)return!0}return!1},n.prototype._areAllElementsEqual=function(t){for(var e=t[0],n=0,r=t;n<r.length;n++){var i=r[n];if(i!==e)return!1}return!0},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"mode",void 0),__decorate([t.require(function(e){t.assert(6===e.length,t.Log.info.FUNC_MUST("cubemap","has 6 assets")),t.assert(this._areAssetsAllImageAssets(e)||this._areAssetsAllCompressedAsset(e),t.Log.info.FUNC_MUST_BE("cubemap six face's assets","all ImageTextureAsset or all CompressedTextureAsset")),this._areAssetsAllCompressedAsset(e)&&t.assert(!this._hasSourceRegion(e),t.Log.info.FUNC_SHOULD_NOT("compressed face","contain sourceRegion data")),
t.assert(this._areTextureSizOfAllFaceseEqual(e),t.Log.info.FUNC_MUST_BE("all cubemap faces' texture size","equal"))})],n.prototype,"initWhenCreate",null),n}(t.BasicTexture);t.CubemapTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.type=t.ETextureType.UNSIGNED_BYTE,this.format=null,this.width=null,this.height=null}return e}();t.CubemapFaceTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.sourceRegion=null,this.source=null}return __extends(n,e),n.create=function(t){var e=new this;return e.initWhenCreate(t),e},Object.defineProperty(n.prototype,"sourceRegionMethod",{get:function(){return t.ETextureSourceRegionMethod.DRAW_IN_CANVAS},set:function(t){},enumerable:!0,configurable:!0}),n.prototype.initWhenCreate=function(t){t.cloneToCubemapFaceTexture(this)},n.prototype.isSourcePowerOfTwo=function(){return t.BasicTextureUtils.isSourcePowerOfTwo(this.sourceRegion,this.sourceRegionMethod,this.width,this.height)},n.prototype.needClampMaxSize=function(){return this.source?t.BasicTextureUtils.needClampMaxSize(t.GPUDetector.getInstance().maxCubemapTextureSize,this.source.width,this.source.height):!1},n.prototype.clampToMaxSize=function(){var e=t.GPUDetector.getInstance().maxCubemapTextureSize;this.source=t.BasicTextureUtils.clampToMaxSize(this.source,e)},n.prototype.draw=function(e){var n=t.DrawNoMipmapTwoDTextureCommand.create(),r=t.DeviceManager.getInstance().gl;n.source=this.source,n.sourceRegion=this.sourceRegion,n.sourceRegionMethod=this.sourceRegionMethod,n.glTarget=r.TEXTURE_CUBE_MAP_POSITIVE_X+e,n.format=this.format,n.type=this.type,n.execute()},__decorate([t.requireSetter(function(e){t.assert(e===t.ETextureSourceRegionMethod.DRAW_IN_CANVAS,t.Log.info.FUNC_SUPPORT("cubemap twoD face texture->sourceRegionMethod only","DRAW_IN_CANVAS"))})],n.prototype,"sourceRegionMethod",null),n}(t.CubemapFaceTexture);t.CubemapFaceImageTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.mipmaps=null,this.minFilter=null}return __extends(n,e),n.create=function(t){var e=new this;return e.initWhenCreate(t),e},n.prototype.initWhenCreate=function(t){t.cloneToCubemapFaceTexture(this)},n.prototype.isSourcePowerOfTwo=function(){return t.BasicTextureUtils.isSourcePowerOfTwo(null,null,this.width,this.height)},n.prototype.needClampMaxSize=function(){return t.BasicTextureUtils.needClampMaxSize(t.GPUDetector.getInstance().maxCubemapTextureSize,this.width,this.height)},n.prototype.clampToMaxSize=function(){t.Log.warn("CubemapFaceCompressedTexture's texture size is over maxCubemapTextureSize")},n.prototype.draw=function(e){var n=t.DrawCompressedTextureCommand.create(),r=t.DeviceManager.getInstance().gl;n.glTarget=r.TEXTURE_CUBE_MAP_POSITIVE_X+e,n.type=this.type,n.format=this.format,n.mipmaps=this.mipmaps,n.execute()},n}(t.CubemapFaceTexture);t.CubemapFaceCompressedTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t){var e=new this(t);return e.initWhenCreate(),e},Object.defineProperty(n.prototype,"sourceRegionMethod",{get:function(){return t.Log.assert(this.p_sourceRegionMethod===t.ETextureSourceRegionMethod.DRAW_IN_CANVAS,"compressed texture not support ETextureSourceRegionMethod.DRAW_IN_CANVAS, will use ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL instead"),t.ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL},enumerable:!0,configurable:!0}),n.prototype.allocateSourceToTexture=function(e){var n=t.DeviceManager.getInstance().gl,r=t.DrawCompressedTextureCommand.create();r.glTarget=n.TEXTURE_2D,r.type=this.type,r.format=this.format,r.mipmaps=this.mipmaps,r.sourceRegion=this.sourceRegion,r.sourceRegionMethod=this.sourceRegionMethod,r.execute(),this.mipmaps.getCount()>1&&(this.generateMipmaps=!1)},n.prototype.needClampMaxSize=function(){return!1},n}(t.TwoDTexture);t.CompressedTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.format=null,this.type=null,this.sourceRegion=null,this.sourceRegionMethod=t.ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL,this.glTarget=null}return e.prototype.getDrawTarget=function(e,n){void 0===n&&(n=this.sourceRegion);var r=null;return r=t.BasicTextureUtils.isDrawPartOfTexture(n,this.sourceRegionMethod)?t.BasicTextureUtils.drawPartOfTextureByCanvas(e,n.width,n.height,n.x,n.y,n.width,n.height,0,0,n.width,n.height):e},e}();t.DrawTextureCommand=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.mipmaps=null}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.execute=function(){var e=t.DeviceManager.getInstance().gl,n=this;t.Log.error(null===this.format,t.Log.info.FUNC_NOT_SUPPORT(this.format)),this.format!==t.ETextureFormat.RGBA?this.mipmaps.forEach(function(t,r){e.compressedTexImage2D(n.glTarget,r,n.format,t.width,t.height,0,n.getDrawTarget(t.data))}):this.mipmaps.forEach(function(t,r){e.texImage2D(n.glTarget,r,e[n.format],t.width,t.height,0,e[n.format],e[n.type],n.getDrawTarget(t.data))})},n}(t.DrawTextureCommand);t.DrawCompressedTextureCommand=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.source=null}return __extends(n,e),n.prototype.drawTexture=function(e,n){var r=t.DeviceManager.getInstance().gl;r.texImage2D(this.glTarget,e,r[this.format],r[this.format],r[this.type],this.getDrawTarget(n))},n}(t.DrawTextureCommand);t.DrawTwoDTextureCommand=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.mipmaps=null}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.execute=function(){var t=this;this.mipmaps.forEach(function(e,n){t.drawTexture(n,e)})},e}(t.DrawTwoDTextureCommand);t.DrawMipmapTwoDTextureCommand=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.execute=function(){this.drawTexture(0,this.source)},e}(t.DrawTwoDTextureCommand);t.DrawNoMipmapTwoDTextureCommand=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t){var e=t.urlArr,n=t.onLoad,r=void 0===n?function(t){}:n,i=t.onError,o=void 0===i?function(t){}:i;this.url=null,this.source=null,this.isStop=!1,this._urlArr=null,this._onLoad=null,this._onError=null,this._urlArr=wdCb.Collection.create(e),this._onLoad=r,this._onError=o}return e.create=function(t){var e=new this(t);return e.initWhenCreate(),e},e.prototype.initWhenCreate=function(){this.url=this._getCanPlayUrl(),this.source=document.createElement("video"),this.source.src=this.url,this._bindEvent()},e.prototype.play=function(){this.isStop=!1,this.source.play()},e.prototype._getCanPlayUrl=function(){var e=this,n=null,r=[];return this._urlArr.forEach(function(t){var i=wdCb.PathUtils.extname(t);return r.push(i),e._canplay(i)?(n=t,wdCb.$BREAK):void 0}),t.Log.error(null===n,t.Log.info.FUNC_NOT_SUPPORT("browser",r.join(","))),n},e.prototype._canplay=function(e){var n=document.createElement("video"),r=null;switch(e){case".mp4":r='video/mp4; codecs="avc1.42e01e, mp4a.40.2"';break;case".ogv":r='video/ogg; codecs="theora, vorbis"';break;case".webm":r='video/webm; codecs="vp8, vorbis"';break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT(e))}return!!n.canPlayType&&""!==n.canPlayType(r)},e.prototype._bindEvent=function(){var t=this;this.source.addEventListener("canplaythrough",function(){t._onLoad(t)},!1),this.source.addEventListener("error",function(){t._onError("errorCode "+t.source.error.code)},!1),this.source.addEventListener("ended",function(){t.isStop=!0},!1)},e}();t.Video=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},e.prototype.play=function(e){var n=t.VideoLoader.getInstance().get(e),r=null;t.Log.error(!n,t.Log.info.FUNC_NOT_EXIST("video asset which id is "+e)),r=n.video,r.play()},e._instance=null,e}();t.VideoManager=e}(wd||(wd={}));var wd;!function(t){t.JudgeUtils.isNodeJs()?t.root=global:t.root=window}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.prototype.sendShaderVariables=function(t,e){},n.prototype.setShaderDefinition=function(t){e.prototype.setShaderDefinition.call(this,t,null)},__decorate([t.virtual],n.prototype,"sendShaderVariables",null),__decorate([t.virtual],n.prototype,"setShaderDefinition",null),n}(t.EngineShaderLib);t.ProceduralShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.frameBuffer=null,this._indexBuffer=null,this._vertexBuffer=null,this._shader=null,this._vaoManager=t.GPUDetector.getInstance().extensionVAO?t.VAOManager.create():null}return __extends(n,e),n.prototype.init=function(){e.prototype.init.call(this),this._initBuffer(),this._shader=this.createShader(),this._shader.init(),this._vaoManager&&this._vaoManager.init()},n.prototype.dispose=function(){e.prototype.dispose.call(this),this._indexBuffer.dispose(),this._vertexBuffer.dispose(),this._shader.dispose(),this._vaoManager&&this._vaoManager.dispose()},n.prototype.initFrameBuffer=function(){var e=this.frameBufferOperator,n=t.DeviceManager.getInstance().gl;this.frameBuffer=e.createFrameBuffer(),e.bindFrameBuffer(this.frameBuffer),e.attachTexture(n.TEXTURE_2D,this.texture.glTexture),e.check(),e.unBindAll()},n.prototype.renderFrameBufferTexture=function(e,n){this.frameBufferOperator.bindFrameBuffer(this.frameBuffer),this.texture.bindToUnit(0),this.frameBufferOperator.setViewport(),n.addCommand(this._createRenderCommand()),n.clear(),n.webglState=t.BasicState.create(),n.render(),this.frameBufferOperator.unBindFrameBuffer(),this.frameBufferOperator.restoreViewport()},n.prototype.disposeFrameBuffer=function(){var e=t.DeviceManager.getInstance().gl;e.deleteFramebuffer(this.frameBuffer)},n.prototype.getRenderList=function(){return null},n.prototype.isRenderListEmpty=function(){return!1},n.prototype._initBuffer=function(){t.BufferTable.hasBuffer(t.BufferTableKey.PROCEDURAL_VERTEX)?this._vertexBuffer=t.BufferTable.getBuffer(t.BufferTableKey.PROCEDURAL_VERTEX):(this._vertexBuffer=t.ArrayBuffer.create([1,1,-1,1,-1,-1,1,-1],2,t.EBufferType.FLOAT),t.BufferTable.addBuffer(t.BufferTableKey.PROCEDURAL_VERTEX,this._vertexBuffer)),t.BufferTable.hasBuffer(t.BufferTableKey.PROCEDURAL_INDEX)?this._indexBuffer=t.BufferTable.getBuffer(t.BufferTableKey.PROCEDURAL_INDEX):(this._indexBuffer=t.ElementBuffer.create([0,1,2,0,2,3],t.EBufferType.UNSIGNED_SHORT),t.BufferTable.addBuffer(t.BufferTableKey.PROCEDURAL_INDEX,this._indexBuffer))},n.prototype._createRenderCommand=function(){var e=t.ProceduralCommand.create();return e.vertexBuffer=this._vertexBuffer,e.indexBuffer=this._indexBuffer,e.shader=this._shader,e.vaoManager=this._vaoManager,e},n}(t.RenderTargetRenderer);t.ProceduralRenderTargetRenderer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.repeatRegion=t.RectRegion.create(0,0,1,1)}return __extends(n,e),Object.defineProperty(n.prototype,"sourceRegionForGLSL",{get:function(){return t.RectRegion.create(0,0,1,1)},enumerable:!0,configurable:!0}),n.prototype.initWhenCreate=function(){e.prototype.initWhenCreate.call(this),this.renderRate=0},n.prototype.getSamplerName=function(e){return this.getSamplerNameByVariableData(e,t.EVariableType.SAMPLER_2D)},__decorate([t.cloneAttributeAsCloneable()],n.prototype,"repeatRegion",void 0),n}(t.TwoDRenderTargetTexture);t.ProceduralTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="common_proceduralTexture"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e){this.sendAttributeBuffer(t,"a_positionVec2",e.vertexBuffer),t.sendAllBufferData(e.vaoManager)},e.prototype.setShaderDefinition=function(e){t.prototype.setShaderDefinition.call(this,e),this.addAttributeVariable(["a_positionVec2"])},e}(t.ProceduralShaderLib);t.CommonProceduralShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(t){e.call(this),this.type="fire_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=t}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.sendShaderVariables=function(e,n){var r=this._proceduralTexture;r.computeTime(),this.sendUniformData(e,"u_time",r.time),this.sendUniformData(e,"u_speed",r.speed),this.sendUniformData(e,"u_shift",r.shift),this.sendUniformData(e,"u_alphaThreshold",r.alphaThreshold),r.fireColorMap.forEach(function(n,r){e.sendStructureData("u_fireColor."+r,t.EVariableType.VECTOR_3,n.toVector3())})},n.prototype.setShaderDefinition=function(t){e.prototype.setShaderDefinition.call(this,t),this.addUniformVariable(["u_time","u_speed","u_shift","u_alphaThreshold","u_fireColor"])},n}(t.ProceduralShaderLib);t.FireProceduralShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t){var e=new this(t);return e.initWhenCreate(),e},n.prototype.createShader=function(){var e=t.CommonProceduralShader.create();return e.addLib(t.FireProceduralShaderLib.create(this.texture)),e},n}(t.ProceduralRenderTargetRenderer);t.FireProceduralRenderTargetRenderer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._fireColorMap=null,this.fireColorType=n.RED,this.speed=t.Vector2.create(.5,.3),this.alphaThreshold=.5,this.shift=1,this.time=0}return __extends(r,e),r.create=function(){var t=new this;return t.initWhenCreate(),t},Object.defineProperty(r.prototype,"fireColorMap",{get:function(){if(null!==this._fireColorMap)return this._fireColorMap;switch(this.fireColorType){case n.CUSTOM:return this._fireColorMap;case n.RED:return wdCb.Hash.create({c1:t.Color.create("rgb(0.5, 0.0, 0.1)"),c2:t.Color.create("rgb(0.9, 0.0, 0.0)"),c3:t.Color.create("rgb(0.2, 0.0, 0.0)"),c4:t.Color.create("rgb(1.0, 0.9, 0.0)"),c5:t.Color.create("rgb(0.1, 0.1, 0.1)"),c6:t.Color.create("rgb(0.9, 0.9, 0.9)")});case n.BLUE:return wdCb.Hash.create({c1:t.Color.create("rgb(0.1, 0.0, 0.5)"),c2:t.Color.create("rgb(0.0, 0.0, 0.5)"),c3:t.Color.create("rgb(0.1, 0.0, 0.2)"),c4:t.Color.create("rgb(0.0, 0.0, 1.0)"),c5:t.Color.create("rgb(0.1, 0.2, 0.3)"),c6:t.Color.create("rgb(0.0, 0.2, 0.9)")});case n.PURPLE:return wdCb.Hash.create({c1:t.Color.create("rgb(0.5, 0.0, 1.0)"),c2:t.Color.create("rgb(0.9, 0.0, 1.0)"),c3:t.Color.create("rgb(0.2, 0.0, 1.0)"),c4:t.Color.create("rgb(1.0, 0.9, 1.0)"),c5:t.Color.create("rgb(0.1, 0.1, 1.0)"),c6:t.Color.create("rgb(0.9, 0.9, 1.0)")});case n.GREEN:return wdCb.Hash.create({c1:t.Color.create("rgb(0.5, 1.0, 0.0)"),c2:t.Color.create("rgb(0.5, 1.0, 0.0)"),c3:t.Color.create("rgb(0.3, 0.4, 0.0)"),c4:t.Color.create("rgb(0.5, 1.0, 0.0)"),c5:t.Color.create("rgb(0.2, 0.0, 0.0)"),c6:t.Color.create("rgb(0.5, 1.0, 0.0)")});default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("fireColorType:"+this.fireColorType))}},set:function(t){this._fireColorMap=t},enumerable:!0,configurable:!0}),r.prototype.initWhenCreate=function(){e.prototype.initWhenCreate.call(this),this.renderRate=1},r.prototype.init=function(){return e.prototype.init.call(this),t.Director.getInstance().scene.addProceduralRenderTargetRenderer(t.FireProceduralRenderTargetRenderer.create(this)),this},r.prototype.computeTime=function(){this.time+=.1},__decorate([t.cloneAttributeAsBasicType()],r.prototype,"_fireColorMap",void 0),__decorate([t.requireSetter(function(e){t.assert(6===e.getCount(),t.Log.info.FUNC_SHOULD("contain 6 colors"))}),t.ensureGetter(function(e){t.assert(6===e.getCount(),t.Log.info.FUNC_SHOULD("contain 6 colors"))})],r.prototype,"fireColorMap",null),__decorate([t.cloneAttributeAsBasicType()],r.prototype,"fireColorType",void 0),__decorate([t.cloneAttributeAsCloneable()],r.prototype,"speed",void 0),__decorate([t.cloneAttributeAsBasicType()],r.prototype,"alphaThreshold",void 0),__decorate([t.cloneAttributeAsBasicType()],r.prototype,"shift",void 0),__decorate([t.cloneAttributeAsBasicType()],r.prototype,"time",void 0),r}(t.ProceduralTexture);t.FireProceduralTexture=e,function(t){t[t.CUSTOM=0]="CUSTOM",t[t.RED=1]="RED",t[t.PURPLE=2]="PURPLE",t[t.GREEN=3]="GREEN",t[t.BLUE=4]="BLUE"}(t.EFireProceduralTextureColorType||(t.EFireProceduralTextureColorType={}));var n=t.EFireProceduralTextureColorType}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t){var e=new this(t);return e.initWhenCreate(),e},n.prototype.createShader=function(){var e=t.CommonProceduralShader.create();return e.addLib(t.MarbleProceduralShaderLib.create(this.texture)),e},n}(t.ProceduralRenderTargetRenderer);t.MarbleProceduralRenderTargetRenderer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.tilesHeightNumber=3,this.tilesWidthNumber=3,this.amplitude=9,this.jointColor=t.Color.create("rgb(0.72, 0.72, 0.72)")}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},n.prototype.init=function(){return e.prototype.init.call(this),t.Director.getInstance().scene.addProceduralRenderTargetRenderer(t.MarbleProceduralRenderTargetRenderer.create(this)),this},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"tilesHeightNumber",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"tilesWidthNumber",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"amplitude",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"jointColor",void 0),n}(t.ProceduralTexture);t.MarbleProceduralTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(e){t.call(this),this.type="marble_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=e}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e.prototype.sendShaderVariables=function(t,e){var n=this._proceduralTexture;this.sendUniformData(t,"u_tilesHeightNumber",n.tilesHeightNumber),this.sendUniformData(t,"u_tilesWidthNumber",n.tilesWidthNumber),this.sendUniformData(t,"u_amplitude",n.amplitude),this.sendUniformData(t,"u_jointColor",n.jointColor.toVector3())},e.prototype.setShaderDefinition=function(e){t.prototype.setShaderDefinition.call(this,e),this.addUniformVariable(["u_tilesHeightNumber","u_tilesWidthNumber","u_amplitude","u_jointColor"])},e}(t.ProceduralShaderLib);t.MarbleProceduralShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t){var e=new this(t);return e.initWhenCreate(),e},n.prototype.createShader=function(){var e=t.CommonProceduralShader.create();return e.addLib(t.GrassProceduralShaderLib.create(this.texture)),e},n}(t.ProceduralRenderTargetRenderer);t.GrassProceduralRenderTargetRenderer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.herb1Color=t.Color.create("rgb(0.29, 0.38, 0.02)"),this.herb2Color=t.Color.create("rgb(0.36, 0.49, 0.09)"),this.herb3Color=t.Color.create("rgb(0.51, 0.6, 0.28)"),this.groundColor=t.Color.create("rgb(1.0,1.0,1.0)")}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},n.prototype.init=function(){return e.prototype.init.call(this),t.Director.getInstance().scene.addProceduralRenderTargetRenderer(t.GrassProceduralRenderTargetRenderer.create(this)),this},__decorate([t.cloneAttributeAsCloneable()],n.prototype,"herb1Color",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"herb2Color",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"herb3Color",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"groundColor",void 0),n}(t.ProceduralTexture);t.GrassProceduralTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(e){t.call(this),this.type="grass_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=e}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e.prototype.sendShaderVariables=function(t,e){var n=this._proceduralTexture;this.sendUniformData(t,"u_herb1Color",n.herb1Color.toVector3()),this.sendUniformData(t,"u_herb2Color",n.herb2Color.toVector3()),this.sendUniformData(t,"u_herb3Color",n.herb3Color.toVector3()),this.sendUniformData(t,"u_groundColor",n.groundColor.toVector3())},e.prototype.setShaderDefinition=function(e){t.prototype.setShaderDefinition.call(this,e),this.addUniformVariable(["u_herb1Color","u_herb2Color","u_herb3Color","u_groundColor"])},e}(t.ProceduralShaderLib);t.GrassProceduralShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t){var e=new this(t);return e.initWhenCreate(),e},n.prototype.createShader=function(){var e=t.CommonProceduralShader.create();return e.addLib(t.WoodProceduralShaderLib.create(this.texture)),e},n}(t.ProceduralRenderTargetRenderer);t.WoodProceduralRenderTargetRenderer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.ampScale=100,this.woodColor=t.Color.create("rgb(0.32, 0.17, 0.09)")}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},n.prototype.init=function(){return e.prototype.init.call(this),t.Director.getInstance().scene.addProceduralRenderTargetRenderer(t.WoodProceduralRenderTargetRenderer.create(this)),this},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"ampScale",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"woodColor",void 0),n}(t.ProceduralTexture);t.WoodProceduralTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(e){t.call(this),this.type="wood_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=e}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e.prototype.sendShaderVariables=function(t,e){var n=this._proceduralTexture;this.sendUniformData(t,"u_ampScale",n.ampScale),this.sendUniformData(t,"u_woodColor",n.woodColor.toVector3())},e.prototype.setShaderDefinition=function(e){t.prototype.setShaderDefinition.call(this,e),this.addUniformVariable(["u_ampScale","u_woodColor"])},e}(t.ProceduralShaderLib);t.WoodProceduralShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t){var e=new this(t);return e.initWhenCreate(),e},n.prototype.createShader=function(){var e=t.CommonProceduralShader.create();return e.addLib(t.RoadProceduralShaderLib.create(this.texture)),e},n}(t.ProceduralRenderTargetRenderer);t.RoadProceduralRenderTargetRenderer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.roadColor=t.Color.create("rgb(0.53, 0.53, 0.53)")}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},n.prototype.init=function(){return e.prototype.init.call(this),t.Director.getInstance().scene.addProceduralRenderTargetRenderer(t.RoadProceduralRenderTargetRenderer.create(this)),this},__decorate([t.cloneAttributeAsCloneable()],n.prototype,"roadColor",void 0),n}(t.ProceduralTexture);t.RoadProceduralTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(e){t.call(this),this.type="road_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=e}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e.prototype.sendShaderVariables=function(t,e){var n=this._proceduralTexture;this.sendUniformData(t,"u_roadColor",n.roadColor.toVector3())},e.prototype.setShaderDefinition=function(e){t.prototype.setShaderDefinition.call(this,e),this.addUniformVariable(["u_roadColor"])},e}(t.ProceduralShaderLib);t.RoadProceduralShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t){var e=new this(t);return e.initWhenCreate(),e},n.prototype.createShader=function(){var e=t.CommonProceduralShader.create();return e.addLib(t.CloudProceduralShaderLib.create(this.texture)),e},n}(t.ProceduralRenderTargetRenderer);t.CloudProceduralRenderTargetRenderer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.skyColor=t.Color.create("rgb(0.15, 0.68, 1.0)"),this.cloudColor=t.Color.create("rgb(1.0, 1.0, 1.0)")}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},n.prototype.init=function(){return e.prototype.init.call(this),t.Director.getInstance().scene.addProceduralRenderTargetRenderer(t.CloudProceduralRenderTargetRenderer.create(this)),this},__decorate([t.cloneAttributeAsCloneable()],n.prototype,"skyColor",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"cloudColor",void 0),n}(t.ProceduralTexture);t.CloudProceduralTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(e){t.call(this),this.type="cloud_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=e}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e.prototype.sendShaderVariables=function(t,e){var n=this._proceduralTexture;this.sendUniformData(t,"u_skyColor",n.skyColor.toVector4()),this.sendUniformData(t,"u_cloudColor",n.cloudColor.toVector4())},e.prototype.setShaderDefinition=function(e){t.prototype.setShaderDefinition.call(this,e),this.addUniformVariable(["u_skyColor","u_cloudColor"])},e}(t.ProceduralShaderLib);t.CloudProceduralShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t){var e=new this(t);return e.initWhenCreate(),e},n.prototype.createShader=function(){var e=t.CommonProceduralShader.create();return e.addLib(t.BrickProceduralShaderLib.create(this.texture)),e},n}(t.ProceduralRenderTargetRenderer);t.BrickProceduralRenderTargetRenderer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.tilesHeightNumber=15,this.tilesWidthNumber=5,this.brickColor=t.Color.create("rgb(0.77, 0.47, 0.40)"),this.jointColor=t.Color.create("rgb(0.72, 0.72, 0.72)")}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},n.prototype.init=function(){return e.prototype.init.call(this),t.Director.getInstance().scene.addProceduralRenderTargetRenderer(t.BrickProceduralRenderTargetRenderer.create(this)),this},__decorate([t.cloneAttributeAsBasicType()],n.prototype,"tilesHeightNumber",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"tilesWidthNumber",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"brickColor",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"jointColor",void 0),n}(t.ProceduralTexture);t.BrickProceduralTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(e){t.call(this),this.type="brick_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=e}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e.prototype.sendShaderVariables=function(t,e){var n=this._proceduralTexture;this.sendUniformData(t,"u_tilesWidthNumber",n.tilesWidthNumber),this.sendUniformData(t,"u_tilesHeightNumber",n.tilesHeightNumber),this.sendUniformData(t,"u_brickColor",n.brickColor.toVector3()),this.sendUniformData(t,"u_jointColor",n.jointColor.toVector3())},e.prototype.setShaderDefinition=function(e){t.prototype.setShaderDefinition.call(this,e),this.addUniformVariable(["u_tilesHeightNumber","u_tilesWidthNumber","u_brickColor","u_jointColor"])},e}(t.ProceduralShaderLib);t.BrickProceduralShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t){var e=new this(t);return e.initWhenCreate(),e},n.prototype.createShader=function(){var e=t.CustomProceduralShader.create(this.texture);return e.addLib(t.CustomProceduralShaderLib.create(this.texture)),e},n}(t.ProceduralRenderTargetRenderer);t.CustomProceduralRenderTargetRenderer=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.mapManager=t.MapManager.create(),this.uniformMap=wdCb.Hash.create(),this.fsSource=null}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},n.prototype.init=function(){return e.prototype.init.call(this),t.Director.getInstance().scene.addProceduralRenderTargetRenderer(t.CustomProceduralRenderTargetRenderer.create(this)),this},n.prototype.read=function(e){var n=t.LoaderManager.getInstance().get(e),r=n.uniforms;this.fsSource=t.LoaderManager.getInstance().get(n.fsSourceId),this.renderRate=n.renderRate||0;for(var i in r)if(r.hasOwnProperty(i)){var o=r[i];o.type===t.EVariableType.SAMPLER_2D?this.mapManager.addMap(t.LoaderManager.getInstance().get(o.textureId),{samplerVariableName:i}):this.uniformMap.addChild(i,o)}},__decorate([t.cloneAttributeAsCustomType(function(t,e,n){t[n].getMapList().forEach(function(t){e[n].addMap(t.clone())})})],n.prototype,"mapManager",void 0),__decorate([t.cloneAttributeAsCloneable()],n.prototype,"uniformMap",void 0),__decorate([t.cloneAttributeAsBasicType()],n.prototype,"fsSource",void 0),__decorate([t.require(function(e){var n=t.LoaderManager.getInstance().get(e),r=n.uniforms;for(var i in r)if(r.hasOwnProperty(i)){var o=r[i];t.assert(o.type!==t.EVariableType.SAMPLER_CUBE,t.Log.info.FUNC_NOT_SUPPORT("uniforms","EVariableType.SAMPLER_CUBE type"))}}),t.ensure(function(){t.assert(null!==this.fsSource,t.Log.info.FUNC_SHOULD("read fragment glsl source"))})],n.prototype,"read",null),n}(t.ProceduralTexture);t.CustomProceduralTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(t){e.call(this),this.type="custom_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=t}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.sendShaderVariables=function(e,n){var r=this._proceduralTexture,i=r.uniformMap;i.forEach(function(n,r){t.CustomShaderLibUtils.sendUniformData(r,n.type,n.value,e)})},n.prototype.setShaderDefinition=function(t){var n=this._proceduralTexture;e.prototype.setShaderDefinition.call(this,t),this.setFsSource(n.fsSource)},n}(t.ProceduralShaderLib);t.CustomProceduralShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.layer=n.create()}return __extends(r,e),r.create=function(){var t=new this;return t.initWhenCreate(),t},r.prototype.init=function(){this.mapManager.addMapArray("u_layerSampler2Ds",this.layer.mapArray),e.prototype.init.call(this)},r.prototype.addExtendShaderLib=function(){this.layer.mapDataList.getCount()>0&&this.shader.addLib(t.TerrainLayerShaderLib.create())},__decorate([t.cloneAttributeAsCloneable()],r.prototype,"layer",void 0),r}(t.StandardLightMaterial);t.TerrainMaterial=e;var n=function(){function e(){this._mapDataList=wdCb.Collection.create()}return e.create=function(){var t=new this;return t},Object.defineProperty(e.prototype,"mapDataList",{get:function(){return this._mapDataList},set:function(t){this._mapDataList=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"mapArray",{get:function(){var t=[];return this._mapDataList.forEach(function(e){t.push(e.diffuseMap)}),t},enumerable:!0,configurable:!0}),e.prototype.clone=function(){return t.CloneUtils.clone(this)},__decorate([t.requireSetter(function(e){e.forEach(function(e){t.assert(e.minHeight<e.maxHeight,t.Log.info.FUNC_SHOULD("minHeight","< maxHeight"))}),e.forEach(function(n){e.filter(function(t){return t.minHeight!==n.minHeight||t.maxHeight!==n.maxHeight}).forEach(function(e){t.assert(n.minHeight>=e.maxHeight||n.maxHeight<=e.minHeight,t.Log.info.FUNC_SHOULD_NOT("height range","overlap"))})})}),t.cloneAttributeAsCloneable()],e.prototype,"mapDataList",null),__decorate([t.ensureGetter(function(e){for(var n=0,r=e;n<r.length;n++){var i=r[n];t.assert(i instanceof t.Texture,t.Log.info.FUNC_SHOULD("return Array<Texture>"));
}})],e.prototype,"mapArray",null),e}();t.TerrainLayerMapModel=n}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="terrainLayer"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(e,n,r){r.layer.mapDataList.forEach(function(n,r){e.sendStructureData("u_layerHeightDatas["+r+"].minHeight",t.EVariableType.FLOAT_1,n.minHeight),e.sendStructureData("u_layerHeightDatas["+r+"].maxHeight",t.EVariableType.FLOAT_1,n.maxHeight)})},n.prototype.setShaderDefinition=function(t,n){e.prototype.setShaderDefinition.call(this,t,n),this.addUniformVariable(["u_layerHeightDatas","u_layerSampler2Ds"]),this.fsSourceDefineList.addChildren([{name:"LAYER_COUNT",value:n.layer.mapDataList.getCount()}])},__decorate([t.require(function(e,n){t.assert(!!n,t.Log.info.FUNC_NOT_EXIST("param:material")),t.assert(n.layer.mapDataList.getCount()>=0,t.Log.info.FUNC_SHOULD("TerrainMaterial->layer->mapDataList->count",">= 0"))})],n.prototype,"setShaderDefinition",null),n}(t.EngineShaderLib);t.TerrainLayerShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function i(){e.apply(this,arguments),this._bumpMap=null,this._reflectionMap=null,this._refractionMap=null,this.wind=n.create(),this.wave=r.create(),this.fresnelLevel=1,this.reflectionLevel=.6,this.refractionLevel=.8}return __extends(i,e),i.create=function(){var t=new this;return t.initWhenCreate(),t},Object.defineProperty(i.prototype,"bumpMap",{get:function(){return this._bumpMap},set:function(e){e.wrapS=t.ETextureWrapMode.REPEAT,e.wrapT=t.ETextureWrapMode.REPEAT,this.mapManager.addMap(e,{samplerVariableName:t.VariableNameTable.getVariableName("bumpMap")}),this._bumpMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"reflectionMap",{get:function(){return this._reflectionMap},set:function(e){this.mapManager.addMap(e,{samplerVariableName:t.VariableNameTable.getVariableName("reflectionMap")}),this._reflectionMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"refractionMap",{get:function(){return this._refractionMap},set:function(e){this.mapManager.addMap(e,{samplerVariableName:t.VariableNameTable.getVariableName("refractionMap")}),this._refractionMap=e},enumerable:!0,configurable:!0}),i.prototype.updateShader=function(t){this._computeTime(),e.prototype.updateShader.call(this,t)},i.prototype.addExtendShaderLib=function(){this.bumpMap?this.shader.addLib(t.WaterBumpMapShaderLib.create()):this.shader.addLib(t.WaterNoBumpMapShaderLib.create()),this.shader.addLib(t.WaterShaderLib.create()),this.reflectionMap&&this.refractionMap?this.shader.addLib(t.WaterFresnelShaderLib.create()):this.reflectionMap?this.shader.addLib(t.WaterReflectionMapShaderLib.create()):this.refractionMap?this.shader.addLib(t.WaterRefractionMapShaderLib.create()):this.shader.addLib(t.WaterNoLightEffectShaderLib.create())},i.prototype._computeTime=function(){this.wind.time+=1e-4},__decorate([t.requireSetter(function(e){t.assert(e instanceof t.ImageTexture)}),t.cloneAttributeAsCloneable()],i.prototype,"bumpMap",null),__decorate([t.cloneAttributeAsCloneable()],i.prototype,"reflectionMap",null),__decorate([t.cloneAttributeAsCloneable()],i.prototype,"refractionMap",null),__decorate([t.cloneAttributeAsCloneable()],i.prototype,"wind",void 0),__decorate([t.cloneAttributeAsCloneable()],i.prototype,"wave",void 0),__decorate([t.cloneAttributeAsBasicType()],i.prototype,"fresnelLevel",void 0),__decorate([t.cloneAttributeAsBasicType()],i.prototype,"reflectionLevel",void 0),__decorate([t.cloneAttributeAsBasicType()],i.prototype,"refractionLevel",void 0),i}(t.StandardLightMaterial);t.WaterMaterial=e;var n=function(){function e(){this.time=0,this.direction=t.Vector2.create(0,1)}return e.create=function(){var t=new this;return t},Object.defineProperty(e.prototype,"matrix",{get:function(){return t.Matrix4.create().translate(this.direction.x*this.time,this.direction.y*this.time,0)},enumerable:!0,configurable:!0}),e.prototype.clone=function(){return t.CloneUtils.clone(this)},__decorate([t.cloneAttributeAsBasicType()],e.prototype,"time",void 0),__decorate([t.cloneAttributeAsBasicType()],e.prototype,"direction",void 0),e}();t.WaterWindModel=n;var r=function(){function e(){this.height=.15,this.length=.1}return e.create=function(){var t=new this;return t},e.prototype.clone=function(){return t.CloneUtils.clone(this)},__decorate([t.cloneAttributeAsBasicType()],e.prototype,"height",void 0),__decorate([t.cloneAttributeAsBasicType()],e.prototype,"length",void 0),e}();t.WaterWaveModel=r}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="water"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(e,n,r){e.sendStructureData("u_waveData.length",t.EVariableType.FLOAT_1,r.wave.length),e.sendStructureData("u_waveData.height",t.EVariableType.FLOAT_1,r.wave.height)},n.prototype.setShaderDefinition=function(t,n){e.prototype.setShaderDefinition.call(this,t,n),this.addUniformVariable(["u_waveData"])},n}(t.EngineShaderLib);t.WaterShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="water_reflection"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(e,n,r){t.RenderTargerRendererShaderLibUtils.judgeAndSendIsRenderListEmptyVariable(e,t.EShaderGLSLData.MIRROR,"u_isReflectionRenderListEmpty"),e.sendStructureData("u_levelData.reflectionLevel",t.EVariableType.FLOAT_1,r.reflectionLevel)},n.prototype.setShaderDefinition=function(n,r){e.prototype.setShaderDefinition.call(this,n,r),this.addUniformVariable(["u_levelData","u_isReflectionRenderListEmpty",t.VariableNameTable.getVariableName("reflectionMap")])},n}(t.EngineShaderLib);t.WaterReflectionMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="water_refraction"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(e,n,r){t.RenderTargerRendererShaderLibUtils.judgeAndSendIsRenderListEmptyVariable(e,t.EShaderGLSLData.REFRACTION,"u_isRefractionRenderListEmpty"),e.sendStructureData("u_levelData.refractionLevel",t.EVariableType.FLOAT_1,r.refractionLevel)},n.prototype.setShaderDefinition=function(n,r){e.prototype.setShaderDefinition.call(this,n,r),this.addUniformVariable(["u_levelData","u_isRefractionRenderListEmpty",t.VariableNameTable.getVariableName("refractionMap")])},n}(t.EngineShaderLib);t.WaterRefractionMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="water_fresnel"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(e,n,r){t.RenderTargerRendererShaderLibUtils.judgeAndSendIsRenderListEmptyVariable(e,t.EShaderGLSLData.MIRROR,"u_isReflectionRenderListEmpty"),t.RenderTargerRendererShaderLibUtils.judgeAndSendIsRenderListEmptyVariable(e,t.EShaderGLSLData.REFRACTION,"u_isRefractionRenderListEmpty"),e.sendStructureData("u_levelData.fresnelLevel",t.EVariableType.FLOAT_1,r.fresnelLevel),e.sendStructureData("u_levelData.refractionLevel",t.EVariableType.FLOAT_1,r.refractionLevel),e.sendStructureData("u_levelData.reflectionLevel",t.EVariableType.FLOAT_1,r.reflectionLevel)},n.prototype.setShaderDefinition=function(n,r){e.prototype.setShaderDefinition.call(this,n,r),this.addUniformVariable(["u_levelData","u_isReflectionRenderListEmpty","u_isRefractionRenderListEmpty",t.VariableNameTable.getVariableName("reflectionMap"),t.VariableNameTable.getVariableName("refractionMap")])},n}(t.EngineShaderLib);t.WaterFresnelShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="water_noLightEffect"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){},e}(t.EngineShaderLib);t.WaterNoLightEffectShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="water_bump"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(e,n,r){e.sendUniformData("u_windMatrix",t.EVariableType.FLOAT_MAT4,r.wind.matrix)},n.prototype.setShaderDefinition=function(n,r){e.prototype.setShaderDefinition.call(this,n,r),this.addUniformVariable([t.VariableNameTable.getVariableName("bumpMap"),"u_windMatrix"])},n}(t.EngineShaderLib);t.WaterBumpMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="water_noBump"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){},e}(t.EngineShaderLib);t.WaterNoBumpMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._reflectionMap=null}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},Object.defineProperty(n.prototype,"reflectionMap",{get:function(){return this._reflectionMap},set:function(e){this.mapManager.addMap(e,{samplerVariableName:t.VariableNameTable.getVariableName("reflectionMap")}),this._reflectionMap=e},enumerable:!0,configurable:!0}),n.prototype.addExtendShaderLib=function(){this.reflectionMap&&this.shader.addLib(t.MirrorShaderLib.create())},__decorate([t.cloneAttributeAsCloneable()],n.prototype,"reflectionMap",null),n}(t.StandardLightMaterial);t.MirrorMaterial=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="mirror"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(e,n,r){t.RenderTargerRendererShaderLibUtils.judgeAndSendIsRenderListEmptyVariable(e,t.EShaderGLSLData.MIRROR)},n.prototype.setShaderDefinition=function(n,r){e.prototype.setShaderDefinition.call(this,n,r),this.addUniformVariable(["u_isRenderListEmpty",t.VariableNameTable.getVariableName("reflectionMap")])},n}(t.EngineShaderLib);t.MirrorShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},e.prototype.update=function(t){var e=[];this.list.forEach(function(n){return n.isFinish?void e.push(n):void(n.isStop||n.isPause||n.update(t))});for(var n=0,r=e;n<r.length;n++){var i=r[n];i.entityObject.removeComponent(i)}},e._instance=null,e}(t.ComponentContainer);t.ActionEngine=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){this._scriptList=wdCb.Collection.create()}return t.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},t.prototype.addChild=function(t,e,n){t.scriptManager.addChild(e,n),this._scriptList.addChild(n)},t.prototype.removeChild=function(t,e){t.scriptManager.removeChild(e),this._scriptList.removeChild(e)},t.prototype.removeAllChildren=function(){this._scriptList.removeAllChildren()},t.prototype.findScript=function(t,e){return t.scriptManager.getChild(e)},t.prototype.execEntityObjectScript=function(t,e){t.scriptManager.execScript(e)},t.prototype.execEntityObjectScriptOnlyOnce=function(t,e){t.scriptManager.execScriptOnlyOnce(e)},t.prototype.execEntityObjectScriptWithData=function(t,e,n){t.scriptManager.execScriptWithData(e,n)},t.prototype.execScript=function(t){this._scriptList.forEach(function(e){e[t]&&e[t]()})},t.prototype.execScriptWithData=function(t,e){this._scriptList.forEach(function(n){n[t]&&n[t](e)})},t.prototype.execEntityObjectEventScriptWithData=function(t,e,n){t.scriptManager.execEventScriptWithData(e,n)},t._instance=null,t}();t.ScriptEngine=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},e.prototype.update=function(t){this.list.forEach(function(e){e.update(t)})},e._instance=null,e}(t.ComponentContainer);t.LODEngine=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},e.prototype.update=function(t){this.list.forEach(function(e){e.update(t)})},e._instance=null,e}(t.ComponentContainer);t.SpacePartitionEngine=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},e.prototype.update=function(t){this.list.forEach(function(e){e.update(t)})},e._instance=null,e}(t.ComponentContainer);t.AnimationEngine=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._collisionDetector=t.CollisionDetector.create()}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.update=function(t){this.list.forEach(function(e){e.update(t)})},n.prototype.detect=function(t){this._collisionDetector.update(t)},n._instance=null,n}(t.ComponentContainer);t.ColliderEngine=e}(wd||(wd={}));var wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},e.prototype.initBody=function(){this.list.forEach(function(t){t.initBody()})},e.prototype.initConstraint=function(){this.list.forEach(function(t){t.initConstraint()})},e._instance=null,e}(t.ComponentContainer);t.RigidBodyEngine=e}(wd||(wd={}));var wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.update=function(t){this.list.forEach(function(e){e.update(t)})},n.prototype.render=function(){var t=this;this.list.forEach(function(e){t._isDirty(e.entityObject)&&e.render()},this)},n.prototype._isDirty=function(e){return e.getComponent(t.UIRenderer).state===t.EUIRendererState.DIRTY},n._instance=null,n}(t.ComponentContainer);t.UIEngine=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t.empty={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},t.NULL=-1,t.normal_morph_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"vec3 a_normal = a_currentFrameNormal + (a_nextFrameNormal - a_currentFrameNormal) * u_interpolation;\n"},t.vertice_morph_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"vec3 a_position = a_currentFramePosition + (a_nextFramePosition - a_currentFramePosition) * u_interpolation;\n"},t.basic_fragment={top:"",define:"",varDeclare:"varying vec3 v_color;\n",funcDeclare:"",funcDefine:"",body:"vec4 totalColor = vec4(v_color, 1.0);\n"},t.basic_vertex={top:"",define:"",varDeclare:"varying vec3 v_color;\n",funcDeclare:"",funcDefine:"",body:"v_color = a_color;\n"},t.end_basic_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_FragColor = vec4(totalColor.rgb, totalColor.a * u_opacity);\n"},t.common_define={top:"",define:"#define NULL -1.0\n",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},t.common_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},t.common_function={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"mat2 transpose(mat2 m) {\n  return mat2(  m[0][0], m[1][0],   // new col 0\n                m[0][1], m[1][1]    // new col 1\n             );\n  }\nmat3 transpose(mat3 m) {\n  return mat3(  m[0][0], m[1][0], m[2][0],  // new col 0\n                m[0][1], m[1][1], m[2][1],  // new col 1\n                m[0][2], m[1][2], m[2][2]   // new col 1\n             );\n  }\n\nbool isRenderListEmpty(int isRenderListEmpty){\n  return isRenderListEmpty == 1;\n}\n",body:""},t.common_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},t.highp_fragment={top:"precision highp float;\nprecision highp int;\n",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},t.lowp_fragment={top:"precision lowp float;\nprecision lowp int;\n",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},t.mediump_fragment={top:"precision mediump float;\nprecision mediump int;\n",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},t.common_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec3 flipNormal(vec3 normal){\n    vec3 normalForRefraction = normal;\n    normalForRefraction.y = -normalForRefraction.y;\n    normalForRefraction.z = -normalForRefraction.z;\n\n    return normalForRefraction;\n}\n",body:""},t.lightCommon_fragment={top:"",define:"",varDeclare:"varying vec3 v_worldPosition;\n#if POINT_LIGHTS_COUNT > 0\nstruct PointLight {\n    vec3 position;\n    vec4 color;\n    float intensity;\n\n    float range;\n    float constant;\n    float linear;\n    float quadratic;\n};\nuniform PointLight u_pointLights[POINT_LIGHTS_COUNT];\n\n#endif\n\n\n#if DIRECTION_LIGHTS_COUNT > 0\nstruct DirectionLight {\n    vec3 position;\n\n    float intensity;\n\n    vec4 color;\n};\nuniform DirectionLight u_directionLights[DIRECTION_LIGHTS_COUNT];\n#endif\n",funcDeclare:"",funcDefine:"",body:""},t.lightCommon_vertex={top:"",define:"",varDeclare:"varying vec3 v_worldPosition;\n#if POINT_LIGHTS_COUNT > 0\nstruct PointLight {\n    vec3 position;\n    vec4 color;\n    float intensity;\n\n    float range;\n    float constant;\n    float linear;\n    float quadratic;\n};\nuniform PointLight u_pointLights[POINT_LIGHTS_COUNT];\n\n#endif\n\n\n#if DIRECTION_LIGHTS_COUNT > 0\nstruct DirectionLight {\n    vec3 position;\n\n    float intensity;\n\n    vec4 color;\n};\nuniform DirectionLight u_directionLights[DIRECTION_LIGHTS_COUNT];\n#endif\n",funcDeclare:"",funcDefine:"",body:"v_worldPosition = vec3(mMatrix * vec4(a_position, 1.0));\n"},t.lightEnd_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_FragColor = vec4(totalColor.rgb, totalColor.a * u_opacity);\n"},t.light_common={top:"",define:"",varDeclare:"",funcDeclare:"vec3 getDirectionLightDirByLightPos(vec3 lightPos);\nvec3 getPointLightDirByLightPos(vec3 lightPos);\nvec3 getPointLightDirByLightPos(vec3 lightPos, vec3 worldPosition);\n",funcDefine:"vec3 getDirectionLightDirByLightPos(vec3 lightPos){\n    return lightPos - vec3(0.0);\n    //return vec3(0.0) - lightPos;\n}\nvec3 getPointLightDirByLightPos(vec3 lightPos){\n    return lightPos - v_worldPosition;\n}\nvec3 getPointLightDirByLightPos(vec3 lightPos, vec3 worldPosition){\n    return lightPos - worldPosition;\n}\n",body:""},t.light_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float getBlinnShininess(float shininess, vec3 normal, vec3 lightDir, vec3 viewDir, float dotResultBetweenNormAndLight){\n        vec3 halfAngle = normalize(lightDir + viewDir);\n        float blinnTerm = dot(normal, halfAngle);\n\n        blinnTerm = clamp(blinnTerm, 0.0, 1.0);\n        blinnTerm = dotResultBetweenNormAndLight != 0.0 ? blinnTerm : 0.0;\n        blinnTerm = pow(blinnTerm, shininess);\n\n        return blinnTerm;\n}\n\nfloat getPhongShininess(float shininess, vec3 normal, vec3 lightDir, vec3 viewDir, float dotResultBetweenNormAndLight){\n        vec3 reflectDir = reflect(-lightDir, normal);\n        float phongTerm = dot(viewDir, reflectDir);\n\n        phongTerm = clamp(phongTerm, 0.0, 1.0);\n        phongTerm = dotResultBetweenNormAndLight != 0.0 ? phongTerm : 0.0;\n        phongTerm = pow(phongTerm, shininess);\n\n        return phongTerm;\n}\n\nvec4 calcLight(vec3 lightDir, vec4 color, float intensity, float attenuation, vec3 normal, vec3 viewDir)\n{\n        vec4 materialLight = getMaterialLight();\n        vec4 materialDiffuse = getMaterialDiffuse();\n        vec4 materialSpecular = getMaterialSpecular();\n        vec4 materialEmission = getMaterialEmission();\n\n        float dotResultBetweenNormAndLight = dot(normal, lightDir);\n        float diff = max(dotResultBetweenNormAndLight, 0.0);\n\n        vec4 emissionColor = materialEmission;\n\n        vec4 ambientColor = (u_ambient + materialLight) * materialDiffuse;\n\n\n        if(u_lightModel == 3){\n            return emissionColor + ambientColor;\n        }\n\n\n        vec4 diffuseColor = color * materialDiffuse;\n\n        //not affect alpha data\n        diffuseColor = vec4(diff * vec3(diffuseColor) * intensity, diffuseColor.a);\n\n\n        float spec = 0.0;\n\n        if(u_lightModel == 2){\n                spec = getPhongShininess(u_shininess, normal, lightDir, viewDir, diff);\n        }\n        else if(u_lightModel == 1){\n                spec = getBlinnShininess(u_shininess, normal, lightDir, viewDir, diff);\n        }\n\n        //not affect alpha data\n        vec4 specularColor = vec4(spec * vec3(materialSpecular) * intensity, materialSpecular.a);\n\n        vec4 tColor = diffuseColor + specularColor;\n\n        //not affect alpha data\n        return emissionColor + ambientColor + vec4(attenuation * vec3(tColor), tColor.a);\n}\n\n\n\n\n#if POINT_LIGHTS_COUNT > 0\n        vec4 calcPointLight(vec3 lightDir, PointLight light, vec3 normal, vec3 viewDir)\n{\n        //lightDir is not normalize computing distance\n        float distance = length(lightDir);\n\n        float attenuation = 0.0;\n\n        if(light.range == NULL || distance < light.range)\n        {\n            attenuation = 1.0 / (light.constant + light.linear * distance + light.quadratic * (distance * distance));\n        }\n\n        lightDir = normalize(lightDir);\n\n        return calcLight(lightDir, light.color, light.intensity, attenuation, normal, viewDir);\n}\n#endif\n\n\n\n#if DIRECTION_LIGHTS_COUNT > 0\n        vec4 calcDirectionLight(vec3 lightDir, DirectionLight light, vec3 normal, vec3 viewDir)\n{\n        float attenuation = 1.0;\n\n        lightDir = normalize(lightDir);\n\n        return calcLight(lightDir, light.color, light.intensity, attenuation, normal, viewDir);\n}\n#endif\n\n\n\nvec4 calcTotalLight(vec3 norm, vec3 viewDir){\n    vec4 totalLight = vec4(0.0);\n\n    #if POINT_LIGHTS_COUNT > 0\n                for(int i = 0; i < POINT_LIGHTS_COUNT; i++){\n                totalLight += calcPointLight(getPointLightDir(i), u_pointLights[i], norm, viewDir);\n        }\n    #endif\n\n    #if DIRECTION_LIGHTS_COUNT > 0\n                for(int i = 0; i < DIRECTION_LIGHTS_COUNT; i++){\n                totalLight += calcDirectionLight(getDirectionLightDir(i), u_directionLights[i], norm, viewDir);\n        }\n    #endif\n\n        return totalLight;\n}\n",body:"vec3 normal = normalize(getNormal());\n\n#ifdef BOTH_SIDE\nnormal = normal * (-1.0 + 2.0 * float(gl_FrontFacing));\n#endif\n\nvec3 viewDir = normalize(getViewDir());\n\nvec4 totalColor = calcTotalLight(normal, viewDir);\n\ntotalColor *= vec4(getShadowVisibility(), 1.0);\n"},t.light_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_Position = u_pMatrix * u_vMatrix * vec4(v_worldPosition, 1.0);\n"},t.map_forBasic_fragment={top:"",define:"",varDeclare:"varying vec2 v_mapCoord0;\n",funcDeclare:"",funcDefine:"",body:"totalColor *= vec4(texture2D(u_sampler2D0, v_mapCoord0).xyz, 1.0);\n"},t.map_forBasic_vertex={top:"",define:"",varDeclare:"varying vec2 v_mapCoord0;\n",funcDeclare:"",funcDefine:"",body:"vec2 sourceTexCoord0 = a_texCoord * u_map0SourceRegion.zw + u_map0SourceRegion.xy;\n\n    v_mapCoord0 = sourceTexCoord0 * u_map0RepeatRegion.zw + u_map0RepeatRegion.xy;\n"},t.multi_map_forBasic_fragment={top:"",define:"",varDeclare:"varying vec2 v_mapCoord0;\nvarying vec2 v_mapCoord1;\n",funcDeclare:"",funcDefine:"vec4 getMapColor(){\n            vec4 color0 = vec4(texture2D(u_sampler2D0, v_mapCoord0).xyz, 1.0);\n            vec4 color1 = vec4(texture2D(u_sampler2D1, v_mapCoord1).xyz, 1.0);\n\n            if(u_combineMode == 0){\n                return mix(color0, color1, u_mixRatio);\n            }\n            else if(u_combineMode == 1){\n                return color0 * color1;\n            }\n            else if(u_combineMode == 2){\n                return color0 + color1;\n            }\n\n            /*!\n            solve error in window7 chrome/firefox:\n            not all control paths return a value.\n            failed to create d3d shaders\n            */\n            return vec4(1.0);\n		}\n",body:"totalColor *= getMapColor();\n"},t.multi_map_forBasic_vertex={top:"",define:"",varDeclare:"varying vec2 v_mapCoord1;\n",funcDeclare:"",funcDefine:"",body:"vec2 sourceTexCoord1 = a_texCoord * u_map1SourceRegion.zw + u_map1SourceRegion.xy;\n\n    v_mapCoord1 = sourceTexCoord1 * u_map1RepeatRegion.zw + u_map1RepeatRegion.xy;\n"},t.skybox_fragment={top:"",define:"",varDeclare:"varying vec3 v_dir;\n",funcDeclare:"",funcDefine:"",body:"gl_FragColor = textureCube(u_samplerCube0, v_dir);\n"},t.skybox_vertex={top:"",define:"",varDeclare:"varying vec3 v_dir;\n",funcDeclare:"",funcDefine:"",body:"vec4 pos = u_pMatrix * mat4(mat3(u_vMatrix)) * mMatrix * vec4(a_position, 1.0);\n\n    gl_Position = pos.xyww;\n\n    v_dir = a_position;\n"},t.basic_forLight_envMap_fragment={top:"",define:"",varDeclare:"varying vec3 v_basicEnvMap_dir;\n",funcDeclare:"",funcDefine:"",body:"totalColor *= textureCube(u_samplerCube0, v_basicEnvMap_dir);\n"},t.basic_forLight_envMap_vertex={top:"",define:"",varDeclare:"varying vec3 v_basicEnvMap_dir;\n",funcDeclare:"",funcDefine:"",body:"v_basicEnvMap_dir = a_position;\n"},t.forLight_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"vec3 inDir = normalize(v_worldPosition - u_cameraPos);\n"},t.forLight_envMap_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},t.fresnel_forLight_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float computeFresnelRatio(vec3 inDir, vec3 normal, float refractionRatio){\n    float f = pow(1.0 - refractionRatio, 2.0) / pow(1.0 + refractionRatio, 2.0);\n    float fresnelPower = 5.0;\n    float ratio = f + (1.0 - f) * pow((1.0 - dot(inDir, normal)), fresnelPower);\n\n    return ratio / 100.0;\n}\n\nvec4 getEnvMapTotalColor(vec3 inDir, vec3 normal){\n    vec3 reflectDir = reflect(inDir, normal);\n\n/*!\n//todo why only fresnel->refraction need flip normal, but refraction don't need?\n*/\n    vec3 refractDir = refract(inDir, flipNormal(normal), u_refractionRatio);\n\n    vec4 reflectColor = textureCube(u_samplerCube0, reflectDir);\n    vec4 refractColor = textureCube(u_samplerCube0, refractDir);\n\n\n    vec4 totalColor = vec4(0.0);\n\n	if(u_reflectivity != NULL){\n        totalColor = mix(reflectColor, refractColor, u_reflectivity);\n	}\n	else{\n        totalColor = mix(reflectColor, refractColor, computeFresnelRatio(inDir, normal, u_refractionRatio));\n	}\n\n	return totalColor;\n}\n",body:"if(!isRenderListEmpty(u_isRenderListEmpty)){\n	totalColor *= getEnvMapTotalColor(inDir, normalize(getNormal()));\n}\n"},t.reflection_forLight_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"if(!isRenderListEmpty(u_isRenderListEmpty)){\n    totalColor *= textureCube(u_samplerCube0, reflect(inDir, normalize(getNormal())));\n}\n"},t.refraction_forLight_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"if(!isRenderListEmpty(u_isRenderListEmpty)){\n//    totalColor *= textureCube(u_samplerCube0, refract(inDir, flipNormalWhenRefraction(normal), u_refractionRatio));\n    totalColor *= textureCube(u_samplerCube0, refract(inDir, normal, u_refractionRatio));\n}\n"},t.basic_forBasic_envMap_fragment={top:"",define:"",varDeclare:"varying vec3 v_dir;\n",funcDeclare:"",funcDefine:"",body:"totalColor *= textureCube(u_samplerCube0, v_dir);\n"},t.basic_forBasic_envMap_vertex={top:"",define:"",varDeclare:"varying vec3 v_dir;\n",funcDeclare:"",funcDefine:"",body:"v_dir = a_position;\n"},t.forBasic_envMap_fragment={top:"",define:"",varDeclare:"varying vec3 v_normal;\nvarying vec3 v_position;\n",funcDeclare:"",funcDefine:"",body:"vec3 inDir = normalize(v_position - u_cameraPos);\n"},t.forBasic_envMap_vertex={top:"",define:"",varDeclare:"varying vec3 v_normal;\nvarying vec3 v_position;\n",funcDeclare:"",funcDefine:"",body:"v_normal = normalize( normalMatrix * a_normal);\n    v_position = vec3(mMatrix * vec4(a_position, 1.0));\n"},t.fresnel_forBasic_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float computeFresnelRatio(vec3 inDir, vec3 normal, float refractionRatio){\n    float f = pow(1.0 - refractionRatio, 2.0) / pow(1.0 + refractionRatio, 2.0);\n    float fresnelPower = 5.0;\n    float ratio = f + (1.0 - f) * pow((1.0 - dot(inDir, normal)), fresnelPower);\n\n    return ratio / 100.0;\n}\nvec4 getEnvMapTotalColor(vec3 inDir, vec3 normal){\n    vec3 reflectDir = reflect(inDir, normal);\n    vec3 refractDir = refract(inDir, flipNormal(normal), u_refractionRatio);\n\n    vec4 reflectColor = textureCube(u_samplerCube0, reflectDir);\n    vec4 refractColor = textureCube(u_samplerCube0, refractDir);\n\n    vec4 totalColor = vec4(0.0);\n\n	if(u_reflectivity != NULL){\n        totalColor = mix(reflectColor, refractColor, u_reflectivity);\n	}\n	else{\n        totalColor = mix(reflectColor, refractColor, computeFresnelRatio(inDir, normal, u_refractionRatio));\n	}\n\n	return totalColor;\n}\n",body:"if(!isRenderListEmpty(u_isRenderListEmpty)){\n    totalColor *= getEnvMapTotalColor(inDir, normalize(v_normal));\n}\n"},t.reflection_forBasic_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"if(!isRenderListEmpty(u_isRenderListEmpty)){\n    totalColor *= textureCube(u_samplerCube0, reflect(inDir, normalize(v_normal)));\n}\n"},t.refraction_forBasic_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"if(!isRenderListEmpty(u_isRenderListEmpty)){\n    totalColor *= textureCube(u_samplerCube0, refract(inDir, v_normal, u_refractionRatio));\n}\n"},t.modelMatrix_hardware_instance_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"mat4 mMatrix = mat4(a_mVec4_0, a_mVec4_1, a_mVec4_2, a_mVec4_3);\n"},t.normalMatrix_hardware_instance_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"mat3 normalMatrix = mat3(a_normalVec4_0, a_normalVec4_1, a_normalVec4_2);\n"},t.modelMatrix_batch_instance_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"mat4 mMatrix = u_mMatrix;\n"},t.normalMatrix_batch_instance_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"mat3 normalMatrix = u_normalMatrix;\n"},t.modelMatrix_noInstance_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"mat4 mMatrix = u_mMatrix;\n"},t.normalMatrix_noInstance_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"mat3 normalMatrix = u_normalMatrix;\n"},t.diffuseMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_diffuseMapTexCoord;\n",funcDeclare:"",funcDefine:"vec4 getMaterialDiffuse() {\n        return texture2D(u_diffuseMapSampler, v_diffuseMapTexCoord);\n    }\n",body:""},t.diffuseMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_diffuseMapTexCoord;\n",funcDeclare:"",funcDefine:"",body:"//todo optimize(combine, reduce compute numbers)\n    //todo BasicTexture extract textureMatrix\n    vec2 sourceTexCoord = a_texCoord * u_diffuseSourceRegion.zw + u_diffuseSourceRegion.xy;\n    v_diffuseMapTexCoord = sourceTexCoord * u_diffuseRepeatRegion.zw + u_diffuseRepeatRegion.xy;\n"},t.emissionMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_emissionMapTexCoord;\n",funcDeclare:"",funcDefine:"vec4 getMaterialEmission() {\n        return texture2D(u_emissionMapSampler, v_emissionMapTexCoord);\n    }\n",body:""},t.emissionMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_emissionMapTexCoord;\n",funcDeclare:"",funcDefine:"",body:"v_emissionMapTexCoord = a_texCoord;\n"
},t.lightMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_lightMapTexCoord;\n",funcDeclare:"",funcDefine:"vec4 getMaterialLight() {\n        return texture2D(u_lightMapSampler, v_lightMapTexCoord) * u_lightMapIntensity;\n    }\n",body:""},t.lightMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_lightMapTexCoord;\n",funcDeclare:"",funcDefine:"",body:"v_lightMapTexCoord = a_texCoord;\n"},t.noDiffuseMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec4 getMaterialDiffuse() {\n        return u_diffuse;\n    }\n",body:""},t.noEmissionMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec4 getMaterialEmission() {\n        return u_emission;\n    }\n",body:""},t.noLightMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec4 getMaterialLight() {\n        return vec4(0.0);\n    }\n",body:""},t.noNormalMap_fragment={top:"",define:"",varDeclare:"varying vec3 v_normal;\n",funcDeclare:"vec3 getNormal();\n\n",funcDefine:"#if POINT_LIGHTS_COUNT > 0\nvec3 getPointLightDir(int index){\n    //workaround '[] : Index expression must be constant' error\n    for (int x = 0; x <= POINT_LIGHTS_COUNT; x++) {\n        if(x == index){\n            return getPointLightDirByLightPos(u_pointLights[x].position);\n        }\n    }\n    /*!\n    solve error in window7 chrome/firefox:\n    not all control paths return a value.\n    failed to create d3d shaders\n    */\n    return vec3(0.0);\n}\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\nvec3 getDirectionLightDir(int index){\n    //workaround '[] : Index expression must be constant' error\n    for (int x = 0; x <= DIRECTION_LIGHTS_COUNT; x++) {\n        if(x == index){\n            return getDirectionLightDirByLightPos(u_directionLights[x].position);\n        }\n    }\n\n    /*!\n    solve error in window7 chrome/firefox:\n    not all control paths return a value.\n    failed to create d3d shaders\n    */\n    return vec3(0.0);\n}\n#endif\n\n\nvec3 getViewDir(){\n    return normalize(u_cameraPos - v_worldPosition);\n}\nvec3 getNormal(){\n    return v_normal;\n}\n\n",body:""},t.noNormalMap_vertex={top:"",define:"",varDeclare:"varying vec3 v_normal;\n",funcDeclare:"",funcDefine:"",body:"v_normal = normalize(normalMatrix * a_normal);\n"},t.noSpecularMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec4 getMaterialSpecular() {\n        return u_specular;\n    }\n",body:""},t.normalMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_normalMapTexCoord;\nvarying vec3 v_viewDir;\n#if POINT_LIGHTS_COUNT > 0\nvarying vec3 v_pointLightDir[POINT_LIGHTS_COUNT];\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\nvarying vec3 v_directionLightDir[DIRECTION_LIGHTS_COUNT];\n#endif\n\n",funcDeclare:"vec3 getNormal();\n\nvec3 getLightDir(vec3 lightPos);\n\n",funcDefine:"#if POINT_LIGHTS_COUNT > 0\nvec3 getPointLightDir(int index){\n    //workaround '[] : Index expression must be constant' error\n    for (int x = 0; x <= POINT_LIGHTS_COUNT; x++) {\n        if(x == index){\n            return v_pointLightDir[x];\n        }\n    }\n    /*!\n    solve error in window7 chrome/firefox:\n    not all control paths return a value.\n    failed to create d3d shaders\n    */\n    return vec3(0.0);\n}\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\n\nvec3 getDirectionLightDir(int index){\n    //workaround '[] : Index expression must be constant' error\n    for (int x = 0; x <= DIRECTION_LIGHTS_COUNT; x++) {\n        if(x == index){\n            return v_directionLightDir[x];\n        }\n    }\n\n    /*!\n    solve error in window7 chrome/firefox:\n    not all control paths return a value.\n    failed to create d3d shaders\n    */\n    return vec3(0.0);\n}\n#endif\n\n\nvec3 getViewDir(){\n    return v_viewDir;\n}\nvec3 getNormal(){\n        // Obtain normal from normal map in range [0,1]\n        vec3 normal = texture2D(u_normalMapSampler, v_normalMapTexCoord).rgb;\n\n        // Transform normal vector to range [-1,1]\n        return normalize(normal * 2.0 - 1.0);  // this normal is in tangent space\n}\n",body:""},t.normalMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_normalMapTexCoord;\n	varying vec3 v_viewDir;\n\n\n#if POINT_LIGHTS_COUNT > 0\nvarying vec3 v_pointLightDir[POINT_LIGHTS_COUNT];\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\nvarying vec3 v_directionLightDir[DIRECTION_LIGHTS_COUNT];\n#endif\n\n",funcDeclare:"",funcDefine:"mat3 computeTBN(mat3 normalMatrix){\n            vec3 T = normalize(normalMatrix * a_tangent);\n            vec3 N = normalize(normalMatrix * a_normal);\n            // re-orthogonalize T with respect to N\n            T = normalize(T - dot(T, N) * N);\n            // then retrieve perpendicular vector B with the cross product of T and N\n            vec3 B = cross(T, N);\n\n\n            return transpose(mat3(T, B, N));\n        }\n",body:"mat3 TBN = computeTBN(normalMatrix);\n\n    //v_tangentLightPos = TBN * light.position;\n    //v_tangentCameraPos  = TBN * u_cameraPos;\n    //v_tangentPos  = TBN * v_position;\n\n\n    vec3 tangentPosition = TBN * vec3(mMatrix * vec4(a_position, 1.0));\n\n    v_normalMapTexCoord = a_texCoord;\n\n    v_viewDir = normalize(TBN * u_cameraPos - tangentPosition);\n\n\n#if POINT_LIGHTS_COUNT > 0\n       for(int i = 0; i < POINT_LIGHTS_COUNT; i++){\n            //not normalize for computing distance\n            v_pointLightDir[i] = TBN * getPointLightDirByLightPos(u_pointLights[i].position, tangentPosition);\n       }\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\n       for(int i = 0; i < DIRECTION_LIGHTS_COUNT; i++){\n            v_directionLightDir[i] = normalize(- TBN * getDirectionLightDirByLightPos(u_directionLights[i].position));\n       }\n#endif\n\n"},t.specularMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_specularMapTexCoord;\n",funcDeclare:"",funcDefine:"vec4 getMaterialSpecular() {\n        return texture2D(u_specularMapSampler, v_specularMapTexCoord);\n    }\n",body:""},t.specularMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_specularMapTexCoord;\n",funcDeclare:"",funcDefine:"",body:"v_specularMapTexCoord = a_texCoord;\n"},t.buildCubemapShadowMap_fragment={top:"",define:"",varDeclare:"varying vec3 v_worldPosition;\n",funcDeclare:"",funcDefine:"",body:"\n// get distance between fragment and light source\n    float lightDistance = length(v_worldPosition - u_lightPos);\n\n    // map to [0,1] range by dividing by farPlane\n    lightDistance = lightDistance / u_farPlane;\n\n\ngl_FragData[0] = packDepth(lightDistance);\n\n\n//gl_FragColor = vec4(0.5, 0.0, 1.0, 1.0);\n//gl_FragData[0] = vec4(lightDistance, 1.0, 1.0, 1.0);\n"},t.buildCubemapShadowMap_vertex={top:"",define:"",varDeclare:"varying vec3 v_worldPosition;\n",funcDeclare:"",funcDefine:"",body:"v_worldPosition = vec3(mMatrix * vec4(a_position, 1.0));\n    gl_Position = u_pMatrix * u_vMatrix * vec4(v_worldPosition, 1.0);\n"},t.buildTwoDShadowMap_depthMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},t.buildTwoDShadowMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},t.buildTwoDShadowMap_packDepth_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_FragData[0] = packDepth(gl_FragCoord.z);\n"},t.buildTwoDShadowMap_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_Position = u_vpMatrixFromLight * mMatrix * vec4(a_position, 1.0);\n"},t.commonBuildShadowMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"// Packing a float in GLSL with multiplication and mod\nvec4 packDepth(in float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n    // combination of mod and multiplication and division works better\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res -= res.xxyz * bit_mask;\n\n    return res;\n}\n",body:""},t.cubemapShadowMap_fragment={top:"",define:"",varDeclare:"uniform samplerCube u_cubemapShadowMapSampler[ CUBEMAP_SHADOWMAP_COUNT ];\n\n    uniform int u_isCubemapRenderListEmpty[ CUBEMAP_SHADOWMAP_COUNT ];\n	uniform float u_cubemapShadowDarkness[ CUBEMAP_SHADOWMAP_COUNT ];\n	uniform float u_cubemapShadowBias[ CUBEMAP_SHADOWMAP_COUNT ];\n	uniform float u_farPlane[ CUBEMAP_SHADOWMAP_COUNT ];\n	uniform vec3 u_cubemapLightPos[ CUBEMAP_SHADOWMAP_COUNT ];\n",funcDeclare:"",funcDefine:"// PCF\nfloat getCubemapShadowVisibilityByPCF(float currentDepth, vec3 fragToLight, samplerCube cubemapShadowMapSampler, float shadowBias, float farPlane, float shadowDarkness){\n    //only support in opengl es 3.0+\n    //vec3 sampleOffsetDirections[20] = vec3[]\n    //(\n       //vec3( 1,  1,  1), vec3( 1, -1,  1), vec3(-1, -1,  1), vec3(-1,  1,  1),\n       //vec3( 1,  1, -1), vec3( 1, -1, -1), vec3(-1, -1, -1), vec3(-1,  1, -1),\n       //vec3( 1,  1,  0), vec3( 1, -1,  0), vec3(-1, -1,  0), vec3(-1,  1,  0),\n       //vec3( 1,  0,  1), vec3(-1,  0,  1), vec3( 1,  0, -1), vec3(-1,  0, -1),\n       //vec3( 0,  1,  1), vec3( 0, -1,  1), vec3( 0, -1, -1), vec3( 0,  1, -1)\n    //);\n\n    vec3 sampleOffsetDirections[20];\n\n    sampleOffsetDirections[0] = vec3( 1,  1,  1);\n    sampleOffsetDirections[1] = vec3( 1,  -1,  1);\n    sampleOffsetDirections[2] = vec3( -1,  -1,  1);\n    sampleOffsetDirections[3] = vec3( -1,  1,  1);\n\n    sampleOffsetDirections[4] = vec3( 1,  1,  -1);\n    sampleOffsetDirections[5] = vec3( 1,  -1,  -1);\n    sampleOffsetDirections[6] = vec3( -1,  -1,  -1);\n    sampleOffsetDirections[7] = vec3( -1,  1,  -1);\n\n    sampleOffsetDirections[8] = vec3( 1,  1,  0);\n    sampleOffsetDirections[9] = vec3( 1,  -1,  0);\n    sampleOffsetDirections[10] = vec3( -1,  -1,  0);\n    sampleOffsetDirections[11] = vec3( -1,  1,  0);\n\n    sampleOffsetDirections[12] = vec3( 1,  0,  1);\n    sampleOffsetDirections[13] = vec3( -1,  0,  1);\n    sampleOffsetDirections[14] = vec3( 1,  0,  -1);\n    sampleOffsetDirections[15] = vec3( -1,  0,  -1);\n\n    sampleOffsetDirections[16] = vec3( 0,  1,  1);\n    sampleOffsetDirections[17] = vec3( 0,  -1,  1);\n    sampleOffsetDirections[18] = vec3( 0,  -1,  -1);\n    sampleOffsetDirections[19] = vec3( 0,  1,  -1);\n\n    float shadow = 0.0;\n    int samples = 20;\n\n    //float diskRadius = 0.00000;\n    //Another interesting trick we can apply here is that we can change the diskRadius based on how far the viewer is away from a fragment; this way we can increase the offset radius by the distance to the viewer, making the shadows softer when far away and sharper when close by.\n    float viewDistance = length(u_cameraPos - v_worldPosition);\n    float diskRadius = (1.0 + (viewDistance / farPlane)) / 25.0;\n\n    //for(int i = 0; i < samples; ++i)\n    for(int i = 0; i < 20; ++i)\n    {\n        float pcfDepth = unpackDepth(textureCube(cubemapShadowMapSampler, fragToLight + sampleOffsetDirections[i] * diskRadius));\n        pcfDepth *= farPlane;   // Undo mapping [0;1]\n        shadow += currentDepth - shadowBias > pcfDepth  ? shadowDarkness : 1.0;\n    }\n    shadow /= float(samples);\n\n    return shadow;\n}\n\n\nfloat getCubemapShadowVisibility(vec3 lightDir, samplerCube cubemapShadowMapSampler, vec3 lightPos, float farPlane, float shadowBias, float  shadowDarkness) {\n// Get vector between fragment position and light position\n    vec3 fragToLight= v_worldPosition - lightPos;\n    // Use the light to fragment vector to sample from the depth map\n    // Now get current linear depth as the length between the fragment and light position\n    float currentDepth = length(fragToLight);\n\n    #if defined(SHADOWMAP_TYPE_PCF)\n    return getCubemapShadowVisibilityByPCF(currentDepth, fragToLight, cubemapShadowMapSampler, getShadowBias(lightDir, shadowBias), farPlane, shadowDarkness);\n    #endif\n\n    float closestDepth = unpackDepth(textureCube(cubemapShadowMapSampler, fragToLight));\n\n    // It is currently in linear range between [0,1]. Re-transform back to original value\n    closestDepth *= farPlane;\n\n\n    return float(currentDepth > closestDepth + getShadowBias(lightDir, shadowBias) ? shadowDarkness : 1.0);\n}\n",body:""},t.noShadowMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec3 getShadowVisibility() {\n        return vec3(1.0);\n    }\n",body:""},t.totalShadowMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"float getShadowBias(vec3 lightDir, float shadowBias);\nfloat unpackDepth(vec4 rgbaDepth);\n",funcDefine:"float getShadowBias(vec3 lightDir, float shadowBias){\n    float bias = shadowBias;\n\n    if(shadowBias == NULL){\n        bias = 0.005;\n    }\n\n\n     /*!\n     A shadow bias of 0.005 solves the issues of our scene by a large extent, but some surfaces that have a steep angle to the light source might still produce shadow acne. A more solid approach would be to change the amount of bias based on the surface angle towards the light: something we can solve with the dot product:\n     */\n\n     return max(bias * (1.0 - dot(normalize(getNormal()), lightDir)), bias);\n\n    //return bias;\n}\n\nvec3 getShadowVisibility() {\n    vec3 shadowColor = vec3(1.0);\n    vec3 twoDLightDir = vec3(0.0);\n    vec3 cubemapLightDir = vec3(0.0);\n\n\n\n    //to normalMap, the lightDir use the origin one instead of normalMap's lightDir here(the lightDir is used for computing shadowBias, the origin one is enough for it)\n\n    #if TWOD_SHADOWMAP_COUNT > 0\n	for( int i = 0; i < TWOD_SHADOWMAP_COUNT; i ++ ) {\n        if(isRenderListEmpty(u_isTwoDRenderListEmpty[i])){\n            continue;\n        }\n\n        twoDLightDir = getDirectionLightDirByLightPos(u_twoDLightPos[i]);\n\n	////if is opposite to direction of light rays, no shadow\n\n        shadowColor *= getTwoDShadowVisibility(twoDLightDir, u_twoDShadowMapSampler[i], v_positionFromLight[i], u_twoDShadowBias[i], u_twoDShadowDarkness[i], u_twoDShadowSize[i]);\n	}\n	#endif\n\n\n	#if CUBEMAP_SHADOWMAP_COUNT > 0\n\n	for( int i = 0; i < CUBEMAP_SHADOWMAP_COUNT; i ++ ) {\n        if(isRenderListEmpty(u_isCubemapRenderListEmpty[i])){\n            continue;\n        }\n\n	////if is opposite to direction of light rays, no shadow\n\n        shadowColor *= getCubemapShadowVisibility(cubemapLightDir, u_cubemapShadowMapSampler[i], u_cubemapLightPos[i], u_farPlane[i], u_cubemapShadowBias[i], u_cubemapShadowDarkness[i]);\n	}\n	#endif\n\n	return shadowColor;\n}\n\nfloat unpackDepth(vec4 rgbaDepth) {\n    /*! make sure that the visibility from the shadow map which is not builded is always be 1.0 */\n    if(rgbaDepth == vec4(0.0)){\n        return 100000.0;\n    }\n\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    return dot(rgbaDepth, bitShift);\n}\n\n",body:""},t.twoDShadowMap_depthMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"float handleDepthMap(vec4 rgbaDepth);\n",funcDefine:"float handleDepthMap(vec4 rgbaDepth) {\n    return rgbaDepth.r;\n}\n",body:""},t.twoDShadowMap_fragment={top:"",define:"",varDeclare:"varying vec4 v_positionFromLight[ TWOD_SHADOWMAP_COUNT ];\n    uniform int u_isTwoDRenderListEmpty[ TWOD_SHADOWMAP_COUNT ];\n	uniform sampler2D u_twoDShadowMapSampler[ TWOD_SHADOWMAP_COUNT ];\n	uniform float u_twoDShadowDarkness[ TWOD_SHADOWMAP_COUNT ];\n	uniform float u_twoDShadowBias[ TWOD_SHADOWMAP_COUNT ];\n	uniform vec2 u_twoDShadowSize[ TWOD_SHADOWMAP_COUNT ];\n	uniform vec3 u_twoDLightPos[ TWOD_SHADOWMAP_COUNT ];\n",funcDeclare:"",funcDefine:"// PCF\nfloat getTwoDShadowVisibilityByPCF(float currentDepth, vec2 shadowCoord, sampler2D twoDShadowMapSampler, float shadowBias, float shadowDarkness, vec2 shadowMapSize){\n\n    float shadow = 0.0;\n    vec2 texelSize = vec2(1.0 / shadowMapSize[0], 1.0 / shadowMapSize[1]);\n\n    for(int x = -1; x <= 1; ++x)\n    {\n        for(int y = -1; y <= 1; ++y)\n        {\n            float pcfDepth = handleDepthMap(texture2D(twoDShadowMapSampler, shadowCoord + vec2(x, y) * texelSize));\n            shadow += currentDepth - shadowBias > pcfDepth  ? shadowDarkness : 1.0;\n        }\n    }\n    shadow /= 9.0;\n\n    return shadow;\n}\n\n\n\nfloat getTwoDShadowVisibility(vec3 lightDir, sampler2D twoDShadowMapSampler, vec4 v_positionFromLight, float shadowBias, float shadowDarkness, vec2 shadowSize) {\n    //project texture\n    vec3 shadowCoord = (v_positionFromLight.xyz / v_positionFromLight.w) / 2.0 + 0.5;\n    //vec3 shadowCoord = vec3(0.5, 0.5, 0.5);\n\n    #ifdef SHADOWMAP_TYPE_PCF\n    // Percentage-close filtering\n    // (9 pixel kernel)\n    return getTwoDShadowVisibilityByPCF(shadowCoord.z, shadowCoord.xy, twoDShadowMapSampler, getShadowBias(lightDir, shadowBias), shadowDarkness, shadowSize);\n\n    #else\n    return shadowCoord.z > handleDepthMap(texture2D(twoDShadowMapSampler, shadowCoord.xy)) + getShadowBias(lightDir, shadowBias) ? shadowDarkness : 1.0;\n    #endif\n}\n",body:""},t.twoDShadowMap_unpackDepth_fragment={top:"",define:"",varDeclare:"",funcDeclare:"float handleDepthMap(vec4 rgbaDepth);\n",funcDefine:"float handleDepthMap(vec4 rgbaDepth) {\n    return unpackDepth(rgbaDepth);\n}\n",body:""},t.twoDShadowMap_vertex={top:"",define:"",varDeclare:"varying vec4 v_positionFromLight[ TWOD_SHADOWMAP_COUNT ];\nuniform mat4 u_vpMatrixFromLight[ TWOD_SHADOWMAP_COUNT ];\n",funcDeclare:"",funcDefine:"",body:"for( int i = 0; i < TWOD_SHADOWMAP_COUNT; i ++ ) {\n    v_positionFromLight[i] = u_vpMatrixFromLight[i] * vec4(v_worldPosition, 1.0);\n	}\n"},t.mirror_fragment={top:"",define:"",varDeclare:"varying vec4 v_reflectionMapCoord;\n",funcDeclare:"",funcDefine:"//todo add more blend way to mix reflectionMap color and textureColor\n		float blendOverlay(float base, float blend) {\n			return( base < 0.5 ? ( 2.0 * base * blend ) : (1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );\n		}\n		vec4 getReflectionMapColor(in vec4 materialColor){\n			vec4 color = texture2DProj(u_reflectionMapSampler, v_reflectionMapCoord);\n\n			color = vec4(blendOverlay(materialColor.r, color.r), blendOverlay(materialColor.g, color.g), blendOverlay(materialColor.b, color.b), 1.0);\n\n			return color;\n		}\n",body:"if(!isRenderListEmpty(u_isRenderListEmpty)){\n    totalColor *= getReflectionMapColor(totalColor);\n}\n"},t.mirror_vertex={top:"",define:"",varDeclare:"varying vec4 v_reflectionMapCoord;\n",funcDeclare:"",funcDefine:"",body:"mat4 textureMatrix = mat4(\n                        0.5, 0.0, 0.0, 0.0,\n                        0.0, 0.5, 0.0, 0.0,\n                        0.0, 0.0, 0.5, 0.0,\n                        0.5, 0.5, 0.5, 1.0\n);\n\nv_reflectionMapCoord = textureMatrix * gl_Position;\n"},t.terrainLayer_fragment={top:"",define:"",varDeclare:"struct LayerHeightData {\n    float minHeight;\n    float maxHeight;\n};\nuniform LayerHeightData u_layerHeightDatas[LAYER_COUNT];\n//sampler2D can't be contained in struct\nuniform sampler2D u_layerSampler2Ds[LAYER_COUNT];\n\n\nvarying vec2 v_layerTexCoord;\n",funcDeclare:"",funcDefine:"vec4 getLayerTextureColor(in sampler2D layerSampler2Ds[LAYER_COUNT], in LayerHeightData layerHeightDatas[LAYER_COUNT]){\n    vec4 color = vec4(0.0);\n    bool isInLayer = false;\n\n    float height = v_worldPosition.y;\n\n    for(int i = 0; i < LAYER_COUNT; i++){\n        if(height >= layerHeightDatas[i].minHeight && height <= layerHeightDatas[i].maxHeight){\n            //todo blend color\n            color += texture2D(layerSampler2Ds[i], v_layerTexCoord);\n\n            isInLayer = true;\n\n            break;\n        }\n    }\n\n    return isInLayer ? color : vec4(1.0);\n}\n",body:"\ntotalColor *= getLayerTextureColor(u_layerSampler2Ds, u_layerHeightDatas);\n"},t.terrainLayer_vertex={top:"",define:"",varDeclare:"varying vec2 v_layerTexCoord;\n",funcDeclare:"",funcDefine:"",body:"v_layerTexCoord = a_texCoord;\n"},t.water_bump_fragment={top:"",define:"",varDeclare:"varying vec2 v_bumpTexCoord;\n",funcDeclare:"",funcDefine:"",body:"// fetch bump texture, unpack from [0..1] to [-1..1]\n	vec3 bumpNormal = 2.0 * texture2D(u_bumpMapSampler, v_bumpTexCoord).rgb - 1.0;\n	vec2 perturbation = u_waveData.height * bumpNormal.rg;\n"},t.water_bump_vertex={top:"",define:"",varDeclare:"struct WaveData {\n    float length;\n    float height;\n};\nuniform WaveData u_waveData;\nvarying vec2 v_bumpTexCoord;\n",funcDeclare:"",funcDefine:"",body:"vec2 bumpTexCoord = vec2(u_windMatrix * vec4(a_texCoord, 0.0, 1.0));\n	v_bumpTexCoord = bumpTexCoord / u_waveData.length;\n"},t.water_fragment={top:"",define:"",varDeclare:"struct WaveData {\n    float length;\n    float height;\n};\nuniform WaveData u_waveData;\nstruct LevelData {\n    float fresnelLevel;\n    float reflectionLevel;\n    float refractionLevel;\n};\nuniform LevelData u_levelData;\n\nvarying vec4 v_reflectionAndRefractionMapCoord;\n",funcDeclare:"",funcDefine:"",body:"vec2 projectedTexCoords = v_reflectionAndRefractionMapCoord.xy / v_reflectionAndRefractionMapCoord.w + perturbation;\n\n\n\n\n//totalColor = vec4(1.0 - fresnelTerm);\n//totalColor *= vec4(refractionColor, 1.0);\n//totalColor *= vec4(mix(reflectionColor, refractionColor, fresnelTerm), 1.0);\n//totalColor += vec4(reflectionColor * fresnelTerm * u_levelData.reflectionLevel + (1.0 - fresnelTerm) * refractionColor * u_levelData.refractionLevel, 1.0);\n\n//totalColor += vec4(reflectionColor * fresnelTerm * u_levelData.reflectionLevel + (1.0 - fresnelTerm) * refractionColor * u_levelData.refractionLevel, 1.0);\n\ntotalColor += vec4(getLightEffectColor(projectedTexCoords), 1.0);\n\n\n//totalColor *= vec4(mix(reflectionColor, refractionColor, 0.5), 1.0);\n"},t.water_fresnel_fragment={top:"",define:"",varDeclare:"varying vec3 v_position;\n",funcDeclare:"",funcDefine:"vec3 getLightEffectColor(vec2 projectedTexCoords){\n	vec3 reflectionColor;\n	vec3 refractionColor;\n\n    vec3 inDir = normalize(v_position - u_cameraPos);\n\n	float fresnelTerm = max(dot(inDir, v_normal), 0.0);\n	fresnelTerm = clamp((1.0 - fresnelTerm) * u_levelData.fresnelLevel, 0., 1.);\n\n    if(!isRenderListEmpty(u_isReflectionRenderListEmpty)){\n        reflectionColor = texture2D(u_reflectionMapSampler, projectedTexCoords).rgb;\n        reflectionColor = reflectionColor * fresnelTerm * u_levelData.reflectionLevel;\n	}\n	else{\n        reflectionColor = vec3(0.0);\n	}\n\n    if(!isRenderListEmpty(u_isRefractionRenderListEmpty)){\n        refractionColor = texture2D(u_refractionMapSampler, projectedTexCoords).rgb;\n        refractionColor = (1.0 - fresnelTerm) * refractionColor * u_levelData.refractionLevel;\n	}\n	else{\n        refractionColor = vec3(0.0);\n	}\n\n	return reflectionColor + refractionColor;\n}\n",body:""},t.water_fresnel_vertex={top:"",define:"",varDeclare:"varying vec3 v_position;\n",funcDeclare:"",funcDefine:"",body:"v_position = a_position;\n"},t.water_noBump_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"vec2 perturbation = vec2(0.0);\n"},t.water_noLightEffect_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec4 getLightEffectColor(vec2 projectedTexCoords){\n    return vec4(1.0);\n}\n",body:""},t.water_reflection_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec3 getLightEffectColor(vec2 projectedTexCoords){\n    if(!isRenderListEmpty(u_isReflectionRenderListEmpty)){\n        return texture2D(u_reflectionMapSampler, projectedTexCoords).rgb * u_levelData.reflectionLevel;\n    }\n    return vec3(0.0);\n}\n",body:""},t.water_refraction_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec3 getLightEffectColor(vec2 projectedTexCoords){\n    if(!isRenderListEmpty(u_isRefractionRenderListEmpty)){\n        return texture2D(u_refractionMapSampler, projectedTexCoords).rgb * u_levelData.refractionLevel;\n    }\n    return vec3(0.0);\n}\n",body:""},t.water_vertex={top:"",define:"",varDeclare:"varying vec4 v_reflectionAndRefractionMapCoord;\n",funcDeclare:"",funcDefine:"",body:"mat4 textureMatrix = mat4(\n                        0.5, 0.0, 0.0, 0.0,\n                        0.0, 0.5, 0.0, 0.0,\n                        0.0, 0.0, 0.5, 0.0,\n                        0.5, 0.5, 0.5, 1.0\n);\n\nv_reflectionAndRefractionMapCoord = textureMatrix * gl_Position;\n"},t.brick_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\n",funcDeclare:"",funcDefine:"",body:"float brickW = 1.0 / u_tilesWidthNumber;\n	float brickH = 1.0 / u_tilesWidthNumber;\n	float jointWPercentage = 0.01;\n	float jointHPercentage = 0.05;\n	vec3 color = u_brickColor;\n	float yi = v_texCoord.y / brickH;\n	float nyi = round(yi);\n	float xi = v_texCoord.x / brickW;\n\n	if (mod(floor(yi), 2.0) == 0.0){\n		xi = xi - 0.5;\n	}\n\n	float nxi = round(xi);\n	vec2 brickv_texCoord = vec2((xi - floor(xi)) / brickH, (yi - floor(yi)) /  brickW);\n\n	if (yi < nyi + jointHPercentage && yi > nyi - jointHPercentage){\n		color = mix(u_jointColor, vec3(0.37, 0.25, 0.25), (yi - nyi) / jointHPercentage + 0.2);\n	}\n	else if (xi < nxi + jointWPercentage && xi > nxi - jointWPercentage){\n		color = mix(u_jointColor, vec3(0.44, 0.44, 0.44), (xi - nxi) / jointWPercentage + 0.2);\n	}\n	else {\n		float u_brickColorSwitch = mod(floor(yi) + floor(xi), 3.0);\n\n		if (u_brickColorSwitch == 0.0)\n			color = mix(color, vec3(0.33, 0.33, 0.33), 0.3);\n		else if (u_brickColorSwitch == 2.0)\n			color = mix(color, vec3(0.11, 0.11, 0.11), 0.3);\n	}\n\n	gl_FragColor = vec4(color, 1.0);\n"},t.cloud_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\n",funcDeclare:"",funcDefine:"",body:"gl_FragColor = mix(u_skyColor, u_cloudColor, fbm(v_texCoord * 12.0));\n"},t.common_proceduralTexture_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float rand(vec2 n) {\n	return fract(cos(dot(n, vec2(12.9898, 4.1414))) * 43758.5453);\n}\nfloat noise(vec2 n) {\n	const vec2 d = vec2(0.0, 1.0);\n	vec2 b = floor(n), f = smoothstep(vec2(0.0), vec2(1.0), fract(n));\n	return mix(mix(rand(b), rand(b + d.yx), f.x), mix(rand(b + d.xy), rand(b + d.yy), f.x), f.y);\n}\n\nfloat turbulence(vec2 P)\n{\n	float val = 0.0;\n	float freq = 1.0;\n	for (int i = 0; i < 4; i++)\n	{\n		val += abs(noise(P*freq) / freq);\n		freq *= 2.07;\n	}\n	return val;\n}\n\nfloat fbm(vec2 n) {\n	float total = 0.0, amplitude = 1.0;\n	for (int i = 0; i < 4; i++) {\n		total += noise(n) * amplitude;\n		n += n;\n		amplitude *= 0.5;\n	}\n	return total;\n}\n\nfloat round(float number){\n	return sign(number)*floor(abs(number) + 0.5);\n}\n",body:""},t.common_proceduralTexture_vertex={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\nconst vec2 MADD=vec2(0.5,0.5);\n",funcDeclare:"",funcDefine:"",body:"v_texCoord=a_positionVec2*MADD+MADD;\n\n    gl_Position=vec4(a_positionVec2, 0.0 ,1.0);\n"},t.fire_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\nstruct FireColor {\n    vec3 c1;\n    vec3 c2;\n    vec3 c3;\n    vec3 c4;\n    vec3 c5;\n    vec3 c6;\n};\nuniform FireColor u_fireColor;\n",funcDeclare:"",funcDefine:"",body:"vec2 p = v_texCoord * 8.0;\n	float q = fbm(p - u_time * 0.1);\n	vec2 r = vec2(fbm(p + q + u_time * u_speed.x - p.x - p.y), fbm(p + q - u_time * u_speed.y));\n	vec3 c = mix(u_fireColor.c1, u_fireColor.c2, fbm(p + r)) + mix(u_fireColor.c3, u_fireColor.c4, r.x) - mix(u_fireColor.c5, u_fireColor.c6, r.y);\n	vec3 color = c * cos(u_shift * v_texCoord.y);\n	float luminance = dot(color.rgb, vec3(0.3, 0.59, 0.11));\n\n	gl_FragColor = vec4(color, luminance * u_alphaThreshold + (1.0 - u_alphaThreshold));\n"},t.grass_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\n",funcDeclare:"",funcDefine:"",body:"vec3 color = mix(u_groundColor, u_herb1Color, rand(gl_FragCoord.xy * 4.0));\n	color = mix(color, u_herb2Color, rand(gl_FragCoord.xy * 8.0));\n	color = mix(color, u_herb3Color, rand(gl_FragCoord.xy));\n	color = mix(color, u_herb1Color, fbm(gl_FragCoord.xy * 16.0));\n\n	gl_FragColor = vec4(color, 1.0);\n"},t.marble_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\nconst vec3 TILE_SIZE = vec3(1.1, 1.0, 1.1);\n//const vec3 TILE_PCT = vec3(0.98, 1.0, 0.98);\n",funcDeclare:"",funcDefine:"vec3 marble_color(float x)\n{\n	vec3 col;\n	x = 0.5*(x + 1.);\n	x = sqrt(x);\n	x = sqrt(x);\n	x = sqrt(x);\n	col = vec3(.2 + .75*x);\n	col.b *= 0.95;\n	return col;\n}\n",body:"vec3 color;\n	float brickW = 1.0 / u_tilesHeightNumber;\n	float brickH = 1.0 / u_tilesWidthNumber;\n	float jointWPercentage = 0.01;\n	float jointHPercentage = 0.01;\n	float yi = v_texCoord.y / brickH;\n	float nyi = round(yi);\n	float xi = v_texCoord.x / brickW;\n\n	if (mod(floor(yi), 2.0) == 0.0){\n		xi = xi - 0.5;\n	}\n\n	float nxi = round(xi);\n	vec2 brickv_texCoord = vec2((xi - floor(xi)) / brickH, (yi - floor(yi)) / brickW);\n\n	if (yi < nyi + jointHPercentage && yi > nyi - jointHPercentage){\n		color = mix(u_jointColor, vec3(0.37, 0.25, 0.25), (yi - nyi) / jointHPercentage + 0.2);\n	}\n	else if (xi < nxi + jointWPercentage && xi > nxi - jointWPercentage){\n		color = mix(u_jointColor, vec3(0.44, 0.44, 0.44), (xi - nxi) / jointWPercentage + 0.2);\n	}\n	else {\n		float t = 6.28 * brickv_texCoord.x / (TILE_SIZE.x + noise(vec2(v_texCoord)*6.0));\n		t += u_amplitude * turbulence(brickv_texCoord.xy);\n		t = sin(t);\n		color = marble_color(t);\n	}\n\n	gl_FragColor = vec4(color, 1.0);\n"},t.road_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\n",funcDeclare:"",funcDefine:"",body:"float ratioy = mod(gl_FragCoord.y * 100.0 , fbm(v_texCoord * 2.0));\n	vec3 color = u_roadColor * ratioy;\n\n	gl_FragColor = vec4(color, 1.0);\n"},t.wood_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\n",funcDeclare:"",funcDefine:"",body:"float ratioy = mod(v_texCoord.x * u_ampScale, 2.0 + fbm(v_texCoord * 0.8));\n	vec3 wood = u_woodColor * ratioy;\n\n	gl_FragColor = vec4(wood, 1.0);\n"},t}();t.ShaderChunk=e}(wd||(wd={}));