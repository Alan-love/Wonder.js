!function(e,t){"undefined"!=typeof module&&module.exports?module.exports.browser=t():"function"==typeof define&&define.amd?define(t):this[e]=t()}("bowser",function(){function detect(t){function getFirstMatch(e){var r=t.match(e);return r&&r.length>1&&r[1]||""}var r,n=getFirstMatch(/(ipod|iphone|ipad)/i).toLowerCase(),i=/like android/i.test(t),o=!i&&/android/i.test(t),a=getFirstMatch(/version\/(\d+(\.\d+)?)/i),s=/tablet/i.test(t),c=!s&&/[^-]mobi/i.test(t);/opera|opr/i.test(t)?r={name:"Opera",opera:e,version:a||getFirstMatch(/(?:opera|opr)[\s\/](\d+(\.\d+)?)/i)}:/windows phone/i.test(t)?r={name:"Windows Phone",windowsphone:e,msie:e,version:getFirstMatch(/iemobile\/(\d+(\.\d+)?)/i)}:/msie|trident/i.test(t)?r={name:"Internet Explorer",msie:e,version:getFirstMatch(/(?:msie |rv:)(\d+(\.\d+)?)/i)}:/chrome|crios|crmo/i.test(t)?r={name:"Chrome",chrome:e,version:getFirstMatch(/(?:chrome|crios|crmo)\/(\d+(\.\d+)?)/i)}:n?(r={name:"iphone"==n?"iPhone":"ipad"==n?"iPad":"iPod"},a&&(r.version=a)):/sailfish/i.test(t)?r={name:"Sailfish",sailfish:e,version:getFirstMatch(/sailfish\s?browser\/(\d+(\.\d+)?)/i)}:/seamonkey\//i.test(t)?r={name:"SeaMonkey",seamonkey:e,version:getFirstMatch(/seamonkey\/(\d+(\.\d+)?)/i)}:/firefox|iceweasel/i.test(t)?(r={name:"Firefox",firefox:e,version:getFirstMatch(/(?:firefox|iceweasel)[ \/](\d+(\.\d+)?)/i)},/\((mobile|tablet);[^\)]*rv:[\d\.]+\)/i.test(t)&&(r.firefoxos=e)):/silk/i.test(t)?r={name:"Amazon Silk",silk:e,version:getFirstMatch(/silk\/(\d+(\.\d+)?)/i)}:o?r={name:"Android",version:a}:/phantom/i.test(t)?r={name:"PhantomJS",phantom:e,version:getFirstMatch(/phantomjs\/(\d+(\.\d+)?)/i)}:/blackberry|\bbb\d+/i.test(t)||/rim\stablet/i.test(t)?r={name:"BlackBerry",blackberry:e,version:a||getFirstMatch(/blackberry[\d]+\/(\d+(\.\d+)?)/i)}:/(web|hpw)os/i.test(t)?(r={name:"WebOS",webos:e,version:a||getFirstMatch(/w(?:eb)?osbrowser\/(\d+(\.\d+)?)/i)},/touchpad\//i.test(t)&&(r.touchpad=e)):r=/bada/i.test(t)?{name:"Bada",bada:e,version:getFirstMatch(/dolfin\/(\d+(\.\d+)?)/i)}:/tizen/i.test(t)?{name:"Tizen",tizen:e,version:getFirstMatch(/(?:tizen\s?)?browser\/(\d+(\.\d+)?)/i)||a}:/safari/i.test(t)?{name:"Safari",safari:e,version:a}:{},/(apple)?webkit/i.test(t)?(r.name=r.name||"Webkit",r.webkit=e,!r.version&&a&&(r.version=a)):!r.opera&&/gecko\//i.test(t)&&(r.name=r.name||"Gecko",r.gecko=e,r.version=r.version||getFirstMatch(/gecko\/(\d+(\.\d+)?)/i)),o||r.silk?r.android=e:n&&(r[n]=e,r.ios=e);var u="";n?(u=getFirstMatch(/os (\d+([_\s]\d+)*) like mac os x/i),u=u.replace(/[_\s]/g,".")):o?u=getFirstMatch(/android[ \/-](\d+(\.\d+)*)/i):r.windowsphone?u=getFirstMatch(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i):r.webos?u=getFirstMatch(/(?:web|hpw)os\/(\d+(\.\d+)*)/i):r.blackberry?u=getFirstMatch(/rim\stablet\sos\s(\d+(\.\d+)*)/i):r.bada?u=getFirstMatch(/bada\/(\d+(\.\d+)*)/i):r.tizen&&(u=getFirstMatch(/tizen[\/\s](\d+(\.\d+)*)/i)),u&&(r.osversion=u);var l=u.split(".")[0];return s||"ipad"==n||o&&(3==l||4==l&&!c)||r.silk?r.tablet=e:(c||"iphone"==n||"ipod"==n||o||r.blackberry||r.webos||r.bada)&&(r.mobile=e),r.msie&&r.version>=10||r.chrome&&r.version>=20||r.firefox&&r.version>=20||r.safari&&r.version>=6||r.opera&&r.version>=10||r.ios&&r.osversion&&r.osversion.split(".")[0]>=6||r.blackberry&&r.version>=10.1?r.a=e:r.msie&&r.version<10||r.chrome&&r.version<20||r.firefox&&r.version<20||r.safari&&r.version<6||r.opera&&r.version<10||r.ios&&r.osversion&&r.osversion.split(".")[0]<6?r.c=e:r.x=e,r}var e=!0,t=detect("undefined"!=typeof navigator?navigator.userAgent:"");return t._detect=detect,t});var wdCb;!function(e){var t=Math.pow(2,53)-1,r=function(){function JudgeUtils(){}return JudgeUtils.isArray=function(e){var r=e&&e.length;return"number"==typeof r&&r>=0&&r<=t},JudgeUtils.isArrayExactly=function(e){return"[object Array]"===Object.prototype.toString.call(e)},JudgeUtils.isNumber=function(e){return"number"==typeof e},JudgeUtils.isNumberExactly=function(e){return"[object Number]"===Object.prototype.toString.call(e)},JudgeUtils.isString=function(e){return"string"==typeof e},JudgeUtils.isStringExactly=function(e){return"[object String]"===Object.prototype.toString.call(e)},JudgeUtils.isBoolean=function(e){return e===!0||e===!1||"[boolect Boolean]"===toString.call(e)},JudgeUtils.isDom=function(e){return!(!e||1!==e.nodeType)},JudgeUtils.isObject=function(e){var t=typeof e;return"function"===t||"object"===t&&!!e},JudgeUtils.isDirectObject=function(e){return"[object Object]"===Object.prototype.toString.call(e)},JudgeUtils.isHostMethod=function(e,t){var r=typeof e[t];return"function"===r||"object"===r&&!!e[t]||"unknown"===r},JudgeUtils.isNodeJs=function(){return("undefined"!=typeof global&&global.module||"undefined"!=typeof module)&&"undefined"!=typeof module.exports},JudgeUtils.isFunction=function(e){return!0},JudgeUtils}();e.JudgeUtils=r,"function"!=typeof/./&&"object"!=typeof Int8Array?r.isFunction=function(e){return"function"==typeof e}:r.isFunction=function(e){return"[object Function]"===Object.prototype.toString.call(e)}}(wdCb||(wdCb={}));var wdCb;!function(e){e.JudgeUtils.isNodeJs()&&"undefined"!=typeof global?e.root=global:e.root=window}(wdCb||(wdCb={}));var wdCb;!function(e){if("performance"in e.root==!1&&(e.root.performance={}),Date.now=Date.now||function(){return(new Date).getTime()},"now"in e.root.performance==!1){var t=e.root.performance.timing&&e.root.performance.timing.navigationStart?performance.timing.navigationStart:Date.now();e.root.performance.now=function(){return Date.now()-t}}}(wdCb||(wdCb={}));var wdCb;!function(e){e.$BREAK={"break":!0},e.$REMOVE=void 0}(wdCb||(wdCb={}));var wdCb;!function(e){var t=function(){function Log(){}return Log.log=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];this._exec("log",t)||e.root.alert(t.join(",")),this._exec("trace",t)},Log.assert=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];e&&(this._exec("assert",arguments,1)||this.log.apply(this,Array.prototype.slice.call(arguments,1)))},Log.error=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];if(e)throw new Error(Array.prototype.slice.call(arguments,1).join("\n"))},Log.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=this._exec("warn",arguments);r?this._exec("trace",["warn trace"]):this.log.apply(this,arguments)},Log._exec=function(t,r,n){return void 0===n&&(n=0),!(!e.root.console||!e.root.console[t])&&(e.root.console[t].apply(e.root.console,Array.prototype.slice.call(r,n)),!0)},Log.info={INVALID_PARAM:"invalid parameter",helperFunc:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r="";return e.forEach(function(e){r+=String(e)+" "}),r.slice(0,-1)},assertion:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];if(2===e.length)return this.helperFunc(e[0],e[1]);if(3===e.length)return this.helperFunc(e[1],e[0],e[2]);throw new Error("args.length must <= 3")},FUNC_INVALID:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("invalid"),this.assertion.apply(this,e)},FUNC_MUST:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("must"),this.assertion.apply(this,e)},FUNC_MUST_BE:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("must be"),this.assertion.apply(this,e)},FUNC_MUST_NOT_BE:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("must not be"),this.assertion.apply(this,e)},FUNC_SHOULD:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("should"),this.assertion.apply(this,e)},FUNC_SHOULD_NOT:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("should not"),this.assertion.apply(this,e)},FUNC_SUPPORT:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("support"),this.assertion.apply(this,e)},FUNC_NOT_SUPPORT:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("not support"),this.assertion.apply(this,e)},FUNC_MUST_DEFINE:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("must define"),this.assertion.apply(this,e)},FUNC_MUST_NOT_DEFINE:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("must not define"),this.assertion.apply(this,e)},FUNC_UNKNOW:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("unknow"),this.assertion.apply(this,e)},FUNC_EXPECT:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("expect"),this.assertion.apply(this,e)},FUNC_UNEXPECT:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("unexpect"),this.assertion.apply(this,e)},FUNC_EXIST:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("exist"),this.assertion.apply(this,e)},FUNC_NOT_EXIST:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("not exist"),this.assertion.apply(this,e)},FUNC_ONLY:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("only"),this.assertion.apply(this,e)},FUNC_CAN_NOT:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("can't"),this.assertion.apply(this,e)}},Log}();e.Log=t}(wdCb||(wdCb={}));var wdCb;!function(e){var t=function(){function List(){this.children=null}return List.prototype.getCount=function(){return this.children.length},List.prototype.hasChild=function(e){for(var t=null,r=this.children,n=0,i=r.length;n<i;n++){if(t=r[n],e.uid&&t.uid&&e.uid==t.uid)return!0;if(e===t)return!0}return!1},List.prototype.hasChildWithFunc=function(e){for(var t=0,r=this.children.length;t<r;t++)if(e(this.children[t],t))return!0;return!1},List.prototype.getChildren=function(){return this.children},List.prototype.getChild=function(e){return this.children[e]},List.prototype.addChild=function(e){return this.children.push(e),this},List.prototype.addChildren=function(t){if(e.JudgeUtils.isArray(t)){var r=t;this.children=this.children.concat(r)}else if(t instanceof List){var r=t;this.children=this.children.concat(r.getChildren())}else{var n=t;this.addChild(n)}return this},List.prototype.setChildren=function(e){return this.children=e,this},List.prototype.unShiftChild=function(e){this.children.unshift(e)},List.prototype.removeAllChildren=function(){return this.children=[],this},List.prototype.forEach=function(e,t){return this._forEach(this.children,e,t),this},List.prototype.toArray=function(){return this.children},List.prototype.copyChildren=function(){return this.children.slice(0)},List.prototype.removeChildHelper=function(t){var r=null;if(e.JudgeUtils.isFunction(t)){var n=t;r=this._removeChild(this.children,n)}else r=t.uid?this._removeChild(this.children,function(e){return!!e.uid&&e.uid===t.uid}):this._removeChild(this.children,function(e){return e===t});return r},List.prototype._forEach=function(t,r,n){var i=n,o=0,a=t.length;for(o=0;o<a&&r.call(i,t[o],o)!==e.$BREAK;o++);},List.prototype._removeChild=function(e,t){var r=this,n=[],i=[];return this._forEach(e,function(e,o){t.call(r,e)?n.push(e):i.push(e)}),this.children=i,n},List}();e.List=t}(wdCb||(wdCb={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdCb;!function(e){var t=function(t){function Collection(e){void 0===e&&(e=[]),t.call(this),this.children=e}return __extends(Collection,t),Collection.create=function(e){void 0===e&&(e=[]);var t=new this(e);return t},Collection.prototype.clone=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=null;return 0===t.length?(i=!1,n=Collection.create()):1===t.length?e.JudgeUtils.isBoolean(t[0])?(n=Collection.create(),i=t[0]):(n=t[0],i=!1):(n=t[0],i=t[1]),i===!0?n.setChildren(e.ExtendUtils.extendDeep(this.children)):n.setChildren(e.ExtendUtils.extend([],this.children)),n},Collection.prototype.filter=function(e){for(var t=this.children,r=[],n=null,i=0,o=t.length;i<o;i++)n=t[i],e.call(t,n,i)&&r.push(n);return Collection.create(r)},Collection.prototype.findOne=function(t){var r=this.children,n=null;return this.forEach(function(i,o){if(t.call(r,i,o))return n=i,e.$BREAK}),n},Collection.prototype.reverse=function(){return Collection.create(this.copyChildren().reverse())},Collection.prototype.removeChild=function(e){return Collection.create(this.removeChildHelper(e))},Collection.prototype.sort=function(e,t){return void 0===t&&(t=!1),t?(this.children.sort(e),this):Collection.create(this.copyChildren().sort(e))},Collection.prototype.map=function(t){var r=[];return this.forEach(function(n,i){var o=t(n,i);o!==e.$REMOVE&&r.push(o)}),Collection.create(r)},Collection.prototype.removeRepeatItems=function(){var e=Collection.create();return this.forEach(function(t){e.hasChild(t)||e.addChild(t)}),e},Collection.prototype.hasRepeatItems=function(){var t=Collection.create(),r=!1;return this.forEach(function(n){return t.hasChild(n)?(r=!0,e.$BREAK):void t.addChild(n)}),r},Collection}(e.List);e.Collection=t}(wdCb||(wdCb={}));var wdCb;!function(e){var t=function(){function Hash(e){void 0===e&&(e={}),this._children=null,this._children=e}return Hash.create=function(e){void 0===e&&(e={});var t=new this(e);return t},Hash.prototype.getChildren=function(){return this._children},Hash.prototype.getCount=function(){var e=0,t=this._children,r=null;for(r in t)t.hasOwnProperty(r)&&e++;return e},Hash.prototype.getKeys=function(){var t=e.Collection.create(),r=this._children,n=null;for(n in r)r.hasOwnProperty(n)&&t.addChild(n);return t},Hash.prototype.getValues=function(){var t=e.Collection.create(),r=this._children,n=null;for(n in r)r.hasOwnProperty(n)&&t.addChild(r[n]);return t},Hash.prototype.getChild=function(e){return this._children[e]},Hash.prototype.setValue=function(e,t){return this._children[e]=t,this},Hash.prototype.addChild=function(e,t){return this._children[e]=t,this},Hash.prototype.addChildren=function(e){var t=null,r=null;r=e instanceof Hash?e.getChildren():e;for(t in r)r.hasOwnProperty(t)&&this.addChild(t,r[t]);return this},Hash.prototype.appendChild=function(t,r){if(this._children[t]instanceof e.Collection){var n=this._children[t];n.addChild(r)}else this._children[t]=e.Collection.create().addChild(r);return this},Hash.prototype.setChildren=function(e){this._children=e},Hash.prototype.removeChild=function(t){var r=[];if(e.JudgeUtils.isString(t)){var n=t;r.push(this._children[n]),this._children[n]=void 0,delete this._children[n]}else if(e.JudgeUtils.isFunction(t)){var i=t,o=this;this.forEach(function(e,t){i(e,t)&&(r.push(o._children[t]),o._children[t]=void 0,delete o._children[t])})}return e.Collection.create(r)},Hash.prototype.removeAllChildren=function(){this._children={}},Hash.prototype.hasChild=function(e){return void 0!==this._children[e]},Hash.prototype.hasChildWithFunc=function(t){var r=!1;return this.forEach(function(n,i){if(t(n,i))return r=!0,e.$BREAK}),r},Hash.prototype.forEach=function(t,r){var n=this._children;for(var i in n)if(n.hasOwnProperty(i)&&t.call(r,n[i],i)===e.$BREAK)break;return this},Hash.prototype.filter=function(e){var t={},r=this._children,n=null;for(var i in r)r.hasOwnProperty(i)&&(n=r[i],e.call(r,n,i)&&(t[i]=n));return Hash.create(t)},Hash.prototype.findOne=function(t){var r=[],n=this,i=this._children;return this.forEach(function(o,a){if(t.call(i,o,a))return r=[a,n.getChild(a)],e.$BREAK}),r},Hash.prototype.map=function(t){var r={};return this.forEach(function(n,i){var o=t(n,i);o!==e.$REMOVE&&(e.Log.error(!e.JudgeUtils.isArray(o)||2!==o.length,e.Log.info.FUNC_MUST_BE("iterator","[key, value]")),r[o[0]]=o[1])}),Hash.create(r)},Hash.prototype.toCollection=function(){var t=e.Collection.create();return this.forEach(function(r,n){r instanceof e.Collection?t.addChildren(r):t.addChild(r)}),t},Hash.prototype.toArray=function(){var t=[];return this.forEach(function(r,n){r instanceof e.Collection?t=t.concat(r.getChildren()):t.push(r)}),t},Hash.prototype.clone=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=null;return 0===t.length?(i=!1,n=Hash.create()):1===t.length?e.JudgeUtils.isBoolean(t[0])?(n=Hash.create(),i=t[0]):(n=t[0],i=!1):(n=t[0],i=t[1]),i===!0?n.setChildren(e.ExtendUtils.extendDeep(this._children)):n.setChildren(e.ExtendUtils.extend({},this._children)),n},Hash}();e.Hash=t}(wdCb||(wdCb={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdCb;!function(e){var t=function(e){function Queue(t){void 0===t&&(t=[]),e.call(this),this.children=t}return __extends(Queue,e),Queue.create=function(e){void 0===e&&(e=[]);var t=new this(e);return t},Object.defineProperty(Queue.prototype,"front",{get:function(){return this.children[this.children.length-1]},enumerable:!0,configurable:!0}),Object.defineProperty(Queue.prototype,"rear",{get:function(){return this.children[0]},enumerable:!0,configurable:!0}),Queue.prototype.push=function(e){this.children.unshift(e)},Queue.prototype.pop=function(){return this.children.pop()},Queue.prototype.clear=function(){this.removeAllChildren()},Queue}(e.List);e.Queue=t}(wdCb||(wdCb={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdCb;!function(e){var t=function(t){function Stack(e){void 0===e&&(e=[]),t.call(this),this.children=e}return __extends(Stack,t),Stack.create=function(e){void 0===e&&(e=[]);var t=new this(e);return t},Object.defineProperty(Stack.prototype,"top",{get:function(){return this.children[this.children.length-1]},enumerable:!0,configurable:!0}),Stack.prototype.push=function(e){this.children.push(e)},Stack.prototype.pop=function(){return this.children.pop()},Stack.prototype.clear=function(){this.removeAllChildren()},Stack.prototype.clone=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=null;return 0===t.length?(i=!1,n=Stack.create()):1===t.length?e.JudgeUtils.isBoolean(t[0])?(n=Stack.create(),i=t[0]):(n=t[0],i=!1):(n=t[0],i=t[1]),i===!0?n.setChildren(e.ExtendUtils.extendDeep(this.children)):n.setChildren(e.ExtendUtils.extend([],this.children)),n},Stack.prototype.filter=function(t){for(var r=this.children,n=[],i=null,o=0,a=r.length;o<a;o++)i=r[o],t.call(r,i,o)&&n.push(i);return e.Collection.create(n)},Stack.prototype.findOne=function(t){var r=this.children,n=null;return this.forEach(function(i,o){if(t.call(r,i,o))return n=i,e.$BREAK}),n},Stack.prototype.reverse=function(){return e.Collection.create(this.copyChildren().reverse())},Stack.prototype.removeChild=function(t){return e.Collection.create(this.removeChildHelper(t))},Stack.prototype.sort=function(t,r){return void 0===r&&(r=!1),r?(this.children.sort(t),this):e.Collection.create(this.copyChildren().sort(t))},Stack.prototype.map=function(t){var r=[];return this.forEach(function(n,i){var o=t(n,i);o!==e.$REMOVE&&r.push(o)}),e.Collection.create(r)},Stack.prototype.removeRepeatItems=function(){var t=e.Collection.create();return this.forEach(function(e){t.hasChild(e)||t.addChild(e)}),t},Stack.prototype.hasRepeatItems=function(){var t=e.Collection.create(),r=!1;return this.forEach(function(n){return t.hasChild(n)?(r=!0,e.$BREAK):void t.addChild(n)}),r},Stack}(e.List);e.Stack=t}(wdCb||(wdCb={}));var wdCb;!function(wdCb){var AjaxUtils=function(){function AjaxUtils(){}return AjaxUtils.ajax=function(conf){var type=conf.type,url=conf.url,data=conf.data,dataType=conf.dataType,success=conf.success,error=conf.error,xhr=null,self=this;if(null===type&&(type="get"),null===dataType&&(dataType="text"),xhr=this._createAjax(error))try{xhr.open(type,url,!0),this._isSoundFile(dataType)&&(xhr.responseType="arraybuffer"),"GET"===type||"get"===type?xhr.send(null):"POST"!==type&&"post"!==type||(xhr.setRequestHeader("content-type","application/x-www-form-urlencoded"),xhr.send(data)),xhr.onreadystatechange=function(){4!==xhr.readyState||200!==xhr.status&&!self._isLocalFile(xhr.status)||("text"===dataType||"TEXT"===dataType?null!==success&&success(xhr.responseText):"xml"===dataType||"XML"===dataType?null!==success&&success(xhr.responseXML):"json"===dataType||"JSON"===dataType?null!==success&&success(eval("("+xhr.responseText+")")):self._isSoundFile(dataType)&&null!==success&&success(xhr.response))}}catch(e){error(xhr,e)}},AjaxUtils._createAjax=function(e){var t=null;try{t=new ActiveXObject("microsoft.xmlhttp")}catch(r){try{t=new XMLHttpRequest}catch(n){return e(t,{message:"您的浏览器不支持ajax，请更换！"}),null}}return t},AjaxUtils._isLocalFile=function(e){return document.URL.contain("file://")&&0===e},AjaxUtils._isSoundFile=function(e){return"arraybuffer"===e},AjaxUtils}();wdCb.AjaxUtils=AjaxUtils}(wdCb||(wdCb={}));var wdCb;!function(e){var t=function(){function ArrayUtils(){}return ArrayUtils.removeRepeatItems=function(e,t){void 0===t&&(t=function(e,t){return e===t});var r=[],n=this;return e.forEach(function(e){n.contain(r,function(r){return t(r,e)})||r.push(e)}),r},ArrayUtils.contain=function(t,r){if(e.JudgeUtils.isFunction(r))for(var n=r,i=0,o=t.length;i<o;i++){var a=t[i];if(n.call(null,a,i))return!0}else for(var i=0,o=t.length;i<o;i++){var a=t[i];if(r===a||a.contain&&a.contain(r))return!0}return!1},ArrayUtils}();e.ArrayUtils=t}(wdCb||(wdCb={}));var wdCb;!function(e){var t=function(){function ConvertUtils(){}return ConvertUtils.toString=function(t){return e.JudgeUtils.isNumber(t)?String(t):e.JudgeUtils.isFunction(t)?this._convertCodeToString(t):e.JudgeUtils.isDirectObject(t)||e.JudgeUtils.isArray(t)?JSON.stringify(t):String(t)},ConvertUtils._convertCodeToString=function(e){return e.toString().split("\n").slice(1,-1).join("\n")+"\n"},ConvertUtils}();e.ConvertUtils=t}(wdCb||(wdCb={}));var wdCb;!function(e){var t=function(){function EventUtils(){}return EventUtils.bindEvent=function(e,t){return function(r){return t.call(e,r)}},EventUtils.addEvent=function(t,r,n){e.JudgeUtils.isHostMethod(t,"addEventListener")?t.addEventListener(r,n,!1):e.JudgeUtils.isHostMethod(t,"attachEvent")?t.attachEvent("on"+r,n):t["on"+r]=n},EventUtils.removeEvent=function(t,r,n){e.JudgeUtils.isHostMethod(t,"removeEventListener")?t.removeEventListener(r,n,!1):e.JudgeUtils.isHostMethod(t,"detachEvent")?t.detachEvent("on"+r,n):t["on"+r]=null},EventUtils}();e.EventUtils=t}(wdCb||(wdCb={}));var wdCb;!function(e){var t=function(){function ExtendUtils(){}return ExtendUtils.extendDeep=function(e,t,r){void 0===r&&(r=function(e,t){return!0});var n=null,i=0,o=Object.prototype.toString,a="[object Array]",s="[object Object]",c="",u=null;if(o.call(e)===a)for(u=t||[],n=0,i=e.length;n<i;n++){var l=e[n];r(l,n)&&(l.clone?u[n]=l.clone():(c=o.call(l),c===a||c===s?(u[n]=c===a?[]:{},ExtendUtils.extendDeep(l,u[n])):u[n]=l))}else if(o.call(e)===s){u=t||{};for(n in e){var l=e[n];r(l,n)&&(l.clone?u[n]=l.clone():(c=o.call(l),c===a||c===s?(u[n]=c===a?[]:{},ExtendUtils.extendDeep(l,u[n])):u[n]=l))}}else u=e;return u},ExtendUtils.extend=function(e,t){var r="";for(r in t)e[r]=t[r];return e},ExtendUtils.copyPublicAttri=function(t){var r={};return this.extendDeep(t,r,function(t,r){return"_"!==r.slice(0,1)&&!e.JudgeUtils.isFunction(t)}),r},ExtendUtils}();e.ExtendUtils=t}(wdCb||(wdCb={}));var wdCb;!function(e){var t=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,r=function(){function PathUtils(){}return PathUtils.basename=function(e,t){var r=this._splitPath(e)[2];return t&&r.substr(-1*t.length)===t&&(r=r.substr(0,r.length-t.length)),r},PathUtils.changeExtname=function(e,t){var t=t||"",r=e.indexOf("?"),n="";return r>0&&(n=e.substring(r),e=e.substring(0,r)),r=e.lastIndexOf("."),r<0?e+t+n:e.substring(0,r)+t+n},PathUtils.changeBasename=function(e,t,r){void 0===r&&(r=!1);var n=null,i=null,o=null;return 0==t.indexOf(".")?this.changeExtname(e,t):(n=e.indexOf("?"),i="",o=r?this.extname(e):"",n>0&&(i=e.substring(n),e=e.substring(0,n)),n=e.lastIndexOf("/"),n=n<=0?0:n+1,e.substring(0,n)+t+o+i)},PathUtils.extname=function(e){return this._splitPath(e)[3]},PathUtils.dirname=function(e){var t=this._splitPath(e),r=t[0],n=t[1];return r||n?(n&&(n=n.substr(0,n.length-1)),r+n):"."},PathUtils._splitPath=function(e){return t.exec(e).slice(1)},PathUtils}();e.PathUtils=r}(wdCb||(wdCb={}));var wdCb;!function(e){var t=function(){function FunctionUtils(){}return FunctionUtils.bind=function(e,t){return function(){return t.apply(e,arguments)}},FunctionUtils}();e.FunctionUtils=t}(wdCb||(wdCb={}));var wdCb;!function(e){var t=function(){function DomQuery(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];return this._doms=null,e.JudgeUtils.isDom(t[0])?this._doms=[t[0]]:this._isDomEleStr(t[0])?this._doms=[this._buildDom(t[0])]:this._doms=document.querySelectorAll(t[0]),this}return DomQuery.create=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=new this(e[0]);return r},DomQuery.prototype.get=function(e){return this._doms[e]},DomQuery.prototype.prepend=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=null;r=this._buildDom(e[0]);for(var n=0,i=this._doms;n<i.length;n++){var o=i[n];1===o.nodeType&&o.insertBefore(r,o.firstChild)}return this},DomQuery.prototype.prependTo=function(e){var t=null;t=DomQuery.create(e);for(var r=0,n=this._doms;r<n.length;r++){var i=n[r];1===i.nodeType&&t.prepend(i)}return this},DomQuery.prototype.remove=function(){for(var e=0,t=this._doms;e<t.length;e++){var r=t[e];r&&r.parentNode&&"BODY"!=r.tagName&&r.parentNode.removeChild(r)}return this},DomQuery.prototype.css=function(e,t){for(var r=0,n=this._doms;r<n.length;r++){var i=n[r];i.style[e]=t}},DomQuery.prototype.attr=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];if(1===e.length){var r=e[0];return this.get(0).getAttribute(r)}for(var n=e[0],i=e[1],o=0,a=this._doms;o<a.length;o++){var s=a[o];s.setAttribute(n,i)}},DomQuery.prototype._isDomEleStr=function(e){return null!==e.match(/<(\w+)[^>]*><\/\1>/)},DomQuery.prototype._buildDom=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(e.JudgeUtils.isString(t[0])){var n=this._createElement("div"),i=t[0];return n.innerHTML=i,n.firstChild}return t[0]},DomQuery.prototype._createElement=function(e){return document.createElement(e)},DomQuery}();e.DomQuery=t}(wdCb||(wdCb={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(e){function JudgeUtils(){e.apply(this,arguments)}return __extends(JudgeUtils,e),JudgeUtils.isPromise=function(t){return!!t&&!e.isFunction.call(this,t.subscribe)&&e.isFunction.call(this,t.then)},JudgeUtils.isEqual=function(e,t){return e.uid===t.uid},JudgeUtils.isIObserver=function(e){return e.next&&e.error&&e.completed},JudgeUtils}(wdCb.JudgeUtils);e.JudgeUtils=t}(wdFrp||(wdFrp={}));var wdFrp;!function(e){e.fromNodeCallback=function(t,r){return function(){for(var n=[],i=0;i<arguments.length;i++)n[i-0]=arguments[i];return e.createStream(function(e){var i=function(t){for(var r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];return t?void e.error(t):(r.length<=1?e.next.apply(e,r):e.next(r),void e.completed())};n.push(i),t.apply(r,n)})}},e.fromStream=function(t,r){return void 0===r&&(r="end"),t.pause&&t.pause(),e.createStream(function(e){var n=function(t){e.next(t)},i=function(t){e.error(t)},o=function(){e.completed()};return t.addListener("data",n),t.addListener("error",i),t.addListener(r,o),t.resume&&t.resume(),function(){t.removeListener("data",n),t.removeListener("error",i),t.removeListener(r,o)}})},e.fromReadableStream=function(t){return e.fromStream(t,"end")},e.fromWritableStream=function(t){return e.fromStream(t,"finish")},e.fromTransformStream=function(t){return e.fromStream(t,"finish")}}(wdFrp||(wdFrp={}));var wdFrp;!function(e){var t=function(){function Entity(e){this._uid=null,this._uid=e+String(Entity.UID++)}return Object.defineProperty(Entity.prototype,"uid",{get:function(){return this._uid},set:function(e){this._uid=e},enumerable:!0,configurable:!0}),Entity.UID=1,Entity}();e.Entity=t}(wdFrp||(wdFrp={}));var wdFrp;!function(e){var t=function(){function Main(){}return Main.isTest=!1,Main}();e.Main=t}(wdFrp||(wdFrp={}));var wdFrp;!function(e){function assert(e,r){void 0===r&&(r="contract error"),t.error(!e,r)}function require(t){return function(r,n,i){var o=i.value;return i.value=function(){for(var r=[],n=0;n<arguments.length;n++)r[n-0]=arguments[n];return e.Main.isTest&&t.apply(this,r),o.apply(this,r)},i}}function ensure(t){return function(r,n,i){var o=i.value;return i.value=function(){for(var r=[],n=0;n<arguments.length;n++)r[n-0]=arguments[n];var i=o.apply(this,r),a=[i].concat(r);return e.Main.isTest&&t.apply(this,a),i},i}}function requireGetter(t){return function(r,n,i){var o=i.get;return i.get=function(){return e.Main.isTest&&t.call(this),o.call(this)},i}}function requireSetter(t){return function(r,n,i){var o=i.set;return i.set=function(r){e.Main.isTest&&t.call(this,r),o.call(this,r)},i}}function ensureGetter(t){return function(r,n,i){var o=i.get;return i.get=function(){var r=o.call(this);return e.Main.isTest&&t.call(this,r),r},i}}function ensureSetter(t){return function(r,n,i){var o=i.set;return i.set=function(r){var n=o.call(this,r),i=[n,r];e.Main.isTest&&t.apply(this,i)},i}}function invariant(t){return function(r){e.Main.isTest&&t(r)}}var t=wdCb.Log;e.assert=assert,e.require=require,e.ensure=ensure,e.requireGetter=requireGetter,e.requireSetter=requireSetter,e.ensureGetter=ensureGetter,e.ensureSetter=ensureSetter,e.invariant=invariant}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(e){function SingleDisposable(t){e.call(this,"SingleDisposable"),this._disposeHandler=null,this._isDisposed=!1,this._disposeHandler=t}return __extends(SingleDisposable,e),SingleDisposable.create=function(e){void 0===e&&(e=function(){});var t=new this(e);return t},SingleDisposable.prototype.setDisposeHandler=function(e){this._disposeHandler=e},SingleDisposable.prototype.dispose=function(){this._isDisposed||(this._isDisposed=!0,this._disposeHandler())},SingleDisposable}(e.Entity);e.SingleDisposable=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(e){function GroupDisposable(t){e.call(this,"GroupDisposable"),this._group=wdCb.Collection.create(),this._isDisposed=!1,t&&this._group.addChild(t)}return __extends(GroupDisposable,e),GroupDisposable.create=function(e){var t=new this(e);return t},GroupDisposable.prototype.add=function(e){return this._group.addChild(e),this},GroupDisposable.prototype.remove=function(e){return this._group.removeChild(e),this},GroupDisposable.prototype.dispose=function(){this._isDisposed||(this._isDisposed=!0,this._group.forEach(function(e){e.dispose()}))},GroupDisposable}(e.Entity);e.GroupDisposable=t}(wdFrp||(wdFrp={}));var wdFrp;!function(e){var t=function(){function InnerSubscription(e,t){this._subject=null,this._observer=null,this._subject=e,this._observer=t}return InnerSubscription.create=function(e,t){var r=new this(e,t);return r},InnerSubscription.prototype.dispose=function(){this._subject.remove(this._observer),this._observer.dispose()},InnerSubscription}();e.InnerSubscription=t}(wdFrp||(wdFrp={}));var wdFrp;!function(e){var t=function(){function InnerSubscriptionGroup(){this._container=wdCb.Collection.create()}return InnerSubscriptionGroup.create=function(){
var e=new this;return e},InnerSubscriptionGroup.prototype.addChild=function(e){this._container.addChild(e)},InnerSubscriptionGroup.prototype.dispose=function(){this._container.forEach(function(e){e.dispose()})},InnerSubscriptionGroup}();e.InnerSubscriptionGroup=t}(wdFrp||(wdFrp={}));var wdFrp;!function(e){e.JudgeUtils.isNodeJs()&&"undefined"!=typeof global?e.root=global:e.root=window}(wdFrp||(wdFrp={}));var wdFrp;!function(e){e.root.RSVP&&(e.root.RSVP.onerror=function(e){throw e},e.root.RSVP.on("error",e.root.RSVP.onerror))}(wdFrp||(wdFrp={}));var wdFrp;!function(e){e.root.requestNextAnimationFrame=function(){var t=void 0,r=void 0,n=null,i=e.root.navigator&&e.root.navigator.userAgent,o=0,a=this;return r=function(t){t=e.root.performance.now(),a.callback(t)},e.root.requestAnimationFrame?requestAnimationFrame:(e.root.webkitRequestAnimationFrame&&(t=e.root.webkitRequestAnimationFrame,e.root.webkitRequestAnimationFrame=function(e,n){return a.callback=e,t(r,n)}),e.root.msRequestAnimationFrame&&(t=e.root.msRequestAnimationFrame,e.root.msRequestAnimationFrame=function(e){return a.callback=e,t(r)}),e.root.mozRequestAnimationFrame&&(o=i.indexOf("rv:"),i.indexOf("Gecko")!=-1&&(n=i.substr(o+3,3),"2.0"===n&&(e.root.mozRequestAnimationFrame=void 0))),e.root.webkitRequestAnimationFrame||e.root.mozRequestAnimationFrame||e.root.oRequestAnimationFrame||e.root.msRequestAnimationFrame||function(t,r){var n,i;e.root.setTimeout(function(){n=e.root.performance.now(),t(n),i=e.root.performance.now(),a.timeout=1e3/60-(i-n)},a.timeout)})}(),e.root.cancelNextRequestAnimationFrame=e.root.cancelRequestAnimationFrame||e.root.webkitCancelAnimationFrame||e.root.webkitCancelRequestAnimationFrame||e.root.mozCancelRequestAnimationFrame||e.root.oCancelRequestAnimationFrame||e.root.msCancelRequestAnimationFrame||clearTimeout}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},__decorate=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a},wdFrp;!function(e){var t=wdCb.Log,r=function(r){function Stream(e){r.call(this,"Stream"),this.scheduler=null,this.subscribeFunc=null,this.subscribeFunc=e||function(){}}return __extends(Stream,r),Stream.prototype.buildStream=function(t){return e.SingleDisposable.create(this.subscribeFunc(t)||function(){})},Stream.prototype["do"]=function(t,r,n){return e.DoStream.create(this,t,r,n)},Stream.prototype.map=function(t){return e.MapStream.create(this,t)},Stream.prototype.flatMap=function(e){return this.map(e).mergeAll()},Stream.prototype.concatMap=function(e){return this.map(e).concatAll()},Stream.prototype.mergeAll=function(){return e.MergeAllStream.create(this)},Stream.prototype.concatAll=function(){return this.merge(1)},Stream.prototype.skipUntil=function(t){return e.SkipUntilStream.create(this,t)},Stream.prototype.takeUntil=function(t){return e.TakeUntilStream.create(this,t)},Stream.prototype.take=function(t){void 0===t&&(t=1);var r=this;return 0===t?e.empty():e.createStream(function(e){r.subscribe(function(r){t>0&&e.next(r),t--,t<=0&&e.completed()},function(t){e.error(t)},function(){e.completed()})})},Stream.prototype.takeLast=function(t){void 0===t&&(t=1);var r=this;return 0===t?e.empty():e.createStream(function(e){var n=[];r.subscribe(function(e){n.push(e),n.length>t&&n.shift()},function(t){e.error(t)},function(){for(;n.length>0;)e.next(n.shift());e.completed()})})},Stream.prototype.takeWhile=function(t,r){void 0===r&&(r=this);var n=this,i=null;return i=wdCb.FunctionUtils.bind(r,t),e.createStream(function(e){var t=0,r=!1;n.subscribe(function(o){if(i(o,t++,n))try{e.next(o),r=!0}catch(a){return void e.error(a)}else r&&e.completed()},function(t){e.error(t)},function(){e.completed()})})},Stream.prototype.lastOrDefault=function(t){void 0===t&&(t=null);var r=this;return e.createStream(function(e){var n=[];r.subscribe(function(e){n.push(e),n.length>1&&n.shift()},function(t){e.error(t)},function(){if(0===n.length)e.next(t);else for(;n.length>0;)e.next(n.shift());e.completed()})})},Stream.prototype.filter=function(t,r){if(void 0===r&&(r=this),this instanceof e.FilterStream){var n=this;return n.internalFilter(t,r)}return e.FilterStream.create(this,t,r)},Stream.prototype.filterWithState=function(t,r){if(void 0===r&&(r=this),this instanceof e.FilterStream){var n=this;return n.internalFilter(t,r)}return e.FilterWithStateStream.create(this,t,r)},Stream.prototype.concat=function(){var t=null;return t=e.JudgeUtils.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments,0),t.unshift(this),e.ConcatStream.create(t)},Stream.prototype.merge=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(e.JudgeUtils.isNumber(t[0])){var n=t[0];return e.MergeStream.create(this,n)}e.JudgeUtils.isArray(t[0])&&(t=arguments[0]);var i=null;return t.unshift(this),i=e.fromArray(t).mergeAll()},Stream.prototype.repeat=function(t){return void 0===t&&(t=-1),e.RepeatStream.create(this,t)},Stream.prototype.ignoreElements=function(){return e.IgnoreElementsStream.create(this)},Stream.prototype.handleSubject=function(e){return!!this._isSubject(e)&&(this._setSubject(e),!0)},Stream.prototype._isSubject=function(t){return t instanceof e.Subject},Stream.prototype._setSubject=function(e){e.source=this},__decorate([e.require(function(r){void 0===r&&(r=1),e.assert(r>=0,t.info.FUNC_SHOULD("count",">= 0"))})],Stream.prototype,"take",null),__decorate([e.require(function(r){void 0===r&&(r=1),e.assert(r>=0,t.info.FUNC_SHOULD("count",">= 0"))})],Stream.prototype,"takeLast",null),Stream}(e.Entity);e.Stream=r}(wdFrp||(wdFrp={}));var wdFrp;!function(e){var t=function(){function Scheduler(){this._requestLoopId=null}return Scheduler.create=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=new this;return r},Object.defineProperty(Scheduler.prototype,"requestLoopId",{get:function(){return this._requestLoopId},set:function(e){this._requestLoopId=e},enumerable:!0,configurable:!0}),Scheduler.prototype.publishRecursive=function(e,t,r){r(t)},Scheduler.prototype.publishInterval=function(t,r,n,i){return e.root.setInterval(function(){r=i(r)},n)},Scheduler.prototype.publishIntervalRequest=function(t,r){var n=this,i=function(t){var o=r(t);o||(n._requestLoopId=e.root.requestNextAnimationFrame(i))};this._requestLoopId=e.root.requestNextAnimationFrame(i)},Scheduler.prototype.publishTimeout=function(t,r,n){return e.root.setTimeout(function(){n(r),t.completed()},r)},Scheduler}();e.Scheduler=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(e){function Observer(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(e.call(this,"Observer"),this._isDisposed=null,this.onUserNext=null,this.onUserError=null,this.onUserCompleted=null,this._isStop=!1,this._disposable=null,1===t.length){var n=t[0];this.onUserNext=function(e){n.next(e)},this.onUserError=function(e){n.error(e)},this.onUserCompleted=function(){n.completed()}}else{var i=t[0],o=t[1],a=t[2];this.onUserNext=i||function(e){},this.onUserError=o||function(e){throw e},this.onUserCompleted=a||function(){}}}return __extends(Observer,e),Object.defineProperty(Observer.prototype,"isDisposed",{get:function(){return this._isDisposed},set:function(e){this._isDisposed=e},enumerable:!0,configurable:!0}),Observer.prototype.next=function(e){if(!this._isStop)return this.onNext(e)},Observer.prototype.error=function(e){this._isStop||(this._isStop=!0,this.onError(e))},Observer.prototype.completed=function(){this._isStop||(this._isStop=!0,this.onCompleted())},Observer.prototype.dispose=function(){this._isStop=!0,this._isDisposed=!0,this._disposable&&this._disposable.dispose()},Observer.prototype.setDisposable=function(e){this._disposable=e},Observer}(e.Entity);e.Observer=t}(wdFrp||(wdFrp={}));var wdFrp;!function(e){var t=function(){function Subject(){this._source=null,this._observer=new e.SubjectObserver}return Subject.create=function(){var e=new this;return e},Object.defineProperty(Subject.prototype,"source",{get:function(){return this._source},set:function(e){this._source=e},enumerable:!0,configurable:!0}),Subject.prototype.subscribe=function(t,r,n){var i=t instanceof e.Observer?t:e.AutoDetachObserver.create(t,r,n);return this._observer.addChild(i),e.InnerSubscription.create(this,i)},Subject.prototype.next=function(e){this._observer.next(e)},Subject.prototype.error=function(e){this._observer.error(e)},Subject.prototype.completed=function(){this._observer.completed()},Subject.prototype.start=function(){this._source&&this._observer.setDisposable(this._source.buildStream(this))},Subject.prototype.remove=function(e){this._observer.removeChild(e)},Subject.prototype.dispose=function(){this._observer.dispose()},Subject}();e.Subject=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function GeneratorSubject(){t.call(this,"GeneratorSubject"),this._isStart=!1,this.observer=new e.SubjectObserver}return __extends(GeneratorSubject,t),GeneratorSubject.create=function(){var e=new this;return e},Object.defineProperty(GeneratorSubject.prototype,"isStart",{get:function(){return this._isStart},set:function(e){this._isStart=e},enumerable:!0,configurable:!0}),GeneratorSubject.prototype.onBeforeNext=function(e){},GeneratorSubject.prototype.onAfterNext=function(e){},GeneratorSubject.prototype.onIsCompleted=function(e){return!1},GeneratorSubject.prototype.onBeforeError=function(e){},GeneratorSubject.prototype.onAfterError=function(e){},GeneratorSubject.prototype.onBeforeCompleted=function(){},GeneratorSubject.prototype.onAfterCompleted=function(){},GeneratorSubject.prototype.subscribe=function(t,r,n){var i=t instanceof e.Observer?t:e.AutoDetachObserver.create(t,r,n);return this.observer.addChild(i),e.InnerSubscription.create(this,i)},GeneratorSubject.prototype.next=function(e){if(this._isStart&&!this.observer.isEmpty())try{this.onBeforeNext(e),this.observer.next(e),this.onAfterNext(e),this.onIsCompleted(e)&&this.completed()}catch(t){this.error(t)}},GeneratorSubject.prototype.error=function(e){this._isStart&&!this.observer.isEmpty()&&(this.onBeforeError(e),this.observer.error(e),this.onAfterError(e))},GeneratorSubject.prototype.completed=function(){this._isStart&&!this.observer.isEmpty()&&(this.onBeforeCompleted(),this.observer.completed(),this.onAfterCompleted())},GeneratorSubject.prototype.toStream=function(){var t=this,r=null;return r=e.AnonymousStream.create(function(e){t.subscribe(e)})},GeneratorSubject.prototype.start=function(){var t=this;this._isStart=!0,this.observer.setDisposable(e.SingleDisposable.create(function(){t.dispose()}))},GeneratorSubject.prototype.stop=function(){this._isStart=!1},GeneratorSubject.prototype.remove=function(e){this.observer.removeChild(e)},GeneratorSubject.prototype.dispose=function(){this.observer.dispose()},GeneratorSubject}(e.Entity);e.GeneratorSubject=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(e){function AnonymousObserver(){e.apply(this,arguments)}return __extends(AnonymousObserver,e),AnonymousObserver.create=function(e,t,r){return new this(e,t,r)},AnonymousObserver.prototype.onNext=function(e){this.onUserNext(e)},AnonymousObserver.prototype.onError=function(e){this.onUserError(e)},AnonymousObserver.prototype.onCompleted=function(){this.onUserCompleted()},AnonymousObserver}(e.Observer);e.AnonymousObserver=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},__decorate=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a},wdFrp;!function(e){var t=function(t){function AutoDetachObserver(){t.apply(this,arguments)}return __extends(AutoDetachObserver,t),AutoDetachObserver.create=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return 1===e.length?new this(e[0]):new this(e[0],e[1],e[2])},AutoDetachObserver.prototype.dispose=function(){this.isDisposed||t.prototype.dispose.call(this)},AutoDetachObserver.prototype.onNext=function(e){try{this.onUserNext(e)}catch(t){this.onError(t)}},AutoDetachObserver.prototype.onError=function(e){try{this.onUserError(e)}catch(t){throw t}finally{this.dispose()}},AutoDetachObserver.prototype.onCompleted=function(){try{this.onUserCompleted(),this.dispose()}catch(e){throw e}},__decorate([e.require(function(){this.isDisposed&&wdCb.Log.warn("only can dispose once")})],AutoDetachObserver.prototype,"dispose",null),AutoDetachObserver}(e.Observer);e.AutoDetachObserver=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(e){function MapObserver(t,r){e.call(this,null,null,null),this._currentObserver=null,this._selector=null,this._currentObserver=t,this._selector=r}return __extends(MapObserver,e),MapObserver.create=function(e,t){return new this(e,t)},MapObserver.prototype.onNext=function(e){var t=null;try{t=this._selector(e)}catch(r){this._currentObserver.error(r)}finally{this._currentObserver.next(t)}},MapObserver.prototype.onError=function(e){this._currentObserver.error(e)},MapObserver.prototype.onCompleted=function(){this._currentObserver.completed()},MapObserver}(e.Observer);e.MapObserver=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(e){function DoObserver(t,r){e.call(this,null,null,null),this._currentObserver=null,this._prevObserver=null,this._currentObserver=t,this._prevObserver=r}return __extends(DoObserver,e),DoObserver.create=function(e,t){return new this(e,t)},DoObserver.prototype.onNext=function(e){try{this._prevObserver.next(e)}catch(t){this._prevObserver.error(t),this._currentObserver.error(t)}finally{this._currentObserver.next(e)}},DoObserver.prototype.onError=function(e){try{this._prevObserver.error(e)}catch(t){}finally{this._currentObserver.error(e)}},DoObserver.prototype.onCompleted=function(){try{this._prevObserver.completed()}catch(e){this._prevObserver.error(e),this._currentObserver.error(e)}finally{this._currentObserver.completed()}},DoObserver}(e.Observer);e.DoObserver=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},__decorate=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a},wdFrp;!function(e){var t=wdCb.Log,r=function(r){function MergeAllObserver(e,t,n){r.call(this,null,null,null),this.done=!1,this.currentObserver=null,this._streamGroup=null,this._groupDisposable=null,this.currentObserver=e,this._streamGroup=t,this._groupDisposable=n}return __extends(MergeAllObserver,r),MergeAllObserver.create=function(e,t,r){return new this(e,t,r)},MergeAllObserver.prototype.onNext=function(t){e.JudgeUtils.isPromise(t)&&(t=e.fromPromise(t)),this._streamGroup.addChild(t),this._groupDisposable.add(t.buildStream(n.create(this,this._streamGroup,t)))},MergeAllObserver.prototype.onError=function(e){this.currentObserver.error(e)},MergeAllObserver.prototype.onCompleted=function(){this.done=!0,0===this._streamGroup.getCount()&&this.currentObserver.completed()},__decorate([e.require(function(r){e.assert(r instanceof e.Stream||e.JudgeUtils.isPromise(r),t.info.FUNC_MUST_BE("innerSource","Stream or Promise"))})],MergeAllObserver.prototype,"onNext",null),MergeAllObserver}(e.Observer);e.MergeAllObserver=r;var n=function(t){function InnerObserver(e,r,n){t.call(this,null,null,null),this._parent=null,this._streamGroup=null,this._currentStream=null,this._parent=e,this._streamGroup=r,this._currentStream=n}return __extends(InnerObserver,t),InnerObserver.create=function(e,t,r){var n=new this(e,t,r);return n},InnerObserver.prototype.onNext=function(e){this._parent.currentObserver.next(e)},InnerObserver.prototype.onError=function(e){this._parent.currentObserver.error(e)},InnerObserver.prototype.onCompleted=function(){var t=this._currentStream,r=this._parent;this._streamGroup.removeChild(function(r){return e.JudgeUtils.isEqual(r,t)}),this._isAsync()&&0===this._streamGroup.getCount()&&r.currentObserver.completed()},InnerObserver.prototype._isAsync=function(){return this._parent.done},InnerObserver}(e.Observer)}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},__decorate=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a},wdFrp;!function(e){var t=wdCb.Log,r=function(r){function MergeObserver(e,t,n,i){r.call(this,null,null,null),this.done=!1,this.currentObserver=null,this.activeCount=0,this.q=[],this._maxConcurrent=null,this._groupDisposable=null,this._streamGroup=null,this.currentObserver=e,this._maxConcurrent=t,this._streamGroup=n,this._groupDisposable=i}return __extends(MergeObserver,r),MergeObserver.create=function(e,t,r,n){return new this(e,t,r,n)},MergeObserver.prototype.handleSubscribe=function(t){e.JudgeUtils.isPromise(t)&&(t=e.fromPromise(t)),this._streamGroup.addChild(t),this._groupDisposable.add(t.buildStream(n.create(this,this._streamGroup,t)))},MergeObserver.prototype.onNext=function(e){return this._isReachMaxConcurrent()?(this.activeCount++,void this.handleSubscribe(e)):void this.q.push(e)},MergeObserver.prototype.onError=function(e){this.currentObserver.error(e)},MergeObserver.prototype.onCompleted=function(){this.done=!0,0===this._streamGroup.getCount()&&this.currentObserver.completed()},MergeObserver.prototype._isReachMaxConcurrent=function(){return this.activeCount<this._maxConcurrent},__decorate([e.require(function(r){e.assert(r instanceof e.Stream||e.JudgeUtils.isPromise(r),t.info.FUNC_MUST_BE("innerSource","Stream or Promise"))})],MergeObserver.prototype,"onNext",null),MergeObserver}(e.Observer);e.MergeObserver=r;var n=function(e){function InnerObserver(t,r,n){e.call(this,null,null,null),this._parent=null,this._streamGroup=null,this._currentStream=null,this._parent=t,this._streamGroup=r,this._currentStream=n}return __extends(InnerObserver,e),InnerObserver.create=function(e,t,r){var n=new this(e,t,r);return n},InnerObserver.prototype.onNext=function(e){this._parent.currentObserver.next(e)},InnerObserver.prototype.onError=function(e){this._parent.currentObserver.error(e)},InnerObserver.prototype.onCompleted=function(){var e=this._parent;this._streamGroup.removeChild(this._currentStream),e.q.length>0?(e.activeCount=0,e.handleSubscribe(e.q.shift())):this._isAsync()&&0===this._streamGroup.getCount()&&e.currentObserver.completed()},InnerObserver.prototype._isAsync=function(){return this._parent.done},InnerObserver}(e.Observer)}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(e){function TakeUntilObserver(t){e.call(this,null,null,null),this._prevObserver=null,this._prevObserver=t}return __extends(TakeUntilObserver,e),TakeUntilObserver.create=function(e){return new this(e)},TakeUntilObserver.prototype.onNext=function(e){this._prevObserver.completed()},TakeUntilObserver.prototype.onError=function(e){this._prevObserver.error(e)},TakeUntilObserver.prototype.onCompleted=function(){},TakeUntilObserver}(e.Observer);e.TakeUntilObserver=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(e){function SkipUntilSourceObserver(t,r){e.call(this,null,null,null),this._prevObserver=null,this._skipUntilStream=null,this._prevObserver=t,this._skipUntilStream=r}return __extends(SkipUntilSourceObserver,e),SkipUntilSourceObserver.create=function(e,t){return new this(e,t)},SkipUntilSourceObserver.prototype.onNext=function(e){this._skipUntilStream.isOpen&&this._prevObserver.next(e)},SkipUntilSourceObserver.prototype.onError=function(e){this._prevObserver.error(e)},SkipUntilSourceObserver.prototype.onCompleted=function(){this._skipUntilStream.isOpen&&this._prevObserver.completed()},SkipUntilSourceObserver}(e.Observer);e.SkipUntilSourceObserver=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(e){function SkipUntilOtherObserver(t,r){e.call(this,null,null,null),this.otherDisposable=null,this._prevObserver=null,this._skipUntilStream=null,this._prevObserver=t,this._skipUntilStream=r}return __extends(SkipUntilOtherObserver,e),SkipUntilOtherObserver.create=function(e,t){return new this(e,t)},SkipUntilOtherObserver.prototype.onNext=function(e){this._skipUntilStream.isOpen=!0,this.otherDisposable.dispose()},SkipUntilOtherObserver.prototype.onError=function(e){this._prevObserver.error(e)},SkipUntilOtherObserver.prototype.onCompleted=function(){this.otherDisposable.dispose()},SkipUntilOtherObserver}(e.Observer);e.SkipUntilOtherObserver=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(e){function ConcatObserver(t,r){e.call(this,null,null,null),this.currentObserver=null,this._startNextStream=null,this.currentObserver=t,this._startNextStream=r}return __extends(ConcatObserver,e),ConcatObserver.create=function(e,t){return new this(e,t)},ConcatObserver.prototype.onNext=function(e){this.currentObserver.next(e)},ConcatObserver.prototype.onError=function(e){this.currentObserver.error(e)},ConcatObserver.prototype.onCompleted=function(){this._startNextStream()},ConcatObserver}(e.Observer);e.ConcatObserver=t}(wdFrp||(wdFrp={}));var wdFrp;!function(e){var t=function(){function SubjectObserver(){this.observers=wdCb.Collection.create(),this._disposable=null}return SubjectObserver.prototype.isEmpty=function(){return 0===this.observers.getCount()},SubjectObserver.prototype.next=function(e){this.observers.forEach(function(t){t.next(e)})},SubjectObserver.prototype.error=function(e){this.observers.forEach(function(t){t.error(e)})},SubjectObserver.prototype.completed=function(){this.observers.forEach(function(e){e.completed()})},SubjectObserver.prototype.addChild=function(e){this.observers.addChild(e),e.setDisposable(this._disposable)},SubjectObserver.prototype.removeChild=function(t){this.observers.removeChild(function(r){return e.JudgeUtils.isEqual(r,t)})},SubjectObserver.prototype.dispose=function(){this.observers.forEach(function(e){e.dispose()}),this.observers.removeAllChildren()},SubjectObserver.prototype.setDisposable=function(e){this.observers.forEach(function(t){t.setDisposable(e)}),this._disposable=e},SubjectObserver}();e.SubjectObserver=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(e){function IgnoreElementsObserver(t){e.call(this,null,null,null),this._currentObserver=null,this._currentObserver=t}return __extends(IgnoreElementsObserver,e),IgnoreElementsObserver.create=function(e){return new this(e)},IgnoreElementsObserver.prototype.onNext=function(e){},IgnoreElementsObserver.prototype.onError=function(e){this._currentObserver.error(e)},IgnoreElementsObserver.prototype.onCompleted=function(){this._currentObserver.completed()},IgnoreElementsObserver}(e.Observer);e.IgnoreElementsObserver=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(e){function FilterObserver(t,r,n){e.call(this,null,null,null),this.prevObserver=null,this.source=null,this.i=0,this.predicate=null,this.prevObserver=t,this.predicate=r,this.source=n}return __extends(FilterObserver,e),FilterObserver.create=function(e,t,r){return new this(e,t,r)},FilterObserver.prototype.onNext=function(e){try{this.predicate(e,this.i++,this.source)&&this.prevObserver.next(e)}catch(t){this.prevObserver.error(t)}},FilterObserver.prototype.onError=function(e){this.prevObserver.error(e)},FilterObserver.prototype.onCompleted=function(){this.prevObserver.completed()},FilterObserver}(e.Observer);e.FilterObserver=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function FilterWithStateObserver(){t.apply(this,arguments),this._isTrigger=!1}return __extends(FilterWithStateObserver,t),FilterWithStateObserver.create=function(e,t,r){return new this(e,t,r)},FilterWithStateObserver.prototype.onNext=function(t){var r=null;try{this.predicate(t,this.i++,this.source)?(r=this._isTrigger?{value:t,state:e.FilterState.TRIGGER}:{value:t,state:e.FilterState.ENTER},this.prevObserver.next(r),this._isTrigger=!0):(this._isTrigger&&(r={value:t,state:e.FilterState.LEAVE},this.prevObserver.next(r)),this._isTrigger=!1)}catch(n){this.prevObserver.error(n)}},FilterWithStateObserver}(e.FilterObserver);e.FilterWithStateObserver=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function BaseStream(){t.apply(this,arguments)}return __extends(BaseStream,t),BaseStream.prototype.subscribe=function(t,r,n){var i=null;if(!this.handleSubject(t))return i=t instanceof e.Observer?e.AutoDetachObserver.create(t):e.AutoDetachObserver.create(t,r,n),i.setDisposable(this.buildStream(i)),i},BaseStream.prototype.buildStream=function(e){return t.prototype.buildStream.call(this,e),this.subscribeCore(e)},BaseStream}(e.Stream);e.BaseStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function DoStream(r,n,i,o){t.call(this,null),this._source=null,this._observer=null,this._source=r,this._observer=e.AnonymousObserver.create(n,i,o),this.scheduler=this._source.scheduler}return __extends(DoStream,t),DoStream.create=function(e,t,r,n){var i=new this(e,t,r,n);return i},DoStream.prototype.subscribeCore=function(t){return this._source.buildStream(e.DoObserver.create(t,this._observer))},DoStream}(e.BaseStream);e.DoStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function MapStream(e,r){t.call(this,null),this._source=null,this._selector=null,this._source=e,this.scheduler=this._source.scheduler,this._selector=r}return __extends(MapStream,t),MapStream.create=function(e,t){var r=new this(e,t);return r},MapStream.prototype.subscribeCore=function(t){return this._source.buildStream(e.MapObserver.create(t,this._selector))},MapStream}(e.BaseStream);e.MapStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function FromArrayStream(e,r){t.call(this,null),this._array=null,this._array=e,this.scheduler=r}return __extends(FromArrayStream,t),FromArrayStream.create=function(e,t){var r=new this(e,t);return r},FromArrayStream.prototype.subscribeCore=function(t){function loopRecursive(e){e<n?(t.next(r[e]),loopRecursive(e+1)):t.completed()}var r=this._array,n=r.length;return this.scheduler.publishRecursive(t,0,loopRecursive),e.SingleDisposable.create()},FromArrayStream}(e.BaseStream);e.FromArrayStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function FromPromiseStream(e,r){t.call(this,null),this._promise=null,this._promise=e,this.scheduler=r}return __extends(FromPromiseStream,t),FromPromiseStream.create=function(e,t){var r=new this(e,t);return r},FromPromiseStream.prototype.subscribeCore=function(t){return this._promise.then(function(e){t.next(e),t.completed()},function(e){t.error(e)},t),e.SingleDisposable.create()},FromPromiseStream}(e.BaseStream);e.FromPromiseStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function FromEventPatternStream(e,r){t.call(this,null),this._addHandler=null,this._removeHandler=null,this._addHandler=e,this._removeHandler=r}return __extends(FromEventPatternStream,t),FromEventPatternStream.create=function(e,t){var r=new this(e,t);return r},FromEventPatternStream.prototype.subscribeCore=function(t){function innerHandler(e){t.next(e)}var r=this;return this._addHandler(innerHandler),e.SingleDisposable.create(function(){r._removeHandler(innerHandler)})},FromEventPatternStream}(e.BaseStream);
e.FromEventPatternStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function AnonymousStream(r){t.call(this,r),this.scheduler=e.Scheduler.create()}return __extends(AnonymousStream,t),AnonymousStream.create=function(e){var t=new this(e);return t},AnonymousStream.prototype.subscribe=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null;if(t[0]instanceof e.Subject){var i=t[0];return void this.handleSubject(i)}if(e.JudgeUtils.isIObserver(t[0]))n=e.AutoDetachObserver.create(t[0]);else{var o=t[0],a=t[1]||null,s=t[2]||null;n=e.AutoDetachObserver.create(o,a,s)}return n.setDisposable(this.buildStream(n)),n},AnonymousStream}(e.Stream);e.AnonymousStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function IntervalStream(e,r){t.call(this,null),this._interval=null,this._interval=e,this.scheduler=r}return __extends(IntervalStream,t),IntervalStream.create=function(e,t){var r=new this(e,t);return r.initWhenCreate(),r},IntervalStream.prototype.initWhenCreate=function(){this._interval=this._interval<=0?1:this._interval},IntervalStream.prototype.subscribeCore=function(t){var r=null;return r=this.scheduler.publishInterval(t,0,this._interval,function(e){return t.next(e),e+1}),e.SingleDisposable.create(function(){e.root.clearInterval(r)})},IntervalStream}(e.BaseStream);e.IntervalStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function IntervalRequestStream(e){t.call(this,null),this._isEnd=!1,this.scheduler=e}return __extends(IntervalRequestStream,t),IntervalRequestStream.create=function(e){var t=new this(e);return t},IntervalRequestStream.prototype.subscribeCore=function(t){var r=this;return this.scheduler.publishIntervalRequest(t,function(e){return t.next(e),r._isEnd}),e.SingleDisposable.create(function(){e.root.cancelNextRequestAnimationFrame(r.scheduler.requestLoopId),r._isEnd=!0})},IntervalRequestStream}(e.BaseStream);e.IntervalRequestStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},__decorate=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a},wdFrp;!function(e){var t=wdCb.Log,r=function(r){function TimeoutStream(e,t){r.call(this,null),this._time=null,this._time=e,this.scheduler=t}return __extends(TimeoutStream,r),TimeoutStream.create=function(e,t){var r=new this(e,t);return r},TimeoutStream.prototype.subscribeCore=function(t){var r=null;return r=this.scheduler.publishTimeout(t,this._time,function(e){t.next(e)}),e.SingleDisposable.create(function(){e.root.clearTimeout(r)})},__decorate([e.require(function(r,n){e.assert(r>0,t.info.FUNC_SHOULD("time","> 0"))})],TimeoutStream,"create",null),TimeoutStream}(e.BaseStream);e.TimeoutStream=r}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function MergeAllStream(e){t.call(this,null),this._source=null,this._observer=null,this._source=e,this.scheduler=this._source.scheduler}return __extends(MergeAllStream,t),MergeAllStream.create=function(e){var t=new this(e);return t},MergeAllStream.prototype.subscribeCore=function(t){var r=wdCb.Collection.create(),n=e.GroupDisposable.create();return this._source.buildStream(e.MergeAllObserver.create(t,r,n)),n},MergeAllStream}(e.BaseStream);e.MergeAllStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function MergeStream(e,r){t.call(this,null),this._source=null,this._maxConcurrent=null,this._source=e,this._maxConcurrent=r,this.scheduler=this._source.scheduler}return __extends(MergeStream,t),MergeStream.create=function(e,t){var r=new this(e,t);return r},MergeStream.prototype.subscribeCore=function(t){var r=wdCb.Collection.create(),n=e.GroupDisposable.create();return this._source.buildStream(e.MergeObserver.create(t,this._maxConcurrent,r,n)),n},MergeStream}(e.BaseStream);e.MergeStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function TakeUntilStream(r,n){t.call(this,null),this._source=null,this._otherStream=null,this._source=r,this._otherStream=e.JudgeUtils.isPromise(n)?e.fromPromise(n):n,this.scheduler=this._source.scheduler}return __extends(TakeUntilStream,t),TakeUntilStream.create=function(e,t){var r=new this(e,t);return r},TakeUntilStream.prototype.subscribeCore=function(t){var r=e.GroupDisposable.create(),n=e.AutoDetachObserver.create(t),i=null;return i=this._source.buildStream(t),r.add(i),n.setDisposable(i),r.add(this._otherStream.buildStream(e.TakeUntilObserver.create(n))),r},TakeUntilStream}(e.BaseStream);e.TakeUntilStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function SkipUntilStream(r,n){t.call(this,null),this.isOpen=!1,this._source=null,this._otherStream=null,this._source=r,this._otherStream=e.JudgeUtils.isPromise(n)?e.fromPromise(n):n,this.scheduler=this._source.scheduler}return __extends(SkipUntilStream,t),SkipUntilStream.create=function(e,t){var r=new this(e,t);return r},SkipUntilStream.prototype.subscribeCore=function(t){var r=e.GroupDisposable.create(),n=null,i=null;return r.add(this._source.buildStream(e.SkipUntilSourceObserver.create(t,this))),i=e.SkipUntilOtherObserver.create(t,this),n=this._otherStream.buildStream(i),i.otherDisposable=n,r.add(n),r},SkipUntilStream}(e.BaseStream);e.SkipUntilStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function ConcatStream(r){t.call(this,null),this._sources=wdCb.Collection.create();var n=this;this.scheduler=r[0].scheduler,r.forEach(function(t){e.JudgeUtils.isPromise(t)?n._sources.addChild(e.fromPromise(t)):n._sources.addChild(t)})}return __extends(ConcatStream,t),ConcatStream.create=function(e){var t=new this(e);return t},ConcatStream.prototype.subscribeCore=function(t){function loopRecursive(o){return o===n?void t.completed():void i.add(r._sources.getChild(o).buildStream(e.ConcatObserver.create(t,function(){loopRecursive(o+1)})))}var r=this,n=this._sources.getCount(),i=e.GroupDisposable.create();return this.scheduler.publishRecursive(t,0,loopRecursive),e.GroupDisposable.create(i)},ConcatStream}(e.BaseStream);e.ConcatStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function RepeatStream(e,r){t.call(this,null),this._source=null,this._count=null,this._source=e,this._count=r,this.scheduler=this._source.scheduler}return __extends(RepeatStream,t),RepeatStream.create=function(e,t){var r=new this(e,t);return r},RepeatStream.prototype.subscribeCore=function(t){function loopRecursive(i){return 0===i?void t.completed():void n.add(r._source.buildStream(e.ConcatObserver.create(t,function(){loopRecursive(i-1)})))}var r=this,n=e.GroupDisposable.create();return this.scheduler.publishRecursive(t,this._count,loopRecursive),e.GroupDisposable.create(n)},RepeatStream}(e.BaseStream);e.RepeatStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function IgnoreElementsStream(e){t.call(this,null),this._source=null,this._source=e,this.scheduler=this._source.scheduler}return __extends(IgnoreElementsStream,t),IgnoreElementsStream.create=function(e){var t=new this(e);return t},IgnoreElementsStream.prototype.subscribeCore=function(t){return this._source.buildStream(e.IgnoreElementsObserver.create(t))},IgnoreElementsStream}(e.BaseStream);e.IgnoreElementsStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function DeferStream(e){t.call(this,null),this._buildStreamFunc=null,this._buildStreamFunc=e}return __extends(DeferStream,t),DeferStream.create=function(e){var t=new this(e);return t},DeferStream.prototype.subscribeCore=function(t){var r=e.GroupDisposable.create();return r.add(this._buildStreamFunc().buildStream(t)),r},DeferStream}(e.BaseStream);e.DeferStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function FilterStream(e,r,n){t.call(this,null),this.predicate=null,this._source=null,this._source=e,this.predicate=wdCb.FunctionUtils.bind(n,r)}return __extends(FilterStream,t),FilterStream.create=function(e,t,r){var n=new this(e,t,r);return n},FilterStream.prototype.subscribeCore=function(e){return this._source.subscribe(this.createObserver(e))},FilterStream.prototype.internalFilter=function(e,t){return this.createStreamForInternalFilter(this._source,this._innerPredicate(e,this),t)},FilterStream.prototype.createObserver=function(t){return e.FilterObserver.create(t,this.predicate,this)},FilterStream.prototype.createStreamForInternalFilter=function(e,t,r){return FilterStream.create(e,t,r)},FilterStream.prototype._innerPredicate=function(e,t){var r=this;return function(n,i,o){return t.predicate(n,i,o)&&e.call(r,n,i,o)}},FilterStream}(e.BaseStream);e.FilterStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function FilterWithStateStream(){t.apply(this,arguments)}return __extends(FilterWithStateStream,t),FilterWithStateStream.create=function(e,t,r){var n=new this(e,t,r);return n},FilterWithStateStream.prototype.createObserver=function(t){return e.FilterWithStateObserver.create(t,this.predicate,this)},FilterWithStateStream.prototype.createStreamForInternalFilter=function(e,t,r){return FilterWithStateStream.create(e,t,r)},FilterWithStateStream}(e.FilterStream);e.FilterWithStateStream=t}(wdFrp||(wdFrp={}));var wdFrp;!function(e){e.createStream=function(t){return e.AnonymousStream.create(t)},e.fromArray=function(t,r){return void 0===r&&(r=e.Scheduler.create()),e.FromArrayStream.create(t,r)},e.fromPromise=function(t,r){return void 0===r&&(r=e.Scheduler.create()),e.FromPromiseStream.create(t,r)},e.fromEventPattern=function(t,r){return e.FromEventPatternStream.create(t,r)},e.interval=function(t,r){return void 0===r&&(r=e.Scheduler.create()),e.IntervalStream.create(t,r)},e.intervalRequest=function(t){return void 0===t&&(t=e.Scheduler.create()),e.IntervalRequestStream.create(t)},e.timeout=function(t,r){return void 0===r&&(r=e.Scheduler.create()),e.TimeoutStream.create(t,r)},e.empty=function(){return e.createStream(function(e){e.completed()})},e.callFunc=function(t,r){return void 0===r&&(r=e.root),e.createStream(function(e){try{e.next(t.call(r,null))}catch(n){e.error(n)}e.completed()})},e.judge=function(e,t,r){return e()?t():r()},e.defer=function(t){return e.DeferStream.create(t)},e.just=function(t){return e.createStream(function(e){e.next(t),e.completed()})}}(wdFrp||(wdFrp={}));var wdFrp;!function(e){!function(e){e[e.TRIGGER=0]="TRIGGER",e[e.ENTER=1]="ENTER",e[e.LEAVE=2]="LEAVE"}(e.FilterState||(e.FilterState={}));e.FilterState}(wdFrp||(wdFrp={}));var wdFrp;!function(e){var t=function(e,t){return e===t},r=function(){function Record(e,r,n,i){this._time=null,this._value=null,this._actionType=null,this._comparer=null,this._time=e,this._value=r,this._actionType=n,this._comparer=i||t}return Record.create=function(e,t,r,n){var i=new this(e,t,r,n);return i},Object.defineProperty(Record.prototype,"time",{get:function(){return this._time},set:function(e){this._time=e},enumerable:!0,configurable:!0}),Object.defineProperty(Record.prototype,"value",{get:function(){return this._value},set:function(e){this._value=e},enumerable:!0,configurable:!0}),Object.defineProperty(Record.prototype,"actionType",{get:function(){return this._actionType},set:function(e){this._actionType=e},enumerable:!0,configurable:!0}),Record.prototype.equals=function(e){return this._time===e.time&&this._comparer(this._value,e.value)},Record}();e.Record=r}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function MockObserver(e){t.call(this,null,null,null),this._messages=[],this._scheduler=null,this._scheduler=e}return __extends(MockObserver,t),MockObserver.create=function(e){var t=new this(e);return t},Object.defineProperty(MockObserver.prototype,"messages",{get:function(){return this._messages},set:function(e){this._messages=e},enumerable:!0,configurable:!0}),MockObserver.prototype.onNext=function(t){var r=null;r=e.JudgeUtils.isDirectObject(t)?e.Record.create(this._scheduler.clock,t,e.ActionType.NEXT,function(e,t){var r=!0;for(var n in e)if(e.hasOwnProperty(n)&&e[n]!==t[n]){r=!1;break}return r}):e.Record.create(this._scheduler.clock,t,e.ActionType.NEXT),this._messages.push(r)},MockObserver.prototype.onError=function(t){this._messages.push(e.Record.create(this._scheduler.clock,t,e.ActionType.ERROR))},MockObserver.prototype.onCompleted=function(){this._messages.push(e.Record.create(this._scheduler.clock,null,e.ActionType.COMPLETED))},MockObserver.prototype.dispose=function(){t.prototype.dispose.call(this),this._scheduler.remove(this)},MockObserver.prototype.clone=function(){var e=MockObserver.create(this._scheduler);return e.messages=this._messages,e},MockObserver}(e.Observer);e.MockObserver=t}(wdFrp||(wdFrp={}));var wdFrp;!function(e){var t=function(){function MockPromise(e,t){this._messages=[],this._scheduler=null,this._scheduler=e,this._messages=t}return MockPromise.create=function(e,t){var r=new this(e,t);return r},MockPromise.prototype.then=function(e,t,r){this._scheduler.setStreamMap(r,this._messages)},MockPromise}();e.MockPromise=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=200,r=1e3,n=function(n){function TestScheduler(e){n.call(this),this._clock=null,this._isReset=!1,this._isDisposed=!1,this._timerMap=wdCb.Hash.create(),this._streamMap=wdCb.Hash.create(),this._subscribedTime=null,this._disposedTime=null,this._observer=null,this._isReset=e}return __extends(TestScheduler,n),TestScheduler.next=function(t,r){return e.JudgeUtils.isDirectObject(r)?e.Record.create(t,r,e.ActionType.NEXT,function(e,t){var r=!0;for(var n in e)if(e.hasOwnProperty(n)&&e[n]!==t[n]){r=!1;break}return r}):e.Record.create(t,r,e.ActionType.NEXT)},TestScheduler.error=function(t,r){return e.Record.create(t,r,e.ActionType.ERROR)},TestScheduler.completed=function(t){return e.Record.create(t,null,e.ActionType.COMPLETED)},TestScheduler.create=function(e){void 0===e&&(e=!1);var t=new this(e);return t},Object.defineProperty(TestScheduler.prototype,"clock",{get:function(){return this._clock},set:function(e){this._clock=e},enumerable:!0,configurable:!0}),TestScheduler.prototype.setStreamMap=function(t,r){var n=this;r.forEach(function(r){var i=null;switch(r.actionType){case e.ActionType.NEXT:i=function(){t.next(r.value)};break;case e.ActionType.ERROR:i=function(){t.error(r.value)};break;case e.ActionType.COMPLETED:i=function(){t.completed()};break;default:wdCb.Log.error(!0,wdCb.Log.info.FUNC_UNKNOW("actionType"))}n._streamMap.addChild(String(r.time),i)})},TestScheduler.prototype.remove=function(e){this._isDisposed=!0},TestScheduler.prototype.publishRecursive=function(e,t,r){var n=this,i=null,o=null;this._setClock(),i=e.next,o=e.completed,e.next=function(t){i.call(e,t),n._tick(1)},e.completed=function(){o.call(e),n._tick(1)},r(t)},TestScheduler.prototype.publishInterval=function(e,t,r,n){var i=10,o=[];for(this._setClock();i>0&&!this._isDisposed;)this._tick(r),o.push(TestScheduler.next(this._clock,t)),t++,i--;return this.setStreamMap(e,o),NaN},TestScheduler.prototype.publishIntervalRequest=function(e,t){var r=10,n=[],i=100,o=0;for(this._setClock();r>0&&!this._isDisposed;)this._tick(i),n.push(TestScheduler.next(this._clock,o)),o++,r--;return this.setStreamMap(e,n),NaN},TestScheduler.prototype.publishTimeout=function(e,t,r){var n=[];return this._setClock(),this._tick(t),n.push(TestScheduler.next(this._clock,t),TestScheduler.completed(this._clock+1)),this.setStreamMap(e,n),NaN},TestScheduler.prototype._setClock=function(){this._isReset&&(this._clock=this._subscribedTime)},TestScheduler.prototype.startWithTime=function(e,t,r){var n,i,o=this.createObserver(),a=this;return this._subscribedTime=t,this._disposedTime=r,this._clock=t,this._runAt(t,function(){n=e(),i=n.subscribe(o)}),this._runAt(r,function(){i.dispose(),a._isDisposed=!0}),this._observer=o,this.start(),o},TestScheduler.prototype.startWithSubscribe=function(e,n){return void 0===n&&(n=t),this.startWithTime(e,n,r)},TestScheduler.prototype.startWithDispose=function(e,n){return void 0===n&&(n=r),this.startWithTime(e,t,n)},TestScheduler.prototype.publicAbsolute=function(e,t){this._runAt(e,function(){t()})},TestScheduler.prototype.start=function(){for(var e=this._getMinAndMaxTime(),t=e[0],r=e[1],n=t;n<=r;)this._clock=n,this._exec(n,this._timerMap),this._clock=n,this._runStream(n),n++,r=this._getMinAndMaxTime()[1]},TestScheduler.prototype.createStream=function(t){return e.TestStream.create(Array.prototype.slice.call(arguments,0),this)},TestScheduler.prototype.createObserver=function(){return e.MockObserver.create(this)},TestScheduler.prototype.createResolvedPromise=function(t,r){return e.MockPromise.create(this,[TestScheduler.next(t,r),TestScheduler.completed(t+1)])},TestScheduler.prototype.createRejectPromise=function(t,r){return e.MockPromise.create(this,[TestScheduler.error(t,r)])},TestScheduler.prototype._getMinAndMaxTime=function(){var e=this._timerMap.getKeys().addChildren(this._streamMap.getKeys());return e=e.map(function(e){return Number(e)}).toArray(),[Math.min.apply(Math,e),Math.max.apply(Math,e)]},TestScheduler.prototype._exec=function(e,t){var r=t.getChild(String(e));r&&r()},TestScheduler.prototype._runStream=function(e){var t=this._streamMap.getChild(String(e));t&&t()},TestScheduler.prototype._runAt=function(e,t){this._timerMap.addChild(String(e),t)},TestScheduler.prototype._tick=function(e){this._clock+=e},TestScheduler}(e.Scheduler);e.TestScheduler=n}(wdFrp||(wdFrp={}));var wdFrp;!function(e){!function(e){e[e.NEXT=0]="NEXT",e[e.ERROR=1]="ERROR",e[e.COMPLETED=2]="COMPLETED"}(e.ActionType||(e.ActionType={}));e.ActionType}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function TestStream(e,r){t.call(this,null),this.scheduler=null,this._messages=null,this._messages=e,this.scheduler=r}return __extends(TestStream,t),TestStream.create=function(e,t){var r=new this(e,t);return r},TestStream.prototype.subscribeCore=function(t){return this.scheduler.setStreamMap(t,this._messages),e.SingleDisposable.create()},TestStream}(e.BaseStream);e.TestStream=t}(wdFrp||(wdFrp={}));var __decorate=this&&this.__decorate||function(e,t,r,n){var i,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(o<3?i(a):o>3?i(t,r,a):i(t,r))||a);return o>3&&a&&Object.defineProperty(t,r,a),a},__extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wd;!function(e){e.DebugConfig={isTest:!1,debugCollision:!1,showDebugPanel:!1}}(wd||(wd={}));var wdFrp;!function(e){e.fromCollection=function(t,r){void 0===r&&(r=e.Scheduler.create());var n=t.toArray();return 0===n.length?e.empty():e.fromArray(n,r)}}(wdFrp||(wdFrp={}));var wd;!function(e){e.CompileConfig={isCompileTest:!0,closeContractTest:!1}}(wd||(wd={}));var wd;!function(e){function assert(t,r){void 0===r&&(r="contract error"),e.Log.error(!t,r)}function describe(e,r,n,i){if(void 0===n&&(n=function(){return!0}),void 0===i&&(i=this),n.call(i,null)){t=i;try{r.call(i,null)}catch(o){assert(!1,e+"->"+o.message)}finally{t=null}}}function it(e,r,n){try{3===arguments.length?r.call(n,null):t?r.call(t,null):r()}catch(i){assert(!1,e+"->"+i.message)}}function require(t){return function(r,n,i){if(e.CompileConfig.isCompileTest){var o=i.value;i.value=function(r){return e.Main.isTest&&t.apply(this,arguments),o.apply(this,arguments)}}return i}}function ensure(t){return function(r,n,i){if(e.CompileConfig.isCompileTest){var o=i.value;i.value=function(r){var n=o.apply(this,arguments);if(e.Main.isTest){for(var i=[n],a=0,s=arguments.length;a<s;a++)i[a+1]=arguments[a];t.apply(this,i)}return n}}return i}}function requireGetterAndSetter(t,r){return function(n,i,o){if(e.CompileConfig.isCompileTest){var a=o.get,s=o.set;o.get=function(){return e.Main.isTest&&t.call(this),a.call(this)},o.set=function(t){e.Main.isTest&&r.call(this,t),s.call(this,t)}}return o}}function requireGetter(t){return function(r,n,i){if(e.CompileConfig.isCompileTest){var o=i.get;i.get=function(){return e.Main.isTest&&t.call(this),o.call(this)}}return i}}function requireSetter(t){return function(r,n,i){if(e.CompileConfig.isCompileTest){var o=i.set;i.set=function(r){e.Main.isTest&&t.call(this,r),o.call(this,r)}}return i}}function ensureGetterAndSetter(t,r){return function(n,i,o){if(e.CompileConfig.isCompileTest){var a=o.get,s=o.set;o.get=function(){var r=a.call(this);return e.Main.isTest&&t.call(this,r),r},o.set=function(t){var n=s.call(this,t);if(e.Main.isTest){var i=[n,t];r.apply(this,i)}}}return o}}function ensureGetter(t){return function(r,n,i){if(e.CompileConfig.isCompileTest){var o=i.get;i.get=function(){var r=o.call(this);return e.Main.isTest&&t.call(this,r),r}}return i}}function ensureSetter(t){return function(r,n,i){if(e.CompileConfig.isCompileTest){var o=i.set;i.set=function(r){var n=o.call(this,r);if(e.Main.isTest){var i=[n,r];t.apply(this,i)}}}return i}}function invariant(t){return function(r){e.CompileConfig.isCompileTest&&e.Main.isTest&&t(r)}}var t=null;e.assert=assert,e.describe=describe,e.it=it,e.require=require,e.ensure=ensure,e.requireGetterAndSetter=requireGetterAndSetter,e.requireGetter=requireGetter,e.requireSetter=requireSetter,e.ensureGetterAndSetter=ensureGetterAndSetter,e.ensureGetter=ensureGetter,e.ensureSetter=ensureSetter,e.invariant=invariant}(wd||(wd={}));var wd;!function(e){function singleton(e){return void 0===e&&(e=!1),function(t){t._instance=null,e?t.getInstance=function(){if(null===t._instance){var e=new t;t._instance=e,e.initWhenCreate()}return t._instance}:t.getInstance=function(){return null===t._instance&&(t._instance=new t),t._instance}}}e.singleton=singleton}(wd||(wd={}));var wd;!function(e){function cacheGetter(e,t,r){return function(n,i,o){var a=o.get;return o.get=function(){var n=null;return e.call(this)?t.call(this):(n=a.call(this),r.call(this,n),n)},o}}function cache(e,t,r){return function(n,i,o){var a=o.value;return o.value=function(n){var i=null,o=null;if(e.apply(this,arguments))return t.apply(this,arguments);i=a.apply(this,arguments),o=[i];for(var s=0,c=arguments.length;s<c;s++)o[s+1]=arguments[s];return r.apply(this,o),i},o}}function cacheBufferForBufferContainer(){return function(e,t,r){var n=r.value;return r.value=function(e){var t=null;return this.container.hasChild(e)?this.container.getChild(e):(t=n.call(this,e),this.container.addChild(e,t),t)},r}}function cacheBufferForBufferContainerWithFuncParam(e){return function(t,r,n){var i=n.value;return n.value=function(t){var r=null,n=this[e](t);return this.container.hasChild(n)?this.container.getChild(n):(r=i.call(this,t),this.container.addChild(n,r),r)},n}}e.cacheGetter=cacheGetter,e.cache=cache,e.cacheBufferForBufferContainer=cacheBufferForBufferContainer,e.cacheBufferForBufferContainerWithFuncParam=cacheBufferForBufferContainerWithFuncParam}(wd||(wd={}));var wd;!function(e){function virtual(e,t,r){return r}e.virtual=virtual}(wd||(wd={}));var wd;!function(e){function script(t){return function(r){e.Script.addScript(t,r)}}e.script=script}(wd||(wd={}));var wd;!function(e){function execOnlyOnce(e){return function(t,r,n){var i=n.value;return n.value=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(!this[e])return this[e]=!0,i.apply(this,t)},n}}e.execOnlyOnce=execOnlyOnce}(wd||(wd={}));var wd;!function(e){function cloneAttributeAsBasicType(e){return c(l.BASIC,wdCb.ExtendUtils.extend({order:0},e))}function cloneAttributeAsCloneable(e){return c(l.CLONEABLE,wdCb.ExtendUtils.extend({order:0},e))}function cloneAttributeAsCustomType(e,t){return c(l.CUSTOM,e,wdCb.ExtendUtils.extend({order:0},t))}var t="not_clone",r=function(e){return e[s(e)]},n=function(e,t){e[s(e)]=t},i=function(e){var t="__decorator_clone",r=null;for(var n in e)if(e.hasOwnProperty(n)&&n.indexOf(t)>-1){r=e[n];break}return r},o=function(t){var o="__decorator_clone_isGathered_"+e.ClassUtils.getClassName(t)+"_cloneAttributeMembers",a=wdCb.Collection.create(),c=function(t){if(t){if(t[o]){var n=r(t);return e.assert(n,e.Log.info.FUNC_NOT_EXIST(""+s(t))),void a.addChildren(n)}c(t.__proto__);var u=i(t);u&&a.addChildren(u)}},u=function(){n(t.__proto__,a),t.__proto__[o]=!0};return c(t.__proto__),u(),r(t)},a=function(e){n(e,wdCb.Collection.create())},s=function(t){return"__decorator_clone_"+e.ClassUtils.getClassName(t)+"_cloneAttributeMembers"},c=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return function(n,i){r(n)||a(n),1===t.length?r(n).addChild({memberName:i,cloneType:e,configData:t[0]}):2===t.length&&r(n).addChild({memberName:i,cloneType:e,cloneFunc:t[0],configData:t[1]})}};e.cloneAttributeAsBasicType=cloneAttributeAsBasicType,e.cloneAttributeAsCloneable=cloneAttributeAsCloneable,e.cloneAttributeAsCustomType=cloneAttributeAsCustomType;var u=function(){function CloneUtils(){}return CloneUtils.clone=function(t,r,n,i){void 0===r&&(r=null),void 0===n&&(n=null),void 0===i&&(i=null);var a=o(t).sort(function(e,t){return e.configData.order-t.configData.order}),s=e.ClassUtils.getClassName(t);return null===i&&(i=n?e[s].create.apply(e[s],n):e[s].create()),a?(a.forEach(function(e){var n=e.cloneType,o=e.memberName;switch(n){case l.CLONEABLE:null!==t[o]&&void 0!==t[o]&&(null!==i[o]?i[o]=t[o].clone(i[o]):i[o]=t[o].clone());break;case l.BASIC:i[o]=t[o];break;case l.CUSTOM:var a=e.cloneFunc;a.call(i,t,i,o,r)}}),i):i},CloneUtils.cloneArray=function(e,t){return void 0===t&&(t=!1),null===e?null:t?wdCb.ExtendUtils.extendDeep(e):[].concat(e)},CloneUtils.markNotClone=function(e){e.hasTag(t)||e.addTag(t)},CloneUtils.isNotClone=function(e){return e.hasTag(t)},__decorate([e.require(function(t,r,n){void 0===r&&(r=null),void 0===n&&(n=null),n&&e.assert(e.JudgeUtils.isArrayExactly(n),e.Log.info.FUNC_MUST_BE("param:createDataArr","be arr"))})],CloneUtils,"clone",null),CloneUtils}();e.CloneUtils=u,function(e){e[e.CLONEABLE=0]="CLONEABLE",e[e.BASIC=1]="BASIC",e[e.CUSTOM=2]="CUSTOM"}(e.CloneType||(e.CloneType={}));var l=e.CloneType}(wd||(wd={}));var wd;!function(e){var t=function(){function AngleUtils(){}return AngleUtils.convertDegreeToRadians=function(e){return e*Math.PI/180},AngleUtils.convertRadiansToDegree=function(e){return 180*e/Math.PI},AngleUtils}();e.AngleUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function ArrayUtils(){e.apply(this,arguments)}return __extends(ArrayUtils,e),ArrayUtils.hasRepeatItems=function(e){for(var t=[],r=!1,n=0,i=e;n<i.length;n++){var o=i[n];if(o){if(this.contain(t,o)){r=!0;break}t.push(o)}}return r},ArrayUtils.contain=function(e,t){for(var r=null,n=0,i=e.length;n<i;n++){if(r=e[n],t.uid&&r.uid&&t.uid==r.uid)return!0;if(t===r)return!0}return!1},ArrayUtils}(wdCb.ArrayUtils);e.ArrayUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function BufferUtils(){}return BufferUtils.convertArrayToArrayBuffer=function(t,r){var n=this._getBufferSize(t);return e.ArrayBuffer.create(r,n,e.EBufferType.FLOAT)},BufferUtils._getBufferSize=function(t){var r=null;switch(t){case e.EVariableType.FLOAT_1:case e.EVariableType.NUMBER_1:r=1;break;case e.EVariableType.FLOAT_2:r=2;break;case e.EVariableType.FLOAT_3:r=3;break;case e.EVariableType.FLOAT_4:r=4;break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("EVariableType",t))}return r},__decorate([e.require(function(t,r){e.it("value:"+r+" should be array",function(){e.expect(e.JudgeUtils.isArrayExactly(r))["true"]})})],BufferUtils,"convertArrayToArrayBuffer",null),BufferUtils}();e.BufferUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ClassUtils(){}return ClassUtils.getClassName=function(e){return e.constructor.name},ClassUtils.getClass=function(t){return e[t]},ClassUtils.hasComponent=function(e,t){var r=this.getClass(t);return void 0!==r&&e.hasComponent(r)},ClassUtils.createClassInstance=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];var n=ClassUtils.getClass(e);return n?n.create.apply(n,t):null},ClassUtils.createClassInstanceOrEmpty=function(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];var i=ClassUtils.getClass(e);return void 0===i&&(i=ClassUtils.getClass(t)),i.create.apply(i,r)},ClassUtils.execSingletonMethod=function(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];var i=this.getClass(e);if(i){var o=i.getInstance();o[t].apply(o,r)}},__decorate([e.ensure(function(t){e.it("should get class name from objInstance.className",function(){e.expect(t).exist,e.expect(""!==t)["true"]})})],ClassUtils,"getClassName",null),__decorate([e.require(function(t,r){
for(var n=this,i=[],o=2;o<arguments.length;o++)i[o-2]=arguments[o];e.it("should exist empty class if class not exist",function(){void 0===n.getClass(t)&&e.expect(n.getClass(r)).exist},this)})],ClassUtils,"createClassInstanceOrEmpty",null),ClassUtils}();e.ClassUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function CoordinateUtils(){}return CoordinateUtils.convertWebGLPositionToCanvasPosition=function(t){var r=e.DeviceManager.getInstance().view;return e.Vector2.create(r.width/2+t.x,r.height/2-t.y)},CoordinateUtils.convertCanvasPositionToWebGLPosition=function(t){var r=e.DeviceManager.getInstance().view;return e.Vector3.create(t.x-r.width/2,r.height/2-t.y,0)},CoordinateUtils.convertLeftCornerPositionToCenterPositionInWebGL=function(t,r,n){return e.Vector2.create(this.convertLeftCornerPositionXToCenterPositionXInWebGL(t.x,r),this.convertLeftCornerPositionYToCenterPositionYInWebGL(t.y,n))},CoordinateUtils.convertLeftCornerPositionXToCenterPositionXInWebGL=function(e,t){return e-t/2},CoordinateUtils.convertLeftCornerPositionYToCenterPositionYInWebGL=function(e,t){return e-t/2},CoordinateUtils.convertLeftCornerPositionToCenterPositionInCanvas=function(t,r,n){return e.Vector2.create(this.convertLeftCornerPositionXToCenterPositionXInCanvas(t.x,r),this.convertLeftCornerPositionYToCenterPositionYInCanvas(t.y,n))},CoordinateUtils.convertLeftCornerPositionXToCenterPositionXInCanvas=function(e,t){return e+t/2},CoordinateUtils.convertLeftCornerPositionYToCenterPositionYInCanvas=function(e,t){return e+t/2},__decorate([e.require(function(){e.assert(!!e.DeviceManager.getInstance().view,e.Log.info.FUNC_SHOULD("set view"))})],CoordinateUtils,"convertWebGLPositionToCanvasPosition",null),__decorate([e.require(function(){e.assert(!!e.DeviceManager.getInstance().view,e.Log.info.FUNC_SHOULD("set view"))})],CoordinateUtils,"convertCanvasPositionToWebGLPosition",null),CoordinateUtils}();e.CoordinateUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function GlobalGeometryUtils(){}return GlobalGeometryUtils.hasMorphAnimation=function(t){return t instanceof e.ModelGeometry&&t.hasMorphAnimation()},GlobalGeometryUtils.hasSkinSkeletonAnimation=function(t){return t instanceof e.ModelGeometry&&t.hasSkinSkeletonAnimation()},GlobalGeometryUtils}();e.GlobalGeometryUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function GlobalScriptUtils(){}return GlobalScriptUtils.addScriptToEntityObject=function(t,r){e.ScriptEngine.getInstance().addChild(t,r.name,new r["class"](t))},GlobalScriptUtils}();e.GlobalScriptUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function GlobalTextureUtils(){}return GlobalTextureUtils.convertSourceRegionCanvasMapToUV=function(t,r,n){var i=null;return i=e.RectRegion.create(t.x/r,t.y/n,t.width/r,t.height/n),i.y=1-i.y-i.height,i},GlobalTextureUtils}();e.GlobalTextureUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function InstanceUtils(){}return InstanceUtils.isHardwareSupport=function(){return null!==e.GPUDetector.getInstance().extensionInstancedArrays},InstanceUtils.isInstance=function(t){return t.hasComponent(e.Instance)},InstanceUtils.isSourceInstance=function(t){return t.hasComponent(e.SourceInstance)},InstanceUtils.isOneToOneSourceInstance=function(t){return t.hasComponent(e.OneToOneSourceInstance)},InstanceUtils.isOneToManySourceInstance=function(t){return t.hasComponent(e.OneToManySourceInstance)},InstanceUtils.isObjectInstance=function(t){return t.hasComponent(e.ObjectInstance)},InstanceUtils.addModelMatrixShaderLib=function(t,r){if(r)return InstanceUtils.isInstance(r)?InstanceUtils.isHardwareSupport()?void t.addLib(e.ModelMatrixHardwareInstanceShaderLib.create()):void t.addLib(e.ModelMatrixBatchInstanceShaderLib.create()):void t.addLib(e.ModelMatrixNoInstanceShaderLib.create())},InstanceUtils.addNormalModelMatrixShaderLib=function(t,r){if(r)return InstanceUtils.isInstance(r)?InstanceUtils.isHardwareSupport()?void t.addLib(e.NormalMatrixHardwareInstanceShaderLib.create()):void t.addLib(e.NormalMatrixBatchInstanceShaderLib.create()):void t.addLib(e.NormalMatrixNoInstanceShaderLib.create())},InstanceUtils}();e.InstanceUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function IterateUtils(){}return IterateUtils.forEachAll=function(e,t){var r=function(e){t(e),e.forEach(function(e){r(e)})};r(e)},IterateUtils}();e.IterateUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function JudgeUtils(){t.apply(this,arguments)}return __extends(JudgeUtils,t),JudgeUtils.isView=function(e){return!!e&&e.offset&&e.width&&e.height&&this.isFunction(e.getContext)},JudgeUtils.isEqual=function(e,t){return!(!e&&t||e&&!t)&&(e.uid&&t.uid?e.uid===t.uid:e===t)},JudgeUtils.isPowerOfTwo=function(e){return 0===(e&e-1)&&0!==e},JudgeUtils.isFloatArray=function(e){return"[object Float32Array]"===Object.prototype.toString.call(e)||"[object Float16Array]"===Object.prototype.toString.call(e)},JudgeUtils.isInterface=function(e,t){return!!e[t]},JudgeUtils.isSpacePartitionObject=function(t){return e.ClassUtils.hasComponent(t,"SpacePartition")},JudgeUtils.isSelf=function(e,t){return e.uid===t.uid},JudgeUtils.isComponenet=function(e){return void 0!==e.entityObject},JudgeUtils.isDom=function(e){return null!==Object.prototype.toString.call(e).match(/\[object HTML\w+/)},JudgeUtils.isCollection=function(e){return e instanceof wdCb.Collection},JudgeUtils.isClass=function(e,t){return e.constructor.name===t},JudgeUtils}(wdCb.JudgeUtils);e.JudgeUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function LightUtils(){}return LightUtils.getPointLightPosition=function(e){return e.position},LightUtils.getDirectionLightPosition=function(t){return this._isZero(t.position)?e.DirectionLight.defaultPosition:t.position},LightUtils._isZero=function(e){var t=e.values;return 0===t[0]&&0===t[1]&&0===t[2]},LightUtils}();e.LightUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function Log(){e.apply(this,arguments)}return __extends(Log,e),Log}(wdCb.Log);e.Log=t}(wd||(wd={}));var wd;!function(e){var t=function(){function MathUtils(){}return MathUtils.clamp=function(e,t,r){return e<t?t:e>r?r:e},MathUtils.bigThan=function(e,t){return e<t?t:e},MathUtils.generateZeroToOne=function(){return Math.random()},MathUtils.generateMinToMax=function(e,t){return Math.random()*(t+1-e)+e},MathUtils.generateInteger=function(e,t){return Math.floor(this.generateMinToMax(e,t))},MathUtils.mod=function(e,t){var r=Math.floor(e/t);return e-=r*t,e<0&&(e+=t),e},MathUtils.maxFloorIntegralMultiple=function(e,t){return 0==t?e:e<t?0:Math.floor(e/t)*t},__decorate([e.require(function(t,r){e.it("min should <= max",function(){e.expect(t).lte(r)})})],MathUtils,"generateMinToMax",null),__decorate([e.ensure(function(t){e.it("result should >= 0",function(){e.expect(t).gte(0)})})],MathUtils,"mod",null),__decorate([e.require(function(t,r){e.it("a,b should >= 0",function(){e.expect(t).gte(0),e.expect(r).gte(0)})}),e.ensure(function(t){e.it("result should >= 0",function(){e.expect(t).gte(0)})})],MathUtils,"maxFloorIntegralMultiple",null),MathUtils}();e.MathUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function RenderUtils(){}return RenderUtils.getGameObjectRenderList=function(t){var r=this,n=[];return t.forEach(function(t){var i=e.ClassUtils.getClass("GameObjectLOD"),o=null;if(void 0!==i){var a=t.getComponent(i);if(o=r._getActiveGameObject(t,a),null===o)return wdCb.Collection.create()}else o=t;o.isVisible&&!e.InstanceUtils.isObjectInstance(o)&&n.push(o)}),wdCb.Collection.create(n)},RenderUtils.getGameObjectRenderListForOctree=function(t){var r=this,n=[];return t.forEach(function(t){var i=e.ClassUtils.getClass("GameObjectLOD"),o=null;if(void 0!==i){var a=t.getComponent(i);if(o=r._getActiveGameObject(t,a),null===o)return wdCb.Collection.create()}else o=t;o.isVisible&&n.push(o)}),wdCb.Collection.create(n)},RenderUtils._getActiveGameObject=function(e,t){return t?t.activeGameObject:e},RenderUtils}();e.RenderUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ShaderLibUtils(){}return ShaderLibUtils.addVerticeShaderLib=function(t,r){e.GlobalGeometryUtils.hasMorphAnimation(t)?(r.addLib(e.ClassUtils.getClass("CommonMorphShaderLib").create()),r.addLib(e.ClassUtils.getClass("VerticeMorphShaderLib").create())):e.GlobalGeometryUtils.hasSkinSkeletonAnimation(t)?(r.addLib(e.VerticeCommonShaderLib.create()),r.addLib(e.ClassUtils.getClass("VerticeSkinSkeletonShaderLib").create())):r.addLib(e.VerticeCommonShaderLib.create())},ShaderLibUtils}();e.ShaderLibUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function SortUtils(){}return SortUtils.insertSort=function(e,t,r){void 0===r&&(r=!1);for(var n=r?e:wdCb.ExtendUtils.extend([],e),i=1,o=n.length;i<o;i++)for(var a=i;a>0&&t(n[a],n[a-1]);a--)this._swap(n,a-1,a);return n},SortUtils.quickSort=function(e,t,r){void 0===r&&(r=!1);var n=r?e:wdCb.ExtendUtils.extend([],e),i=function(e,r){if(!(e>=r)){for(var o=e,a=r,s=n[e];o<a;){for(;o<a&&t(s,n[a]);)a--;for(o<a&&(n[o++]=n[a]);o<a&&t(n[o],s);)o++;o<a&&(n[a--]=n[o])}n[o]=s,i(e,o-1),i(o+1,r)}};return i(0,n.length-1),n},SortUtils._swap=function(e,t,r){var n=null;n=e[t],e[t]=e[r],e[r]=n},SortUtils}();e.SortUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function TimeController(){this.elapsed=null,this.pauseElapsed=0,this.pauseTime=null,this.startTime=null}return TimeController.prototype.start=function(){this.startTime=this.getNow(),this.pauseElapsed=null},TimeController.prototype.stop=function(){this.startTime=null},TimeController.prototype.pause=function(){this.pauseTime=this.getNow()},TimeController.prototype.resume=function(){this.pauseElapsed+=this.getNow()-this.pauseTime,this.pauseTime=null},TimeController.prototype.computeElapseTime=function(e){return this.pauseElapsed?this.elapsed=e-this.pauseElapsed-this.startTime:this.elapsed=e-this.startTime,this.elapsed<0&&(this.elapsed=0),this.elapsed},__decorate([e.ensure(function(){e.assert(this.elapsed>=0,e.Log.info.FUNC_SHOULD("elapsed:"+this.elapsed,">= 0"))})],TimeController.prototype,"computeElapseTime",null),TimeController}();e.TimeController=t}(wd||(wd={}));var wd;!function(e){var t=60,r=1e3,n=function(n){function DirectorTimeController(){n.apply(this,arguments),this.gameTime=null,this.fps=null,this.isTimeChange=!1,this.deltaTime=null,this._lastTime=null}return __extends(DirectorTimeController,n),DirectorTimeController.create=function(){var e=new this;return e},DirectorTimeController.prototype.tick=function(e){this.deltaTime=null!==this._lastTime?e-this._lastTime:e,this._updateFps(this.deltaTime),this.gameTime=e/r,this._lastTime=e},DirectorTimeController.prototype.start=function(){n.prototype.start.call(this),this.isTimeChange=!0,this.elapsed=0},DirectorTimeController.prototype.resume=function(){n.prototype.resume.call(this),this.isTimeChange=!0},DirectorTimeController.prototype.getNow=function(){return e.root.performance.now()},DirectorTimeController.prototype._updateFps=function(e){null===this._lastTime?this.fps=t:this.fps=1e3/e},DirectorTimeController}(e.TimeController);e.DirectorTimeController=n}(wd||(wd={}));var wd;!function(e){var t=function(t){function CommonTimeController(){t.apply(this,arguments)}return __extends(CommonTimeController,t),CommonTimeController.create=function(){var e=new this;return e},CommonTimeController.prototype.getNow=function(){return e.Director.getInstance().isTimeChange?e.Director.getInstance().elapsed:e.root.performance.now()},CommonTimeController}(e.TimeController);e.CommonTimeController=t}(wd||(wd={}));var wd;!function(e){e.DEG_TO_RAD=Math.PI/180,e.RAD_TO_DEG=180/Math.PI}(wd||(wd={}));var wd;!function(e){var t=function(){function Vector2(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];this.values=new Float32Array(2),e.length>0&&(this.values[0]=e[0],this.values[1]=e[1])}return Vector2.create=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=null;return r=0===e.length?new this:new this(e[0],e[1])},Object.defineProperty(Vector2.prototype,"x",{get:function(){return this.values[0]},set:function(e){this.values[0]=e},enumerable:!0,configurable:!0}),Object.defineProperty(Vector2.prototype,"y",{get:function(){return this.values[1]},set:function(e){this.values[1]=e},enumerable:!0,configurable:!0}),Vector2.prototype.set=function(e,t){this.x=e,this.y=t},Vector2.prototype.add=function(e){return this.values[0]=this.values[0]+e.values[0],this.values[1]=this.values[1]+e.values[1],this},Vector2.prototype.mul=function(e){return this.values[0]=this.values[0]*e.values[0],this.values[1]=this.values[1]*e.values[1],this},Vector2.prototype.isEqual=function(e){return this.x===e.x&&this.y===e.y},Vector2.prototype.clone=function(){return Vector2.create(this.x,this.y)},Vector2}();e.Vector2=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Vector3(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];this.values=null,this.values=new Float32Array(3),e.length>0&&(this.values[0]=e[0],this.values[1]=e[1],this.values[2]=e[2])}return Vector3.create=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=null;return r=0===e.length?new this:new this(e[0],e[1],e[2])},Object.defineProperty(Vector3.prototype,"x",{get:function(){return this.values[0]},set:function(e){this.values[0]=e},enumerable:!0,configurable:!0}),Object.defineProperty(Vector3.prototype,"y",{get:function(){return this.values[1]},set:function(e){this.values[1]=e},enumerable:!0,configurable:!0}),Object.defineProperty(Vector3.prototype,"z",{get:function(){return this.values[2]},set:function(e){this.values[2]=e},enumerable:!0,configurable:!0}),Vector3.prototype.normalize=function(){var e=this.values,t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);return 0===t?(e[0]=0,e[1]=0,e[2]=0,this):(e[0]=e[0]/t,e[1]=e[1]/t,e[2]=e[2]/t,e[0]===-0&&(e[0]=0),e[1]===-0&&(e[1]=0),e[2]===-0&&(e[2]=0),this)},Vector3.prototype.isZero=function(){var e=this.values;return 0===e[0]&&0===e[1]&&0===e[2]},Vector3.prototype.scale=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=this.values;if(1===e.length){var n=e[0];r[0]*=n,r[1]*=n,r[2]*=n}else if(3===e.length){var i=e[0],o=e[1],a=e[2];r[0]*=i,r[1]*=o,r[2]*=a}return this},Vector3.prototype.set=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];if(3===e.length)this.x=e[0],this.y=e[1],this.z=e[2];else{var r=e[0];this.x=r.x,this.y=r.y,this.z=r.z}},Vector3.prototype.sub=function(e){return this.values[0]=this.values[0]-e.values[0],this.values[1]=this.values[1]-e.values[1],this.values[2]=this.values[2]-e.values[2],this},Vector3.prototype.sub2=function(e,t){return this.values[0]=e.values[0]-t.values[0],this.values[1]=e.values[1]-t.values[1],this.values[2]=e.values[2]-t.values[2],this},Vector3.prototype.add=function(e){return this.values[0]=this.values[0]+e.values[0],this.values[1]=this.values[1]+e.values[1],this.values[2]=this.values[2]+e.values[2],this},Vector3.prototype.add2=function(e,t){return this.values[0]=e.values[0]+t.values[0],this.values[1]=e.values[1]+t.values[1],this.values[2]=e.values[2]+t.values[2],this},Vector3.prototype.mul=function(e){return this.values[0]=this.values[0]*e.values[0],this.values[1]=this.values[1]*e.values[1],this.values[2]=this.values[2]*e.values[2],this},Vector3.prototype.mul2=function(e,t){return this.values[0]=e.values[0]*t.values[0],this.values[1]=e.values[1]*t.values[1],this.values[2]=e.values[2]*t.values[2],this},Vector3.prototype.reverse=function(){return this.values[0]=-this.values[0],this.values[1]=-this.values[1],this.values[2]=-this.values[2],this},Vector3.prototype.clone=function(){var e=Vector3.create(),t=0,r=this.values.length;for(t=0;t<r;t++)e.values[t]=this.values[t];return e},Vector3.prototype.toVector4=function(){return e.Vector4.create(this.values[0],this.values[1],this.values[2],1)},Vector3.prototype.length=function(){var e=this.values;return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])},Vector3.prototype.cross=function(e,t){var r,n,i,o,a,s,c,u,l;return r=e.values,n=t.values,i=this.values,o=r[0],a=r[1],s=r[2],c=n[0],u=n[1],l=n[2],i[0]=a*l-u*s,i[1]=s*c-l*o,i[2]=o*u-c*a,this},Vector3.prototype.lerp=function(e,t,r){var n=e.values,i=t.values,o=this.values;return o[0]=n[0]+r*(i[0]-n[0]),o[1]=n[1]+r*(i[1]-n[1]),o[2]=n[2]+r*(i[2]-n[2]),this},Vector3.prototype.dot=function(e){var t=this.values,r=e.values;return t[0]*r[0]+t[1]*r[1]+t[2]*r[2]},Vector3.prototype.calAngleCos=function(e){var t=this.length()*e.length();return 0===t?NaN:this.dot(e)/t},Vector3.prototype.min=function(e){return this.x>e.x&&(this.x=e.x),this.y>e.y&&(this.y=e.y),this.z>e.z&&(this.z=e.z),this},Vector3.prototype.max=function(e){return this.x<e.x&&(this.x=e.x),this.y<e.y&&(this.y=e.y),this.z<e.z&&(this.z=e.z),this},Vector3.prototype.isEqual=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z},Vector3.prototype.toArray=function(){return[this.x,this.y,this.z]},Vector3.prototype.applyMatrix3=function(e){var t=this.x,r=this.y,n=this.z,i=e.values;return this.x=i[0]*t+i[3]*r+i[6]*n,this.y=i[1]*t+i[4]*r+i[7]*n,this.z=i[2]*t+i[5]*r+i[8]*n,this},Vector3.prototype.applyMatrix4=function(e){var t=this.x,r=this.y,n=this.z,i=e.values;return this.x=i[0]*t+i[4]*r+i[8]*n+i[12],this.y=i[1]*t+i[5]*r+i[9]*n+i[13],this.z=i[2]*t+i[6]*r+i[10]*n+i[14],this},Vector3.prototype.distanceTo=function(e){return Math.sqrt(this.distanceToSquared(e))},Vector3.prototype.distanceToSquared=function(e){var t=this.x-e.x,r=this.y-e.y,n=this.z-e.z;return Math.pow(t,2)+Math.pow(r,2)+Math.pow(n,2)},Vector3.up=Vector3.create(0,1,0),Vector3.forward=Vector3.create(0,0,1),Vector3.right=Vector3.create(1,0,0),Vector3}();e.Vector3=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Vector4(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];this.values=new Float32Array(4),e.length>0&&(this.values[0]=e[0],this.values[1]=e[1],this.values[2]=e[2],this.values[3]=e[3])}return Vector4.create=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=null;return r=0===e.length?new this:new this(e[0],e[1],e[2],e[3])},Object.defineProperty(Vector4.prototype,"x",{get:function(){return this.values[0]},set:function(e){this.values[0]=e},enumerable:!0,configurable:!0}),Object.defineProperty(Vector4.prototype,"y",{get:function(){return this.values[1]},set:function(e){this.values[1]=e},enumerable:!0,configurable:!0}),Object.defineProperty(Vector4.prototype,"z",{get:function(){return this.values[2]},set:function(e){this.values[2]=e},enumerable:!0,configurable:!0}),Object.defineProperty(Vector4.prototype,"w",{get:function(){return this.values[3]},set:function(e){this.values[3]=e},enumerable:!0,configurable:!0}),Vector4.prototype.normalize=function(){var e=this.values,t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]+e[3]*e[3]);return 0===t?Vector4.create(0,0,0,0):(e[0]=e[0]/t,e[1]=e[1]/t,e[2]=e[2]/t,e[3]=e[3]/t,this)},Vector4.prototype.isEqual=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},Vector4.prototype.clone=function(){return this.copyHelper(Vector4.create())},Vector4.prototype.toVector3=function(){return e.Vector3.create(this.values[0],this.values[1],this.values[2])},Vector4.prototype.lengthManhattan=function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)},Vector4.prototype.multiplyScalar=function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},Vector4.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},Vector4.prototype.set=function(e,t,r,n){this.x=e,this.y=t,this.z=r,this.w=n},Vector4.prototype.copyHelper=function(e){var t=e,r=0,n=this.values.length;for(r=0;r<n;r++)t.values[r]=this.values[r];return t},Vector4}();e.Vector4=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Matrix4(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];this.values=null,this._matrixArr=null,1===e.length?this.values=e[0]:this.values=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._matrixArr=[]}return Matrix4.create=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=null;return r=0===e.length?new this:new this(e[0])},Matrix4.prototype.push=function(){this._matrixArr.push(this.values)},Matrix4.prototype.pop=function(){this.values=this._matrixArr.pop()},Matrix4.prototype.set=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=this.values,n=null;if(1===e.length){var i=e[0];n=i.values}else n=[e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15]];return r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=n[3],r[4]=n[4],r[5]=n[5],r[6]=n[6],r[7]=n[7],r[8]=n[8],r[9]=n[9],r[10]=n[10],r[11]=n[11],r[12]=n[12],r[13]=n[13],r[14]=n[14],r[15]=n[15],this},Matrix4.prototype.setIdentity=function(){var e=this.values;return e[0]=1,e[4]=0,e[8]=0,e[12]=0,e[1]=0,e[5]=1,e[9]=0,e[13]=0,e[2]=0,e[6]=0,e[10]=1,e[14]=0,e[3]=0,e[7]=0,e[11]=0,e[15]=1,this},Matrix4.prototype.invert=function(){var e,t,r,n,i,o,a,s,c,u,l,h,d,p,f,m,g,_,y,v,b,C,E,S,T,M,D,L,w,x;return x=this.values,e=x[0],t=x[1],r=x[2],n=x[3],i=x[4],o=x[5],a=x[6],s=x[7],c=x[8],u=x[9],l=x[10],h=x[11],d=x[12],p=x[13],f=x[14],m=x[15],g=e*o-t*i,_=e*a-r*i,y=e*s-n*i,v=t*a-r*o,b=t*s-n*o,C=r*s-n*a,E=c*p-u*d,S=c*f-l*d,T=c*m-h*d,M=u*f-l*p,D=u*m-h*p,L=l*m-h*f,w=1/(g*L-_*D+y*M+v*T-b*S+C*E),x[0]=(o*L-a*D+s*M)*w,x[1]=(-t*L+r*D-n*M)*w,x[2]=(p*C-f*b+m*v)*w,x[3]=(-u*C+l*b-h*v)*w,x[4]=(-i*L+a*T-s*S)*w,x[5]=(e*L-r*T+n*S)*w,x[6]=(-d*C+f*y-m*_)*w,x[7]=(c*C-l*y+h*_)*w,x[8]=(i*D-o*T+s*E)*w,x[9]=(-e*D+t*T-n*E)*w,x[10]=(d*b-p*y+m*g)*w,x[11]=(-c*b+u*y-h*g)*w,x[12]=(-i*M+o*S-a*E)*w,x[13]=(e*M-t*S+r*E)*w,x[14]=(-d*v+p*_-f*g)*w,x[15]=(c*v-u*_+l*g)*w,this},Matrix4.prototype.invertTo3x3=function(){var t,r,n,i,o,a,s,c,u,l,h,d,p,f=e.Matrix3.create();return l=this.values,h=f.values,t=l[10]*l[5]-l[6]*l[9],r=-l[10]*l[1]+l[2]*l[9],n=l[6]*l[1]-l[2]*l[5],i=-l[10]*l[4]+l[6]*l[8],o=l[10]*l[0]-l[2]*l[8],a=-l[6]*l[0]+l[2]*l[4],s=l[9]*l[4]-l[5]*l[8],c=-l[9]*l[0]+l[1]*l[8],u=l[5]*l[0]-l[1]*l[4],d=l[0]*t+l[1]*i+l[2]*s,0===d?(e.Log.warn("can't invert matrix, determinant is 0"),f):(p=1/d,h[0]=p*t,h[1]=p*r,h[2]=p*n,h[3]=p*i,h[4]=p*o,h[5]=p*a,h[6]=p*s,h[7]=p*c,h[8]=p*u,f)},Matrix4.prototype.transpose=function(){var e,t=this.values;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},Matrix4.prototype.setTranslate=function(e,t,r){var n=this.values;return n[0]=1,n[4]=0,n[8]=0,n[12]=e,n[1]=0,n[5]=1,n[9]=0,n[13]=t,n[2]=0,n[6]=0,n[10]=1,n[14]=r,n[3]=0,n[7]=0,n[11]=0,n[15]=1,this},Matrix4.prototype.translate=function(e,t,r){return this.applyMatrix(Matrix4.create().setTranslate(e,t,r)),this},Matrix4.prototype.setRotate=function(e,t,r,n){var i,o,a,s,c,u,l,h,d,p,f,m,e=Math.PI*e/180;return i=this.values,o=Math.sin(e),a=Math.cos(e),0!==t&&0===r&&0===n?(t<0&&(o=-o),i[0]=1,i[4]=0,i[8]=0,i[12]=0,i[1]=0,i[5]=a,i[9]=-o,i[13]=0,i[2]=0,i[6]=o,i[10]=a,i[14]=0,i[3]=0,i[7]=0,i[11]=0,i[15]=1):0===t&&0!==r&&0===n?(r<0&&(o=-o),i[0]=a,i[4]=0,i[8]=o,i[12]=0,i[1]=0,i[5]=1,i[9]=0,i[13]=0,i[2]=-o,i[6]=0,i[10]=a,i[14]=0,i[3]=0,i[7]=0,i[11]=0,i[15]=1):0===t&&0===r&&0!==n?(n<0&&(o=-o),i[0]=a,i[4]=-o,i[8]=0,i[12]=0,i[1]=o,i[5]=a,i[9]=0,i[13]=0,i[2]=0,i[6]=0,i[10]=1,i[14]=0,i[3]=0,i[7]=0,i[11]=0,i[15]=1):(s=Math.sqrt(t*t+r*r+n*n),1!==s&&(c=1/s,t*=c,r*=c,n*=c),u=1-a,l=t*r,h=r*n,d=n*t,p=t*o,f=r*o,m=n*o,i[0]=t*t*u+a,i[1]=l*u+m,i[2]=d*u-f,i[3]=0,i[4]=l*u-m,i[5]=r*r*u+a,i[6]=h*u+p,i[7]=0,i[8]=d*u+f,i[9]=h*u-p,i[10]=n*n*u+a,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1),this},Matrix4.prototype.rotate=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=e[0];if(2===e.length){var n=e[1];this.applyMatrix(Matrix4.create().setRotate(r,n.values[0],n.values[1],n.values[2]))}else if(4===e.length){var i=e[1],o=e[2],a=e[3];this.applyMatrix(Matrix4.create().setRotate(r,i,o,a))}return this},Matrix4.prototype.setScale=function(e,t,r){var n=this.values;return n[0]=e,n[4]=0,n[8]=0,n[12]=0,n[1]=0,n[5]=t,n[9]=0,n[13]=0,n[2]=0,n[6]=0,n[10]=r,n[14]=0,n[3]=0,n[7]=0,n[11]=0,n[15]=1,this},Matrix4.prototype.scale=function(e,t,r){return this.applyMatrix(Matrix4.create().setScale(e,t,r)),this},Matrix4.prototype.setLookAt=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n,i,o,a,s,c;3===t.length?(a=t[0],s=t[1],c=t[2]):9===t.length&&(a=e.Vector3.create(t[0],t[1],t[2]),s=e.Vector3.create(t[3],t[4],t[5]),c=e.Vector3.create(t[6],t[7],t[8])),n=e.Vector3.create(),o=a.clone().sub(s).normalize(),i=c.clone().normalize(),n.cross(i,o).normalize(),i.cross(o,n);var u=this.values;return u[0]=n.x,u[1]=n.y,u[2]=n.z,u[3]=0,u[4]=i.x,u[5]=i.y,u[6]=i.z,u[7]=0,u[8]=o.x,u[9]=o.y,u[10]=o.z,u[11]=0,u[12]=a.x,u[13]=a.y,u[14]=a.z,u[15]=1,this},Matrix4.prototype.lookAt=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=Matrix4.create();return this.applyMatrix(r.setLookAt.apply(r,e)),this},Matrix4.prototype.setOrtho=function(e,t,r,n,i,o){var a,s,c,u=this.values;return a=1/(t-e),s=1/(n-r),c=1/(o-i),u[0]=2*a,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=2*s,u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=-2*c,u[11]=0,u[12]=-(t+e)*a,u[13]=-(n+r)*s,u[14]=-(o+i)*c,u[15]=1,this},Matrix4.prototype.ortho=function(e,t,r,n,i,o){return this.applyMatrix(Matrix4.create().setOrtho(e,t,r,n,i,o)),this},Matrix4.prototype.setPerspective=function(t,r,n,i){var o=null,a=null,s=null,c=null,t=Math.PI*t/180/2;return s=Math.sin(t),e.Log.error(0===s,e.Log.info.FUNC_MUST_NOT_BE("frustum","null")),a=1/(i-n),c=Math.cos(t)/s,o=this.values,o[0]=c/r,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=c,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=-(i+n)*a,o[11]=-1,o[12]=0,o[13]=0,o[14]=-2*n*i*a,o[15]=0,this},Matrix4.prototype.perspective=function(e,t,r,n){return this.applyMatrix(Matrix4.create().setPerspective(e,t,r,n)),this},Matrix4.prototype.applyMatrix=function(e,t){void 0===t&&(t=!1);var r=this,n=e.clone();return t?n.multiply(r):(this.values=n.multiply(r).values,this)},Matrix4.prototype.multiply=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=null,n=null,i=null;i=this.values,1===e.length?(r=this.values,n=e[0].values):2===e.length&&(r=e[0].values,n=e[1].values);var o=r[0],a=r[1],s=r[2],c=r[3],u=r[4],l=r[5],h=r[6],d=r[7],p=r[8],f=r[9],m=r[10],g=r[11],_=r[12],y=r[13],v=r[14],b=r[15],C=n[0],E=n[1],S=n[2],T=n[3],M=n[4],D=n[5],L=n[6],w=n[7],x=n[8],O=n[9],A=n[10],R=n[11],I=n[12],N=n[13],B=n[14],P=n[15];return i[0]=C*o+E*u+S*p+T*_,i[1]=C*a+E*l+S*f+T*y,i[2]=C*s+E*h+S*m+T*v,i[3]=C*c+E*d+S*g+T*b,i[4]=M*o+D*u+L*p+w*_,i[5]=M*a+D*l+L*f+w*y,i[6]=M*s+D*h+L*m+w*v,i[7]=M*c+D*d+L*g+w*b,i[8]=x*o+O*u+A*p+R*_,i[9]=x*a+O*l+A*f+R*y,i[10]=x*s+O*h+A*m+R*v,i[11]=x*c+O*d+A*g+R*b,i[12]=I*o+N*u+B*p+P*_,i[13]=I*a+N*l+B*f+P*y,i[14]=I*s+N*h+B*m+P*v,i[15]=I*c+N*d+B*g+P*b,this},Matrix4.prototype.multiplyVector4=function(t){var r=this.values,n=t.values,i=[];return i[0]=n[0]*r[0]+n[1]*r[4]+n[2]*r[8]+n[3]*r[12],i[1]=n[0]*r[1]+n[1]*r[5]+n[2]*r[9]+n[3]*r[13],i[2]=n[0]*r[2]+n[1]*r[6]+n[2]*r[10]+n[3]*r[14],i[3]=n[0]*r[3]+n[1]*r[7]+n[2]*r[11]+n[3]*r[15],e.Vector4.create(i[0],i[1],i[2],i[3])},Matrix4.prototype.multiplyVector3=function(t){var r=this.values,n=t.values,i=[];return i[0]=n[0]*r[0]+n[1]*r[4]+n[2]*r[8],i[1]=n[0]*r[1]+n[1]*r[5]+n[2]*r[9],i[2]=n[0]*r[2]+n[1]*r[6]+n[2]*r[10],e.Vector3.create(i[0],i[1],i[2])},Matrix4.prototype.multiplyPoint=function(t){var r=this.values,n=t.values,i=[];return i[0]=n[0]*r[0]+n[1]*r[4]+n[2]*r[8]+r[12],i[1]=n[0]*r[1]+n[1]*r[5]+n[2]*r[9]+r[13],i[2]=n[0]*r[2]+n[1]*r[6]+n[2]*r[10]+r[14],e.Vector3.create(i[0],i[1],i[2])},Matrix4.prototype.clone=function(){var e=Matrix4.create(),t=0,r=this.values.length;for(t=0;t<r;t++)e.values[t]=this.values[t];return e},Matrix4.prototype.cloneToArray=function(e,t){void 0===t&&(t=0);for(var r=this.values,n=0;n<16;n++)e[t+n]=r[n];return this},Matrix4.prototype.getX=function(){return e.Vector3.create(this.values[0],this.values[1],this.values[2])},Matrix4.prototype.getY=function(){return e.Vector3.create(this.values[4],this.values[5],this.values[6])},Matrix4.prototype.getZ=function(){return e.Vector3.create(this.values[8],this.values[9],this.values[10])},Matrix4.prototype.getTranslation=function(){return e.Vector3.create(this.values[12],this.values[13],this.values[14])},Matrix4.prototype.getScale=function(){return e.Vector3.create(this.getX().length(),this.getY().length(),this.getZ().length())},Matrix4.prototype.getRotation=function(){return e.Quaternion.create().setFromMatrix(this)},Matrix4.prototype.getEulerAngles=function(){var t,r,n,i,o,a,s,c,u=this.getScale();return i=u.x,o=u.y,a=u.z,s=this.values,r=Math.asin(-s[2]/i),c=.5*Math.PI,r<c?r>-c?(t=Math.atan2(s[6]/o,s[10]/a),n=Math.atan2(s[1]/i,s[0]/i)):(n=0,t=-Math.atan2(s[4]/o,s[5]/o)):(n=0,t=Math.atan2(s[4]/o,s[5]/o)),e.Vector3.create(t,r,n).scale(e.RAD_TO_DEG)},Matrix4.prototype.setTRS=function(e,t,r){var n,i,o,a,s,c,u,l,h,d,p,f,m,g,_,y,v,b,C,E,S,T,M;return n=e.x,i=e.y,o=e.z,a=t.x,s=t.y,c=t.z,u=t.w,l=r.x,h=r.y,d=r.z,p=a+a,f=s+s,m=c+c,g=a*p,_=a*f,y=a*m,v=s*f,b=s*m,C=c*m,E=u*p,S=u*f,T=u*m,M=this.values,M[0]=(1-(v+C))*l,M[1]=(_+T)*l,M[2]=(y-S)*l,M[3]=0,M[4]=(_-T)*h,M[5]=(1-(g+C))*h,M[6]=(b+E)*h,M[7]=0,M[8]=(y+S)*d,M[9]=(b-E)*d,M[10]=(1-(g+v))*d,M[11]=0,M[12]=n,M[13]=i,M[14]=o,M[15]=1,this},__decorate([e.require(function(t,r,n,i){e.it("axis's component shouldn't all be zero",function(){e.expect(0===r&&0===n&&0===i)["false"]})})],Matrix4.prototype,"setRotate",null),__decorate([e.require(function(t,r,n,i,o,a){e.assert(t!==r&&n!==i&&o!==a,e.Log.info.FUNC_MUST_NOT_BE("frustum","null"))})],Matrix4.prototype,"setOrtho",null),__decorate([e.require(function(t,r,n,i){e.assert(n!==i&&0!==r,e.Log.info.FUNC_MUST_NOT_BE("frustum","null")),e.assert(n>0,e.Log.info.FUNC_MUST("near","> 0")),e.assert(i>0,e.Log.info.FUNC_MUST("far","> 0"))})],Matrix4.prototype,"setPerspective",null),Matrix4}();e.Matrix4=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Matrix3(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];this.values=null,1===e.length?this.values=e[0]:this.values=new Float32Array([1,0,0,0,1,0,0,0,1])}return Matrix3.create=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=null;return r=0===e.length?new this:new this(e[0])},Object.defineProperty(Matrix3.prototype,"a",{get:function(){return this.values[0]},set:function(e){this.values[0]=e},enumerable:!0,configurable:!0}),Object.defineProperty(Matrix3.prototype,"c",{get:function(){return this.values[1]},set:function(e){this.values[1]=e},enumerable:!0,configurable:!0}),Object.defineProperty(Matrix3.prototype,"b",{get:function(){return this.values[3]},set:function(e){this.values[3]=e},enumerable:!0,configurable:!0}),Object.defineProperty(Matrix3.prototype,"d",{get:function(){return this.values[4]},set:function(e){this.values[4]=e},enumerable:!0,configurable:!0}),Object.defineProperty(Matrix3.prototype,"tx",{get:function(){return this.values[6]},set:function(e){this.values[6]=e},enumerable:!0,configurable:!0}),Object.defineProperty(Matrix3.prototype,"ty",{get:function(){return this.values[7]},set:function(e){this.values[7]=e},enumerable:!0,configurable:!0}),Matrix3.prototype.setIdentity=function(){var e=this.values;return e[0]=1,e[3]=0,e[6]=0,e[1]=0,e[4]=1,e[7]=0,e[2]=0,e[5]=0,e[8]=1,this},Matrix3.prototype.invert=function(){var e=this.values[0],t=this.values[1],r=this.values[3],n=this.values[4],i=this.values[6],o=this.values[7],a=e*n-t*r;return this.values[0]=n/a,this.values[1]=-t/a,this.values[3]=-r/a,this.values[4]=e/a,this.values[6]=(r*o-n*i)/a,this.values[7]=-(e*o-t*i)/a,this},Matrix3.prototype.multiplyScalar=function(e){var t=this.values;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this},Matrix3.prototype.multiplyVector2=function(t){var r=t.x,n=t.y,i=e.Vector2.create(),o=this.values;return i.x=o[0]*r+o[3]*n,i.y=o[1]*r+o[4]*n,i},Matrix3.prototype.multiplyPoint=function(t){var r=t.x,n=t.y,i=e.Vector2.create(),o=this.values;return i.x=o[0]*r+o[3]*n+this.tx,i.y=o[1]*r+o[4]*n+this.ty,i},Matrix3.prototype.multiply=function(e){var t=this.a*e.a+this.c*e.b,r=this.b*e.a+this.d*e.b,n=this.a*e.c+this.c*e.d,i=this.b*e.c+this.d*e.d,o=this.a*e.tx+this.c*e.ty+this.tx,a=this.b*e.tx+this.d*e.ty+this.ty;
return this.a=t,this.b=r,this.c=n,this.d=i,this.tx=o,this.ty=a,this},Matrix3.prototype.transpose=function(){var e,t=this.values;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this},Matrix3.prototype.clone=function(){return Matrix3.create().set(this)},Matrix3.prototype.cloneToArray=function(e,t){void 0===t&&(t=0);for(var r=this.values,n=0;n<9;n++)e[t+n]=r[n];return this},Matrix3.prototype.set=function(e){var t=this.values,r=e.values;return t[0]=r[0],t[3]=r[3],t[6]=r[6],t[1]=r[1],t[4]=r[4],t[7]=r[7],t[2]=r[2],t[5]=r[5],t[8]=r[8],this},Matrix3.prototype.setTS=function(e,t){this.setPosition(e.x,e.y),this.setScale(t.x,t.y)},Matrix3.prototype.rotate=function(t){var r=t*e.DEG_TO_RAD,n=Math.cos(r),i=Math.sin(r),o=this.a*n+this.c*i,a=this.b*n+this.d*i,s=this.a*-i+this.c*n,c=this.b*-i+this.d*n;return this.a=o,this.b=a,this.c=s,this.d=c,this},Matrix3.prototype.setRotation=function(t){var r=t*e.DEG_TO_RAD,n=Math.cos(r),i=Math.sin(r),o=this.values;return o[0]=n,o[1]=-i,o[3]=i,o[4]=n,this},Matrix3.prototype.translate=function(e,t){this.tx+=this.a*e+this.c*t,this.ty+=this.b*e+this.d*t},Matrix3.prototype.setPosition=function(e,t){this.tx=e,this.ty=t},Matrix3.prototype.scale=function(e,t){return this.a*=e,this.b*=e,this.c*=t,this.d*=t,this},Matrix3.prototype.setScale=function(e,t){var r=this.values;return r[0]=e,r[4]=t,this},Matrix3.prototype.getTranslation=function(){return e.Vector2.create(this.tx,this.ty)},Matrix3.prototype.getScale=function(){return e.Vector2.create(Math.sqrt(this.a*this.a+this.b*this.b),Math.sqrt(this.c*this.c+this.d*this.d))},Matrix3.prototype.getRotation=function(){return this._getSkewX()},Matrix3.prototype.getSkew=function(){return e.Vector2.create(this._getSkewX(),this._getSkewY())},Matrix3.prototype._getDeltaTransformPoint=function(e,t){return{x:t.x*e.a+t.y*e.c+0,y:t.x*e.b+t.y*e.d+0}},Matrix3.prototype._getSkewX=function(){var e=this._getDeltaTransformPoint(this,{x:0,y:1});return 180/Math.PI*Math.atan2(e.y,e.x)-90},Matrix3.prototype._getSkewY=function(){var e=this._getDeltaTransformPoint(this,{x:1,y:0});return 180/Math.PI*Math.atan2(e.y,e.x)},Matrix3}();e.Matrix3=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Quaternion(e,t,r,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),void 0===n&&(n=1),this.x=null,this.y=null,this.z=null,this.w=null,this.x=e,this.y=t,this.z=r,this.w=n}return Quaternion.create=function(e,t,r,n){var i=new this(e,t,r,n);return i},Quaternion.prototype.setFromEulerAngles=function(t){var r,n,i,o,a,s,c,u=t.x,l=t.y,h=t.z;return c=.5*e.DEG_TO_RAD,u*=c,l*=c,h*=c,r=Math.sin(u),n=Math.cos(u),i=Math.sin(l),o=Math.cos(l),a=Math.sin(h),s=Math.cos(h),this.x=r*o*s-n*i*a,this.y=n*i*s+r*o*a,this.z=n*o*a-r*i*s,this.w=n*o*s+r*i*a,this},Quaternion.prototype.multiply=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r,n,i,o,a,s,c,u,l,h,d=this;return 1===e.length?(l=this,h=e[0]):2===e.length&&(l=e[0],h=e[1]),r=l.x,n=l.y,i=l.z,o=l.w,a=h.x,s=h.y,c=h.z,u=h.w,d.x=o*a+r*u+n*c-i*s,d.y=o*s+n*u+i*a-r*c,d.z=o*c+i*u+r*s-n*a,d.w=o*u-r*a-n*s-i*c,d},Quaternion.prototype.setFromMatrix=function(e){var t,r,n,i,o,a,s,c,u,l,h,d,p,f,m,g;return g=e.values,t=g[0],r=g[1],n=g[2],i=g[4],o=g[5],a=g[6],s=g[8],c=g[9],u=g[10],p=1/Math.sqrt(t*t+r*r+n*n),f=1/Math.sqrt(i*i+o*o+a*a),m=1/Math.sqrt(s*s+c*c+u*u),t*=p,r*=p,n*=p,i*=f,o*=f,a*=f,s*=m,c*=m,u*=m,l=t+o+u,l>=0?(h=Math.sqrt(l+1),this.w=.5*h,h=.5/h,this.x=(a-c)*h,this.y=(s-n)*h,this.z=(r-i)*h):t>o?t>u?(d=t-(o+u)+1,d=Math.sqrt(d),this.x=.5*d,d=.5/d,this.w=(a-c)*d,this.y=(r+i)*d,this.z=(n+s)*d):(d=u-(t+o)+1,d=Math.sqrt(d),this.z=.5*d,d=.5/d,this.w=(r-i)*d,this.x=(s+n)*d,this.y=(c+a)*d):o>u?(d=o-(u+t)+1,d=Math.sqrt(d),this.y=.5*d,d=.5/d,this.w=(s-n)*d,this.z=(a+c)*d,this.x=(i+r)*d):(d=u-(t+o)+1,d=Math.sqrt(d),this.z=.5*d,d=.5/d,this.w=(r-i)*d,this.x=(s+n)*d,this.y=(c+a)*d),this},Quaternion.prototype.setFromAxisAngle=function(t,r){var n,i;return r=r.normalize(),t*=.5*e.DEG_TO_RAD,n=Math.sin(t),i=Math.cos(t),this.x=n*r.x,this.y=n*r.y,this.z=n*r.z,this.w=i,this},Quaternion.prototype.invert=function(){return this.conjugate().normalize()},Quaternion.prototype.conjugate=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},Quaternion.prototype.clone=function(){return Quaternion.create(this.x,this.y,this.z,this.w)},Quaternion.prototype.normalize=function(){var e=this.length();return 0===e?(this.x=this.y=this.z=0,this.w=1):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},Quaternion.prototype.length=function(){var e,t,r,n;return e=this.x,t=this.y,r=this.z,n=this.w,Math.sqrt(e*e+t*t+r*r+n*n)},Quaternion.prototype.multiplyVector3=function(t){var r=this,n=t.x,i=t.y,o=t.z,a=r.x,s=r.y,c=r.z,u=r.w,l=u*n+s*o-c*i,h=u*i+c*n-a*o,d=u*o+a*i-s*n,p=-a*n-s*i-c*o;return e.Vector3.create(l*u+p*-a+h*-c-d*-s,h*u+p*-s+d*-a-l*-c,d*u+p*-c+l*-s-h*-a)},Quaternion.prototype.set=function(e,t,r,n){this.x=e,this.y=t,this.z=r,this.w=n},Quaternion.prototype.sub=function(e){var t=e.clone().invert().multiply(this);return this.set(t.x,t.y,t.z,t.w),this},Quaternion.prototype.getEulerAngles=function(){var t,r,n,i,o,a,s,c;return i=this.x,o=this.y,a=this.z,s=this.w,c=2*(s*o-i*a),c<=-.99999?(t=2*Math.atan2(i,s),r=-Math.PI/2,n=0):c>=.99999?(t=2*Math.atan2(i,s),r=Math.PI/2,n=0):(t=Math.atan2(2*(s*i+o*a),1-2*(i*i+o*o)),r=Math.asin(c),n=Math.atan2(2*(s*a+i*o),1-2*(o*o+a*a))),e.Vector3.create(t,r,n).scale(e.RAD_TO_DEG)},Quaternion.prototype.slerp=function(e,t,r){if(0===r)return this.set(e.x,e.y,e.z,e.w),this;if(1===r)return this.set(t.x,t.y,t.z,t.w),this;var n,i,o=r,a=e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w,s=!1;if(a<0&&(s=!0,a=-a),a>.999999)i=1-o,n=s?-o:o;else{var c=Math.acos(a),u=1/Math.sin(c);i=Math.sin((1-o)*c)*u,n=s?-Math.sin(o*c)*u:Math.sin(o*c)*u}return this.set(i*e.x+n*t.x,i*e.y+n*t.y,i*e.z+n*t.z,i*e.w+n*t.w),this},Quaternion}();e.Quaternion=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Plane(t,r,n,i){this.normal=e.Vector3.create(0,1,0),this.d=0,this.normal=e.Vector3.create(t,r,n),this.d=i}return Plane.create=function(e,t,r,n){var i=new this(e,t,r,n);return i},Plane.prototype.getReflectionMatrix=function(){this.normalize();var t=this.normal.x,r=this.normal.y,n=this.normal.z,i=-2*t,o=-2*r,a=-2*n,s=e.Matrix4.create();return s.values[0]=i*t+1,s.values[1]=o*t,s.values[2]=a*t,s.values[3]=0,s.values[4]=i*r,s.values[5]=o*r+1,s.values[6]=a*r,s.values[7]=0,s.values[8]=i*n,s.values[9]=o*n,s.values[10]=a*n+1,s.values[11]=0,s.values[12]=i*this.d,s.values[13]=o*this.d,s.values[14]=a*this.d,s.values[15]=1,s},Plane.prototype.normalize=function(){var e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z),t=0;return 0!==e&&(t=1/e),this.normal.x*=t,this.normal.y*=t,this.normal.z*=t,this.d*=t,this},Plane.prototype.clone=function(){return Plane.create(this.normal.x,this.normal.y,this.normal.z,this.d)},Plane.prototype.dotCoordinate=function(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d},Plane}();e.Plane=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Ray(e,t){this._origin=null,this._direction=null,this._origin=e,this._direction=t}return Ray.create=function(e,t){var r=new this(e,t);return r},Ray.prototype.isIntersectWithAABB=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=null,o=e.Vector3.create(),a=null,s=null,c=e.Vector3.create(),u=e.Vector3.create(),l=this._origin,h=this._direction;if(1===t.length){var d=t[0];n=d.center,i=d.halfExtents}else if(2===t.length){var p=t[0],f=t[1];n=e.AABBShape.getCenter(p,f),i=e.AABBShape.getHalfExtents(p,f)}return o.sub2(l,n),a=e.Vector3.create(Math.abs(o.x),Math.abs(o.y),Math.abs(o.z)),u.mul2(o,h),!(a.x>i.x&&u.x>=0)&&(!(a.y>i.y&&u.y>=0)&&(!(a.z>i.z&&u.z>=0)&&(s=e.Vector3.create(Math.abs(h.x),Math.abs(h.y),Math.abs(h.z)),c.cross(h,o),c.set(Math.abs(c.x),Math.abs(c.y),Math.abs(c.z)),!(c.x>i.y*s.z+i.z*s.y)&&(!(c.y>i.x*s.z+i.z*s.x)&&!(c.z>i.x*s.y+i.y*s.x)))))},Ray.prototype.isIntersectWithSphere=function(t){var r=t.center,n=t.radius,i=e.Vector3.create(),o=0,a=0,s=0,c=0,u=this._origin,l=this._direction;return i.sub2(u,r),i.dot(i)<n*n||(o=l.dot(l),a=2*l.dot(i),s=r.dot(r),s+=u.dot(u),s-=2*r.dot(u),s-=n*n,c=a*a-4*o*s,!(c<0))},Ray}();e.Ray=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Entity(){this.uid=null,this.data=null,this._tagList=wdCb.Collection.create(),this.uid=Entity._count,Entity._count+=1}return Entity.prototype.addTag=function(e){this._tagList.addChild(e)},Entity.prototype.removeTag=function(e){this._tagList.removeChild(e)},Entity.prototype.getTagList=function(){return this._tagList},Entity.prototype.hasTag=function(e){return this._tagList.hasChild(e)},Entity.prototype.containTag=function(e){return this._tagList.hasChildWithFunc(function(t){return t.indexOf(e)>-1})},Entity._count=1,Entity}();e.Entity=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function Component(){t.apply(this,arguments),this.entityObject=null}return __extends(Component,t),Component.prototype.init=function(){},Component.prototype.dispose=function(){},Component.prototype.clone=function(){return e.CloneUtils.clone(this)},Object.defineProperty(Component.prototype,"transform",{get:function(){return this.entityObject?this.entityObject.transform:null},enumerable:!0,configurable:!0}),Component.prototype.addToObject=function(e,t){void 0===t&&(t=!1),t||(this.entityObject&&this.entityObject.removeComponent(this),this.entityObject=e)},Component.prototype.removeFromObject=function(e){this.removeFromEngine()},Component.prototype.removeFromEngine=function(){},__decorate([e.virtual],Component.prototype,"init",null),__decorate([e.virtual],Component.prototype,"dispose",null),__decorate([e.virtual],Component.prototype,"clone",null),__decorate([e.virtual],Component.prototype,"addToObject",null),__decorate([e.virtual],Component.prototype,"removeFromObject",null),__decorate([e.virtual],Component.prototype,"removeFromEngine",null),Component}(e.Entity);e.Component=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Scheduler(){this._scheduleCount=0,this._schedules=wdCb.Hash.create()}return Scheduler.create=function(){var e=new this;return e},Scheduler.prototype.update=function(e){var t=this;this._schedules.forEach(function(r,n){r.isStop||r.isPause||(r.update(e),r.isFinish&&t.remove(n))})},Scheduler.prototype.scheduleLoop=function(e,t){return void 0===t&&(t=[]),this._schedule(o,Array.prototype.slice.call(arguments,0))},Scheduler.prototype.scheduleFrame=function(e,t,r){return void 0===t&&(t=1),this._schedule(a,Array.prototype.slice.call(arguments,0))},Scheduler.prototype.scheduleInterval=function(e,t,r){return void 0===t&&(t=0),this._schedule(i,Array.prototype.slice.call(arguments,0))},Scheduler.prototype.scheduleTime=function(e,t,r){return void 0===t&&(t=0),this._schedule(n,Array.prototype.slice.call(arguments,0))},Scheduler.prototype.pause=function(e){if(0===arguments.length){var t=this;this._schedules.forEach(function(e,r){t.pause(r)})}else if(1===arguments.length){var r=this._schedules.getChild(arguments[0]);r.pause()}},Scheduler.prototype.resume=function(e){if(0===arguments.length){var t=this;this._schedules.forEach(function(e,r){t.resume(r)})}else if(1===arguments.length){var r=this._schedules.getChild(arguments[0]);r.resume()}},Scheduler.prototype.start=function(e){if(0===arguments.length){var t=this;this._schedules.forEach(function(e,r){t.start(r)})}else if(1===arguments.length){var r=this._schedules.getChild(arguments[0]);r.start()}},Scheduler.prototype.stop=function(e){if(0===arguments.length){var t=this;this._schedules.forEach(function(e,r){t.stop(r)})}else if(1===arguments.length){var r=this._schedules.getChild(arguments[0]);r.stop()}},Scheduler.prototype.has=function(e){return!!this._schedules.hasChild(e)},Scheduler.prototype.remove=function(e){this._schedules.removeChild(e)},Scheduler.prototype.removeAll=function(){this._schedules.removeAllChildren()},Scheduler.prototype._schedule=function(e,t){var r=this._buildId();return this._schedules.setValue(r,e.create.apply(e,t)),r},Scheduler.prototype._buildId=function(){return"Schedule_"+this._scheduleCount++},Scheduler}();e.Scheduler=t;var r=function(){function ScheduleItem(t,r){this.isPause=!1,this.isStop=!1,this.pauseTime=null,this.pauseElapsed=null,this.startTime=null,this.isFinish=!1,this.task=null,this.args=null,this.timeController=e.CommonTimeController.create(),this.task=t,this.args=r}return ScheduleItem.prototype.pause=function(){this.isPause=!0,this.timeController.pause()},ScheduleItem.prototype.resume=function(){this.isPause=!1,this.timeController.resume()},ScheduleItem.prototype.start=function(){this.isStop=!1,this.timeController.start()},ScheduleItem.prototype.stop=function(){this.isStop=!0,this.timeController.stop()},ScheduleItem.prototype.finish=function(){this.isFinish=!0},ScheduleItem}(),n=function(e){function TimeScheduleItem(t,r,n){void 0===r&&(r=0),void 0===n&&(n=[]),e.call(this,t,n),this._time=null,this._time=r}return __extends(TimeScheduleItem,e),TimeScheduleItem.create=function(e,t,r){void 0===t&&(t=0),void 0===r&&(r=[]);var n=new this(e,t,r);return n},TimeScheduleItem.prototype.update=function(e){var e=this.timeController.computeElapseTime(e);e>=this._time&&(this.task.apply(this,this.args),this.finish())},TimeScheduleItem}(r),i=function(e){function IntervalScheduleItem(t,r,n){void 0===r&&(r=0),void 0===n&&(n=[]),e.call(this,t,n),this._intervalTime=null,this._elapsed=0,this._intervalTime=r}return __extends(IntervalScheduleItem,e),IntervalScheduleItem.create=function(e,t,r){void 0===t&&(t=0),void 0===r&&(r=[]);var n=new this(e,t,r);return n},IntervalScheduleItem.prototype.update=function(e){var e=this.timeController.computeElapseTime(e);e-this._elapsed>=this._intervalTime&&(this.task.apply(this,this.args),this._elapsed=e)},IntervalScheduleItem.prototype.start=function(){e.prototype.start.call(this),this._elapsed=0},IntervalScheduleItem}(r),o=function(e){function LoopScheduleItem(){e.apply(this,arguments)}return __extends(LoopScheduleItem,e),LoopScheduleItem.create=function(e,t){void 0===t&&(t=[]);var r=new this(e,t);return r},LoopScheduleItem.prototype.update=function(e){this.task.apply(this,this.args)},LoopScheduleItem}(r),a=function(e){function FrameScheduleItem(t,r,n){void 0===r&&(r=1),void 0===n&&(n=[]),e.call(this,t,n),this._frame=null,this._frame=r}return __extends(FrameScheduleItem,e),FrameScheduleItem.create=function(e,t,r){void 0===t&&(t=1),void 0===r&&(r=[]);var n=new this(e,t,r);return n},FrameScheduleItem.prototype.update=function(e){this._frame--,this._frame<=0&&(this.task.apply(this,this.args),this.finish())},FrameScheduleItem}(r)}(wd||(wd={}));var wd;!function(e){var t;!function(e){e[e.NORMAL=0]="NORMAL",e[e.STOP=1]="STOP",e[e.PAUSE=2]="PAUSE"}(t||(t={}));var r=function(){function Director(){this.scene=null,this.scheduler=null,this.renderer=null,this.domEventManager=e.DomEventManager.create(),this._gameLoop=null,this._eventSubscription=null,this._gameState=t.NORMAL,this._timeController=e.DirectorTimeController.create()}return Director.getInstance=function(){},Object.defineProperty(Director.prototype,"gameTime",{get:function(){return this._timeController.gameTime},enumerable:!0,configurable:!0}),Object.defineProperty(Director.prototype,"fps",{get:function(){return this._timeController.fps},enumerable:!0,configurable:!0}),Object.defineProperty(Director.prototype,"isNormal",{get:function(){return this._gameState===t.NORMAL},enumerable:!0,configurable:!0}),Object.defineProperty(Director.prototype,"isStop",{get:function(){return this._gameState===t.STOP},enumerable:!0,configurable:!0}),Object.defineProperty(Director.prototype,"isPause",{get:function(){return this._gameState===t.PAUSE},enumerable:!0,configurable:!0}),Object.defineProperty(Director.prototype,"isTimeChange",{get:function(){return this._timeController.isTimeChange},enumerable:!0,configurable:!0}),Object.defineProperty(Director.prototype,"elapsed",{get:function(){return this._timeController.elapsed},enumerable:!0,configurable:!0}),Object.defineProperty(Director.prototype,"view",{get:function(){return e.DeviceManager.getInstance().view},enumerable:!0,configurable:!0}),Director.prototype.initWhenCreate=function(){this.scene=e.SceneDispatcher.create(),this.scheduler=e.Scheduler.create(),this.renderer=e.WebGLRenderer.create()},Director.prototype.start=function(){this._gameState=t.NORMAL,this._startLoop()},Director.prototype.stop=function(){this._gameLoop&&this._gameLoop.dispose(),this._gameState=t.STOP,this._timeController.stop(),this.scheduler.stop(),this._eventSubscription&&this._eventSubscription.dispose()},Director.prototype.pause=function(){this._gameState!==t.PAUSE&&(this._gameState=t.PAUSE,this._timeController.pause(),this.scheduler.pause())},Director.prototype.resume=function(){this._gameState=t.NORMAL,this._timeController.resume(),this.scheduler.resume()},Director.prototype.getDeltaTime=function(){return this._timeController.deltaTime},Director.prototype.initUIObjectScene=function(){var e=this.scene.uiObjectScene;this._initDomEvent(),null!==e&&(e.onEnter(),e.init())},Director.prototype.runUIObjectScene=function(t){var r=this.scene.uiObjectScene;null!==r&&(e.EventManager.trigger(e.CustomEvent.create(e.EEngineEvent.STARTLOOP)),e.ScriptEngine.getInstance().execScript("onStartLoop"),r.update(t),r.render(),e.ScriptEngine.getInstance().execScript("onEndLoop"),e.EventManager.trigger(e.CustomEvent.create(e.EEngineEvent.ENDLOOP)))},Director.prototype._startLoop=function(){var e=this;this._gameLoop=this._buildInitStream().ignoreElements().concat(this._buildLoopStream()).subscribe(function(t){e._loopBody(t)})},Director.prototype._buildInitStream=function(){var e=this;return wdFrp.callFunc(function(){e._init()},this)},Director.prototype._init=function(){var t=e.ClassUtils.getClass("DebugStatistics");t&&t.init(),this._initGameObjectScene(),this.initUIObjectScene()},Director.prototype._initGameObjectScene=function(){var e=this.scene.gameObjectScene;this._initDomEvent(),e.onEnter(),e.init(),this.renderer.init(),this._timeController.start(),this.scheduler.start()},Director.prototype._buildLoopStream=function(){return wdFrp.intervalRequest()},Director.prototype._loopBody=function(e){var r=null;return this._gameState!==t.PAUSE&&this._gameState!==t.STOP&&(r=this._timeController.computeElapseTime(e),this._run(r),!0)},Director.prototype._run=function(t){this._timeController.tick(t),e.EventManager.trigger(e.CustomEvent.create(e.EEngineEvent.STARTLOOP)),e.ScriptEngine.getInstance().execScript("onStartLoop"),this._update(t),this._render(),e.ScriptEngine.getInstance().execScript("onEndLoop"),e.EventManager.trigger(e.CustomEvent.create(e.EEngineEvent.ENDLOOP))},Director.prototype._update=function(t){this.scheduler.update(t),e.ScriptEngine.getInstance().execScriptWithData("update",t),e.ClassUtils.execSingletonMethod("ActionEngine","update",t),this.scene.gameObjectScene.update(t),null!==this.scene.uiObjectScene&&this.scene.uiObjectScene.update(t)},Director.prototype._render=function(){this.scene.gameObjectScene.render(this.renderer),this.renderer.clear(),this.renderer.hasCommand()&&(this.renderer.webglState=e.BasicState.create(),this.renderer.render()),null!==this.scene.uiObjectScene&&this.scene.uiObjectScene.render()},Director.prototype._initDomEvent=function(){this._eventSubscription=this.domEventManager.initDomEvent()},__decorate([e.execOnlyOnce("_isInitUIScene")],Director.prototype,"initUIObjectScene",null),__decorate([e.execOnlyOnce("_isInitDomEvent")],Director.prototype,"_initDomEvent",null),Director=__decorate([e.singleton(!0)],Director)}();e.Director=r}(wd||(wd={}));var wd;!function(e){var t=function(){function Main(){}return Object.defineProperty(Main,"isTest",{get:function(){return this._isTest},set:function(e){this._isTest=e,wdFrp.Main.isTest=e},enumerable:!0,configurable:!0}),Main.setConfig=function(t){var r=t.canvasId,n=void 0===r?null:r,i=t.isTest,o=void 0===i?e.DebugConfig.isTest:i,a=t.screenSize,s=void 0===a?e.EScreenSize.FULL:a,c=t.useDevicePixelRatio,u=void 0!==c&&c,l=t.contextConfig,h=void 0===l?{options:{alpha:!0,depth:!0,stencil:!1,antialias:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!1}}:l;return this.screenSize=s,this._canvasId=n,this._useDevicePixelRatio=u,this._contextConfig={options:wdCb.ExtendUtils.extend({alpha:!0,depth:!0,stencil:!1,antialias:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!1},h.options)},this._setIsTest(o),this},Main.init=function(){return e.DeviceManager.getInstance().createGL(this._canvasId,this._contextConfig,this._useDevicePixelRatio),e.DeviceManager.getInstance().setScreen(),e.GPUDetector.getInstance().detect(),this},Main._setIsTest=function(t){e.CompileConfig.closeContractTest?this.isTest=!1:this.isTest=t},Main._isTest=!1,Main.screenSize=null,Main._canvasId=null,Main._contextConfig=null,Main._useDevicePixelRatio=null,Main}();e.Main=t}(wd||(wd={}));var wd;!function(e){var t=function(){function DomEventManager(){this.designatedTriggerList=null,this._lastTriggerList=null,this._isDragEventTriggering=!1,this._triggerListOfDragEvent=null,this._pointEventBinder=e.PointEventBinder.create()}return DomEventManager.create=function(){var e=new this;return e},Object.defineProperty(DomEventManager.prototype,"scene",{get:function(){return e.Director.getInstance().scene},enumerable:!0,configurable:!0}),DomEventManager.prototype.initDomEvent=function(){var t=this;return this._pointEventBinder.initPointEvent(),wdFrp.fromArray([e.EventManager.fromEvent(e.EEngineEvent.POINT_TAP),e.EventManager.fromEvent(e.EEngineEvent.POINT_DOWN),e.EventManager.fromEvent(e.EEngineEvent.POINT_UP),e.EventManager.fromEvent(e.EEngineEvent.POINT_SCALE),this._buildPointDragStream()]).mergeAll().map(function(e){return e.userData}).filter(function(t){return!e.Director.getInstance().isPause}).map(function(e){var r=t._getPointEventTriggerList(e);return t._isDragEventTriggering&&(t._triggerListOfDragEvent=r),t._getPointEventTriggerListData(e,r)}).merge(this._buildPointMoveStream()).subscribe(function(e){var r=e[0],n=e[1];r.forEach(function(e){t._trigger(n.clone(),e)})})},DomEventManager.prototype.dispose=function(){this._pointEventBinder.dispose()},DomEventManager.prototype._buildPointDragStream=function(){var t=this;return e.EventManager.fromEvent(e.EEngineEvent.POINT_DOWN).flatMap(function(r){return e.EventManager.fromEvent(e.EEngineEvent.POINT_MOVE).takeUntil(e.EventManager.fromEvent(e.EEngineEvent.POINT_UP)["do"](function(e){t._isDragEventTriggering=!1}))}).map(function(r){return r.name=e.EEngineEvent.POINT_DRAG,r.userData.name=e.EEngineEvent.POINT_DRAG,t._isDragEventFirstTriggered()&&t._resetLastPosition(r.userData),t._isDragEventTriggering=!0,r})},DomEventManager.prototype._resetLastPosition=function(e){e.lastX=null,e.lastY=null},DomEventManager.prototype._isDragEventFirstTriggered=function(){return this._isDragEventTriggering===!1},DomEventManager.prototype._buildPointMoveStream=function(){var t=this;return e.EventManager.fromEvent(e.EEngineEvent.POINT_MOVE).map(function(e){return e.userData}).filter(function(t){return!e.Director.getInstance().isPause}).map(function(e){var r=null;r=t.designatedTriggerList?t.designatedTriggerList:t._isDragEventTriggering?t._triggerListOfDragEvent:t._getPointEventTriggerList(e);var n=t._getPointOverAndPointOutObject(r,t._lastTriggerList),i=n.pointoverObjects,o=n.pointoutObjects;return t._setPointOverTag(i),t._setPointOutTag(o),t._lastTriggerList=r.clone(),r=o.addChildren(r),t._getPointEventTriggerListData(e,r)})},DomEventManager.prototype._getPointOverAndPointOutObject=function(t,r){var n=wdCb.Collection.create(),i=wdCb.Collection.create();return r?(r.forEach(function(r){t.hasChildWithFunc(function(t){return e.JudgeUtils.isEqual(t,r)})||i.addChild(r)}),t.forEach(function(t){r.hasChildWithFunc(function(r){return e.JudgeUtils.isEqual(t,r)})||n.addChild(t)})):n=t,{pointoverObjects:n,pointoutObjects:i}},DomEventManager.prototype._setPointOverTag=function(e){e.forEach(function(e){e.addTag(r.POINT_OVER)})},DomEventManager.prototype._setPointOutTag=function(e){e.forEach(function(e){e.addTag(r.POINT_OUT)})},DomEventManager.prototype._setEventNameByEventTag=function(t,n){return t.hasTag(r.POINT_OVER)?n.name=e.EEngineEvent.POINT_OVER:t.hasTag(r.POINT_OUT)&&(n.name=e.EEngineEvent.POINT_OUT),n},DomEventManager.prototype._removeEventTag=function(e){e.removeTag(r.POINT_OVER),e.removeTag(r.POINT_OUT)},DomEventManager.prototype._trigger=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=t[0],i=t[1],o=!1,a=null,s=null,c=null;3===t.length&&t[2]?(o=!0,a=n):(a=this._setEventNameByEventTag(i,n),this._removeEventTag(i)),c=e.EventTriggerTable.getScriptHandlerName(a.name),s=e.CustomEvent.create(a.name,a),s.getDataFromDomEvent(a),e.EventManager.trigger(i,s,o),a.getDataFromCustomEvent(s),e.ScriptEngine.getInstance().execEntityObjectEventScriptWithData(i,c,a),!a.isStopPropagation&&i.bubbleParent&&this._trigger(a.clone(),i.bubbleParent,!0)},DomEventManager.prototype._getPointEventTriggerList=function(e){var t=null,r=null,n=null;return this.designatedTriggerList?this.designatedTriggerList:(n=wdCb.Collection.create(),t=this._findTopGameObject(e,this.scene.gameObjectScene),r=this._findTopUIObject(e,this.scene.uiObjectScene),t&&n.addChild(t),r&&n.addChild(r),this._isSceneAsTopOne(e,n)&&n.addChild(this.scene),n)},DomEventManager.prototype._isSceneAsTopOne=function(e,t){return this._isTriggerScene(e)&&0===t.getCount()},DomEventManager.prototype._findTopGameObject=function(e,t){var r=this;return this._findTriggerGameObjectList(e,t).sort(function(e,t){return r._getDistanceToCamera(e)-r._getDistanceToCamera(t)}).getChild(0)},DomEventManager.prototype._getDistanceToCamera=function(t){return t.transform.position.clone().sub(e.Director.getInstance().scene.currentCamera.transform.position).length()},DomEventManager.prototype._findTopUIObject=function(e,t){return null===t?null:this._findTriggerUIObjectList(e,t).sort(function(e,t){return t.transform.zIndex-e.transform.zIndex}).getChild(0)},DomEventManager.prototype._findTriggerGameObjectList=function(t,r){var n=wdCb.Collection.create(),i=this,o=function(r){e.ClassUtils.hasComponent(r,"SpacePartition")?r.getSpacePartition().getIntersectListWithRay(t).forEach(function(e){i._addTriggerObjectByQueryDetector(e,t,n)}):(i._addTriggerObjectByQueryDetector(r,t,n),r.forEach(function(e){o(e)}))};return r.forEach(function(e){o(e)}),n},DomEventManager.prototype._findTriggerUIObjectList=function(e,t){var r=wdCb.Collection.create(),n=this,i=function(t){n._addTriggerObjectByQueryDetector(t,e,r),t.forEach(function(e){i(e)})};return t.forEach(function(e){i(e)}),r},DomEventManager.prototype._addTriggerObjectByQueryDetector=function(t,r,n){if(t.hasComponent(e.EventTriggerDetector)){var i=t.getComponent(e.EventTriggerDetector);i.isTrigger(r)&&n.addChild(t)}},DomEventManager.prototype._isTriggerScene=function(t){var r=this.scene.getComponent(e.EventTriggerDetector);return r.isTrigger(t)},DomEventManager.prototype._getPointEventTriggerListData=function(e,t){return[t,e]},DomEventManager}();e.DomEventManager=t;var r;!function(e){e[e.POINT_OVER="POINT_OVER"]="POINT_OVER",e[e.POINT_OUT="POINT_OUT"]="POINT_OUT"}(r||(r={}))}(wd||(wd={}));var wd;!function(e){var t=function(){function PointEventBinder(){this._pointDownSubscription=null,this._pointTapSubscription=null,this._pointUpSubscription=null,this._pointMoveSubscription=null,this._pointScaleSubscription=null}return PointEventBinder.create=function(){var e=new this;return e},PointEventBinder.prototype.initPointEvent=function(){var t=this;if(this._isSupportTouch()){var r=e.EventManager.fromEvent(e.EEventName.TOUCHDOWN),n=e.EventManager.fromEvent(e.EEventName.TOUCHUP),i=e.EventManager.fromEvent(e.EEventName.TOUCHMOVE);this._pointDownSubscription=r.subscribe(function(r){e.EventManager.trigger(e.CustomEvent.create(e.EEngineEvent.POINT_DOWN,t._convertTouchEventToPointEvent(r,e.EEngineEvent.POINT_DOWN)))}),this._pointMoveSubscription=i.subscribe(function(r){e.EventManager.trigger(e.CustomEvent.create(e.EEngineEvent.POINT_MOVE,t._convertTouchEventToPointEvent(r,e.EEngineEvent.POINT_MOVE)))}),this._pointUpSubscription=n.subscribe(function(r){e.EventManager.trigger(e.CustomEvent.create(e.EEngineEvent.POINT_UP,t._convertTouchEventToPointEvent(r,e.EEngineEvent.POINT_UP)))}),this._pointTapSubscription=n.skipUntil(r).subscribe(function(r){e.EventManager.trigger(e.CustomEvent.create(e.EEngineEvent.POINT_TAP,t._convertTouchEventToPointEvent(r,e.EEngineEvent.POINT_TAP)))})}else this._pointDownSubscription=e.EventManager.fromEvent(e.EEventName.MOUSEDOWN).subscribe(function(r){e.EventManager.trigger(e.CustomEvent.create(e.EEngineEvent.POINT_DOWN,t._convertMouseEventToPointEvent(r,e.EEngineEvent.POINT_DOWN)))}),this._pointMoveSubscription=e.EventManager.fromEvent(e.EEventName.MOUSEMOVE).subscribe(function(r){e.EventManager.trigger(e.CustomEvent.create(e.EEngineEvent.POINT_MOVE,t._convertMouseEventToPointEvent(r,e.EEngineEvent.POINT_MOVE)))}),this._pointUpSubscription=e.EventManager.fromEvent(e.EEventName.MOUSEUP).subscribe(function(r){e.EventManager.trigger(e.CustomEvent.create(e.EEngineEvent.POINT_UP,t._convertMouseEventToPointEvent(r,e.EEngineEvent.POINT_UP)))}),this._pointScaleSubscription=e.EventManager.fromEvent(e.EEventName.MOUSEWHEEL).subscribe(function(r){e.EventManager.trigger(e.CustomEvent.create(e.EEngineEvent.POINT_SCALE,t._convertMouseEventToPointEvent(r,e.EEngineEvent.POINT_SCALE)))}),this._pointTapSubscription=e.EventManager.fromEvent(e.EEventName.CLICK).subscribe(function(r){e.EventManager.trigger(e.CustomEvent.create(e.EEngineEvent.POINT_TAP,t._convertMouseEventToPointEvent(r,e.EEngineEvent.POINT_TAP)))})},PointEventBinder.prototype.dispose=function(){this._pointTapSubscription&&this._pointTapSubscription.dispose(),this._pointDownSubscription&&this._pointDownSubscription.dispose(),this._pointUpSubscription&&this._pointUpSubscription.dispose(),this._pointMoveSubscription&&this._pointMoveSubscription.dispose(),this._pointScaleSubscription&&this._pointScaleSubscription.dispose()},PointEventBinder.prototype._isSupportTouch=function(){return"ontouchstart"in e.root},PointEventBinder.prototype._convertTouchEventToPointEvent=function(t,r){var n=e.TouchPointEvent.create(r);return n.getDataFromEventObj(t),n},PointEventBinder.prototype._convertMouseEventToPointEvent=function(t,r){var n=e.MousePointEvent.create(r);return n.getDataFromEventObj(t),n},__decorate([e.require(function(){var t=this;e.it("should support touch or point event",function(){e.expect(t._isSupportTouch()||"onmousedown"in e.root)["true"]},this)})],PointEventBinder.prototype,"initPointEvent",null),PointEventBinder}();e.PointEventBinder=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function EntityObject(){t.apply(this,arguments),this._bubbleParent=null,this.name=null,this.parent=null,this.customEventMap=wdCb.Hash.create(),this.scriptManager=e.ScriptManager.create(this),this.componentManager=e.ComponentManager.create(this),this._hasComponentCache=wdCb.Hash.create(),this._getComponentCache=wdCb.Hash.create(),this._componentChangeSubscription=null,this._entityObjectManager=e.EntityObjectManager.create(this)}return __extends(EntityObject,t),Object.defineProperty(EntityObject.prototype,"bubbleParent",{get:function(){return this._bubbleParent?this._bubbleParent:this.parent},set:function(e){this._bubbleParent=e},enumerable:!0,configurable:!0}),Object.defineProperty(EntityObject.prototype,"componentDirty",{set:function(e){e===!0&&this.clearCache()},enumerable:!0,configurable:!0}),Object.defineProperty(EntityObject.prototype,"transform",{get:function(){return this.componentManager.transform},enumerable:!0,configurable:!0}),EntityObject.prototype.initWhenCreate=function(){this.addComponent(this.createTransform())},EntityObject.prototype.clone=function(t){void 0===t&&(t={});var r=null;return e.CloneUtils.isNotClone(this)?null:(t=wdCb.ExtendUtils.extend({cloneChildren:!0,shareGeometry:!1,cloneGeometry:!0},t),r=e.CloneUtils.clone(this),this.forEachComponent(function(n){if(t.cloneGeometry||!(n instanceof e.Geometry))return t.shareGeometry&&n instanceof e.Geometry?void r.addComponent(n,!0):void r.addComponent(n.clone());
}),t.cloneChildren&&this._cloneChildren(r),r)},EntityObject.prototype.init=function(){var t=this;return this._componentChangeSubscription=e.EventManager.fromEvent(this,e.EEngineEvent.COMPONENT_CHANGE).subscribe(function(){t._onComponentChange()}),this.componentManager.init(),this._entityObjectManager.init(),this.afterInitChildren(),e.ScriptEngine.getInstance().execEntityObjectScriptOnlyOnce(this,"init"),this},EntityObject.prototype.onEnter=function(){e.ScriptEngine.getInstance().execEntityObjectScriptOnlyOnce(this,"onEnter"),e.EventManager.trigger(this,e.CustomEvent.create(e.EEngineEvent.ENTER))},EntityObject.prototype.onExit=function(){e.ScriptEngine.getInstance().execEntityObjectScriptOnlyOnce(this,"onExit"),e.EventManager.trigger(this,e.CustomEvent.create(e.EEngineEvent.EXIT))},EntityObject.prototype.onDispose=function(){e.ScriptEngine.getInstance().execEntityObjectScriptOnlyOnce(this,"onDispose")},EntityObject.prototype.dispose=function(){this.onDispose(),this.parent&&(this.parent.removeChild(this),this.parent=null),e.EventManager.off(this),this._componentChangeSubscription&&this._componentChangeSubscription.dispose(),this.componentManager.dispose(),this._entityObjectManager.dispose(),e.EventManager.off(this)},EntityObject.prototype.hasChild=function(e){return this._entityObjectManager.hasChild(e)},EntityObject.prototype.addChild=function(e){return this._entityObjectManager.addChild(e),this},EntityObject.prototype.addChildren=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return this._entityObjectManager.addChildren(e[0]),this},EntityObject.prototype.forEach=function(e){return this._entityObjectManager.forEach(e),this},EntityObject.prototype.filter=function(e){return this._entityObjectManager.filter(e)},EntityObject.prototype.sort=function(e,t){return void 0===t&&(t=!1),this._entityObjectManager.sort(e,t)},EntityObject.prototype.getChildren=function(){return this._entityObjectManager.getChildren()},EntityObject.prototype.getChild=function(e){return this._entityObjectManager.getChild(e)},EntityObject.prototype.findChildByUid=function(e){return this._entityObjectManager.findChildByUid(e)},EntityObject.prototype.findChildByTag=function(e){return this._entityObjectManager.findChildByTag(e)},EntityObject.prototype.findChildByName=function(e){return this._entityObjectManager.findChildByName(e)},EntityObject.prototype.findChildrenByName=function(e){return this._entityObjectManager.findChildrenByName(e)},EntityObject.prototype.removeChild=function(e){return this._entityObjectManager.removeChild(e),this},EntityObject.prototype.removeAllChildren=function(){this._entityObjectManager.removeAllChildren()},EntityObject.prototype.getComponent=function(e){return this.componentManager.getComponent(e)},EntityObject.prototype.getComponents=function(){return this.componentManager.getComponents()},EntityObject.prototype.findComponentByUid=function(e){return this.componentManager.findComponentByUid(e)},EntityObject.prototype.forEachComponent=function(e){return this.componentManager.forEachComponent(e),this},EntityObject.prototype.hasComponent=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=this._getHasComponentCacheKey(e[0]),n=this._hasComponentCache.getChild(r);return void 0!==n?n:(n=this.componentManager.hasComponent(e[0]),this._hasComponentCache.addChild(r,n),n)},EntityObject.prototype.addComponent=function(e,t){return void 0===t&&(t=!1),this.componentManager.addComponent(e,t),this.componentDirty=!0,this},EntityObject.prototype.removeComponent=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return this.componentManager.removeComponent(e[0]),this.componentDirty=!0,this},EntityObject.prototype.removeAllComponent=function(){return this.componentDirty=!0,this.componentManager.removeAllComponent()},EntityObject.prototype.removeAllComponentFromEngine=function(){return this.componentManager.removeAllComponentFromEngine()},EntityObject.prototype.render=function(e,t){var r=null;r=this.componentManager.getRendererComponent(),r&&r.render(e,this,t),this.getRenderList().forEach(function(r){r.render(e,t)})},EntityObject.prototype.update=function(e){this.forEach(function(t){t.update(e)})},EntityObject.prototype.getComponentCount=function(e){return this.componentManager.getComponentCount(e)},EntityObject.prototype.getAllChildren=function(){return this._entityObjectManager.getAllChildren()},EntityObject.prototype.getGeometry=function(){return this.componentManager.getGeometry()},EntityObject.prototype.afterInitChildren=function(){},EntityObject.prototype.getRenderList=function(){return this.getChildren()},EntityObject.prototype.clearCache=function(){this._hasComponentCache.removeAllChildren(),this._getComponentCache.removeAllChildren()},EntityObject.prototype._getHasComponentCacheKey=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(e.JudgeUtils.isComponenet(t[0])){var n=t[0];return String(n.uid)}var i=t[0];return i.name},EntityObject.prototype._onComponentChange=function(){this.clearCache()},EntityObject.prototype._cloneChildren=function(e){this.forEach(function(t){var r=t.clone();null!==r&&e.addChild(r)})},__decorate([e.cloneAttributeAsBasicType()],EntityObject.prototype,"bubbleParent",null),__decorate([e.cloneAttributeAsBasicType()],EntityObject.prototype,"name",void 0),__decorate([e.cloneAttributeAsBasicType()],EntityObject.prototype,"parent",void 0),__decorate([e.virtual],EntityObject.prototype,"initWhenCreate",null),__decorate([e.require(function(t){var r=this;void 0===t&&(t={}),e.it("if has OneToManySourceInstance component, not support share geometry",function(){t.shareGeometry&&e.expect(r.hasComponent(e.OneToManySourceInstance))["false"]})})],EntityObject.prototype,"clone",null),__decorate([e.cache(function(e){return this._getComponentCache.hasChild(e.name)},function(e){return this._getComponentCache.getChild(e.name)},function(e,t){this._getComponentCache.addChild(t.name,e)})],EntityObject.prototype,"getComponent",null),__decorate([e.virtual],EntityObject.prototype,"render",null),__decorate([e.virtual],EntityObject.prototype,"getGeometry",null),__decorate([e.virtual],EntityObject.prototype,"afterInitChildren",null),__decorate([e.virtual],EntityObject.prototype,"getRenderList",null),__decorate([e.ensure(function(t){e.it("key:"+t+" be string",function(){e.expect(e.JudgeUtils.isString(t))["true"]})})],EntityObject.prototype,"_getHasComponentCacheKey",null),EntityObject}(e.Entity);e.EntityObject=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ComponentManager(e){this.transform=null,this._entityObject=null,this._components=wdCb.Collection.create(),this._rendererComponent=null,this._collider=null,this._geometry=null,this._entityObject=e}return ComponentManager.create=function(e){var t=new this(e);return t},ComponentManager.prototype.init=function(){for(var t=0,r=e.SortUtils.insertSort(this._components.getChildren(),function(t,r){return e.ComponentInitOrderTable.getOrder(t)<e.ComponentInitOrderTable.getOrder(r)});t<r.length;t++){var n=r[t];n.init()}},ComponentManager.prototype.dispose=function(){var e=this.removeAllComponent();e.forEach(function(e){e.dispose()}),this._components.removeAllChildren()},ComponentManager.prototype.removeAllComponent=function(){var e=this,t=wdCb.Collection.create();return this._components.forEach(function(r){e._removeComponentHandler(r),t.addChild(r)},this),t},ComponentManager.prototype.getComponent=function(e){return this._components.findOne(function(t){return t instanceof e})},ComponentManager.prototype.getComponents=function(){return this._components},ComponentManager.prototype.findComponentByUid=function(e){return this._components.findOne(function(t){return t.uid===e})},ComponentManager.prototype.forEachComponent=function(e){return this._components.forEach(e),this},ComponentManager.prototype.hasComponent=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null;if(e.JudgeUtils.isComponenet(t[0])){var i=t[0];n=this._components.hasChild(i)}else{var o=t[0];n=this._components.hasChildWithFunc(function(e){return e instanceof o})}return n},ComponentManager.prototype.addComponent=function(t,r){if(void 0===r&&(r=!1),t)return t instanceof e.RendererComponent?this._rendererComponent=t:t instanceof e.Collider?this._collider=t:t instanceof e.Geometry?this._geometry=t:t instanceof e.Transform&&(this.transform&&this.removeComponent(this.transform),this.transform=t),t.addToObject(this._entityObject,r),this._components.addChild(t),this},ComponentManager.prototype.removeComponent=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null;return n=t[0]instanceof e.Component?t[0]:this.getComponent(t[0]),n&&(this._components.removeChild(n),this._removeComponentHandler(n)),this},ComponentManager.prototype.removeAllComponentFromEngine=function(){this._components.forEach(function(e){return e.removeFromEngine()})},ComponentManager.prototype.getComponentCount=function(e){return this._components.filter(function(t){return t instanceof e}).getCount()},ComponentManager.prototype.getGeometry=function(){return this._geometry},ComponentManager.prototype.getRendererComponent=function(){return this._rendererComponent},ComponentManager.prototype.getCollider=function(){return this._collider},ComponentManager.prototype._removeComponentHandler=function(e){e.removeFromObject(this._entityObject)},__decorate([e.require(function(t,r){var n=this;void 0===r&&(r=!1),t&&e.it("should not add the component which is already added",function(){e.expect(n.hasComponent(t))["false"]})})],ComponentManager.prototype,"addComponent",null),__decorate([e.require(function(){var t=this;e.it("entityObject shouldn't contain more than 1 geometry component",function(){e.expect(t.getComponentCount(e.Geometry)).lessThan(2)})})],ComponentManager.prototype,"getGeometry",null),__decorate([e.require(function(){var t=this;e.it("entityObject shouldn't contain more than 1 rendererComponent",function(){e.expect(t.getComponentCount(e.RendererComponent)).lessThan(2)})})],ComponentManager.prototype,"getRendererComponent",null),__decorate([e.require(function(){var t=this;e.it("entityObject shouldn't contain more than 1 collider",function(){e.expect(t.getComponentCount(e.Collider)).lessThan(2)})})],ComponentManager.prototype,"getCollider",null),ComponentManager}();e.ComponentManager=t}(wd||(wd={}));var wd;!function(e){var t=function(){function EntityObjectManager(e){this._entityObject=null,this._children=wdCb.Collection.create(),this._entityObject=e}return EntityObjectManager.create=function(e){var t=new this(e);return t},EntityObjectManager.prototype.init=function(){this.forEach(function(e){e.init()})},EntityObjectManager.prototype.dispose=function(){this.forEach(function(e){e.dispose()})},EntityObjectManager.prototype.hasChild=function(e){return this._children.hasChild(e)},EntityObjectManager.prototype.addChild=function(e){return e.parent&&e.parent.removeChild(e),e.parent=this._entityObject,e.transform.parent=this._entityObject.transform,this._children.addChild(e),e.onEnter(),this},EntityObjectManager.prototype.addChildren=function(){for(var t=this,r=[],n=0;n<arguments.length;n++)r[n-0]=arguments[n];if(e.JudgeUtils.isArray(r[0]))for(var i=r[0],o=0,a=i;o<a.length;o++){var s=a[o];this.addChild(s)}else if(e.JudgeUtils.isCollection(r[0])){var i=r[0];i.forEach(function(e){t.addChild(e)})}else this.addChild(r[0]);return this},EntityObjectManager.prototype.forEach=function(e){return this._children.forEach(e),this},EntityObjectManager.prototype.filter=function(e){return this._children.filter(e)},EntityObjectManager.prototype.sort=function(e,t){return void 0===t&&(t=!1),this._children.sort(e,t)},EntityObjectManager.prototype.getChildren=function(){return this._children},EntityObjectManager.prototype.getAllChildren=function(){var e=wdCb.Collection.create(),t=function(r){e.addChildren(r.getChildren()),r.forEach(function(e){t(e)})};return t(this._entityObject),e},EntityObjectManager.prototype.getChild=function(e){return this._children.getChild(e)},EntityObjectManager.prototype.findChildByUid=function(e){return this._children.findOne(function(t){return t.uid===e})},EntityObjectManager.prototype.findChildByTag=function(e){return this._children.findOne(function(t){return t.hasTag(e)})},EntityObjectManager.prototype.findChildByName=function(e){return this._children.findOne(function(t){return t.name.search(e)>-1})},EntityObjectManager.prototype.findChildrenByName=function(e){return this._children.filter(function(t){return t.name.search(e)>-1})},EntityObjectManager.prototype.removeChild=function(e){return e.onExit(),e.getAllChildren().forEach(function(e){return e.removeAllComponentFromEngine()}),e.removeAllComponentFromEngine(),this._children.removeChild(e),e.parent=null,this},EntityObjectManager.prototype.removeAllChildren=function(){var e=this;this._children.forEach(function(t){e.removeChild(t)},this)},EntityObjectManager}();e.EntityObjectManager=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ScriptManager(e){this._scriptList=wdCb.Hash.create(),this._entityObject=null,this._scriptExecuteHistory=wdCb.Hash.create(),this._entityObject=e}return ScriptManager.create=function(e){var t=new this(e);return t},ScriptManager.prototype.addChild=function(e,t){this._scriptList.addChild(e,t)},ScriptManager.prototype.getChild=function(e){return this._scriptList.getChild(e)},ScriptManager.prototype.removeChild=function(e){return this._scriptList.removeChild(function(t){return t===e})},ScriptManager.prototype.hasChild=function(e){return this._scriptList.hasChildWithFunc(function(t){return t===e})},ScriptManager.prototype.execScriptOnlyOnce=function(e){var t=this;this._scriptList.forEach(function(r,n){t._isScriptExecuted(n,e)||(r&&r[e]&&r[e](),t._addToScriptExecuteHistory(n,e))},this)},ScriptManager.prototype.execScriptWithData=function(e,t){this._scriptList.forEach(function(r){r[e]&&r[e](t)})},ScriptManager.prototype.execScript=function(e){this._scriptList.forEach(function(t){t[e]&&t[e]()})},ScriptManager.prototype.execEventScriptWithData=function(e,t){this._scriptList.forEach(function(r){r&&r[e]&&r[e](t)})},ScriptManager.prototype._addToScriptExecuteHistory=function(e,t){this._scriptExecuteHistory.addChild(this._buildScriptHistoryKey(e,t),!0)},ScriptManager.prototype._isScriptExecuted=function(e,t){return this._scriptExecuteHistory.getChild(this._buildScriptHistoryKey(e,t))},ScriptManager.prototype._buildScriptHistoryKey=function(e,t){return e+"_"+t},ScriptManager}();e.ScriptManager=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ComponentContainer(){this.list=wdCb.Collection.create()}return ComponentContainer.prototype.addChild=function(e){this.list.addChild(e)},ComponentContainer.prototype.removeChild=function(e){this.list.removeChild(e)},ComponentContainer.prototype.removeAllChildren=function(){this.list.removeAllChildren()},ComponentContainer.prototype.hasChild=function(e){return this.list.hasChild(e)},ComponentContainer}();e.ComponentContainer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function GameObject(){t.apply(this,arguments),this.renderGroup=0,this.renderPriority=0,this.isVisible=!0}return __extends(GameObject,t),GameObject.create=function(){var e=new this;return e.initWhenCreate(),e},GameObject.merge=function(t){var r=t[0],n=r.clone({cloneChildren:!1,cloneGeometry:!1}),i=e.ModelGeometry.create();n.removeAllChildren();for(var o=0,a=t;o<a.length;o++){var s=a[o];i.merge(s.getComponent(e.Geometry),s.transform)}return i.material=r.getComponent(e.Geometry).material.clone(),n.addComponent(i),n},GameObject.prototype.initWhenCreate=function(){t.prototype.initWhenCreate.call(this),this.name="gameObject"+String(this.uid)},GameObject.prototype.getSpacePartition=function(){return this.getComponent(e.ClassUtils.getClass("SpacePartition"))},GameObject.prototype.getGeometry=function(){var r=e.ClassUtils.getClass("GeometryLOD");if(r){var n=this.getComponent(r);if(n&&n.activeGeometry)return n.activeGeometry}return t.prototype.getGeometry.call(this)},GameObject.prototype.createTransform=function(){return e.ThreeDTransform.create()},GameObject.prototype.getRenderList=function(){return e.ClassUtils.hasComponent(this,"Octree")?this.getSpacePartition().getRenderList():e.RenderUtils.getGameObjectRenderList(this.getChildren())},GameObject.prototype.afterInitChildren=function(){if(e.ClassUtils.hasComponent(this,"Octree"))return this.getSpacePartition().build()},__decorate([e.cloneAttributeAsBasicType()],GameObject.prototype,"renderGroup",void 0),__decorate([e.cloneAttributeAsBasicType()],GameObject.prototype,"renderPriority",void 0),__decorate([e.cloneAttributeAsBasicType()],GameObject.prototype,"isVisible",void 0),__decorate([e.require(function(t){var r=function(t){e.assert(t.hasComponent(e.Geometry),e.Log.info.FUNC_SHOULD("contain geometry component"))},n=function(){var n=t[0],i=null;r(n),i=e.ClassUtils.getClassName(n.getComponent(e.Geometry).material);for(var o=1,a=t.length;o<a;o++){var s=t[o];r(s),e.assert(e.ClassUtils.getClassName(s.getComponent(e.Geometry).material)===i,e.Log.info.FUNC_SHOULD("gameObjectArr","has the same material class"))}};e.assert(t.length>1,e.Log.info.FUNC_SHOULD("object count","> 1")),n()}),e.ensure(function(t){e.assert(0===t.getChildren().getCount(),e.Log.info.FUNC_SHOULD("merged object","has no children"))})],GameObject,"merge",null),GameObject}(e.EntityObject);e.GameObject=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function SceneDispatcher(){t.apply(this,arguments),this.name="scene"+String(this.uid),this.uiObjectScene=null,this.gameObjectScene=e.GameObjectScene.create()}return __extends(SceneDispatcher,t),SceneDispatcher.create=function(){var e=new this;return e.initWhenCreate(),e},Object.defineProperty(SceneDispatcher.prototype,"scriptManager",{get:function(){return this.gameObjectScene.scriptManager},set:function(e){},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"ambientLight",{get:function(){return this.gameObjectScene.ambientLight},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"directionLights",{get:function(){return this.gameObjectScene.directionLights},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"pointLights",{get:function(){return this.gameObjectScene.pointLights},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"side",{get:function(){return this.gameObjectScene.side},set:function(e){this.gameObjectScene.side=e},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"shadowMap",{get:function(){return this.gameObjectScene.shadowMap},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"currentCamera",{get:function(){return this.gameObjectScene.currentCamera},set:function(e){this.gameObjectScene.currentCamera=e},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"physics",{get:function(){return this.gameObjectScene.physics},set:function(e){this.gameObjectScene.physics=e},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"glslData",{get:function(){return this.gameObjectScene.glslData},set:function(e){this.gameObjectScene.glslData=e},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"isUseShader",{get:function(){return this.gameObjectScene.isUseShader},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"currentShaderType",{get:function(){return this.gameObjectScene.currentShaderType},enumerable:!0,configurable:!0}),SceneDispatcher.prototype.initWhenCreate=function(){t.prototype.initWhenCreate.call(this),this.addComponent(e.SceneEventTriggerDetector.create());var r=e.ClassUtils.getClass("UIObjectScene");r&&(this.uiObjectScene=r.create())},SceneDispatcher.prototype.useShaderType=function(e){this.gameObjectScene.useShaderType(e)},SceneDispatcher.prototype.unUseShader=function(){this.gameObjectScene.unUseShader()},SceneDispatcher.prototype.addChild=function(t){return t instanceof e.GameObject?this.gameObjectScene.addChild(t):e.JudgeUtils.isClass(t,"UIObject")&&this.uiObjectScene.addChild(t),t.parent=this,this},SceneDispatcher.prototype.addCommonRenderTargetRenderer=function(e){return this.gameObjectScene.renderTargetRendererManager.addCommonRenderTargetRenderer(e)},SceneDispatcher.prototype.addProceduralRenderTargetRenderer=function(e){return this.gameObjectScene.renderTargetRendererManager.addProceduralRenderTargetRenderer(e)},SceneDispatcher.prototype.dispose=function(){this.gameObjectScene.dispose(),this.uiObjectScene.dispose()},SceneDispatcher.prototype.hasChild=function(t){return t instanceof e.GameObject?this.gameObjectScene.hasChild(t):e.JudgeUtils.isClass(t,"UIObject")?this.uiObjectScene.hasChild(t):void 0},SceneDispatcher.prototype.addChildren=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(t[0]instanceof e.EntityObject){var n=t[0];this.addChild(n)}if(t[0]instanceof wdCb.Collection){var i=t[0],o=this;i.forEach(function(e){o.addChild(e)})}else if(e.JudgeUtils.isArrayExactly(t[0]))for(var i=t[0],a=0,s=i;a<s.length;a++){var n=s[a];this.addChild(n)}return this},SceneDispatcher.prototype.getChildren=function(){return this.gameObjectScene.getChildren().clone().addChildren(this.uiObjectScene.getChildren())},SceneDispatcher.prototype.findChildByUid=function(e){var t=this.gameObjectScene.findChildByUid(e);return t||(t=this.uiObjectScene.findChildByUid(e)),t},SceneDispatcher.prototype.findChildByTag=function(e){var t=this.gameObjectScene.findChildByTag(e);return t||(t=this.uiObjectScene.findChildByTag(e)),t},SceneDispatcher.prototype.findChildByName=function(e){var t=this.gameObjectScene.findChildByName(e);return t||(t=this.uiObjectScene.findChildByName(e)),t},SceneDispatcher.prototype.findChildrenByName=function(e){return this.gameObjectScene.findChildrenByName(e).addChildren(this.uiObjectScene.findChildrenByName(e))},SceneDispatcher.prototype.removeChild=function(t){return t instanceof e.GameObject?this.gameObjectScene.removeChild(t):e.JudgeUtils.isClass(t,"UIObject")?this.uiObjectScene.removeChild(t):void 0},SceneDispatcher.prototype.onEnter=function(){this.gameObjectScene.onEnter(),this.uiObjectScene.onEnter()},SceneDispatcher.prototype.onExit=function(){this.gameObjectScene.onExit(),this.uiObjectScene.onExit()},SceneDispatcher.prototype.onDispose=function(){this.gameObjectScene.onDispose(),this.uiObjectScene.onDispose()},SceneDispatcher.prototype.createTransform=function(){return null},__decorate([e.ensureGetter(function(t){t&&e.assert(t.getCount()<=4,e.Log.info.FUNC_SHOULD("direction lights' count","<= 4"))})],SceneDispatcher.prototype,"directionLights",null),__decorate([e.ensureGetter(function(t){t&&e.assert(t.getCount()<=4,e.Log.info.FUNC_SHOULD("point lights' count","<= 4"))})],SceneDispatcher.prototype,"pointLights",null),SceneDispatcher}(e.EntityObject);e.SceneDispatcher=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function Scene(){e.apply(this,arguments)}return __extends(Scene,e),Scene}(e.EntityObject);e.Scene=t}(wd||(wd={}));var wd;!function(e){var t=function(){function BufferTable(){}return BufferTable.bindIndexBuffer=function(t){var r=null;this.lastBindedElementBuffer!==t&&(this.lastBindedElementBuffer=t,r=e.DeviceManager.getInstance().gl,r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t.buffer))},BufferTable.hasBuffer=function(e){return this._table.hasChild(e)},BufferTable.addBuffer=function(e,t){this._table.addChild(e,t)},BufferTable.getBuffer=function(e){return this._table.getChild(e)},BufferTable.dispose=function(){this._table.forEach(function(e){e.dispose()}),this.lastBindedArrayBufferListUidStr=null,this.lastBindedElementBuffer=null},BufferTable.clearAll=function(){this._table.removeAllChildren(),this.lastBindedArrayBufferListUidStr=null,this.lastBindedElementBuffer=null},BufferTable.resetBindedArrayBuffer=function(){var t=e.DeviceManager.getInstance().gl;t.bindBuffer(t.ARRAY_BUFFER,null),this.lastBindedArrayBufferListUidStr=null},BufferTable.resetBindedElementBuffer=function(){var t=e.DeviceManager.getInstance().gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),this.lastBindedElementBuffer=null},BufferTable.lastBindedArrayBufferListUidStr=null,BufferTable.lastBindedElementBuffer=null,BufferTable._table=wdCb.Hash.create(),BufferTable}();e.BufferTable=t,function(e){e[e.PROCEDURAL_VERTEX="PROCEDURAL_VERTEX"]="PROCEDURAL_VERTEX",e[e.PROCEDURAL_INDEX="PROCEDURAL_INDEX"]="PROCEDURAL_INDEX"}(e.BufferTableKey||(e.BufferTableKey={}));e.BufferTableKey}(wd||(wd={}));var wd;!function(e){var t=function(){function ProgramTable(){}return ProgramTable.hasProgram=function(e){return this._table.hasChild(e)},ProgramTable.addProgram=function(e,t){this._table.addChild(e,t)},ProgramTable.getProgram=function(e){return this._table.getChild(e)},ProgramTable.dispose=function(){this._table.forEach(function(e){e.dispose()}),this.lastUsedProgram=null},ProgramTable.clearAll=function(){this._table.removeAllChildren(),this.lastUsedProgram=null},ProgramTable.lastUsedProgram=null,ProgramTable._table=wdCb.Hash.create(),ProgramTable}();e.ProgramTable=t}(wd||(wd={}));var wd;!function(e){var t=function(){function TextureCache(){}return TextureCache.isCached=function(t,r){return e.JudgeUtils.isEqual(this.getActiveTexture(t),r)},TextureCache.addActiveTexture=function(e,t){this._bindTextureUnitCache[e]=t},TextureCache.getActiveTexture=function(e){return this._bindTextureUnitCache[e]},TextureCache.clearAll=function(){this._bindTextureUnitCache=[]},TextureCache.clearAllBindTextureUnitCache=function(){this._bindTextureUnitCache=[]},TextureCache.clearBindTextureUnitCache=function(e){this._bindTextureUnitCache[e]=null},TextureCache._checkUnit=function(t){var r=e.GPUDetector.getInstance().maxTextureUnit;e.assert(t>=0,e.Log.info.FUNC_SHOULD("texture unit",">= 0, but actual is "+t)),e.assert(t<r,"trying to cache "+t+" texture units, but GPU only supports "+r+" units")},TextureCache._bindTextureUnitCache=[],__decorate([e.require(function(e,t){this._checkUnit(e)})],TextureCache,"addActiveTexture",null),__decorate([e.require(function(e,t){this._checkUnit(e)})],TextureCache,"getActiveTexture",null),TextureCache}();e.TextureCache=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function GameObjectScene(){t.apply(this,arguments),this._currentCamera=null,this.side=null,this.shadowMap=r.create(this),this.physics=e.ClassUtils.createClassInstance("PhysicsConfig"),this.glslData=wdCb.Hash.create(),this.currentShaderType=null,this.renderTargetRendererManager=e.RenderTargetRendererManager.create(),this.shadowManager=e.ClassUtils.createClassInstanceOrEmpty("ShadowManager","EmptyShadowManager",this),this._lightManager=e.LightManager.create(),this._cameraList=wdCb.Collection.create()}return __extends(GameObjectScene,t),GameObjectScene.create=function(){var e=new this;return e},Object.defineProperty(GameObjectScene.prototype,"ambientLight",{get:function(){return this._lightManager.ambientLight},enumerable:!0,configurable:!0}),Object.defineProperty(GameObjectScene.prototype,"directionLights",{get:function(){return this._lightManager.directionLights},enumerable:!0,configurable:!0}),Object.defineProperty(GameObjectScene.prototype,"pointLights",{get:function(){return this._lightManager.pointLights},enumerable:!0,configurable:!0}),Object.defineProperty(GameObjectScene.prototype,"currentCamera",{get:function(){return this._currentCamera||this._cameraList.getChild(0)},set:function(t){if(e.JudgeUtils.isNumber(t)){var r=t;this._currentCamera=this._cameraList.getChild(r)}else if(t instanceof e.GameObject){var n=t;this._currentCamera=n}},enumerable:!0,configurable:!0}),Object.defineProperty(GameObjectScene.prototype,"isUseShader",{get:function(){return null!==this.currentShaderType},enumerable:!0,configurable:!0}),GameObjectScene.prototype.init=function(){return e.ClassUtils.execSingletonMethod("PhysicsEngine","initPhysicsEngineAdapter"),this.shadowManager&&this.shadowManager.init(),t.prototype.init.call(this),this.renderTargetRendererManager.init(),e.ClassUtils.execSingletonMethod("PhysicsEngine","initBody"),e.ClassUtils.execSingletonMethod("PhysicsEngine","initConstraint"),this},GameObjectScene.prototype.dispose=function(){t.prototype.dispose.call(this),this.shadowManager.dispose(),this.renderTargetRendererManager.dispose()},GameObjectScene.prototype.addChild=function(e){var r=this._getCameras(e),n=this._getLights(e);return r.getCount()>0&&this._cameraList.addChildren(r),n.getCount()>0&&this._lightManager.addChildren(n),t.prototype.addChild.call(this,e)},GameObjectScene.prototype.update=function(r){var n=this._getCurrentCameraComponent(),i=this.shadowManager;e.ClassUtils.execSingletonMethod("PhysicsEngine","update",r),n&&n.update(r),i.update(r),e.ClassUtils.execSingletonMethod("LODEngine","update",r),e.ClassUtils.execSingletonMethod("SpacePartitionEngine","update",r),e.ClassUtils.execSingletonMethod("AnimationEngine","update",r),e.CollisionEngine.getInstance().update(r),e.ClassUtils.execSingletonMethod("ThreeDUIEngine","update",r),t.prototype.update.call(this,r),e.CollisionEngine.getInstance().detect(r),e.ClassUtils.execSingletonMethod("BillboardEngine","update",r)},GameObjectScene.prototype.render=function(e){this.shadowManager.setShadowRenderListForCurrentLoop(),this.renderTargetRendererManager.render(e,this.currentCamera),t.prototype.render.call(this,e,this.currentCamera)},GameObjectScene.prototype.useShaderType=function(e){this.currentShaderType=e},GameObjectScene.prototype.unUseShader=function(){this.currentShaderType=null},GameObjectScene.prototype.getRenderList=function(){return e.RenderUtils.getGameObjectRenderList(this.getChildren())},GameObjectScene.prototype.createTransform=function(){return null},GameObjectScene.prototype._getCameras=function(e){return this._find(e,this._isCamera)},GameObjectScene.prototype._getLights=function(e){return this._find(e,this._isLight)},GameObjectScene.prototype._find=function(e,t){var r=this,n=wdCb.Collection.create(),i=function(e){t.call(r,e)&&n.addChild(e),e.forEach(function(e){i(e)})};return i(e),n},GameObjectScene.prototype._isCamera=function(t){return t.hasComponent(e.CameraController)},GameObjectScene.prototype._isLight=function(t){return t.hasComponent(e.Light)},GameObjectScene.prototype._getCurrentCameraComponent=function(){return this.currentCamera?this.currentCamera.getComponent(e.CameraController):null},__decorate([e.requireSetter(function(t){if(e.JudgeUtils.isNumber(t)){var r=t;e.assert(!!this._cameraList.getChild(r),e.Log.info.FUNC_NOT_EXIST("current camera in cameraList"))}})],GameObjectScene.prototype,"currentCamera",null),GameObjectScene}(e.Scene);e.GameObjectScene=t;var r=function(){function ShadowMapModel(t){this._scene=null,this._enable=!0,this._softType=e.EShadowMapSoftType.NONE,this.shadowLayerList=e.ClassUtils.createClassInstance("ShadowLayerList",this),this._scene=t}return ShadowMapModel.create=function(e){var t=new this(e);return t},Object.defineProperty(ShadowMapModel.prototype,"enable",{get:function(){return this._enable},set:function(e){this._enable=e},enumerable:!0,configurable:!0}),Object.defineProperty(ShadowMapModel.prototype,"softType",{get:function(){return this._softType},set:function(t){t!==this._softType&&(e.EventManager.broadcast(this._scene,e.CustomEvent.create(e.EEngineEvent.SHADOWMAP_SOFTTYPE_CHANGE)),this._softType=t)},enumerable:!0,configurable:!0}),ShadowMapModel.prototype.getTwoDShadowMapDataMap=function(e){return this._scene.shadowManager.getTwoDShadowMapDataMap(e)},ShadowMapModel.prototype.getCubemapShadowMapDataMap=function(e){return this._scene.shadowManager.getCubemapShadowMapDataMap(e)},ShadowMapModel}();e.ShadowMapModel=r}(wd||(wd={}));var wd;!function(e){var t=function(){function CollisionDetector(){this._collisionTable=wdCb.Hash.create(),this._lastCollisionTable=wdCb.Hash.create()}return CollisionDetector.create=function(){var e=new this;return e},CollisionDetector.prototype.update=function(t){var r=e.Director.getInstance().scene.gameObjectScene,n=r.filter(function(t){
return t.hasComponent(e.Collider)||e.JudgeUtils.isSpacePartitionObject(t)&&t.getSpacePartition().isCollideEnable}),i=this;0!==n.getCount()&&(this._clearCollisionTable(),n.forEach(function(t){e.ClassUtils.hasComponent(t,"RigidBody")||i._recordCollideObjects(t,n)}),this._triggerCollisionEvent())},CollisionDetector.prototype._recordCollideObjects=function(t,r){var n=this;if(e.JudgeUtils.isSpacePartitionObject(t)){var i=t.getSpacePartition();return void r.forEach(function(r){e.JudgeUtils.isSelf(t,r)||(e.JudgeUtils.isSpacePartitionObject(r)?n._handleCollisionBetweenSpacePartitionAndSpacePartition(r.getSpacePartition(),i):n._handleCollisionBetweenGameObjectAndSpacePartition(r.getComponent(e.Collider),i))})}var o=t.getComponent(e.Collider);o.enable&&r.forEach(function(r){e.JudgeUtils.isSelf(t,r)||(e.JudgeUtils.isSpacePartitionObject(r)?n._handleCollisionBetweenGameObjectAndSpacePartition(o,r.getSpacePartition()):n._handleCollisionBetweenGameObjectAndGameObject(o,r))})},CollisionDetector.prototype._isGameObjectCollideWithGameObject=function(e,t,n){return!(this._isNotTransform(e)&&this._isNotTransform(n)&&!e.hasTag(r.COLLIDED))&&t.isCollide(n)},CollisionDetector.prototype._clearCollisionTable=function(){this._collisionTable.removeAllChildren()},CollisionDetector.prototype._isCollidedInTable=function(e,t){var r=this._collisionTable,n=String(e.uid),i=String(t.uid);return r.hasChild(n)&&r.getChild(n).targetObjectMap.hasChild(i)},CollisionDetector.prototype._recordToTable=function(e,t){var r=this._collisionTable,n=String(e.uid),i=String(t.uid);if(!r.hasChild(n)){var o=wdCb.Hash.create();return o.addChild(i,t),void r.addChild(n,{sourceObject:e,targetObjectMap:o})}r.getChild(n).targetObjectMap.addChild(i,t)},CollisionDetector.prototype._handleCollisionBetweenGameObjectAndSpacePartition=function(t,r){var n=t.entityObject,i=this;t.enable&&r.getCollideObjects(t.shape).forEach(function(t){var r=t.getComponent(e.Collider);r.enable&&!i._isCollidedInTable(t,n)&&i._isGameObjectCollideWithGameObject(t,r,n)&&(i._recordToTable(t,n),i._recordToTable(n,t))})},CollisionDetector.prototype._handleCollisionBetweenSpacePartitionAndSpacePartition=function(t,r){var n=this;t.getChildren().forEach(function(t){var i=t.getComponent(e.Collider);i.enable&&n._handleCollisionBetweenGameObjectAndSpacePartition(i,r)},this)},CollisionDetector.prototype._handleCollisionBetweenGameObjectAndGameObject=function(t,r){var n=t.entityObject;r.getComponent(e.Collider).enable&&!this._isCollidedInTable(n,r)&&this._isGameObjectCollideWithGameObject(n,t,r)&&(this._recordToTable(n,r),this._recordToTable(r,n))},CollisionDetector.prototype._isCollisionStart=function(e){return!e.hasTag(r.COLLIDED)},CollisionDetector.prototype._triggerCollisionEventOfCollideObjectWhichHasRigidBody=function(t,r,n){e.ClassUtils.hasComponent(r,"RigidBody")&&t.filter(function(t){return e.ClassUtils.hasComponent(t,"RigidBody")}).forEach(function(t){for(var i=0,o=n;i<o.length;i++){var a=o[i];e.ScriptEngine.getInstance().execEntityObjectScriptWithData(t,a,wdCb.Collection.create([r]))}})},CollisionDetector.prototype._triggerCollisionEvent=function(){var t=this;this._collisionTable.forEach(function(n){var i=n.sourceObject,o=n.targetObjectMap,a=o.toCollection();t._isCollisionStart(i)?(e.ScriptEngine.getInstance().execEntityObjectScriptWithData(i,"onCollisionStart",a),e.ScriptEngine.getInstance().execEntityObjectScriptWithData(i,"onContact",a),t._triggerCollisionEventOfCollideObjectWhichHasRigidBody(a,i,["onCollisionStart","onContact"])):(e.ScriptEngine.getInstance().execEntityObjectScriptWithData(i,"onContact",a),t._triggerCollisionEventOfCollideObjectWhichHasRigidBody(a,i,["onContact"])),i.hasTag(r.COLLIDED)||i.addTag(r.COLLIDED)},this),this._triggerCollisionEndEvent(),this._lastCollisionTable=this._collisionTable.clone()},CollisionDetector.prototype._triggerCollisionEndEvent=function(){var t=this,n=this._collisionTable;this._lastCollisionTable.forEach(function(i){var o=i.sourceObject,a=i.targetObjectMap;n.hasChild(String(o.uid))||(e.ScriptEngine.getInstance().execEntityObjectScript(o,"onCollisionEnd"),t._triggerCollisionEventOfCollideObjectWhichHasRigidBody(a.toCollection(),o,["onCollisionEnd"]),o.removeTag(r.COLLIDED))})},CollisionDetector.prototype._isNotTransform=function(e){return!e.transform.isTransform},__decorate([e.require(function(t,r){r.forEach(function(t){e.assert(t instanceof e.GameObject,e.Log.info.FUNC_SHOULD("targetObject","be GameObject"))})})],CollisionDetector.prototype,"_recordCollideObjects",null),__decorate([e.require(function(t,r,n){e.assert(t instanceof e.GameObject&&n instanceof e.GameObject,e.Log.info.FUNC_SHOULD("sourceObject and targetObject","be GameObject"))})],CollisionDetector.prototype,"_isGameObjectCollideWithGameObject",null),CollisionDetector}();e.CollisionDetector=t;var r;!function(e){e[e.COLLIDED="COLLIDED"]="COLLIDED"}(r||(r={}))}(wd||(wd={}));var wd;!function(e){var t=function(){function EmptyShadowManager(){}return EmptyShadowManager.create=function(){var e=new this;return e},EmptyShadowManager.prototype.update=function(e){},EmptyShadowManager.prototype.dispose=function(){},EmptyShadowManager.prototype.getTwoDShadowMapDataMap=function(e){return null},EmptyShadowManager.prototype.getCubemapShadowMapDataMap=function(e){return null},EmptyShadowManager.prototype.setShadowRenderListForCurrentLoop=function(){},EmptyShadowManager.prototype.getShadowRenderListByLayer=function(e){return null},EmptyShadowManager.prototype.getShadowLayerList=function(){return null},EmptyShadowManager.prototype.init=function(){},EmptyShadowManager}();e.EmptyShadowManager=t}(wd||(wd={}));var wd;!function(e){var t=function(){function LightManager(){this._lights=wdCb.Hash.create()}return LightManager.create=function(){var e=new this;return e},Object.defineProperty(LightManager.prototype,"ambientLight",{get:function(){return this._lights.getChild(e.AmbientLight.type)},enumerable:!0,configurable:!0}),Object.defineProperty(LightManager.prototype,"directionLights",{get:function(){return this._getLights(e.DirectionLight.type)},enumerable:!0,configurable:!0}),Object.defineProperty(LightManager.prototype,"pointLights",{get:function(){return this._getLights(e.PointLight.type)},enumerable:!0,configurable:!0}),LightManager.prototype.addChild=function(t){t.hasComponent(e.AmbientLight)?this._lights.addChild(e.AmbientLight.type,t):t.hasComponent(e.DirectionLight)?this._lights.appendChild(e.DirectionLight.type,t):t.hasComponent(e.PointLight)?this._lights.appendChild(e.PointLight.type,t):e.Log.error(!0,e.Log.info.FUNC_INVALID("light"))},LightManager.prototype.addChildren=function(e){var t=this;e.forEach(function(e){t.addChild(e)})},LightManager.prototype._getLights=function(e){return this._lights.getChild(e)},LightManager}();e.LightManager=t}(wd||(wd={}));var wd;!function(e){var t=function(){function RenderTargetRendererManager(){this._commonRenderTargetRendererList=wdCb.Collection.create(),this._proceduralRendererList=wdCb.Collection.create()}return RenderTargetRendererManager.create=function(){var e=new this;return e},RenderTargetRendererManager.prototype.init=function(){this._commonRenderTargetRendererList.forEach(function(e){return e.init()}),this._proceduralRendererList.forEach(function(e){return e.init()})},RenderTargetRendererManager.prototype.dispose=function(){this._commonRenderTargetRendererList.forEach(function(e){return e.dispose()}),this._proceduralRendererList.forEach(function(e){return e.dispose()})},RenderTargetRendererManager.prototype.addCommonRenderTargetRenderer=function(e){this._commonRenderTargetRendererList.addChild(e)},RenderTargetRendererManager.prototype.getCommonRenderTargetRendererList=function(){return this._commonRenderTargetRendererList},RenderTargetRendererManager.prototype.removeCommonRenderTargetRenderer=function(e){return this._commonRenderTargetRendererList.removeChild(e)},RenderTargetRendererManager.prototype.addProceduralRenderTargetRenderer=function(e){this._proceduralRendererList.addChild(e)},RenderTargetRendererManager.prototype.render=function(e,t){this._proceduralRendererList.filter(function(e){return e.needRender()}).forEach(function(t){t.render(e)}),this._commonRenderTargetRendererList.filter(function(e){return e.needRender()}).forEach(function(r){r.render(e,t)})},RenderTargetRendererManager}();e.RenderTargetRendererManager=t}(wd||(wd={}));var wd;!function(e){var t=function(){function EventManager(){}return EventManager.on=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(2===t.length&&e.JudgeUtils.isString(t[0])){var n=t[0],i=t[1],o=1,a=e.EventBinderFactory.createEventBinder(n);a.on(n,i,o)}else if(3===t.length&&e.JudgeUtils.isString(t[0])){var n=t[0],i=t[1],o=t[2],a=e.EventBinderFactory.createEventBinder(n);a.on(n,i,o)}else if(3===t.length&&t[0]instanceof e.EntityObject){var s=t[0],n=t[1],i=t[2],o=1,a=e.CustomEventBinder.getInstance();a.on(s,n,i,o)}else if(3===t.length&&e.JudgeUtils.isDom(t[0])){var c=t[0],n=t[1],i=t[2],o=1,a=e.DomEventBinder.getInstance();a.on(c,n,i,o)}else if(4===t.length&&t[0]instanceof e.EntityObject){var s=t[0],n=t[1],i=t[2],o=t[3],a=e.CustomEventBinder.getInstance();a.on(s,n,i,o)}else if(4===t.length&&e.JudgeUtils.isDom(t[0])){var c=t[0],n=t[1],i=t[2],o=t[3],a=e.DomEventBinder.getInstance();a.on(c,n,i,o)}},EventManager.off=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(0===t.length){var n=e.CustomEventBinder.getInstance(),i=e.DomEventBinder.getInstance();n.off(),i.off()}else if(1===t.length&&e.JudgeUtils.isString(t[0])){var o=t[0],a=e.EventBinderFactory.createEventBinder(o);a.off(o)}else if(1===t.length&&t[0]instanceof e.EntityObject){var s=t[0],a=e.CustomEventBinder.getInstance();a.off(s)}else if(1===t.length&&e.JudgeUtils.isDom(t[0])){var c=t[0],a=e.DomEventBinder.getInstance();a.off(c)}else if(2===t.length&&e.JudgeUtils.isString(t[0])){var o=t[0],u=t[1],a=e.EventBinderFactory.createEventBinder(o);a.off(o,u)}else if(2===t.length&&t[0]instanceof e.EntityObject){var s=t[0],o=t[1],a=e.CustomEventBinder.getInstance();a.off(s,o)}else if(2===t.length&&e.JudgeUtils.isDom(t[0])){var c=t[0],o=t[1],a=e.DomEventBinder.getInstance();a.off(c,o)}else if(3===t.length&&t[0]instanceof e.EntityObject){var s=t[0],o=t[1],u=t[2],a=e.CustomEventBinder.getInstance();a.off(s,o,u)}else if(3===t.length&&e.JudgeUtils.isDom(t[0])){var c=t[0],o=t[1],u=t[2],a=e.DomEventBinder.getInstance();a.off(c,o,u)}},EventManager.trigger=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=t.length;if(1===n){var i=t[0],o=e.EventDispatcherFactory.createEventDispatcher(i);o.trigger(i)}else if(2===n&&e.EventUtils.isEvent(t[0])){var a=t[0],s=t[1],o=e.CustomEventDispatcher.getInstance();o.trigger(a,s)}else if(2===n&&e.EventUtils.isEntityObject(t[0])){var c=t[0],u=t[1],o=e.CustomEventDispatcher.getInstance();if(!c)return;o.trigger(c,u)}else if(2===n){var l=t[0],h=t[1],o=e.DomEventDispatcher.getInstance();if(!l)return;o.trigger(l,h)}else if(3===n){var c=t[0],d=t[1],s=t[2],o=e.CustomEventDispatcher.getInstance();if(!c)return;o.trigger(c,d,s)}else if(4===n){var c=t[0],p=t[1],s=t[2],f=t[3],o=e.CustomEventDispatcher.getInstance();if(!c)return;o.trigger(c,p,s,f)}},EventManager.broadcast=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=e.CustomEventDispatcher.getInstance();n.broadcast.apply(n,t)},EventManager.emit=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=e.CustomEventDispatcher.getInstance();n.emit.apply(n,t)},EventManager.fromEvent=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=null;if(1===t.length){var o=t[0];n=function(e){EventManager.on(o,e)},i=function(e){EventManager.off(o,e)}}else if(2===t.length&&e.JudgeUtils.isNumber(t[1])){var a=t[0],s=t[1];n=function(e){EventManager.on(a,e,s)},i=function(e){EventManager.off(a,e)}}else if(2===t.length){var c=t[1];n=function(e){EventManager.on(t[0],c,e)},i=function(e){EventManager.off(t[0],c,e)}}else if(3===t.length){var u=t[1],l=t[2];n=function(e){EventManager.on(t[0],u,e,l)},i=function(e){EventManager.off(t[0],u,e)}}return wdFrp.fromEventPattern(n,i)},EventManager.setBubbleParent=function(t,r){e.CustomEventRegister.getInstance().setBubbleParent(t,r)},__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(t[0]instanceof e.EntityObject){var n=t[1];e.it("event must be custom event",function(){var t=e.EventTable.getEventType(n);e.expect(t===e.EEventType.CUSTOM||t===e.EEventType.POINT)["true"]})}else if(e.JudgeUtils.isDom(t[0])){var i=t[1],o=e.EventTable.getEventType(i);e.it("event must be dom event",function(){e.expect(o===e.EEventType.TOUCH||o===e.EEventType.MOUSE||o===e.EEventType.KEYBOARD)["true"]})}})],EventManager,"on",null),__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(t.length>2&&t[0]instanceof e.EntityObject){var n=t[1],i=e.EventTable.getEventType(n);e.it("event must be custom or point event",function(){e.expect(i===e.EEventType.CUSTOM||i===e.EEventType.POINT)["true"]})}else if(t.length>2&&e.JudgeUtils.isDom(t[0])){var n=t[1],o=e.EventTable.getEventType(n);e.it("event must be keyboard event",function(){e.expect(o===e.EEventType.KEYBOARD)["true"]})}})],EventManager,"off",null),__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(2===t.length&&t[0]instanceof e.Event){var n=t[0];e.assert(n instanceof e.CustomEvent,e.Log.info.FUNC_MUST_BE("event type","CUSTOM"))}else if(2===t.length&&t[0]instanceof e.EntityObject);else if(2===t.length)t[0]&&e.assert(e.JudgeUtils.isDom(t[0]),e.Log.info.FUNC_MUST_BE("the first param","dom"));else if(t[0]instanceof e.EntityObject){var i=t[1];e.assert(i instanceof e.CustomEvent,e.Log.info.FUNC_MUST_BE("event type","CUSTOM"))}})],EventManager,"trigger",null),__decorate([e.require(function(t,r,n){e.assert(r instanceof e.CustomEvent,e.Log.info.FUNC_MUST_BE("eventObject","CustomEvent"))})],EventManager,"broadcast",null),__decorate([e.require(function(t,r,n){e.assert(r instanceof e.CustomEvent,e.Log.info.FUNC_MUST_BE("eventObject","CustomEvent"))})],EventManager,"emit",null),__decorate([e.require(function(t,r){e.assert(t instanceof e.EntityObject,"only EntityObject can setBubleParent")})],EventManager,"setBubbleParent",null),EventManager}();e.EventManager=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.STARTLOOP="wd_startLoop"]="STARTLOOP",e[e.ENDLOOP="wd_endLoop"]="ENDLOOP",e[e.POINT_TAP="wd_pointtap"]="POINT_TAP",e[e.POINT_DOWN="wd_pointdown"]="POINT_DOWN",e[e.POINT_UP="wd_pointup"]="POINT_UP",e[e.POINT_MOVE="wd_pointmove"]="POINT_MOVE",e[e.POINT_OVER="wd_pointover"]="POINT_OVER",e[e.POINT_OUT="wd_pointout"]="POINT_OUT",e[e.POINT_SCALE="wd_pointscale"]="POINT_SCALE",e[e.POINT_DRAG="wd_pointdrag"]="POINT_DRAG",e[e.MATERIAL_CHANGE="wd_material_change"]="MATERIAL_CHANGE",e[e.MATERIAL_COLOR_CHANGE="wd_material_color_change"]="MATERIAL_COLOR_CHANGE",e[e.UI_WIDTH_CHANGE="wd_ui_width_change"]="UI_WIDTH_CHANGE",e[e.UI_HEIGHT_CHANGE="wd_ui_height_change"]="UI_HEIGHT_CHANGE",e[e.TRANSFORM_TRANSLATE="wd_transform_translate"]="TRANSFORM_TRANSLATE",e[e.TRANSFORM_ROTATE="wd_transform_rotate"]="TRANSFORM_ROTATE",e[e.TRANSFORM_SCALE="wd_transform_scale"]="TRANSFORM_SCALE",e[e.SHADOWMAP_SOFTTYPE_CHANGE="wd_shadowMap_softType_change"]="SHADOWMAP_SOFTTYPE_CHANGE",e[e.SHADOWMAP_LAYER_CHANGE="wd_shadowMap_layer_change"]="SHADOWMAP_LAYER_CHANGE",e[e.COMPONENT_CHANGE="wd_component_change"]="COMPONENT_CHANGE",e[e.AFTER_SCENEGRAPH_BUILD="wd_after_sceneGraph_build"]="AFTER_SCENEGRAPH_BUILD",e[e.ANIMATION_STOP="wd_animation_stop"]="ANIMATION_STOP",e[e.EXIT="wd_exit"]="EXIT",e[e.ENTER="wd_enter"]="ENTER"}(e.EEngineEvent||(e.EEngineEvent={}));e.EEngineEvent}(wd||(wd={}));var wd;!function(e){var t=function(){function EventListenerMap(){}return EventListenerMap.prototype.buildSecondLevelKey=function(e){return e},EventListenerMap}();e.EventListenerMap=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CustomEventListenerMap(){t.apply(this,arguments),this._globalListenerMap=wdCb.Hash.create(),this._targetRecordMap=wdCb.Hash.create()}return __extends(CustomEventListenerMap,t),CustomEventListenerMap.create=function(){var e=new this;return e},CustomEventListenerMap.prototype.hasChild=function(e){return e.customEventMap.getCount()>0},CustomEventListenerMap.prototype.appendChild=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];if(2===e.length){var r=e[0],n=e[1];this._globalListenerMap.appendChild(r,n)}else{var i=e[0],r=e[1],n=e[2];this._targetRecordMap.addChild(this.buildFirstLevelKey(i),i),i.customEventMap.appendChild(this.buildSecondLevelKey(r),n)}},CustomEventListenerMap.prototype.forEachAll=function(e){this._globalListenerMap.forEach(e),this._targetRecordMap.forEach(function(t){t.customEventMap.forEach(e)})},CustomEventListenerMap.prototype.forEachEventName=function(e){this._globalListenerMap.forEach(e)},CustomEventListenerMap.prototype.clear=function(){this._globalListenerMap.removeAllChildren(),this._targetRecordMap.forEach(function(e){e.customEventMap.removeAllChildren()}),this._targetRecordMap.removeAllChildren()},CustomEventListenerMap.prototype.getChild=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(1===t.length&&e.JudgeUtils.isString(t[0])){var n=t[0];return this._globalListenerMap.getChild(n)}if(1===t.length&&t[0]instanceof e.EntityObject){var i=t[0];return i.customEventMap}if(2===t.length){var i=t[0],n=t[1],o=null;return o=i.customEventMap,o?o.getChild(this.buildSecondLevelKey(n)):null}},CustomEventListenerMap.prototype.removeChild=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(1===t.length&&e.JudgeUtils.isString(t[0])){var n=t[0];this._globalListenerMap.removeChild(n)}else if(1===t.length&&t[0]instanceof e.EntityObject){var i=t[0];i.customEventMap.removeAllChildren(),this._targetRecordMap.removeChild(this.buildFirstLevelKey(i))}else if(2===t.length&&e.JudgeUtils.isString(t[0])){var n=t[0],o=t[1],a=null;a=this._globalListenerMap.getChild(n),a&&(a.removeChild(function(e){return e.originHandler===o}),0===a.getCount()&&this._globalListenerMap.removeChild(n))}else if(2===t.length&&e.JudgeUtils.isNumber(t[0])){var s=t[0],n=t[1],c=null;c=this._targetRecordMap.getChild(this.buildFirstLevelKey(s)),c&&c.removeChild(this.buildSecondLevelKey(n))}else if(2===t.length&&t[0]instanceof e.EntityObject){var i=t[0],n=t[1],c=null;c=i.customEventMap,c&&c.removeChild(this.buildSecondLevelKey(n))}else if(3===t.length&&t[0]instanceof e.EntityObject){var i=t[0],n=t[1],u=t[2],c=null;if(c=i.customEventMap){var l=c.getChild(n);l&&(l.removeChild(function(e){return e.originHandler===u}),0===l.getCount()&&c.removeChild(n))}}},CustomEventListenerMap.prototype.buildFirstLevelKey=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=e[0],n=r.uid;return n?String(n):r},CustomEventListenerMap}(e.EventListenerMap);e.CustomEventListenerMap=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DomEventListenerMap(){t.apply(this,arguments),this._targetListenerMap=wdCb.Hash.create()}return __extends(DomEventListenerMap,t),DomEventListenerMap.create=function(){var e=new this;return e},DomEventListenerMap.prototype.hasChild=function(e,t){var r=this._targetListenerMap.getChild(this.buildFirstLevelKey(e));return!!r&&(r=r.getChild(t),r&&r.getCount()>0)},DomEventListenerMap.prototype.appendChild=function(e,t,r){var n=this.buildFirstLevelKey(e);if(!this._targetListenerMap.hasChild(n)){var i=wdCb.Hash.create();return i.addChild(this.buildSecondLevelKey(t),wdCb.Collection.create([r])),void this._targetListenerMap.addChild(n,i)}this._targetListenerMap.getChild(n).appendChild(this.buildSecondLevelKey(t),r)},DomEventListenerMap.prototype.forEachAll=function(e){this._targetListenerMap.forEach(function(t){t.forEach(e)})},DomEventListenerMap.prototype.forEachEventName=function(e){this.forEachAll(e)},DomEventListenerMap.prototype.clear=function(){this._targetListenerMap.removeAllChildren()},DomEventListenerMap.prototype.getChild=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];if(1===e.length){var r=e[0];return this._targetListenerMap.getChild(this.buildFirstLevelKey(r))}if(2===e.length){var r=e[0],n=e[1],i=null;return i=this._targetListenerMap.getChild(this.buildFirstLevelKey(r)),i?i.getChild(this.buildSecondLevelKey(n)):null}},DomEventListenerMap.prototype.removeChild=function(){for(var t=this,r=[],n=0;n<arguments.length;n++)r[n-0]=arguments[n];var i=null;if(1===r.length&&e.JudgeUtils.isString(r[0])){var o=r[0],a=[];this._targetListenerMap.forEach(function(e,r){var n=t.buildSecondLevelKey(o);e.hasChild(n)&&a.push(e.removeChild(n).getChild(0))});for(var s=wdCb.Collection.create(),c=0,u=a;c<u.length;c++){var l=u[c];s.addChildren(l)}i=this._getEventDataOffDataList(o,s)}else if(2===r.length&&e.JudgeUtils.isString(r[0])){var h=r[0],d=r[1],p=[];this._targetListenerMap.forEach(function(e,r){var n=e.getChild(t.buildSecondLevelKey(h));n&&p.push(n.removeChild(function(e){return e.originHandler===d}))});for(var s=wdCb.Collection.create(),f=0,m=p;f<m.length;f++){var l=m[f];s.addChildren(l)}i=this._getEventDataOffDataList(h,s)}else if(2===r.length&&e.JudgeUtils.isDom(r[0])){var g=r[0],_=r[1],y=null;y=this._targetListenerMap.getChild(this.buildFirstLevelKey(g)),i=y?this._getEventDataOffDataList(_,y.removeChild(this.buildSecondLevelKey(_)).getChild(0)):wdCb.Collection.create()}else if(3===r.length&&e.JudgeUtils.isDom(r[0])){var g=r[0],_=r[1],v=r[2],y=null;if(y=this._targetListenerMap.getChild(this.buildFirstLevelKey(g))){var l=y.getChild(this.buildSecondLevelKey(_));i=l?this._getEventDataOffDataList(_,l.removeChild(function(e){return e.originHandler===v})):wdCb.Collection.create()}else i=wdCb.Collection.create()}return i},DomEventListenerMap.prototype.buildFirstLevelKey=function(e){return e.id?""+e.tagName+e.id:e.nodeName?""+e.nodeName:""+e.tagName},DomEventListenerMap.prototype._getEventDataOffDataList=function(e,t){return t?t.map(function(t){return{dom:t.dom,eventName:e,domHandler:t.domHandler}}):wdCb.Collection.create()},DomEventListenerMap}(e.EventListenerMap);e.DomEventListenerMap=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.MOUSE=0]="MOUSE",e[e.TOUCH=1]="TOUCH",e[e.POINT=2]="POINT",e[e.KEYBOARD=3]="KEYBOARD",e[e.CUSTOM=4]="CUSTOM"}(e.EEventType||(e.EEventType={}));e.EEventType}(wd||(wd={}));var wd;!function(e){var t;!function(e){e[e.FALLBACK="fallback"]="FALLBACK",e[e.FIREFOX="firefox"]="FIREFOX",e[e.CHROME="chrome"]="CHROME"}(t||(t={})),function(e){e[e.CLICK="click"]="CLICK",e[e.MOUSEOVER="mouseover"]="MOUSEOVER",e[e.MOUSEUP="mouseup"]="MOUSEUP",e[e.MOUSEOUT="mouseout"]="MOUSEOUT",e[e.MOUSEMOVE="mousemove"]="MOUSEMOVE",e[e.MOUSEDOWN="mousedown"]="MOUSEDOWN",e[e.MOUSEWHEEL="mousewheel|DOMMouseScroll*"+t.FIREFOX]="MOUSEWHEEL",e[e.MOUSEDRAG="mousedrag"]="MOUSEDRAG",e[e.TOUCHUP="touchend"]="TOUCHUP",e[e.TOUCHMOVE="touchmove"]="TOUCHMOVE",e[e.TOUCHDOWN="touchstart"]="TOUCHDOWN",e[e.KEYDOWN="keydown"]="KEYDOWN",e[e.KEYUP="keyup"]="KEYUP",e[e.KEYPRESS="keypress"]="KEYPRESS"}(e.EEventName||(e.EEventName={}));var r=(e.EEventName,"|"),n="*",i=function(){function EventNameHandler(){}return EventNameHandler.handleEventName=function(e){for(var t=e,n=null,i=[],o=null,a=0,s=t.split(r);a<s.length;a++){var c=s[a];this._isFallbackEventName(c)?n=c:i.push(c)}return o=this._getSpecifyBrowserEventName(i),null!==o?o:n},EventNameHandler._isFallbackEventName=function(e){return 1===e.split(n).length},EventNameHandler._getSpecifyBrowserEventName=function(e){for(var r=null,i=0,o=e;i<o.length;i++){var a=o[i],s=a.split(n),c=s[0],u=s[1];switch(u){case t.CHROME:bowser.chrome&&(r=c);break;case t.FIREFOX:bowser.firefox&&(r=c)}if(r)break}return r},EventNameHandler}();e.EventNameHandler=i}(wd||(wd={}));var wd;!function(e){!function(e){e[e.BROADCAST=0]="BROADCAST",e[e.EMIT=1]="EMIT"}(e.EEventPhase||(e.EEventPhase={}));e.EEventPhase}(wd||(wd={}));var wd;!function(e){var t=wdCb.Hash.create();t.addChild(e.EEventName.CLICK,e.EEventType.MOUSE),t.addChild(e.EEventName.MOUSEMOVE,e.EEventType.MOUSE),t.addChild(e.EEventName.MOUSEDOWN,e.EEventType.MOUSE),t.addChild(e.EEventName.MOUSEDRAG,e.EEventType.MOUSE),t.addChild(e.EEventName.MOUSEOUT,e.EEventType.MOUSE),t.addChild(e.EEventName.MOUSEOVER,e.EEventType.MOUSE),t.addChild(e.EEventName.MOUSEUP,e.EEventType.MOUSE),t.addChild(e.EEventName.MOUSEWHEEL,e.EEventType.MOUSE),t.addChild(e.EEventName.TOUCHMOVE,e.EEventType.TOUCH),t.addChild(e.EEventName.TOUCHDOWN,e.EEventType.TOUCH),t.addChild(e.EEventName.TOUCHUP,e.EEventType.TOUCH),t.addChild(e.EEngineEvent.POINT_TAP,e.EEventType.POINT),t.addChild(e.EEngineEvent.POINT_OVER,e.EEventType.POINT),t.addChild(e.EEngineEvent.POINT_OUT,e.EEventType.POINT),t.addChild(e.EEngineEvent.POINT_MOVE,e.EEventType.POINT),t.addChild(e.EEngineEvent.POINT_DOWN,e.EEventType.POINT),t.addChild(e.EEngineEvent.POINT_UP,e.EEventType.POINT),t.addChild(e.EEngineEvent.POINT_SCALE,e.EEventType.POINT),t.addChild(e.EEngineEvent.POINT_DRAG,e.EEventType.POINT),t.addChild(e.EEventName.KEYDOWN,e.EEventType.KEYBOARD),t.addChild(e.EEventName.KEYPRESS,e.EEventType.KEYBOARD),t.addChild(e.EEventName.KEYUP,e.EEventType.KEYBOARD);var r=function(){function EventTable(){}return EventTable.getEventType=function(r){var n=t.getChild(r);return void 0===n&&(n=e.EEventType.CUSTOM),n},EventTable}();e.EventTable=r}(wd||(wd={}));var wd;!function(e){var t=function(){function Event(e){this.name=null,this.currentTarget=null,this.isStopPropagation=!1,this.phase=null,this.name=e}return Event.prototype.stopPropagation=function(){this.isStopPropagation=!0},Event.prototype.copyMember=function(e,t,r){return r.forEach(function(r){e[r]=t[r]}),e},Event}();e.Event=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DomEvent(e,r){t.call(this,r),this._event=null,this.event=e}return __extends(DomEvent,t),Object.defineProperty(DomEvent.prototype,"event",{get:function(){return this._event},set:function(t){this._event=t||e.root.event},enumerable:!0,configurable:!0}),DomEvent.prototype.preventDefault=function(){var e=this._event;bowser.msie&&Number(bowser.version)<=8?e.returnValue=!1:e.preventDefault()},DomEvent.prototype.getDataFromCustomEvent=function(e){this.target=e.target,this.currentTarget=e.currentTarget,this.isStopPropagation=e.isStopPropagation},DomEvent}(e.Event);e.DomEvent=t}(wd||(wd={}));var wd;!function(e){var t={8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",61:"=",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},r={"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"},n=function(n){function KeyboardEvent(){n.apply(this,arguments),this.type=e.EEventType.KEYBOARD,this.keyState=null}return __extends(KeyboardEvent,n),KeyboardEvent.create=function(e,t){var r=new this(e,t);return r},Object.defineProperty(KeyboardEvent.prototype,"ctrlKey",{get:function(){return this.event.ctrlKey},enumerable:!0,configurable:!0}),Object.defineProperty(KeyboardEvent.prototype,"altKey",{get:function(){return this.event.altKey},enumerable:!0,configurable:!0}),Object.defineProperty(KeyboardEvent.prototype,"shiftKey",{get:function(){return this.event.shiftKey},enumerable:!0,configurable:!0}),Object.defineProperty(KeyboardEvent.prototype,"metaKey",{get:function(){return this.event.metaKey},enumerable:!0,configurable:!0}),Object.defineProperty(KeyboardEvent.prototype,"keyCode",{get:function(){return this.event.keyCode},enumerable:!0,configurable:!0}),Object.defineProperty(KeyboardEvent.prototype,"key",{get:function(){var e=t[this.keyCode],n=null;return e?e:(n=String.fromCharCode(this.keyCode).toLowerCase(),this.shiftKey?r[n]:n)},enumerable:!0,configurable:!0}),KeyboardEvent.prototype.clone=function(){var e=KeyboardEvent.create(this.event,this.name);return this.copyMember(e,this,["target","currentTarget","isStopPropagation","phase"])},KeyboardEvent}(e.DomEvent);e.KeyboardEvent=n}(wd||(wd={}));var wd;!function(e){var t=function(t){function PointEvent(){t.apply(this,arguments),this.type=e.EEventType.POINT,this.eventObj=null}return __extends(PointEvent,t),Object.defineProperty(PointEvent.prototype,"lastX",{get:function(){return this.eventObj.lastX},set:function(e){this.eventObj.lastX=e},enumerable:!0,configurable:!0}),Object.defineProperty(PointEvent.prototype,"lastY",{get:function(){return this.eventObj.lastY},set:function(e){this.eventObj.lastY=e},enumerable:!0,configurable:!0}),PointEvent.prototype.cloneHelper=function(e){return e.event=this.event,this.copyMember(e,this,["eventObj","target","currentTarget","isStopPropagation","phase","lastX","lastY"])},PointEvent}(e.DomEvent);e.PointEvent=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function TouchPointEvent(){e.apply(this,arguments),this.button=null}return __extends(TouchPointEvent,e),TouchPointEvent.create=function(e){var t=new this(null,e);return t},Object.defineProperty(TouchPointEvent.prototype,"location",{get:function(){return this.eventObj.location},set:function(e){this.eventObj.location=e},enumerable:!0,configurable:!0}),Object.defineProperty(TouchPointEvent.prototype,"locationInView",{get:function(){return this.eventObj.locationInView},set:function(e){this.eventObj.locationInView=e},enumerable:!0,configurable:!0}),Object.defineProperty(TouchPointEvent.prototype,"wheel",{get:function(){return null},enumerable:!0,configurable:!0}),Object.defineProperty(TouchPointEvent.prototype,"movementDelta",{get:function(){return this.eventObj.movementDelta},enumerable:!0,configurable:!0}),TouchPointEvent.prototype.getDataFromEventObj=function(e){var t=e.touchData;this.eventObj=e,this.event={clientX:t.clientX,clientY:t.clientY,pageX:t.pageX,pageY:t.pageY,target:t.target,currentTarget:e.currentTarget}},TouchPointEvent.prototype.clone=function(){return this.cloneHelper(TouchPointEvent.create(this.name))},TouchPointEvent}(e.PointEvent);e.TouchPointEvent=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function MousePointEvent(){e.apply(this,arguments)}return __extends(MousePointEvent,e),MousePointEvent.create=function(e){var t=new this(null,e);return t},Object.defineProperty(MousePointEvent.prototype,"location",{get:function(){return this.eventObj.location},set:function(e){this.eventObj.location=e},enumerable:!0,configurable:!0}),Object.defineProperty(MousePointEvent.prototype,"locationInView",{get:function(){return this.eventObj.locationInView},set:function(e){this.eventObj.locationInView=e},enumerable:!0,configurable:!0}),Object.defineProperty(MousePointEvent.prototype,"button",{get:function(){return this.eventObj.button},set:function(e){this.eventObj.button=e},enumerable:!0,configurable:!0}),Object.defineProperty(MousePointEvent.prototype,"wheel",{get:function(){return this.eventObj.wheel},enumerable:!0,configurable:!0}),Object.defineProperty(MousePointEvent.prototype,"movementDelta",{get:function(){return this.eventObj.movementDelta},enumerable:!0,configurable:!0}),MousePointEvent.prototype.getDataFromEventObj=function(e){this.eventObj=e,this.event=e.event},MousePointEvent.prototype.clone=function(){return this.cloneHelper(MousePointEvent.create(this.name))},MousePointEvent}(e.PointEvent);e.MousePointEvent=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function MouseEvent(){t.apply(this,arguments),this._location=null,this._locationInView=null,this._button=null,
this.type=e.EEventType.MOUSE,this.lastX=null,this.lastY=null}return __extends(MouseEvent,t),MouseEvent.create=function(e,t){var r=new this(e,t);return r},Object.defineProperty(MouseEvent.prototype,"location",{get:function(){var t=null,r=this.event;return this._location?this._location:(t=e.Point.create(),bowser.msie?(t.x=r.clientX+document.body.scrollLeft||document.documentElement.scrollLeft,t.y=r.clientY+document.body.scrollTop||document.documentElement.scrollTop):(t.x=r.pageX,t.y=r.pageY),t)},set:function(e){this._location=e},enumerable:!0,configurable:!0}),Object.defineProperty(MouseEvent.prototype,"locationInView",{get:function(){var t=null,r=null;return this._locationInView?this._locationInView:(t=this.location,r=e.DeviceManager.getInstance().view.offset,e.Point.create(t.x-r.x,t.y-r.y))},set:function(e){this._locationInView=e},enumerable:!0,configurable:!0}),Object.defineProperty(MouseEvent.prototype,"button",{get:function(){var t=this.event,r=null;if(bowser.mobile)return null;if(null!==this._button)return this._button;if(bowser.msie)switch(t.button){case 1:r=e.EMouseButton.LEFT;break;case 4:r=e.EMouseButton.RIGHT;break;case 2:r=e.EMouseButton.CENTER;break;default:e.Log.error(!0,e.Log.info.FUNC_NOT_SUPPORT("multi mouse button"))}else switch(t.button){case 0:r=e.EMouseButton.LEFT;break;case 1:r=e.EMouseButton.RIGHT;break;case 2:r=e.EMouseButton.CENTER;break;default:e.Log.error(!0,e.Log.info.FUNC_NOT_SUPPORT("multi mouse button"))}return r},set:function(e){this._button=e},enumerable:!0,configurable:!0}),Object.defineProperty(MouseEvent.prototype,"wheel",{get:function(){var e=this.event;return bowser.mobile?null:e.detail?-1*e.detail:e.wheelDelta?e.wheelDelta/120:0},enumerable:!0,configurable:!0}),Object.defineProperty(MouseEvent.prototype,"movementDelta",{get:function(){var e=this.event,t=null,r=null;if(this._isPointerLocked())t=e.movementX||e.webkitMovementX||e.mozMovementX||0,r=e.movementY||e.webkitMovementY||e.mozMovementY||0;else{var n=this.location,i=this.lastX,o=this.lastY;null===i&&null===o?(t=0,r=0):(t=n.x-i,r=n.y-o)}return{x:t,y:r}},enumerable:!0,configurable:!0}),MouseEvent.prototype.clone=function(){var e=MouseEvent.create(this.event,this.name);return this.copyMember(e,this,["target","currentTarget","isStopPropagation","phase","lastX","lastY"])},MouseEvent.prototype._isPointerLocked=function(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)},MouseEvent}(e.DomEvent);e.MouseEvent=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function TouchEvent(){t.apply(this,arguments),this._location=null,this._locationInView=null,this.type=e.EEventType.TOUCH,this.lastX=null,this.lastY=null}return __extends(TouchEvent,t),TouchEvent.create=function(e,t){var r=new this(e,t);return r},Object.defineProperty(TouchEvent.prototype,"location",{get:function(){var t=null;if(this._location)return this._location;var r=this.touchData;return t=e.Point.create(),t.x=r.pageX,t.y=r.pageY,t},set:function(e){this._location=e},enumerable:!0,configurable:!0}),Object.defineProperty(TouchEvent.prototype,"touchData",{get:function(){var e=this.event.changedTouches;return e[0]},enumerable:!0,configurable:!0}),Object.defineProperty(TouchEvent.prototype,"locationInView",{get:function(){var t=null,r=null;return this._locationInView?this._locationInView:(t=this.location,r=e.DeviceManager.getInstance().view.offset,e.Point.create(t.x-r.x,t.y-r.y))},set:function(e){this._locationInView=e},enumerable:!0,configurable:!0}),Object.defineProperty(TouchEvent.prototype,"movementDelta",{get:function(){var e=null,t=null,r=this.location,n=this.lastX,i=this.lastY;return null===n&&null===i?(e=0,t=0):(e=r.x-n,t=r.y-i),{x:e,y:t}},enumerable:!0,configurable:!0}),TouchEvent.prototype.clone=function(){var e=TouchEvent.create(this.event,this.name);return this.copyMember(e,this,["target","currentTarget","isStopPropagation","phase","lastX","lastY"])},__decorate([e.ensureGetter(function(t){e.it("should exist touch data",function(){e.expect(t).exist},this)})],TouchEvent.prototype,"touchData",null),TouchEvent}(e.DomEvent);e.TouchEvent=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CustomEvent(){for(var r=[],n=0;n<arguments.length;n++)r[n-0]=arguments[n];if(t.call(this,r[0]),this.type=e.EEventType.CUSTOM,this.userData=null,2===r.length){var i=r[1];this.userData=i}}return __extends(CustomEvent,t),CustomEvent.create=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=null;return r=1===e.length?new this(e[0]):new this(e[0],e[1])},CustomEvent.prototype.copyPublicAttri=function(t,r){return wdCb.ExtendUtils.extend(t,function(t,r){return"_"!==r.slice(0,1)&&!e.JudgeUtils.isFunction(t)}),t},CustomEvent.prototype.clone=function(){var e=CustomEvent.create(this.name);return this.copyMember(e,this,["target","currentTarget","isStopPropagation","phase"])},CustomEvent.prototype.getDataFromDomEvent=function(e){this.target=e.target,this.currentTarget=e.currentTarget,this.isStopPropagation=e.isStopPropagation},CustomEvent}(e.Event);e.CustomEvent=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT",e[e.CENTER=2]="CENTER"}(e.EMouseButton||(e.EMouseButton={}));e.EMouseButton}(wd||(wd={}));var wd;!function(e){var t=function(){function EventHandler(){}return EventHandler}();e.EventHandler=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DomEventHandler(){t.apply(this,arguments)}return __extends(DomEventHandler,t),DomEventHandler.prototype.off=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=this,i=null,o=null,a=e.DomEventRegister.getInstance(),s=null;if(1===t.length)i=t[0],o=this.getDefaultDom(),s=a.remove(i);else if(2===t.length&&e.JudgeUtils.isDom(t[0]))o=t[0],i=t[1],s=a.remove(o,i);else if(2===t.length){var c=t[1];i=t[0],o=this.getDefaultDom(),s=a.remove(i,c)}else{var c=t[2];o=t[0],i=t[1],s=a.remove(o,i,c)}s&&!a.isBinded(o,i)&&s.forEach(function(e){n._unBind(e.dom,e.eventName,e.domHandler)})},DomEventHandler.prototype.trigger=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=null,o=null,a=null;1===t.length?(i=t[0],n=this.getDefaultDom()):(n=t[0],i=t[1]),o=i.name,a=e.DomEventRegister.getInstance().getEventRegisterDataList(n,o),null!==a&&0!==a.getCount()&&a.forEach(function(e){var t=i.clone();e.handler(t,e.eventData)})},DomEventHandler.prototype.clearHandler=function(){},DomEventHandler.prototype.buildDomHandler=function(t,r){var n=this,i=e.root;return wdCb.EventUtils.bindEvent(i,function(e){n.triggerDomEvent(t,e,r)})},DomEventHandler.prototype.handler=function(t,r,n,i){var o=null,a=n;n=this.addEngineHandler(r,n),o=e.DomEventRegister.getInstance().isBinded(t,r)?e.DomEventRegister.getInstance().getDomHandler(t,r):this._bind(t,r),e.DomEventRegister.getInstance().register(t,r,this.createEventData(),n,a,o,i)},DomEventHandler.prototype._bind=function(t,r){var n=null;return n=this.buildDomHandler(t,r),wdCb.EventUtils.addEvent(t,e.EventNameHandler.handleEventName(r),n),n},DomEventHandler.prototype._unBind=function(t,r,n){wdCb.EventUtils.removeEvent(t,e.EventNameHandler.handleEventName(r),n)},__decorate([e.virtual],DomEventHandler.prototype,"clearHandler",null),DomEventHandler}(e.EventHandler);e.DomEventHandler=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function PointEventHandler(){t.apply(this,arguments)}return __extends(PointEventHandler,t),PointEventHandler.prototype.on=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=null,n=null,i=null,o=null;3===e.length?(r=this.getDefaultDom(),n=e[0],i=e[1],o=e[2]):(r=e[0],n=e[1],i=e[2],o=e[3]),this.handler(r,n,i,o)},PointEventHandler.prototype.getDefaultDom=function(){return document.body},PointEventHandler.prototype.triggerDomEvent=function(t,r,n){var i=this.createEventObject(t,r,n);e.EventManager.trigger(t,i)},PointEventHandler.prototype.createEventData=function(){var e=wdCb.Hash.create();return e.addChild("lastX",null),e.addChild("lastY",null),e},PointEventHandler.prototype.handleMove=function(e){var t=this;return function(r,n){t._copyEventDataToEventObject(r,n),e(r),t._saveLocation(r,n)}},PointEventHandler.prototype._copyEventDataToEventObject=function(e,t){e.lastX=t.getChild("lastX"),e.lastY=t.getChild("lastY")},PointEventHandler.prototype._saveLocation=function(e,t){var r=e.location;t.setValue("lastX",r.x),t.setValue("lastY",r.y)},__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(4===t.length){var n=t[0];e.it("first param should be HTMLElement",function(){e.expect(e.JudgeUtils.isDom(n))["true"]})}})],PointEventHandler.prototype,"on",null),PointEventHandler}(e.DomEventHandler);e.PointEventHandler=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function MouseEventHandler(){t.call(this)}return __extends(MouseEventHandler,t),MouseEventHandler.getInstance=function(){},MouseEventHandler.prototype.addEngineHandler=function(t,r){var n=null;switch(t){case e.EEventName.MOUSEMOVE:n=this.handleMove(r);break;default:n=r}return n},MouseEventHandler.prototype.createEventObject=function(t,r,n){var i=e.MouseEvent.create(r?r:e.root.event,n);return i.target=t,i},MouseEventHandler=__decorate([e.singleton()],MouseEventHandler)}(e.PointEventHandler);e.MouseEventHandler=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function TouchEventHandler(){t.call(this)}return __extends(TouchEventHandler,t),TouchEventHandler.getInstance=function(){},TouchEventHandler.prototype.addEngineHandler=function(t,r){var n=null;switch(t){case e.EEventName.TOUCHMOVE:n=this.handleMove(r);break;default:n=r}return n},TouchEventHandler.prototype.createEventObject=function(t,r,n){var i=e.TouchEvent.create(r?r:e.root.event,n);return i.target=t,i},TouchEventHandler=__decorate([e.singleton()],TouchEventHandler)}(e.PointEventHandler);e.TouchEventHandler=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function KeyboardEventHandler(){t.call(this)}return __extends(KeyboardEventHandler,t),KeyboardEventHandler.getInstance=function(){},KeyboardEventHandler.prototype.on=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=null,o=null;3===t.length?(n=t[0],i=t[1],o=t[2]):(e.Log.warn("keyboard event can only bind on document.body"),n=t[1],i=t[2],o=t[3]),this.handler(this.getDefaultDom(),n,i,o)},KeyboardEventHandler.prototype.triggerDomEvent=function(t,r,n){var i=this._createEventObject(t,r,n);e.EventManager.trigger(t,i)},KeyboardEventHandler.prototype.getDefaultDom=function(){return document.body},KeyboardEventHandler.prototype.addEngineHandler=function(t,r){var n=null;switch(t){case e.EEventName.KEYDOWN:n=this._handleKeyDown(r);break;case e.EEventName.KEYUP:n=this._handleKeyUp(r);break;default:n=r}return n},KeyboardEventHandler.prototype.createEventData=function(){var e=wdCb.Hash.create();return e.addChild("keyState",{}),e},KeyboardEventHandler.prototype._handleKeyDown=function(e){var t=this;return function(r,n){var i=n.getChild("keyState");t._setKeyStateAllFalse(i),i[r.key]=!0,t._copyEventDataToEventObject(r,n),e(r)}},KeyboardEventHandler.prototype._handleKeyUp=function(e){var t=this;return function(r,n){t._setKeyStateAllFalse(n.getChild("keyState")),t._copyEventDataToEventObject(r,n),e(r)}},KeyboardEventHandler.prototype._copyEventDataToEventObject=function(e,t){e.keyState=t.getChild("keyState")},KeyboardEventHandler.prototype._setKeyStateAllFalse=function(e){for(var t in e)e.hasOwnProperty(t)&&(e[t]=!1)},KeyboardEventHandler.prototype._createEventObject=function(t,r,n){var i=e.KeyboardEvent.create(r?r:e.root.event,n);return i.target=t,i},KeyboardEventHandler=__decorate([e.singleton()],KeyboardEventHandler)}(e.DomEventHandler);e.KeyboardEventHandler=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CustomEventHandler(){t.call(this)}return __extends(CustomEventHandler,t),CustomEventHandler.getInstance=function(){},CustomEventHandler.prototype.on=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(3===t.length){var n=t[0],i=t[1],o=i,a=t[2];e.CustomEventRegister.getInstance().register(n,i,o,null,a)}else if(4===t.length){var s=t[0],n=t[1],i=t[2],o=i,a=t[3];e.CustomEventRegister.getInstance().register(s,n,i,o,null,a)}},CustomEventHandler.prototype.off=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=e.CustomEventRegister.getInstance();n.remove.apply(n,t)},CustomEventHandler.prototype.trigger=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=null;if(1===e.length||2===e.length){var n=null;return 1===e.length?r=e[0]:(r=e[0],n=e[1]),this._triggerEventHandler(r,n)}if(3===e.length||4===e.length){var i=null,n=null,o=null;return 3===e.length?(i=e[0],r=e[1],o=e[2]):(i=e[0],r=e[1],n=e[2],o=e[3]),this._triggerTargetAndEventHandler(i,r,n,o)}},CustomEventHandler.prototype._triggerEventHandler=function(t,r){var n=null,i=this;return n=e.CustomEventRegister.getInstance().getEventRegisterDataList(t.name),null!==n&&0!==n.getCount()&&(n.forEach(function(e){t.currentTarget=e.target,t.target=e.target,i._setUserData(t,r),e.handler(t)}),!0)},CustomEventHandler.prototype._triggerTargetAndEventHandler=function(t,r,n,i){var o=null,a=!1,s=this;return i||(r.target=t),o=e.CustomEventRegister.getInstance().getEventRegisterDataList(t,r.name),null!==o&&0!==o.getCount()&&(o.forEach(function(e){r.currentTarget=e.target,s._setUserData(r,n),e.handler(r),r.isStopPropagation&&(a=!0)}),a)},CustomEventHandler.prototype._setUserData=function(e,t){t&&(e.userData=t)},CustomEventHandler=__decorate([e.singleton()],CustomEventHandler)}(e.EventHandler);e.CustomEventHandler=t}(wd||(wd={}));var wd;!function(e){var t=function(){function EventDispatcher(){}return EventDispatcher}();e.EventDispatcher=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CustomEventDispatcher(){t.call(this)}return __extends(CustomEventDispatcher,t),CustomEventDispatcher.getInstance=function(){},CustomEventDispatcher.prototype.trigger=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=t.length;if(1===n){var i=t[0],o=i.type;return e.EventHandlerFactory.createEventHandler(o).trigger(i)}if(2===n&&e.EventUtils.isEvent(t[0])){var a=t[0],s=t[1],o=a.type;return e.EventHandlerFactory.createEventHandler(o).trigger(a,s)}if(2===n&&e.EventUtils.isEntityObject(t[0])||3===n&&e.JudgeUtils.isBoolean(t[2])){var c=t[0],u=t[1],l=void 0!==t[2]&&t[2],o=u.type;return e.EventHandlerFactory.createEventHandler(o).trigger(c,u,l)}if(3===n||4===n){var c=t[0],h=t[1],s=t[2],l=void 0!==t[3]&&t[3],o=h.type;return e.EventHandlerFactory.createEventHandler(o).trigger(c,h,s,l)}},CustomEventDispatcher.prototype.emit=function(t,r,n){var i=!1;if(t){r.phase=e.EEventPhase.EMIT,r.target=t;do{if(i=this._triggerWithUserData(t,r,n,!0))break;t=t.bubbleParent}while(t)}},CustomEventDispatcher.prototype.broadcast=function(t,r,n){var i=this,o=function(e){var t=e.getChildren();0!==t.getCount()&&t.forEach(function(e){i._triggerWithUserData(e,r,n,!0),o(e)})};t&&(r.phase=e.EEventPhase.BROADCAST,r.target=t,this._triggerWithUserData(t,r,n,!0),o(t))},CustomEventDispatcher.prototype._triggerWithUserData=function(e,t,r,n){return r?this.trigger(e,t,r,n):this.trigger(e,t,n)},CustomEventDispatcher=__decorate([e.singleton()],CustomEventDispatcher)}(e.EventDispatcher);e.CustomEventDispatcher=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DomEventDispatcher(){t.call(this)}return __extends(DomEventDispatcher,t),DomEventDispatcher.getInstance=function(){},DomEventDispatcher.prototype.trigger=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(1===t.length){var n=t[0],i=n.type;e.EventHandlerFactory.createEventHandler(i).trigger(n)}else if(2===t.length){var o=t[0],a=t[1],i=a.type;e.EventHandlerFactory.createEventHandler(i).trigger(o,a)}},DomEventDispatcher=__decorate([e.singleton()],DomEventDispatcher)}(e.EventDispatcher);e.DomEventDispatcher=t}(wd||(wd={}));var wd;!function(e){var t=function(){function EventRegister(){}return EventRegister.prototype.getEventRegisterDataList=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=this.listenerMap.getChild.apply(this.listenerMap,e);return r?r.sort(function(e,t){return t.priority-e.priority},!0):null},EventRegister.prototype.forEachAll=function(e){return this.listenerMap.forEachAll(e)},EventRegister.prototype.forEachEventName=function(e){this.listenerMap.forEachEventName(e)},EventRegister.prototype.clear=function(){return this.listenerMap.clear()},EventRegister.prototype.getChild=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return this.listenerMap.getChild.apply(this.listenerMap,Array.prototype.slice.call(arguments,0))},EventRegister}();e.EventRegister=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CustomEventRegister(){t.call(this),this.listenerMap=e.CustomEventListenerMap.create()}return __extends(CustomEventRegister,t),CustomEventRegister.getInstance=function(){},CustomEventRegister.prototype.register=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];if(5===e.length){var r=e[0],n=e[1],i=e[2],o=e[3],a=e[4];this.listenerMap.appendChild(r,{target:null,eventName:r,handler:n,originHandler:i,domHandler:o,priority:a})}else{var s=e[0],r=e[1],n=e[2],i=e[3],o=e[4],a=e[5];this.listenerMap.appendChild(s,r,{target:s,eventName:r,handler:n,originHandler:i,domHandler:o,priority:a})}},CustomEventRegister.prototype.remove=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=t[0];if(1===t.length&&e.JudgeUtils.isString(t[0])){var i=t[0];this.listenerMap.removeChild(i)}else if(1===t.length&&t[0]instanceof e.EntityObject)this.listenerMap.removeChild(n),this._handleAfterAllEventHandlerRemoved(n);else if(2===t.length&&e.JudgeUtils.isFunction(t[1])){var i=t[0],o=t[1];this.listenerMap.removeChild(i,o)}else if(2===t.length&&e.JudgeUtils.isNumber(t[0])){var a=t[0],i=t[1];this.listenerMap.removeChild(a,i)}else(2===t.length&&t[0]instanceof e.EntityObject||3===t.length)&&(this.listenerMap.removeChild.apply(this.listenerMap,t),this._isAllEventHandlerRemoved(n)&&this._handleAfterAllEventHandlerRemoved(n))},CustomEventRegister.prototype.setBubbleParent=function(e,t){e.bubbleParent=t},CustomEventRegister.prototype._isAllEventHandlerRemoved=function(e){return!this.listenerMap.hasChild(e)},CustomEventRegister.prototype._handleAfterAllEventHandlerRemoved=function(e){this.setBubbleParent(e,null)},CustomEventRegister=__decorate([e.singleton()],CustomEventRegister)}(e.EventRegister);e.CustomEventRegister=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DomEventRegister(){t.call(this),this.listenerMap=e.DomEventListenerMap.create()}return __extends(DomEventRegister,t),DomEventRegister.getInstance=function(){},DomEventRegister.prototype.register=function(e,t,r,n,i,o,a){this.listenerMap.appendChild(e,t,{dom:e,eventName:t,eventData:r,handler:n,originHandler:i,domHandler:o,priority:a})},DomEventRegister.prototype.remove=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null;if(1===t.length&&e.JudgeUtils.isString(t[0])){var i=t[0];n=this.listenerMap.removeChild(i)}else if(2===t.length&&e.JudgeUtils.isFunction(t[1])){var i=t[0],o=t[1];n=this.listenerMap.removeChild(i,o)}else(2===t.length&&e.JudgeUtils.isDom(t[0])||3===t.length)&&(n=this.listenerMap.removeChild.apply(this.listenerMap,t));return n},DomEventRegister.prototype.isBinded=function(e,t){return this.listenerMap.hasChild(e,t)},DomEventRegister.prototype.getDomHandler=function(e,t){var r=this.getChild(e,t);if(r&&r.getCount()>0)return r.getChild(0).domHandler},DomEventRegister=__decorate([e.singleton()],DomEventRegister)}(e.EventRegister);e.DomEventRegister=t}(wd||(wd={}));var wd;!function(e){var t=function(){function EventBinder(){}return EventBinder}();e.EventBinder=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CustomEventBinder(){t.call(this)}return __extends(CustomEventBinder,t),CustomEventBinder.getInstance=function(){},CustomEventBinder.prototype.on=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(2===t.length){var n=t[0],i=t[1];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(n)).on(n,i)}else if(3===t.length&&e.JudgeUtils.isString(t[0])){var n=t[0],i=t[1],o=t[2];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(n)).on(n,i,o)}else if(3===t.length&&t[0]instanceof e.EntityObject){var a=t[0],n=t[1],i=t[2];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(n)).on(a,n,i)}else if(4===t.length){var a=t[0],n=t[1],i=t[2],o=t[3];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(n)).on(a,n,i,o)}},CustomEventBinder.prototype.off=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=e.CustomEventRegister.getInstance();if(0===t.length)n.forEachAll(function(t,r){e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(r)).off(r)}),n.clear();else if(1===t.length&&e.JudgeUtils.isString(t[0])){var i=t[0];n.forEachEventName(function(t,r){r===i&&e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(i)).off(i)})}else if(1===t.length&&t[0]instanceof e.EntityObject){var o=t[0],a=null;a=n.getChild(o),a&&a.forEach(function(t,r){e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(r)).off(o,r)})}else if(2===t.length&&e.JudgeUtils.isString(t[0])){var s=t[0],c=t[1];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(s)).off(s,c)}else if(2===t.length&&t[0]instanceof e.EntityObject){var u=t[0],s=t[1];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(s)).off(u,s)}else if(3===t.length&&t[0]instanceof e.EntityObject){var u=t[0],s=t[1],c=t[2];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(s)).off(u,s,c)}},CustomEventBinder=__decorate([e.singleton()],CustomEventBinder)}(e.EventBinder);e.CustomEventBinder=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DomEventBinder(){t.call(this)}return __extends(DomEventBinder,t),DomEventBinder.getInstance=function(){},DomEventBinder.prototype.on=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(2===t.length&&e.JudgeUtils.isString(t[0])){var n=t[0],i=t[1];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(n)).on(n,i)}else if(3===t.length&&e.JudgeUtils.isString(t[0])){var n=t[0],i=t[1],o=t[2];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(n)).on(n,i,o)}else if(3===t.length&&e.JudgeUtils.isDom(t[0])){var a=t[0],n=t[1],i=t[2];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(n)).on(a,n,i)}else if(4===t.length){var a=t[0],n=t[1],i=t[2],o=t[3];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(n)).on(a,n,i,o)}},DomEventBinder.prototype.off=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=e.DomEventRegister.getInstance();if(0===t.length)n.forEachAll(function(t,r){e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(r)).off(r)}),n.clear();else if(1===t.length&&e.JudgeUtils.isString(t[0])){var i=t[0];n.forEachEventName(function(t,r){r===i&&e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(i)).off(i)})}else if(1===t.length&&e.JudgeUtils.isDom(t[0])){var o=t[0],a=null;a=n.getChild(o),a&&a.forEach(function(t,r){e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(r)).off(o,r)})}else if(2===t.length&&e.JudgeUtils.isString(t[0])){var s=t[0],c=t[1];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(s)).off(s,c)}else if(2===t.length&&e.JudgeUtils.isDom(t[0])){var u=t[0],s=t[1];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(s)).off(u,s)}else if(3===t.length){var u=t[0],s=t[1],c=t[2];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(s)).off(u,s,c)}},DomEventBinder=__decorate([e.singleton()],DomEventBinder)}(e.EventBinder);e.DomEventBinder=t}(wd||(wd={}));var wd;!function(e){var t=function(){function EventHandlerFactory(){}return EventHandlerFactory.createEventHandler=function(t){var r=null;switch(t){case e.EEventType.MOUSE:r=e.MouseEventHandler.getInstance();break;case e.EEventType.TOUCH:r=e.TouchEventHandler.getInstance();break;case e.EEventType.KEYBOARD:r=e.KeyboardEventHandler.getInstance();break;case e.EEventType.CUSTOM:case e.EEventType.POINT:r=e.CustomEventHandler.getInstance();break;default:e.Log.error(!0,e.Log.info.FUNC_INVALID("eventType"))}return r},EventHandlerFactory}();e.EventHandlerFactory=t}(wd||(wd={}));var wd;!function(e){var t=function(){function EventBinderFactory(){}return EventBinderFactory.createEventBinder=function(t){var r=null,n=e.EventTable.getEventType(t);switch(n){case e.EEventType.MOUSE:case e.EEventType.TOUCH:case e.EEventType.KEYBOARD:r=e.DomEventBinder.getInstance();break;case e.EEventType.CUSTOM:case e.EEventType.POINT:r=e.CustomEventBinder.getInstance();break;default:e.Log.error(!0,e.Log.info.FUNC_INVALID("eventName:"+t))}return r},EventBinderFactory}();e.EventBinderFactory=t}(wd||(wd={}));var wd;!function(e){var t=function(){function EventDispatcherFactory(){}return EventDispatcherFactory.createEventDispatcher=function(t){var r=null,n=t.type;switch(n){case e.EEventType.MOUSE:case e.EEventType.TOUCH:case e.EEventType.KEYBOARD:r=e.DomEventDispatcher.getInstance();break;case e.EEventType.CUSTOM:case e.EEventType.POINT:r=e.CustomEventDispatcher.getInstance();break;default:e.Log.error(!0,e.Log.info.FUNC_INVALID("event:"+t))}return r},EventDispatcherFactory}();e.EventDispatcherFactory=t}(wd||(wd={}));var wd;!function(e){var t=function(){function EventUtils(){}return EventUtils.isEvent=function(e){return e&&void 0!==e.currentTarget},EventUtils.isEntityObject=function(e){return e&&void 0!==e.bubbleParent},__decorate([e.ensure(function(t,r){t&&e.assert(r instanceof e.EntityObject,e.Log.info.FUNC_MUST_BE("EntityObject, but actual is "+r))})],EventUtils,"isEntityObject",null),EventUtils}();e.EventUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ScriptEngine(){this._scriptList=wdCb.Collection.create()}return ScriptEngine.getInstance=function(){},ScriptEngine.prototype.addChild=function(e,t,r){e.scriptManager.addChild(t,r),this._scriptList.addChild(r)},ScriptEngine.prototype.removeChild=function(e,t){e.scriptManager.removeChild(t),this._scriptList.removeChild(t)},ScriptEngine.prototype.removeAllChildren=function(){this._scriptList.removeAllChildren()},ScriptEngine.prototype.findScript=function(e,t){return e.scriptManager.getChild(t)},ScriptEngine.prototype.execEntityObjectScript=function(e,t){e.scriptManager.execScript(t)},ScriptEngine.prototype.execEntityObjectScriptOnlyOnce=function(e,t){e.scriptManager.execScriptOnlyOnce(t)},ScriptEngine.prototype.execEntityObjectScriptWithData=function(e,t,r){e.scriptManager.execScriptWithData(t,r)},ScriptEngine.prototype.execScript=function(e){this._scriptList.forEach(function(t){t[e]&&t[e]()})},ScriptEngine.prototype.execScriptWithData=function(e,t){this._scriptList.forEach(function(r){r[e]&&r[e](t)})},ScriptEngine.prototype.execEntityObjectEventScriptWithData=function(e,t,r){e.scriptManager.execEventScriptWithData(t,r)},ScriptEngine=__decorate([e.singleton()],ScriptEngine)}();e.ScriptEngine=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CollisionEngine(){t.call(this),this._collisionDetector=e.CollisionDetector.create()}return __extends(CollisionEngine,t),CollisionEngine.getInstance=function(){},CollisionEngine.prototype.update=function(e){this.list.forEach(function(t){t.update(e)})},CollisionEngine.prototype.detect=function(e){this._collisionDetector.update(e)},CollisionEngine=__decorate([e.singleton()],CollisionEngine)}(e.ComponentContainer);e.CollisionEngine=t}(wd||(wd={}));var wd;!function(e){var t=function(){function BoneMatrix(e){this._localMatrix=null,this._globalMatrix=null,this._parent=null,this.dirtyLocal=!0,this.dirtyGlobal=null,this._children=wdCb.Collection.create(),this._localMatrix=e}return BoneMatrix.create=function(e){var t=new this(e);return t},Object.defineProperty(BoneMatrix.prototype,"localMatrix",{get:function(){return this._localMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(BoneMatrix.prototype,"globalMatrix",{get:function(){return this.dirtyLocal&&(this.dirtyLocal=!1,this.dirtyGlobal=!0),this.dirtyGlobal&&(null===this.parent?this._globalMatrix=this._localMatrix:this._globalMatrix=this._localMatrix.applyMatrix(this.parent.globalMatrix,!0),this.dirtyGlobal=!1,this._children.forEach(function(e){e.dirtyGlobal=!0})),this._globalMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(BoneMatrix.prototype,"parent",{get:function(){return this._parent},set:function(e){return null!==this._parent&&this._parent.removeChild(this),e?(this._parent=e,void this._parent.addChild(this)):void(this._parent=null)},enumerable:!0,configurable:!0}),BoneMatrix.prototype.clone=function(){return e.CloneUtils.clone(this)},BoneMatrix.prototype.updateLocalMatrix=function(e){this._localMatrix=e,this.dirtyLocal=!0},BoneMatrix.prototype.removeChild=function(e){this._children.removeChild(e)},BoneMatrix.prototype.addChild=function(e){this._children.addChild(e)},__decorate([e.cloneAttributeAsCloneable()],BoneMatrix.prototype,"_localMatrix",void 0),__decorate([e.cloneAttributeAsBasicType()],BoneMatrix.prototype,"parent",null),BoneMatrix}();e.BoneMatrix=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ComponentInitOrderTable(){}return ComponentInitOrderTable.getOrder=function(t){return t instanceof e.SourceInstance?1:e.JudgeUtils.isClass(t,"Shadow")?2:e.JudgeUtils.isClass(t,"ThreeDBitmapFont")?3:t instanceof e.Geometry?4:5},ComponentInitOrderTable}();e.ComponentInitOrderTable=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function Instance(){t.apply(this,arguments)}return __extends(Instance,t),Instance.prototype.addToObject=function(e,r){void 0===r&&(r=!1),t.prototype.addToObject.call(this,e,r)},Instance.prototype.clone=function(){return e.CloneUtils.clone(this)},__decorate([e.require(function(t){e.assert(t instanceof e.GameObject,e.Log.info.FUNC_SHOULD("Instance component","add to GameObject"))})],Instance.prototype,"addToObject",null),Instance}(e.Component);e.Instance=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function SourceInstance(){t.apply(this,arguments),this._instanceBuffer=null}return __extends(SourceInstance,t),Object.defineProperty(SourceInstance.prototype,"instanceBuffer",{get:function(){return null===this._instanceBuffer&&(this._instanceBuffer=e.InstanceBuffer.create()),this._instanceBuffer},enumerable:!0,configurable:!0}),SourceInstance}(e.Instance);e.SourceInstance=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function OneToOneSourceInstance(){t.apply(this,arguments),this.instanceList=wdCb.Collection.create(),this._toRenderInstanceList=wdCb.Collection.create(),this._endLoopSubscription=null,this._isAddSourceInstanceToChildren=!1,this._enterSubscription=null,this._exitSubscription=null}return __extends(OneToOneSourceInstance,t),OneToOneSourceInstance.create=function(){var e=new this;return e},Object.defineProperty(OneToOneSourceInstance.prototype,"toRenderInstanceListForDraw",{get:function(){return this.hasToRenderInstance()||(this._toRenderInstanceList=this.defaultToRenderInstanceList),this._toRenderInstanceList},enumerable:!0,configurable:!0}),Object.defineProperty(OneToOneSourceInstance.prototype,"defaultToRenderInstanceList",{get:function(){return wdCb.Collection.create().addChild(this.entityObject).addChildren(this.instanceList)},enumerable:!0,configurable:!0}),OneToOneSourceInstance.prototype.init=function(){var t=this;this._isAddSourceInstanceToChildren||this._addSourceInstanceToChildren(),this._endLoopSubscription=e.EventManager.fromEvent(e.EEngineEvent.ENDLOOP).subscribe(function(){t._toRenderInstanceList.removeAllChildren()}),this._enterSubscription=e.EventManager.fromEvent(this.entityObject,e.EEngineEvent.ENTER).subscribe(function(){t._addAllInstances()}),this._exitSubscription=e.EventManager.fromEvent(this.entityObject,e.EEngineEvent.EXIT).subscribe(function(){
t._removeAllInstances()})},OneToOneSourceInstance.prototype.dispose=function(){this._endLoopSubscription.dispose(),this._enterSubscription.dispose(),this._exitSubscription.dispose(),this.instanceList.forEach(function(e){e.dispose()})},OneToOneSourceInstance.prototype.cloneInstance=function(t){var r=this,n=this,i=function(t,o){var a=e.GameObject.create(),s=e.ObjectInstance.create(),c=null;return c=o.getComponent(OneToOneSourceInstance).instanceList,a.name=t,r._addComponentsFromSourceToObject(o,a),s.sourceObject=o,a.addComponent(s),a.bubbleParent=o.bubbleParent,a.parent=o.parent,a.isVisible=o.isVisible,o.getTagList().forEach(function(e){a.addTag(e)}),c.addChild(a),o.forEach(function(e){a.addChild(i(n._buildInstanceChildName(t,e.name),e))}),a};return this._addSourceInstanceToChildren(),this._isAddSourceInstanceToChildren=!0,i(t,this.entityObject)},OneToOneSourceInstance.prototype.hasToRenderInstance=function(){return this._toRenderInstanceList&&this._toRenderInstanceList.getCount()>0},OneToOneSourceInstance.prototype.addToRenderIntance=function(e){this._toRenderInstanceList.addChild(e)},OneToOneSourceInstance.prototype.forEachToRenderInstanceList=function(e){this._toRenderInstanceList.forEach(e)},OneToOneSourceInstance.prototype._addComponentsFromSourceToObject=function(t,r){r.removeComponent(e.Transform),t.forEachComponent(function(t){t instanceof OneToOneSourceInstance||e.JudgeUtils.isClass(t,"GeometryLOD")||(t instanceof e.Geometry||t instanceof e.Script?r.addComponent(t,!0):r.addComponent(t.clone()))})},OneToOneSourceInstance.prototype._addSourceInstanceToChildren=function(){var t=function(r){if(!e.InstanceUtils.isOneToOneSourceInstance(r)){var n=OneToOneSourceInstance.create();r.addComponent(n),r.forEach(function(e){t(e)})}};this.entityObject.forEach(function(e){t(e)})},OneToOneSourceInstance.prototype._addAllInstances=function(){var t=this.entityObject.parent,r=e.EInstanceTag.isAddSourceInstance;this.instanceList.forEach(function(e){e.addTag(r),t.addChild(e),e.removeTag(r)})},OneToOneSourceInstance.prototype._removeAllInstances=function(){var t=e.EInstanceTag.isRemoveSourceInstance;this.instanceList.forEach(function(e){e.addTag(t),e.parent.removeChild(e),e.removeTag(t)})},OneToOneSourceInstance.prototype._buildInstanceChildName=function(e,t){return e+"_"+t},__decorate([e.ensureGetter(function(t){var r=this;e.it("should not be empty",function(){e.expect(t.getCount()).greaterThan(0)}),e.it("should render self entityObject or the entityObject in instanceList",function(){t.forEach(function(t){e.expect(e.JudgeUtils.isEqual(t,r.entityObject)||r.instanceList.hasChild(t))["true"]})},this),e.it("shouldn't has repeat instance which is to render",function(){e.expect(t.hasRepeatItems())["false"]})})],OneToOneSourceInstance.prototype,"toRenderInstanceListForDraw",null),__decorate([e.cloneAttributeAsCloneable()],OneToOneSourceInstance.prototype,"instanceList",void 0),__decorate([e.ensure(function(){var t=this;e.it("children should contain OneToOneSourceInstance component",function(){t.entityObject.forEach(function(t){e.IterateUtils.forEachAll(t,function(t){e.expect(e.InstanceUtils.isOneToOneSourceInstance(t))["true"]})})},this)})],OneToOneSourceInstance.prototype,"init",null),__decorate([e.require(function(){var t=this;e.it("instance is not only in instanceList but also in loop",function(){var r=null,n=null,i=!0;0!==t.instanceList.getCount()&&(r=e.Director.getInstance().scene,n=wdCb.Collection.create(),e.IterateUtils.forEachAll(r.gameObjectScene,function(e){n.addChild(e)}),t.instanceList.forEach(function(e){if(!n.hasChild(e))return i=!1,wdCb.$BREAK}),e.expect(i)["true"])},this)})],OneToOneSourceInstance.prototype,"dispose",null),__decorate([e.require(function(){var t=this.entityObject;e.it("space partition not support instance",function(){e.expect(e.ClassUtils.hasComponent(t,"SpacePartition"))["false"]})}),e.ensure(function(t){e.it("should be object instance",function(){e.expect(e.InstanceUtils.isObjectInstance(t))["true"]})})],OneToOneSourceInstance.prototype,"cloneInstance",null),__decorate([e.ensure(function(t,r,n){e.it("instance should contain ThreeDTransform component",function(){e.expect(n.hasComponent(e.ThreeDTransform))["true"]})})],OneToOneSourceInstance.prototype,"_addComponentsFromSourceToObject",null),__decorate([e.ensure(function(){var t=this;e.it("children should contain only one OneToOneSourceInstance component",function(){e.IterateUtils.forEachAll(t.entityObject,function(t){e.expect(t.getComponents().filter(function(e){return e instanceof OneToOneSourceInstance}).getCount()).equal(1)})})})],OneToOneSourceInstance.prototype,"_addSourceInstanceToChildren",null),__decorate([e.ensure(function(){var t=this;e.it("instance shouldn't add EInstanceTag.isAddSourceInstance tag here",function(){t.instanceList.forEach(function(t){e.expect(t.hasTag(e.EInstanceTag.isAddSourceInstance))["false"]})},this)})],OneToOneSourceInstance.prototype,"_addAllInstances",null),__decorate([e.ensure(function(){var t=this;e.it("instance shouldn't add EInstanceTag.isRemoveSourceInstance tag here",function(){t.instanceList.forEach(function(t){e.expect(t.hasTag(e.EInstanceTag.isRemoveSourceInstance))["false"]})},this)})],OneToOneSourceInstance.prototype,"_removeAllInstances",null),OneToOneSourceInstance}(e.SourceInstance);e.OneToOneSourceInstance=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function OneToManySourceInstance(){e.apply(this,arguments)}return __extends(OneToManySourceInstance,e),OneToManySourceInstance.create=function(){var e=new this;return e},OneToManySourceInstance}(e.SourceInstance);e.OneToManySourceInstance=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ObjectInstance(){t.apply(this,arguments),this.sourceObject=null,this._enterSubscription=null,this._exitSubscription=null}return __extends(ObjectInstance,t),ObjectInstance.create=function(){var e=new this;return e},ObjectInstance.prototype.init=function(){var t=this,r=this.entityObject;this._enterSubscription=e.EventManager.fromEvent(r,e.EEngineEvent.ENTER).subscribe(function(){r.hasTag(e.EInstanceTag.isAddSourceInstance)||t._addToSourceAndItsChildren()}),this._exitSubscription=e.EventManager.fromEvent(r,e.EEngineEvent.EXIT).subscribe(function(){r.hasTag(e.EInstanceTag.isRemoveSourceInstance)||t._removeFromSourceAndItsChildren()})},ObjectInstance.prototype.dispose=function(){this._enterSubscription.dispose(),this._exitSubscription.dispose(),this._removeFromSourceAndItsChildren()},ObjectInstance.prototype._addToSourceAndItsChildren=function(){var t=function(r,n){r.getComponent(e.OneToOneSourceInstance).instanceList.addChild(n),n.forEach(function(e,n){t(r.getChild(n),e)})};t(this.sourceObject,this.entityObject)},ObjectInstance.prototype._removeFromSourceAndItsChildren=function(){var t=function(r,n){r.getComponent(e.OneToOneSourceInstance).instanceList.removeChild(n),n.forEach(function(e,n){t(r.getChild(n),e)})};t(this.sourceObject,this.entityObject)},__decorate([e.cloneAttributeAsBasicType()],ObjectInstance.prototype,"sourceObject",void 0),ObjectInstance}(e.Instance);e.ObjectInstance=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.isRemoveSourceInstance="isRemoveSourceInstance"]="isRemoveSourceInstance",e[e.isAddSourceInstance="isAddSourceInstance"]="isAddSourceInstance"}(e.EInstanceTag||(e.EInstanceTag={}));e.EInstanceTag}(wd||(wd={}));var wd;!function(e){var t=function(t){function EventTriggerDetector(){t.apply(this,arguments)}return __extends(EventTriggerDetector,t),EventTriggerDetector.prototype.clone=function(){return e.CloneUtils.clone(this)},EventTriggerDetector}(e.Component);e.EventTriggerDetector=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function RayCasterEventTriggerDetector(){t.apply(this,arguments)}return __extends(RayCasterEventTriggerDetector,t),RayCasterEventTriggerDetector.create=function(){var e=new this;return e},RayCasterEventTriggerDetector.prototype.isTrigger=function(t){var r=e.Director.getInstance().scene,n=r.currentCamera.getComponent(e.CameraController),i=t.locationInView;return n.isIntersectWithRay(this.entityObject,i.x,i.y)},RayCasterEventTriggerDetector}(e.EventTriggerDetector);e.RayCasterEventTriggerDetector=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function SceneEventTriggerDetector(){t.apply(this,arguments)}return __extends(SceneEventTriggerDetector,t),SceneEventTriggerDetector.create=function(){var e=new this;return e},SceneEventTriggerDetector.prototype.isTrigger=function(t){var r=e.DeviceManager.getInstance().view,n=r.width,i=r.height,o=t.locationInView,a=e.Vector2.create(0,0);return e.EventTriggerDetectorUtils.isInRect(o,a,n,i)},SceneEventTriggerDetector}(e.EventTriggerDetector);e.SceneEventTriggerDetector=t}(wd||(wd={}));var wd;!function(e){var t=function(){function EventTriggerDetectorUtils(){}return EventTriggerDetectorUtils.isInRect=function(e,t,r,n){return e.x>=t.x&&e.x<=t.x+r&&e.y>=t.y&&e.y<=t.y+n},EventTriggerDetectorUtils}();e.EventTriggerDetectorUtils=t}(wd||(wd={}));var wd;!function(e){var t=wdCb.Hash.create(),r=wdCb.Hash.create();t.addChild(e.EEngineEvent.POINT_TAP,"onPointTap"),t.addChild(e.EEngineEvent.POINT_OVER,"onPointOver"),t.addChild(e.EEngineEvent.POINT_OUT,"onPointOut"),t.addChild(e.EEngineEvent.POINT_MOVE,"onPointMove"),t.addChild(e.EEngineEvent.POINT_DOWN,"onPointDown"),t.addChild(e.EEngineEvent.POINT_UP,"onPointUp"),t.addChild(e.EEngineEvent.POINT_SCALE,"onPointScale"),t.addChild(e.EEngineEvent.POINT_DRAG,"onPointDrag"),r.addChild(e.EEngineEvent.POINT_TAP,"POINT_TAP"),r.addChild(e.EEngineEvent.POINT_DOWN,"POINT_DOWN"),r.addChild(e.EEngineEvent.POINT_UP,"POINT_UP"),r.addChild(e.EEngineEvent.POINT_MOVE,"POINT_MOVE"),r.addChild(e.EEngineEvent.POINT_OVER,"POINT_OVER"),r.addChild(e.EEngineEvent.POINT_OUT,"POINT_OUT"),r.addChild(e.EEngineEvent.POINT_SCALE,"POINT_SCALE"),r.addChild(e.EEngineEvent.POINT_DRAG,"POINT_DRAG");var n=function(){function EventTriggerTable(){}return EventTriggerTable.getScriptHandlerName=function(e){var r=t.getChild(e);return r},EventTriggerTable.getScriptEngineEvent=function(e){var t=r.getChild(e);return t},EventTriggerTable}();e.EventTriggerTable=n}(wd||(wd={}));var wd;!function(e){var t=function(t){function Script(e){void 0===e&&(e=null),t.call(this),this.id=null,this.id=e}return __extends(Script,t),Script.create=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];if(0===e.length)return new this;if(1===e.length){var r=e[0];return new this(r)}},Script.addScript=function(e,t){this.scriptList.push({name:e,"class":t})},Script.prototype.addToObject=function(r,n){void 0===n&&(n=!1),t.prototype.addToObject.call(this,r,n);var i=e.LoaderManager.getInstance().get(this.id);e.GlobalScriptUtils.addScriptToEntityObject(r,i)},Script.scriptList=wdCb.Stack.create(),__decorate([e.cloneAttributeAsBasicType()],Script.prototype,"id",void 0),__decorate([e.require(function(t,r){var n=this;void 0===r&&(r=!1),e.it("script should be loaded",function(){e.expect(e.LoaderManager.getInstance().get(n.id)).exist},this)})],Script.prototype,"addToObject",null),Script}(e.Component);e.Script=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function Transform(){t.apply(this,arguments),this.p_parent=null,this._isTranslate=!1,this._isRotate=!1,this._isScale=!1,this.dirtyLocal=!0,this.children=wdCb.Collection.create(),this._endLoopSubscription=null}return __extends(Transform,t),Object.defineProperty(Transform.prototype,"parent",{get:function(){return this.p_parent},set:function(e){this.setParent(e)},enumerable:!0,configurable:!0}),Object.defineProperty(Transform.prototype,"isTransform",{get:function(){return this.isTranslate||this.isRotate||this.isScale},enumerable:!0,configurable:!0}),Object.defineProperty(Transform.prototype,"isTranslate",{get:function(){return this._isTranslate},set:function(t){this._setGlobalTransformState(e.ETransformState.ISTRANSLATE,t)},enumerable:!0,configurable:!0}),Object.defineProperty(Transform.prototype,"isRotate",{get:function(){return this._isRotate},set:function(t){this._setGlobalTransformState(e.ETransformState.ISROTATE,t)},enumerable:!0,configurable:!0}),Object.defineProperty(Transform.prototype,"isScale",{get:function(){return this._isScale},set:function(t){this._setGlobalTransformState(e.ETransformState.ISSCALE,t)},enumerable:!0,configurable:!0}),Object.defineProperty(Transform.prototype,"isLocalTranslate",{set:function(t){this._setLocalTransformState(e.ETransformState.ISLOCALTRANSLATE,t)},enumerable:!0,configurable:!0}),Object.defineProperty(Transform.prototype,"isLocalRotate",{set:function(t){this._setLocalTransformState(e.ETransformState.ISLOCALROTATE,t)},enumerable:!0,configurable:!0}),Object.defineProperty(Transform.prototype,"isLocalScale",{set:function(t){this._setLocalTransformState(e.ETransformState.ISLOCALSCALE,t)},enumerable:!0,configurable:!0}),Transform.prototype.init=function(){var t=this;this.clearCache(),this._endLoopSubscription=e.EventManager.fromEvent(e.EEngineEvent.ENDLOOP).subscribe(function(){t._resetTransformFlag()})},Transform.prototype.dispose=function(){t.prototype.dispose.call(this),this._endLoopSubscription&&this._endLoopSubscription.dispose()},Transform.prototype.addChild=function(e){this.children.addChild(e)},Transform.prototype.removeChild=function(e){this.children.removeChild(e)},Transform.prototype.setChildrenTransformState=function(e,t){t&&this.children.forEach(function(t){t[e]=!0})},Transform.prototype.handleWhenSetTransformState=function(e){},Transform.prototype.setParent=function(e){return this.p_parent&&this.p_parent.removeChild(this),e?(this.p_parent=e,void this.p_parent.addChild(this)):void(this.p_parent=null)},Transform.prototype.getMatrix=function(e,t){var r=wdCb.Collection.create(),n=this.p_parent;for(r.addChild(this);null!==n;)r.addChild(n),n=n.parent;return r.reverse().forEach(function(t){t[e]()}),this[t]},Transform.prototype._setGlobalTransformState=function(e,t){this["_"+e]=t,t&&(this.dirtyLocal=!0,this.clearCache(),this.handleWhenSetTransformState(e)),t&&this.setChildrenTransformState(e,t)},Transform.prototype._setLocalTransformState=function(e,t){t&&(this.dirtyLocal=!0,this.clearCache()),t&&this.setChildrenTransformState(e,t)},Transform.prototype._resetTransformFlag=function(){this.isTranslate=!1,this.isScale=!1,this.isRotate=!1},__decorate([e.cloneAttributeAsBasicType()],Transform.prototype,"parent",null),__decorate([e.virtual],Transform.prototype,"handleWhenSetTransformState",null),Transform}(e.Component);e.Transform=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ThreeDTransform(){t.apply(this,arguments),this._localToWorldMatrix=null,this._position=e.Vector3.create(),this._rotation=e.Quaternion.create(0,0,0,1),this._scale=e.Vector3.create(1,1,1),this._eulerAngles=null,this._localPosition=e.Vector3.create(0,0,0),this._localRotation=e.Quaternion.create(0,0,0,1),this._localEulerAngles=null,this._localScale=e.Vector3.create(1,1,1),this.dirtyWorld=null,this._localToParentMatrix=e.Matrix4.create(),this._localToWorldMatrixCache=null,this._positionCache=null,this._rotationCache=null,this._scaleCache=null,this._eulerAnglesCache=null,this._localEulerAnglesCache=null,this._normalMatrixCache=null}return __extends(ThreeDTransform,t),ThreeDTransform.create=function(){var e=new this;return e},Object.defineProperty(ThreeDTransform.prototype,"localToWorldMatrix",{get:function(){return this.getMatrix("sync","_localToWorldMatrix")},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"normalMatrix",{get:function(){return this.localToWorldMatrix.invertTo3x3().transpose()},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"position",{get:function(){return this._position=this.localToWorldMatrix.getTranslation(),this._position},set:function(e){null===this.p_parent?this._localPosition=e:this._localPosition=this.p_parent.localToWorldMatrix.clone().invert().multiplyPoint(e),this.isTranslate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"rotation",{get:function(){return this._rotation.setFromMatrix(this.localToWorldMatrix),this._rotation},set:function(e){null===this.p_parent?this._localRotation=e:this._localRotation=this.p_parent.rotation.clone().invert().multiply(e),this.isRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"scale",{get:function(){return this._scale=this.localToWorldMatrix.getScale(),this._scale},set:function(e){null===this.p_parent?this._localScale=e:this._localScale=this.p_parent.localToWorldMatrix.clone().invert().multiplyVector3(e),this.isScale=!0},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"eulerAngles",{get:function(){return this._eulerAngles=this.localToWorldMatrix.getEulerAngles(),this._eulerAngles},set:function(e){this._localRotation.setFromEulerAngles(e),null!==this.p_parent&&(this._localRotation=this.p_parent.rotation.clone().invert().multiply(this._localRotation)),this.isRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"localPosition",{get:function(){return this._localPosition},set:function(e){this._localPosition=e,this.isLocalTranslate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"localRotation",{get:function(){return this._localRotation},set:function(e){this._localRotation=e,this.isLocalRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"localEulerAngles",{get:function(){return this._localEulerAngles=this._localRotation.getEulerAngles(),this._localEulerAngles},set:function(e){this._localRotation.setFromEulerAngles(e),this.isLocalRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"localScale",{get:function(){return this._localScale},set:function(e){this._localScale=e,this.isLocalScale=!0},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"up",{get:function(){return this.localToWorldMatrix.getY().normalize()},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"right",{get:function(){return this.localToWorldMatrix.getX().normalize()},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"forward",{get:function(){return this.localToWorldMatrix.getZ().normalize().scale(-1)},enumerable:!0,configurable:!0}),ThreeDTransform.prototype.sync=function(){this.dirtyLocal&&(this._localToParentMatrix.setTRS(this._localPosition,this._localRotation,this._localScale),this.dirtyLocal=!1,this.dirtyWorld=!0),this.dirtyWorld&&(null===this.p_parent?this._localToWorldMatrix=this._localToParentMatrix.clone():this._localToWorldMatrix=this.p_parent.localToWorldMatrix.clone().multiply(this._localToParentMatrix),this.dirtyWorld=!1,this.children.forEach(function(e){e.dirtyWorld=!0}))},ThreeDTransform.prototype.translateLocal=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null;return n=3===t.length?e.Vector3.create(t[0],t[1],t[2]):t[0],this._localPosition=this._localPosition.add(this._localRotation.multiplyVector3(n)),this.isTranslate=!0,this},ThreeDTransform.prototype.translate=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null;return n=3===t.length?e.Vector3.create(t[0],t[1],t[2]):t[0],this.position=n.add(this.position),this},ThreeDTransform.prototype.rotate=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=e.Quaternion.create();return n=3===t.length?e.Vector3.create(t[0],t[1],t[2]):t[0],i.setFromEulerAngles(n),null===this.p_parent?this._localRotation=i.multiply(this._localRotation):(i=this.p_parent.rotation.clone().invert().multiply(i),this._localRotation=i.multiply(this.rotation)),this.isRotate=!0,this},ThreeDTransform.prototype.rotateLocal=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=e.Quaternion.create();return n=3===t.length?e.Vector3.create(t[0],t[1],t[2]):t[0],i.setFromEulerAngles(n),this._localRotation.multiply(i),this.isRotate=!0,this},ThreeDTransform.prototype.rotateAround=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=null,o=null,a=null,s=null;return 3===t.length?(n=t[0],i=t[1],o=t[2]):(n=t[0],i=e.Vector3.create(t[1],t[2],t[3]),o=e.Vector3.create(t[4],t[5],t[6])),a=e.Quaternion.create().setFromAxisAngle(n,o),s=this.position.clone().sub(i),s=a.multiplyVector3(s),this.position=i.add(s),this.rotation=a.multiply(this.rotation),this},ThreeDTransform.prototype.lookAt=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=null;return 1===t.length?(n=t[0],i=e.Vector3.up):2===t.length?(n=t[0],i=t[1]):3===t.length?(n=e.Vector3.create(t[0],t[1],t[2]),i=e.Vector3.up):(n=e.Vector3.create(t[0],t[1],t[2]),i=e.Vector3.create(t[3],t[4],t[5])),this.rotation=e.Quaternion.create().setFromMatrix(e.Matrix4.create().setLookAt(this.position,n,i)),this},ThreeDTransform.prototype.clearCache=function(){this._localToWorldMatrixCache=null,this._normalMatrixCache=null,this._positionCache=null,this._rotationCache=null,this._scaleCache=null,this._eulerAnglesCache=null,this._localEulerAnglesCache=null},ThreeDTransform.prototype.handleWhenSetTransformState=function(t){var r=null;switch(t){case e.ETransformState.ISTRANSLATE:r=e.EEngineEvent.TRANSFORM_TRANSLATE;break;case e.ETransformState.ISROTATE:r=e.EEngineEvent.TRANSFORM_ROTATE;break;case e.ETransformState.ISSCALE:r=e.EEngineEvent.TRANSFORM_SCALE;break;default:e.Log.error(!0,e.Log.info.FUNC_UNKNOW("transformState:"+t))}e.EventManager.trigger(this.entityObject,e.CustomEvent.create(r))},__decorate([e.cacheGetter(function(){return null!==this._localToWorldMatrixCache},function(){return this._localToWorldMatrixCache},function(e){this._localToWorldMatrixCache=e})],ThreeDTransform.prototype,"localToWorldMatrix",null),__decorate([e.cacheGetter(function(){return null!==this._normalMatrixCache},function(){return this._normalMatrixCache},function(e){this._normalMatrixCache=e})],ThreeDTransform.prototype,"normalMatrix",null),__decorate([e.cloneAttributeAsCloneable(),e.cacheGetter(function(){return null!==this._positionCache},function(){return this._positionCache},function(e){this._positionCache=e})],ThreeDTransform.prototype,"position",null),__decorate([e.cloneAttributeAsCloneable(),e.cacheGetter(function(){return null!==this._rotationCache},function(){return this._rotationCache},function(e){this._rotationCache=e})],ThreeDTransform.prototype,"rotation",null),__decorate([e.cloneAttributeAsCloneable(),e.cacheGetter(function(){return null!==this._scaleCache},function(){return this._scaleCache},function(e){this._scaleCache=e})],ThreeDTransform.prototype,"scale",null),__decorate([e.cacheGetter(function(){return null!==this._eulerAnglesCache},function(){return this._eulerAnglesCache},function(e){this._eulerAnglesCache=e})],ThreeDTransform.prototype,"eulerAngles",null),__decorate([e.cloneAttributeAsCloneable()],ThreeDTransform.prototype,"localPosition",null),__decorate([e.cloneAttributeAsCloneable()],ThreeDTransform.prototype,"localRotation",null),__decorate([e.cacheGetter(function(){return null!==this._localEulerAnglesCache},function(){return this._localEulerAnglesCache},function(e){this._localEulerAnglesCache=e})],ThreeDTransform.prototype,"localEulerAngles",null),__decorate([e.cloneAttributeAsCloneable()],ThreeDTransform.prototype,"localScale",null),ThreeDTransform}(e.Transform);e.ThreeDTransform=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.ISTRANSLATE="isTranslate"]="ISTRANSLATE",e[e.ISROTATE="isRotate"]="ISROTATE",e[e.ISSCALE="isScale"]="ISSCALE",e[e.ISLOCALTRANSLATE="isLocalTranslate"]="ISLOCALTRANSLATE",e[e.ISLOCALROTATE="isLocalRotate"]="ISLOCALROTATE",e[e.ISLOCALSCALE="isLocalScale"]="ISLOCALSCALE"}(e.ETransformState||(e.ETransformState={}));e.ETransformState}(wd||(wd={}));var wd;!function(e){var t=function(t){function Geometry(){t.apply(this,arguments),this._material=null,this.buffers=null,this.vaoManager=e.GPUDetector.getInstance().extensionVAO?e.VAOManager.create():null,this.drawMode=e.EDrawMode.TRIANGLES}return __extends(Geometry,t),Object.defineProperty(Geometry.prototype,"material",{get:function(){return this._material},set:function(t){e.JudgeUtils.isEqual(t,this._material)||(this._material=t,this._material.geometry=this,this.entityObject&&e.EventManager.trigger(this.entityObject,e.CustomEvent.create(e.EEngineEvent.MATERIAL_CHANGE)))},enumerable:!0,configurable:!0}),Object.defineProperty(Geometry.prototype,"geometryData",{get:function(){return null===this.buffers?null:this.buffers.geometryData},enumerable:!0,configurable:!0}),Geometry.prototype.init=function(){var e=null,t=this.computeData();this.buffers=this.createBufferContainer(),e=this.createGeometryData(t),this.buffers.geometryData=e,this.buffers.init(),this._material.init(),this.computeNormals(),this.vaoManager&&this.vaoManager.init()},Geometry.prototype.hasFaceNormals=function(){return this.buffers.geometryData.hasFaceNormals()},Geometry.prototype.hasVertexNormals=function(){return this.buffers.geometryData.hasVertexNormals()},Geometry.prototype.hasColors=function(){return this.buffers.geometryData.hasColors()},Geometry.prototype.isSmoothShading=function(){return this._material.shading===e.EShading.SMOOTH},Geometry.prototype.dispose=function(){this.buffers.dispose(),this._material.dispose(),this.vaoManager&&this.vaoManager.dispose()},Geometry.prototype.computeFaceNormals=function(){this.buffers.geometryData.computeFaceNormals()},Geometry.prototype.computeVertexNormals=function(){this.buffers.geometryData.computeVertexNormals()},Geometry.prototype.createBuffersFromGeometryData=function(){this.buffers.createBuffersFromGeometryData()},Geometry.prototype.computeNormals=function(){this.isSmoothShading()?this.hasVertexNormals()||this.computeVertexNormals():this.hasFaceNormals()||this.computeFaceNormals()},Geometry.prototype.createBufferContainer=function(){return e.BasicBufferContainer.create(this.entityObject)},Geometry.prototype.createGeometryData=function(e){return this.createBasicGeometryData(e)},Geometry.prototype.createBasicGeometryData=function(t){var r=t.vertices,n=t.faces,i=void 0===n?[]:n,o=t.texCoords,a=t.colors,s=e.BasicGeometryData.create(this);return s.vertices=r,s.faces=i,s.texCoords=o,s.colors=a,s},__decorate([e.cloneAttributeAsCloneable()],Geometry.prototype,"material",null),__decorate([e.cloneAttributeAsBasicType()],Geometry.prototype,"drawMode",void 0),__decorate([e.ensure(function(){var t=this.buffers.geometryData;e.it("faces.count should be be "+t.indices.length/3+", but actual is "+t.faces.length,function(){e.expect(3*t.faces.length).equals(t.indices.length)})}),e.execOnlyOnce("_isInit")],Geometry.prototype,"init",null),__decorate([e.require(function(){var t=this;e.it("must define buffers->geometryData",function(){e.expect(t.buffers).exist,e.expect(t.buffers.geometryData).exist})})],Geometry.prototype,"hasFaceNormals",null),__decorate([e.require(function(){var t=this;e.it("must define buffers->geometryData",function(){e.expect(t.buffers).exist,e.expect(t.buffers.geometryData).exist})})],Geometry.prototype,"hasVertexNormals",null),__decorate([e.require(function(){var t=this;e.it("must define buffers->geometryData",function(){e.expect(t.buffers).exist,e.expect(t.buffers.geometryData).exist})})],Geometry.prototype,"computeFaceNormals",null),__decorate([e.require(function(){var t=this;e.it("not exist buffers",function(){e.expect(t.buffers).exist})})],Geometry.prototype,"createBuffersFromGeometryData",null),__decorate([e.virtual],Geometry.prototype,"computeNormals",null),__decorate([e.virtual],Geometry.prototype,"createBufferContainer",null),__decorate([e.virtual],Geometry.prototype,"createGeometryData",null),Geometry}(e.Component);e.Geometry=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function InstanceGeometry(){t.apply(this,arguments),this._customGeometry=e.CustomGeometry.create(),this._attributeData=wdCb.Collection.create(),this.dirty=!1}return __extends(InstanceGeometry,t),Object.defineProperty(InstanceGeometry.prototype,"vertices",{get:function(){return this._customGeometry.vertices},set:function(e){this._customGeometry.vertices=e},enumerable:!0,configurable:!0}),Object.defineProperty(InstanceGeometry.prototype,"texCoords",{get:function(){return this._customGeometry.texCoords},set:function(e){this._customGeometry.texCoords=e},enumerable:!0,configurable:!0}),Object.defineProperty(InstanceGeometry.prototype,"colors",{get:function(){return this._customGeometry.colors},set:function(e){this._customGeometry.colors=e},enumerable:!0,configurable:!0}),Object.defineProperty(InstanceGeometry.prototype,"indices",{get:function(){return this._customGeometry.indices},set:function(e){this._customGeometry.indices=e},enumerable:!0,configurable:!0}),Object.defineProperty(InstanceGeometry.prototype,"normals",{get:function(){return this._customGeometry.normals},set:function(e){this._customGeometry.normals=e},enumerable:!0,configurable:!0}),Object.defineProperty(InstanceGeometry.prototype,"instanceAttributeData",{get:function(){return this.attributeData.getChild(0)},enumerable:!0,configurable:!0}),Object.defineProperty(InstanceGeometry.prototype,"instanceCount",{get:function(){return this.attributeData.getCount()},enumerable:!0,configurable:!0}),Object.defineProperty(InstanceGeometry.prototype,"attributeData",{get:function(){return this._attributeData},enumerable:!0,configurable:!0}),InstanceGeometry.prototype.addInstanceAttributes=function(e){var t=wdCb.Collection.create();this.dirty=!0;for(var r=0,n=e;r<n.length;r++){var i=n[r];t.addChild(wdCb.ExtendUtils.extend({meshPerAttribute:1},i))}this._attributeData.addChild(t)},InstanceGeometry.prototype.clearInstanceAttributeData=function(){this.dirty=!0,this._attributeData.removeAllChildren()},InstanceGeometry.prototype.computeData=function(){return{vertices:this.vertices,faces:e.GeometryUtils.convertToFaces(this.indices,this.normals),texCoords:this.texCoords,colors:this.colors}},__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],InstanceGeometry.prototype,"vertices",null),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],InstanceGeometry.prototype,"texCoords",null),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],InstanceGeometry.prototype,"colors",null),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],InstanceGeometry.prototype,"indices",null),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],InstanceGeometry.prototype,"normals",null),__decorate([e.requireGetter(function(){var t=this;e.it("attributeData.length should > 0",function(){e.expect(t.attributeData.getCount()).greaterThan(0)},this)}),e.ensureGetter(function(t){var r=this;e.it("each data of all instance datas should be the same except the data",function(){r.attributeData.forEach(function(r){r.forEach(function(r,n){e.expect(r.attributeName).equals(t.getChild(n).attributeName),e.expect(r.meshPerAttribute).equals(t.getChild(n).meshPerAttribute)})})},this)})],InstanceGeometry.prototype,"instanceAttributeData",null),__decorate([e.cloneAttributeAsCustomType(function(e,t,r){var n=e[r],i=t[r];n.forEach(function(e){i.addChild(e.clone(!0))})})],InstanceGeometry.prototype,"attributeData",null),__decorate([e.cloneAttributeAsBasicType()],InstanceGeometry.prototype,"dirty",void 0),__decorate([e.require(function(t){e.it("attributeName shouldn't equal vertices|normals|indices|texCoords|colors",function(){for(var r=0,n=t;r<n.length;r++){var i=n[r],o=i.attributeName;e.expect(o).not.equals("vertices"),e.expect(o).not.equals("normals"),e.expect(o).not.equals("indices"),e.expect(o).not.equals("texCoords"),e.expect(o).not.equals("colors")}}),e.it("data should be Array<number> or Float32Array",function(){for(var r=0,n=t;r<n.length;r++){var i=n[r],o=i.data;e.expect(e.JudgeUtils.isArrayExactly(o)||"[object Float32Array]"===Object.prototype.toString.call(o))["true"];
}})})],InstanceGeometry.prototype,"addInstanceAttributes",null),InstanceGeometry}(e.Geometry);e.InstanceGeometry=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BasicInstanceGeometry(){e.apply(this,arguments)}return __extends(BasicInstanceGeometry,e),BasicInstanceGeometry.create=function(){var e=new this;return e},BasicInstanceGeometry}(e.InstanceGeometry);e.BasicInstanceGeometry=t}(wd||(wd={}));var wd;!function(e){var t=function(){function VAOManager(){this._vaoMap=wdCb.Hash.create(),this._extension=null}return VAOManager.create=function(){var e=new this;return e},VAOManager.prototype.init=function(){this._extension=e.GPUDetector.getInstance().extensionVAO},VAOManager.prototype.dispose=function(){this._vaoMap.removeAllChildren()},VAOManager.prototype.getVAOData=function(e){var t=!1,r=this._vaoMap.getChild(e);return r?t=!0:(r=this._extension.createVertexArrayOES(),this._vaoMap.addChild(e,r),t=!1),{vao:r,isSetted:t}},VAOManager.prototype.sendAllBufferData=function(t,r){var n=this.getVAOData(t),i=n.vao,o=n.isSetted;if(e.BufferTable.lastBindedElementBuffer=null,this._extension.bindVertexArrayOES(i),!o)for(var a=0,s=r.length;a<s;a++){var c=r[a];if(c){var u=e.DeviceManager.getInstance().gl;u.bindBuffer(u.ARRAY_BUFFER,c.buffer),u.vertexAttribPointer(a,c.size,u[c.type],!1,0,0),u.enableVertexAttribArray(a)}}},__decorate([e.require(function(){e.assert(!!e.GPUDetector.getInstance().extensionVAO,e.Log.info.FUNC_SHOULD("hardware","support vao extension"))})],VAOManager.prototype,"init",null),VAOManager}();e.VAOManager=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function LineGeometry(){t.apply(this,arguments),this._customGeometry=e.CustomGeometry.create()}return __extends(LineGeometry,t),Object.defineProperty(LineGeometry.prototype,"vertices",{get:function(){return this._customGeometry.vertices},set:function(e){this._customGeometry.vertices=e},enumerable:!0,configurable:!0}),LineGeometry.prototype.computeData=function(){return{vertices:this.computeVertices()}},__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],LineGeometry.prototype,"vertices",null),LineGeometry}(e.Geometry);e.LineGeometry=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function SolidLineGeometry(){t.apply(this,arguments)}return __extends(SolidLineGeometry,t),SolidLineGeometry.create=function(){var e=new this;return e.initWhenCreate(),e},SolidLineGeometry.prototype.initWhenCreate=function(){this.drawMode=e.EDrawMode.LINE_STRIP},SolidLineGeometry.prototype.computeVertices=function(){return this.vertices},SolidLineGeometry}(e.LineGeometry);e.SolidLineGeometry=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DashLineGeometry(){t.apply(this,arguments),this.dashSize=3,this.gapSize=1,this.dashCount=200}return __extends(DashLineGeometry,t),DashLineGeometry.create=function(){var e=new this;return e.initWhenCreate(),e},DashLineGeometry.prototype.initWhenCreate=function(){this.drawMode=e.EDrawMode.LINES},DashLineGeometry.prototype.computeVertices=function(){for(var t=this.dashSize,r=this.gapSize,n=this.dashCount,i=this.vertices.slice(0),o=e.Vector3.create(),a=0,s=0,c=0,u=0,l=0,h=[],d=0,p=i.length-3;d<p;d+=3)o.x=i[d+3]-i[d],o.y=i[d+4]-i[d+1],o.z=i[d+5]-i[d+2],a+=o.length();c=a/n,u=t*c/(t+r);for(var d=0,p=i.length-3;d<p;d+=3){o.x=i[d+3]-i[d],o.y=i[d+4]-i[d+1],o.z=i[d+5]-i[d+2],s=Math.floor(o.length()/c),o.normalize();for(var f=0;f<s;f++)l=c*f,h.push(i[d]+l*o.x,i[d+1]+l*o.y,i[d+2]+l*o.z),h.push(i[d]+(l+u)*o.x,i[d+1]+(l+u)*o.y,i[d+2]+(l+u)*o.z)}return h},__decorate([e.cloneAttributeAsBasicType()],DashLineGeometry.prototype,"dashSize",void 0),__decorate([e.cloneAttributeAsBasicType()],DashLineGeometry.prototype,"gapSize",void 0),__decorate([e.cloneAttributeAsBasicType()],DashLineGeometry.prototype,"dashCount",void 0),DashLineGeometry}(e.LineGeometry);e.DashLineGeometry=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ConvexPolygonGeometry(){t.apply(this,arguments),this._customGeometry=e.CustomGeometry.create()}return __extends(ConvexPolygonGeometry,t),ConvexPolygonGeometry.create=function(){var e=new this;return e},Object.defineProperty(ConvexPolygonGeometry.prototype,"vertices",{get:function(){return this._customGeometry.vertices},set:function(e){this._customGeometry.vertices=e},enumerable:!0,configurable:!0}),Object.defineProperty(ConvexPolygonGeometry.prototype,"texCoords",{get:function(){return this._customGeometry.texCoords},set:function(e){this._customGeometry.texCoords=e},enumerable:!0,configurable:!0}),Object.defineProperty(ConvexPolygonGeometry.prototype,"colors",{get:function(){return this._customGeometry.colors},set:function(e){this._customGeometry.colors=e},enumerable:!0,configurable:!0}),Object.defineProperty(ConvexPolygonGeometry.prototype,"indices",{get:function(){return this._customGeometry.indices},set:function(e){this._customGeometry.indices=e},enumerable:!0,configurable:!0}),Object.defineProperty(ConvexPolygonGeometry.prototype,"normals",{get:function(){return this._customGeometry.normals},set:function(e){this._customGeometry.normals=e},enumerable:!0,configurable:!0}),ConvexPolygonGeometry.prototype.computeData=function(){for(var t=[],r=1,n=this.vertices.length/3-1;r<n;r++)t.push(0,r+1,r);return this.indices=t,{vertices:this.vertices,faces:e.GeometryUtils.convertToFaces(this.indices,this.normals),texCoords:this.texCoords,colors:this.colors}},__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],ConvexPolygonGeometry.prototype,"vertices",null),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],ConvexPolygonGeometry.prototype,"texCoords",null),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],ConvexPolygonGeometry.prototype,"colors",null),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],ConvexPolygonGeometry.prototype,"indices",null),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],ConvexPolygonGeometry.prototype,"normals",null),ConvexPolygonGeometry}(e.Geometry);e.ConvexPolygonGeometry=t}(wd||(wd={}));var wd;!function(e){var t=function(){function GeometryUtils(){}return GeometryUtils.convertToFaces=function(t,r){for(var n=this.hasData(r),i=[],o=0,a=t.length;o<a;o+=3){var s=t[o],c=t[o+1],u=t[o+2],l=e.Face3.create(s,c,u);n&&(l.vertexNormals.addChildren([this.getThreeComponent(r,s),this.getThreeComponent(r,c),this.getThreeComponent(r,u)]),l.faceNormal=l.vertexNormals.getChild(0).clone()),i.push(l)}return i},GeometryUtils.hasData=function(e){return e&&(e.length&&e.length>0||e.getCount&&e.getCount()>0)},GeometryUtils.getThreeComponent=function(t,r){var n=3*r;return e.Vector3.create(t[n],t[n+1],t[n+2])},GeometryUtils.iterateThreeComponent=function(t,r){for(var n=0,i=t.length;n<i;n+=3)r(e.Vector3.create(t[n],t[n+1],t[n+2]))},GeometryUtils.setThreeComponent=function(t,r,n){r instanceof e.Vector3?(t[3*n]=r.x,t[3*n+1]=r.y,t[3*n+2]=r.z):(t[3*n]=r[0],t[3*n+1]=r[1],t[3*n+2]=r[2])},GeometryUtils.mergeFace=function(e,t){if(!t)return e;for(var r=0,n=t;r<n.length;r++){var i=n[r];e.push(i.clone())}return e},__decorate([e.require(function(t){t&&e.assert(t instanceof wdCb.Collection||t instanceof wdCb.Hash||e.JudgeUtils.isArrayExactly(t),e.Log.info.FUNC_SHOULD("data","be Array or Collection or Hash"))})],GeometryUtils,"hasData",null),__decorate([e.require(function(t,r){e.assert(t.length%3===0,e.Log.info.FUNC_SHOULD("dataArr.length","times of three"))})],GeometryUtils,"iterateThreeComponent",null),GeometryUtils}();e.GeometryUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CustomGeometry(){t.apply(this,arguments),this._vertices=[],this._texCoords=[],this._colors=[],this._indices=[],this._normals=[]}return __extends(CustomGeometry,t),CustomGeometry.create=function(){var e=new this;return e},Object.defineProperty(CustomGeometry.prototype,"vertices",{get:function(){return this._vertices},set:function(e){this._vertices=e,this.buffers&&(this.buffers.geometryData.vertices=e)},enumerable:!0,configurable:!0}),Object.defineProperty(CustomGeometry.prototype,"texCoords",{get:function(){return this._texCoords},set:function(e){this._texCoords=e,this.buffers&&(this.buffers.geometryData.texCoords=e)},enumerable:!0,configurable:!0}),Object.defineProperty(CustomGeometry.prototype,"colors",{get:function(){return this._colors},set:function(e){this._colors=e,this.buffers&&(this.buffers.geometryData.colors=e)},enumerable:!0,configurable:!0}),Object.defineProperty(CustomGeometry.prototype,"indices",{get:function(){return this._indices},set:function(t){this._indices=t,this.buffers&&(this.buffers.geometryData.faces=e.GeometryUtils.convertToFaces(t,this.normals))},enumerable:!0,configurable:!0}),Object.defineProperty(CustomGeometry.prototype,"normals",{get:function(){return this._normals},set:function(t){this._normals=t,this.buffers&&(this.buffers.geometryData.faces=e.GeometryUtils.convertToFaces(this.indices,t))},enumerable:!0,configurable:!0}),CustomGeometry.prototype.computeData=function(){return{vertices:this.vertices,faces:e.GeometryUtils.convertToFaces(this.indices,this.normals),texCoords:this.texCoords,colors:this.colors}},__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],CustomGeometry.prototype,"vertices",null),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],CustomGeometry.prototype,"texCoords",null),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],CustomGeometry.prototype,"colors",null),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],CustomGeometry.prototype,"indices",null),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],CustomGeometry.prototype,"normals",null),CustomGeometry}(e.Geometry);e.CustomGeometry=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ModelGeometryMerger(){}return ModelGeometryMerger.create=function(){var e=new this;return e},ModelGeometryMerger.prototype.merge=function(e,t,r){var n=this._getSourceModelGeometryData(e),i=this._getTargetModelGeometryData(t);n=this._initModelGeometryData(n),e.faces=this._mergeTransformedFace(n.faces,i.faces,r,n.vertices.length/3),e.vertices=this._mergeData(n.vertices,this._transformVertices(i.vertices,r)),e.texCoords=this._mergeData(n.texCoords,i.texCoords),e.colors=this._mergeData(n.colors,i.colors),e.jointIndices=this._mergeData(n.jointIndices,i.jointIndices),e.jointWeights=this._mergeData(n.jointWeights,i.jointWeights)},ModelGeometryMerger.prototype._getSourceModelGeometryData=function(e){return null!==e.geometryData?e.geometryData:{vertices:e.vertices,texCoords:e.texCoords,colors:e.colors,jointIndices:e.jointIndices,jointWeights:e.jointWeights,faces:e.faces}},ModelGeometryMerger.prototype._initModelGeometryData=function(e){return{vertices:e.vertices||[],texCoords:e.texCoords||[],colors:e.colors||[],jointIndices:e.jointIndices||[],jointWeights:e.jointWeights||[],faces:e.faces||[]}},ModelGeometryMerger.prototype._getTargetModelGeometryData=function(t){return null!==t.geometryData?t.geometryData:t instanceof e.ModelGeometry?{vertices:t.vertices,texCoords:t.texCoords,colors:t.colors,jointIndices:t.jointIndices,jointWeights:t.jointWeights,faces:t.faces}:t.computeData()},ModelGeometryMerger.prototype._transformVertices=function(t,r){for(var n=r.localToWorldMatrix,i=[],o=0,a=t.length;o<a;o+=3){var s=e.Vector3.create(t[o],t[o+1],t[o+2]).applyMatrix4(n);i.push(s.x,s.y,s.z)}return i},ModelGeometryMerger.prototype._mergeTransformedFace=function(t,r,n,i){var o=null;if(!r)return t;o=n.normalMatrix;for(var a=function(r){var n=e.Face3.create(r.aIndex+i,r.bIndex+i,r.cIndex+i);if(r.hasFaceNormal()&&(n.faceNormal=r.faceNormal.clone().applyMatrix3(o)),r.vertexNormals){var a=wdCb.Collection.create();r.vertexNormals.forEach(function(e){a.addChild(e.clone().applyMatrix3(o))}),n.vertexNormals=a}t.push(n)},s=0,c=r;s<c.length;s++){var u=c[s];a(u)}return t},ModelGeometryMerger.prototype._mergeData=function(e,t){return t?e.concat(t):e},ModelGeometryMerger.prototype._mergeFace=function(t,r){return e.GeometryUtils.mergeFace(t,r)},__decorate([e.require(function(t,r){e.assert(t&&t.length>0,e.Log.info.FUNC_MUST("vertices.count","> 0"))})],ModelGeometryMerger.prototype,"_transformVertices",null),ModelGeometryMerger}();e.ModelGeometryMerger=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ModelGeometry(){t.apply(this,arguments),this.vertices=null,this.colors=null,this.texCoords=null,this.faces=null,this.morphVertices=null,this.morphFaceNormals=wdCb.Hash.create(),this.morphVertexNormals=wdCb.Hash.create(),this.jointIndices=null,this.jointWeights=null,this._merger=e.ModelGeometryMerger.create()}return __extends(ModelGeometry,t),ModelGeometry.create=function(){var e=new this;return e},ModelGeometry.prototype.hasMorphAnimation=function(){return this._hasMorphTargets()&&this.entityObject&&e.ClassUtils.hasComponent(this.entityObject,"MorphAnimation")},ModelGeometry.prototype.hasSkinSkeletonAnimation=function(){return this._hasJoinData()&&this.entityObject&&e.ClassUtils.hasComponent(this.entityObject,"SkinSkeletonAnimation")},ModelGeometry.prototype.hasMorphFaceNormals=function(){return this.buffers.geometryData.hasMorphFaceNormals()},ModelGeometry.prototype.hasMorphVertexNormals=function(){return this.buffers.geometryData.hasMorphVertexNormals()},ModelGeometry.prototype.computeMorphNormals=function(){this.buffers.geometryData.computeMorphNormals()},ModelGeometry.prototype.merge=function(e,t){this._merger.merge(this,e,t)},ModelGeometry.prototype.computeNormals=function(){t.prototype.computeNormals.call(this),this._hasMorphTargets()&&(this.isSmoothShading()?this.hasMorphVertexNormals()||this.computeMorphNormals():this.hasMorphFaceNormals()||this.computeMorphNormals())},ModelGeometry.prototype.computeData=function(){return{vertices:this.vertices,faces:this.faces,texCoords:this.texCoords,colors:this.colors,jointIndices:this.jointIndices,jointWeights:this.jointWeights,morphVertices:this.morphVertices}},ModelGeometry.prototype.createBufferContainer=function(){if(this.hasMorphAnimation()){var t=e.ClassUtils.getClass("MorphBufferContainer"),r=e.ClassUtils.getClass("MorphAnimation");return t.create(this.entityObject,this.entityObject.getComponent(r))}if(this.hasSkinSkeletonAnimation()){var n=e.ClassUtils.getClass("SkinSkeletonBufferContainer");e.ClassUtils.getClass("SkinSkeletonAnimation");return n.create(this.entityObject)}return e.BasicBufferContainer.create(this.entityObject)},ModelGeometry.prototype.createGeometryData=function(t){if(this.hasMorphAnimation()){var r=t.vertices,n=t.faces,i=void 0===n?[]:n,o=t.texCoords,a=t.colors,s=t.morphVertices,c=e.ClassUtils.getClass("MorphGeometryData"),u=c.create(this);return u.vertices=r,u.faces=i,u.texCoords=o,u.colors=a,u.morphVertices=s,u}if(this.hasSkinSkeletonAnimation()){var r=t.vertices,l=t.faces,i=void 0===l?[]:l,o=t.texCoords,a=t.colors,h=t.jointIndices,d=t.jointWeights,p=e.ClassUtils.getClass("SkinSkeletonGeometryData"),u=p.create(this);return u.vertices=r,u.faces=i,u.texCoords=o,u.colors=a,u.jointIndices=h,u.jointWeights=d,u}return this.createBasicGeometryData(t)},ModelGeometry.prototype._hasMorphTargets=function(){return this.morphVertices&&this.morphVertices.getCount()>0},ModelGeometry.prototype._hasJoinData=function(){return this.jointIndices&&this.jointIndices.length>0},ModelGeometry.prototype._getDeepCloneMorphData=function(e){var t=wdCb.Hash.create();return e&&e.forEach(function(e,r){t.addChild(r,e.clone(!0))}),t},__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],ModelGeometry.prototype,"vertices",void 0),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],ModelGeometry.prototype,"colors",void 0),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],ModelGeometry.prototype,"texCoords",void 0),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.GeometryUtils.mergeFace([],t[n])})],ModelGeometry.prototype,"faces",void 0),__decorate([e.cloneAttributeAsCustomType(function(e,t,r){t[r]=this._getDeepCloneMorphData(e[r])})],ModelGeometry.prototype,"morphVertices",void 0),__decorate([e.cloneAttributeAsCustomType(function(e,t,r){t[r]=this._getDeepCloneMorphData(e[r])})],ModelGeometry.prototype,"morphFaceNormals",void 0),__decorate([e.cloneAttributeAsCustomType(function(e,t,r){t[r]=this._getDeepCloneMorphData(e[r])})],ModelGeometry.prototype,"morphVertexNormals",void 0),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],ModelGeometry.prototype,"jointIndices",void 0),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],ModelGeometry.prototype,"jointWeights",void 0),__decorate([e.require(function(){e.assert(this.buffers&&this.buffers.geometryData,e.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],ModelGeometry.prototype,"hasMorphFaceNormals",null),__decorate([e.require(function(){e.assert(this.buffers&&this.buffers.geometryData,e.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],ModelGeometry.prototype,"hasMorphVertexNormals",null),__decorate([e.require(function(){e.assert(this.buffers&&this.buffers.geometryData,e.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],ModelGeometry.prototype,"computeMorphNormals",null),__decorate([e.require(function(){var t=this;this.hasMorphAnimation()&&e.it("entityObject with ModelGeometry should add MorphAnimation component",function(){e.ClassUtils.hasComponent(t.entityObject,"MorphAnimation")},this)})],ModelGeometry.prototype,"createBufferContainer",null),__decorate([e.ensure(function(t){var r=this;e.it("jointIndices and jointWeights should has data",function(){t&&e.expect(r.jointWeights&&r.jointWeights.length>0)})})],ModelGeometry.prototype,"_hasJoinData",null),ModelGeometry}(e.Geometry);e.ModelGeometry=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function BoxGeometry(){t.apply(this,arguments),this.width=null,this.height=null,this.depth=null,this.widthSegments=1,this.heightSegments=1,this.depthSegments=1}return __extends(BoxGeometry,t),BoxGeometry.create=function(){var e=new this;return e},BoxGeometry.prototype.computeData=function(){function generateFace(t,r,n){var i,o,a,s,m=h.length/3;for(a=0;a<=r;a++)for(s=0;s<=n;s++){var g=e.Vector3.create(),_=e.Vector3.create(),y=e.Vector3.create(),v=e.Vector3.create();g.lerp(l[c[t][0]],l[c[t][1]],a/r),_.lerp(l[c[t][0]],l[c[t][2]],s/n),y.sub2(_,l[c[t][0]]),v.add2(g,y),i=a/r,o=s/n,h.push(v.x,v.y,v.z),d.push(u[t][0],u[t][1],u[t][2]),p.push(i,o),a<r&&s<n&&(f.push(m+s+a*(r+1),m+s+(a+1)*(r+1),m+s+a*(r+1)+1),f.push(m+s+(a+1)*(r+1),m+s+(a+1)*(r+1)+1,m+s+a*(r+1)+1))}}var t=this.width,r=this.height,n=this.depth,i=this.widthSegments,o=this.heightSegments,a=this.depthSegments,s={FRONT:0,BACK:1,TOP:2,BOTTOM:3,RIGHT:4,LEFT:5},c=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],u=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],l=[e.Vector3.create(-t,-r,n),e.Vector3.create(t,-r,n),e.Vector3.create(t,r,n),e.Vector3.create(-t,r,n),e.Vector3.create(t,-r,-n),e.Vector3.create(-t,-r,-n),e.Vector3.create(-t,r,-n),e.Vector3.create(t,r,-n)],h=[],d=[],p=[],f=[];return generateFace(s.FRONT,i,o),generateFace(s.BACK,i,o),generateFace(s.TOP,i,a),generateFace(s.BOTTOM,i,a),generateFace(s.RIGHT,a,o),generateFace(s.LEFT,a,o),{vertices:h,faces:e.GeometryUtils.convertToFaces(f,d),texCoords:p}},__decorate([e.cloneAttributeAsBasicType()],BoxGeometry.prototype,"width",void 0),__decorate([e.cloneAttributeAsBasicType()],BoxGeometry.prototype,"height",void 0),__decorate([e.cloneAttributeAsBasicType()],BoxGeometry.prototype,"depth",void 0),__decorate([e.cloneAttributeAsBasicType()],BoxGeometry.prototype,"widthSegments",void 0),__decorate([e.cloneAttributeAsBasicType()],BoxGeometry.prototype,"heightSegments",void 0),__decorate([e.cloneAttributeAsBasicType()],BoxGeometry.prototype,"depthSegments",void 0),BoxGeometry}(e.Geometry);e.BoxGeometry=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function RectGeometry(){t.apply(this,arguments),this.width=null,this.height=null}return __extends(RectGeometry,t),RectGeometry.create=function(){var e=new this;return e},RectGeometry.prototype.computeData=function(){var t=this.width,r=this.height,n=-t/2,i=t/2,o=r/2,a=-r/2,s=[],c=[],u=[],l=[];return s=[i,o,0,n,o,0,n,a,0,i,a,0],u=[0,1,2,0,2,3],c=[1,1,0,1,0,0,1,0],l=[0,0,1,0,0,1,0,0,1,0,0,1],{vertices:s,faces:e.GeometryUtils.convertToFaces(u,l),texCoords:c}},__decorate([e.cloneAttributeAsBasicType()],RectGeometry.prototype,"width",void 0),__decorate([e.cloneAttributeAsBasicType()],RectGeometry.prototype,"height",void 0),RectGeometry}(e.Geometry);e.RectGeometry=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function PlaneGeometry(){t.apply(this,arguments),this.width=null,this.height=null,this.widthSegments=1,this.heightSegments=1}return __extends(PlaneGeometry,t),PlaneGeometry.create=function(){var e=new this;return e},PlaneGeometry.prototype.computeData=function(){var t=this.width,r=this.height,n=this.widthSegments,i=this.heightSegments,o=null,a=null,s=null,c=null,u=null,l=null,h=null,d=[],p=[],f=[],m=[];for(l=0;l<=n;l++)for(h=0;h<=i;h++)o=-t+2*t*l/n,a=0,s=-(-r+2*r*h/i),c=l/n,u=h/i,d.push(o,a,s),f.push(0,1,0),p.push(c,u),l<n&&h<i&&(m.push(h+l*(n+1),h+(l+1)*(n+1),h+l*(n+1)+1),m.push(h+(l+1)*(n+1),h+(l+1)*(n+1)+1,h+l*(n+1)+1));return{vertices:d,faces:e.GeometryUtils.convertToFaces(m,f),texCoords:p}},__decorate([e.cloneAttributeAsBasicType()],PlaneGeometry.prototype,"width",void 0),__decorate([e.cloneAttributeAsBasicType()],PlaneGeometry.prototype,"height",void 0),__decorate([e.cloneAttributeAsBasicType()],PlaneGeometry.prototype,"widthSegments",void 0),__decorate([e.cloneAttributeAsBasicType()],PlaneGeometry.prototype,"heightSegments",void 0),PlaneGeometry}(e.Geometry);e.PlaneGeometry=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.LATITUDELONGTITUDE=0]="LATITUDELONGTITUDE"}(e.ESphereDrawMode||(e.ESphereDrawMode={}));e.ESphereDrawMode}(wd||(wd={}));var wd;!function(e){var t=function(t){function SphereGeometry(){t.apply(this,arguments),this.radius=1,this.sphereDrawMode=e.ESphereDrawMode.LATITUDELONGTITUDE,this.segments=20}return __extends(SphereGeometry,t),SphereGeometry.create=function(){var e=new this;return e},SphereGeometry.prototype.computeData=function(){var t=this.radius,n=(this.sphereDrawMode,this.segments),i=r.create(t,n).getData(),o=i.vertices,a=i.indices,s=i.normals,c=i.texCoords;return{vertices:o,faces:e.GeometryUtils.convertToFaces(a,s),texCoords:c}},__decorate([e.cloneAttributeAsBasicType()],SphereGeometry.prototype,"radius",void 0),__decorate([e.cloneAttributeAsBasicType()],SphereGeometry.prototype,"sphereDrawMode",void 0),__decorate([e.cloneAttributeAsBasicType()],SphereGeometry.prototype,"segments",void 0),__decorate([e.require(function(){e.assert(this.sphereDrawMode===e.ESphereDrawMode.LATITUDELONGTITUDE,e.Log.info.FUNC_MUST_BE("sphereDrawMode","ESphereDrawMode.LATITUDELONGTITUDE"))})],SphereGeometry.prototype,"computeData",null),SphereGeometry}(e.Geometry);e.SphereGeometry=t;var r=function(){function GetDataByLatitudeLongtitude(e,t){this._radius=null,this._latitudeBands=null,this._longitudeBands=null,this._radius=e,this._latitudeBands=t,this._longitudeBands=t}return GetDataByLatitudeLongtitude.create=function(e,t){var r=new this(e,t);return r},GetDataByLatitudeLongtitude.prototype.getData=function(){for(var e=[],t=[],r=[],n=[],i=0;i<=this._latitudeBands;i++)for(var o=i*Math.PI/this._latitudeBands,a=Math.sin(o),s=Math.cos(o),c=0;c<=this._longitudeBands;c++){var u=2*c*Math.PI/this._longitudeBands,l=Math.sin(u),h=Math.cos(u),d=this._radius*h*a,p=this._radius*s,f=this._radius*l*a,m=1-c/this._longitudeBands,g=1-i/this._latitudeBands;t.push(d),t.push(p),t.push(f),r.push(m),r.push(g),e.push(d),e.push(p),e.push(f)}for(var i=0;i<this._latitudeBands;i++)for(var c=0;c<this._longitudeBands;c++){var _=i*(this._longitudeBands+1)+c,y=_+this._longitudeBands+1;n.push(_+1),n.push(y),n.push(_),n.push(_+1),n.push(y+1),n.push(y)}return{vertices:e,indices:n,normals:t,texCoords:r}},GetDataByLatitudeLongtitude}()}(wd||(wd={}));var wd;!function(e){var t=function(t){function TriangleGeometry(){t.apply(this,arguments),this.width=null,this.height=null}return __extends(TriangleGeometry,t),TriangleGeometry.create=function(){var e=new this;return e},TriangleGeometry.prototype.computeData=function(){var t=this.width,r=this.height,n=-t/2,i=t/2,o=r/2,a=-r/2,s=null,c=null,u=null,l=null;return s=[0,o,0,n,a,0,i,a,0],u=[0,1,2],c=[.5,1,0,0,1,0],l=[0,0,1,0,0,1,0,0,1],{vertices:s,faces:e.GeometryUtils.convertToFaces(u,l),texCoords:c}},__decorate([e.cloneAttributeAsBasicType()],TriangleGeometry.prototype,"width",void 0),__decorate([e.cloneAttributeAsBasicType()],TriangleGeometry.prototype,"height",void 0),TriangleGeometry}(e.Geometry);e.TriangleGeometry=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function TerrainGeometry(){t.apply(this,arguments),this._rangeWidth=null,this._rangeHeight=null,this.heightMapAsset=null,this.subdivisions=2,this.minHeight=0,this.maxHeight=10,this.isHeightMapStoreHeightInEachPixel=!0,this._heightMapImageDataCache=null,this._heightMapImageDataCacheWidth=null,this._heightMapImageDataCacheHeight=null,this._heightCache=[]}return __extends(TerrainGeometry,t),TerrainGeometry.create=function(){var e=new this;return e},Object.defineProperty(TerrainGeometry.prototype,"rangeWidth",{get:function(){return null!==this._rangeWidth?this._rangeWidth:null!==this._heightMapImageDataCacheWidth?this.isHeightMapStoreHeightInEachPixel?4*this._heightMapImageDataCacheWidth:this._heightMapImageDataCacheWidth:256},set:function(e){this._rangeWidth=e},enumerable:!0,configurable:!0}),Object.defineProperty(TerrainGeometry.prototype,"rangeHeight",{get:function(){return null!==this._rangeHeight?this._rangeHeight:null!==this._heightMapImageDataCacheHeight?this._heightMapImageDataCacheHeight:256},set:function(e){this._rangeHeight=e},enumerable:!0,configurable:!0}),Object.defineProperty(TerrainGeometry.prototype,"heightMapImageDataWidth",{get:function(){return this._heightMapImageDataCacheWidth},enumerable:!0,configurable:!0}),Object.defineProperty(TerrainGeometry.prototype,"heightMapImageDataHeight",{get:function(){return this._heightMapImageDataCacheHeight},enumerable:!0,configurable:!0}),TerrainGeometry.prototype.getHeightAtCoordinates=function(e,t){var r=this.entityObject.transform,n=null;if(e+=this.rangeWidth/2,t+=this.rangeHeight/2,e>this.rangeWidth||t>this.rangeHeight||e<0||t<0)return 0;this._isReadHeightMapData()||this._readHeightMapData();var i=this._getQuadHeightMapCoordinateArr(this._getQuadSubdivisionsCoordinateArr(e,t)),o=this._getCacheHeight(i[0]),a=this._getCacheHeight(i[1]),s=this._getCacheHeight(i[2]),c=this._getCacheHeight(i[3]);return n=this._getBilinearInterpolatedHeight(i[4],o,a,s,c),n*r.scale.y+r.position.y},TerrainGeometry.prototype._getQuadSubdivisionsCoordinateArr=function(t,r){var n=[],i=this.subdivisions,o=t/this.rangeWidth*i,a=r/this.rangeHeight*i,s=Math.floor(o),c=Math.floor(a),u=null,l=null,h=null,d=null;return s<i?(u=s,l=s+1):(u=s-1,l=s),c<i?(h=c,d=c+1):(h=c-1,d=c),n.push(e.Vector2.create(u,h)),n.push(e.Vector2.create(l,h)),n.push(e.Vector2.create(l,d)),n.push(e.Vector2.create(u,d)),n.push(e.Vector2.create(o-u,a-h)),n},TerrainGeometry.prototype._getQuadHeightMapCoordinateArr=function(e){for(var t=0;t<=3;t++){var r=e[t];r.x=this._computeHeightMapColInCanvasCoordinate(r.x),r.y=this._computeHeightMapRowInCanvasCoordinate(r.y)}return e},TerrainGeometry.prototype._getBilinearInterpolatedHeight=function(e,t,r,n,i){return(t*(1-e.x)+r*e.x)*(1-e.y)+(n*e.x+i*(1-e.x))*e.y},TerrainGeometry.prototype._getCacheHeight=function(e){var t=e.x,r=e.y,n=this._computeHeightMapIndex(r,t),i=this._heightCache[n];if(void 0!==i)return i;var o=this._getHeightByReadHeightMapData(n);return this._heightCache[n]=o,o},TerrainGeometry.prototype.computeData=function(){return this._isReadHeightMapData()||this._readHeightMapData(),this._createGroundFromHeightMap()},TerrainGeometry.prototype._isReadHeightMapData=function(){return null!==this._heightMapImageDataCache},TerrainGeometry.prototype._readHeightMapData=function(){var e=this.heightMapAsset.source,t=e.width,r=e.height,n=document.createElement("canvas"),i=n.getContext("2d");n.width=t,n.height=r,i.drawImage(e,0,0),this._heightMapImageDataCache=i.getImageData(0,0,t,r).data,this._heightMapImageDataCacheWidth=t,this._heightMapImageDataCacheHeight=r},TerrainGeometry.prototype._createGroundFromHeightMap=function(){for(var t=[],r=[],n=[],i=this.subdivisions,o=this.rangeWidth,a=this.rangeHeight,s=this._heightCache,c=0;c<i;c++)for(var u=0;u<i;u++){var l=u*o/i-o/2,h=(i-c)*a/i-a/2,d=this._computeHeightMapRowInTexCoordCoordinate(c),p=this._computeHeightMapColInTexCoordCoordinate(u),f=this._computeHeightMapIndex(d,p),m=null;m=this._getHeightByReadHeightMapData(f),s[f]=m,t.push(l,m,h),n.push(u/i,1-c/i)}return{vertices:t,faces:e.GeometryUtils.convertToFaces(this._getIndices(),r),texCoords:n}},TerrainGeometry.prototype._computeHeightMapColInCanvasCoordinate=function(e){var t=Math.floor(e/this.subdivisions*this._heightMapImageDataCacheWidth);return t>0&&(t-=1),t},TerrainGeometry.prototype._computeHeightMapRowInCanvasCoordinate=function(e){var t=Math.floor(e/this.subdivisions*this._heightMapImageDataCacheHeight);return t>0&&(t-=1),t},TerrainGeometry.prototype._computeHeightMapColInTexCoordCoordinate=function(e){return this._computeHeightMapColInCanvasCoordinate(e)},TerrainGeometry.prototype._computeHeightMapRowInTexCoordCoordinate=function(e){var t=Math.floor((1-e/this.subdivisions)*this._heightMapImageDataCacheHeight);return t>0&&(t-=1),t},TerrainGeometry.prototype._computeHeightMapIndex=function(e,t){var r=4*(t+e*this._heightMapImageDataCacheWidth);return r},TerrainGeometry.prototype._getHeightByReadHeightMapData=function(e){var t=this._heightMapImageDataCache,r=t[e]/256,n=t[e+1]/256,i=t[e+2]/256,o=.3*r+.59*n+.11*i,a=this.minHeight,s=this.maxHeight;return a+(s-a)*o},TerrainGeometry.prototype._getIndices=function(){for(var e=[],t=this.subdivisions,r=0;r<t-1;r++)for(var n=0;n<t-1;n++)e.push(n+r*t),e.push(n+1+r*t),e.push(n+1+(r+1)*t),e.push(n+r*t),e.push(n+1+(r+1)*t),e.push(n+(r+1)*t);return e},__decorate([e.cloneAttributeAsBasicType()],TerrainGeometry.prototype,"rangeWidth",null),__decorate([e.cloneAttributeAsBasicType()],TerrainGeometry.prototype,"rangeHeight",null),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){t[n]&&(r[n]=e.ImageTextureAsset.create(t[n].source))})],TerrainGeometry.prototype,"heightMapAsset",void 0),__decorate([e.cloneAttributeAsBasicType()],TerrainGeometry.prototype,"subdivisions",void 0),__decorate([e.cloneAttributeAsBasicType()],TerrainGeometry.prototype,"minHeight",void 0),__decorate([e.cloneAttributeAsBasicType()],TerrainGeometry.prototype,"maxHeight",void 0),__decorate([e.cloneAttributeAsBasicType()],TerrainGeometry.prototype,"isHeightMapStoreHeightInEachPixel",void 0),TerrainGeometry}(e.Geometry);e.TerrainGeometry=t}(wd||(wd={}));var wd;!function(e){var t=function(){function GeometryData(e){this._vertices=null,this._faces=null,this._texCoords=null,this._colors=null,this._tangents=null,this.tangentDirty=!0,this.colorDirty=!0,this.geometry=null,this._normalCache=null,this._normalFromFaceCache=null,this._normalFromVertexCache=null,this._indiceCache=null,this._colorCache=null,this._normalDirty=!0,this._indiceDirty=!0,this._materialColorChangeSubscription=null,this.geometry=e}return Object.defineProperty(GeometryData.prototype,"vertices",{get:function(){return this._vertices},set:function(t){this._vertices=t,this.tangentDirty=!0,this.geometry.buffers.removeCache(e.EBufferDataType.VERTICE)},enumerable:!0,configurable:!0}),Object.defineProperty(GeometryData.prototype,"normals",{get:function(){var e=this.geometry;
return e.isSmoothShading()?(this.hasVertexNormals()||this.computeVertexNormals(),this.normalsFromVertexNormals):(this.hasFaceNormals()||this.computeFaceNormals(),this.normalsFromFaceNormal)},enumerable:!0,configurable:!0}),Object.defineProperty(GeometryData.prototype,"normalsFromFaceNormal",{get:function(){var t=null;return this.hasFaceNormals()?(t=[],this._faces.forEach(function(r){var n=r.faceNormal;e.GeometryUtils.setThreeComponent(t,n,r.aIndex),e.GeometryUtils.setThreeComponent(t,n,r.bIndex),e.GeometryUtils.setThreeComponent(t,n,r.cIndex)}),this._fillEmptyData(t),t):[]},enumerable:!0,configurable:!0}),Object.defineProperty(GeometryData.prototype,"normalsFromVertexNormals",{get:function(){var t=null;return this.hasVertexNormals()?(t=[],this._faces.forEach(function(r){e.GeometryUtils.setThreeComponent(t,r.vertexNormals.getChild(0),r.aIndex),e.GeometryUtils.setThreeComponent(t,r.vertexNormals.getChild(1),r.bIndex),e.GeometryUtils.setThreeComponent(t,r.vertexNormals.getChild(2),r.cIndex)}),this._fillEmptyData(t),t):[]},enumerable:!0,configurable:!0}),Object.defineProperty(GeometryData.prototype,"indices",{get:function(){for(var e=[],t=0,r=this._faces;t<r.length;t++){var n=r[t];e.push(n.aIndex,n.bIndex,n.cIndex)}return e},enumerable:!0,configurable:!0}),Object.defineProperty(GeometryData.prototype,"faces",{get:function(){return this._faces},set:function(t){this._faces=t,this.geometry.buffers.removeCache(e.EBufferDataType.NORMAL),this.geometry.buffers.removeCache(e.EBufferDataType.INDICE),this.onChangeFace()},enumerable:!0,configurable:!0}),Object.defineProperty(GeometryData.prototype,"texCoords",{get:function(){return this._texCoords},set:function(t){this._texCoords=t,this.tangentDirty=!0,this.geometry.buffers.removeCache(e.EBufferDataType.TEXCOORD)},enumerable:!0,configurable:!0}),Object.defineProperty(GeometryData.prototype,"colors",{get:function(){return this._colors},set:function(t){this._colors=t,this.colorDirty=!0,this.geometry.buffers.removeCache(e.EBufferDataType.COLOR)},enumerable:!0,configurable:!0}),Object.defineProperty(GeometryData.prototype,"tangents",{get:function(){return this.tangentDirty&&(this.tangentDirty=!1,e.GeometryUtils.hasData(this.normals)&&e.GeometryUtils.hasData(this.texCoords)&&e.GeometryUtils.hasData(this.indices)&&(this._tangents=this._calculateTangents(this._vertices,this.normals,this.texCoords,this.indices))),this._tangents},enumerable:!0,configurable:!0}),GeometryData.prototype.init=function(){var t=this;this._materialColorChangeSubscription=wdFrp.fromArray([e.EventManager.fromEvent(this.geometry.entityObject,e.EEngineEvent.MATERIAL_COLOR_CHANGE),e.EventManager.fromEvent(this.geometry.entityObject,e.EEngineEvent.MATERIAL_CHANGE)]).mergeAll().subscribe(function(){t._needGetColorsFromMaterial()&&(t.colorDirty=!0)})},GeometryData.prototype.dispose=function(){this._materialColorChangeSubscription&&this._materialColorChangeSubscription.dispose()},GeometryData.prototype.computeFaceNormals=function(){var t=this._vertices;if(!e.GeometryUtils.hasData(this.vertices))return void e.Log.warn("has no vertices data, can't compute face normals");for(var r=0,n=this._faces;r<n.length;r++){var i=n[r];i.faceNormal=this.computeFaceNormalsHelper(t,i.aIndex,i.bIndex,i.cIndex)}},GeometryData.prototype.computeVertexNormals=function(){var e=null;this.hasFaceNormals()||this.computeFaceNormals(),e=this.computeVertexNormalsHelper(this._vertices);for(var t=0,r=this._faces;t<r.length;t++){var n=r[t];n.vertexNormals=wdCb.Collection.create([e[n.aIndex],e[n.bIndex],e[n.cIndex]])}},GeometryData.prototype.hasFaceNormals=function(){for(var e=0,t=this._faces;e<t.length;e++){var r=t[e];if(!r.hasFaceNormal())return!1}return!0},GeometryData.prototype.hasVertexNormals=function(){for(var e=0,t=this._faces;e<t.length;e++){var r=t[e];if(!r.hasVertexNormal())return!1}return!0},GeometryData.prototype.hasColors=function(){return e.GeometryUtils.hasData(this._colors)},GeometryData.prototype.onChangeFace=function(){this.tangentDirty=!0,this._normalDirty=!0,this._indiceDirty=!0},GeometryData.prototype.computeFaceNormalsHelper=function(t,r,n,i){var o=e.GeometryUtils.getThreeComponent(t,r),a=e.GeometryUtils.getThreeComponent(t,n),s=e.GeometryUtils.getThreeComponent(t,i),c=e.Vector3.create().sub2(s,a),u=e.Vector3.create().sub2(o,a);return e.Vector3.create().cross(c,u).normalize()},GeometryData.prototype.computeVertexNormalsHelper=function(t){var r=t.length/3,n=null;n=new Array(r);for(var i=0;i<r;i++)n[i]=e.Vector3.create();for(var o=0,a=this._faces;o<a.length;o++){var s=a[o],c=null;c=s.faceNormal,n[s.aIndex].add(c),n[s.bIndex].add(c),n[s.cIndex].add(c)}for(var i=0;i<r;i++)n[i].normalize();return n},GeometryData.prototype._fillEmptyData=function(e){for(var t=0,r=e.length;t<r;t++)isNaN(e[t])&&(e[t]=0)},GeometryData.prototype._calculateTangents=function(t,r,n,i){var o,a,s,c,u,l,h,d,p,f,m,g,_,y,v,b=i.length/3,C=t.length/3,E=e.Vector3.create(),S=e.Vector3.create(),T=e.Vector3.create(),M=e.Vector3.create(),D=e.Vector3.create(),L=e.Vector2.create(),w=e.Vector2.create(),x=e.Vector2.create(),O=new Float32Array(3*C),A=new Float32Array(3*C),R=e.Vector3.create(),I=e.Vector3.create(),N=[];for(v=0;v<b;v++)o=i[3*v],a=i[3*v+1],s=i[3*v+2],T.set(t[3*o],t[3*o+1],t[3*o+2]),M.set(t[3*a],t[3*a+1],t[3*a+2]),D.set(t[3*s],t[3*s+1],t[3*s+2]),L.set(n[2*o],n[2*o+1]),w.set(n[2*a],n[2*a+1]),x.set(n[2*s],n[2*s+1]),c=M.x-T.x,u=D.x-T.x,l=M.y-T.y,h=D.y-T.y,d=M.z-T.z,p=D.z-T.z,f=w.x-L.x,m=x.x-L.x,g=w.y-L.y,_=x.y-L.y,y=1/(f*_-m*g),E.set((_*c-g*u)*y,(_*l-g*h)*y,(_*d-g*p)*y),S.set((f*u-m*c)*y,(f*h-m*l)*y,(f*p-m*d)*y),O[3*o+0]+=E.x,O[3*o+1]+=E.y,O[3*o+2]+=E.z,O[3*a+0]+=E.x,O[3*a+1]+=E.y,O[3*a+2]+=E.z,O[3*s+0]+=E.x,O[3*s+1]+=E.y,O[3*s+2]+=E.z,A[3*o+0]+=S.x,A[3*o+1]+=S.y,A[3*o+2]+=S.z,A[3*a+0]+=S.x,A[3*a+1]+=S.y,A[3*a+2]+=S.z,A[3*s+0]+=S.x,A[3*s+1]+=S.y,A[3*s+2]+=S.z;for(g=e.Vector3.create(),_=e.Vector3.create(),v=0;v<C;v++){var B=null;R.set(r[3*v],r[3*v+1],r[3*v+2]),g.set(O[3*v],O[3*v+1],O[3*v+2]),_.set(A[3*v],A[3*v+1],A[3*v+2]),B=R.dot(g),I=R.clone().scale(B),I.sub2(g,I).normalize(),N[4*v]=I.x,N[4*v+1]=I.y,N[4*v+2]=I.z,I.cross(R,g),N[4*v+3]=I.dot(_)<0?-1:1}return N},GeometryData.prototype._needGetColorsFromMaterial=function(){var e=this._colors;return!e||0===e.length},__decorate([e.requireGetter(function(){e.assert(this._faces.length>0,e.Log.info.FUNC_SHOULD("faces.count","> 0"));for(var t=0,r=this._faces;t<r.length;t++){var n=r[t];this.geometry.isSmoothShading()&&e.assert(n.vertexNormals&&3===n.vertexNormals.getCount(),e.Log.info.FUNC_SHOULD("faces->vertexNormals.count","=== 3"))}}),e.cacheGetter(function(){return!this._normalDirty&&this._normalCache},function(){return this._normalCache},function(e){this._normalCache=e,this._normalDirty=!1})],GeometryData.prototype,"normals",null),__decorate([e.requireGetter(function(){e.assert(this._faces.length>0,e.Log.info.FUNC_SHOULD("geometry","has faces"))}),e.ensureGetter(function(t){for(var r=0,n=t;r<n.length;r++){var i=n[r];e.assert(e.JudgeUtils.isNumber(i),e.Log.info.FUNC_SHOULD("normals data","be number"))}}),e.cacheGetter(function(){return!this._normalDirty&&this._normalFromFaceCache},function(){return this._normalFromFaceCache},function(e){this._normalFromFaceCache=e,this._normalDirty=!1})],GeometryData.prototype,"normalsFromFaceNormal",null),__decorate([e.requireGetter(function(){e.assert(this._faces.length>0,e.Log.info.FUNC_SHOULD("geometry","has faces"))}),e.ensureGetter(function(t){for(var r=0,n=t;r<n.length;r++){var i=n[r];e.assert(e.JudgeUtils.isNumber(i),e.Log.info.FUNC_SHOULD("normals data","be number"))}}),e.cacheGetter(function(){return!this._normalDirty&&this._normalFromVertexCache},function(){return this._normalFromVertexCache},function(e){this._normalFromVertexCache=e,this._normalDirty=!1})],GeometryData.prototype,"normalsFromVertexNormals",null),__decorate([e.cacheGetter(function(){return!this._indiceDirty&&this._indiceCache},function(){return this._indiceCache},function(e){this._indiceCache=e,this._indiceDirty=!1})],GeometryData.prototype,"indices",null),__decorate([e.ensureGetter(function(t){e.assert(t.length===this._vertices.length,e.Log.info.FUNC_SHOULD("colors.length:"+t.length,"=== vertices.length:"+this._vertices.length))}),e.cacheGetter(function(){return!this.colorDirty&&this._colorCache},function(){return this._colorCache},function(e){this._colorCache=e,this.colorDirty=!1})],GeometryData.prototype,"colors",null),__decorate([e.ensure(function(){for(var t=0,r=this._faces;t<r.length;t++){var n=r[t];e.assert(n.faceNormal instanceof e.Vector3,e.Log.info.FUNC_SHOULD_NOT("faceNormal","be null"))}})],GeometryData.prototype,"computeFaceNormals",null),__decorate([e.virtual],GeometryData.prototype,"onChangeFace",null),GeometryData}();e.GeometryData=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BasicGeometryData(){e.apply(this,arguments)}return __extends(BasicGeometryData,e),BasicGeometryData.create=function(e){var t=new this(e);return t},BasicGeometryData}(e.GeometryData);e.BasicGeometryData=t}(wd||(wd={}));var wd;!function(e){var t=function(){function BufferContainer(e){this.geometryData=null,this.entityObject=null,this.container=wdCb.Hash.create(),this._colorBuffer=null,this._texCoordBuffer=null,this._tangentBuffer=null,this._indiceBuffer=null,this._materialChangeSubscription=null,this.entityObject=e}return BufferContainer.prototype.createBuffersFromGeometryData=function(){this.getChild(e.EBufferDataType.VERTICE),this.getChild(e.EBufferDataType.NORMAL),this.getChild(e.EBufferDataType.TANGENT),this.getChild(e.EBufferDataType.COLOR),this.getChild(e.EBufferDataType.INDICE),this.getChild(e.EBufferDataType.TEXCOORD)},BufferContainer.prototype.init=function(){var t=this;this._materialChangeSubscription=e.EventManager.fromEvent(this.entityObject,e.EEngineEvent.MATERIAL_CHANGE).subscribe(function(){t.removeCache(e.EBufferDataType.COLOR),t.geometryData.colorDirty=!0}),this.geometryData.init()},BufferContainer.prototype.removeCache=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];this.container.removeChild(e[0])},BufferContainer.prototype.getChild=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=t[0],i=null;switch(n){case e.EBufferDataType.VERTICE:i=this.getVertice(n);break;case e.EBufferDataType.NORMAL:i=this.getNormal(n);break;case e.EBufferDataType.TANGENT:i=this._getTangent(n);break;case e.EBufferDataType.COLOR:i=this._getColor(n);break;case e.EBufferDataType.INDICE:i=this._getIndice(n);break;case e.EBufferDataType.TEXCOORD:i=this._getTexCoord(n);break;case e.EBufferDataType.CUSTOM:i=this.getCustomData(t[1]);break;default:i=this.getBuffer(n)}return i},BufferContainer.prototype.dispose=function(){this.container.forEach(function(e){e.dispose()}),this.geometryData.dispose(),this._materialChangeSubscription&&this._materialChangeSubscription.dispose()},BufferContainer.prototype.getCustomData=function(e){return null},BufferContainer.prototype.getBuffer=function(t){return e.Log.error(!0,wdCb.Log.info.FUNC_UNKNOW("EBufferDataType: "+t)),null},BufferContainer.prototype.createOnlyOnceAndUpdateArrayBuffer=function(t,r,n,i,o,a){void 0===i&&(i=e.EBufferType.FLOAT),void 0===o&&(o=0),void 0===a&&(a=e.EBufferUsage.STATIC_DRAW);var s=this[t];return s?void s.resetData(r,n,i,o):void(this[t]=e.ArrayBuffer.create(r,n,i,a))},BufferContainer.prototype.createOnlyOnceAndUpdateElememntBuffer=function(t,r,n,i,o){void 0===n&&(n=null),void 0===i&&(i=0),void 0===o&&(o=e.EBufferUsage.STATIC_DRAW);var a=this[t];return a?void a.resetData(r,n,i):void(this[t]=e.ElementBuffer.create(r,n,o))},BufferContainer.prototype.hasData=function(e){return!!e&&e.length>0},BufferContainer.prototype._getTangent=function(t){var r=null;return r=this.geometryData[e.BufferDataTable.getGeometryDataName(t)],this.hasData(r)?(this.createOnlyOnceAndUpdateArrayBuffer("_tangentBuffer",r,3),this._tangentBuffer):null},BufferContainer.prototype._getColor=function(t){var r=null;return r=this.geometryData[e.BufferDataTable.getGeometryDataName(t)],this.hasData(r)?(this.createOnlyOnceAndUpdateArrayBuffer("_colorBuffer",r,3),this._colorBuffer):null},BufferContainer.prototype._getIndice=function(t){var r=null;return r=this.geometryData[e.BufferDataTable.getGeometryDataName(t)],this.hasData(r)?(this.createOnlyOnceAndUpdateElememntBuffer("_indiceBuffer",r),this._indiceBuffer):null},BufferContainer.prototype._getTexCoord=function(t){var r=null;return r=this.geometryData[e.BufferDataTable.getGeometryDataName(t)],this.hasData(r)?(this.createOnlyOnceAndUpdateArrayBuffer("_texCoordBuffer",r,2),this._texCoordBuffer):null},BufferContainer.prototype._needReCalcuteTangent=function(t){return this.geometryData.tangentDirty&&t===e.EBufferDataType.TANGENT},__decorate([e.virtual],BufferContainer.prototype,"createBuffersFromGeometryData",null),__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];e.it("test arguments",function(){if(2===t.length){var r=t[1];e.expect(r).exist,e.expect(r).be.a("string")}})})],BufferContainer.prototype,"getChild",null),__decorate([e.virtual],BufferContainer.prototype,"getCustomData",null),__decorate([e.virtual],BufferContainer.prototype,"getBuffer",null),__decorate([e.cache(function(e){return this.container.hasChild(e)&&!this._needReCalcuteTangent(e)},function(e){return this.container.getChild(e)},function(e,t){this.container.addChild(t,e)})],BufferContainer.prototype,"_getTangent",null),__decorate([e.cache(function(e){return this.container.hasChild(e)},function(e){return this.container.getChild(e)},function(e,t){this.container.addChild(t,e)})],BufferContainer.prototype,"_getColor",null),__decorate([e.cache(function(e){return this.container.hasChild(e)},function(e){return this.container.getChild(e)},function(e,t){this.container.addChild(t,e)})],BufferContainer.prototype,"_getIndice",null),__decorate([e.cache(function(e){return this.container.hasChild(e)},function(e){return this.container.getChild(e)},function(e,t){this.container.addChild(t,e)})],BufferContainer.prototype,"_getTexCoord",null),BufferContainer}();e.BufferContainer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CommonBufferContainer(){t.apply(this,arguments),this._verticeBuffer=null,this._normalBuffer=null}return __extends(CommonBufferContainer,t),CommonBufferContainer.prototype.getBufferForRenderSort=function(){var t=this.getChild(e.EBufferDataType.VERTICE);return t?t:null},CommonBufferContainer.prototype.getVertice=function(t){var r=this.geometryData[e.BufferDataTable.getGeometryDataName(t)];return this.hasData(r)?(this.createOnlyOnceAndUpdateArrayBuffer("_verticeBuffer",r,3),this._verticeBuffer):null},CommonBufferContainer.prototype.getNormal=function(t){var r=this.geometryData[e.BufferDataTable.getGeometryDataName(t)];return this.hasData(r)?(this.createOnlyOnceAndUpdateArrayBuffer("_normalBuffer",r,3),this._normalBuffer):null},__decorate([e.cacheBufferForBufferContainer()],CommonBufferContainer.prototype,"getVertice",null),__decorate([e.cacheBufferForBufferContainer()],CommonBufferContainer.prototype,"getNormal",null),CommonBufferContainer}(e.BufferContainer);e.CommonBufferContainer=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BasicBufferContainer(){e.apply(this,arguments)}return __extends(BasicBufferContainer,e),BasicBufferContainer.create=function(e){var t=new this(e);return t},BasicBufferContainer}(e.CommonBufferContainer);e.BasicBufferContainer=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Camera(){this._worldToCameraMatrix=null,this._near=null,this._far=null,this.pMatrix=e.Matrix4.create(),this.entityObject=null,this.dirty=!1}return Object.defineProperty(Camera.prototype,"cameraToWorldMatrix",{get:function(){return this.entityObject.transform.localToWorldMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(Camera.prototype,"worldToCameraMatrix",{get:function(){return this._worldToCameraMatrix?this._worldToCameraMatrix:this.cameraToWorldMatrix.clone().invert()},set:function(e){this._worldToCameraMatrix=e},enumerable:!0,configurable:!0}),Object.defineProperty(Camera.prototype,"near",{get:function(){return this._near},set:function(e){this._near=e,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(Camera.prototype,"far",{get:function(){return this._far},set:function(e){this._far=e,this.dirty=!0},enumerable:!0,configurable:!0}),Camera.prototype.init=function(){this.dirty&&(this.updateProjectionMatrix(),this.dirty=!1)},Camera.prototype.dispose=function(){},Camera.prototype.clone=function(){return e.CloneUtils.clone(this)},Camera.prototype.update=function(e){this.dirty&&(this.updateProjectionMatrix(),this.dirty=!1)},Camera.prototype.getInvViewProjMat=function(){return this.pMatrix.clone().multiply(this.worldToCameraMatrix).invert()},__decorate([e.requireGetter(function(){e.assert(this.entityObject,e.Log.info.FUNC_MUST_DEFINE("entityObject"))})],Camera.prototype,"cameraToWorldMatrix",null),__decorate([e.cloneAttributeAsBasicType()],Camera.prototype,"near",null),__decorate([e.cloneAttributeAsBasicType()],Camera.prototype,"far",null),__decorate([e.cloneAttributeAsCloneable()],Camera.prototype,"pMatrix",void 0),__decorate([e.virtual],Camera.prototype,"init",null),__decorate([e.virtual],Camera.prototype,"dispose",null),Camera}();e.Camera=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function OrthographicCamera(){t.apply(this,arguments),this._left=null,this._right=null,this._bottom=null,this._top=null}return __extends(OrthographicCamera,t),OrthographicCamera.create=function(){var e=new this;return e},Object.defineProperty(OrthographicCamera.prototype,"left",{get:function(){return this._left},set:function(e){this._left=e,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(OrthographicCamera.prototype,"right",{get:function(){return this._right},set:function(e){this._right=e,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(OrthographicCamera.prototype,"bottom",{get:function(){return this._bottom},set:function(e){this._bottom=e,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(OrthographicCamera.prototype,"top",{get:function(){return this._top},set:function(e){this._top=e,this.dirty=!0},enumerable:!0,configurable:!0}),OrthographicCamera.prototype.convertScreenToWorld=function(t,r,n){var i=e.DeviceManager.getInstance(),o=i.view.width,a=i.view.height,s=e.Vector3.create(2*t/o-1,(a-r)/a*2-1,(n-this.far)/(this.far-this.near)*2+1);return this.getInvViewProjMat().multiplyPoint(s)},OrthographicCamera.prototype.convertWorldToScreen=function(t,r,n,i,o){return e.Log.error(!0,"need implement"),null},OrthographicCamera.prototype.updateProjectionMatrix=function(){this.pMatrix.setOrtho(this._left,this._right,this._bottom,this._top,this.near,this.far)},__decorate([e.cloneAttributeAsBasicType()],OrthographicCamera.prototype,"left",null),__decorate([e.cloneAttributeAsBasicType()],OrthographicCamera.prototype,"right",null),__decorate([e.cloneAttributeAsBasicType()],OrthographicCamera.prototype,"bottom",null),__decorate([e.cloneAttributeAsBasicType()],OrthographicCamera.prototype,"top",null),OrthographicCamera}(e.Camera);e.OrthographicCamera=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function PerspectiveCamera(){t.apply(this,arguments),this._fovy=null,this._aspect=null}return __extends(PerspectiveCamera,t),PerspectiveCamera.create=function(){var e=new this;return e},Object.defineProperty(PerspectiveCamera.prototype,"fovy",{get:function(){return this._fovy},set:function(e){this._fovy=e,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(PerspectiveCamera.prototype,"aspect",{get:function(){return this._aspect},set:function(e){this._aspect=e,this.dirty=!0},enumerable:!0,configurable:!0}),PerspectiveCamera.prototype.zoomIn=function(e,t){void 0===t&&(t=1),this.fovy=Math.max(this.fovy-e,t)},PerspectiveCamera.prototype.zoomOut=function(e,t){void 0===t&&(t=179),this.fovy=Math.min(this.fovy+e,t)},PerspectiveCamera.prototype.convertScreenToWorld=function(t,r,n){var i=e.DeviceManager.getInstance(),o=i.view.width,a=i.view.height,s=e.Vector3.create(2*t/o-1,1-2*r/a,1),c=this.getInvViewProjMat(),u=null,l=null;return u=c.multiplyPoint(s),l=s.x*c.values[3]+s.y*c.values[7]+s.z*c.values[11]+c.values[15],u.scale(1/l),e.Vector3.create().lerp(this.entityObject.transform.position,u,n/this.far)},PerspectiveCamera.prototype.convertWorldToScreen=function(t,r,n,i,o){var a=this.worldToCameraMatrix.clone().applyMatrix(this.pMatrix),s=a.multiplyVector4(e.Vector4.create(t,r,n,1)),c=e.Vector3.create(s.x/s.w,s.y/s.w,s.z/s.w);return e.Vector2.create(Math.round((c.x+1)/2*i),Math.round((1-c.y)/2*o))},PerspectiveCamera.prototype.updateProjectionMatrix=function(){this.pMatrix.setPerspective(this._fovy,this._aspect,this.near,this.far)},__decorate([e.cloneAttributeAsBasicType()],PerspectiveCamera.prototype,"fovy",null),__decorate([e.cloneAttributeAsBasicType()],PerspectiveCamera.prototype,"aspect",null),PerspectiveCamera}(e.Camera);e.PerspectiveCamera=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CameraController(e){t.call(this),this.camera=null,this._worldToCameraMatrixCache=null,this._clearCacheSubscription=null,this.camera=e}return __extends(CameraController,t),Object.defineProperty(CameraController.prototype,"cameraToWorldMatrix",{get:function(){return this.camera.cameraToWorldMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(CameraController.prototype,"worldToCameraMatrix",{get:function(){return this._getWorldToCameraMatrix()},set:function(e){this.camera.worldToCameraMatrix=e},enumerable:!0,configurable:!0}),Object.defineProperty(CameraController.prototype,"pMatrix",{get:function(){return this.camera.pMatrix},set:function(e){this.camera.pMatrix=e},enumerable:!0,configurable:!0}),CameraController.prototype.init=function(){this.camera.entityObject=this.entityObject,this.camera.init(),this.bindClearCacheEvent()},CameraController.prototype.update=function(e){this.camera.update(e)},CameraController.prototype.dispose=function(){this.camera.dispose(),this.disposeClearCacheEvent()},CameraController.prototype.clone=function(){return e.CloneUtils.clone(this)},CameraController.prototype.isIntersectWithRay=function(t,r,n){var i=null;return!!t.hasComponent(e.Collider)&&(i=t.getComponent(e.Collider).shape,i.isIntersectWithRay(this.createRay(r,n)))},CameraController.prototype.createRay=function(t,r){var n=this.convertScreenToWorld(t,r,this.camera.near),i=this.convertScreenToWorld(t,r,this.camera.far);return e.Ray.create(n,i.sub(n))},CameraController.prototype.convertScreenToWorld=function(e,t,r){return this.camera.convertScreenToWorld(e,t,r)},CameraController.prototype.convertWorldToScreen=function(e,t,r,n,i){return this.camera.convertWorldToScreen(e,t,r,n,i)},CameraController.prototype.getPlanes=function(){for(var t=[],r=this.worldToCameraMatrix.applyMatrix(this.pMatrix,!0),n=0;n<6;n++)t.push(e.Plane.create(0,0,0,0));return this._setPlanes(r,t),t},CameraController.prototype.bindClearCacheEvent=function(){var t=this;this._clearCacheSubscription=wdFrp.fromArray([e.EventManager.fromEvent(e.EEngineEvent.ENDLOOP),e.EventManager.fromEvent(this.entityObject,e.EEngineEvent.TRANSFORM_TRANSLATE),e.EventManager.fromEvent(this.entityObject,e.EEngineEvent.TRANSFORM_ROTATE),e.EventManager.fromEvent(this.entityObject,e.EEngineEvent.TRANSFORM_SCALE)]).mergeAll().subscribe(function(){t._clearCache()})},CameraController.prototype.disposeClearCacheEvent=function(){this._clearCacheSubscription&&this._clearCacheSubscription.dispose()},CameraController.prototype._setPlanes=function(e,t){t[0].normal.x=e.values[3]+e.values[2],t[0].normal.y=e.values[7]+e.values[6],t[0].normal.z=e.values[11]+e.values[10],t[0].d=e.values[15]+e.values[14],t[0].normalize(),t[1].normal.x=e.values[3]-e.values[2],t[1].normal.y=e.values[7]-e.values[6],t[1].normal.z=e.values[11]-e.values[10],t[1].d=e.values[15]-e.values[14],t[1].normalize(),t[2].normal.x=e.values[3]+e.values[0],t[2].normal.y=e.values[7]+e.values[4],t[2].normal.z=e.values[11]+e.values[8],t[2].d=e.values[15]+e.values[12],t[2].normalize(),t[3].normal.x=e.values[3]-e.values[0],t[3].normal.y=e.values[7]-e.values[4],t[3].normal.z=e.values[11]-e.values[8],t[3].d=e.values[15]-e.values[12],t[3].normalize(),t[4].normal.x=e.values[3]-e.values[1],t[4].normal.y=e.values[7]-e.values[5],t[4].normal.z=e.values[11]-e.values[9],t[4].d=e.values[15]-e.values[13],t[4].normalize(),t[5].normal.x=e.values[3]+e.values[1],t[5].normal.y=e.values[7]+e.values[5],t[5].normal.z=e.values[11]+e.values[9],t[5].d=e.values[15]+e.values[13],t[5].normalize()},CameraController.prototype._clearCache=function(){this._worldToCameraMatrixCache=null},CameraController.prototype._getWorldToCameraMatrix=function(){return this.camera.worldToCameraMatrix},__decorate([e.cacheGetter(function(){return null!==this._worldToCameraMatrixCache},function(){return this._worldToCameraMatrixCache},function(e){this._worldToCameraMatrixCache=e})],CameraController.prototype,"worldToCameraMatrix",null),__decorate([e.cloneAttributeAsCloneable()],CameraController.prototype,"camera",void 0),__decorate([e.virtual],CameraController.prototype,"bindClearCacheEvent",null),__decorate([e.virtual],CameraController.prototype,"disposeClearCacheEvent",null),CameraController}(e.Component);e.CameraController=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function RenderTargetRendererCameraController(){e.apply(this,arguments)}return __extends(RenderTargetRendererCameraController,e),RenderTargetRendererCameraController.create=function(e){var t=new this(e);return t},RenderTargetRendererCameraController.prototype.bindClearCacheEvent=function(){},RenderTargetRendererCameraController.prototype.disposeClearCacheEvent=function(){},RenderTargetRendererCameraController}(e.CameraController);e.RenderTargetRendererCameraController=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BasicCameraController(){e.apply(this,arguments)}return __extends(BasicCameraController,e),BasicCameraController.create=function(e){var t=new this(e);return t},BasicCameraController}(e.CameraController);e.BasicCameraController=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function FlyCameraController(r){t.call(this,r),this._control=null,r instanceof e.PerspectiveCamera?this._control=e.FlyPerspectiveCameraControl.create(r):this._control=e.FlyOrthographicCameraControl.create(r)}return __extends(FlyCameraController,t),FlyCameraController.create=function(e){var t=new this(e);return t},Object.defineProperty(FlyCameraController.prototype,"moveSpeed",{get:function(){return this._control.moveSpeed},set:function(e){this._control.moveSpeed=e},enumerable:!0,configurable:!0}),Object.defineProperty(FlyCameraController.prototype,"rotateSpeed",{get:function(){return this._control.rotateSpeed},set:function(e){this._control.rotateSpeed=e},enumerable:!0,configurable:!0}),Object.defineProperty(FlyCameraController.prototype,"zoomSpeed",{get:function(){return this._control.zoomSpeed},set:function(e){this._control.zoomSpeed=e},enumerable:!0,configurable:!0}),FlyCameraController.prototype.init=function(){t.prototype.init.call(this),this._control.init(this.entityObject)},FlyCameraController.prototype.update=function(e){t.prototype.update.call(this,e),this._control.update(e)},FlyCameraController.prototype.dispose=function(){t.prototype.dispose.call(this),this._control.dispose()},__decorate([e.cloneAttributeAsBasicType()],FlyCameraController.prototype,"moveSpeed",null),__decorate([e.cloneAttributeAsBasicType()],FlyCameraController.prototype,"rotateSpeed",null),__decorate([e.requireGetterAndSetter(function(){e.assert(this._control instanceof e.FlyPerspectiveCameraControl,e.Log.info.FUNC_MUST_BE("FlyPerspectiveCameraControl"))},function(){e.assert(this._control instanceof e.FlyPerspectiveCameraControl,e.Log.info.FUNC_MUST_BE("FlyPerspectiveCameraControl"))}),e.cloneAttributeAsBasicType()],FlyCameraController.prototype,"zoomSpeed",null),FlyCameraController}(e.CameraController);e.FlyCameraController=t}(wd||(wd={}));var wd;!function(e){var t=function(){function FlyCameraControl(e){this.moveSpeed=1.2,this.rotateSpeed=100,this.cameraComponent=null,this._rotateX=0,this._rotateY=0,this._isRotate=!1,this._pointDragSubscription=null,this._keydownSubscription=null,this._gameObject=null,this.cameraComponent=e}return FlyCameraControl.prototype.init=function(e){var t=e.transform.eulerAngles;this._rotateX=t.x,this._rotateY=t.y,this._gameObject=e,this._bindCanvasEvent(),this._updateTransform(),this._isRotate=!1},FlyCameraControl.prototype.update=function(e){this._isRotate&&(this._isRotate=!1,this._updateTransform())},FlyCameraControl.prototype.dispose=function(){this._removeEvent()},FlyCameraControl.prototype._move=function(t){var r=this.moveSpeed,n=this._gameObject,i=t.keyState;i.a||i.left?n.transform.translateLocal(e.Vector3.create(-r,0,0)):i.d||i.right?n.transform.translateLocal(e.Vector3.create(r,0,0)):i.w||i.up?n.transform.translateLocal(e.Vector3.create(0,0,-r)):(i.s||i.down)&&n.transform.translateLocal(e.Vector3.create(0,0,r))},FlyCameraControl.prototype._bindCanvasEvent=function(){var t=this,r=this.rotateSpeed,n=e.EventManager.fromEvent(e.Director.getInstance().scene,e.EEngineEvent.POINT_DRAG),i=e.EventManager.fromEvent(e.EEventName.KEYDOWN),o=e.Director.getInstance().view;this._pointDragSubscription=n.map(function(e){var n=e.userData.movementDelta,i=null,a=null,s=r/o.height;return i=s*n.x,a=s*n.y,t._isRotate=!0,{dx:i,dy:a}}).subscribe(function(e){t._changeRotation(e)}),this._keydownSubscription=i.subscribe(function(e){t._move(e),t.zoom(e)})},FlyCameraControl.prototype._changeRotation=function(e){var t=e.dx,r=e.dy;this._rotateY-=t,this._rotateX-=r},FlyCameraControl.prototype._removeEvent=function(){this._pointDragSubscription.dispose(),this._keydownSubscription.dispose()},FlyCameraControl.prototype._updateTransform=function(){this._gameObject.transform.eulerAngles=e.Vector3.create(this._rotateX,this._rotateY,0)},FlyCameraControl}();e.FlyCameraControl=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function FlyPerspectiveCameraControl(){e.apply(this,arguments),this.zoomSpeed=10}return __extends(FlyPerspectiveCameraControl,e),FlyPerspectiveCameraControl.create=function(e){var t=new this(e);return t},FlyPerspectiveCameraControl.prototype.zoom=function(e){var t=this.zoomSpeed,r=e.keyState;r.g?this.cameraComponent.zoomIn(t):r.h&&this.cameraComponent.zoomOut(t)},FlyPerspectiveCameraControl}(e.FlyCameraControl);e.FlyPerspectiveCameraControl=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function FlyOrthographicCameraControl(){e.apply(this,arguments)}return __extends(FlyOrthographicCameraControl,e),FlyOrthographicCameraControl.create=function(e){var t=new this(e);return t},FlyOrthographicCameraControl.prototype.zoom=function(e){},FlyOrthographicCameraControl}(e.FlyCameraControl);e.FlyOrthographicCameraControl=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ArcballCameraController(){t.apply(this,arguments),this._distance=10,this._minDistance=.05,this._phi=Math.PI/2,this._theta=Math.PI/2,this._thetaMargin=.05,this._target=e.Vector3.create(0,0,0),this.moveSpeedX=1,this.moveSpeedY=1,this.rotateSpeed=1,this.wheelSpeed=1,this._isChange=!0,this._pointDragSubscription=null,this._pointWheelSubscription=null,this._keydownSubscription=null}return __extends(ArcballCameraController,t),ArcballCameraController.create=function(e){var t=new this(e);return t},Object.defineProperty(ArcballCameraController.prototype,"distance",{get:function(){return this._distance},set:function(e){this._distance!==e&&this._changeDistance(e)},enumerable:!0,configurable:!0}),Object.defineProperty(ArcballCameraController.prototype,"minDistance",{get:function(){return this._minDistance},set:function(e){this._minDistance=e,e>this._distance&&this._changeDistance(e)},enumerable:!0,configurable:!0}),Object.defineProperty(ArcballCameraController.prototype,"phi",{get:function(){return this._phi},set:function(e){this._phi!==e&&this._changePhi(e)},enumerable:!0,configurable:!0}),Object.defineProperty(ArcballCameraController.prototype,"theta",{
get:function(){return this._theta},set:function(e){this._theta!==e&&this._changeTheta(e)},enumerable:!0,configurable:!0}),Object.defineProperty(ArcballCameraController.prototype,"thetaMargin",{get:function(){return this._thetaMargin},set:function(e){this._thetaMargin!==e&&(this._thetaMargin=e,this._constrainTheta())},enumerable:!0,configurable:!0}),Object.defineProperty(ArcballCameraController.prototype,"target",{get:function(){return this._target},set:function(e){this._target.isEqual(e)||this._changeTarget(e)},enumerable:!0,configurable:!0}),ArcballCameraController.prototype.init=function(){t.prototype.init.call(this),this._bindCanvasEvent(),this._updateTransform(),this._isChange=!1},ArcballCameraController.prototype.update=function(e){t.prototype.update.call(this,e),this._isChange&&(this._isChange=!1,this._updateTransform())},ArcballCameraController.prototype.dispose=function(){t.prototype.dispose.call(this),this._removeEvent()},ArcballCameraController.prototype._bindCanvasEvent=function(){var t=this,r=e.Director.getInstance().scene,n=e.EventManager.fromEvent(r,e.EEngineEvent.POINT_SCALE),i=e.EventManager.fromEvent(r,e.EEngineEvent.POINT_DRAG),o=e.EventManager.fromEvent(e.EEventName.KEYDOWN);this._pointDragSubscription=i.subscribe(function(e){t._changeOrbit(e.userData)}),this._pointWheelSubscription=n.subscribe(function(e){var r=e.userData;r.preventDefault(),t._changeDistance(r)}),this._keydownSubscription=o.subscribe(function(e){t._changeTarget(e)})},ArcballCameraController.prototype._changeOrbit=function(e){var t=e.movementDelta;this._isChange=!0,this._changePhi(this._phi+t.x/(100/this.rotateSpeed)),this._changeTheta(this._theta-t.y/(100/this.rotateSpeed))},ArcballCameraController.prototype._changePhi=function(e){this._isChange=!0,this._phi=e},ArcballCameraController.prototype._changeTheta=function(e){this._isChange=!0,this._theta=e,this._constrainTheta()},ArcballCameraController.prototype._changeTarget=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(this._isChange=!0,t[0]instanceof e.Vector3)this._target=t[0];else{var n=t[0],i=this.moveSpeedX,o=this.moveSpeedY,a=null,s=null,c=n.keyState,u=this.entityObject.transform;c.a||c.left?a=-i:c.d||c.right?a=i:c.w||c.up?s=o:(c.s||c.down)&&(s=-o),this._target.add(e.Vector3.create(u.right.x*a,0,u.right.z*a)),this._target.add(e.Vector3.create(u.up.x*s,u.up.y*s,0))}},ArcballCameraController.prototype._changeDistance=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(this._isChange=!0,e.JudgeUtils.isNumber(t[0]))this._distance=t[0];else{var n=t[0];this._distance-=this.wheelSpeed*n.wheel}this._constrainDistance()},ArcballCameraController.prototype._constrainDistance=function(){this.distance=e.MathUtils.bigThan(this.distance,this.minDistance)},ArcballCameraController.prototype._constrainTheta=function(){this._theta=e.MathUtils.clamp(this._theta,this._thetaMargin,Math.PI-this._thetaMargin)},ArcballCameraController.prototype._removeEvent=function(){this._pointDragSubscription.dispose(),this._pointWheelSubscription.dispose(),this._keydownSubscription.dispose()},ArcballCameraController.prototype._updateTransform=function(){var t=null,r=null,n=null;t=this.distance*Math.cos(this.phi)*Math.sin(this.theta)+this.target.x,n=this.distance*Math.sin(this.phi)*Math.sin(this.theta)+this.target.z,r=this.distance*Math.cos(this.theta)+this.target.y,this.entityObject.transform.position=e.Vector3.create(t,r,n),this.entityObject.transform.lookAt(this.target)},__decorate([e.cloneAttributeAsBasicType()],ArcballCameraController.prototype,"distance",null),__decorate([e.cloneAttributeAsBasicType()],ArcballCameraController.prototype,"minDistance",null),__decorate([e.cloneAttributeAsBasicType()],ArcballCameraController.prototype,"phi",null),__decorate([e.cloneAttributeAsBasicType()],ArcballCameraController.prototype,"theta",null),__decorate([e.cloneAttributeAsBasicType()],ArcballCameraController.prototype,"thetaMargin",null),__decorate([e.cloneAttributeAsCloneable()],ArcballCameraController.prototype,"target",null),__decorate([e.cloneAttributeAsBasicType()],ArcballCameraController.prototype,"moveSpeedX",void 0),__decorate([e.cloneAttributeAsBasicType()],ArcballCameraController.prototype,"moveSpeedY",void 0),__decorate([e.cloneAttributeAsBasicType()],ArcballCameraController.prototype,"rotateSpeed",void 0),__decorate([e.cloneAttributeAsBasicType()],ArcballCameraController.prototype,"wheelSpeed",void 0),__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];e.expect(t[0]instanceof e.KeyboardEvent||t[0]instanceof e.Vector3)["true"]})],ArcballCameraController.prototype,"_changeTarget",null),__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];e.expect(e.JudgeUtils.isNumber(t[0])||t[0]instanceof e.PointEvent)["true"]})],ArcballCameraController.prototype,"_changeDistance",null),ArcballCameraController}(e.CameraController);e.ArcballCameraController=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function RendererComponent(){e.apply(this,arguments)}return __extends(RendererComponent,e),RendererComponent}(e.Component);e.RendererComponent=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function MeshRenderer(){t.apply(this,arguments)}return __extends(MeshRenderer,t),MeshRenderer.create=function(){var e=new this;return e},MeshRenderer.prototype.render=function(e,t,r){var n=t.getGeometry();n&&e.addCommand(this.createDrawCommand(t,n,r))},MeshRenderer.prototype.createDrawCommand=function(t,r,n){var i=null,o=n.getComponent(e.CameraController),a=r.material;return i=this._createCommand(t,a),i.target=t,i.buffers=r.buffers,i.vaoManager=r.vaoManager,i.drawMode=r.drawMode,i.mMatrix=t.transform.localToWorldMatrix,i.vMatrix=o.worldToCameraMatrix,i.pMatrix=o.pMatrix,i.material=a,i.blend=a.blend,i},MeshRenderer.prototype._createCommand=function(t,r){var n=null,i=null,o=this._getInstanceState(r),a=o.isModelMatrixInstance,s=o.isNormalMatrixInstance,c=o.isOneToManyInstance,u=o.isHardwareInstance,l=o.isBatchInstance;return i=this._getInstanceGLSLData(c,a,s),u?n=c?this._createOneToManyHardwareInstanceCommand(t,r,i):this._createOneToOneHardwareInstanceCommand(t,r,i):l?n=c?this._createOneToManyBatchInstanceCommand(t,r,i):this._createOneToOneBatchInstanceCommand(t,r,i):(n=e.SingleDrawCommand.create(),n.normalMatrix=this.entityObject.transform.normalMatrix),n},MeshRenderer.prototype._getInstanceState=function(t){if(t.geometry instanceof e.InstanceGeometry){var r=e.InstanceUtils.isHardwareSupport(),n=!r;return{isModelMatrixInstance:!1,isNormalMatrixInstance:!1,isOneToManyInstance:!0,isHardwareInstance:r,isBatchInstance:n}}var i=t.shader.getInstanceState(),o=i.isModelMatrixInstance,a=i.isNormalMatrixInstance,s=i.isHardwareInstance,c=i.isBatchInstance;return{isModelMatrixInstance:o,isNormalMatrixInstance:a,isOneToManyInstance:!1,isHardwareInstance:s,isBatchInstance:c}},MeshRenderer.prototype._getInstanceGLSLData=function(t,r,n){return t?e.EInstanceGLSLData.ONE_MANY:n?e.EInstanceGLSLData.NORMALMATRIX_MODELMATRIX:e.EInstanceGLSLData.MODELMATRIX},MeshRenderer.prototype._createOneToOneHardwareInstanceCommand=function(t,r,n){var i=t.getComponent(e.OneToOneSourceInstance),o=e.OneToOneHardwareInstanceCommand.create();return o.instanceList=i.toRenderInstanceListForDraw,o.instanceBuffer=i.instanceBuffer,o.glslData=n,o},MeshRenderer.prototype._createOneToManyHardwareInstanceCommand=function(t,r,n){var i=t.getComponent(e.OneToManySourceInstance),o=e.OneToManyHardwareInstanceCommand.create();return o.instanceBuffer=i.instanceBuffer,o.geometry=r.geometry,o.glslData=n,o},MeshRenderer.prototype._createOneToOneBatchInstanceCommand=function(t,r,n){var i=t.getComponent(e.OneToOneSourceInstance),o=e.OneToOneBatchInstanceCommand.create();return o.instanceList=i.toRenderInstanceListForDraw,o.glslData=n,o},MeshRenderer.prototype._createOneToManyBatchInstanceCommand=function(t,r,n){var i=(t.getComponent(e.OneToManySourceInstance),e.OneToManyBatchInstanceCommand.create());return i.geometry=r.geometry,i.glslData=n,i},__decorate([e.require(function(t,r,n){var i=n.getComponent(e.CameraController);e.it("camera must add Camera Component",function(){e.expect(!!i&&!!i.camera)["true"]}),e.it("Mesh must add geometry component",function(){e.expect(!!r)["true"]})})],MeshRenderer.prototype,"createDrawCommand",null),__decorate([e.require(function(t){e.InstanceUtils.isInstance(t)&&e.it("if use instance to batch draw, target should be SourceInstance",function(){e.expect(e.InstanceUtils.isSourceInstance(t))["true"]})}),e.ensure(function(t,r){t instanceof e.HardwareInstanceCommand?e.it("hardware should support instance",function(){e.expect(e.InstanceUtils.isHardwareSupport())["true"]}):t instanceof e.BatchInstanceCommand&&e.it("hardware shouldn't support instance",function(){e.expect(e.InstanceUtils.isHardwareSupport())["false"]})})],MeshRenderer.prototype,"_createCommand",null),MeshRenderer}(e.RendererComponent);e.MeshRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function SkyboxRenderer(){t.apply(this,arguments)}return __extends(SkyboxRenderer,t),SkyboxRenderer.create=function(){var e=new this;return e},SkyboxRenderer.prototype.render=function(t,r,n){t.skyboxCommand=this.createDrawCommand(r,r.getComponent(e.Geometry),n)},__decorate([e.require(function(t,r,n){e.it("target should has geometry",function(){e.expect(r.hasComponent(e.Geometry))["true"]})})],SkyboxRenderer.prototype,"render",null),SkyboxRenderer}(e.MeshRenderer);e.SkyboxRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ColliderForFirstCheck(){t.apply(this,arguments)}return __extends(ColliderForFirstCheck,t),ColliderForFirstCheck.prototype.clone=function(){return e.CloneUtils.clone(this)},ColliderForFirstCheck}(e.Component);e.ColliderForFirstCheck=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function BoxColliderForFirstCheck(){t.apply(this,arguments),this._collider=e.BoxCollider.create()}return __extends(BoxColliderForFirstCheck,t),BoxColliderForFirstCheck.create=function(){var e=new this;return e},Object.defineProperty(BoxColliderForFirstCheck.prototype,"shape",{get:function(){return this._collider.shape},enumerable:!0,configurable:!0}),BoxColliderForFirstCheck.prototype.init=function(){this._collider.entityObject=this.entityObject,this._collider.init()},BoxColliderForFirstCheck.prototype.update=function(e){this._collider.update(e)},__decorate([e.cloneAttributeAsCloneable()],BoxColliderForFirstCheck.prototype,"_collider",void 0),BoxColliderForFirstCheck}(e.ColliderForFirstCheck);e.BoxColliderForFirstCheck=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function Collider(){t.apply(this,arguments),this.enable=!0,this.boundingRegion=null}return __extends(Collider,t),Object.defineProperty(Collider.prototype,"shape",{get:function(){return this.boundingRegion.shape},enumerable:!0,configurable:!0}),Collider.prototype.init=function(){this.boundingRegion=this.createBoundingRegion(),this.boundingRegion.init(),this.buildBoundingRegion()},Collider.prototype.addToObject=function(r,n){void 0===n&&(n=!1);var i=e.CollisionEngine.getInstance();t.prototype.addToObject.call(this,r,n),i.hasChild(this)||i.addChild(this)},Collider.prototype.removeFromEngine=function(){e.CollisionEngine.getInstance().removeChild(this)},Collider.prototype.clone=function(){return e.CloneUtils.clone(this)},Collider.prototype.update=function(e){this.boundingRegion.update()},Collider.prototype.updateShape=function(){this.boundingRegion.updateShape()},Collider.prototype.isIntersectWith=function(t){return t instanceof e.BoxCollider?this.boundingRegion.isIntersectWithBox(t.boundingRegion):t instanceof e.SphereCollider?this.boundingRegion.isIntersectWithSphere(t.boundingRegion):void e.Log.warn(e.Log.info.FUNC_NOT_SUPPORT(this.type+" collider","intersect with "+t.type+" collider"))},Collider.prototype.isCollide=function(t){var r=null;return r=t.getComponent(Collider),e.ClassUtils.hasComponent(t,"RigidBody")&&r.updateShape(),this.isIntersectWith(r)},Collider.prototype._isSelf=function(t){return e.JudgeUtils.isSelf(this.entityObject,t)},__decorate([e.cloneAttributeAsBasicType()],Collider.prototype,"enable",void 0),__decorate([e.cloneAttributeAsCloneable()],Collider.prototype,"boundingRegion",void 0),__decorate([e.require(function(t){e.assert(t instanceof Collider,e.Log.info.FUNC_SHOULD("target","be collider"))})],Collider.prototype,"isIntersectWith",null),__decorate([e.require(function(t){e.assert(!this._isSelf(t),e.Log.info.FUNC_SHOULD_NOT("targetObject","be self")),e.assert(t.hasComponent(Collider),e.Log.info.FUNC_SHOULD("targetObject","contain Collider component"))})],Collider.prototype,"isCollide",null),Collider}(e.Component);e.Collider=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function BoxCollider(){t.apply(this,arguments),this.center=e.Vector3.create(0,0,0),this.halfExtents=null,this.type=e.EColliderType.BOX}return __extends(BoxCollider,t),BoxCollider.create=function(){var e=new this;return e},BoxCollider.prototype.createBoundingRegion=function(){return e.BoxBoundingRegion.create(this.entityObject)},BoxCollider.prototype.buildBoundingRegion=function(){this.boundingRegion.build(this.center,this.halfExtents)},__decorate([e.cloneAttributeAsCloneable()],BoxCollider.prototype,"center",void 0),__decorate([e.cloneAttributeAsCloneable()],BoxCollider.prototype,"halfExtents",void 0),BoxCollider}(e.Collider);e.BoxCollider=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function SphereCollider(){t.apply(this,arguments),this.center=e.Vector3.create(0,0,0),this.radius=null,this.type=e.EColliderType.SPHERE}return __extends(SphereCollider,t),SphereCollider.create=function(){var e=new this;return e},SphereCollider.prototype.createBoundingRegion=function(){return e.SphereBoundingRegion.create(this.entityObject)},SphereCollider.prototype.buildBoundingRegion=function(){this.boundingRegion.build(this.center,this.radius)},__decorate([e.cloneAttributeAsCloneable()],SphereCollider.prototype,"center",void 0),__decorate([e.cloneAttributeAsBasicType()],SphereCollider.prototype,"radius",void 0),SphereCollider}(e.Collider);e.SphereCollider=t}(wd||(wd={}));var wd;!function(e){var t=function(){function BoundingRegion(e){this.shape=null,this.entityObject=null,this.isUserSpecifyTheRegion=!1,this.originShape=null,this.debugObject=null,this.entityObject=e}return BoundingRegion.prototype.init=function(){this.shape=this.createShape()},BoundingRegion.prototype.clone=function(){return e.CloneUtils.clone(this)},BoundingRegion.prototype.build=function(t){for(var r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];var i=Array.prototype.slice.call(arguments,0);this.isBuildUserSpecifyBoundingRegion.apply(this,i)?(this.isUserSpecifyTheRegion=!0,this.shape.setFromShapeParam.apply(this.shape,i)):this.shape.setFromPoints(e.ColliderUtils.getVertices(this.entityObject)),this.originShape=this.shape.clone(),e.DebugConfig.debugCollision&&(this.debugObject=this.buildDebugObjectFromShape(this.shape),e.Director.getInstance().scene.addChild(this.debugObject))},BoundingRegion.prototype.update=function(){this.isNotTransformed()||(e.DebugConfig.debugCollision?(this.updateShape(),this.updateDebugObjectFromShape(this.shape)):e.ClassUtils.hasComponent(this.entityObject,"RigidBody")||this.updateShape())},BoundingRegion.prototype.isIntersectWithSphere=function(e){return this.shape.isIntersectWithSphere(e.shape)},BoundingRegion.prototype.isIntersectWithBox=function(e){return this.shape.isIntersectWithBox(e.shape)},BoundingRegion.prototype.buildDebugObjectFromShape=function(t){var r=null,n=null,i=null,o=null;return r=e.BasicMaterial.create(),r.color=e.Color.create("rgb(255,0,0)"),n=e.CustomGeometry.create(),n.material=r,n.drawMode=e.EDrawMode.LINES,this.setDebugObjectGeometry(n,t),i=e.MeshRenderer.create(),o=e.GameObject.create(),o.addComponent(n),o.addComponent(i),o.transform.translate(t.center),o.name="debugBoundingRegion"+this.entityObject.uid,o.init(),o},__decorate([e.cloneAttributeAsCloneable()],BoundingRegion.prototype,"shape",void 0),__decorate([e.ensure(function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];this.isBuildUserSpecifyBoundingRegion.apply(this,Array.prototype.slice.call(arguments,1))&&e.assert(this.shape.center.isEqual(r),e.Log.info.FUNC_SHOULD_NOT("transform shape when build"))})],BoundingRegion.prototype,"build",null),BoundingRegion}();e.BoundingRegion=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function BoxBoundingRegion(){t.apply(this,arguments)}return __extends(BoxBoundingRegion,t),BoxBoundingRegion.create=function(e){var t=new this(e);return t},BoxBoundingRegion.prototype.updateShape=function(){var e=this.entityObject.transform;this.isUserSpecifyTheRegion?this.shape.setFromTranslationAndScale(this.originShape,e.localToWorldMatrix):e.isRotate?this.shape.setFromObject(this.entityObject):this.shape.setFromTranslationAndScale(this.originShape,e.localToWorldMatrix)},BoxBoundingRegion.prototype.createShape=function(){return e.AABBShape.create()},BoxBoundingRegion.prototype.updateDebugObjectFromShape=function(t){var r=this.debugObject.getComponent(e.CustomGeometry);this.setDebugObjectGeometry(r,t),this.debugObject.transform.position=t.center},BoxBoundingRegion.prototype.setDebugObjectGeometry=function(e,t){var r=t.halfExtents,n=r.x,i=r.y,o=r.z;e.vertices=[-n,-i,-o,-n,-i,o,n,-i,o,n,-i,-o,-n,i,-o,-n,i,o,n,i,o,n,i,-o],e.indices=[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]},BoxBoundingRegion.prototype.isBuildUserSpecifyBoundingRegion=function(e,t){return!!e&&!!t},BoxBoundingRegion.prototype.isNotTransformed=function(){var e=this.entityObject.transform;return!e.isRotate&&!e.isTranslate&&!e.isScale},__decorate([e.require(function(t){e.assert(this.debugObject,e.Log.info.FUNC_SHOULD("build debugObject"))})],BoxBoundingRegion.prototype,"updateDebugObjectFromShape",null),__decorate([e.require(function(t,r){e.assert(r.halfExtents&&!r.halfExtents.isZero(),e.Log.info.FUNC_SHOULD_NOT("halfExtents","be zero"))})],BoxBoundingRegion.prototype,"setDebugObjectGeometry",null),BoxBoundingRegion}(e.BoundingRegion);e.BoxBoundingRegion=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function SphereBoundingRegion(){t.apply(this,arguments)}return __extends(SphereBoundingRegion,t),SphereBoundingRegion.create=function(e){var t=new this(e);return t},SphereBoundingRegion.prototype.updateShape=function(){var e=this.entityObject.transform;this.shape.setFromTranslationAndScale(this.originShape,e.localToWorldMatrix)},SphereBoundingRegion.prototype.createShape=function(){return e.SphereShape.create()},SphereBoundingRegion.prototype.updateDebugObjectFromShape=function(t){this.debugObject.transform.position=t.center;var r=t.radius/this.originShape.radius;this.debugObject.transform.scale=e.Vector3.create(r,r,r)},SphereBoundingRegion.prototype.isNotTransformed=function(){var e=this.entityObject.transform;return!e.isTranslate&&!e.isScale},SphereBoundingRegion.prototype.isBuildUserSpecifyBoundingRegion=function(e,t){return!!e&&!!t},SphereBoundingRegion.prototype.setDebugObjectGeometry=function(e,t){for(var r=40,n=3,i=t.radius,o=[],a=0,s=0;s<n;s++){var c=0,u=1,l=2,h=null;1===s?(c=1,u=0,l=2):2===s&&(c=0,u=2,l=1);for(var d=0;d<r;d++)h=2*Math.PI*(d/r),o[a+c]=i*Math.cos(h),o[a+u]=0,o[a+l]=i*Math.sin(h),a+=3,h=2*Math.PI*((d+1)/r),o[a+c]=i*Math.cos(h),o[a+u]=0,o[a+l]=i*Math.sin(h),a+=3}e.vertices=o},__decorate([e.require(function(t){e.assert(this.debugObject,e.Log.info.FUNC_SHOULD("build debugObject"))})],SphereBoundingRegion.prototype,"updateDebugObjectFromShape",null),__decorate([e.require(function(t,r){e.assert(r.radius>0,e.Log.info.FUNC_SHOULD("radius","> 0"))})],SphereBoundingRegion.prototype,"setDebugObjectGeometry",null),SphereBoundingRegion}(e.BoundingRegion);e.SphereBoundingRegion=t}(wd||(wd={}));var wd;!function(e){var t=function(){function BoundingRegionUtils(){}return BoundingRegionUtils.isAABBInFrustum=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=null,n=null;if(2===e.length)r=e[0],n=e[1];else if(3===e.length){var i=e[0],o=e[1];r=this.buildBoundingVectors(i,o),n=e[2]}for(var a=0;a<6;a++)for(var s=0;s<8;s++)if(n[a].dotCoordinate(r[s])<0)return!1;return!0},BoundingRegionUtils.isAABBIntersectFrustum=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=null,n=null;if(2===e.length)r=e[0],n=e[1];else if(3===e.length){var i=e[0],o=e[1];r=this.buildBoundingVectors(i,o),n=e[2]}for(var a=0;a<6;a++){for(var s=8,c=0;c<8&&n[a].dotCoordinate(r[c])<0;c++)s--;if(0===s)return!1}return!0},BoundingRegionUtils.buildBoundingVectors=function(e,t){var r=[];return r.push(e.clone()),r.push(t.clone()),r.push(e.clone()),r[2].x=t.x,r.push(e.clone()),r[3].y=t.y,r.push(e.clone()),r[4].z=t.z,r.push(t.clone()),r[5].z=e.z,r.push(t.clone()),r[6].x=e.x,r.push(t.clone()),r[7].y=e.y,r},BoundingRegionUtils}();e.BoundingRegionUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Shape(){this.center=e.Vector3.create(0,0,0)}return Shape.prototype.clone=function(){return e.CloneUtils.clone(this)},Shape.prototype.isBoxAndSphereIntersected=function(e,t){var r=t.center,n=t.radius;return r.distanceToSquared(e.closestPointTo(r))<Math.pow(n,2)},__decorate([e.cloneAttributeAsCloneable()],Shape.prototype,"center",void 0),Shape}();e.Shape=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function AABBShape(){t.apply(this,arguments),this.halfExtents=e.Vector3.create(.5,.5,.5)}return __extends(AABBShape,t),AABBShape.create=function(){var e=new this;return e},AABBShape.getCenter=function(t,r){return e.Vector3.create().add2(r,t).scale(.5)},AABBShape.getHalfExtents=function(t,r){return e.Vector3.create().sub2(r,t).scale(.5)},AABBShape.prototype.setMinMax=function(e,t){this.center=AABBShape.getCenter(e,t),this.halfExtents=AABBShape.getHalfExtents(e,t)},AABBShape.prototype.getMin=function(){return this.center.clone().sub(this.halfExtents)},AABBShape.prototype.getMax=function(){return this.center.clone().add(this.halfExtents)},AABBShape.prototype.setFromShapeParam=function(e,t){this.center=e,this.halfExtents=t},AABBShape.prototype.setFromPoints=function(t){var r=this,n=this._getEmptyMin(),i=this._getEmptyMax();return e.GeometryUtils.iterateThreeComponent(t,function(e){r._expandByPoint(e,n,i)}),this.setMinMax(n,i),this},AABBShape.prototype.setFromTransformedAABB=function(e,t){var r=this.center,n=this.halfExtents,i=e.center.values,o=e.halfExtents.values,a=t.values,s=a[0],c=a[4],u=a[8],l=a[1],h=a[5],d=a[9],p=a[2],f=a[6],m=a[10],g=Math.abs(s),_=Math.abs(c),y=Math.abs(u),v=Math.abs(l),b=Math.abs(h),C=Math.abs(d),E=Math.abs(p),S=Math.abs(f),T=Math.abs(m);r.set(a[12]+s*i[0]+c*i[1]+u*i[2],a[13]+l*i[0]+h*i[1]+d*i[2],a[14]+p*i[0]+f*i[1]+m*i[2]),n.set(g*o[0]+_*o[1]+y*o[2],v*o[0]+b*o[1]+C*o[2],E*o[0]+S*o[1]+T*o[2])},AABBShape.prototype.setFromTranslationAndScale=function(e,t){var r=t.getTranslation(),n=t.getScale();this.center=e.center.clone().add(r),this.halfExtents=e.halfExtents.clone().mul(n)},AABBShape.prototype.setFromObject=function(t){var r=t.transform.localToWorldMatrix,n=e.ColliderUtils.getVertices(t),i=this,o=this._getEmptyMin(),a=this._getEmptyMax();e.GeometryUtils.iterateThreeComponent(n,function(e){e.applyMatrix4(r),i._expandByPoint(e,o,a)}),this.setMinMax(o,a)},AABBShape.prototype.isIntersectWithBox=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=this.getMax(),n=this.getMin(),i=null,o=null;if(1===e.length){var a=e[0];o=a.getMin(),i=a.getMax()}else 2===e.length&&(o=e[0],i=e[1]);return n.x<=i.x&&r.x>=o.x&&n.y<=i.y&&r.y>=o.y&&n.z<=i.z&&r.z>=o.z},AABBShape.prototype.isIntersectWithSphere=function(e){return this.isBoxAndSphereIntersected(this,e)},AABBShape.prototype.isIntersectWithRay=function(e){return e.isIntersectWithAABB(this)},AABBShape.prototype.closestPointTo=function(t){var r=this.getMin(),n=this.getMax(),i=e.Vector3.create();return t.x<r.x?i.x=r.x:t.x>n.x?i.x=n.x:i.x=t.x,t.y<r.y?i.y=r.y:t.y>n.y?i.y=n.y:i.y=t.y,t.z<r.z?i.z=r.z:t.z>n.z?i.z=n.z:i.z=t.z,i},AABBShape.prototype.containPoint=function(e){for(var t=this.getMin(),r=this.getMax(),n=0;n<3;++n)if(e.values[n]<t.values[n]||e.values[n]>r.values[n])return!1;return!0},AABBShape.prototype._getEmptyMin=function(){return e.Vector3.create(1/0,1/0,1/0)},AABBShape.prototype._getEmptyMax=function(){return e.Vector3.create(-(1/0),-(1/0),-(1/0))},AABBShape.prototype._expandByPoint=function(e,t,r){t.min(e),r.max(e)},__decorate([e.cloneAttributeAsCloneable()],AABBShape.prototype,"halfExtents",void 0),__decorate([e.require(function(t){var r=e.ColliderUtils.getVertices(t);e.assert(r&&r.length>0,e.Log.info.FUNC_MUST_DEFINE("vertices"))})],AABBShape.prototype,"setFromObject",null),AABBShape}(e.Shape);e.AABBShape=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function SphereShape(){t.apply(this,arguments),this.radius=1}return __extends(SphereShape,t),SphereShape.create=function(){var e=new this;return e},SphereShape.prototype.setFromShapeParam=function(e,t){this.center=e,this.radius=t},SphereShape.prototype.setFromPoints=function(t){var r=e.AABBShape.create();this.center=r.setFromPoints(t).center,this.radius=this._findMaxDistanceOfPointsToCenter(t)},SphereShape.prototype.setFromTranslationAndScale=function(e,t){var r=t.getTranslation(),n=t.getScale();this.center=e.center.clone().add(r),this.radius=e.radius*Math.max(n.x,n.y,n.z)},SphereShape.prototype.isIntersectWithSphere=function(e){var t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=Math.pow(t,2)},SphereShape.prototype.isIntersectWithBox=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null;if(1===t.length)n=t[0];else if(2===t.length){var i=t[0],o=t[1];n=e.AABBShape.create(),n.setMinMax(i,o)}return this.isBoxAndSphereIntersected(n,this)},SphereShape.prototype.isIntersectWithRay=function(e){return e.isIntersectWithSphere(this)},SphereShape.prototype.containPoint=function(e){return e.distanceToSquared(this.center)<=Math.pow(this.radius,2)},SphereShape.prototype._findMaxDistanceOfPointsToCenter=function(t){var r=0,n=this.center;return e.GeometryUtils.iterateThreeComponent(t,function(e){r=Math.max(r,n.distanceToSquared(e))}),Math.sqrt(r)},__decorate([e.cloneAttributeAsBasicType()],SphereShape.prototype,"radius",void 0),SphereShape}(e.Shape);e.SphereShape=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.BOX="box"]="BOX",e[e.SPHERE="sphere"]="SPHERE"}(e.EColliderType||(e.EColliderType={}));e.EColliderType}(wd||(wd={}));var wd;!function(e){var t=function(){function ColliderUtils(){}return ColliderUtils.getVertices=function(t){return t.hasComponent(e.Geometry)?t.getComponent(e.Geometry).geometryData.vertices:t.hasTag(e.EWDTag.CONTAINER)?t.getChild(0).getComponent(e.Geometry).vertices:null},__decorate([e.require(function(t){e.describe("if entityObject is EWDTag.CONTAINER",function(){e.it("children->vertices should has data",function(){var r=t.getChild(0);if(r){var n=r.getComponent(e.Geometry).vertices;e.expect(n).exist,e.expect(n.length).greaterThan(0)}}),e.it("first child->vertices.length should === second child->vertices.length",function(){var r=t.getChild(0),n=t.getChild(1);if(r&&n){var i=r.getComponent(e.Geometry).vertices,o=n.getComponent(e.Geometry).vertices;e.expect(i).exist,e.expect(o).exist,e.expect(i.length===o.length)["true"]}})},function(){return!t.hasComponent(e.Geometry)&&t.hasTag(e.EWDTag.CONTAINER)})})],ColliderUtils,"getVertices",null),ColliderUtils}();e.ColliderUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function Light(){t.apply(this,arguments),this._shadowMapWidth=null,this._shadowMapHeight=null,this.color=e.Color.create("#ffffff"),this.castShadow=!1,this.shadowCameraNear=.1,this.shadowCameraFar=5e3,this.shadowBias=e.ShaderChunk.NULL,this.shadowDarkness=0}return __extends(Light,t),Object.defineProperty(Light.prototype,"position",{get:function(){return this.entityObject.transform.position},enumerable:!0,configurable:!0}),Object.defineProperty(Light.prototype,"shadowMapWidth",{get:function(){var t=e.GPUDetector.getInstance().maxCubemapTextureSize;return!this._shadowMapWidth||this._shadowMapWidth>t?t:this._shadowMapWidth},set:function(e){this._shadowMapWidth=e},enumerable:!0,configurable:!0}),Object.defineProperty(Light.prototype,"shadowMapHeight",{get:function(){var t=e.GPUDetector.getInstance().maxCubemapTextureSize;return!this._shadowMapHeight||this._shadowMapHeight>t?t:this._shadowMapHeight},set:function(e){this._shadowMapHeight=e},enumerable:!0,configurable:!0}),__decorate([e.cloneAttributeAsBasicType()],Light.prototype,"shadowMapWidth",null),__decorate([e.cloneAttributeAsBasicType()],Light.prototype,"shadowMapHeight",null),__decorate([e.cloneAttributeAsCloneable()],Light.prototype,"color",void 0),__decorate([e.cloneAttributeAsBasicType()],Light.prototype,"castShadow",void 0),__decorate([e.cloneAttributeAsBasicType()],Light.prototype,"shadowCameraNear",void 0),__decorate([e.cloneAttributeAsBasicType()],Light.prototype,"shadowCameraFar",void 0),__decorate([e.cloneAttributeAsBasicType()],Light.prototype,"shadowBias",void 0),__decorate([e.cloneAttributeAsBasicType()],Light.prototype,"shadowDarkness",void 0),Light}(e.Component);e.Light=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function AmbientLight(){e.apply(this,arguments)}return __extends(AmbientLight,e),AmbientLight.create=function(){var e=new this;return e},AmbientLight.type="ambientLight",AmbientLight}(e.Light);e.AmbientLight=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function SourceLight(){t.apply(this,arguments),this.intensity=1}return __extends(SourceLight,t),__decorate([e.cloneAttributeAsBasicType()],SourceLight.prototype,"intensity",void 0),SourceLight}(e.Light);e.SourceLight=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DirectionLight(){t.apply(this,arguments),this.shadowCameraLeft=-1e3,this.shadowCameraRight=1e3,this.shadowCameraTop=1e3,this.shadowCameraBottom=-1e3}return __extends(DirectionLight,t),DirectionLight.create=function(){var e=new this;return e},DirectionLight.type="directionLight",DirectionLight.defaultPosition=e.Vector3.create(0,0,1),__decorate([e.cloneAttributeAsBasicType()],DirectionLight.prototype,"shadowCameraLeft",void 0),__decorate([e.cloneAttributeAsBasicType()],DirectionLight.prototype,"shadowCameraRight",void 0),__decorate([e.cloneAttributeAsBasicType()],DirectionLight.prototype,"shadowCameraTop",void 0),__decorate([e.cloneAttributeAsBasicType()],DirectionLight.prototype,"shadowCameraBottom",void 0),DirectionLight}(e.SourceLight);e.DirectionLight=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function PointLight(){t.apply(this,arguments),this._rangeLevel=null,this._attenuation=e.Attenuation.create()}return __extends(PointLight,t),PointLight.create=function(){var e=new this;return e},Object.defineProperty(PointLight.prototype,"rangeLevel",{get:function(){return this._rangeLevel},set:function(e){this._rangeLevel=e,this._attenuation.rangeLevel=this._rangeLevel},enumerable:!0,configurable:!0}),Object.defineProperty(PointLight.prototype,"range",{get:function(){return this._attenuation.range},set:function(e){this._attenuation.range=e},enumerable:!0,configurable:!0}),Object.defineProperty(PointLight.prototype,"constant",{get:function(){return this._attenuation.constant},set:function(e){this._attenuation.constant=e},enumerable:!0,configurable:!0}),Object.defineProperty(PointLight.prototype,"linear",{get:function(){return this._attenuation.linear},set:function(e){this._attenuation.linear=e},enumerable:!0,configurable:!0}),Object.defineProperty(PointLight.prototype,"quadratic",{get:function(){return this._attenuation.quadratic},set:function(e){this._attenuation.quadratic=e},enumerable:!0,configurable:!0}),PointLight.type="pointLight",__decorate([e.cloneAttributeAsBasicType()],PointLight.prototype,"rangeLevel",null),__decorate([e.cloneAttributeAsBasicType()],PointLight.prototype,"range",null),__decorate([e.cloneAttributeAsBasicType()],PointLight.prototype,"constant",null),__decorate([e.cloneAttributeAsBasicType()],PointLight.prototype,"linear",null),
__decorate([e.cloneAttributeAsBasicType()],PointLight.prototype,"quadratic",null),PointLight}(e.SourceLight);e.PointLight=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Attenuation(){this._constant=1,this._range=null,this._linear=0,this._quadratic=0,this._rangeLevel=0}return Attenuation.create=function(){var e=new this;return e},Object.defineProperty(Attenuation.prototype,"constant",{get:function(){return this._constant},set:function(e){this._constant=e},enumerable:!0,configurable:!0}),Object.defineProperty(Attenuation.prototype,"range",{get:function(){return this._range},set:function(e){this._range=e},enumerable:!0,configurable:!0}),Object.defineProperty(Attenuation.prototype,"linear",{get:function(){return this._linear},set:function(e){this._linear=e},enumerable:!0,configurable:!0}),Object.defineProperty(Attenuation.prototype,"quadratic",{get:function(){return this._quadratic},set:function(e){this._quadratic=e},enumerable:!0,configurable:!0}),Object.defineProperty(Attenuation.prototype,"rangeLevel",{get:function(){return this._rangeLevel},set:function(e){e&&(this._rangeLevel=e,this.setByRangeLevel())},enumerable:!0,configurable:!0}),Attenuation.prototype.setByRangeLevel=function(){switch(this._rangeLevel){case 0:this._range=7,this._linear=.7,this._quadratic=1.8;break;case 1:this._range=13,this._linear=.35,this._quadratic=.44;break;case 2:this._range=20,this._linear=.22,this._quadratic=.2;break;case 3:this._range=32,this._linear=.14,this._quadratic=.07;break;case 4:this._range=50,this._linear=.09,this._quadratic=.032;break;case 5:this._range=65,this._linear=.07,this._quadratic=.017;break;case 6:this._range=100,this._linear=.045,this._quadratic=.0075;break;case 7:this._range=160,this._linear=.027,this._quadratic=.0028;break;case 8:this._range=200,this._linear=.022,this._quadratic=.0019;break;case 9:this._range=325,this._linear=.014,this._quadratic=7e-4;break;case 10:this._range=600,this._linear=.007,this._quadratic=2e-4;break;case 11:this._range=3250,this._linear=.0014,this._quadratic=7e-6;break;default:e.Log.error(!0,"over light range")}},Attenuation}();e.Attenuation=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.PHONG="PHONG"]="PHONG",e[e.BLINN="BLINN"]="BLINN",e[e.LAMBERT="LAMBERT"]="LAMBERT",e[e.CONSTANT="CONSTANT"]="CONSTANT"}(e.ELightModel||(e.ELightModel={}));e.ELightModel}(wd||(wd={}));var wd;!function(e){var t=function(){function RenderTargetRenderer(e){this.texture=null,this.frameBufferOperator=null,this._isRenderListEmpty=!1,this._renderCount=0,this.texture=e}return RenderTargetRenderer.prototype.initWhenCreate=function(){this.frameBufferOperator=e.FrameBuffer.create(this.texture.width,this.texture.height)},RenderTargetRenderer.prototype.init=function(){this.texture.createEmptyTexture(),this.initFrameBuffer()},RenderTargetRenderer.prototype.needRender=function(){var e=this.texture.renderRate,t=!1;return t=0===e?this._shouldRenderOnce():this._shouldRenderAtRate(e),this._renderCount++,t},RenderTargetRenderer.prototype.render=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=e[0],n=this.getRenderList();if(this._isRenderListEmpty=this.isRenderListEmpty(n),this.beforeRender(),1===e.length)this.renderFrameBufferTexture(n,r);else{var i=e[1];this.renderFrameBufferTexture(n,r,i)}this.afterRender()},RenderTargetRenderer.prototype.dispose=function(){this.frameBufferOperator.dispose(),this.disposeFrameBuffer(),this.texture.dispose()},RenderTargetRenderer.prototype.beforeRender=function(){},RenderTargetRenderer.prototype.afterRender=function(){},RenderTargetRenderer.prototype.isRenderListEmptyWhenRender=function(){return this._isRenderListEmpty},RenderTargetRenderer.prototype._shouldRenderOnce=function(){return 0===this._renderCount},RenderTargetRenderer.prototype._shouldRenderAtRate=function(e){var t=this._renderCount;return 0===t||t===e&&(this._renderCount=0,!0)},__decorate([e.require(function(){e.assert(this.texture.renderRate>=0,e.Log.info.FUNC_SHOULD("renderTargetTexture->renderRate",">= 0, but actual is "+this.texture.renderRate))}),e.virtual],RenderTargetRenderer.prototype,"needRender",null),__decorate([e.virtual],RenderTargetRenderer.prototype,"beforeRender",null),__decorate([e.virtual],RenderTargetRenderer.prototype,"afterRender",null),__decorate([e.ensure(function(t){t&&e.assert(this.isRenderListEmpty(this.getRenderList()),e.Log.info.FUNC_SHOULD("renderList","be empty"))})],RenderTargetRenderer.prototype,"isRenderListEmptyWhenRender",null),RenderTargetRenderer}();e.RenderTargetRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ProceduralRenderTargetRenderer(){t.apply(this,arguments),this.frameBuffer=null,this._indexBuffer=null,this._vertexBuffer=null,this._shader=null,this._vaoManager=e.GPUDetector.getInstance().extensionVAO?e.VAOManager.create():null}return __extends(ProceduralRenderTargetRenderer,t),ProceduralRenderTargetRenderer.prototype.init=function(){t.prototype.init.call(this),this._initBuffer(),this._shader=this.createShader(),this._shader.init(),this._vaoManager&&this._vaoManager.init()},ProceduralRenderTargetRenderer.prototype.dispose=function(){t.prototype.dispose.call(this),this._indexBuffer.dispose(),this._vertexBuffer.dispose(),this._shader.dispose(),this._vaoManager&&this._vaoManager.dispose()},ProceduralRenderTargetRenderer.prototype.initFrameBuffer=function(){var t=this.frameBufferOperator,r=e.DeviceManager.getInstance().gl;this.frameBuffer=t.createFrameBuffer(),t.bindFrameBuffer(this.frameBuffer),t.attachTexture(r.TEXTURE_2D,this.texture.glTexture),t.check(),t.unBindAll()},ProceduralRenderTargetRenderer.prototype.renderFrameBufferTexture=function(t,r){this.frameBufferOperator.bindFrameBuffer(this.frameBuffer),this.texture.bindToUnit(0),this.frameBufferOperator.setViewport(),r.addCommand(this._createRenderCommand()),r.clear(),r.webglState=e.BasicState.create(),r.render(),this.frameBufferOperator.unBindFrameBuffer(),this.frameBufferOperator.restoreViewport()},ProceduralRenderTargetRenderer.prototype.disposeFrameBuffer=function(){var t=e.DeviceManager.getInstance().gl;t.deleteFramebuffer(this.frameBuffer)},ProceduralRenderTargetRenderer.prototype.getRenderList=function(){return null},ProceduralRenderTargetRenderer.prototype.isRenderListEmpty=function(){return!1},ProceduralRenderTargetRenderer.prototype._initBuffer=function(){e.BufferTable.hasBuffer(e.BufferTableKey.PROCEDURAL_VERTEX)?this._vertexBuffer=e.BufferTable.getBuffer(e.BufferTableKey.PROCEDURAL_VERTEX):(this._vertexBuffer=e.ArrayBuffer.create([1,1,-1,1,-1,-1,1,-1],2,e.EBufferType.FLOAT),e.BufferTable.addBuffer(e.BufferTableKey.PROCEDURAL_VERTEX,this._vertexBuffer)),e.BufferTable.hasBuffer(e.BufferTableKey.PROCEDURAL_INDEX)?this._indexBuffer=e.BufferTable.getBuffer(e.BufferTableKey.PROCEDURAL_INDEX):(this._indexBuffer=e.ElementBuffer.create([0,1,2,0,2,3],e.EBufferType.UNSIGNED_SHORT),e.BufferTable.addBuffer(e.BufferTableKey.PROCEDURAL_INDEX,this._indexBuffer))},ProceduralRenderTargetRenderer.prototype._createRenderCommand=function(){var t=e.ProceduralCommand.create();return t.vertexBuffer=this._vertexBuffer,t.indexBuffer=this._indexBuffer,t.shader=this._shader,t.vaoManager=this._vaoManager,t},ProceduralRenderTargetRenderer}(e.RenderTargetRenderer);e.ProceduralRenderTargetRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CustomProceduralRenderTargetRenderer(){t.apply(this,arguments)}return __extends(CustomProceduralRenderTargetRenderer,t),CustomProceduralRenderTargetRenderer.create=function(e){var t=new this(e);return t.initWhenCreate(),t},CustomProceduralRenderTargetRenderer.prototype.createShader=function(){var t=e.CustomProceduralShader.create(this.texture);return t.addLib(e.CustomProceduralShaderLib.create(this.texture)),t},CustomProceduralRenderTargetRenderer}(e.ProceduralRenderTargetRenderer);e.CustomProceduralRenderTargetRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function CommonRenderTargetRenderer(){e.apply(this,arguments)}return __extends(CommonRenderTargetRenderer,e),CommonRenderTargetRenderer}(e.RenderTargetRenderer);e.CommonRenderTargetRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function TwoDRenderTargetRenderer(){t.apply(this,arguments),this.frameBuffer=null,this._renderBuffer=null,this._lastCamera=null}return __extends(TwoDRenderTargetRenderer,t),TwoDRenderTargetRenderer.prototype.isNeedCreateCamera=function(){return!0},TwoDRenderTargetRenderer.prototype.createCamera=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return null},TwoDRenderTargetRenderer.prototype.setFrameBufferTexture=function(){var t=this.frameBufferOperator,r=e.DeviceManager.getInstance().gl;t.attachTexture(r.TEXTURE_2D,this.texture.glTexture,e.EFrameBufferAttachType.COLOR_ATTACHMENT0)},TwoDRenderTargetRenderer.prototype.createAndAttachDepthBuffer=function(){var t=this.frameBufferOperator;e.DeviceManager.getInstance().gl;this._renderBuffer=t.createRenderBuffer(),t.attachRenderBuffer("DEPTH_ATTACHMENT",this._renderBuffer)},TwoDRenderTargetRenderer.prototype.deleteRenderBuffer=function(){var t=e.DeviceManager.getInstance().gl;t.deleteRenderbuffer(this._renderBuffer)},TwoDRenderTargetRenderer.prototype.isRenderListEmpty=function(e){return 0===e.getCount()},TwoDRenderTargetRenderer.prototype.initFrameBuffer=function(){var e=this.frameBufferOperator;this.frameBuffer=e.createFrameBuffer(),e.bindFrameBuffer(this.frameBuffer),this.setFrameBufferTexture(),this.createAndAttachDepthBuffer(),e.check(),e.unBindAll()},TwoDRenderTargetRenderer.prototype.renderFrameBufferTexture=function(e,t,r){var n=null;this.isRenderListEmptyWhenRender()||(this.texture.bindToUnit(0),this.isNeedCreateCamera()?(n=this.createCamera(r),this._lastCamera&&this._lastCamera.dispose(),this._lastCamera=n):n=r,this.beforeRenderFrameBufferTexture(n),this.frameBufferOperator.bindFrameBuffer(this.frameBuffer),this.frameBufferOperator.setViewport(),e.forEach(function(e){e.render(t,n)}),t.clear(),this.renderRenderer(t),this.frameBufferOperator.unBindFrameBuffer(),this.frameBufferOperator.restoreViewport())},TwoDRenderTargetRenderer.prototype.disposeFrameBuffer=function(){var t=e.DeviceManager.getInstance().gl;t.deleteFramebuffer(this.frameBuffer),this.deleteRenderBuffer()},__decorate([e.virtual],TwoDRenderTargetRenderer.prototype,"isNeedCreateCamera",null),__decorate([e.virtual],TwoDRenderTargetRenderer.prototype,"createCamera",null),__decorate([e.virtual],TwoDRenderTargetRenderer.prototype,"setFrameBufferTexture",null),__decorate([e.virtual],TwoDRenderTargetRenderer.prototype,"createAndAttachDepthBuffer",null),__decorate([e.virtual],TwoDRenderTargetRenderer.prototype,"deleteRenderBuffer",null),__decorate([e.require(function(t,r,n){e.assert(!!n,e.Log.info.FUNC_SHOULD("pass param->camera"))})],TwoDRenderTargetRenderer.prototype,"renderFrameBufferTexture",null),TwoDRenderTargetRenderer}(e.CommonRenderTargetRenderer);e.TwoDRenderTargetRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function MirrorRenderTargetRenderer(){t.apply(this,arguments)}return __extends(MirrorRenderTargetRenderer,t),MirrorRenderTargetRenderer.create=function(e){var t=new this(e);return t.initWhenCreate(),t},MirrorRenderTargetRenderer.prototype.beforeRenderFrameBufferTexture=function(e){},MirrorRenderTargetRenderer.prototype.getRenderList=function(){return this.texture.renderList},MirrorRenderTargetRenderer.prototype.renderRenderer=function(t){this._setSceneSide(e.ESide.FRONT),t.webglState=e.BasicState.create(),t.render(),this._setSceneSide(null)},MirrorRenderTargetRenderer.prototype.beforeRender=function(){this.isRenderListEmptyWhenRender()?e.Director.getInstance().scene.glslData.addChild(e.EShaderGLSLData.MIRROR,{isRenderListEmpty:!0}):e.Director.getInstance().scene.glslData.addChild(e.EShaderGLSLData.MIRROR,{isRenderListEmpty:!1})},MirrorRenderTargetRenderer.prototype.createCamera=function(t){var r=null,n=null,i=t.getComponent(e.CameraController),o=null,a=null;return n=this.texture.getPlane(),o=n.getReflectionMatrix().applyMatrix(i.worldToCameraMatrix),a=this._setClipPlane(o,i.pMatrix,n),r=e.PerspectiveCamera.create(),r.worldToCameraMatrix=o.clone(),r.pMatrix=a,e.GameObject.create().addComponent(e.RenderTargetRendererCameraController.create(r)).init()},MirrorRenderTargetRenderer.prototype._setSceneSide=function(t){var r=e.Director.getInstance().scene;r.side=t},MirrorRenderTargetRenderer.prototype._setClipPlane=function(t,r,n){var i=r.clone(),o=e.Vector4.create(),a=this._getClipPlaneInCameraSpace(t,n),s=e.Vector4.create();return o.x=(Math.sign(a.x)+i.values[8])/i.values[0],o.y=(Math.sign(a.y)+i.values[9])/i.values[5],o.z=-1,o.w=(1+i.values[10])/i.values[14],s=a.multiplyScalar(2/a.dot(o)),i.values[2]=s.x,i.values[6]=s.y,i.values[10]=s.z+1,i.values[14]=s.w,i},MirrorRenderTargetRenderer.prototype._getClipPlaneInCameraSpace=function(t,r){var n=e.Vector4.create(),i=t.multiplyPoint(this.texture.getPosition()),o=t.clone().invert().transpose().multiplyPoint(r.normal).normalize();return n.set(o.x,o.y,o.z,-i.dot(o)),n},MirrorRenderTargetRenderer}(e.TwoDRenderTargetRenderer);e.MirrorRenderTargetRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function RefractionRenderTargetRenderer(){t.apply(this,arguments)}return __extends(RefractionRenderTargetRenderer,t),RefractionRenderTargetRenderer.create=function(e){var t=new this(e);return t.initWhenCreate(),t},RefractionRenderTargetRenderer.prototype.beforeRenderFrameBufferTexture=function(e){},RefractionRenderTargetRenderer.prototype.getRenderList=function(){return this.texture.renderList},RefractionRenderTargetRenderer.prototype.renderRenderer=function(t){t.webglState=e.BasicState.create(),t.render()},RefractionRenderTargetRenderer.prototype.beforeRender=function(){this.isRenderListEmptyWhenRender()?e.Director.getInstance().scene.glslData.addChild(e.EShaderGLSLData.REFRACTION,{isRenderListEmpty:!0}):e.Director.getInstance().scene.glslData.addChild(e.EShaderGLSLData.REFRACTION,{isRenderListEmpty:!1})},RefractionRenderTargetRenderer.prototype.isNeedCreateCamera=function(){return!1},RefractionRenderTargetRenderer}(e.TwoDRenderTargetRenderer);e.RefractionRenderTargetRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CubemapRenderTargetRenderer(){t.apply(this,arguments),this._frameBufferList=wdCb.Collection.create(),this._renderBufferList=wdCb.Collection.create(),this._lastCameraList=null,this._lastPosition=null}return __extends(CubemapRenderTargetRenderer,t),CubemapRenderTargetRenderer.prototype.renderRenderer=function(t){t.webglState=e.BasicState.create(),t.render()},CubemapRenderTargetRenderer.prototype.beforeRenderFrameBufferTexture=function(e){},CubemapRenderTargetRenderer.prototype.initFrameBuffer=function(){for(var t=this.frameBufferOperator,r=e.DeviceManager.getInstance().gl,n=0;n<6;n++){var i=t.createFrameBuffer(),o=t.createRenderBuffer();this._frameBufferList.addChild(i),this._renderBufferList.addChild(o),t.bindFrameBuffer(i),t.attachTexture(r.TEXTURE_CUBE_MAP_POSITIVE_X+n,this.texture.glTexture),t.attachRenderBuffer("DEPTH_ATTACHMENT",o),t.check()}t.unBindAll()},CubemapRenderTargetRenderer.prototype.renderFrameBufferTexture=function(e,t,r){var n=null,i=null,o=null,a=null,s=null;if(!this.isRenderListEmptyWhenRender()){this.texture.bindToUnit(0),a=this.getPosition(),s=this._isNeedCreateCamera(a),s&&(o=wdCb.Collection.create());for(var c=0;c<6;c++)i=e.getChild(this._convertIndexToFaceKey(c)),this._isEmpty(i)||(s?(n=this.createCamera(c),o.addChild(n)):n=this._lastCameraList.getChild(c),this.beforeRenderFrameBufferTexture(n),this.frameBufferOperator.bindFrameBuffer(this._frameBufferList.getChild(c)),this.frameBufferOperator.setViewport(),i.forEach(function(e){e.render(t,n)}),t.clear(),this.renderRenderer(t));s&&(this._lastCameraList&&this._lastCameraList.forEach(function(e){e.dispose()}),this._lastCameraList=o,this._lastPosition=a),this.frameBufferOperator.unBindFrameBuffer(),this.frameBufferOperator.restoreViewport()}},CubemapRenderTargetRenderer.prototype.disposeFrameBuffer=function(){var t=e.DeviceManager.getInstance().gl;this._frameBufferList.forEach(function(e){return t.deleteFramebuffer(e)}),this._renderBufferList.forEach(function(e){return t.deleteRenderbuffer(e)})},CubemapRenderTargetRenderer.prototype.createCamera=function(t){var r=e.PerspectiveCamera.create(),n=e.GameObject.create(),i=this.getPosition();return r.fovy=90,this.setCamera(r),n.addComponent(e.RenderTargetRendererCameraController.create(r)),n.transform.translate(i),this._lookAtFace(n,i,t),n.init(),n},CubemapRenderTargetRenderer.prototype.isRenderListEmpty=function(e){var t=this,r=!0;return e.forEach(function(e){if(!t._isEmpty(e))return r=!1,wdCb.$BREAK},this),r},CubemapRenderTargetRenderer.prototype._isEmpty=function(e){return void 0===e||0===e.getCount()},CubemapRenderTargetRenderer.prototype._convertIndexToFaceKey=function(e){var t=null;switch(e){case 0:t="px";break;case 1:t="nx";break;case 2:t="py";break;case 3:t="ny";break;case 4:t="pz";break;case 5:t="nz"}return t},CubemapRenderTargetRenderer.prototype._lookAtFace=function(e,t,r){switch(r){case 0:e.transform.lookAt(t.x+1,t.y,t.z,0,-1,0);break;case 1:e.transform.lookAt(t.x-1,t.y,t.z,0,-1,0);break;case 2:e.transform.lookAt(t.x,t.y+1,t.z,0,0,1);break;case 3:e.transform.lookAt(t.x,t.y-1,t.z,0,0,-1);break;case 4:e.transform.lookAt(t.x,t.y,t.z+1,0,-1,0);break;case 5:e.transform.lookAt(t.x,t.y,t.z-1,0,-1,0)}},CubemapRenderTargetRenderer.prototype._isNeedCreateCamera=function(e){return null===this._lastPosition||null===this._lastCameraList||0===this._lastCameraList.getCount()||!e.isEqual(this._lastPosition)},__decorate([e.virtual],CubemapRenderTargetRenderer.prototype,"renderRenderer",null),__decorate([e.virtual],CubemapRenderTargetRenderer.prototype,"beforeRenderFrameBufferTexture",null),__decorate([e.require(function(t,r,n){e.assert(!!n,e.Log.info.FUNC_SHOULD("pass param->camera"))})],CubemapRenderTargetRenderer.prototype,"renderFrameBufferTexture",null),CubemapRenderTargetRenderer}(e.CommonRenderTargetRenderer);e.CubemapRenderTargetRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DynamicCubemapRenderTargetRenderer(){t.apply(this,arguments)}return __extends(DynamicCubemapRenderTargetRenderer,t),DynamicCubemapRenderTargetRenderer.create=function(e){var t=new this(e);return t.initWhenCreate(),t},DynamicCubemapRenderTargetRenderer.prototype.getRenderList=function(){return this.texture.renderList},DynamicCubemapRenderTargetRenderer.prototype.setCamera=function(e){e.aspect=1,e.near=this.texture.near,e.far=this.texture.far},DynamicCubemapRenderTargetRenderer.prototype.getPosition=function(){return this.texture.getPosition()},DynamicCubemapRenderTargetRenderer.prototype.beforeRender=function(){this.isRenderListEmptyWhenRender()?e.Director.getInstance().scene.glslData.addChild(e.EShaderGLSLData.DYNAMIC_CUBEMAP,{isRenderListEmpty:!0}):e.Director.getInstance().scene.glslData.addChild(e.EShaderGLSLData.DYNAMIC_CUBEMAP,{isRenderListEmpty:!1})},DynamicCubemapRenderTargetRenderer}(e.CubemapRenderTargetRenderer);e.DynamicCubemapRenderTargetRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Renderer(){this._webglState=null,this.skyboxCommand=null}return Object.defineProperty(Renderer.prototype,"webglState",{get:function(){return this._webglState?this._webglState:e.BasicState.create()},set:function(e){this._webglState=e},enumerable:!0,configurable:!0}),Renderer.prototype.init=function(){},__decorate([e.virtual],Renderer.prototype,"init",null),Renderer}();e.Renderer=t}(wd||(wd={}));var wd;!function(e){var t=31,r=31,n=1024,i=1024,o=1024,a=30,s=a-5,c=a-5-5,u=a-5-5-10,l=function(a){function WebGLRenderer(){a.apply(this,arguments),this._commandQueue=wdCb.Collection.create(),this._clearOptions={color:e.Color.create("#000000")}}return __extends(WebGLRenderer,a),WebGLRenderer.create=function(){var e=new this;return e},WebGLRenderer.prototype.addCommand=function(e){this._commandQueue.addChild(e),e.init()},WebGLRenderer.prototype.hasCommand=function(){return this._commandQueue.getCount()>0||!!this.skyboxCommand},WebGLRenderer.prototype.clear=function(){e.DeviceManager.getInstance().clear(this._clearOptions)},WebGLRenderer.prototype.render=function(){var t=this,r=e.DeviceManager.getInstance(),n=this.webglState,i=[],o=[];if(this._commandQueue.forEach(function(r){r.webglState=n,r.blend?i.push(r):r instanceof e.QuadCommand?(t._buildOpaqueCommandSortId(r),o.push(r)):r.execute()},this),o.length>0){this._sortOpaqueQuadCommand(o);for(var a=0,s=o;a<s.length;a++){var c=s[a];c.execute()}}i.length>0&&(r.depthWrite=!1,this._renderSortedTransparentCommands(i),r.depthWrite=!0),this.skyboxCommand&&(r.depthFunc=e.EDepthFunction.LEQUAL,this.skyboxCommand.webglState=n,this.skyboxCommand.execute(),r.depthFunc=e.EDepthFunction.LESS),this._clearCommand(),this.webglState=null},WebGLRenderer.prototype.init=function(){var t=e.DeviceManager.getInstance();t.depthTest=!0,t.blend=!1,t.setColorWrite(!0,!0,!0,!0),t.side=e.ESide.FRONT,t.depthWrite=!0},WebGLRenderer.prototype.setClearColor=function(e){this._setClearOptions({color:e})},WebGLRenderer.prototype._renderSortedTransparentCommands=function(t){for(var r=this,n=0,i=e.SortUtils.insertSort(t,function(e,t){return r._getObjectZDistanceInCameraCoordinate(e)<r._getObjectZDistanceInCameraCoordinate(t)});n<i.length;n++){var o=i[n];o.execute()}},WebGLRenderer.prototype._getObjectZDistanceInCameraCoordinate=function(e){return e.mMatrix.applyMatrix(e.vMatrix,!0).getTranslation().z},WebGLRenderer.prototype._clearCommand=function(){this._commandQueue.forEach(function(e){e.dispose()}),this._commandQueue.removeAllChildren(),this.skyboxCommand&&(this.skyboxCommand.dispose(),this.skyboxCommand=null)},WebGLRenderer.prototype._setClearOptions=function(e){wdCb.ExtendUtils.extend(this._clearOptions,e)},WebGLRenderer.prototype._buildOpaqueCommandSortId=function(e){var t=e.target,r=e.material;e.sortId=(t.renderGroup<<s|t.renderPriority<<c|this._buildShaderSortId(r.shader)<<u|this._mapEntityIdToRenderId(this._getTargetTexture(r),i))*o+this._mapEntityIdToRenderId(this._getTargetBuffer(r),o)},WebGLRenderer.prototype._buildShaderSortId=function(e){return this._mapEntityIdToRenderId(e.program,n)},WebGLRenderer.prototype._getTargetTexture=function(e){return e.getTextureForRenderSort()},WebGLRenderer.prototype._getTargetBuffer=function(e){return e.geometry.buffers.getBufferForRenderSort()},WebGLRenderer.prototype._mapEntityIdToRenderId=function(e,t){return e?e.uid%t:1},WebGLRenderer.prototype._sortOpaqueQuadCommand=function(t){e.SortUtils.quickSort(t,function(e,t){return e.sortId<t.sortId},!0)},__decorate([e.ensure(function(){e.assert(!this._commandQueue.hasRepeatItems(),e.Log.info.FUNC_SHOULD_NOT("has duplicate render command"))})],WebGLRenderer.prototype,"addCommand",null),__decorate([e.require(function(){e.assert(!!this.webglState,e.Log.info.FUNC_MUST_DEFINE("webglState"))})],WebGLRenderer.prototype,"render",null),__decorate([e.require(function(t){e.assert(!!e.Director.getInstance().scene.currentCamera,e.Log.info.FUNC_NOT_EXIST("current camera"));for(var r=0,n=t;r<n.length;r++){var i=n[r];e.assert(i instanceof e.QuadCommand,e.Log.info.FUNC_MUST_BE("transparent command","QuadCommand"))}})],WebGLRenderer.prototype,"_renderSortedTransparentCommands",null),__decorate([e.require(function(n){var i=n.target;e.assert(i.renderGroup<=t&&i.renderGroup>=0,e.Log.info.FUNC_SHOULD("renderGroup:"+i.renderGroup,"in range:[0, "+t+"]")),e.assert(i.renderPriority<=r&&i.renderPriority>=0,e.Log.info.FUNC_SHOULD("renderPriority:"+i.renderPriority,"in range:[0, "+r+"]"))})],WebGLRenderer.prototype,"_buildOpaqueCommandSortId",null),__decorate([e.ensure(function(t,r,n){e.assert(t>=0&&t<=n,e.Log.info.FUNC_SHOULD("mappedId:"+t,"in range:[0, "+n+"]"))})],WebGLRenderer.prototype,"_mapEntityIdToRenderId",null),__decorate([e.require(function(t){for(var r=0,n=t;r<n.length;r++){var i=n[r];e.assert(i instanceof e.QuadCommand,e.Log.info.FUNC_MUST_BE("command","QuadCommand")),e.assert(i.blend===!1,e.Log.info.FUNC_MUST_BE("command","opaque command"))}})],WebGLRenderer.prototype,"_sortOpaqueQuadCommand",null),WebGLRenderer}(e.Renderer);e.WebGLRenderer=l}(wd||(wd={}));var wd;!function(e){var t=function(){function WebGLState(){}return WebGLState.prototype.getSide=function(t){var r=e.Director.getInstance().scene;return r.side?r.side:t.side},WebGLState}();e.WebGLState=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function BasicState(){t.apply(this,arguments)}return __extends(BasicState,t),BasicState.create=function(){var e=new this;return e},BasicState.prototype.setState=function(t){var r=e.DeviceManager.getInstance();r.setColorWrite(t.redWrite,t.greenWrite,t.blueWrite,t.alphaWrite),r.polygonOffsetMode=t.polygonOffsetMode,r.side=this.getSide(t),r.blend=t.blend,t.blendFuncSeparate&&t.blendEquationSeparate?(r.setBlendFuncSeparate(t.blendFuncSeparate),r.setBlendEquationSeparate(t.blendEquationSeparate)):(r.setBlendFunc(t.blendSrc,t.blendDst),r.setBlendEquation(t.blendEquation)),t.alphaToCoverage&&(r.alphaToCoverage=t.alphaToCoverage)},__decorate([e.require(function(t){t.blendFuncSeparate&&t.blendEquationSeparate||e.assert(!!t.blendSrc&&!!t.blendDst&&!!t.blendEquation,wdCb.Log.info.FUNC_MUST("material.blendSrc && material.blendDst && material.blendEquation","be set"))})],BasicState.prototype,"setState",null),BasicState}(e.WebGLState);e.BasicState=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.POINTS="POINTS"]="POINTS",e[e.LINES="LINES"]="LINES",e[e.LINE_LOOP="LINE_LOOP"]="LINE_LOOP",e[e.LINE_STRIP="LINE_STRIP"]="LINE_STRIP",e[e.TRIANGLES="TRIANGLES"]="TRIANGLES",e[e.TRIANGLE_STRIP="TRIANGLE_STRIP"]="TRIANGLE_STRIP",e[e.TRANGLE_FAN="TRIANGLE_FAN"]="TRANGLE_FAN"}(e.EDrawMode||(e.EDrawMode={}));e.EDrawMode}(wd||(wd={}));var wd;!function(e){!function(e){e[e.BYTE="BYTE"]="BYTE",e[e.UNSIGNED_BYTE="UNSIGNED_BYTE"]="UNSIGNED_BYTE",e[e.SHORT="SHORT"]="SHORT",e[e.UNSIGNED_SHORT="UNSIGNED_SHORT"]="UNSIGNED_SHORT",e[e.INT="INT"]="INT",e[e.UNSIGNED_INT="UNSIGNED_INT"]="UNSIGNED_INT",e[e.FLOAT="FLOAT"]="FLOAT"}(e.EBufferType||(e.EBufferType={}));e.EBufferType}(wd||(wd={}));var wd;!function(e){!function(e){e[e.VERTICE="VERTICE"]="VERTICE",e[e.INDICE="INDICE"]="INDICE",e[e.NORMAL="NORMAL"]="NORMAL",e[e.TEXCOORD="TEXCOORD"]="TEXCOORD",e[e.TANGENT="TANGENT"]="TANGENT",e[e.COLOR="COLOR"]="COLOR",e[e.JOINT_INDICE="JOINT_INDICE"]="JOINT_INDICE",e[e.JOINT_WEIGHT="JOINT_WEIGHT"]="JOINT_WEIGHT",e[e.CUSTOM="CUSTOM"]="CUSTOM"}(e.EBufferDataType||(e.EBufferDataType={}));e.EBufferDataType}(wd||(wd={}));var wd;!function(e){!function(e){e[e.STREAM_DRAW="STREAM_DRAW"]="STREAM_DRAW",e[e.STATIC_DRAW="STATIC_DRAW"]="STATIC_DRAW",e[e.DYNAMIC_DRAW="DYNAMIC_DRAW"]="DYNAMIC_DRAW"}(e.EBufferUsage||(e.EBufferUsage={}));e.EBufferUsage}(wd||(wd={}));var wd;!function(e){var t=function(t){function Buffer(){t.apply(this,arguments),this.buffer=null}return __extends(Buffer,t),Buffer.prototype.dispose=function(){e.DeviceManager.getInstance().gl.deleteBuffer(this.buffer),delete this.buffer},Buffer}(e.Entity);e.Buffer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function InstanceBuffer(){t.apply(this,arguments),this._capacity=2048,this._cacheMap=wdCb.Hash.create()}return __extends(InstanceBuffer,t),InstanceBuffer.create=function(){var e=new this;return e.initWhenCreate(),e},Object.defineProperty(InstanceBuffer.prototype,"float32InstanceArraySize",{get:function(){return this._capacity/4},enumerable:!0,configurable:!0}),InstanceBuffer.prototype.initWhenCreate=function(){this.buffer=this._createBuffer()},InstanceBuffer.prototype.setCapacity=function(t){for(var r=this._capacity;r<t;)r*=2;this._capacity<r&&(this._capacity=r,this.buffer&&e.DeviceManager.getInstance().gl.deleteBuffer(this.buffer),this.buffer=this._createBuffer())},InstanceBuffer.prototype.resetData=function(t){var r=e.DeviceManager.getInstance().gl;r.bindBuffer(r.ARRAY_BUFFER,this.buffer),r.bufferSubData(r.ARRAY_BUFFER,0,t)},InstanceBuffer.prototype.bindBuffer=function(){var t=e.DeviceManager.getInstance().gl;t.bindBuffer(t.ARRAY_BUFFER,this.buffer)},InstanceBuffer.prototype.addCache=function(e,t){this._cacheMap.addChild(e,t)},InstanceBuffer.prototype.getCache=function(e){return this._cacheMap.getChild(e)},InstanceBuffer.prototype._createBuffer=function(){var t=e.DeviceManager.getInstance().gl,r=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,this._capacity,t.DYNAMIC_DRAW),e.BufferTable.resetBindedArrayBuffer(),r},InstanceBuffer}(e.Buffer);e.InstanceBuffer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CommonBuffer(){t.apply(this,arguments),this.type=null,this.count=null,this.usage=null}return __extends(CommonBuffer,t),CommonBuffer.prototype.resetBufferData=function(t,r,n){void 0===n&&(n=0);var i=e.DeviceManager.getInstance().gl;return this.usage===e.EBufferUsage.STATIC_DRAW&&0===n?void i.bufferData(i[t],r,i.DYNAMIC_DRAW):void i.bufferSubData(i[t],n,r)},CommonBuffer}(e.Buffer);e.CommonBuffer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ElementBuffer(){t.apply(this,arguments),this.data=null}return __extends(ElementBuffer,t),ElementBuffer.create=function(t,r,n){void 0===r&&(r=null),void 0===n&&(n=e.EBufferUsage.STATIC_DRAW);var i=new this;return i.initWhenCreate(t,r,n),i},Object.defineProperty(ElementBuffer.prototype,"typeSize",{get:function(){return this.data.BYTES_PER_ELEMENT},enumerable:!0,configurable:!0}),ElementBuffer.prototype.initWhenCreate=function(t,r,n){var i=e.DeviceManager.getInstance().gl,o=null,a=null;return this.buffer=i.createBuffer(),this.buffer?t?(o=this._checkIsNeed32Bits(t,r),a=this._convertToTypedArray(o,t),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.buffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,a,i[n]),e.BufferTable.resetBindedElementBuffer(),this._saveData(a,this._getType(o,r),n),this.buffer):null:(e.Log.warn("Failed to create the this.buffer object"),null)},ElementBuffer.prototype.resetData=function(t,r,n){void 0===r&&(r=null),void 0===n&&(n=0);var i=e.DeviceManager.getInstance().gl,o=this._checkIsNeed32Bits(t,r),a=this._convertToTypedArray(o,t);return i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.buffer),this.resetBufferData("ELEMENT_ARRAY_BUFFER",a,n),this._saveData(a,this._getType(o,r),e.EBufferUsage.DYNAMIC_DRAW),this},ElementBuffer.prototype._convertToTypedArray=function(e,t){return e?new Uint32Array(t):new Uint16Array(t)},ElementBuffer.prototype._checkIsNeed32Bits=function(t,r){var n=!1;if(null!==r)return r===e.EBufferType.UNSIGNED_INT;if(e.GPUDetector.getInstance().extensionUintIndices)for(var i=0,o=t;i<o.length;i++){var a=o[i];if(a>65535){n=!0;break}}else n=!1;return n},ElementBuffer.prototype._getType=function(t,r){return null===r?t?e.EBufferType.UNSIGNED_INT:e.EBufferType.UNSIGNED_SHORT:r},ElementBuffer.prototype._saveData=function(e,t,r){this.type=t,this.count=e.length,this.data=e,this.usage=r},__decorate([e.ensureGetter(function(t){e.assert(t>0,e.Log.info.FUNC_SHOULD("typeSize","> 0, but actual is "+t))})],ElementBuffer.prototype,"typeSize",null),__decorate([e.require(function(t,r,n){void 0===r&&(r=null),void 0===n&&(n=0),e.assert(this.buffer,e.Log.info.FUNC_MUST("create gl buffer"))})],ElementBuffer.prototype,"resetData",null),__decorate([e.require(function(t,r){null!==r&&(t?e.assert(r===e.EBufferType.UNSIGNED_INT,e.Log.info.FUNC_MUST_BE("type","UNSIGNED_SHORT, but actual is "+r)):e.assert(r===e.EBufferType.UNSIGNED_SHORT||r===e.EBufferType.UNSIGNED_INT,e.Log.info.FUNC_MUST_BE("type","UNSIGNED_SHORT or UNSIGNED_INT, but actual is "+r)))})],ElementBuffer.prototype,"_getType",null),ElementBuffer}(e.CommonBuffer);e.ElementBuffer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ArrayBuffer(){t.apply(this,arguments),this.size=null,this.data=null}return __extends(ArrayBuffer,t),ArrayBuffer.create=function(t,r,n,i){void 0===n&&(n=e.EBufferType.FLOAT),void 0===i&&(i=e.EBufferUsage.STATIC_DRAW);var o=new this;return o.initWhenCreate(t,r,n,i),o},ArrayBuffer.prototype.initWhenCreate=function(t,r,n,i){var o=e.DeviceManager.getInstance().gl,a=null;
return this.buffer=o.createBuffer(),this.buffer?t?(a=this._convertToTypedArray(t,n),o.bindBuffer(o.ARRAY_BUFFER,this.buffer),o.bufferData(o.ARRAY_BUFFER,a,o[i]),e.BufferTable.resetBindedArrayBuffer(),this._saveData(a,r,n,i),this.buffer):null:(e.Log.warn("Failed to create the this.buffer object"),null)},ArrayBuffer.prototype.resetData=function(t,r,n,i){void 0===r&&(r=this.size),void 0===n&&(n=this.type),void 0===i&&(i=0);var o=e.DeviceManager.getInstance().gl,a=this._convertToTypedArray(t,n);return o.bindBuffer(o.ARRAY_BUFFER,this.buffer),this.resetBufferData("ARRAY_BUFFER",a,i),this._saveData(a,r,n,e.EBufferUsage.DYNAMIC_DRAW),this},ArrayBuffer.prototype._convertToTypedArray=function(e,t){return new Float32Array(e)},ArrayBuffer.prototype._saveData=function(e,t,r,n){this.size=t,this.type=r,this.count=e.length/t,this.usage=n,this.data=e},__decorate([e.require(function(t,r,n,i){void 0===r&&(r=this.size),void 0===n&&(n=this.type),void 0===i&&(i=0),e.assert(this.buffer,e.Log.info.FUNC_MUST("create gl buffer"))})],ArrayBuffer.prototype,"resetData",null),ArrayBuffer}(e.CommonBuffer);e.ArrayBuffer=t}(wd||(wd={}));var wd;!function(e){var t=wdCb.Hash.create();t.addChild(e.EBufferDataType.VERTICE,"vertices"),t.addChild(e.EBufferDataType.INDICE,"indices"),t.addChild(e.EBufferDataType.NORMAL,"normals"),t.addChild(e.EBufferDataType.TEXCOORD,"texCoords"),t.addChild(e.EBufferDataType.COLOR,"colors"),t.addChild(e.EBufferDataType.TANGENT,"tangents"),t.addChild(e.EBufferDataType.JOINT_INDICE,"jointIndices"),t.addChild(e.EBufferDataType.JOINT_WEIGHT,"jointWeights");var r=function(){function BufferDataTable(){}return BufferDataTable.getGeometryDataName=function(e){var r=t.getChild(e);return r},__decorate([e.ensure(function(t,r){e.Log.error(void 0===t,e.Log.info.FUNC_NOT_EXIST(r,"in BufferDataTable"))})],BufferDataTable,"getGeometryDataName",null),BufferDataTable}();e.BufferDataTable=r}(wd||(wd={}));var wd;!function(e){var t=function(t){function Program(){t.apply(this,arguments),this.glProgram=null,this._getAttribLocationCache=wdCb.Hash.create(),this._sender=e.GLSLDataSender.create(this)}return __extends(Program,t),Program.create=function(){var e=new this;return e},Program.prototype.use=function(){e.JudgeUtils.isEqual(this,e.ProgramTable.lastUsedProgram)||(e.ProgramTable.lastUsedProgram=this,e.DeviceManager.getInstance().gl.useProgram(this.glProgram),this._sender.disableVertexAttribArray(),e.BufferTable.lastBindedArrayBufferListUidStr=null)},Program.prototype.getAttribLocation=function(t){var r=null,n=e.DeviceManager.getInstance().gl;return r=this._getAttribLocationCache.getChild(t),void 0!==r?r:(r=n.getAttribLocation(this.glProgram,t),this._getAttribLocationCache.addChild(t,r),r)},Program.prototype.getUniformLocation=function(e){return this._sender.getUniformLocation(e)},Program.prototype.sendUniformData=function(t,r,n){if(null!==n)switch(r){case e.EVariableType.FLOAT_1:this._sender.sendFloat1(t,n);break;case e.EVariableType.FLOAT_2:this._sender.sendFloat2(t,n);break;case e.EVariableType.FLOAT_3:this._sender.sendFloat3(t,n);break;case e.EVariableType.FLOAT_4:this._sender.sendFloat4(t,n);break;case e.EVariableType.VECTOR_2:this._sender.sendVector2(t,n);break;case e.EVariableType.VECTOR_3:this._sender.sendVector3(t,n);break;case e.EVariableType.VECTOR_4:this._sender.sendVector4(t,n);break;case e.EVariableType.COLOR_3:this._sender.sendColor3(t,n);break;case e.EVariableType.FLOAT_MAT3:this._sender.sendMatrix3(t,n);break;case e.EVariableType.FLOAT_MAT4:this._sender.sendMatrix4(t,n);break;case e.EVariableType.NUMBER_1:case e.EVariableType.SAMPLER_CUBE:case e.EVariableType.SAMPLER_2D:this._sender.sendNum1(t,n);break;case e.EVariableType.FLOAT_MAT4_ARRAY:this._sender.sendMatrix4Array(t,n);break;case e.EVariableType.SAMPLER_ARRAY:this._sender.sendSampleArray(t,n);break;default:e.Log.error(!0,e.Log.info.FUNC_INVALID("EVariableType:",r))}},Program.prototype.sendAttributeBuffer=function(e,t,r){var n=null;n=this.getAttribLocation(e),n!==-1&&this._sender.addBufferToToSendList(n,r)},Program.prototype.sendStructureData=function(e,t,r){this.sendUniformData(e,t,r)},Program.prototype.sendFloat1=function(e,t){this._sender.sendFloat1(e,t)},Program.prototype.sendFloat2=function(e,t){this._sender.sendFloat2(e,t)},Program.prototype.sendFloat3=function(e,t){this._sender.sendFloat3(e,t)},Program.prototype.sendFloat4=function(e,t){this._sender.sendFloat4(e,t)},Program.prototype.sendVector2=function(e,t){this._sender.sendVector2(e,t)},Program.prototype.sendVector3=function(e,t){this._sender.sendVector3(e,t)},Program.prototype.sendVector4=function(e,t){this._sender.sendVector4(e,t)},Program.prototype.sendColor3=function(e,t){this._sender.sendColor3(e,t)},Program.prototype.sendNum1=function(e,t){this._sender.sendNum1(e,t)},Program.prototype.sendMatrix3=function(e,t){this._sender.sendMatrix3(e,t)},Program.prototype.sendMatrix4=function(e,t){this._sender.sendMatrix4(e,t)},Program.prototype.sendMatrix4Array=function(e,t){this._sender.sendMatrix4Array(e,t)},Program.prototype.sendSampleArray=function(e,t){this._sender.sendSampleArray(e,t)},Program.prototype.sendAllBufferData=function(e){this._sender.sendAllBufferData(e),this._sender.clearBufferList()},Program.prototype.initWithShader=function(t){var r=e.DeviceManager.getInstance().gl,n=null,i=null;return this.glProgram&&this.dispose(),this.glProgram=e.DeviceManager.getInstance().gl.createProgram(),n=t.createVsShader(),i=t.createFsShader(),r.attachShader(this.glProgram,n),r.attachShader(this.glProgram,i),r.bindAttribLocation(this.glProgram,0,"a_position"),r.linkProgram(this.glProgram),e.Log.error(r.getProgramParameter(this.glProgram,r.LINK_STATUS)===!1,r.getProgramInfoLog(this.glProgram)),r.deleteShader(n),r.deleteShader(i),this},Program.prototype.dispose=function(){var t=e.DeviceManager.getInstance().gl;t.deleteProgram(this.glProgram),this.glProgram=null,this._sender.dispose(),this._clearAllCache()},Program.prototype._clearAllCache=function(){this._getAttribLocationCache.removeAllChildren(),this._sender.clearAllCache()},__decorate([e.require(function(t,r,n){e.assert(n instanceof e.ArrayBuffer,e.Log.info.FUNC_MUST_BE("ArrayBuffer")),e.assert(r===e.EVariableType.BUFFER,e.Log.info.FUNC_SHOULD("type","be EVariableType.BUFFER, but actual is "+r))})],Program.prototype,"sendAttributeBuffer",null),Program}(e.Entity);e.Program=t}(wd||(wd={}));var wd;!function(e){var t=function(){function GLSLDataSender(e){this._program=null,this._uniformCache={},this._vertexAttribHistory=[],this._getUniformLocationCache={},this._toSendBufferArr=[],this._toSendBuffersUidStr="",this._program=e}return GLSLDataSender.create=function(e){var t=new this(e);return t},GLSLDataSender.prototype.sendFloat1=function(t,r){var n=null,i=null;this._uniformCache[t]!=r&&(this._recordUniformData(t,r),n=e.DeviceManager.getInstance().gl,i=this.getUniformLocation(t),this._isUniformDataNotExistByLocation(i)||n.uniform1f(i,Number(r)))},GLSLDataSender.prototype.sendFloat2=function(t,r){var n=null,i=null,o=this._uniformCache[t];o&&o[0]===r[0]&&o[1]===r[1]||(this._recordUniformData(t,r),n=e.DeviceManager.getInstance().gl,i=this.getUniformLocation(t),this._isUniformDataNotExistByLocation(i)||n.uniform2f(i,r[0],r[1]))},GLSLDataSender.prototype.sendFloat3=function(t,r){var n=null,i=null,o=this._uniformCache[t];o&&o[0]===r[0]&&o[1]===r[1]&&o[2]===r[2]||(this._recordUniformData(t,r),n=e.DeviceManager.getInstance().gl,i=this.getUniformLocation(t),this._isUniformDataNotExistByLocation(i)||n.uniform3f(i,r[0],r[1],r[2]))},GLSLDataSender.prototype.sendFloat4=function(t,r){var n=null,i=null,o=this._uniformCache[t];o&&o[0]===r[0]&&o[1]===r[1]&&o[2]===r[2]&&o[3]===r[3]||(this._recordUniformData(t,r),n=e.DeviceManager.getInstance().gl,i=this.getUniformLocation(t),this._isUniformDataNotExistByLocation(i)||n.uniform4f(i,r[0],r[1],r[2],r[3]))},GLSLDataSender.prototype.sendVector2=function(t,r){var n=null,i=null,o=this._uniformCache[t];if(!o||o[0]!=r.x||o[1]!=r.y){var a=r.x,s=r.y;this._recordUniformData(t,[a,s]),n=e.DeviceManager.getInstance().gl,i=this.getUniformLocation(t),this._isUniformDataNotExistByLocation(i)||n.uniform2f(i,a,s)}},GLSLDataSender.prototype.sendVector3=function(t,r){var n=null,i=null,o=this._uniformCache[t];if(!o||o[0]!=r.x||o[1]!=r.y||o[2]!=r.z){var a=r.x,s=r.y,c=r.z;this._recordUniformData(t,[a,s,c]),n=e.DeviceManager.getInstance().gl,i=this.getUniformLocation(t),this._isUniformDataNotExistByLocation(i)||n.uniform3f(i,a,s,c)}},GLSLDataSender.prototype.sendVector4=function(t,r){var n=null,i=null,o=this._uniformCache[t];if(!o||o[0]!=r.x||o[1]!=r.y||o[2]!=r.z||o[3]!=r.w){var a=r.x,s=r.y,c=r.z,u=r.w;this._recordUniformData(t,[a,s,c,u]),n=e.DeviceManager.getInstance().gl,i=this.getUniformLocation(t),this._isUniformDataNotExistByLocation(i)||n.uniform4f(i,a,s,c,u)}},GLSLDataSender.prototype.sendColor3=function(t,r){var n=null,i=null,o=this._uniformCache[t];if(!o||o[0]!=r.r||o[1]!=r.g||o[2]!=r.b){var a=r.r,s=r.g,c=r.b;this._recordUniformData(t,[a,s,c]),n=e.DeviceManager.getInstance().gl,i=this.getUniformLocation(t),this._isUniformDataNotExistByLocation(i)||n.uniform3f(i,a,s,c)}},GLSLDataSender.prototype.sendNum1=function(t,r){var n=null,i=null;this._uniformCache[t]!==r&&(this._recordUniformData(t,r),n=e.DeviceManager.getInstance().gl,i=this.getUniformLocation(t),this._isUniformDataNotExistByLocation(i)||n.uniform1i(i,r))},GLSLDataSender.prototype.sendMatrix3=function(t,r){var n=e.DeviceManager.getInstance().gl,i=this.getUniformLocation(t);this._isUniformDataNotExistByLocation(i)||n.uniformMatrix3fv(i,!1,r.values)},GLSLDataSender.prototype.sendMatrix4=function(t,r){var n=e.DeviceManager.getInstance().gl,i=this.getUniformLocation(t);this._isUniformDataNotExistByLocation(i)||n.uniformMatrix4fv(i,!1,r.values)},GLSLDataSender.prototype.sendMatrix4Array=function(t,r){var n=e.DeviceManager.getInstance().gl,i=this.getUniformLocation(t+"[0]");this._isUniformDataNotExistByLocation(i)||n.uniformMatrix4fv(i,!1,r)},GLSLDataSender.prototype.sendSampleArray=function(t,r){var n=null,i=null,o=this._uniformCache[t],a=!0;if(o){for(var s=0,c=r.length;s<c;s++)if(o[s]!==r[s]){a=!1;break}if(a)return}this._recordUniformData(t,r),n=e.DeviceManager.getInstance().gl,i=this.getUniformLocation(t),this._isUniformDataNotExistByLocation(i)||n.uniform1iv(i,r)},GLSLDataSender.prototype.getUniformLocation=function(t){var r=null,n=e.DeviceManager.getInstance().gl;return r=this._getUniformLocationCache[t],void 0!==r?r:(r=n.getUniformLocation(this._program.glProgram,t),this._getUniformLocationCache[t]=r,r)},GLSLDataSender.prototype.addBufferToToSendList=function(e,t){this._toSendBufferArr[e]=t,this._toSendBuffersUidStr+=String(t.uid)},GLSLDataSender.prototype.sendAllBufferData=function(e){var t=this._toSendBufferArr;if(e)return void e.sendAllBufferData(this._toSendBuffersUidStr,t);for(var r=0,n=t.length;r<n;r++){var i=t[r];i&&this.sendBuffer(r,i)}},GLSLDataSender.prototype.clearBufferList=function(){this._toSendBufferArr=[],this._toSendBuffersUidStr=""},GLSLDataSender.prototype.sendBuffer=function(t,r){var n=e.DeviceManager.getInstance().gl;n.bindBuffer(n.ARRAY_BUFFER,r.buffer),n.vertexAttribPointer(t,r.size,n[r.type],!1,0,0),this._vertexAttribHistory[t]!==!0&&(n.enableVertexAttribArray(t),this._vertexAttribHistory[t]=!0)},GLSLDataSender.prototype.disableVertexAttribArray=function(){var t=e.DeviceManager.getInstance().gl;for(var r in this._vertexAttribHistory){var n=+r;n>t.VERTEX_ATTRIB_ARRAY_ENABLED||!this._vertexAttribHistory[n]||(this._vertexAttribHistory[n]=!1,t.disableVertexAttribArray(n))}this._vertexAttribHistory=[]},GLSLDataSender.prototype.clearAllCache=function(){this._getUniformLocationCache={},this._uniformCache={}},GLSLDataSender.prototype.dispose=function(){this.disableVertexAttribArray()},GLSLDataSender.prototype._recordUniformData=function(e,t){this._uniformCache[e]=t},GLSLDataSender.prototype._isUniformDataNotExistByLocation=function(e){return null===e},__decorate([e.require(function(t,r){e.assert(e.JudgeUtils.isNumber(r),e.Log.info.FUNC_MUST_BE("data","be number"))})],GLSLDataSender.prototype,"sendNum1",null),__decorate([e.require(function(t,r){e.it("data should be array, but actual is "+r,function(){e.expect(e.JudgeUtils.isFloatArray(r)||e.JudgeUtils.isArrayExactly(r))["true"]}),e.it("name shouldn't be the first matrix of the array",function(){e.expect(/\[0\]$/.test(t))["false"]})})],GLSLDataSender.prototype,"sendMatrix4Array",null),__decorate([e.require(function(t,r){e.assert(e.JudgeUtils.isArrayExactly(r),e.Log.info.FUNC_SHOULD("data","be array, but actual is "+r));for(var n=0,i=r;n<i.length;n++){var o=i[n];e.assert(e.JudgeUtils.isNumber(o),e.Log.info.FUNC_SHOULD("data","be Array<number>, but actual is "+r))}})],GLSLDataSender.prototype,"sendSampleArray",null),__decorate([e.require(function(){e.assert(!e.ArrayUtils.hasRepeatItems(this._toSendBufferArr),e.Log.info.FUNC_SHOULD_NOT("_toSendBufferArr","has repeat buffer"))}),e.cache(function(){return e.BufferTable.lastBindedArrayBufferListUidStr===this._toSendBuffersUidStr},function(){},function(){e.BufferTable.lastBindedArrayBufferListUidStr=this._toSendBuffersUidStr})],GLSLDataSender.prototype,"sendAllBufferData",null),GLSLDataSender}();e.GLSLDataSender=t}(wd||(wd={}));var wd;!function(e){var t=function(){function RenderCommand(){this._webglState=null,this.drawMode=e.EDrawMode.TRIANGLES,this.blend=!1,this.vaoManager=null}return Object.defineProperty(RenderCommand.prototype,"webglState",{get:function(){return this._webglState?this._webglState:e.BasicState.create()},set:function(e){this._webglState=e},enumerable:!0,configurable:!0}),RenderCommand.prototype.init=function(){},RenderCommand.prototype.dispose=function(){},RenderCommand.prototype.drawElements=function(t){var r=0,n=e.DeviceManager.getInstance().gl;e.BufferTable.bindIndexBuffer(t),e.GlUtils.drawElements(n[this.drawMode],t.count,n[t.type],t.typeSize*r)},RenderCommand.prototype.drawArray=function(t){var r=0,n=e.DeviceManager.getInstance().gl;e.GlUtils.drawArrays(n[this.drawMode],r,t.count)},__decorate([e.virtual],RenderCommand.prototype,"init",null),__decorate([e.virtual],RenderCommand.prototype,"dispose",null),RenderCommand}();e.RenderCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function QuadCommand(){t.apply(this,arguments),this.mMatrix=null,this.vMatrix=null,this.pMatrix=null,this.buffers=null,this.material=null,this.target=null,this.sortId=null}return __extends(QuadCommand,t),Object.defineProperty(QuadCommand.prototype,"program",{get:function(){return this.material.program},enumerable:!0,configurable:!0}),Object.defineProperty(QuadCommand.prototype,"mvpMatrix",{get:function(){return this.mMatrix.applyMatrix(this.vMatrix,!0).applyMatrix(this.pMatrix,!1)},enumerable:!0,configurable:!0}),Object.defineProperty(QuadCommand.prototype,"vpMatrix",{get:function(){return this.vMatrix.applyMatrix(this.pMatrix,!0)},enumerable:!0,configurable:!0}),QuadCommand.prototype.execute=function(){var e=this.material;e.updateShader(this),this.draw(e)},__decorate([e.requireGetter(function(){e.assert(!!this.mMatrix&&!!this.vMatrix&&!!this.pMatrix,e.Log.info.FUNC_NOT_EXIST("mMatrix or vMatrix or pMatrix"))})],QuadCommand.prototype,"mvpMatrix",null),__decorate([e.requireGetter(function(){e.assert(!!this.vMatrix&&!!this.pMatrix,e.Log.info.FUNC_NOT_EXIST("vMatrix or pMatrix"))})],QuadCommand.prototype,"vpMatrix",null),QuadCommand}(e.RenderCommand);e.QuadCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function SingleDrawCommand(){t.apply(this,arguments),this.normalMatrix=null}return __extends(SingleDrawCommand,t),SingleDrawCommand.create=function(){var e=new this;return e},SingleDrawCommand.prototype.draw=function(t){var r=null,n=this.buffers.getChild(e.EBufferDataType.INDICE);this.webglState.setState(t),n?this.drawElements(n):(r=this.buffers.getChild(e.EBufferDataType.VERTICE),this.drawArray(r))},SingleDrawCommand}(e.QuadCommand);e.SingleDrawCommand=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.MODELMATRIX=0]="MODELMATRIX",e[e.NORMALMATRIX_MODELMATRIX=1]="NORMALMATRIX_MODELMATRIX",e[e.ONE_MANY=2]="ONE_MANY"}(e.EInstanceGLSLData||(e.EInstanceGLSLData={}));e.EInstanceGLSLData}(wd||(wd={}));var wd;!function(e){var t=function(e){function InstanceCommand(){e.apply(this,arguments)}return __extends(InstanceCommand,e),InstanceCommand}(e.QuadCommand);e.InstanceCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function HardwareInstanceCommand(){e.apply(this,arguments),this.glslData=null,this.instanceBuffer=null}return __extends(HardwareInstanceCommand,e),HardwareInstanceCommand}(e.InstanceCommand);e.HardwareInstanceCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function OneToOneHardwareInstanceCommand(){t.apply(this,arguments),this.instanceList=null}return __extends(OneToOneHardwareInstanceCommand,t),OneToOneHardwareInstanceCommand.create=function(){var e=new this;return e},OneToOneHardwareInstanceCommand.prototype.draw=function(t){var r=null;if(this._hasInstance()){switch(this.webglState.setState(t),this.glslData){case e.EInstanceGLSLData.MODELMATRIX:r=e.ModelMatrixHardwareInstanceDrawer.getInstance();break;case e.EInstanceGLSLData.NORMALMATRIX_MODELMATRIX:r=e.NormalMatrixModelMatrixHardwareInstanceDrawer.getInstance();break;default:e.Log.error(!0,e.Log.info.FUNC_INVALID("glslData:"+this.glslData))}r.draw(this.instanceList,this.instanceBuffer,this.program,this.buffers,this.drawMode)}},OneToOneHardwareInstanceCommand.prototype._hasInstance=function(){return!!this.instanceList&&this.instanceList.getCount()>0},__decorate([e.ensure(function(t){e.assert(e.JudgeUtils.isBoolean(t),e.Log.info.FUNC_SHOULD("return boolean value")),t&&(e.assert(e.InstanceUtils.isHardwareSupport(),e.Log.info.FUNC_SHOULD("hardware","support instance")),e.assert(!!this.instanceBuffer,e.Log.info.FUNC_MUST_DEFINE("instanceBuffer")))})],OneToOneHardwareInstanceCommand.prototype,"_hasInstance",null),OneToOneHardwareInstanceCommand}(e.HardwareInstanceCommand);e.OneToOneHardwareInstanceCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function OneToManyHardwareInstanceCommand(){t.apply(this,arguments),this.geometry=null}return __extends(OneToManyHardwareInstanceCommand,t),OneToManyHardwareInstanceCommand.create=function(){var e=new this;return e},OneToManyHardwareInstanceCommand.prototype.draw=function(t){var r=null;this.webglState.setState(t),r=e.OneToManyHardwareInstanceDrawer.getInstance(),r.draw(this.geometry,this.instanceBuffer,this.program,this.buffers,this.drawMode)},__decorate([e.require(function(t){var r=this;e.it("glslData should be ONE_MANY",function(){e.expect(r.glslData).equals(e.EInstanceGLSLData.ONE_MANY)},this)})],OneToManyHardwareInstanceCommand.prototype,"draw",null),OneToManyHardwareInstanceCommand}(e.HardwareInstanceCommand);e.OneToManyHardwareInstanceCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ProceduralCommand(){t.apply(this,arguments),this.shader=null,this.indexBuffer=null,this.vertexBuffer=null}return __extends(ProceduralCommand,t),ProceduralCommand.create=function(){var e=new this;return e},ProceduralCommand.prototype.init=function(){this.blend=!1,this.drawMode=e.EDrawMode.TRIANGLES},ProceduralCommand.prototype.execute=function(){this.shader.update(this),this.drawElements(this.indexBuffer)},ProceduralCommand}(e.RenderCommand);e.ProceduralCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(){function InstanceDrawer(){}return InstanceDrawer}();e.InstanceDrawer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function HardwareInstanceDrawer(){t.apply(this,arguments)}return __extends(HardwareInstanceDrawer,t),HardwareInstanceDrawer.prototype.unBind=function(t,r){var n=e.DeviceManager.getInstance().gl,i=e.GPUDetector.getInstance().extensionInstancedArrays;n.bindBuffer(n.ARRAY_BUFFER,t.buffer);for(var o=0,a=r;o<a.length;o++){var s=a[o];n.disableVertexAttribArray(s),i.vertexAttribDivisorANGLE(s,0)}},HardwareInstanceDrawer.prototype.drawElementsInstancedANGLE=function(t,r,n){var i=0,o=e.DeviceManager.getInstance().gl;e.BufferTable.bindIndexBuffer(t),e.GlUtils.drawElementsInstancedANGLE(o[n],t.count,o[t.type],t.typeSize*i,r)},HardwareInstanceDrawer}(e.InstanceDrawer);e.HardwareInstanceDrawer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function OneToOneHardwareInstanceDrawer(){t.apply(this,arguments)}return __extends(OneToOneHardwareInstanceDrawer,t),OneToOneHardwareInstanceDrawer.prototype.draw=function(t,r,n,i,o){var a=null,s=this.getOffsetLocationArray(n);if(this.setCapacity(t,r),this.sendGLSLData(t,r,s),a=i.getChild(e.EBufferDataType.INDICE))this.drawElementsInstancedANGLE(a,t.getCount(),o);else{var c=i.getChild(e.EBufferDataType.VERTICE);this._drawArraysInstancedANGLE(c,t.getCount(),o)}this.unBind(r,s)},OneToOneHardwareInstanceDrawer.prototype._drawArraysInstancedANGLE=function(t,r,n){var i=0,o=e.DeviceManager.getInstance().gl;e.GlUtils.drawArraysInstancedANGLE(o[n],i,t.count,r)},__decorate([e.require(function(){e.assert(e.InstanceUtils.isHardwareSupport(),e.Log.info.FUNC_SHOULD("hardware","support instance"))})],OneToOneHardwareInstanceDrawer.prototype,"draw",null),OneToOneHardwareInstanceDrawer}(e.HardwareInstanceDrawer);e.OneToOneHardwareInstanceDrawer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function OneToManyHardwareInstanceDrawer(){t.call(this),this._geometry=null}return __extends(OneToManyHardwareInstanceDrawer,t),OneToManyHardwareInstanceDrawer.getInstance=function(){},OneToManyHardwareInstanceDrawer.prototype.draw=function(t,r,n,i,o){var a=null,s=null;this._geometry=t,s=this.getOffsetLocationArray(n,r),this.setCapacity(r),this.sendGLSLData(r,s),a=i.getChild(e.EBufferDataType.INDICE),this.drawElementsInstancedANGLE(a,this._geometry.instanceCount,o),this.unBind(r,s),this._geometry.dirty&&(this._geometry.dirty=!1)},OneToManyHardwareInstanceDrawer.prototype.getOffsetLocationArray=function(e,t){return this._geometry.instanceAttributeData.map(function(t){return e.getAttribLocation(t.attributeName)}).toArray()},OneToManyHardwareInstanceDrawer.prototype.setCapacity=function(e){e.setCapacity(this._geometry.instanceCount*this._getStride(e))},OneToManyHardwareInstanceDrawer.prototype.sendGLSLData=function(t,r){var n=new Float32Array(t.float32InstanceArraySize),i=0,o=this._geometry.attributeData,a=this._geometry.instanceAttributeData,s=e.DeviceManager.getInstance().gl,c=e.GPUDetector.getInstance().extensionInstancedArrays;this._geometry.dirty?(o.forEach(function(e){e.forEach(function(e){n.set(e.data,i),i+=e.data.length})}),t.resetData(n)):t.bindBuffer();var u=this._getStride(t);i=0,a.forEach(function(e,t){var n=r[t],o=e.data.length;s.enableVertexAttribArray(n),s.vertexAttribPointer(n,o,s.FLOAT,!1,u,i),c.vertexAttribDivisorANGLE(n,e.meshPerAttribute),i+=4*o})},OneToManyHardwareInstanceDrawer.prototype._getStride=function(e){var t=0;return this._geometry.instanceAttributeData.forEach(function(e){t+=4*e.data.length}),t},__decorate([e.require(function(t,r,n,i,o){e.it("hardware should support instance",function(){e.expect(e.InstanceUtils.isHardwareSupport())["true"]}),e.it("indexBuffer should exist",function(){e.expect(i.getChild(e.EBufferDataType.INDICE)).exist})})],OneToManyHardwareInstanceDrawer.prototype,"draw",null),__decorate([e.require(function(t,r){var n=this;e.it("if cached, should geometry.dirty === false && has cache data",function(){n._geometry.dirty||e.expect(r.getCache("offsetLocationArray")).exist})}),e.cache(function(e,t){return!this._geometry.dirty},function(e,t){return t.getCache("offsetLocationArray")},function(e,t,r){r.addCache("offsetLocationArray",e)})],OneToManyHardwareInstanceDrawer.prototype,"getOffsetLocationArray",null),__decorate([e.require(function(t){var r=this;e.it("if cached, should geometry.dirty === false && has cache data",function(){r._geometry.dirty||e.expect(t.getCache("stride")).exist})}),e.cache(function(e){return!this._geometry.dirty},function(e){return e.getCache("stride")},function(e,t){t.addCache("stride",e)})],OneToManyHardwareInstanceDrawer.prototype,"_getStride",null),OneToManyHardwareInstanceDrawer=__decorate([e.singleton()],OneToManyHardwareInstanceDrawer)}(e.HardwareInstanceDrawer);e.OneToManyHardwareInstanceDrawer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ModelMatrixHardwareInstanceDrawer(){t.call(this)}return __extends(ModelMatrixHardwareInstanceDrawer,t),ModelMatrixHardwareInstanceDrawer.getInstance=function(){},ModelMatrixHardwareInstanceDrawer.prototype.getOffsetLocationArray=function(e){return[e.getAttribLocation("a_mVec4_0"),e.getAttribLocation("a_mVec4_1"),e.getAttribLocation("a_mVec4_2"),e.getAttribLocation("a_mVec4_3")]},ModelMatrixHardwareInstanceDrawer.prototype.setCapacity=function(e,t){t.setCapacity(64*e.getCount())},ModelMatrixHardwareInstanceDrawer.prototype.sendGLSLData=function(t,r,n){var i=new Float32Array(r.float32InstanceArraySize),o=0,a=e.DeviceManager.getInstance().gl,s=e.GPUDetector.getInstance().extensionInstancedArrays;t.forEach(function(e){var t=e.transform.localToWorldMatrix;t.cloneToArray(i,o),o+=16}),r.resetData(i);for(var c=0;c<4;c++){var u=n[c];a.enableVertexAttribArray(u),a.vertexAttribPointer(u,4,a.FLOAT,!1,64,16*c),s.vertexAttribDivisorANGLE(u,1)}},ModelMatrixHardwareInstanceDrawer=__decorate([e.singleton()],ModelMatrixHardwareInstanceDrawer)}(e.OneToOneHardwareInstanceDrawer);e.ModelMatrixHardwareInstanceDrawer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function NormalMatrixModelMatrixHardwareInstanceDrawer(){t.call(this)}return __extends(NormalMatrixModelMatrixHardwareInstanceDrawer,t),NormalMatrixModelMatrixHardwareInstanceDrawer.getInstance=function(){},NormalMatrixModelMatrixHardwareInstanceDrawer.prototype.getOffsetLocationArray=function(e){return[e.getAttribLocation("a_mVec4_0"),e.getAttribLocation("a_mVec4_1"),e.getAttribLocation("a_mVec4_2"),e.getAttribLocation("a_mVec4_3"),e.getAttribLocation("a_normalVec4_0"),e.getAttribLocation("a_normalVec4_1"),e.getAttribLocation("a_normalVec4_2")]},NormalMatrixModelMatrixHardwareInstanceDrawer.prototype.setCapacity=function(e,t){t.setCapacity(112*e.getCount())},NormalMatrixModelMatrixHardwareInstanceDrawer.prototype.sendGLSLData=function(t,r,n){var i=new Float32Array(r.float32InstanceArraySize),o=0,a=e.DeviceManager.getInstance().gl,s=e.GPUDetector.getInstance().extensionInstancedArrays;t.forEach(function(e){var t=e.transform.localToWorldMatrix,r=e.transform.normalMatrix;t.cloneToArray(i,o),o+=16,r.cloneToArray(i,o),o+=9}),r.resetData(i);for(var c=0;c<4;c++){var u=n[c];a.enableVertexAttribArray(u),a.vertexAttribPointer(u,4,a.FLOAT,!1,100,16*c),s.vertexAttribDivisorANGLE(u,1)}for(var c=4;c<7;c++){var u=n[c];a.enableVertexAttribArray(u),a.vertexAttribPointer(u,3,a.FLOAT,!1,100,12*(c-4)+64),s.vertexAttribDivisorANGLE(u,1)}},NormalMatrixModelMatrixHardwareInstanceDrawer=__decorate([e.singleton()],NormalMatrixModelMatrixHardwareInstanceDrawer)}(e.OneToOneHardwareInstanceDrawer);e.NormalMatrixModelMatrixHardwareInstanceDrawer=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BatchInstanceCommand(){e.apply(this,arguments),this.glslData=null}return __extends(BatchInstanceCommand,e),BatchInstanceCommand}(e.InstanceCommand);e.BatchInstanceCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function OneToOneBatchInstanceCommand(){t.apply(this,arguments),this.instanceList=null}return __extends(OneToOneBatchInstanceCommand,t),OneToOneBatchInstanceCommand.create=function(){var e=new this;return e},OneToOneBatchInstanceCommand.prototype.draw=function(t){var r=null;if(this._hasInstance()){switch(this.webglState.setState(t),this.glslData){case e.EInstanceGLSLData.MODELMATRIX:r=e.ModelMatrixBatchInstanceDrawer.getInstance();break;case e.EInstanceGLSLData.NORMALMATRIX_MODELMATRIX:r=e.NormalMatrixModelMatrixBatchInstanceDrawer.getInstance();break;default:e.Log.error(!0,e.Log.info.FUNC_INVALID("glslData:"+this.glslData))}r.draw(this.instanceList,this.program,this.buffers,this.drawMode)}},OneToOneBatchInstanceCommand.prototype._hasInstance=function(){return!!this.instanceList&&this.instanceList.getCount()>0},__decorate([e.ensure(function(t){e.assert(e.JudgeUtils.isBoolean(t),e.Log.info.FUNC_SHOULD("return boolean value")),t&&e.assert(!e.InstanceUtils.isHardwareSupport(),e.Log.info.FUNC_SHOULD_NOT("hardware","support instance"))})],OneToOneBatchInstanceCommand.prototype,"_hasInstance",null),OneToOneBatchInstanceCommand}(e.BatchInstanceCommand);e.OneToOneBatchInstanceCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function OneToManyBatchInstanceCommand(){t.apply(this,arguments),this.geometry=null}return __extends(OneToManyBatchInstanceCommand,t),OneToManyBatchInstanceCommand.create=function(){var e=new this;return e},OneToManyBatchInstanceCommand.prototype.draw=function(t){var r=null;r=e.OneToManyBatchInstanceDrawer.getInstance(),r.draw(this.geometry,this.program,this.buffers,this.drawMode)},OneToManyBatchInstanceCommand}(e.BatchInstanceCommand);e.OneToManyBatchInstanceCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BatchInstanceDrawer(){e.apply(this,arguments)}return __extends(BatchInstanceDrawer,e),BatchInstanceDrawer}(e.InstanceDrawer);e.BatchInstanceDrawer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function OneToOneBatchInstanceDrawer(){t.apply(this,arguments)}return __extends(OneToOneBatchInstanceDrawer,t),OneToOneBatchInstanceDrawer.prototype.draw=function(t,r,n,i){var o=this,a=null,s=null,c=e.DeviceManager.getInstance().gl;if(s=this.getUniformDataNameArray(r),a=n.getChild(e.EBufferDataType.INDICE))e.BufferTable.bindIndexBuffer(a),t.forEach(function(t){var n=0;o.sendGLSLData(r,t,s),e.GlUtils.drawElements(c[i],a.count,c[a.type],a.typeSize*n)},this);else{var u=n.getChild(e.EBufferDataType.VERTICE);t.forEach(function(t){var n=0;o.sendGLSLData(r,t,s),e.GlUtils.drawArrays(c[i],n,u.count)},this)}},__decorate([e.require(function(t,r,n,i){e.it("hardware shouldn't support instance",function(){e.expect(e.InstanceUtils.isHardwareSupport())["false"]})})],OneToOneBatchInstanceDrawer.prototype,"draw",null),OneToOneBatchInstanceDrawer}(e.BatchInstanceDrawer);e.OneToOneBatchInstanceDrawer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function OneToManyBatchInstanceDrawer(){t.call(this),this._geometry=null}return __extends(OneToManyBatchInstanceDrawer,t),OneToManyBatchInstanceDrawer.getInstance=function(){},OneToManyBatchInstanceDrawer.prototype.draw=function(t,r,n,i){var o=this,a=null,s=null,c=e.DeviceManager.getInstance().gl;this._geometry=t,a=n.getChild(e.EBufferDataType.INDICE),e.BufferTable.bindIndexBuffer(a),this._geometry.attributeData.forEach(function(t){o.sendGLSLData(r,t),s=0,e.GlUtils.drawElements(c[i],a.count,c[a.type],a.typeSize*s)},this)},OneToManyBatchInstanceDrawer.prototype.sendGLSLData=function(e,t){var r=this;t.forEach(function(t){var n=t.data;e.sendUniformData(t.attributeName,r._getVariableType(n.length),n)})},OneToManyBatchInstanceDrawer.prototype._getVariableType=function(t){switch(t){case 1:return e.EVariableType.FLOAT_1;case 2:return e.EVariableType.FLOAT_2;case 3:return e.EVariableType.FLOAT_3;case 4:return e.EVariableType.FLOAT_4;default:e.Log.error(!0,e.Log.info.FUNC_INVALID("size:"+t))}},__decorate([e.require(function(t,r,n,i){e.it("hardware shouldn't support instance",function(){e.expect(e.InstanceUtils.isHardwareSupport())["false"]}),e.it("indexBuffer should exist",function(){e.expect(n.getChild(e.EBufferDataType.INDICE)).exist})})],OneToManyBatchInstanceDrawer.prototype,"draw",null),OneToManyBatchInstanceDrawer=__decorate([e.singleton()],OneToManyBatchInstanceDrawer)}(e.BatchInstanceDrawer);e.OneToManyBatchInstanceDrawer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ModelMatrixBatchInstanceDrawer(){t.call(this)}return __extends(ModelMatrixBatchInstanceDrawer,t),ModelMatrixBatchInstanceDrawer.getInstance=function(){},ModelMatrixBatchInstanceDrawer.prototype.getUniformDataNameArray=function(e){return["u_mMatrix"]},ModelMatrixBatchInstanceDrawer.prototype.sendGLSLData=function(t,r,n){var i=n[0];t.sendUniformData(i,e.EVariableType.FLOAT_MAT4,r.transform.localToWorldMatrix);
},ModelMatrixBatchInstanceDrawer=__decorate([e.singleton()],ModelMatrixBatchInstanceDrawer)}(e.OneToOneBatchInstanceDrawer);e.ModelMatrixBatchInstanceDrawer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function NormalMatrixModelMatrixBatchInstanceDrawer(){t.call(this)}return __extends(NormalMatrixModelMatrixBatchInstanceDrawer,t),NormalMatrixModelMatrixBatchInstanceDrawer.getInstance=function(){},NormalMatrixModelMatrixBatchInstanceDrawer.prototype.getUniformDataNameArray=function(e){return["u_mMatrix","u_normalMatrix"]},NormalMatrixModelMatrixBatchInstanceDrawer.prototype.sendGLSLData=function(t,r,n){var i=n[0],o=n[1];t.sendUniformData(i,e.EVariableType.FLOAT_MAT4,r.transform.localToWorldMatrix),t.sendUniformData(o,e.EVariableType.FLOAT_MAT3,r.transform.normalMatrix)},NormalMatrixModelMatrixBatchInstanceDrawer=__decorate([e.singleton()],NormalMatrixModelMatrixBatchInstanceDrawer)}(e.OneToOneBatchInstanceDrawer);e.NormalMatrixModelMatrixBatchInstanceDrawer=t}(wd||(wd={}));var wd;!function(e){var t=function(){function GlUtils(){}return GlUtils.drawElements=function(t,r,n,i){var o=e.ClassUtils.getClass("DebugStatistics");o&&(o.count.drawCalls++,o.count.renderGameObjects++),this._getGl().drawElements(t,r,n,i)},GlUtils.drawArrays=function(t,r,n){var i=e.ClassUtils.getClass("DebugStatistics");i&&(i.count.drawCalls++,i.count.renderGameObjects++),this._getGl().drawArrays(t,r,n)},GlUtils.drawElementsInstancedANGLE=function(t,r,n,i,o){var a=e.GPUDetector.getInstance().extensionInstancedArrays,s=e.ClassUtils.getClass("DebugStatistics");s&&(s.count.drawCalls++,s.count.renderGameObjects+=o),a.drawElementsInstancedANGLE(t,r,n,i,o)},GlUtils.drawArraysInstancedANGLE=function(t,r,n,i){var o=e.GPUDetector.getInstance().extensionInstancedArrays,a=e.ClassUtils.getClass("DebugStatistics");a&&(a.count.drawCalls++,a.count.renderGameObjects+=i),o.drawArraysInstancedANGLE(t,r,n,i)},GlUtils._getGl=function(){return e.DeviceManager.getInstance().gl},GlUtils}();e.GlUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function FrameBuffer(e,t){this.width=null,this.height=null,this._originScissorTest=null,this._glTarget=null,this.width=e,this.height=t}return FrameBuffer.create=function(e,t){var r=new this(e,t);return r},Object.defineProperty(FrameBuffer.prototype,"gl",{get:function(){return e.DeviceManager.getInstance().gl},enumerable:!0,configurable:!0}),FrameBuffer.prototype.createFrameBuffer=function(){return this.gl.createFramebuffer()},FrameBuffer.prototype.bindFrameBuffer=function(e){var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,e)},FrameBuffer.prototype.setViewport=function(){var t=e.DeviceManager.getInstance();t.setViewport(0,0,this.width,this.height),this._originScissorTest=t.scissorTest,t.scissorTest=!1},FrameBuffer.prototype.restoreViewport=function(){var t=e.DeviceManager.getInstance(),r=t.view;t.setViewport(0,0,r.width,r.height),t.scissorTest=this._originScissorTest},FrameBuffer.prototype.dispose=function(){this.unBindAll()},FrameBuffer.prototype.unBindAll=function(){var e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindRenderbuffer(e.RENDERBUFFER,null)},FrameBuffer.prototype.unBindFrameBuffer=function(){var e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null)},FrameBuffer.prototype.createRenderBuffer=function(){var e=this.gl,t=e.createRenderbuffer();return t},FrameBuffer.prototype.attachTexture=function(t,r,n){void 0===n&&(n=e.EFrameBufferAttachType.COLOR_ATTACHMENT0);var i=this.gl;i.framebufferTexture2D(i.FRAMEBUFFER,i[n],t,r,0),this._glTarget=t},FrameBuffer.prototype.attachRenderBuffer=function(e,t){var r=this.gl;r.bindRenderbuffer(r.RENDERBUFFER,t),r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_COMPONENT16,this.width,this.height),r.framebufferRenderbuffer(r.FRAMEBUFFER,r[e],r.RENDERBUFFER,t)},FrameBuffer.prototype.check=function(){var t=this.gl,r=t.checkFramebufferStatus(t.FRAMEBUFFER);r!==t.FRAMEBUFFER_COMPLETE&&e.Log.error(!0,"Frame buffer object is incomplete:"+r.toString())},__decorate([e.ensure(function(){var t=e.DeviceManager.getInstance();e.assert(null!==t.scissorTest,e.Log.info.FUNC_SHOULD_NOT("DeviceManager->scissorTest","be null"))})],FrameBuffer.prototype,"restoreViewport",null),__decorate([e.require(function(){})],FrameBuffer.prototype,"unBindAll",null),__decorate([e.ensure(function(t){e.assert(!!t,e.Log.info.FUNC_NOT_EXIST("renderbuffer object"))})],FrameBuffer.prototype,"createRenderBuffer",null),FrameBuffer}();e.FrameBuffer=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.COLOR_ATTACHMENT0="COLOR_ATTACHMENT0"]="COLOR_ATTACHMENT0",e[e.DEPTH_ATTACHMENT="DEPTH_ATTACHMENT"]="DEPTH_ATTACHMENT"}(e.EFrameBufferAttachType||(e.EFrameBufferAttachType={}));e.EFrameBufferAttachType}(wd||(wd={}));var wd;!function(e){var t=function(){function Shader(){this._attributes=wdCb.Hash.create(),this._uniforms=wdCb.Hash.create(),this._vsSource="",this._fsSource="",this.libDirty=!1,this.definitionDataDirty=!1,this.mapManager=e.MapManager.create(),this.libs=wdCb.Collection.create(),this.sourceBuilder=this.createShaderSourceBuilder(),this._programCache=null,this._instanceStateCache=null}return Object.defineProperty(Shader.prototype,"attributes",{get:function(){return this._attributes},set:function(e){this._isNotEqual(e,this._attributes)&&(this.definitionDataDirty=!0),this._attributes=e},enumerable:!0,configurable:!0}),Object.defineProperty(Shader.prototype,"uniforms",{get:function(){return this._uniforms},set:function(e){this._isNotEqual(e,this._uniforms)&&(this.definitionDataDirty=!0),this._uniforms=e},enumerable:!0,configurable:!0}),Object.defineProperty(Shader.prototype,"vsSource",{get:function(){return this._vsSource},set:function(e){e!==this._vsSource&&(this.definitionDataDirty=!0),this._vsSource=e},enumerable:!0,configurable:!0}),Object.defineProperty(Shader.prototype,"fsSource",{get:function(){return this._fsSource},set:function(e){e!==this._fsSource&&(this.definitionDataDirty=!0),this._fsSource=e},enumerable:!0,configurable:!0}),Object.defineProperty(Shader.prototype,"dirty",{get:function(){return this.libDirty||this.definitionDataDirty},enumerable:!0,configurable:!0}),Object.defineProperty(Shader.prototype,"program",{get:function(){return e.ProgramTable.getProgram(this._getProgramTableKey())},enumerable:!0,configurable:!0}),Shader.prototype.createVsShader=function(){var t=e.DeviceManager.getInstance().gl;return this._initShader(t.createShader(t.VERTEX_SHADER),this.vsSource)},Shader.prototype.createFsShader=function(){var t=e.DeviceManager.getInstance().gl;return this._initShader(t.createShader(t.FRAGMENT_SHADER),this.fsSource)},Shader.prototype.init=function(e){this.libs.forEach(function(e){e.init()}),this.judgeRefreshShader(null,e),this.mapManager.init()},Shader.prototype.dispose=function(){this.attributes.removeAllChildren(),this.uniforms.removeAllChildren(),this.libs.forEach(function(e){e.dispose()}),this.mapManager.dispose(),this._clearAllCache()},Shader.prototype.hasLib=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(t[0]instanceof e.ShaderLib){var n=t[0];return this.libs.hasChild(n)}var i=t[0];return this.libs.hasChildWithFunc(function(e){return e instanceof i})},Shader.prototype.addLib=function(e){this.libs.addChild(e),e.shader=this,this.libDirty=!0},Shader.prototype.addShaderLibToTop=function(e){this.libs.unShiftChild(e),e.shader=this,this.libDirty=!0},Shader.prototype.getLib=function(e){return this.libs.findOne(function(t){return t instanceof e})},Shader.prototype.getLibs=function(){return this.libs},Shader.prototype.removeLib=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return this.libDirty=!0,this.libs.removeChild(e[0])},Shader.prototype.removeAllLibs=function(){this.libDirty=!0,this.libs.removeAllChildren()},Shader.prototype.sortLib=function(e){this.libDirty=!0,this.libs.sort(e,!0)},Shader.prototype.getInstanceState=function(){var t=!1,r=!1,n=!1,i=!1;return this.libs.forEach(function(o){if(o instanceof e.InstanceShaderLib)return o instanceof e.NormalMatrixHardwareInstanceShaderLib?(r=!0,n=!0,wdCb.$BREAK):o instanceof e.NormalMatrixBatchInstanceShaderLib?(r=!0,i=!0,wdCb.$BREAK):o instanceof e.ModelMatrixHardwareInstanceShaderLib?(t=!0,void(n=!0)):o instanceof e.ModelMatrixBatchInstanceShaderLib?(t=!0,void(i=!0)):void 0}),{isModelMatrixInstance:t,isNormalMatrixInstance:r,isHardwareInstance:n,isBatchInstance:i}},Shader.prototype.judgeRefreshShader=function(e,t){this.libDirty&&(this._instanceStateCache=null,this.buildDefinitionData(e,t)),this.definitionDataDirty&&(this._programCache=null,this._registerAndUpdateProgram(),this._programCache=null),this.libDirty=!1,this.definitionDataDirty=!1},Shader.prototype._registerAndUpdateProgram=function(){var t=this._getProgramTableKey();e.ProgramTable.hasProgram(t)||(e.ProgramTable.addProgram(t,e.Program.create()),this._updateProgram())},Shader.prototype._updateProgram=function(){this.program.initWithShader(this)},Shader.prototype._getProgramTableKey=function(){return this.vsSource+"\n"+this.fsSource},Shader.prototype._initShader=function(t,r){var n=e.DeviceManager.getInstance().gl;return n.shaderSource(t,r),n.compileShader(t),n.getShaderParameter(t,n.COMPILE_STATUS)?t:(e.Log.log(n.getShaderInfoLog(t)),e.Log.log("attributes:\n",this.attributes),e.Log.log("uniforms:\n",this.uniforms),e.Log.log("source:\n",r),void 0)},Shader.prototype._isNotEqual=function(e,t){var r=!1;return e.forEach(function(e,n){var i=t.getChild(n);if(!i||e.type!==i.type||e.value!==i.value)return r=!0,wdCb.$BREAK}),r},Shader.prototype._clearAllCache=function(){this._programCache=null,this._instanceStateCache=null},__decorate([e.ensureGetter(function(t){e.it("program should exist(its table key is "+this._getProgramTableKey(),function(){e.expect(t).exist},this)}),e.cacheGetter(function(){return null!==this._programCache},function(){return this._programCache},function(e){this._programCache=e})],Shader.prototype,"program",null),__decorate([e.execOnlyOnce("_isInit")],Shader.prototype,"init",null),__decorate([e.ensure(function(){var t=this;e.it("should set ShaderLib.shader to be this",function(){t.libs.forEach(function(r){e.expect(r.shader===t)["true"]})},this),e.it("libDirty should be true",function(){e.expect(t.libDirty)["true"]},this)})],Shader.prototype,"addLib",null),__decorate([e.ensure(function(t,r){var n=this;e.it("should add shader lib to the top",function(){e.expect(e.JudgeUtils.isEqual(r,n.libs.getChild(0)))["true"]},this),e.it("should set ShaderLib.shader to be this",function(){n.libs.forEach(function(t){e.expect(t.shader===n)["true"]})},this),e.it("libDirty should be true",function(){e.expect(n.libDirty)["true"]},this)})],Shader.prototype,"addShaderLibToTop",null),__decorate([e.ensure(function(t){var r=t.isModelMatrixInstance,n=t.isNormalMatrixInstance,i=t.isHardwareInstance,o=t.isBatchInstance;n&&e.it("if is normalMatrixInstance, should also be modelMatrixInstance",function(){e.expect(r)["true"]}),e.it("shouldn't both be hardware insstance and batch instance",function(){e.expect(i&&o)["false"]})}),e.cache(function(){return this._instanceStateCache},function(){return this._instanceStateCache},function(e){this._instanceStateCache=e})],Shader.prototype,"getInstanceState",null),Shader}();e.Shader=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CustomShader(){t.apply(this,arguments)}return __extends(CustomShader,t),CustomShader.create=function(){var e=new this;return e},CustomShader.prototype.update=function(e,t){var r=null;this.judgeRefreshShader(e,t),r=this.program,r.use(),this.libs.forEach(function(n){n.sendShaderVariables(r,e,t)}),this.mapManager.bindAndUpdate(),this.mapManager.sendData(r)},CustomShader.prototype.read=function(e){this.sourceBuilder.clearShaderDefinition(),this.sourceBuilder.read(e),this.libDirty=!0},CustomShader.prototype.getSampler2DUniformsAfterRead=function(){return this.sourceBuilder.uniforms.filter(function(t,r){return t.type===e.EVariableType.SAMPLER_2D})},CustomShader.prototype.buildDefinitionData=function(e,t){this.sourceBuilder.build(),this.attributes=this.sourceBuilder.attributes,this.uniforms=this.sourceBuilder.uniforms,this.vsSource=this.sourceBuilder.vsSource,this.fsSource=this.sourceBuilder.fsSource},CustomShader.prototype.createShaderSourceBuilder=function(){return e.CustomShaderSourceBuilder.create()},CustomShader}(e.Shader);e.CustomShader=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function EngineShader(){t.apply(this,arguments)}return __extends(EngineShader,t),EngineShader.prototype.buildDefinitionData=function(e,t){this.libs.forEach(function(r){r.setShaderDefinition(e,t)}),this.sourceBuilder.clearShaderDefinition(),this.sourceBuilder.build(this.libs),this.attributes=this.sourceBuilder.attributes,this.uniforms=this.sourceBuilder.uniforms,this.vsSource=this.sourceBuilder.vsSource,this.fsSource=this.sourceBuilder.fsSource},EngineShader.prototype.createShaderSourceBuilder=function(){return e.EngineShaderSourceBuilder.create()},EngineShader}(e.Shader);e.EngineShader=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function CommonShader(){e.apply(this,arguments)}return __extends(CommonShader,e),CommonShader.create=function(){var e=new this;return e},CommonShader.prototype.update=function(e,t){var r=null;this.judgeRefreshShader(e,t),r=this.program,r.use(),this.libs.forEach(function(n){n.sendShaderVariables(r,e,t)}),this.mapManager.bindAndUpdate(),this.mapManager.sendData(r)},CommonShader}(e.EngineShader);e.CommonShader=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ProceduralShader(){t.apply(this,arguments)}return __extends(ProceduralShader,t),ProceduralShader.prototype.init=function(){this.addLib(e.CommonProceduralShaderLib.create()),t.prototype.init.call(this,null)},ProceduralShader.prototype.update=function(e){var t=null;this.judgeRefreshShader(e,null),t=this.program,t.use(),this.libs.forEach(function(r){r.sendShaderVariables(t,e)})},ProceduralShader}(e.EngineShader);e.ProceduralShader=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function CommonProceduralShader(){e.apply(this,arguments)}return __extends(CommonProceduralShader,e),CommonProceduralShader.create=function(){var e=new this;return e},CommonProceduralShader}(e.ProceduralShader);e.CommonProceduralShader=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function CustomProceduralShader(t){e.call(this),this._texture=null,this._texture=t}return __extends(CustomProceduralShader,e),CustomProceduralShader.create=function(e){var t=new this(e);return t},CustomProceduralShader.prototype.update=function(t){e.prototype.update.call(this,t),this._texture.mapManager.bindAndUpdate(),this._texture.mapManager.sendData(this.program)},CustomProceduralShader}(e.ProceduralShader);e.CustomProceduralShader=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.MIRROR="MIRROR"]="MIRROR",e[e.DYNAMIC_CUBEMAP="DYNAMIC_CUBEMAP"]="DYNAMIC_CUBEMAP",e[e.REFRACTION="REFRACTION"]="REFRACTION",e[e.TWOD_SHADOWMAP="TWOD_SHADOWMAP"]="TWOD_SHADOWMAP",e[e.BUILD_CUBEMAP_SHADOWMAP="BUILD_CUBEMAP_SHADOWMAP"]="BUILD_CUBEMAP_SHADOWMAP",e[e.CUBEMAP_SHADOWMAP="CUBEMAP_SHADOWMAP"]="CUBEMAP_SHADOWMAP"}(e.EShaderGLSLData||(e.EShaderGLSLData={}));e.EShaderGLSLData}(wd||(wd={}));var wd;!function(e){!function(e){e[e.BUILD_TWOD_SHADOWMAP="BUILD_TWOD_SHADOWMAP"]="BUILD_TWOD_SHADOWMAP",e[e.BUILD_CUBEMAP_SHADOWMAP="BUILD_CUBEMAP_SHADOWMAP"]="BUILD_CUBEMAP_SHADOWMAP"}(e.EShaderTypeOfScene||(e.EShaderTypeOfScene={}));e.EShaderTypeOfScene}(wd||(wd={}));var wd;!function(e){!function(e){e[e.BUILD_TWOD_SHADOWMAP_INSTANCE="BUILD_TWOD_SHADOWMAP_INSTANCE"]="BUILD_TWOD_SHADOWMAP_INSTANCE",e[e.BUILD_TWOD_SHADOWMAP_NO_INSTANCE="BUILD_TWOD_SHADOWMAP_NO_INSTANCE"]="BUILD_TWOD_SHADOWMAP_NO_INSTANCE",e[e.BUILD_CUBEMAP_SHADOWMAP_INSTANCE="BUILD_CUBEMAP_SHADOWMAP_INSTANCE"]="BUILD_CUBEMAP_SHADOWMAP_INSTANCE",e[e.BUILD_CUBEMAP_SHADOWMAP_NO_INSTANCE="BUILD_CUBEMAP_SHADOWMAP_NO_INSTANCE"]="BUILD_CUBEMAP_SHADOWMAP_NO_INSTANCE"}(e.EShaderMapKeyOfScene||(e.EShaderMapKeyOfScene={}));e.EShaderMapKeyOfScene}(wd||(wd={}));var wd;!function(e){!function(e){e[e.DEFAULT="DEFAULT"]="DEFAULT"}(e.EShaderMapKey||(e.EShaderMapKey={}));e.EShaderMapKey}(wd||(wd={}));var wd;!function(e){var t=function(){function MapManager(){this._material=null,this._textureDirty=!1,this._allMapsCache=null,this._allSingleMapsCache=null,this._shadowMapController=e.ClassUtils.createClassInstanceOrEmpty("ShadowMapController","EmptyShadowMapController",this),this._arrayMapController=e.MapArrayController.create(),this._envMapController=e.EnvMapController.create(),this._commonMapController=e.CommonMapController.create()}return MapManager.create=function(){var e=new this;return e},Object.defineProperty(MapManager.prototype,"material",{get:function(){return this._material},set:function(e){this._material=e,this._envMapController.material=e,this._commonMapController.material=e},enumerable:!0,configurable:!0}),MapManager.prototype.init=function(){for(var e=this._getAllMaps(),t=0,r=e.length;t<r;t++){var n=e[t];n.init()}},MapManager.prototype.addMap=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null;if(t[0]instanceof e.TextureAsset){var i=t[0];n=i.toTexture()}else t[0]instanceof e.Texture&&(n=t[0]);1===t.length?this._commonMapController.addMap(n):this._commonMapController.addMap(n,t[1]),this._textureDirty=!0},MapManager.prototype.addMapArray=function(e,t){this._arrayMapController.addMapArray(e,t),this._textureDirty=!0},MapManager.prototype.addTwoDShadowMap=function(e){this._shadowMapController.addTwoDShadowMap(e),this._textureDirty=!0},MapManager.prototype.getTwoDShadowMapList=function(){return this._shadowMapController.getTwoDShadowMapList()},MapManager.prototype.hasTwoDShadowMap=function(e){return this._shadowMapController.hasTwoDShadowMap(e)},MapManager.prototype.addCubemapShadowMap=function(e){this._shadowMapController.addCubemapShadowMap(e),this._textureDirty=!0},MapManager.prototype.getCubemapShadowMapList=function(){return this._shadowMapController.getCubemapShadowMapList()},MapManager.prototype.hasCubemapShadowMap=function(e){return this._shadowMapController.hasCubemapShadowMap(e)},MapManager.prototype.getMapList=function(){return this._commonMapController.getMapList()},MapManager.prototype.hasMap=function(e){return this._commonMapController.hasMap(e)},MapManager.prototype.getMapCount=function(){return this.getMapList().getCount()},MapManager.prototype.getEnvMap=function(){return this._envMapController.getEnvMap()},MapManager.prototype.setEnvMap=function(e){return e?(this._envMapController.setEnvMap(e),void(this._textureDirty=!0)):(this._envMapController.setEnvMap(null),void(this._textureDirty=!0))},MapManager.prototype.removeChild=function(e){for(var t=0,r=this._getAllControllerArr();t<r.length;t++){var n=r[t];n.removeChild(e)}this._textureDirty=!0},MapManager.prototype.removeAllChildren=function(){for(var e=0,t=this._getAllControllerArr();e<t.length;e++){var r=t[e];r.removeAllChildren()}this._textureDirty=!0},MapManager.prototype.removeAllShdaowMaps=function(){this._shadowMapController.removeAllChildren(),this._textureDirty=!0},MapManager.prototype.dispose=function(){for(var e=this._getAllMaps(),t=0,r=e.length;t<r;t++){var n=e[t];n.dispose()}this.removeAllChildren()},MapManager.prototype.bindAndUpdate=function(){for(var e=this._getAllMaps(),t=0,r=e.length;t<r;t++){var n=e[t];n.bindToUnit(t),n.needUpdate&&n.update(t)}},MapManager.prototype.sendData=function(e){this._sendSingleMapData(e),this._arrayMapController.sendMapData(e,this._getMaxUnitOfBindedSingleMap())},MapManager.prototype._sendSingleMapData=function(e){for(var t=this._getAllSingleMaps(),r=t.length,n=0;n<r;n++){var i=t[n];i.sendData(e,i.getSamplerName(n),n)}},MapManager.prototype._getAllMaps=function(){return[].concat(this._getAllSingleMaps(),this._arrayMapController.getAllMapArr())},MapManager.prototype._getMaxUnitOfBindedSingleMap=function(){return this._getAllSingleMaps().length},MapManager.prototype._getAllSingleMaps=function(){for(var e=[],t=0,r=this._getAllSingleMapControllerArr();t<r.length;t++){var n=r[t],i=n.getAllMapArr();null!==i&&(e=e.concat(i))}return e},MapManager.prototype._getAllSingleMapControllerArr=function(){return[this._shadowMapController,this._envMapController,this._commonMapController]},MapManager.prototype._getAllControllerArr=function(){return[this._shadowMapController,this._envMapController,this._arrayMapController,this._commonMapController]},__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];e.it("arguments[0] should be TextureAsset or Texture",function(){e.expect(t[0]instanceof e.TextureAsset||t[0]instanceof e.Texture)["true"]})})],MapManager.prototype,"addMap",null),__decorate([e.require(function(t,r){e.it("mapArray should be array",function(){e.expect(e.JudgeUtils.isArrayExactly(r))["true"]});for(var n=function(t){e.it("mapArray should be Array<Texture>",function(){e.expect(t)["instanceof"](e.Texture)})},i=0,o=r;i<o.length;i++){var a=o[i];n(a)}})],MapManager.prototype,"addMapArray",null),__decorate([e.require(function(t){var r=this;e.JudgeUtils.isClass(this._shadowMapController,"EmptyShadowMapController")||e.it("shouldn't add the shadowMap which is already exist",function(){e.expect(r._shadowMapController.hasTwoDShadowMap(t))["false"]})})],MapManager.prototype,"addTwoDShadowMap",null),__decorate([e.require(function(t){var r=this;e.JudgeUtils.isClass(this._shadowMapController,"EmptyShadowMapController")||e.it("shouldn't add the shadowMap which is already exist",function(){e.expect(r._shadowMapController.hasCubemapShadowMap(t))["false"]})})],MapManager.prototype,"addCubemapShadowMap",null),__decorate([e.ensure(function(t){t.forEach(function(t){e.it("mapList should only contain BasicTexture or ProceduralTexture",function(){e.expect(t instanceof e.BasicTexture||t instanceof e.ProceduralTexture)["true"]})})})],MapManager.prototype,"getMapList",null),__decorate([e.require(function(t){for(var r={},n=this._getAllMaps(),i=function(t,i){var o=n[t],a=o.getSamplerName(t);e.it("shouldn't has duplicate maps, but actual has the ones with the same samplerName:"+a,function(){e.expect(r[a]).not.equal(1)}),r[a]=1},o=0,a=n.length;o<a;o++)i(o,a)})],MapManager.prototype,"sendData",null),__decorate([e.ensure(function(t){for(var r=function(t){e.it("all maps should be Texture",function(){e.expect(t)["instanceof"](e.Texture)})},n=0,i=t;n<i.length;n++){var o=i[n];r(o)}}),e.cache(function(){return!this._textureDirty&&this._allMapsCache},function(){return this._allMapsCache},function(e){this._allMapsCache=e,this._textureDirty=!1})],MapManager.prototype,"_getAllMaps",null),__decorate([e.cache(function(){return!this._textureDirty&&this._allSingleMapsCache},function(){return this._allSingleMapsCache},function(e){this._allSingleMapsCache=e,this._textureDirty=!1})],MapManager.prototype,"_getAllSingleMaps",null),MapManager}();e.MapManager=t}(wd||(wd={}));var wd;!function(e){var t=function(){function MapController(){}return MapController.prototype.hasMapHelper=function(e,t){return!!e&&e.hasChild(t)},MapController.prototype.setMapOption=function(e,t){e.variableData=t},MapController}();e.MapController=t}(wd||(wd={}));var wd;!function(e){var t=function(){function EmptyShadowMapController(){}return EmptyShadowMapController.create=function(){var e=new this;return e},EmptyShadowMapController.prototype.addTwoDShadowMap=function(e){},EmptyShadowMapController.prototype.addCubemapShadowMap=function(e){},EmptyShadowMapController.prototype.hasTwoDShadowMap=function(e){return!1},EmptyShadowMapController.prototype.hasCubemapShadowMap=function(e){return!1},EmptyShadowMapController.prototype.getTwoDShadowMapList=function(){return null},EmptyShadowMapController.prototype.getCubemapShadowMapList=function(){return null},EmptyShadowMapController.prototype.getAllMapArr=function(){return null},EmptyShadowMapController.prototype.removeChild=function(e){},EmptyShadowMapController.prototype.removeAllChildren=function(){},EmptyShadowMapController}();e.EmptyShadowMapController=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function EnvMapController(){t.apply(this,arguments),this.material=null,this._map=null}return __extends(EnvMapController,t),EnvMapController.create=function(){var e=new this;return e},EnvMapController.prototype.setEnvMap=function(e){return e?(e.material=this.material,void(this._map=e)):void(this._map=null)},EnvMapController.prototype.getEnvMap=function(){return this._map},EnvMapController.prototype.getAllMapArr=function(){return null!==this._map?[this._map]:[]},EnvMapController.prototype.removeChild=function(t){e.JudgeUtils.isEqual(this._map,t)&&(this._map=null)},EnvMapController.prototype.removeAllChildren=function(){this._map=null},EnvMapController}(e.MapController);e.EnvMapController=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function MapArrayController(){t.apply(this,arguments),this._mapArrayList=wdCb.Collection.create()}return __extends(MapArrayController,t),MapArrayController.create=function(){var e=new this;return e},MapArrayController.prototype.addMapArray=function(e,t){this._mapArrayList.addChild({samplerName:e,mapArray:t})},MapArrayController.prototype.sendMapData=function(t,r){var n=this;this._mapArrayList.forEach(function(i){var o=i.mapArray.length;t.sendUniformData(i.samplerName+"[0]",e.EVariableType.SAMPLER_ARRAY,n._generateMapArrayUnitArray(r,r+o)),r+=o})},MapArrayController.prototype.getAllMapArr=function(){var e=[];return this._mapArrayList.forEach(function(t){e=e.concat(t.mapArray)}),e},MapArrayController.prototype.removeChild=function(e){this._mapArrayList.removeChild(e)},MapArrayController.prototype.removeAllChildren=function(){this._mapArrayList.removeAllChildren()},MapArrayController.prototype._generateMapArrayUnitArray=function(e,t){for(var r=[];t>e;)r.push(e),e++;return r},__decorate([e.ensure(function(t){for(var r=0,n=t;r<n.length;r++){var i=n[r];e.assert(i instanceof e.Texture,e.Log.info.FUNC_SHOULD("each element","be Texture"))}})],MapArrayController.prototype,"getAllMapArr",null),__decorate([e.ensure(function(t,r,n){e.assert(t.length===n-r,e.Log.info.FUNC_SHOULD("length","be "+(n-r)+", but actual is "+t.length)),t.length>0&&(e.assert(t[0]===r,e.Log.info.FUNC_SHOULD("first element","be "+r+", but actual is "+t[0])),e.assert(t[t.length-1]===n-1,e.Log.info.FUNC_SHOULD("last element","be "+(n-1)+", but actual is "+t[t.length-1])))})],MapArrayController.prototype,"_generateMapArrayUnitArray",null),MapArrayController}(e.MapController);e.MapArrayController=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CommonMapController(){t.apply(this,arguments),this.material=null,this._list=wdCb.Collection.create()}return __extends(CommonMapController,t),CommonMapController.create=function(){var e=new this;return e},CommonMapController.prototype.addMap=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=e[0];if(2===e.length){var n=e[1];this.setMapOption(r,n)}r.material=this.material,this._list.addChild(r)},CommonMapController.prototype.getAllMapArr=function(){return this._list.toArray()},CommonMapController.prototype.getMapList=function(){return this._list.filter(function(t){return t instanceof e.BasicTexture||t instanceof e.ProceduralTexture})},CommonMapController.prototype.hasMap=function(e){return this.hasMapHelper(this._list,e)},CommonMapController.prototype.removeChild=function(e){this._list.removeChild(e)},CommonMapController.prototype.removeAllChildren=function(){this._list.removeAllChildren()},CommonMapController}(e.MapController);e.CommonMapController=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ShaderSourceBuilder(){this.attributes=wdCb.Hash.create(),this.uniforms=wdCb.Hash.create(),this.vsSource=null,this.fsSource=null}return ShaderSourceBuilder.prototype.dispose=function(){this.clearShaderDefinition()},ShaderSourceBuilder.prototype.convertAttributesData=function(){this.attributes.filter(function(t){return t.value!==e.EVariableCategory.ENGINE&&e.JudgeUtils.isArrayExactly(t.value)}).forEach(function(t,r){t.value=e.BufferUtils.convertArrayToArrayBuffer(t.type,t.value)})},__decorate([e.require(function(){this.attributes.forEach(function(t){e.assert(!e.JudgeUtils.isFloatArray(t.value),e.Log.info.FUNC_SHOULD_NOT("attribute->value","be Float array"))})})],ShaderSourceBuilder.prototype,"convertAttributesData",null),ShaderSourceBuilder}();e.ShaderSourceBuilder=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CustomShaderSourceBuilder(){t.apply(this,arguments)}return __extends(CustomShaderSourceBuilder,t),CustomShaderSourceBuilder.create=function(){var e=new this;return e},CustomShaderSourceBuilder.prototype.read=function(t){t.attributes&&(this.attributes=wdCb.Hash.create(t.attributes)),t.uniforms&&(this.uniforms=wdCb.Hash.create(t.uniforms)),this.vsSource=e.LoaderManager.getInstance().get(t.vsSourceId),this.fsSource=e.LoaderManager.getInstance().get(t.fsSourceId)},CustomShaderSourceBuilder.prototype.build=function(){this.convertAttributesData()},CustomShaderSourceBuilder.prototype.clearShaderDefinition=function(){this.attributes.removeAllChildren(),this.uniforms.removeAllChildren(),this.vsSource=null,this.fsSource=null},CustomShaderSourceBuilder}(e.ShaderSourceBuilder);e.CustomShaderSourceBuilder=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function EngineShaderSourceBuilder(){t.apply(this,arguments),this.vsSourceTop="",this.vsSourceDefine="",this.vsSourceVarDeclare="",this.vsSourceFuncDeclare="",this.vsSourceFuncDefine="",this.vsSourceBody="",this.fsSourceTop="",this.fsSourceDefine="",this.fsSourceVarDeclare="",this.fsSourceFuncDeclare="",this.fsSourceFuncDefine="",this.fsSourceBody="",this.vsSourceDefineList=wdCb.Collection.create(),this.fsSourceDefineList=wdCb.Collection.create(),this.vsSourceExtensionList=wdCb.Collection.create(),this.fsSourceExtensionList=wdCb.Collection.create()}return __extends(EngineShaderSourceBuilder,t),EngineShaderSourceBuilder.create=function(){var e=new this;return e},EngineShaderSourceBuilder.prototype.build=function(e){this._readLibSource(e),null===this.vsSource&&this._buildVsSource(),null===this.fsSource&&this._buildFsSource(),this.convertAttributesData()},EngineShaderSourceBuilder.prototype.clearShaderDefinition=function(){this.attributes.removeAllChildren(),this.uniforms.removeAllChildren(),this.vsSourceDefineList.removeAllChildren(),this.fsSourceDefineList.removeAllChildren(),this.vsSourceTop="",this.vsSourceDefine="",this.vsSourceVarDeclare="",this.vsSourceFuncDeclare="",this.vsSourceFuncDefine="",this.vsSourceBody="",this.vsSource=null,this.fsSourceTop="",this.fsSourceDefine="",this.fsSourceVarDeclare="",this.fsSourceFuncDeclare="",this.fsSourceFuncDefine="",this.fsSourceBody="",this.fsSource=null},EngineShaderSourceBuilder.prototype._readLibSource=function(e){var t=e.filter(function(e){return null!==e.vsSource||null!==e.fsSource});this._judgeAndSetVsSource(t),this._judgeAndSetFsSource(t),this._judgeAndSetPartSource(e)},EngineShaderSourceBuilder.prototype._judgeAndSetVsSource=function(e){var t=e.findOne(function(e){return null!==e.vsSource});t&&(this.vsSource=t.vsSource)},EngineShaderSourceBuilder.prototype._judgeAndSetFsSource=function(e){var t=e.findOne(function(e){return null!==e.fsSource});t&&(this.fsSource=t.fsSource)},EngineShaderSourceBuilder.prototype._judgeAndSetPartSource=function(e){var t=this.vsSource,r=this.fsSource,n=this.attributes,i=this.uniforms,o=this.vsSourceDefineList,a=this.fsSourceDefineList,s=this.vsSourceExtensionList,c=this.fsSourceExtensionList,u="",l="",h="",d="",p="",f="",m="",g="",_="",y="",v="",b="";e.forEach(function(e){n.addChildren(e.attributes),i.addChildren(e.uniforms),null===t&&(u+=e.vsSourceTop,l+=e.vsSourceDefine,h+=e.vsSourceVarDeclare,d+=e.vsSourceFuncDeclare,p+=e.vsSourceFuncDefine,f+=e.vsSourceBody,o.addChildren(e.vsSourceDefineList),s.addChildren(e.vsSourceExtensionList)),null===r&&(m+=e.fsSourceTop,g+=e.fsSourceDefine,_+=e.fsSourceVarDeclare,y+=e.fsSourceFuncDeclare,v+=e.fsSourceFuncDefine,b+=e.fsSourceBody,a.addChildren(e.fsSourceDefineList),c.addChildren(e.fsSourceExtensionList));
}),null===t&&(this.vsSourceTop=u,this.vsSourceDefine=l,this.vsSourceVarDeclare=h,this.vsSourceFuncDeclare=d,this.vsSourceFuncDefine=p,this.vsSourceBody=f),null===r&&(this.fsSourceTop=m,this.fsSourceDefine=g,this.fsSourceVarDeclare=_,this.fsSourceFuncDeclare=y,this.fsSourceFuncDefine=v,this.fsSourceBody=b)},EngineShaderSourceBuilder.prototype._buildVsSource=function(){this.vsSource=this._buildVsSourceTop()+this._buildVsSourceDefine()+this._buildVsSourceVarDeclare()+this._buildVsSourceFuncDeclare()+this._buildVsSourceFuncDefine()+this._buildVsSourceBody()},EngineShaderSourceBuilder.prototype._buildFsSource=function(){this.fsSource=this._buildFsSourceTop()+this._buildFsSourceDefine()+this._buildFsSourceVarDeclare()+this._buildFsSourceFuncDeclare()+this._buildFsSourceFuncDefine()+this._buildFsSourceBody()},EngineShaderSourceBuilder.prototype._buildVsSourceTop=function(){return this._buildVsSourceExtension()+this._getPrecisionSource()+this.vsSourceTop},EngineShaderSourceBuilder.prototype._buildVsSourceDefine=function(){return this._buildSourceDefine(this.vsSourceDefineList)+this.vsSourceDefine},EngineShaderSourceBuilder.prototype._buildVsSourceExtension=function(){return this._buildSourceExtension(this.vsSourceExtensionList)},EngineShaderSourceBuilder.prototype._buildVsSourceVarDeclare=function(){return this._generateAttributeSource()+this._generateUniformSource(this.vsSourceVarDeclare,this.vsSourceFuncDefine,this.vsSourceBody)+this.vsSourceVarDeclare},EngineShaderSourceBuilder.prototype._buildVsSourceFuncDeclare=function(){return this.vsSourceFuncDeclare},EngineShaderSourceBuilder.prototype._buildVsSourceFuncDefine=function(){return this.vsSourceFuncDefine},EngineShaderSourceBuilder.prototype._buildVsSourceBody=function(){return e.ShaderSnippet.main_begin+this.vsSourceBody+e.ShaderSnippet.main_end},EngineShaderSourceBuilder.prototype._buildFsSourceTop=function(){return this._buildFsSourceExtension()+this._getPrecisionSource()+this.fsSourceTop},EngineShaderSourceBuilder.prototype._buildFsSourceDefine=function(){return this._buildSourceDefine(this.fsSourceDefineList)+this.fsSourceDefine},EngineShaderSourceBuilder.prototype._buildFsSourceExtension=function(){return this._buildSourceExtension(this.fsSourceExtensionList)},EngineShaderSourceBuilder.prototype._buildFsSourceVarDeclare=function(){return this._generateUniformSource(this.fsSourceVarDeclare,this.fsSourceFuncDefine,this.fsSourceBody)+this.fsSourceVarDeclare},EngineShaderSourceBuilder.prototype._buildFsSourceFuncDeclare=function(){return this.fsSourceFuncDeclare},EngineShaderSourceBuilder.prototype._buildFsSourceFuncDefine=function(){return this.fsSourceFuncDefine},EngineShaderSourceBuilder.prototype._buildFsSourceBody=function(){return e.ShaderSnippet.main_begin+this.fsSourceBody+e.ShaderSnippet.main_end},EngineShaderSourceBuilder.prototype._buildSourceDefine=function(e){var t="";return e.forEach(function(e){t+=void 0===e.value?"#define "+e.name+"\n":"#define "+e.name+" "+e.value+"\n"}),t},EngineShaderSourceBuilder.prototype._buildSourceExtension=function(e){var t="";return e.forEach(function(e){t+="#extension "+e+" : enable\n"}),t},EngineShaderSourceBuilder.prototype._getPrecisionSource=function(){var t=e.GPUDetector.getInstance().precision,r=null;switch(t){case e.EGPUPrecision.HIGHP:r=e.ShaderChunk.highp_fragment.top;break;case e.EGPUPrecision.MEDIUMP:r=e.ShaderChunk.mediump_fragment.top;break;case e.EGPUPrecision.LOWP:r=e.ShaderChunk.lowp_fragment.top;break;default:r=""}return r},EngineShaderSourceBuilder.prototype._generateAttributeSource=function(){var t="";return this.attributes.filter(function(e,t){return!!e}).forEach(function(r,n){t+="attribute "+e.VariableTypeTable.getVariableType(r.type)+" "+n+";\n"}),t},EngineShaderSourceBuilder.prototype._generateUniformSource=function(t,r,n){var i="",o=this;return this.uniforms.filter(function(i,a){return!!i&&i.type!==e.EVariableType.STRUCTURE&&i.type!==e.EVariableType.STRUCTURES&&!o._isExistInSource(a,t)&&(o._isExistInSource(a,r)||o._isExistInSource(a,n))}).forEach(function(t,r){i+="uniform "+e.VariableTypeTable.getVariableType(t.type)+" "+r+";\n"}),i},EngineShaderSourceBuilder.prototype._isExistInSource=function(e,t){return t.indexOf(e)!==-1},__decorate([e.require(function(t){e.assert(null===this.vsSource,e.Log.info.FUNC_SHOULD("vsSource","be null")),e.assert(null===this.fsSource,e.Log.info.FUNC_SHOULD("fsSource","be null"))})],EngineShaderSourceBuilder.prototype,"build",null),EngineShaderSourceBuilder}(e.ShaderSourceBuilder);e.EngineShaderSourceBuilder=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.FLOAT_1="FLOAT_1"]="FLOAT_1",e[e.FLOAT_2="FLOAT_2"]="FLOAT_2",e[e.FLOAT_3="FLOAT_3"]="FLOAT_3",e[e.FLOAT_4="FLOAT_4"]="FLOAT_4",e[e.VECTOR_2="VECTOR_2"]="VECTOR_2",e[e.VECTOR_3="VECTOR_3"]="VECTOR_3",e[e.VECTOR_4="VECTOR_4"]="VECTOR_4",e[e.COLOR_3="COLOR_3"]="COLOR_3",e[e.FLOAT_MAT3="FLOAT_MAT3"]="FLOAT_MAT3",e[e.FLOAT_MAT4="FLOAT_MAT4"]="FLOAT_MAT4",e[e.BUFFER="BUFFER"]="BUFFER",e[e.SAMPLER_CUBE="SAMPLER_CUBE"]="SAMPLER_CUBE",e[e.SAMPLER_2D="SAMPLER_2D"]="SAMPLER_2D",e[e.NUMBER_1="NUMBER_1"]="NUMBER_1",e[e.STRUCTURE="STRUCTURE"]="STRUCTURE",e[e.STRUCTURES="STRUCTURES"]="STRUCTURES",e[e.SAMPLER_ARRAY="SAMPLER_ARRAY"]="SAMPLER_ARRAY",e[e.FLOAT_MAT4_ARRAY="FLOAT_MAT4_ARRAY"]="FLOAT_MAT4_ARRAY"}(e.EVariableType||(e.EVariableType={}));e.EVariableType}(wd||(wd={}));var wd;!function(e){!function(e){e[e.POSITION="POSITION"]="POSITION",e[e.NORMAL="NORMAL"]="NORMAL",e[e.TEXCOORD="TEXCOORD"]="TEXCOORD",e[e.TANGENT="TANGENT"]="TANGENT",e[e.COLOR="COLOR"]="COLOR",e[e.MODEL="MODEL"]="MODEL",e[e.VIEW="VIEW"]="VIEW",e[e.PROJECTION="PROJECTION"]="PROJECTION",e[e.MODEL_VIEW="MODEL_VIEW"]="MODEL_VIEW",e[e.MODEL_VIEW_PROJECTION="MODEL_VIEW_PROJECTION"]="MODEL_VIEW_PROJECTION",e[e.MODEL_INVERSE="MODEL_INVERSE"]="MODEL_INVERSE",e[e.VIEW_INVERSE="VIEW_INVERSE"]="VIEW_INVERSE",e[e.PROJECTION_INVERSE="PROJECTION_INVERSE"]="PROJECTION_INVERSE",e[e.MODEL_VIEW_INVERSE="MODEL_VIEW_INVERSE"]="MODEL_VIEW_INVERSE",e[e.MODEL_VIEW_PROJECTION_INVERSE="MODEL_VIEW_PROJECTION_INVERSE"]="MODEL_VIEW_PROJECTION_INVERSE",e[e.MODEL_INVERSE_TRANSPOSE="MODEL_INVERSE_TRANSPOSE"]="MODEL_INVERSE_TRANSPOSE",e[e.MODEL_VIEW_INVERSE_TRANSPOSE="MODEL_VIEW_INVERSE_TRANSPOSE"]="MODEL_VIEW_INVERSE_TRANSPOSE",e[e.VIEWPORT="VIEWPORT"]="VIEWPORT"}(e.EVariableSemantic||(e.EVariableSemantic={}));e.EVariableSemantic}(wd||(wd={}));var wd;!function(e){!function(e){e[e.ENGINE="ENGINE"]="ENGINE",e[e.CUSTOM="CUSTOM"]="CUSTOM"}(e.EVariableCategory||(e.EVariableCategory={}));e.EVariableCategory}(wd||(wd={}));var wd;!function(e){var t=function(){function VariableLib(){}return VariableLib.a_position={type:e.EVariableType.FLOAT_3,value:e.EVariableCategory.ENGINE},VariableLib.a_positionVec2={type:e.EVariableType.FLOAT_2,value:e.EVariableCategory.ENGINE},VariableLib.a_currentFramePosition={type:e.EVariableType.FLOAT_3,value:e.EVariableCategory.ENGINE},VariableLib.a_nextFramePosition={type:e.EVariableType.FLOAT_3,value:e.EVariableCategory.ENGINE},VariableLib.a_normal={type:e.EVariableType.FLOAT_3,value:e.EVariableCategory.ENGINE},VariableLib.a_currentFrameNormal={type:e.EVariableType.FLOAT_3,value:e.EVariableCategory.ENGINE},VariableLib.a_nextFrameNormal={type:e.EVariableType.FLOAT_3,value:e.EVariableCategory.ENGINE},VariableLib.a_color={type:e.EVariableType.FLOAT_3,value:e.EVariableCategory.ENGINE},VariableLib.a_texCoord={type:e.EVariableType.FLOAT_2,value:e.EVariableCategory.ENGINE},VariableLib.a_tangent={type:e.EVariableType.FLOAT_3,value:e.EVariableCategory.ENGINE},VariableLib.u_color={type:e.EVariableType.VECTOR_3,value:e.EVariableCategory.ENGINE},VariableLib.u_mMatrix={type:e.EVariableType.FLOAT_MAT4,value:e.EVariableCategory.ENGINE},VariableLib.u_vMatrix={type:e.EVariableType.FLOAT_MAT4,value:e.EVariableCategory.ENGINE},VariableLib.u_pMatrix={type:e.EVariableType.FLOAT_MAT4,value:e.EVariableCategory.ENGINE},VariableLib.u_mvpMatrix={type:e.EVariableType.FLOAT_MAT4,value:e.EVariableCategory.ENGINE},VariableLib.u_vpMatrix={type:e.EVariableType.FLOAT_MAT4,value:e.EVariableCategory.ENGINE},VariableLib.u_normalMatrix={type:e.EVariableType.FLOAT_MAT3,value:e.EVariableCategory.ENGINE},VariableLib.u_samplerCube0={type:e.EVariableType.SAMPLER_CUBE,value:e.EVariableCategory.ENGINE},VariableLib.u_sampler2D0={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_sampler2D1={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_lightMapSampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_diffuseMapSampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_diffuseMap1Sampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_diffuseMap2Sampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_diffuseMap3Sampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_specularMapSampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_emissionMapSampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_normalMapSampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_reflectionMapSampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_refractionMapSampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_cameraPos={type:e.EVariableType.VECTOR_3,value:e.EVariableCategory.ENGINE},VariableLib.u_refractionRatio={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_reflectivity={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_map0SourceRegion={type:e.EVariableType.VECTOR_4,value:e.EVariableCategory.ENGINE},VariableLib.u_map1SourceRegion={type:e.EVariableType.VECTOR_4,value:e.EVariableCategory.ENGINE},VariableLib.u_diffuseMapSourceRegion={type:e.EVariableType.VECTOR_4,value:e.EVariableCategory.ENGINE},VariableLib.u_map0RepeatRegion={type:e.EVariableType.VECTOR_4,value:e.EVariableCategory.ENGINE},VariableLib.u_map1RepeatRegion={type:e.EVariableType.VECTOR_4,value:e.EVariableCategory.ENGINE},VariableLib.u_diffuseMapRepeatRegion={type:e.EVariableType.VECTOR_4,value:e.EVariableCategory.ENGINE},VariableLib.u_combineMode={type:e.EVariableType.NUMBER_1,value:e.EVariableCategory.ENGINE},VariableLib.u_mixRatio={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_lightMapIntensity={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_diffuse={type:e.EVariableType.VECTOR_3,value:e.EVariableCategory.ENGINE},VariableLib.u_specular={type:e.EVariableType.VECTOR_3,value:e.EVariableCategory.ENGINE},VariableLib.u_emission={type:e.EVariableType.VECTOR_3,value:e.EVariableCategory.ENGINE},VariableLib.u_shininess={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_lightModel={type:e.EVariableType.NUMBER_1,value:e.EVariableCategory.ENGINE},VariableLib.u_isBothSide={type:e.EVariableType.NUMBER_1,value:e.EVariableCategory.ENGINE},VariableLib.u_opacity={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_ambient={type:e.EVariableType.VECTOR_3,value:e.EVariableCategory.ENGINE},VariableLib.u_directionLights={type:e.EVariableType.STRUCTURES,value:e.EVariableCategory.ENGINE},VariableLib.u_pointLights={type:e.EVariableType.STRUCTURES,value:e.EVariableCategory.ENGINE},VariableLib.u_vpMatrixFromLight={type:e.EVariableType.FLOAT_MAT4,value:e.EVariableCategory.ENGINE},VariableLib.u_lightPos={type:e.EVariableType.VECTOR_3,value:e.EVariableCategory.ENGINE},VariableLib.u_farPlane={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_interpolation={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_tilesHeightNumber={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_tilesWidthNumber={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_amplitude={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_jointColor={type:e.EVariableType.VECTOR_3,value:e.EVariableCategory.ENGINE},VariableLib.u_time={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_speed={type:e.EVariableType.VECTOR_2,value:e.EVariableCategory.ENGINE},VariableLib.u_shift={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_alphaThreshold={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_fireColor={type:e.EVariableType.STRUCTURE,value:e.EVariableCategory.ENGINE},VariableLib.u_layerHeightDatas={type:e.EVariableType.STRUCTURES,value:e.EVariableCategory.ENGINE},VariableLib.u_layerSampler2Ds={type:e.EVariableType.SAMPLER_ARRAY,value:e.EVariableCategory.ENGINE},VariableLib.u_herb1Color={type:e.EVariableType.VECTOR_3,value:e.EVariableCategory.ENGINE},VariableLib.u_herb2Color={type:e.EVariableType.VECTOR_3,value:e.EVariableCategory.ENGINE},VariableLib.u_herb3Color={type:e.EVariableType.VECTOR_3,value:e.EVariableCategory.ENGINE},VariableLib.u_groundColor={type:e.EVariableType.VECTOR_3,value:e.EVariableCategory.ENGINE},VariableLib.u_ampScale={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_woodColor={type:e.EVariableType.VECTOR_3,value:e.EVariableCategory.ENGINE},VariableLib.u_roadColor={type:e.EVariableType.VECTOR_3,value:e.EVariableCategory.ENGINE},VariableLib.u_skyColor={type:e.EVariableType.VECTOR_4,value:e.EVariableCategory.ENGINE},VariableLib.u_cloudColor={type:e.EVariableType.VECTOR_4,value:e.EVariableCategory.ENGINE},VariableLib.u_brickColor={type:e.EVariableType.VECTOR_3,value:e.EVariableCategory.ENGINE},VariableLib.u_waveData={type:e.EVariableType.STRUCTURE,value:e.EVariableCategory.ENGINE},VariableLib.u_windMatrix={type:e.EVariableType.FLOAT_MAT4,value:e.EVariableCategory.ENGINE},VariableLib.u_bumpMapSampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_bumpMap1Sampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_bumpMap2Sampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_bumpMap3Sampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_levelData={type:e.EVariableType.STRUCTURE,value:e.EVariableCategory.ENGINE},VariableLib.a_mVec4_0={type:e.EVariableType.FLOAT_4,value:e.EVariableCategory.ENGINE},VariableLib.a_mVec4_1={type:e.EVariableType.FLOAT_4,value:e.EVariableCategory.ENGINE},VariableLib.a_mVec4_2={type:e.EVariableType.FLOAT_4,value:e.EVariableCategory.ENGINE},VariableLib.a_mVec4_3={type:e.EVariableType.FLOAT_4,value:e.EVariableCategory.ENGINE},VariableLib.a_normalVec4_0={type:e.EVariableType.FLOAT_3,value:e.EVariableCategory.ENGINE},VariableLib.a_normalVec4_1={type:e.EVariableType.FLOAT_3,value:e.EVariableCategory.ENGINE},VariableLib.a_normalVec4_2={type:e.EVariableType.FLOAT_3,value:e.EVariableCategory.ENGINE},VariableLib.u_isRenderListEmpty={type:e.EVariableType.NUMBER_1,value:e.EVariableCategory.ENGINE},VariableLib.u_isReflectionRenderListEmpty={type:e.EVariableType.NUMBER_1,value:e.EVariableCategory.ENGINE},VariableLib.u_isRefractionRenderListEmpty={type:e.EVariableType.NUMBER_1,value:e.EVariableCategory.ENGINE},VariableLib.u_bitmapSampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.a_page={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_pageSampler2Ds={type:e.EVariableType.SAMPLER_ARRAY,value:e.EVariableCategory.ENGINE},VariableLib.u_mixMapSampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_diffuseMap1RepeatRegion={type:e.EVariableType.VECTOR_4,value:e.EVariableCategory.ENGINE},VariableLib.u_diffuseMap2RepeatRegion={type:e.EVariableType.VECTOR_4,value:e.EVariableCategory.ENGINE},VariableLib.u_diffuseMap3RepeatRegion={type:e.EVariableType.VECTOR_4,value:e.EVariableCategory.ENGINE},VariableLib.u_grassMapDatas={type:e.EVariableType.STRUCTURES,value:e.EVariableCategory.ENGINE},VariableLib.a_quadIndex={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_grassMapSampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_windData={type:e.EVariableType.STRUCTURES,value:e.EVariableCategory.ENGINE},VariableLib.a_vertexIndex={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_grassRangeWidth={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_grassRangeHeight={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_terrainRangeWidth={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_terrainRangeHeight={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_terrainMinHeight={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_terrainMaxHeight={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_terrainSubdivisions={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_terrainScaleY={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_terrainPositionY={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_heightMapSampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_lightColor={type:e.EVariableType.VECTOR_3,value:e.EVariableCategory.ENGINE},VariableLib.a_jointIndice={type:e.EVariableType.FLOAT_4,value:e.EVariableCategory.ENGINE},VariableLib.a_jointWeight={type:e.EVariableType.FLOAT_4,value:e.EVariableCategory.ENGINE},VariableLib.u_jointMatrices={type:e.EVariableType.FLOAT_MAT4_ARRAY,value:e.EVariableCategory.ENGINE},VariableLib}();e.VariableLib=t}(wd||(wd={}));var wd;!function(e){var t=wdCb.Hash.create();t.addChild(e.EVariableType.FLOAT_1,"float"),t.addChild(e.EVariableType.FLOAT_2,"vec2"),t.addChild(e.EVariableType.FLOAT_3,"vec3"),t.addChild(e.EVariableType.FLOAT_4,"vec4"),t.addChild(e.EVariableType.VECTOR_2,"vec2"),t.addChild(e.EVariableType.VECTOR_3,"vec3"),t.addChild(e.EVariableType.VECTOR_4,"vec4"),t.addChild(e.EVariableType.FLOAT_MAT3,"mat3"),t.addChild(e.EVariableType.FLOAT_MAT4,"mat4"),t.addChild(e.EVariableType.NUMBER_1,"int"),t.addChild(e.EVariableType.SAMPLER_CUBE,"samplerCube"),t.addChild(e.EVariableType.SAMPLER_2D,"sampler2D");var r=function(){function VariableTypeTable(){}return VariableTypeTable.getVariableType=function(r){var n=t.getChild(r);return e.Log.error(void 0===n,e.Log.info.FUNC_NOT_EXIST(r,"in VariableTypeTable")),n},VariableTypeTable}();e.VariableTypeTable=r}(wd||(wd={}));var wd;!function(e){var t=wdCb.Hash.create();t.addChild("lightMap","u_lightMapSampler"),t.addChild("diffuseMap","u_diffuseMapSampler"),t.addChild("diffuseMap1","u_diffuseMap1Sampler"),t.addChild("diffuseMap2","u_diffuseMap2Sampler"),t.addChild("diffuseMap3","u_diffuseMap3Sampler"),t.addChild("specularMap","u_specularMapSampler"),t.addChild("emissionMap","u_emissionMapSampler"),t.addChild("normalMap","u_normalMapSampler"),t.addChild("reflectionMap","u_reflectionMapSampler"),t.addChild("refractionMap","u_refractionMapSampler"),t.addChild("bitmap","u_bitmapSampler"),t.addChild("bumpMap","u_bumpMapSampler"),t.addChild("bumpMap1","u_bumpMap1Sampler"),t.addChild("bumpMap2","u_bumpMap2Sampler"),t.addChild("bumpMap3","u_bumpMap3Sampler"),t.addChild("mixMap","u_mixMapSampler"),t.addChild("grassMap","u_grassMapSampler"),t.addChild("heightMap","u_heightMapSampler");var r=function(){function VariableNameTable(){}return VariableNameTable.getVariableName=function(e){return t.getChild(e)},__decorate([e.ensure(function(t){e.it("variableName should in VariableNameTable",function(){e.expect(t).exist})})],VariableNameTable,"getVariableName",null),VariableNameTable}();e.VariableNameTable=r}(wd||(wd={}));var wd;!function(e){e.POINT_LIGHT_GLSLDATA_STRUCTURE_MEMBER_NAME=[{position:"u_pointLights[0].position",color:"u_pointLights[0].color",intensity:"u_pointLights[0].intensity",constant:"u_pointLights[0].constant",linear:"u_pointLights[0].linear",quadratic:"u_pointLights[0].quadratic",range:"u_pointLights[0].range"},{position:"u_pointLights[1].position",color:"u_pointLights[1].color",intensity:"u_pointLights[1].intensity",constant:"u_pointLights[1].constant",linear:"u_pointLights[1].linear",quadratic:"u_pointLights[1].quadratic",range:"u_pointLights[1].range"},{position:"u_pointLights[2].position",color:"u_pointLights[2].color",intensity:"u_pointLights[2].intensity",constant:"u_pointLights[2].constant",linear:"u_pointLights[2].linear",quadratic:"u_pointLights[2].quadratic",range:"u_pointLights[2].range"},{position:"u_pointLights[3].position",color:"u_pointLights[3].color",intensity:"u_pointLights[3].intensity",constant:"u_pointLights[3].constant",linear:"u_pointLights[3].linear",quadratic:"u_pointLights[3].quadratic",range:"u_pointLights[3].range"}],e.DIRECTION_LIGHT_GLSLDATA_STRUCTURE_MEMBER_NAME=[{position:"u_directionLights[0].position",color:"u_directionLights[0].color",intensity:"u_directionLights[0].intensity"},{position:"u_directionLights[1].position",color:"u_directionLights[1].color",intensity:"u_directionLights[1].intensity"},{position:"u_directionLights[2].position",color:"u_directionLights[2].color",intensity:"u_directionLights[2].intensity"},{position:"u_directionLights[3].position",color:"u_directionLights[3].color",intensity:"u_directionLights[3].intensity"}]}(wd||(wd={}));var wd;!function(e){var t=function(){function ShaderLib(){this.shader=null}return ShaderLib.prototype.sendShaderVariables=function(e,t,r){},ShaderLib.prototype.init=function(){},ShaderLib.prototype.dispose=function(){},__decorate([e.virtual],ShaderLib.prototype,"sendShaderVariables",null),__decorate([e.virtual],ShaderLib.prototype,"init",null),__decorate([e.virtual],ShaderLib.prototype,"dispose",null),ShaderLib}();e.ShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CustomShaderLib(){t.apply(this,arguments)}return __extends(CustomShaderLib,t),CustomShaderLib.create=function(){var e=new this;return e},CustomShaderLib.prototype.sendShaderVariables=function(t,r,n){var i=this.shader;i.attributes.forEach(function(n,i){e.CustomShaderLibUtils.sendAttributeBufferWithSemantic(i,n.type,n.value,t,r)}),i.uniforms.forEach(function(n,i){n.type!==e.EVariableType.SAMPLER_2D&&e.CustomShaderLibUtils.sendUniformDataWithSemantic(i,n.type,n.value,t,r)})},CustomShaderLib}(e.ShaderLib);e.CustomShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function EngineShaderLib(){t.apply(this,arguments),this.type=null,this.attributes=wdCb.Hash.create(),this.uniforms=wdCb.Hash.create(),this.vsSourceTop="",this.vsSourceDefine="",this.vsSourceVarDeclare="",this.vsSourceFuncDeclare="",this.vsSourceFuncDefine="",this.vsSourceBody="",this.vsSource=null,this.fsSourceTop="",this.fsSourceDefine="",this.fsSourceVarDeclare="",this.fsSourceFuncDeclare="",this.fsSourceFuncDefine="",this.fsSourceBody="",this.fsSource=null,this.vsSourceDefineList=wdCb.Collection.create(),this.fsSourceDefineList=wdCb.Collection.create(),this.vsSourceExtensionList=wdCb.Collection.create(),this.fsSourceExtensionList=wdCb.Collection.create()}return __extends(EngineShaderLib,t),EngineShaderLib.prototype.setShaderDefinition=function(e,t){var r=null,n=null;this._clearShaderDefinition(),r=this.getVsChunk(),n=this.getFsChunk(),r&&this.setVsSource(r),n&&this.setFsSource(n)},EngineShaderLib.prototype.sendAttributeBuffer=function(t,r,n){t.sendAttributeBuffer(r,e.EVariableType.BUFFER,n)},EngineShaderLib.prototype.sendUniformData=function(t,r,n){t.sendUniformData(r,e.VariableLib[r].type,n)},EngineShaderLib.prototype.getVsChunk=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var n=0===e.length?this.type:e[0];return this._getChunk(n,r.vs)},EngineShaderLib.prototype.getFsChunk=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var n=0===e.length?this.type:e[0];return this._getChunk(n,r.fs)},EngineShaderLib.prototype.setVsSource=function(t,n){void 0===n&&(n="="),e.JudgeUtils.isString(t)?this.vsSource=t:this._setSource(t,r.vs,n)},EngineShaderLib.prototype.setFsSource=function(t,n){void 0===n&&(n="="),e.JudgeUtils.isString(t)?this.fsSource=t:this._setSource(t,r.fs,n)},EngineShaderLib.prototype.addAttributeVariable=function(e){this._addVariable(this.attributes,e)},EngineShaderLib.prototype.addUniformVariable=function(e){this._addVariable(this.uniforms,e)},EngineShaderLib.prototype._addVariable=function(t,r){r.forEach(function(r){e.assert(e.VariableLib[r],e.Log.info.FUNC_SHOULD(r,"exist in VariableLib")),t.addChild(r,e.VariableLib[r])})},EngineShaderLib.prototype._clearShaderDefinition=function(){this.attributes.removeAllChildren(),this.uniforms.removeAllChildren(),this.vsSourceDefineList.removeAllChildren(),this.fsSourceDefineList.removeAllChildren(),this.vsSourceExtensionList.removeAllChildren(),this.fsSourceExtensionList.removeAllChildren(),this.vsSourceTop="",this.vsSourceDefine="",this.vsSourceVarDeclare="",this.vsSourceFuncDeclare="",this.vsSourceFuncDefine="",this.vsSourceBody="",this.vsSource=null,this.fsSourceTop="",this.fsSourceDefine="",this.fsSourceVarDeclare="",this.fsSourceFuncDeclare="",this.fsSourceFuncDefine="",this.fsSourceBody="",this.fsSource=null},EngineShaderLib.prototype._getChunk=function(t,n){var i=null;return t?(i=t.indexOf(".glsl")>-1?""+wdCb.PathUtils.basename(t,".glsl"):n===r.vs?t+"_vertex":t+"_fragment",e.ShaderChunk[i]?e.ShaderChunk[i]:e.ShaderChunk.empty):null},EngineShaderLib.prototype._setSource=function(t,r,n){if(t)switch(n){case"+":this[r+"SourceTop"]+=t.top,this[r+"SourceDefine"]+=t.define,this[r+"SourceVarDeclare"]+=t.varDeclare,this[r+"SourceFuncDeclare"]+=t.funcDeclare,this[r+"SourceFuncDefine"]+=t.funcDefine,this[r+"SourceBody"]+=t.body;break;case"=":this[r+"SourceTop"]=t.top,this[r+"SourceDefine"]=t.define,this[r+"SourceVarDeclare"]=t.varDeclare,this[r+"SourceFuncDeclare"]=t.funcDeclare,this[r+"SourceFuncDefine"]=t.funcDefine,this[r+"SourceBody"]=t.body;break;default:e.Log.error(!0,e.Log.info.FUNC_INVALID("opertor:",n))}},__decorate([e.virtual],EngineShaderLib.prototype,"setShaderDefinition",null),__decorate([e.require(function(t,r,n){e.assert(!!e.VariableLib[r],r+" should exist in VariableLib")})],EngineShaderLib.prototype,"sendUniformData",null),__decorate([e.require(function(){e.assert(null===this.vsSource,e.Log.info.FUNC_SHOULD("vsSource","be null"))})],EngineShaderLib.prototype,"setVsSource",null),__decorate([e.require(function(){e.assert(null===this.fsSource,e.Log.info.FUNC_SHOULD("fsSource","be null"))})],EngineShaderLib.prototype,"setFsSource",null),__decorate([e.require(function(t,r){r.forEach(function(t){e.it("should exist in VariableLib",function(){e.expect(e.VariableLib[t]).exist})})})],EngineShaderLib.prototype,"_addVariable",null),EngineShaderLib}(e.ShaderLib);e.EngineShaderLib=t;var r;!function(e){e[e.vs="vs"]="vs",e[e.fs="fs"]="fs"}(r||(r={}))}(wd||(wd={}));var wd;!function(e){var t=function(t){function CommonShaderLib(){t.apply(this,arguments),this.type="common"}return __extends(CommonShaderLib,t),CommonShaderLib.create=function(){var e=new this;return e},CommonShaderLib.prototype.sendShaderVariables=function(e,t,r){this.sendUniformData(e,"u_vMatrix",t.vMatrix),this.sendUniformData(e,"u_pMatrix",t.pMatrix)},CommonShaderLib.prototype.setShaderDefinition=function(r,n){t.prototype.setShaderDefinition.call(this,r,n),this.addUniformVariable(["u_vMatrix","u_pMatrix"]),this.vsSourceDefine=e.ShaderChunk.common_define.define+e.ShaderChunk.common_vertex.define,this.vsSourceFuncDefine=e.ShaderChunk.common_function.funcDefine+e.ShaderChunk.common_vertex.funcDefine,this.fsSourceDefine=e.ShaderChunk.common_define.define+e.ShaderChunk.common_fragment.define,this.fsSourceFuncDefine=e.ShaderChunk.common_function.funcDefine+e.ShaderChunk.common_fragment.funcDefine},CommonShaderLib}(e.EngineShaderLib);e.CommonShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function EndShaderLib(){e.apply(this,arguments),this.type="end"}return __extends(EndShaderLib,e),EndShaderLib.create=function(){var e=new this;return e},EndShaderLib.prototype.sendShaderVariables=function(e,t,r){e.sendAllBufferData(t.vaoManager)},EndShaderLib}(e.EngineShaderLib);e.EndShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function VerticeCommonShaderLib(){t.apply(this,arguments),this.type="vertice_common"}return __extends(VerticeCommonShaderLib,t),VerticeCommonShaderLib.create=function(){var e=new this;return e},VerticeCommonShaderLib.prototype.sendShaderVariables=function(e,t,r){this._sendAttributeVariables(e,t)},VerticeCommonShaderLib.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addAttributeVariable(["a_position"])},VerticeCommonShaderLib.prototype._sendAttributeVariables=function(t,r){var n=r.buffers.getChild(e.EBufferDataType.VERTICE);n&&this.sendAttributeBuffer(t,"a_position",n)},VerticeCommonShaderLib}(e.EngineShaderLib);e.VerticeCommonShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function NormalCommonShaderLib(){t.apply(this,arguments),this.type="normal_common"}return __extends(NormalCommonShaderLib,t),NormalCommonShaderLib.create=function(){var e=new this;return e},NormalCommonShaderLib.prototype.sendShaderVariables=function(e,t,r){this._sendAttributeVariables(e,t)},NormalCommonShaderLib.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addAttributeVariable(["a_normal"])},NormalCommonShaderLib.prototype._sendAttributeVariables=function(t,r){var n=r.buffers.getChild(e.EBufferDataType.NORMAL);n&&this.sendAttributeBuffer(t,"a_normal",n)},NormalCommonShaderLib}(e.EngineShaderLib);e.NormalCommonShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function BasicShaderLib(){t.apply(this,arguments),this.type="basic"}return __extends(BasicShaderLib,t),BasicShaderLib.create=function(){var e=new this;return e},BasicShaderLib.prototype.sendShaderVariables=function(e,t,r){this.sendUniformData(e,"u_opacity",r.opacity)},BasicShaderLib.prototype.setShaderDefinition=function(r,n){t.prototype.setShaderDefinition.call(this,r,n),this.addUniformVariable(["u_opacity"]),this.vsSourceBody=e.ShaderSnippet.setPos_mvp},BasicShaderLib}(e.EngineShaderLib);e.BasicShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BasicMaterialColorShaderLib(){e.apply(this,arguments),this.type="basic_materialColor"}return __extends(BasicMaterialColorShaderLib,e),BasicMaterialColorShaderLib.create=function(){var e=new this;return e},BasicMaterialColorShaderLib.prototype.sendShaderVariables=function(e,t,r){this.sendUniformData(e,"u_color",r.color.toVector3())},BasicMaterialColorShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_color"])},BasicMaterialColorShaderLib}(e.EngineShaderLib);e.BasicMaterialColorShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function BasicVertexColorShaderLib(){t.apply(this,arguments),this.type="basic_vertexColor"}return __extends(BasicVertexColorShaderLib,t),BasicVertexColorShaderLib.create=function(){var e=new this;return e},BasicVertexColorShaderLib.prototype.sendShaderVariables=function(t,r,n){var i=r.buffers.getChild(e.EBufferDataType.COLOR);i&&this.sendAttributeBuffer(t,"a_color",i)},BasicVertexColorShaderLib.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addAttributeVariable(["a_color"])},BasicVertexColorShaderLib}(e.EngineShaderLib);e.BasicVertexColorShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function EndBasicShaderLib(){e.apply(this,arguments),this.type="end_basic"}return __extends(EndBasicShaderLib,e),EndBasicShaderLib.create=function(){var e=new this;return e},EndBasicShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),null!==r.alphaTest&&(this.fsSourceBody+="if (gl_FragColor.a < "+r.alphaTest+"){\n    discard;\n}\n");
},EndBasicShaderLib}(e.EngineShaderLib);e.EndBasicShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ProceduralShaderLib(){t.apply(this,arguments)}return __extends(ProceduralShaderLib,t),ProceduralShaderLib.prototype.sendShaderVariables=function(e,t){},ProceduralShaderLib.prototype.setShaderDefinition=function(e){t.prototype.setShaderDefinition.call(this,e,null)},__decorate([e.virtual],ProceduralShaderLib.prototype,"sendShaderVariables",null),__decorate([e.virtual],ProceduralShaderLib.prototype,"setShaderDefinition",null),ProceduralShaderLib}(e.EngineShaderLib);e.ProceduralShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CustomProceduralShaderLib(e){t.call(this),this.type="custom_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=e}return __extends(CustomProceduralShaderLib,t),CustomProceduralShaderLib.create=function(e){var t=new this(e);return t},CustomProceduralShaderLib.prototype.sendShaderVariables=function(t,r){var n=this._proceduralTexture,i=n.uniformMap;i.forEach(function(r,n){e.CustomShaderLibUtils.sendUniformData(n,r.type,r.value,t)})},CustomProceduralShaderLib.prototype.setShaderDefinition=function(e){var r=this._proceduralTexture;t.prototype.setShaderDefinition.call(this,e),this.setFsSource(r.fsSource)},CustomProceduralShaderLib}(e.ProceduralShaderLib);e.CustomProceduralShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function CommonProceduralShaderLib(){e.apply(this,arguments),this.type="common_proceduralTexture"}return __extends(CommonProceduralShaderLib,e),CommonProceduralShaderLib.create=function(){var e=new this;return e},CommonProceduralShaderLib.prototype.sendShaderVariables=function(e,t){this.sendAttributeBuffer(e,"a_positionVec2",t.vertexBuffer),e.sendAllBufferData(t.vaoManager)},CommonProceduralShaderLib.prototype.setShaderDefinition=function(t){e.prototype.setShaderDefinition.call(this,t),this.addAttributeVariable(["a_positionVec2"])},CommonProceduralShaderLib}(e.ProceduralShaderLib);e.CommonProceduralShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function SkyboxShaderLib(){e.apply(this,arguments),this.type="skybox"}return __extends(SkyboxShaderLib,e),SkyboxShaderLib.create=function(){var e=new this;return e},SkyboxShaderLib.prototype.sendShaderVariables=function(e,t,r){},SkyboxShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_samplerCube0"])},SkyboxShaderLib}(e.EngineShaderLib);e.SkyboxShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function EnvMapShaderLib(){e.apply(this,arguments)}return __extends(EnvMapShaderLib,e),EnvMapShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_samplerCube0"]),this.vsSourceBody=this.getVsChunk().body},EnvMapShaderLib}(e.EngineShaderLib);e.EnvMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CommonEnvMapShaderLib(){t.apply(this,arguments),this.type="common_envMap"}return __extends(CommonEnvMapShaderLib,t),CommonEnvMapShaderLib.create=function(){var e=new this;return e},CommonEnvMapShaderLib.prototype.sendShaderVariables=function(t,r,n){e.RenderTargerRendererShaderLibUtils.judgeAndSendIsRenderListEmptyVariable(t,e.EShaderGLSLData.DYNAMIC_CUBEMAP)},CommonEnvMapShaderLib.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addUniformVariable(["u_isRenderListEmpty"])},CommonEnvMapShaderLib}(e.EnvMapShaderLib);e.CommonEnvMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ForBasicEnvMapShaderLib(){t.apply(this,arguments)}return __extends(ForBasicEnvMapShaderLib,t),ForBasicEnvMapShaderLib.prototype.sendShaderVariables=function(r,n,i){t.prototype.sendShaderVariables.call(this,r,n,i),this.sendUniformData(r,"u_cameraPos",e.Director.getInstance().scene.currentCamera.transform.position)},ForBasicEnvMapShaderLib.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addUniformVariable(["u_cameraPos"])},ForBasicEnvMapShaderLib.prototype.setEnvMapSource=function(){var e=this.getVsChunk("forBasic_envMap"),t=this.getFsChunk("forBasic_envMap");this.vsSourceTop=e.top,this.vsSourceDefine=e.define,this.vsSourceVarDeclare=e.varDeclare,this.vsSourceFuncDeclare=e.funcDeclare,this.vsSourceFuncDefine=e.funcDefine,this.vsSourceBody+=e.body,this.setFsSource(t)},ForBasicEnvMapShaderLib}(e.EnvMapShaderLib);e.ForBasicEnvMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BasicForBasicEnvMapShaderLib(){e.apply(this,arguments),this.type="basic_forBasic_envMap"}return __extends(BasicForBasicEnvMapShaderLib,e),BasicForBasicEnvMapShaderLib.create=function(){var e=new this;return e},BasicForBasicEnvMapShaderLib}(e.ForBasicEnvMapShaderLib);e.BasicForBasicEnvMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function ReflectionForBasicEnvMapShaderLib(){e.apply(this,arguments),this.type="reflection_forBasic_envMap"}return __extends(ReflectionForBasicEnvMapShaderLib,e),ReflectionForBasicEnvMapShaderLib.create=function(){var e=new this;return e},ReflectionForBasicEnvMapShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},ReflectionForBasicEnvMapShaderLib}(e.ForBasicEnvMapShaderLib);e.ReflectionForBasicEnvMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function RefractionForBasicEnvMapShaderLib(){e.apply(this,arguments),this.type="refraction_forBasic_envMap"}return __extends(RefractionForBasicEnvMapShaderLib,e),RefractionForBasicEnvMapShaderLib.create=function(){var e=new this;return e},RefractionForBasicEnvMapShaderLib.prototype.sendShaderVariables=function(t,r,n){e.prototype.sendShaderVariables.call(this,t,r,n),this.sendUniformData(t,"u_refractionRatio",n.refractionRatio)},RefractionForBasicEnvMapShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_refractionRatio"]),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},RefractionForBasicEnvMapShaderLib}(e.ForBasicEnvMapShaderLib);e.RefractionForBasicEnvMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function FresnelForBasicEnvMapShaderLib(){e.apply(this,arguments),this.type="fresnel_forBasic_envMap"}return __extends(FresnelForBasicEnvMapShaderLib,e),FresnelForBasicEnvMapShaderLib.create=function(){var e=new this;return e},FresnelForBasicEnvMapShaderLib.prototype.sendShaderVariables=function(t,r,n){e.prototype.sendShaderVariables.call(this,t,r,n),this.sendUniformData(t,"u_refractionRatio",n.refractionRatio),this.sendUniformData(t,"u_reflectivity",n.reflectivity)},FresnelForBasicEnvMapShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_refractionRatio","u_reflectivity"]),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},FresnelForBasicEnvMapShaderLib}(e.ForBasicEnvMapShaderLib);e.FresnelForBasicEnvMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function ForLightEnvMapShaderLib(){e.apply(this,arguments)}return __extends(ForLightEnvMapShaderLib,e),ForLightEnvMapShaderLib.prototype.setEnvMapSource=function(){var e=this.getVsChunk("forLight_envMap"),t=this.getFsChunk("forLight_envMap");this.vsSourceTop=e.top,this.vsSourceDefine=e.define,this.vsSourceVarDeclare=e.varDeclare,this.vsSourceFuncDeclare=e.funcDeclare,this.vsSourceFuncDefine=e.funcDefine,this.vsSourceBody+=e.body,this.setFsSource(t)},ForLightEnvMapShaderLib}(e.EnvMapShaderLib);e.ForLightEnvMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BasicForLightEnvMapShaderLib(){e.apply(this,arguments),this.type="basic_forLight_envMap"}return __extends(BasicForLightEnvMapShaderLib,e),BasicForLightEnvMapShaderLib.create=function(){var e=new this;return e},BasicForLightEnvMapShaderLib}(e.ForLightEnvMapShaderLib);e.BasicForLightEnvMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function ReflectionForLightEnvMapShaderLib(){e.apply(this,arguments),this.type="reflection_forLight_envMap"}return __extends(ReflectionForLightEnvMapShaderLib,e),ReflectionForLightEnvMapShaderLib.create=function(){var e=new this;return e},ReflectionForLightEnvMapShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},ReflectionForLightEnvMapShaderLib}(e.ForLightEnvMapShaderLib);e.ReflectionForLightEnvMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function RefractionForLightEnvMapShaderLib(){e.apply(this,arguments),this.type="refraction_forLight_envMap"}return __extends(RefractionForLightEnvMapShaderLib,e),RefractionForLightEnvMapShaderLib.create=function(){var e=new this;return e},RefractionForLightEnvMapShaderLib.prototype.sendShaderVariables=function(t,r,n){e.prototype.sendShaderVariables.call(this,t,r,n),this.sendUniformData(t,"u_refractionRatio",n.refractionRatio)},RefractionForLightEnvMapShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_refractionRatio"]),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},RefractionForLightEnvMapShaderLib}(e.ForLightEnvMapShaderLib);e.RefractionForLightEnvMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function FresnelForLightEnvMapShaderLib(){t.apply(this,arguments),this.type="fresnel_forLight_envMap"}return __extends(FresnelForLightEnvMapShaderLib,t),FresnelForLightEnvMapShaderLib.create=function(){var e=new this;return e},FresnelForLightEnvMapShaderLib.prototype.sendShaderVariables=function(r,n,i){t.prototype.sendShaderVariables.call(this,r,n,i),null!==i.reflectivity?this.sendUniformData(r,"u_reflectivity",i.reflectivity):(this.sendUniformData(r,"u_reflectivity",e.ShaderChunk.NULL),this.sendUniformData(r,"u_refractionRatio",i.refractionRatio))},FresnelForLightEnvMapShaderLib.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addUniformVariable(["u_refractionRatio","u_reflectivity"]),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},FresnelForLightEnvMapShaderLib}(e.ForLightEnvMapShaderLib);e.FresnelForLightEnvMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function MapShaderLib(){t.apply(this,arguments)}return __extends(MapShaderLib,t),MapShaderLib.prototype.sendShaderVariables=function(t,r,n){var i=r.buffers.getChild(e.EBufferDataType.TEXCOORD),o=null,a=null;i&&(this.sendAttributeBuffer(t,"a_texCoord",i),o=n.mapList,a=o.getChild(0),this.sendUniformData(t,"u_map0SourceRegion",a.sourceRegionForGLSL),this.sendUniformData(t,"u_map0RepeatRegion",a.repeatRegion),this.sendMapShaderVariables(t,r,n))},MapShaderLib.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addAttributeVariable(["a_texCoord"]),this.addUniformVariable(["u_sampler2D0","u_map0SourceRegion","u_map0RepeatRegion"]),this._setMapSource()},MapShaderLib.prototype.sendMapShaderVariables=function(e,t,r){},MapShaderLib.prototype._setMapSource=function(){var e=this.getVsChunk("map_forBasic"),t=this.getFsChunk("map_forBasic");this.vsSourceTop=e.top,this.vsSourceDefine=e.define,this.vsSourceVarDeclare=e.varDeclare,this.vsSourceFuncDeclare=e.funcDeclare,this.vsSourceFuncDefine=e.funcDefine,this.vsSourceBody=e.body,this.setFsSource(t)},__decorate([e.virtual],MapShaderLib.prototype,"sendMapShaderVariables",null),MapShaderLib}(e.EngineShaderLib);e.MapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BasicMapShaderLib(){e.apply(this,arguments),this.type="map_forBasic"}return __extends(BasicMapShaderLib,e),BasicMapShaderLib.create=function(){var e=new this;return e},BasicMapShaderLib}(e.MapShaderLib);e.BasicMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function MultiMapShaderLib(){e.apply(this,arguments),this.type="multi_map_forBasic"}return __extends(MultiMapShaderLib,e),MultiMapShaderLib.create=function(){var e=new this;return e},MultiMapShaderLib.prototype.sendMapShaderVariables=function(e,t,r){var n=r.mapList,i=n.getChild(1);this.sendUniformData(e,"u_combineMode",r.mapCombineMode),this.sendUniformData(e,"u_mixRatio",r.mapMixRatio),this.sendUniformData(e,"u_map1SourceRegion",i.sourceRegionForGLSL),this.sendUniformData(e,"u_map1RepeatRegion",i.repeatRegion)},MultiMapShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_sampler2D1","u_combineMode","u_mixRatio","u_map1SourceRegion","u_map1RepeatRegion"]),this.vsSourceVarDeclare+=this.getVsChunk().varDeclare,this.vsSourceBody+=this.getVsChunk().body,this.fsSourceVarDeclare=this.getFsChunk().varDeclare,this.fsSourceFuncDefine=this.getFsChunk().funcDefine,this.fsSourceBody=this.getFsChunk().body},MultiMapShaderLib}(e.MapShaderLib);e.MultiMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function LightCommonShaderLib(){e.apply(this,arguments),this.type="lightCommon"}return __extends(LightCommonShaderLib,e),LightCommonShaderLib.create=function(){var e=new this;return e},LightCommonShaderLib.prototype.sendShaderVariables=function(e,t,r){},LightCommonShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.setVsSource(this.getVsChunk("light_common.glsl")),this.setVsSource(this.getVsChunk(),"+"),this.setFsSource(this.getFsChunk("light_common.glsl")),this.setFsSource(this.getFsChunk(),"+")},LightCommonShaderLib}(e.EngineShaderLib);e.LightCommonShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function LightSetWorldPositionShaderLib(){e.apply(this,arguments),this.type="light_setWorldPosition"}return __extends(LightSetWorldPositionShaderLib,e),LightSetWorldPositionShaderLib.create=function(){var e=new this;return e},LightSetWorldPositionShaderLib}(e.EngineShaderLib);e.LightSetWorldPositionShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function LightShaderLib(){t.apply(this,arguments),this.type="light"}return __extends(LightShaderLib,t),LightShaderLib.create=function(){var e=new this;return e},LightShaderLib.prototype.sendShaderVariables=function(t,r,n){this.sendUniformData(t,"u_cameraPos",e.Director.getInstance().scene.currentCamera.transform.position),this.sendUniformData(t,"u_shininess",n.shininess),this.sendUniformData(t,"u_opacity",n.opacity),this.sendUniformData(t,"u_lightModel",this._convertLightModelToGLSLVariable(n.lightModel)),this._sendLightVariables(t)},LightShaderLib.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addUniformVariable(["u_normalMatrix","u_cameraPos","u_shininess","u_ambient","u_opacity","u_isBothSide","u_lightModel"]),this._setLightDefinition(r)},LightShaderLib.prototype._sendLightVariables=function(t){var r=e.Director.getInstance().scene,n=r.directionLights,i=r.ambientLight,o=r.pointLights;i&&this.sendUniformData(t,"u_ambient",i.getComponent(e.AmbientLight).color.toVector3()),o&&this._sendPointLightVariables(t,o),n&&this._sendDirectionLightVariables(t,n)},LightShaderLib.prototype._sendPointLightVariables=function(t,r){r.forEach(function(r,n){var i=r.getComponent(e.PointLight),o=e.POINT_LIGHT_GLSLDATA_STRUCTURE_MEMBER_NAME[n];t.sendVector3(o.position,e.LightUtils.getPointLightPosition(i)),t.sendColor3(o.color,i.color),t.sendFloat1(o.intensity,i.intensity),t.sendFloat1(o.constant,i.constant),t.sendFloat1(o.linear,i.linear),t.sendFloat1(o.quadratic,i.quadratic),null!==i.range?t.sendFloat1(o.range,i.range):t.sendFloat1(o.range,e.ShaderChunk.NULL)})},LightShaderLib.prototype._sendDirectionLightVariables=function(t,r){r.forEach(function(r,n){var i=r.getComponent(e.DirectionLight),o=e.DIRECTION_LIGHT_GLSLDATA_STRUCTURE_MEMBER_NAME[n];t.sendVector3(o.position,e.LightUtils.getDirectionLightPosition(i)),t.sendColor3(o.color,i.color),t.sendFloat1(o.intensity,i.intensity)})},LightShaderLib.prototype._setLightDefinition=function(t){var r=e.Director.getInstance().scene,n=r.directionLights,i=r.pointLights,o=0,a=0;n&&(this.addUniformVariable(["u_directionLights"]),o=n.getCount()),i&&(this.addUniformVariable(["u_pointLights"]),a=i.getCount()),this._addDefine(this.vsSourceDefineList,o,a),this._addDefine(this.fsSourceDefineList,o,a),t.side===e.ESide.BOTH&&this.fsSourceDefineList.addChildren([{name:"BOTH_SIDE"}])},LightShaderLib.prototype._addDefine=function(e,t,r){e.addChildren([{name:"DIRECTION_LIGHTS_COUNT",value:t},{name:"POINT_LIGHTS_COUNT",value:r}])},LightShaderLib.prototype._convertLightModelToGLSLVariable=function(t){switch(t){case e.ELightModel.BLINN:return 1;case e.ELightModel.PHONG:return 2;case e.ELightModel.CONSTANT:return 3;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("lightModel:"+t))}},__decorate([e.require(function(t){e.assert(t!==e.ELightModel.LAMBERT,e.Log.info.FUNC_SHOULD_NOT("lightModel","=== ELightModel.LAMBERT"))})],LightShaderLib.prototype,"_convertLightModelToGLSLVariable",null),LightShaderLib}(e.EngineShaderLib);e.LightShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function LightEndShaderLib(){e.apply(this,arguments),this.type="lightEnd"}return __extends(LightEndShaderLib,e),LightEndShaderLib.create=function(){var e=new this;return e},LightEndShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),null!==r.alphaTest&&(this.fsSourceBody+="if (totalColor.a < "+r.alphaTest+"){\n    discard;\n}\n")},LightEndShaderLib}(e.EngineShaderLib);e.LightEndShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BaseLightMapShaderLib(){e.apply(this,arguments)}return __extends(BaseLightMapShaderLib,e),BaseLightMapShaderLib.prototype.sendShaderVariables=function(e,t,r){},BaseLightMapShaderLib}(e.EngineShaderLib);e.BaseLightMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CommonLightMapShaderLib(){t.apply(this,arguments)}return __extends(CommonLightMapShaderLib,t),CommonLightMapShaderLib.create=function(){var e=new this;return e},CommonLightMapShaderLib.prototype.sendShaderVariables=function(t,r,n){var i=r.buffers.getChild(e.EBufferDataType.TEXCOORD);i&&(this.sendAttributeBuffer(t,"a_texCoord",i),this.sendUniformData(t,"u_specular",n.specularColor.toVector3()))},CommonLightMapShaderLib.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addAttributeVariable(["a_texCoord"]),this.addUniformVariable(["u_specular"])},CommonLightMapShaderLib}(e.EngineShaderLib);e.CommonLightMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function LightMapShaderLib(){t.apply(this,arguments),this.type="lightMap"}return __extends(LightMapShaderLib,t),LightMapShaderLib.create=function(){var e=new this;return e},LightMapShaderLib.prototype.sendShaderVariables=function(e,t,r){this.sendUniformData(e,"u_lightMapIntensity",r.lightMapIntensity)},LightMapShaderLib.prototype.setShaderDefinition=function(r,n){t.prototype.setShaderDefinition.call(this,r,n),this.addUniformVariable([e.VariableNameTable.getVariableName("lightMap"),"u_lightMapIntensity"])},LightMapShaderLib}(e.BaseLightMapShaderLib);e.LightMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DiffuseMapShaderLib(){t.apply(this,arguments),this.type="diffuseMap"}return __extends(DiffuseMapShaderLib,t),DiffuseMapShaderLib.create=function(){var e=new this;return e},DiffuseMapShaderLib.prototype.sendShaderVariables=function(e,t,r){var n=r.diffuseMap;return this.sendUniformData(e,"u_diffuseMapSourceRegion",n.sourceRegionForGLSL),this.sendUniformData(e,"u_diffuseMapRepeatRegion",n.repeatRegion),this},DiffuseMapShaderLib.prototype.setShaderDefinition=function(r,n){t.prototype.setShaderDefinition.call(this,r,n),this.addUniformVariable([e.VariableNameTable.getVariableName("diffuseMap"),"u_diffuseMapSourceRegion","u_diffuseMapRepeatRegion"])},__decorate([e.require(function(t,r,n){var i=n.diffuseMap;e.assert(!!i,e.Log.info.FUNC_MUST_DEFINE("diffuseMap")),e.assert(!!i.sourceRegionForGLSL&&!!i.repeatRegion,e.Log.info.FUNC_SHOULD("material.diffuseMap","has sourceRegionForGLSL,repeatRegion data"))})],DiffuseMapShaderLib.prototype,"sendShaderVariables",null),DiffuseMapShaderLib}(e.BaseLightMapShaderLib);e.DiffuseMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function SpecularMapShaderLib(){t.apply(this,arguments),this.type="specularMap"}return __extends(SpecularMapShaderLib,t),SpecularMapShaderLib.create=function(){var e=new this;return e},SpecularMapShaderLib.prototype.setShaderDefinition=function(r,n){t.prototype.setShaderDefinition.call(this,r,n),this.addUniformVariable([e.VariableNameTable.getVariableName("specularMap")])},SpecularMapShaderLib}(e.BaseLightMapShaderLib);e.SpecularMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function EmissionMapShaderLib(){t.apply(this,arguments),this.type="emissionMap"}return __extends(EmissionMapShaderLib,t),EmissionMapShaderLib.create=function(){var e=new this;return e},EmissionMapShaderLib.prototype.setShaderDefinition=function(r,n){t.prototype.setShaderDefinition.call(this,r,n),this.addUniformVariable([e.VariableNameTable.getVariableName("emissionMap")])},EmissionMapShaderLib}(e.BaseLightMapShaderLib);e.EmissionMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function NormalMapShaderLib(){t.apply(this,arguments),this.type="normalMap"}return __extends(NormalMapShaderLib,t),NormalMapShaderLib.create=function(){var e=new this;return e},NormalMapShaderLib.prototype.sendShaderVariables=function(r,n,i){var o=null;t.prototype.sendShaderVariables.call(this,r,n,i),o=n.buffers.getChild(e.EBufferDataType.TANGENT),o&&this.sendAttributeBuffer(r,"a_tangent",o)},NormalMapShaderLib.prototype.setShaderDefinition=function(r,n){t.prototype.setShaderDefinition.call(this,r,n),this.addAttributeVariable(["a_tangent"]),this.addUniformVariable([e.VariableNameTable.getVariableName("normalMap")])},NormalMapShaderLib}(e.BaseLightMapShaderLib);e.NormalMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function NoLightMapShaderLib(){e.apply(this,arguments),this.type="noLightMap"}return __extends(NoLightMapShaderLib,e),NoLightMapShaderLib.create=function(){var e=new this;return e},NoLightMapShaderLib.prototype.sendShaderVariables=function(e,t,r){},NoLightMapShaderLib}(e.EngineShaderLib);e.NoLightMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function NoDiffuseMapShaderLib(){e.apply(this,arguments),this.type="noDiffuseMap"}return __extends(NoDiffuseMapShaderLib,e),NoDiffuseMapShaderLib.create=function(){var e=new this;return e},NoDiffuseMapShaderLib.prototype.sendShaderVariables=function(e,t,r){this.sendUniformData(e,"u_diffuse",r.color.toVector3())},NoDiffuseMapShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_diffuse"])},NoDiffuseMapShaderLib}(e.EngineShaderLib);e.NoDiffuseMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function NoSpecularMapShaderLib(){e.apply(this,arguments),this.type="noSpecularMap"}return __extends(NoSpecularMapShaderLib,e),NoSpecularMapShaderLib.create=function(){var e=new this;return e},NoSpecularMapShaderLib}(e.EngineShaderLib);e.NoSpecularMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function NoEmissionMapShaderLib(){e.apply(this,arguments),this.type="noEmissionMap"}return __extends(NoEmissionMapShaderLib,e),NoEmissionMapShaderLib.create=function(){var e=new this;return e},NoEmissionMapShaderLib.prototype.sendShaderVariables=function(e,t,r){this.sendUniformData(e,"u_emission",r.emissionColor.toVector3())},NoEmissionMapShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_emission"])},NoEmissionMapShaderLib}(e.EngineShaderLib);e.NoEmissionMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function NoNormalMapShaderLib(){t.apply(this,arguments),this.type="noNormalMap"}return __extends(NoNormalMapShaderLib,t),NoNormalMapShaderLib.create=function(){var e=new this;return e},NoNormalMapShaderLib.prototype.sendShaderVariables=function(e,t,r){},NoNormalMapShaderLib.prototype.setShaderDefinition=function(r,n){var i=null;t.prototype.setShaderDefinition.call(this,r,n),i=e.ShaderChunk.noNormalMap_light_fragment,this.fsSourceVarDeclare=i.varDeclare,this.fsSourceFuncDefine+=i.funcDefine},NoNormalMapShaderLib}(e.EngineShaderLib);e.NoNormalMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function NoShadowMapShaderLib(){e.apply(this,arguments),this.type="noShadowMap"}return __extends(NoShadowMapShaderLib,e),NoShadowMapShaderLib.create=function(){var e=new this;return e},NoShadowMapShaderLib.prototype.sendShaderVariables=function(e,t,r){},NoShadowMapShaderLib}(e.EngineShaderLib);e.NoShadowMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(){function CustomShaderLibUtils(){}return CustomShaderLibUtils.sendUniformData=function(t,r,n,i){r===e.EVariableType.STRUCTURE?this._sendStructureData(t,n,i):i.sendUniformData(t,r,n)},CustomShaderLibUtils.sendUniformDataWithSemantic=function(t,r,n,i,o){r===e.EVariableType.STRUCTURE?this._sendStructureDataWithSemantic(t,n,i,o):i.sendUniformData(t,r,this._getUniformData(n,o))},CustomShaderLibUtils.sendAttributeBufferWithSemantic=function(e,t,r,n,i){n.sendAttributeBuffer(e,this._getAttributeType(t),this._getAttributeData(r,t,i))},CustomShaderLibUtils._sendStructureData=function(e,t,r){for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];r.sendStructureData(e+"."+n,i.type,i.value)}},CustomShaderLibUtils._sendStructureDataWithSemantic=function(e,t,r,n){for(var i in t)if(t.hasOwnProperty(i)){var o=t[i];r.sendStructureData(e+"."+i,o.type,this._getUniformData(o.value,n))}},CustomShaderLibUtils._getAttributeData=function(t,r,n){switch(t){case e.EVariableSemantic.POSITION:return n.buffers.getChild(e.EBufferDataType.VERTICE);case e.EVariableSemantic.TEXCOORD:return n.buffers.getChild(e.EBufferDataType.TEXCOORD);case e.EVariableSemantic.COLOR:return n.buffers.getChild(e.EBufferDataType.COLOR);case e.EVariableSemantic.NORMAL:return n.buffers.getChild(e.EBufferDataType.NORMAL);case e.EVariableSemantic.TANGENT:return n.buffers.getChild(e.EBufferDataType.TANGENT);default:return t}},CustomShaderLibUtils._getAttributeType=function(t){return e.EVariableType.BUFFER},CustomShaderLibUtils._getUniformData=function(t,r){switch(t){case e.EVariableSemantic.MODEL:return r.mMatrix;case e.EVariableSemantic.VIEW:return r.vMatrix;case e.EVariableSemantic.PROJECTION:return r.pMatrix;case e.EVariableSemantic.MODEL_VIEW_PROJECTION:return r.mvpMatrix;case e.EVariableSemantic.MODEL_INVERSE:return r.mMatrix.clone().invert();case e.EVariableSemantic.VIEW_INVERSE:return r.vMatrix.clone().invert();case e.EVariableSemantic.PROJECTION_INVERSE:return r.pMatrix.clone().invert();case e.EVariableSemantic.MODEL_VIEW_INVERSE:return r.mMatrix.applyMatrix(r.vMatrix,!0).invert();case e.EVariableSemantic.MODEL_VIEW_PROJECTION_INVERSE:return r.mMatrix.applyMatrix(r.vMatrix,!0).applyMatrix(r.pMatrix,!1).invert();case e.EVariableSemantic.MODEL_INVERSE_TRANSPOSE:return r.normalMatrix;case e.EVariableSemantic.MODEL_VIEW_INVERSE_TRANSPOSE:return r.mMatrix.applyMatrix(r.vMatrix,!0).invertTo3x3().transpose();case e.EVariableSemantic.VIEWPORT:return e.DeviceManager.getInstance().getViewport();default:return t}},__decorate([e.require(function(t,r,n,i){e.assert(r!==e.EVariableType.SAMPLER_2D&&r!==e.EVariableType.SAMPLER_CUBE,e.Log.info.FUNC_SHOULD_NOT("type","be SAMPLER_2D or SAMPLER_CUBE, but actual is "+r)),e.assert(r!==e.EVariableType.STRUCTURES,e.Log.info.FUNC_NOT_SUPPORT("type === STRUCTURES")),r===e.EVariableType.STRUCTURE&&e.assert(e.JudgeUtils.isDirectObject(n),e.Log.info.FUNC_MUST_BE("value","object when type === STRUCTURE"))})],CustomShaderLibUtils,"sendUniformData",null),__decorate([e.require(function(t,r,n,i,o){e.assert(r!==e.EVariableType.SAMPLER_2D&&r!==e.EVariableType.SAMPLER_CUBE,e.Log.info.FUNC_SHOULD_NOT("type","be SAMPLER_2D or SAMPLER_CUBE, but actual is "+r)),e.assert(r!==e.EVariableType.STRUCTURES,e.Log.info.FUNC_NOT_SUPPORT("type === STRUCTURES")),r===e.EVariableType.STRUCTURE&&e.assert(e.JudgeUtils.isDirectObject(n),e.Log.info.FUNC_MUST_BE("value","object when type === STRUCTURE"))})],CustomShaderLibUtils,"sendUniformDataWithSemantic",null),__decorate([e.require(function(t,r,n){switch(e.assert("INDICE"!==t,e.Log.info.FUNC_NOT_SUPPORT("semantic:INDICE")),t){case"POSITION":case"COLOR":case"NORMAL":case"TANGENT":e.assert(r===e.EVariableType.FLOAT_3,e.Log.info.FUNC_SHOULD("type","be EVariableType.FLOAT_3"));break;case"TEXCOORD":e.assert(r===e.EVariableType.FLOAT_2,e.Log.info.FUNC_SHOULD("type","be EVariableType.FLOAT_2"))}}),e.ensure(function(t){e.assert(t&&t instanceof e.Buffer,e.Log.info.FUNC_SHOULD("attributeData","be Buffer, but actual is "+t))})],CustomShaderLibUtils,"_getAttributeData",null),CustomShaderLibUtils}();e.CustomShaderLibUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function RenderTargerRendererShaderLibUtils(){}return RenderTargerRendererShaderLibUtils.judgeAndSendIsRenderListEmptyVariable=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=t[0],o=t[1],a=null;n=e.Director.getInstance().scene.glslData.getChild(o),n&&(a=3===t.length?t[2]:"u_isRenderListEmpty",n.isRenderListEmpty?i.sendUniformData(a,e.EVariableType.NUMBER_1,1):i.sendUniformData(a,e.EVariableType.NUMBER_1,0))},RenderTargerRendererShaderLibUtils}();e.RenderTargerRendererShaderLibUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function InstanceShaderLib(){e.apply(this,arguments)}return __extends(InstanceShaderLib,e),InstanceShaderLib}(e.EngineShaderLib);e.InstanceShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function NoInstanceShaderLib(){e.apply(this,arguments)}return __extends(NoInstanceShaderLib,e),NoInstanceShaderLib}(e.EngineShaderLib);e.NoInstanceShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function ModelMatrixInstanceShaderLib(){e.apply(this,arguments)}return __extends(ModelMatrixInstanceShaderLib,e),ModelMatrixInstanceShaderLib}(e.InstanceShaderLib);e.ModelMatrixInstanceShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function NormalMatrixModelMatrixInstanceShaderLib(){e.apply(this,arguments)}return __extends(NormalMatrixModelMatrixInstanceShaderLib,e),NormalMatrixModelMatrixInstanceShaderLib}(e.InstanceShaderLib);e.NormalMatrixModelMatrixInstanceShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function ModelMatrixHardwareInstanceShaderLib(){e.apply(this,arguments),this.type="modelMatrix_hardware_instance"}return __extends(ModelMatrixHardwareInstanceShaderLib,e),ModelMatrixHardwareInstanceShaderLib.create=function(){var e=new this;return e},ModelMatrixHardwareInstanceShaderLib.prototype.sendShaderVariables=function(e,t,r){},ModelMatrixHardwareInstanceShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addAttributeVariable(["a_mVec4_0","a_mVec4_1","a_mVec4_2","a_mVec4_3"])},ModelMatrixHardwareInstanceShaderLib}(e.ModelMatrixInstanceShaderLib);e.ModelMatrixHardwareInstanceShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function NormalMatrixHardwareInstanceShaderLib(){e.apply(this,arguments),this.type="normalMatrix_hardware_instance"}return __extends(NormalMatrixHardwareInstanceShaderLib,e),NormalMatrixHardwareInstanceShaderLib.create=function(){var e=new this;return e},NormalMatrixHardwareInstanceShaderLib.prototype.sendShaderVariables=function(e,t,r){},NormalMatrixHardwareInstanceShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addAttributeVariable(["a_normalVec4_0","a_normalVec4_1","a_normalVec4_2"]);
},NormalMatrixHardwareInstanceShaderLib}(e.NormalMatrixModelMatrixInstanceShaderLib);e.NormalMatrixHardwareInstanceShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function ModelMatrixBatchInstanceShaderLib(){e.apply(this,arguments),this.type="modelMatrix_batch_instance"}return __extends(ModelMatrixBatchInstanceShaderLib,e),ModelMatrixBatchInstanceShaderLib.create=function(){var e=new this;return e},ModelMatrixBatchInstanceShaderLib.prototype.sendShaderVariables=function(e,t,r){},ModelMatrixBatchInstanceShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_mMatrix"])},ModelMatrixBatchInstanceShaderLib}(e.ModelMatrixInstanceShaderLib);e.ModelMatrixBatchInstanceShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function NormalMatrixBatchInstanceShaderLib(){e.apply(this,arguments),this.type="normalMatrix_batch_instance"}return __extends(NormalMatrixBatchInstanceShaderLib,e),NormalMatrixBatchInstanceShaderLib.create=function(){var e=new this;return e},NormalMatrixBatchInstanceShaderLib.prototype.sendShaderVariables=function(e,t,r){},NormalMatrixBatchInstanceShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_normalMatrix"])},NormalMatrixBatchInstanceShaderLib}(e.NormalMatrixModelMatrixInstanceShaderLib);e.NormalMatrixBatchInstanceShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function ModelMatrixNoInstanceShaderLib(){e.apply(this,arguments),this.type="modelMatrix_noInstance"}return __extends(ModelMatrixNoInstanceShaderLib,e),ModelMatrixNoInstanceShaderLib.create=function(){var e=new this;return e},ModelMatrixNoInstanceShaderLib.prototype.sendShaderVariables=function(e,t,r){this.sendUniformData(e,"u_mMatrix",t.mMatrix)},ModelMatrixNoInstanceShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_mMatrix"])},ModelMatrixNoInstanceShaderLib}(e.NoInstanceShaderLib);e.ModelMatrixNoInstanceShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function NormalMatrixNoInstanceShaderLib(){e.apply(this,arguments),this.type="normalMatrix_noInstance"}return __extends(NormalMatrixNoInstanceShaderLib,e),NormalMatrixNoInstanceShaderLib.create=function(){var e=new this;return e},NormalMatrixNoInstanceShaderLib.prototype.sendShaderVariables=function(e,t,r){this.sendUniformData(e,"u_normalMatrix",t.normalMatrix)},NormalMatrixNoInstanceShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_normalMatrix"])},NormalMatrixNoInstanceShaderLib}(e.NoInstanceShaderLib);e.NormalMatrixNoInstanceShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ShaderChunk(){}return ShaderChunk.empty={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.NULL=-1,ShaderChunk.normal_morph_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"vec3 a_normal = a_currentFrameNormal + (a_nextFrameNormal - a_currentFrameNormal) * u_interpolation;\n"},ShaderChunk.vertice_morph_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"vec3 a_position = a_currentFramePosition + (a_nextFramePosition - a_currentFramePosition) * u_interpolation;\n"},ShaderChunk.vertice_skinSkeleton_vertex={top:"",define:"",varDeclare:"uniform mat4 u_jointMatrices[MAX_JOINT_COUNT];\n",funcDeclare:"",funcDefine:"mat4 getJointMatrix(const in float i) {\n        return u_jointMatrices[int(i)];\n    }\n\n    mat4 getVertexBlendedJointMatrix() {\n        return getJointMatrix(a_jointIndice.x) * a_jointWeight.x + getJointMatrix(a_jointIndice.y) * a_jointWeight.y + getJointMatrix(a_jointIndice.z) * a_jointWeight.z + getJointMatrix(a_jointIndice.w) * a_jointWeight.w;\n    }\n",body:"vec3 a_position = vec3(getVertexBlendedJointMatrix() * vec4(a_position, 1.0));\n"},ShaderChunk.basic_materialColor_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"vec4 totalColor = vec4(u_color, 1.0);\n"},ShaderChunk.basic_vertexColor_fragment={top:"",define:"",varDeclare:"varying vec3 v_color;\n",funcDeclare:"",funcDefine:"",body:"vec4 totalColor = vec4(v_color, 1.0);\n"},ShaderChunk.basic_vertexColor_vertex={top:"",define:"",varDeclare:"varying vec3 v_color;\n",funcDeclare:"",funcDefine:"",body:"v_color = a_color;\n"},ShaderChunk.end_basic_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_FragColor = vec4(totalColor.rgb, totalColor.a * u_opacity);\n"},ShaderChunk.common_define={top:"",define:"#define NULL -1.0\n",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.common_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.common_function={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"mat2 transpose(mat2 m) {\n  return mat2(  m[0][0], m[1][0],   // new col 0\n                m[0][1], m[1][1]    // new col 1\n             );\n  }\nmat3 transpose(mat3 m) {\n  return mat3(  m[0][0], m[1][0], m[2][0],  // new col 0\n                m[0][1], m[1][1], m[2][1],  // new col 1\n                m[0][2], m[1][2], m[2][2]   // new col 1\n             );\n  }\n\nbool isRenderListEmpty(int isRenderListEmpty){\n  return isRenderListEmpty == 1;\n}\n",body:""},ShaderChunk.common_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.highp_fragment={top:"precision highp float;\nprecision highp int;\n",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.lowp_fragment={top:"precision lowp float;\nprecision lowp int;\n",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.mediump_fragment={top:"precision mediump float;\nprecision mediump int;\n",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.noNormalMap_light_fragment={top:"",define:"",varDeclare:"varying vec3 v_normal;\n",funcDeclare:"",funcDefine:"#if POINT_LIGHTS_COUNT > 0\nvec3 getPointLightDir(int index){\n    //workaround '[] : Index expression must be constant' error\n    for (int x = 0; x <= POINT_LIGHTS_COUNT; x++) {\n        if(x == index){\n            return getPointLightDirByLightPos(u_pointLights[x].position);\n        }\n    }\n    /*!\n    solve error in window7 chrome/firefox:\n    not all control paths return a value.\n    failed to create d3d shaders\n    */\n    return vec3(0.0);\n}\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\nvec3 getDirectionLightDir(int index){\n    //workaround '[] : Index expression must be constant' error\n    for (int x = 0; x <= DIRECTION_LIGHTS_COUNT; x++) {\n        if(x == index){\n            return getDirectionLightDirByLightPos(u_directionLights[x].position);\n        }\n    }\n\n    /*!\n    solve error in window7 chrome/firefox:\n    not all control paths return a value.\n    failed to create d3d shaders\n    */\n    return vec3(0.0);\n}\n#endif\n\n\nvec3 getViewDir(){\n    return normalize(u_cameraPos - v_worldPosition);\n}\n",body:""},ShaderChunk.common_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec3 flipNormal(vec3 normal){\n    vec3 normalForRefraction = normal;\n    normalForRefraction.y = -normalForRefraction.y;\n    normalForRefraction.z = -normalForRefraction.z;\n\n    return normalForRefraction;\n}\n",body:""},ShaderChunk.lightCommon_fragment={top:"",define:"",varDeclare:"varying vec3 v_worldPosition;\n#if POINT_LIGHTS_COUNT > 0\nstruct PointLight {\n    vec3 position;\n    vec3 color;\n    float intensity;\n\n    float range;\n    float constant;\n    float linear;\n    float quadratic;\n};\nuniform PointLight u_pointLights[POINT_LIGHTS_COUNT];\n\n#endif\n\n\n#if DIRECTION_LIGHTS_COUNT > 0\nstruct DirectionLight {\n    vec3 position;\n\n    float intensity;\n\n    vec3 color;\n};\nuniform DirectionLight u_directionLights[DIRECTION_LIGHTS_COUNT];\n#endif\n",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.lightCommon_vertex={top:"",define:"",varDeclare:"varying vec3 v_worldPosition;\n#if POINT_LIGHTS_COUNT > 0\n    struct PointLight {\n    vec3 position;\n    vec3 color;\n    float intensity;\n\n    float range;\n    float constant;\n    float linear;\n    float quadratic;\n};\nuniform PointLight u_pointLights[POINT_LIGHTS_COUNT];\n\n#endif\n\n\n#if DIRECTION_LIGHTS_COUNT > 0\n    struct DirectionLight {\n    vec3 position;\n\n    float intensity;\n\n    vec3 color;\n};\nuniform DirectionLight u_directionLights[DIRECTION_LIGHTS_COUNT];\n#endif\n",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.lightEnd_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_FragColor = totalColor;\n"},ShaderChunk.light_common={top:"",define:"",varDeclare:"",funcDeclare:"vec3 getDirectionLightDirByLightPos(vec3 lightPos);\nvec3 getPointLightDirByLightPos(vec3 lightPos);\nvec3 getPointLightDirByLightPos(vec3 lightPos, vec3 worldPosition);\n",funcDefine:"vec3 getDirectionLightDirByLightPos(vec3 lightPos){\n    return lightPos - vec3(0.0);\n    //return vec3(0.0) - lightPos;\n}\nvec3 getPointLightDirByLightPos(vec3 lightPos){\n    return lightPos - v_worldPosition;\n}\nvec3 getPointLightDirByLightPos(vec3 lightPos, vec3 worldPosition){\n    return lightPos - worldPosition;\n}\n",body:""},ShaderChunk.light_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float getBlinnShininess(float shininess, vec3 normal, vec3 lightDir, vec3 viewDir, float dotResultBetweenNormAndLight){\n        vec3 halfAngle = normalize(lightDir + viewDir);\n        float blinnTerm = dot(normal, halfAngle);\n\n        blinnTerm = clamp(blinnTerm, 0.0, 1.0);\n        blinnTerm = dotResultBetweenNormAndLight != 0.0 ? blinnTerm : 0.0;\n        blinnTerm = pow(blinnTerm, shininess);\n\n        return blinnTerm;\n}\n\nfloat getPhongShininess(float shininess, vec3 normal, vec3 lightDir, vec3 viewDir, float dotResultBetweenNormAndLight){\n        vec3 reflectDir = reflect(-lightDir, normal);\n        float phongTerm = dot(viewDir, reflectDir);\n\n        phongTerm = clamp(phongTerm, 0.0, 1.0);\n        phongTerm = dotResultBetweenNormAndLight != 0.0 ? phongTerm : 0.0;\n        phongTerm = pow(phongTerm, shininess);\n\n        return phongTerm;\n}\n\nvec4 calcLight(vec3 lightDir, vec3 color, float intensity, float attenuation, vec3 normal, vec3 viewDir)\n{\n        vec3 materialLight = getMaterialLight();\n        vec4 materialDiffuse = getMaterialDiffuse();\n        vec3 materialSpecular = u_specular;\n        vec3 materialEmission = getMaterialEmission();\n\n        float specularStrength = getSpecularStrength();\n\n        float dotResultBetweenNormAndLight = dot(normal, lightDir);\n        float diff = max(dotResultBetweenNormAndLight, 0.0);\n\n        vec3 emissionColor = materialEmission;\n\n        vec3 ambientColor = (u_ambient + materialLight) * materialDiffuse.rgb;\n\n\n        if(u_lightModel == 3){\n            return vec4(emissionColor + ambientColor, 1.0);\n        }\n\n        vec4 diffuseColor = vec4(color * materialDiffuse.rgb * diff * intensity, materialDiffuse.a);\n\n        float spec = 0.0;\n\n        if(u_lightModel == 2){\n                spec = getPhongShininess(u_shininess, normal, lightDir, viewDir, diff);\n        }\n        else if(u_lightModel == 1){\n                spec = getBlinnShininess(u_shininess, normal, lightDir, viewDir, diff);\n        }\n\n        vec3 specularColor = spec * materialSpecular * specularStrength * intensity;\n\n        return vec4(emissionColor + ambientColor + attenuation * (diffuseColor.rgb + specularColor), diffuseColor.a);\n//        return vec4(emissionColor + ambientColor + attenuation * (diffuseColor.rgb + specularColor), 1.0);\n}\n\n\n\n\n#if POINT_LIGHTS_COUNT > 0\n        vec4 calcPointLight(vec3 lightDir, PointLight light, vec3 normal, vec3 viewDir)\n{\n        //lightDir is not normalize computing distance\n        float distance = length(lightDir);\n\n        float attenuation = 0.0;\n\n        if(light.range == NULL || distance < light.range)\n        {\n            attenuation = 1.0 / (light.constant + light.linear * distance + light.quadratic * (distance * distance));\n        }\n\n        lightDir = normalize(lightDir);\n\n        return calcLight(lightDir, light.color, light.intensity, attenuation, normal, viewDir);\n}\n#endif\n\n\n\n#if DIRECTION_LIGHTS_COUNT > 0\n        vec4 calcDirectionLight(vec3 lightDir, DirectionLight light, vec3 normal, vec3 viewDir)\n{\n        float attenuation = 1.0;\n\n        lightDir = normalize(lightDir);\n\n        return calcLight(lightDir, light.color, light.intensity, attenuation, normal, viewDir);\n}\n#endif\n\n\n\nvec4 calcTotalLight(vec3 norm, vec3 viewDir){\n    vec4 totalLight = vec4(0.0);\n\n    #if POINT_LIGHTS_COUNT > 0\n                for(int i = 0; i < POINT_LIGHTS_COUNT; i++){\n                totalLight += calcPointLight(getPointLightDir(i), u_pointLights[i], norm, viewDir);\n        }\n    #endif\n\n    #if DIRECTION_LIGHTS_COUNT > 0\n                for(int i = 0; i < DIRECTION_LIGHTS_COUNT; i++){\n                totalLight += calcDirectionLight(getDirectionLightDir(i), u_directionLights[i], norm, viewDir);\n        }\n    #endif\n\n        return totalLight;\n}\n",body:"vec3 normal = normalize(getNormal());\n\n#ifdef BOTH_SIDE\nnormal = normal * (-1.0 + 2.0 * float(gl_FrontFacing));\n#endif\n\nvec3 viewDir = normalize(getViewDir());\n\nvec4 totalColor = calcTotalLight(normal, viewDir);\n\ntotalColor.a *= u_opacity;\n\ntotalColor.rgb = totalColor.rgb * getShadowVisibility();\n"},ShaderChunk.light_setWorldPosition_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"v_worldPosition = vec3(mMatrix * vec4(a_position, 1.0));\n"},ShaderChunk.light_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_Position = u_pMatrix * u_vMatrix * vec4(v_worldPosition, 1.0);\n"},ShaderChunk.map_forBasic_fragment={top:"",define:"",varDeclare:"varying vec2 v_mapCoord0;\n",funcDeclare:"",funcDefine:"",body:"totalColor *= texture2D(u_sampler2D0, v_mapCoord0);\n"},ShaderChunk.map_forBasic_vertex={top:"",define:"",varDeclare:"varying vec2 v_mapCoord0;\n",funcDeclare:"",funcDefine:"",body:"vec2 sourceTexCoord0 = a_texCoord * u_map0SourceRegion.zw + u_map0SourceRegion.xy;\n\n    v_mapCoord0 = sourceTexCoord0 * u_map0RepeatRegion.zw + u_map0RepeatRegion.xy;\n"},ShaderChunk.multi_map_forBasic_fragment={top:"",define:"",varDeclare:"varying vec2 v_mapCoord0;\nvarying vec2 v_mapCoord1;\n",funcDeclare:"",funcDefine:"vec4 getMapColor(){\n            vec4 color0 = texture2D(u_sampler2D0, v_mapCoord0);\n            vec4 color1 = texture2D(u_sampler2D1, v_mapCoord1);\n\n            if(u_combineMode == 0){\n                return mix(color0, color1, u_mixRatio);\n            }\n            else if(u_combineMode == 1){\n                return color0 * color1;\n            }\n            else if(u_combineMode == 2){\n                return color0 + color1;\n            }\n\n            /*!\n            solve error in window7 chrome/firefox:\n            not all control paths return a value.\n            failed to create d3d shaders\n            */\n            return vec4(1.0);\n\t\t}\n",body:"totalColor *= getMapColor();\n"},ShaderChunk.multi_map_forBasic_vertex={top:"",define:"",varDeclare:"varying vec2 v_mapCoord1;\n",funcDeclare:"",funcDefine:"",body:"vec2 sourceTexCoord1 = a_texCoord * u_map1SourceRegion.zw + u_map1SourceRegion.xy;\n\n    v_mapCoord1 = sourceTexCoord1 * u_map1RepeatRegion.zw + u_map1RepeatRegion.xy;\n"},ShaderChunk.common_proceduralTexture_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float rand(vec2 n) {\n\treturn fract(cos(dot(n, vec2(12.9898, 4.1414))) * 43758.5453);\n}\nfloat noise(vec2 n) {\n\tconst vec2 d = vec2(0.0, 1.0);\n\tvec2 b = floor(n), f = smoothstep(vec2(0.0), vec2(1.0), fract(n));\n\treturn mix(mix(rand(b), rand(b + d.yx), f.x), mix(rand(b + d.xy), rand(b + d.yy), f.x), f.y);\n}\n\nfloat turbulence(vec2 P)\n{\n\tfloat val = 0.0;\n\tfloat freq = 1.0;\n\tfor (int i = 0; i < 4; i++)\n\t{\n\t\tval += abs(noise(P*freq) / freq);\n\t\tfreq *= 2.07;\n\t}\n\treturn val;\n}\n\nfloat fbm(vec2 n) {\n\tfloat total = 0.0, amplitude = 1.0;\n\tfor (int i = 0; i < 4; i++) {\n\t\ttotal += noise(n) * amplitude;\n\t\tn += n;\n\t\tamplitude *= 0.5;\n\t}\n\treturn total;\n}\n\nfloat round(float number){\n\treturn sign(number)*floor(abs(number) + 0.5);\n}\n",body:""},ShaderChunk.common_proceduralTexture_vertex={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\nconst vec2 MADD=vec2(0.5,0.5);\n",funcDeclare:"",funcDefine:"",body:"v_texCoord=a_positionVec2*MADD+MADD;\n\n    gl_Position=vec4(a_positionVec2, 0.0 ,1.0);\n"},ShaderChunk.skybox_fragment={top:"",define:"",varDeclare:"varying vec3 v_dir;\n",funcDeclare:"",funcDefine:"",body:"gl_FragColor = textureCube(u_samplerCube0, v_dir);\n"},ShaderChunk.skybox_vertex={top:"",define:"",varDeclare:"varying vec3 v_dir;\n",funcDeclare:"",funcDefine:"",body:"vec4 pos = u_pMatrix * mat4(mat3(u_vMatrix)) * mMatrix * vec4(a_position, 1.0);\n\n    gl_Position = pos.xyww;\n\n    v_dir = a_position;\n"},ShaderChunk.basic_forBasic_envMap_fragment={top:"",define:"",varDeclare:"varying vec3 v_dir;\n",funcDeclare:"",funcDefine:"",body:"totalColor *= textureCube(u_samplerCube0, v_dir);\n"},ShaderChunk.basic_forBasic_envMap_vertex={top:"",define:"",varDeclare:"varying vec3 v_dir;\n",funcDeclare:"",funcDefine:"",body:"v_dir = a_position;\n"},ShaderChunk.forBasic_envMap_fragment={top:"",define:"",varDeclare:"varying vec3 v_normal;\nvarying vec3 v_position;\n",funcDeclare:"",funcDefine:"",body:"vec3 inDir = normalize(v_position - u_cameraPos);\n"},ShaderChunk.forBasic_envMap_vertex={top:"",define:"",varDeclare:"varying vec3 v_normal;\nvarying vec3 v_position;\n",funcDeclare:"",funcDefine:"",body:"v_normal = normalize( normalMatrix * a_normal);\n    v_position = vec3(mMatrix * vec4(a_position, 1.0));\n"},ShaderChunk.fresnel_forBasic_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float computeFresnelRatio(vec3 inDir, vec3 normal, float refractionRatio){\n    float f = pow(1.0 - refractionRatio, 2.0) / pow(1.0 + refractionRatio, 2.0);\n    float fresnelPower = 5.0;\n    float ratio = f + (1.0 - f) * pow((1.0 - dot(inDir, normal)), fresnelPower);\n\n    return ratio / 100.0;\n}\nvec4 getEnvMapTotalColor(vec3 inDir, vec3 normal){\n    vec3 reflectDir = reflect(inDir, normal);\n    vec3 refractDir = refract(inDir, flipNormal(normal), u_refractionRatio);\n\n    vec4 reflectColor = textureCube(u_samplerCube0, reflectDir);\n    vec4 refractColor = textureCube(u_samplerCube0, refractDir);\n\n    vec4 totalColor = vec4(0.0);\n\n\tif(u_reflectivity != NULL){\n        totalColor = mix(reflectColor, refractColor, u_reflectivity);\n\t}\n\telse{\n        totalColor = mix(reflectColor, refractColor, computeFresnelRatio(inDir, normal, u_refractionRatio));\n\t}\n\n\treturn totalColor;\n}\n",body:"if(!isRenderListEmpty(u_isRenderListEmpty)){\n    totalColor *= getEnvMapTotalColor(inDir, normalize(v_normal));\n}\n"},ShaderChunk.reflection_forBasic_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"if(!isRenderListEmpty(u_isRenderListEmpty)){\n    totalColor *= textureCube(u_samplerCube0, reflect(inDir, normalize(v_normal)));\n}\n"},ShaderChunk.refraction_forBasic_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"if(!isRenderListEmpty(u_isRenderListEmpty)){\n    totalColor *= textureCube(u_samplerCube0, refract(inDir, v_normal, u_refractionRatio));\n}\n"},ShaderChunk.basic_forLight_envMap_fragment={top:"",define:"",varDeclare:"varying vec3 v_basicEnvMap_dir;\n",funcDeclare:"",funcDefine:"",body:"totalColor *= textureCube(u_samplerCube0, v_basicEnvMap_dir);\n"},ShaderChunk.basic_forLight_envMap_vertex={top:"",define:"",varDeclare:"varying vec3 v_basicEnvMap_dir;\n",funcDeclare:"",funcDefine:"",body:"v_basicEnvMap_dir = a_position;\n"},ShaderChunk.forLight_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"vec3 inDir = normalize(v_worldPosition - u_cameraPos);\n"},ShaderChunk.forLight_envMap_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.fresnel_forLight_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float computeFresnelRatio(vec3 inDir, vec3 normal, float refractionRatio){\n    float f = pow(1.0 - refractionRatio, 2.0) / pow(1.0 + refractionRatio, 2.0);\n    float fresnelPower = 5.0;\n    float ratio = f + (1.0 - f) * pow((1.0 - dot(inDir, normal)), fresnelPower);\n\n    return ratio / 100.0;\n}\n\nvec4 getEnvMapTotalColor(vec3 inDir, vec3 normal){\n    vec3 reflectDir = reflect(inDir, normal);\n\n/*!\n//todo why only fresnel->refraction need flip normal, but refraction don't need?\n*/\n    vec3 refractDir = refract(inDir, flipNormal(normal), u_refractionRatio);\n\n    vec4 reflectColor = textureCube(u_samplerCube0, reflectDir);\n    vec4 refractColor = textureCube(u_samplerCube0, refractDir);\n\n\n    vec4 totalColor = vec4(0.0);\n\n\tif(u_reflectivity != NULL){\n        totalColor = mix(reflectColor, refractColor, u_reflectivity);\n\t}\n\telse{\n        totalColor = mix(reflectColor, refractColor, computeFresnelRatio(inDir, normal, u_refractionRatio));\n\t}\n\n\treturn totalColor;\n}\n",body:"if(!isRenderListEmpty(u_isRenderListEmpty)){\n\ttotalColor *= getEnvMapTotalColor(inDir, normalize(getNormal()));\n}\n"},ShaderChunk.reflection_forLight_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"if(!isRenderListEmpty(u_isRenderListEmpty)){\n    totalColor *= textureCube(u_samplerCube0, reflect(inDir, normalize(getNormal())));\n}\n"},ShaderChunk.refraction_forLight_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"if(!isRenderListEmpty(u_isRenderListEmpty)){\n    totalColor *= textureCube(u_samplerCube0, refract(inDir, flipNormal(normal), u_refractionRatio));\n}\n"},ShaderChunk.modelMatrix_hardware_instance_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"mat4 mMatrix = mat4(a_mVec4_0, a_mVec4_1, a_mVec4_2, a_mVec4_3);\n"},ShaderChunk.normalMatrix_hardware_instance_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"mat3 normalMatrix = mat3(a_normalVec4_0, a_normalVec4_1, a_normalVec4_2);\n"},ShaderChunk.modelMatrix_batch_instance_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"mat4 mMatrix = u_mMatrix;\n"},ShaderChunk.normalMatrix_batch_instance_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"mat3 normalMatrix = u_normalMatrix;\n"},ShaderChunk.modelMatrix_noInstance_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"mat4 mMatrix = u_mMatrix;\n"},ShaderChunk.normalMatrix_noInstance_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"mat3 normalMatrix = u_normalMatrix;\n"},ShaderChunk.diffuseMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_diffuseMapTexCoord;\n",funcDeclare:"",funcDefine:"vec4 getMaterialDiffuse() {\n        return texture2D(u_diffuseMapSampler, v_diffuseMapTexCoord);\n    }\n",body:""},ShaderChunk.diffuseMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_diffuseMapTexCoord;\n",funcDeclare:"",funcDefine:"",body:"//todo optimize(combine, reduce compute numbers)\n    //todo BasicTexture extract textureMatrix\n    vec2 sourceTexCoord = a_texCoord * u_diffuseMapSourceRegion.zw + u_diffuseMapSourceRegion.xy;\n    v_diffuseMapTexCoord = sourceTexCoord * u_diffuseMapRepeatRegion.zw + u_diffuseMapRepeatRegion.xy;\n"},ShaderChunk.emissionMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_emissionMapTexCoord;\n",funcDeclare:"",funcDefine:"vec3 getMaterialEmission() {\n        return texture2D(u_emissionMapSampler, v_emissionMapTexCoord).rgb;\n    }\n",body:""},ShaderChunk.emissionMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_emissionMapTexCoord;\n",funcDeclare:"",funcDefine:"",body:"v_emissionMapTexCoord = a_texCoord;\n"},ShaderChunk.lightMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_lightMapTexCoord;\n",funcDeclare:"",funcDefine:"vec3 getMaterialLight() {\n        return texture2D(u_lightMapSampler, v_lightMapTexCoord).rgb * u_lightMapIntensity;\n    }\n",body:""},ShaderChunk.lightMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_lightMapTexCoord;\n",funcDeclare:"",funcDefine:"",body:"v_lightMapTexCoord = a_texCoord;\n"},ShaderChunk.noDiffuseMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec4 getMaterialDiffuse() {\n        return vec4(u_diffuse, 1.0);\n    }\n",body:""},ShaderChunk.noEmissionMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec3 getMaterialEmission() {\n        return u_emission;\n    }\n",body:""},ShaderChunk.noLightMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec3 getMaterialLight() {\n        return vec3(0.0);\n    }\n",body:""},ShaderChunk.noNormalMap_fragment={top:"",define:"",varDeclare:"//varying vec3 v_normal;\n//",funcDeclare:"vec3 getNormal();\n\n",funcDefine:"//#if POINT_LIGHTS_COUNT > 0\n//vec3 getPointLightDir(int index){\n//    //workaround '[] : Index expression must be constant' error\n//    for (int x = 0; x <= POINT_LIGHTS_COUNT; x++) {\n//        if(x == index){\n//            return getPointLightDirByLightPos(u_pointLights[x].position);\n//        }\n//    }\n//    /*!\n//    solve error in window7 chrome/firefox:\n//    not all control paths return a value.\n//    failed to create d3d shaders\n//    */\n//    return vec3(0.0);\n//}\n//#endif\n//\n//#if DIRECTION_LIGHTS_COUNT > 0\n//vec3 getDirectionLightDir(int index){\n//    //workaround '[] : Index expression must be constant' error\n//    for (int x = 0; x <= DIRECTION_LIGHTS_COUNT; x++) {\n//        if(x == index){\n//            return getDirectionLightDirByLightPos(u_directionLights[x].position);\n//        }\n//    }\n//\n//    /*!\n//    solve error in window7 chrome/firefox:\n//    not all control paths return a value.\n//    failed to create d3d shaders\n//    */\n//    return vec3(0.0);\n//}\n//#endif\n//\n//\n//vec3 getViewDir(){\n//    return normalize(u_cameraPos - v_worldPosition);\n//}\nvec3 getNormal(){\n    return v_normal;\n}\n\n",body:""},ShaderChunk.noNormalMap_vertex={top:"",define:"",varDeclare:"varying vec3 v_normal;\n",funcDeclare:"",funcDefine:"",body:"v_normal = normalize(normalMatrix * a_normal);\n"},ShaderChunk.noSpecularMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float getSpecularStrength() {\n        return 1.0;\n    }\n",body:""},ShaderChunk.normalMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_normalMapTexCoord;\nvarying vec3 v_viewDir;\n#if POINT_LIGHTS_COUNT > 0\nvarying vec3 v_pointLightDir[POINT_LIGHTS_COUNT];\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\nvarying vec3 v_directionLightDir[DIRECTION_LIGHTS_COUNT];\n#endif\n\n",funcDeclare:"vec3 getNormal();\n\nvec3 getLightDir(vec3 lightPos);\n\n",funcDefine:"#if POINT_LIGHTS_COUNT > 0\nvec3 getPointLightDir(int index){\n    //workaround '[] : Index expression must be constant' error\n    for (int x = 0; x <= POINT_LIGHTS_COUNT; x++) {\n        if(x == index){\n            return v_pointLightDir[x];\n        }\n    }\n    /*!\n    solve error in window7 chrome/firefox:\n    not all control paths return a value.\n    failed to create d3d shaders\n    */\n    return vec3(0.0);\n}\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\n\nvec3 getDirectionLightDir(int index){\n    //workaround '[] : Index expression must be constant' error\n    for (int x = 0; x <= DIRECTION_LIGHTS_COUNT; x++) {\n        if(x == index){\n            return v_directionLightDir[x];\n        }\n    }\n\n    /*!\n    solve error in window7 chrome/firefox:\n    not all control paths return a value.\n    failed to create d3d shaders\n    */\n    return vec3(0.0);\n}\n#endif\n\n\nvec3 getViewDir(){\n    return v_viewDir;\n}\nvec3 getNormal(){\n        // Obtain normal from normal map in range [0,1]\n        vec3 normal = texture2D(u_normalMapSampler, v_normalMapTexCoord).rgb;\n\n        // Transform normal vector to range [-1,1]\n        return normalize(normal * 2.0 - 1.0);  // this normal is in tangent space\n}\n",body:""},ShaderChunk.normalMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_normalMapTexCoord;\n\tvarying vec3 v_viewDir;\n\n\n#if POINT_LIGHTS_COUNT > 0\nvarying vec3 v_pointLightDir[POINT_LIGHTS_COUNT];\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\nvarying vec3 v_directionLightDir[DIRECTION_LIGHTS_COUNT];\n#endif\n\n",funcDeclare:"",funcDefine:"mat3 computeTBN(mat3 normalMatrix){\n            vec3 T = normalize(normalMatrix * a_tangent);\n            vec3 N = normalize(normalMatrix * a_normal);\n            // re-orthogonalize T with respect to N\n            T = normalize(T - dot(T, N) * N);\n            // then retrieve perpendicular vector B with the cross product of T and N\n            vec3 B = cross(T, N);\n\n\n            return transpose(mat3(T, B, N));\n        }\n",body:"mat3 TBN = computeTBN(normalMatrix);\n\n    //v_tangentLightPos = TBN * light.position;\n    //v_tangentCameraPos  = TBN * u_cameraPos;\n    //v_tangentPos  = TBN * v_position;\n\n\n    vec3 tangentPosition = TBN * vec3(mMatrix * vec4(a_position, 1.0));\n\n    v_normalMapTexCoord = a_texCoord;\n\n    v_viewDir = normalize(TBN * u_cameraPos - tangentPosition);\n\n\n#if POINT_LIGHTS_COUNT > 0\n       for(int i = 0; i < POINT_LIGHTS_COUNT; i++){\n            //not normalize for computing distance\n            v_pointLightDir[i] = TBN * getPointLightDirByLightPos(u_pointLights[i].position, tangentPosition);\n       }\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\n       for(int i = 0; i < DIRECTION_LIGHTS_COUNT; i++){\n            v_directionLightDir[i] = normalize(- TBN * getDirectionLightDirByLightPos(u_directionLights[i].position));\n       }\n#endif\n\n"},ShaderChunk.specularMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_specularMapTexCoord;\n",funcDeclare:"",funcDefine:"float getSpecularStrength() {\n        return texture2D(u_specularMapSampler, v_specularMapTexCoord).r;\n    }\n",body:""},ShaderChunk.specularMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_specularMapTexCoord;\n",funcDeclare:"",funcDefine:"",body:"v_specularMapTexCoord = a_texCoord;\n"},ShaderChunk.noShadowMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec3 getShadowVisibility() {\n        return vec3(1.0);\n    }\n",body:""},ShaderChunk.common_heightMap={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float _getHeightFromHeightMap(vec2 heightMapSampleTexCoord){\nheightMapSampleTexCoord.x /= u_terrainSubdivisions;\nheightMapSampleTexCoord.y =  1.0 - heightMapSampleTexCoord.y / u_terrainSubdivisions;\n\n    vec4 data = texture2D(u_heightMapSampler, heightMapSampleTexCoord);\n    /*!\n     compute gradient from rgb heightMap->r,g,b components\n     */\n    float r = data.r,\n    g = data.g,\n    b = data.b,\n    gradient = r * 0.3 + g * 0.59 + b * 0.11;\n\n    return u_terrainMinHeight + (u_terrainMaxHeight - u_terrainMinHeight) * gradient;\n}\n\n\nfloat _getBilinearInterpolatedHeight(vec2 offset, float heightMinXMinZ, float heightMaxXMinZ, float heightMaxXMaxZ, float heightMinXMaxZ){\n    return (heightMinXMinZ * (1.0 - offset.x) + heightMaxXMinZ * offset.x) * (1.0 - offset.y) + (heightMaxXMaxZ * offset.x + heightMinXMaxZ * (1.0 - offset.x)) * offset.y;\n}\n\n\nfloat getHeightFromHeightMap(float x, float z){\n    x += u_terrainRangeWidth / 2.0;\n    z += u_terrainRangeHeight / 2.0;\n\n    if(x > u_terrainRangeWidth || z > u_terrainRangeHeight || x < 0.0 || z < 0.0){\n        return 0.0;\n    }\n\n\n\n/*!\n1.get grid subdivisions row,col\n2.get grid height\n3.get bilinear interpolated height\n*/\n\n\n\n    float sx = x / u_terrainRangeWidth * u_terrainSubdivisions,\n        sz = z / u_terrainRangeHeight * u_terrainSubdivisions;\n\n    float sFloorX = floor(sx),\n        sFloorZ = floor(sz);\n\n    float sMinX,\n    sMaxX,\n    sMinZ,\n    sMaxZ;\n\n    if(sFloorX < u_terrainSubdivisions){\n        sMinX = sFloorX;\n        sMaxX = sFloorX + 1.0;\n    }\n    else{\n        sMinX = sFloorX - 1.0;\n        sMaxX = sFloorX;\n    }\n\n    if(sFloorZ < u_terrainSubdivisions){\n        sMinZ = sFloorZ;\n        sMaxZ = sFloorZ + 1.0;\n    }\n    else{\n        sMinZ = sFloorZ - 1.0;\n        sMaxZ = sFloorZ;\n    }\n\n    vec2 quadSubdivisionsCoordinateArr[5];\n\n    quadSubdivisionsCoordinateArr[0] = vec2(sMinX, sMinZ);\n    quadSubdivisionsCoordinateArr[1] = vec2(sMaxX, sMinZ);\n    quadSubdivisionsCoordinateArr[2] = vec2(sMaxX, sMaxZ);\n    quadSubdivisionsCoordinateArr[3] = vec2(sMinX, sMaxZ);\n\n    quadSubdivisionsCoordinateArr[4] = vec2(sx - sMinX, sz - sMinZ);\n\n\n    float heightMinXMinZ = _getHeightFromHeightMap(quadSubdivisionsCoordinateArr[0]);\n    float heightMaxXMinZ = _getHeightFromHeightMap(quadSubdivisionsCoordinateArr[1]);\n    float heightMaxXMaxZ = _getHeightFromHeightMap(quadSubdivisionsCoordinateArr[2]);\n    float heightMinXMaxZ = _getHeightFromHeightMap(quadSubdivisionsCoordinateArr[3]);\n\n    return _getBilinearInterpolatedHeight(quadSubdivisionsCoordinateArr[4], heightMinXMinZ, heightMaxXMinZ, heightMaxXMaxZ, heightMinXMaxZ);\n}\n",
body:""},ShaderChunk.common_light={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec3 getDirectionLightDir(vec3 lightPos){\n    return normalize(lightPos - vec3(0.0));\n}\n",body:""},ShaderChunk}();e.ShaderChunk=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ShaderSnippet(){}return ShaderSnippet.main_begin="void main(void){\n",ShaderSnippet.main_end="}\n",ShaderSnippet.setPos_mvp="gl_Position = u_pMatrix * u_vMatrix * mMatrix * vec4(a_position, 1.0);\n",ShaderSnippet}();e.ShaderSnippet=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Material(){this._blendType=null,this._blendSrc=e.EBlendFunc.ONE,this._blendDst=e.EBlendFunc.ZERO,this._blendEquation=e.EBlendEquation.ADD,this._alphaToCoverage=!1,this._color=e.Color.create("#ffffff"),this.redWrite=!0,this.greenWrite=!0,this.blueWrite=!0,this.alphaWrite=!0,this.polygonOffsetMode=e.EPolygonOffsetMode.NONE,this.side=e.ESide.FRONT,this.blend=!1,this.blendFuncSeparate=null,this.blendEquationSeparate=[e.EBlendEquation.ADD,e.EBlendEquation.ADD],this.shading=e.EShading.FLAT,this.geometry=null,this._shaderManager=e.ShaderManager.create(this)}return Object.defineProperty(Material.prototype,"program",{get:function(){return this.shader.program},enumerable:!0,configurable:!0}),Object.defineProperty(Material.prototype,"blendType",{get:function(){return this._blendType},set:function(t){if(null!==t){switch(t){case e.EBlendType.NONE:this.blend=!1,this.blendSrc=e.EBlendFunc.ONE,this.blendDst=e.EBlendFunc.ZERO,this.blendEquation=e.EBlendEquation.ADD;break;case e.EBlendType.NORMAL:this.blend=!0,this.blendSrc=e.EBlendFunc.SRC_ALPHA,this.blendDst=e.EBlendFunc.ONE_MINUS_SRC_ALPHA,this.blendEquation=e.EBlendEquation.ADD;break;case e.EBlendType.PREMULTIPLIED:this.blend=!0,this.blendSrc=e.EBlendFunc.ONE,this.blendDst=e.EBlendFunc.ONE_MINUS_SRC_ALPHA,this.blendEquation=e.EBlendEquation.ADD;break;case e.EBlendType.ADDITIVE:this.blend=!0,this.blendSrc=e.EBlendFunc.ONE,this.blendDst=e.EBlendFunc.ONE,this.blendEquation=e.EBlendEquation.ADD;break;case e.EBlendType.ADDITIVEALPHA:this.blend=!0,this.blendSrc=e.EBlendFunc.SRC_ALPHA,this.blendDst=e.EBlendFunc.ONE,this.blendEquation=e.EBlendEquation.ADD;break;case e.EBlendType.MULTIPLICATIVE:this.blend=!0,this.blendSrc=e.EBlendFunc.DST_COLOR,this.blendDst=e.EBlendFunc.ZERO,this.blendEquation=e.EBlendEquation.ADD;break;default:e.Log.error(!0,e.Log.info.FUNC_INVALID("blendType"))}this._blendType=t}},enumerable:!0,configurable:!0}),Object.defineProperty(Material.prototype,"envMap",{get:function(){return this.mapManager.getEnvMap()},set:function(e){this.mapManager.setEnvMap(e)},enumerable:!0,configurable:!0}),Object.defineProperty(Material.prototype,"blendSrc",{get:function(){return this._blendSrc},set:function(e){this._blendSrc!==e&&(this._blendSrc=e,this.blendFuncSeparate=null)},enumerable:!0,configurable:!0}),Object.defineProperty(Material.prototype,"blendDst",{get:function(){return this._blendDst},set:function(e){this._blendDst!==e&&(this._blendDst=e,this.blendFuncSeparate=null)},enumerable:!0,configurable:!0}),Object.defineProperty(Material.prototype,"blendEquation",{get:function(){return this._blendEquation},set:function(e){this._blendEquation!==e&&(this._blendEquation=e,this.blendEquationSeparate=null)},enumerable:!0,configurable:!0}),Object.defineProperty(Material.prototype,"alphaToCoverage",{get:function(){return this._alphaToCoverage},set:function(e){this._alphaToCoverage=e},enumerable:!0,configurable:!0}),Object.defineProperty(Material.prototype,"color",{get:function(){return this._color},set:function(t){this._color.isEqual(t)||(this.geometry&&this.geometry.entityObject&&e.EventManager.trigger(this.geometry.entityObject,e.CustomEvent.create(e.EEngineEvent.MATERIAL_COLOR_CHANGE)),this._color=t)},enumerable:!0,configurable:!0}),Object.defineProperty(Material.prototype,"mapManager",{get:function(){return this._shaderManager.mapManager},enumerable:!0,configurable:!0}),Object.defineProperty(Material.prototype,"shader",{get:function(){return this._shaderManager.shader},enumerable:!0,configurable:!0}),Material.prototype.clone=function(){return e.CloneUtils.clone(this)},Material.prototype.initWhenCreate=function(){this._shaderManager.setShader(this.createShader())},Material.prototype.init=function(){this._shaderManager.init()},Material.prototype.dispose=function(){this._shaderManager.dispose()},Material.prototype.updateShader=function(e){this._shaderManager.update(e)},Material.prototype.addShader=function(e,t){this._shaderManager.addShader(e,t)},Material.prototype.hasShader=function(e){return this._shaderManager.hasShader(e)},Material.prototype.getShader=function(e){return this._shaderManager.getShader(e)},Material.prototype.hasMap=function(e){return this.mapManager.hasMap(e)},__decorate([e.cloneAttributeAsBasicType({order:1})],Material.prototype,"blendType",null),__decorate([e.cloneAttributeAsCloneable()],Material.prototype,"envMap",null),__decorate([e.cloneAttributeAsBasicType()],Material.prototype,"blendSrc",null),__decorate([e.cloneAttributeAsBasicType()],Material.prototype,"blendDst",null),__decorate([e.cloneAttributeAsBasicType()],Material.prototype,"blendEquation",null),__decorate([e.cloneAttributeAsBasicType(),e.ensureGetter(function(t){e.it("if enable alphaToCoverage, multiSample should be enabled",function(){t&&e.expect(e.DeviceManager.getInstance().contextConfig.options.antialias)["true"]})})],Material.prototype,"alphaToCoverage",null),__decorate([e.cloneAttributeAsCloneable()],Material.prototype,"color",null),__decorate([e.cloneAttributeAsBasicType()],Material.prototype,"redWrite",void 0),__decorate([e.cloneAttributeAsBasicType()],Material.prototype,"greenWrite",void 0),__decorate([e.cloneAttributeAsBasicType()],Material.prototype,"blueWrite",void 0),__decorate([e.cloneAttributeAsBasicType()],Material.prototype,"alphaWrite",void 0),__decorate([e.cloneAttributeAsBasicType()],Material.prototype,"polygonOffsetMode",void 0),__decorate([e.cloneAttributeAsBasicType()],Material.prototype,"side",void 0),__decorate([e.cloneAttributeAsBasicType()],Material.prototype,"blend",void 0),__decorate([e.cloneAttributeAsBasicType({order:-1})],Material.prototype,"blendFuncSeparate",void 0),__decorate([e.cloneAttributeAsBasicType()],Material.prototype,"blendEquationSeparate",void 0),__decorate([e.cloneAttributeAsBasicType()],Material.prototype,"shading",void 0),__decorate([e.cloneAttributeAsBasicType()],Material.prototype,"geometry",void 0),Material}();e.Material=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function EngineMaterial(){t.apply(this,arguments),this.refractionRatio=0,this.reflectivity=null,this.mapCombineMode=e.ETextureCombineMode.MIX,this.mapMixRatio=.5}return __extends(EngineMaterial,t),EngineMaterial.prototype.init=function(){this._addTopShaderLib(),this.addShaderLib(),this._addEndShaderLib(),t.prototype.init.call(this)},EngineMaterial.prototype.addShaderLib=function(){},EngineMaterial.prototype.addNormalShaderLib=function(){var t=e.ClassUtils.getClass("NormalMorphShaderLib");e.GlobalGeometryUtils.hasMorphAnimation(this.geometry)&&void 0!==t&&!this.shader.hasLib(t)?this._addShaderLibToTop(t.create()):this.shader.hasLib(e.NormalCommonShaderLib)||this._addShaderLibToTop(e.NormalCommonShaderLib.create())},EngineMaterial.prototype.createShader=function(){return e.CommonShader.create()},EngineMaterial.prototype._addTopShaderLib=function(){this.shader.addLib(e.CommonShaderLib.create()),e.InstanceUtils.addModelMatrixShaderLib(this.shader,this.geometry.entityObject),e.ShaderLibUtils.addVerticeShaderLib(this.geometry,this.shader)},EngineMaterial.prototype._addShaderLibToTop=function(e){this.shader.addShaderLibToTop(e)},EngineMaterial.prototype._addEndShaderLib=function(){this.shader.addLib(e.EndShaderLib.create())},__decorate([e.cloneAttributeAsBasicType()],EngineMaterial.prototype,"refractionRatio",void 0),__decorate([e.cloneAttributeAsBasicType()],EngineMaterial.prototype,"reflectivity",void 0),__decorate([e.cloneAttributeAsBasicType()],EngineMaterial.prototype,"mapCombineMode",void 0),__decorate([e.cloneAttributeAsBasicType()],EngineMaterial.prototype,"mapMixRatio",void 0),__decorate([e.virtual],EngineMaterial.prototype,"addShaderLib",null),EngineMaterial}(e.Material);e.EngineMaterial=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function StandardLightMaterial(){t.apply(this,arguments),this._lightMap=null,this._diffuseMap=null,this._specularMap=null,this._emissionMap=null,this._normalMap=null,this._shininess=32,this.opacity=1,this.lightModel=e.ELightModel.PHONG,this.specularColor=e.Color.create("#ffffff"),this.emissionColor=e.Color.create("rgba(0,0,0,0)"),this.lightMapIntensity=1,this.alphaTest=null}return __extends(StandardLightMaterial,t),Object.defineProperty(StandardLightMaterial.prototype,"lightMap",{get:function(){return this._lightMap},set:function(e){this._lightMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(StandardLightMaterial.prototype,"diffuseMap",{get:function(){return this._diffuseMap},set:function(e){this._diffuseMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(StandardLightMaterial.prototype,"specularMap",{get:function(){return this._specularMap},set:function(e){this._specularMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(StandardLightMaterial.prototype,"emissionMap",{get:function(){return this._emissionMap},set:function(e){this._emissionMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(StandardLightMaterial.prototype,"normalMap",{get:function(){return this._normalMap},set:function(e){this._normalMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(StandardLightMaterial.prototype,"shininess",{get:function(){return Number(this._shininess)<=0?32:this._shininess},set:function(e){this._shininess=e},enumerable:!0,configurable:!0}),StandardLightMaterial.prototype.init=function(){this._addMap(),t.prototype.init.call(this)},StandardLightMaterial.prototype.addTopExtendShaderLib=function(){},StandardLightMaterial.prototype.addExtendShaderLib=function(){},StandardLightMaterial.prototype.addEndShaderLib=function(){},StandardLightMaterial.prototype.addNormalRelatedShaderLib=function(){this._normalMap?this.shader.addLib(e.NormalMapShaderLib.create()):this.shader.addLib(e.NoNormalMapShaderLib.create())},StandardLightMaterial.prototype.addLightSetWorldPositionShaderLib=function(){this.shader.addLib(e.LightSetWorldPositionShaderLib.create())},StandardLightMaterial.prototype.addShaderLib=function(){var t=null;this.addTopExtendShaderLib(),e.InstanceUtils.addNormalModelMatrixShaderLib(this.shader,this.geometry.entityObject),this.addNormalShaderLib(),this.shader.addLib(e.LightCommonShaderLib.create()),this.addLightSetWorldPositionShaderLib(),this._setLightMapShaderLib(),this.shader.addLib(e.LightShaderLib.create()),t=this.envMap,t&&this._setEnvMapShaderLib(t),this.addExtendShaderLib(),this.shader.addLib(e.LightEndShaderLib.create()),this.addEndShaderLib()},StandardLightMaterial.prototype._setLightMapShaderLib=function(){var t=e.Director.getInstance().scene;if(this.shader.addLib(e.CommonLightMapShaderLib.create()),this._lightMap?this.shader.addLib(e.LightMapShaderLib.create()):this.shader.addLib(e.NoLightMapShaderLib.create()),this._diffuseMap?this.shader.addLib(e.DiffuseMapShaderLib.create()):this.shader.addLib(e.NoDiffuseMapShaderLib.create()),this._specularMap?this.shader.addLib(e.SpecularMapShaderLib.create()):this.shader.addLib(e.NoSpecularMapShaderLib.create()),this._emissionMap?this.shader.addLib(e.EmissionMapShaderLib.create()):this.shader.addLib(e.NoEmissionMapShaderLib.create()),this.addNormalRelatedShaderLib(),t.shadowMap.enable){var r=!1,n=!1;this._hasTwoDShadowMap()&&(r=!0,this.shader.addLib(e.ClassUtils.getClass("TwoDShadowMapShaderLib").create())),this._hasCubemapShadowMap()&&(n=!0,this.shader.addLib(e.ClassUtils.getClass("CubemapShadowMapShaderLib").create())),r||n?this.shader.addLib(e.ClassUtils.getClass("TotalShadowMapShaderLib").create()):this.shader.addLib(e.NoShadowMapShaderLib.create())}else this.shader.addLib(e.NoShadowMapShaderLib.create())},StandardLightMaterial.prototype._setEnvMapShaderLib=function(t){switch(this.shader.addLib(e.CommonEnvMapShaderLib.create()),t.mode){case e.EEnvMapMode.BASIC:this.shader.addLib(e.BasicForLightEnvMapShaderLib.create());break;case e.EEnvMapMode.REFLECTION:this.shader.addLib(e.ReflectionForLightEnvMapShaderLib.create());break;case e.EEnvMapMode.REFRACTION:this.shader.addLib(e.RefractionForLightEnvMapShaderLib.create());break;case e.EEnvMapMode.FRESNEL:this.shader.addLib(e.FresnelForLightEnvMapShaderLib.create());break;default:e.Log.error(!0,e.Log.info.FUNC_INVALID("EEnvMapMode"))}},StandardLightMaterial.prototype._hasTwoDShadowMap=function(){var t=e.ClassUtils.getClass("ShadowUtils");return void 0!==t&&(t.isReceive(this.geometry.entityObject)&&this.mapManager.getTwoDShadowMapList().getCount()>0)},StandardLightMaterial.prototype._hasCubemapShadowMap=function(){var t=e.ClassUtils.getClass("ShadowUtils");return void 0!==t&&(t.isReceive(this.geometry.entityObject)&&this.mapManager.getCubemapShadowMapList().getCount()>0)},StandardLightMaterial.prototype._addMap=function(){null!==this._lightMap&&this.mapManager.addMap(this._lightMap,{samplerVariableName:e.VariableNameTable.getVariableName("lightMap")}),null!==this._diffuseMap&&this.mapManager.addMap(this._diffuseMap,{samplerVariableName:e.VariableNameTable.getVariableName("diffuseMap")}),null!==this._specularMap&&this.mapManager.addMap(this._specularMap,{samplerVariableName:e.VariableNameTable.getVariableName("specularMap")}),null!==this._emissionMap&&this.mapManager.addMap(this._emissionMap,{samplerVariableName:e.VariableNameTable.getVariableName("emissionMap")}),null!==this._normalMap&&this.mapManager.addMap(this._normalMap,{samplerVariableName:e.VariableNameTable.getVariableName("normalMap")})},__decorate([e.requireSetter(function(t){e.assert(t instanceof e.ImageTexture||t instanceof e.ProceduralTexture,e.Log.info.FUNC_SHOULD("lightMap","be ImageTexture or ProceduralTexture"))}),e.cloneAttributeAsCloneable()],StandardLightMaterial.prototype,"lightMap",null),__decorate([e.requireSetter(function(t){e.assert(t instanceof e.ImageTexture||t instanceof e.ProceduralTexture,e.Log.info.FUNC_SHOULD("diffuseMap","be ImageTexture or ProceduralTexture"))}),e.cloneAttributeAsCloneable()],StandardLightMaterial.prototype,"diffuseMap",null),__decorate([e.requireSetter(function(t){e.assert(t instanceof e.ImageTexture||t instanceof e.ProceduralTexture,e.Log.info.FUNC_SHOULD("specularMap","be ImageTexture or ProceduralTexture"))}),e.cloneAttributeAsCloneable()],StandardLightMaterial.prototype,"specularMap",null),__decorate([e.requireSetter(function(t){e.assert(t instanceof e.ImageTexture||t instanceof e.ProceduralTexture,e.Log.info.FUNC_SHOULD("emissionMap","be ImageTexture or ProceduralTexture"))}),e.cloneAttributeAsCloneable()],StandardLightMaterial.prototype,"emissionMap",null),__decorate([e.requireSetter(function(t){e.assert(t instanceof e.ImageTexture,e.Log.info.FUNC_SHOULD("normalMap","be ImageTexture"))}),e.cloneAttributeAsCloneable()],StandardLightMaterial.prototype,"normalMap",null),__decorate([e.cloneAttributeAsBasicType()],StandardLightMaterial.prototype,"shininess",null),__decorate([e.cloneAttributeAsBasicType()],StandardLightMaterial.prototype,"opacity",void 0),__decorate([e.cloneAttributeAsBasicType()],StandardLightMaterial.prototype,"lightModel",void 0),__decorate([e.cloneAttributeAsCloneable()],StandardLightMaterial.prototype,"specularColor",void 0),__decorate([e.cloneAttributeAsCloneable()],StandardLightMaterial.prototype,"emissionColor",void 0),__decorate([e.cloneAttributeAsBasicType()],StandardLightMaterial.prototype,"lightMapIntensity",void 0),__decorate([e.cloneAttributeAsBasicType()],StandardLightMaterial.prototype,"alphaTest",void 0),__decorate([e.virtual],StandardLightMaterial.prototype,"addTopExtendShaderLib",null),__decorate([e.virtual],StandardLightMaterial.prototype,"addExtendShaderLib",null),__decorate([e.virtual],StandardLightMaterial.prototype,"addEndShaderLib",null),__decorate([e.virtual],StandardLightMaterial.prototype,"addNormalRelatedShaderLib",null),__decorate([e.virtual],StandardLightMaterial.prototype,"addLightSetWorldPositionShaderLib",null),StandardLightMaterial}(e.EngineMaterial);e.StandardLightMaterial=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function StandardBasicMaterial(){t.apply(this,arguments),this._map=null,this.opacity=1,this.alphaTest=null}return __extends(StandardBasicMaterial,t),Object.defineProperty(StandardBasicMaterial.prototype,"mapList",{get:function(){return this.mapManager.getMapList()},enumerable:!0,configurable:!0}),Object.defineProperty(StandardBasicMaterial.prototype,"map",{get:function(){return this.mapList.getChild(0)},set:function(e){this._map=e,this._addMap()},enumerable:!0,configurable:!0}),StandardBasicMaterial.prototype.addExtendShaderLib=function(){},StandardBasicMaterial.prototype.addShaderLib=function(){var t=null;this.geometry.hasColors()?this.shader.addLib(e.BasicVertexColorShaderLib.create()):this.shader.addLib(e.BasicMaterialColorShaderLib.create()),this.shader.addLib(e.BasicShaderLib.create()),this._setMapShaderLib(),t=this.envMap,t&&(e.InstanceUtils.addNormalModelMatrixShaderLib(this.shader,this.geometry.entityObject),this._setEnvMapShaderLib(t)),this.addExtendShaderLib(),this.shader.addLib(e.EndBasicShaderLib.create())},StandardBasicMaterial.prototype._setMapShaderLib=function(){var t=this.mapManager,r=t.getMapCount();r>0&&(r>1?this.shader.addLib(e.MultiMapShaderLib.create()):this.shader.addLib(e.BasicMapShaderLib.create()))},StandardBasicMaterial.prototype._setEnvMapShaderLib=function(t){switch(this.addNormalShaderLib(),this.shader.addLib(e.CommonEnvMapShaderLib.create()),t.mode){case e.EEnvMapMode.BASIC:this.shader.addLib(e.BasicForBasicEnvMapShaderLib.create());break;case e.EEnvMapMode.REFLECTION:this.shader.addLib(e.ReflectionForBasicEnvMapShaderLib.create());break;case e.EEnvMapMode.REFRACTION:this.shader.addLib(e.RefractionForBasicEnvMapShaderLib.create());break;case e.EEnvMapMode.FRESNEL:this.shader.addLib(e.FresnelForBasicEnvMapShaderLib.create());break;default:e.Log.error(!0,e.Log.info.FUNC_INVALID("EEnvMapMode"))}},StandardBasicMaterial.prototype._addMap=function(){var t=this._map;if(null!==t)if(t instanceof e.Texture||t instanceof e.TextureAsset)this.mapManager.addMap(t);else for(var r=0,n=t;r<n.length;r++){var i=n[r];this.mapManager.addMap(i)}},__decorate([e.ensureGetter(function(t){e.assert(t.getCount()<=2,wdCb.Log.info.FUNC_SUPPORT("only","map.count <= 2"))}),e.cloneAttributeAsCustomType(function(e,t,r){e[r].forEach(function(e){t.mapManager.addMap(e.clone())})})],StandardBasicMaterial.prototype,"mapList",null),__decorate([e.requireSetter(function(t){if(t instanceof e.Texture||t instanceof e.TextureAsset);else{var r=t;e.it("map should be array",function(){e.expect(r).be.a("array")}),e.it("map.count should < 3",function(){e.expect(r.length).lessThan(3)})}})],StandardBasicMaterial.prototype,"map",null),__decorate([e.cloneAttributeAsBasicType()],StandardBasicMaterial.prototype,"opacity",void 0),__decorate([e.cloneAttributeAsBasicType()],StandardBasicMaterial.prototype,"alphaTest",void 0),__decorate([e.virtual],StandardBasicMaterial.prototype,"addExtendShaderLib",null),StandardBasicMaterial}(e.EngineMaterial);e.StandardBasicMaterial=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function LineMaterial(){t.apply(this,arguments),this._lineWidth=1}return __extends(LineMaterial,t),LineMaterial.create=function(){var e=new this;return e.initWhenCreate(),e},Object.defineProperty(LineMaterial.prototype,"lineWidth",{get:function(){return this._lineWidth},set:function(e){this._lineWidth=e},enumerable:!0,configurable:!0}),LineMaterial.prototype.getTextureForRenderSort=function(){return this.mapList.getChild(0)},__decorate([e.cloneAttributeAsBasicType(),e.requireSetter(function(t){e.it("lineWidth should <= 1",function(){e.expect(t).not.to.greaterThan(1)})}),e.ensureGetter(function(t){e.it("lineWidth should <= 1",function(){e.expect(t).not.to.greaterThan(1)})})],LineMaterial.prototype,"lineWidth",null),LineMaterial}(e.StandardBasicMaterial);e.LineMaterial=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BasicMaterial(){e.apply(this,arguments)}return __extends(BasicMaterial,e),BasicMaterial.create=function(){var e=new this;return e.initWhenCreate(),e},BasicMaterial.prototype.getTextureForRenderSort=function(){return this.mapList.getChild(0)},BasicMaterial}(e.StandardBasicMaterial);e.BasicMaterial=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function SkyboxMaterial(){t.apply(this,arguments)}return __extends(SkyboxMaterial,t),SkyboxMaterial.create=function(){var e=new this;return e.initWhenCreate(),e},SkyboxMaterial.prototype.initWhenCreate=function(){t.prototype.initWhenCreate.call(this),this.side=e.ESide.BACK},SkyboxMaterial.prototype.getTextureForRenderSort=function(){return null},SkyboxMaterial.prototype.addShaderLib=function(){this.shader.addLib(e.SkyboxShaderLib.create())},SkyboxMaterial}(e.EngineMaterial);e.SkyboxMaterial=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function LightMaterial(){e.apply(this,arguments)}return __extends(LightMaterial,e),LightMaterial.create=function(){var e=new this;return e.initWhenCreate(),e},LightMaterial.prototype.getTextureForRenderSort=function(){return this.diffuseMap},LightMaterial}(e.StandardLightMaterial);e.LightMaterial=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ShaderMaterial(){t.apply(this,arguments),this.definitionData=null}return __extends(ShaderMaterial,t),ShaderMaterial.create=function(){var e=new this;return e.initWhenCreate(),e},ShaderMaterial.prototype.init=function(){var r=this;this.shader.read(this.definitionData),this.shader.getSampler2DUniformsAfterRead().forEach(function(t,n){r.mapManager.addMap(e.LoaderManager.getInstance().get(t.textureId),{samplerVariableName:n})}),this.shader.addLib(e.CustomShaderLib.create()),this.shader.addLib(e.EndShaderLib.create()),t.prototype.init.call(this)},ShaderMaterial.prototype.getTextureForRenderSort=function(){return null},ShaderMaterial.prototype.read=function(t){this.definitionData=e.LoaderManager.getInstance().get(t)},ShaderMaterial.prototype.createShader=function(){return e.CustomShader.create()},__decorate([e.cloneAttributeAsBasicType()],ShaderMaterial.prototype,"definitionData",void 0),__decorate([e.ensure(function(){var t=this;e.it("should only has CustomShaderLib and EndShaderLib, not has other shader libs",function(){e.expect(2===t.shader.getLibs().getCount()&&t.shader.hasLib(e.CustomShaderLib))["true"]})})],ShaderMaterial.prototype,"init",null),ShaderMaterial}(e.Material);e.ShaderMaterial=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.FLAT=0]="FLAT",e[e.SMOOTH=1]="SMOOTH"}(e.EShading||(e.EShading={}));e.EShading}(wd||(wd={}));var wd;!function(e){var t=function(){function ShaderManager(e){this._material=null,this._otherShaderMap=wdCb.Hash.create(),this._mainShader=null,this._material=e}return ShaderManager.create=function(e){var t=new this(e);return t},Object.defineProperty(ShaderManager.prototype,"shader",{get:function(){var t=e.Director.getInstance().scene;return t.isUseShader?this._otherShaderMap.getChild(t.currentShaderType):this._mainShader},enumerable:!0,configurable:!0}),Object.defineProperty(ShaderManager.prototype,"mapManager",{get:function(){return this.shader.mapManager},enumerable:!0,configurable:!0}),ShaderManager.prototype.setShader=function(e){this._mainShader=e,this._mainShader.mapManager.material=this._material},ShaderManager.prototype.init=function(){var e=this._material;this._otherShaderMap.forEach(function(t){t.init(e)}),this._mainShader.init(e)},ShaderManager.prototype.dispose=function(){this._otherShaderMap.forEach(function(e){e.dispose()}),this._mainShader.dispose()},ShaderManager.prototype.update=function(e){this.shader.update(e,this._material)},ShaderManager.prototype.addShader=function(e,t){this._otherShaderMap.addChild(e,t)},ShaderManager.prototype.hasShader=function(e){return this._otherShaderMap.hasChild(e)},ShaderManager.prototype.getShader=function(e){return this._otherShaderMap.getChild(e)},__decorate([e.ensureGetter(function(t){e.assert(!!t,e.Log.info.FUNC_NOT_EXIST("shader"))})],ShaderManager.prototype,"shader",null),ShaderManager}();e.ShaderManager=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.UNKNOW=0]="UNKNOW",e[e.FONT=1]="FONT",e[e.SCRIPT=2]="SCRIPT"}(e.EAssetType||(e.EAssetType={}));e.EAssetType}(wd||(wd={}));var wd;!function(e){var t=function(){function Loader(){this._container=wdCb.Hash.create()}return Loader.prototype.load=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=t[0],i=null,o=null,a=this,s=null,c=null;return i=t[1],o=t[2],s=this._container.getChild(i),c=s?wdFrp.just(s):this.loadAsset(n,i,o)["do"](function(t){a._container.addChild(i,t),e.LoaderManager.getInstance().add(i,a)},function(e){a._errorHandle(n,e)},null)},Loader.prototype.get=function(e){return this._container.getChild(e)},Loader.prototype.has=function(e){return this._container.hasChild(e)},Loader.prototype.dispose=function(){this._container.removeAllChildren()},Loader.prototype._errorHandle=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=null;n=e.JudgeUtils.isArrayExactly(t[0])?t[0].join(","):t[0],i=t[1],e.Log.log("load "+n+" asset fail:"+i)},Loader}();e.Loader=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function GLSLLoader(){t.call(this)}return __extends(GLSLLoader,t),GLSLLoader.getInstance=function(){},GLSLLoader.prototype.loadAsset=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=t[0];return e.AjaxLoader.load(n,"text")},__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];e.assert(!e.JudgeUtils.isArrayExactly(t[0]),e.Log.info.FUNC_MUST_BE("url","string"))})],GLSLLoader.prototype,"loadAsset",null),GLSLLoader=__decorate([e.singleton()],GLSLLoader)}(e.Loader);e.GLSLLoader=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function JsLoader(){t.call(this)}return __extends(JsLoader,t),JsLoader.getInstance=function(){},JsLoader.prototype.loadAsset=function(){for(var t=this,r=[],n=0;n<arguments.length;n++)r[n-0]=arguments[n];var i=this,o=r[0];return wdFrp.fromPromise(new e.RSVP.Promise(function(e,r){var n=i._createScript();n.async=!1,n.addEventListener("error",function(e){r("load js file error. url:"+o)}),n.readyState?n.onreadystatechange=function(){"loaded"!==n.readyState&&"complete"!==n.readyState||(n.onreadystatechange=null,e(o))}:n.onload=function(){e(o)},n.src=o,t._appendScript(n)}))},JsLoader.prototype._createScript=function(){var e=document.createElement("script");return e.type="text/javascript",e},JsLoader.prototype._appendScript=function(e){document.getElementsByTagName("head")[0].appendChild(e)},__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];e.assert(!e.JudgeUtils.isArrayExactly(t[0]),e.Log.info.FUNC_MUST_BE("url","string"))})],JsLoader.prototype,"loadAsset",null),JsLoader=__decorate([e.singleton()],JsLoader)}(e.Loader);e.JsLoader=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ScriptLoader(){t.call(this)}return __extends(ScriptLoader,t),ScriptLoader.getInstance=function(){},ScriptLoader.prototype.loadAsset=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=t[0],i=t[1];return e.JsLoader.getInstance().load(n,i).map(function(){return e.Script.scriptList.pop()})},__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];e.assert(!e.JudgeUtils.isArrayExactly(t[0]),e.Log.info.FUNC_MUST_BE("url","string"))})],ScriptLoader.prototype,"loadAsset",null),ScriptLoader=__decorate([e.singleton()],ScriptLoader)}(e.Loader);e.ScriptLoader=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function JSONLoader(){t.call(this)}return __extends(JSONLoader,t),JSONLoader.getInstance=function(){},JSONLoader.prototype.loadAsset=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=t[0];return e.AjaxLoader.load(n,"json")},__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];e.assert(!e.JudgeUtils.isArrayExactly(t[0]),e.Log.info.FUNC_MUST_BE("url","string"))})],JSONLoader.prototype,"loadAsset",null),JSONLoader=__decorate([e.singleton()],JSONLoader)}(e.Loader);e.JSONLoader=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function TextureLoader(){t.call(this)}return __extends(TextureLoader,t),TextureLoader.getInstance=function(){},TextureLoader.prototype.loadAsset=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=null,o=t[0],a=t[2];switch(n=wdCb.PathUtils.extname(o).toLowerCase()){case".jpg":case".jpeg":case".gif":case".bmp":i=e.ImageLoader.load(o,a).map(function(t){var r=e.ImageTextureAsset.create(t);return r.format=e.ETextureFormat.RGB,r});break;case".png":i=e.ImageLoader.load(o,a).map(function(t){return e.ImageTextureAsset.create(t)});break;case".dds":i=e.CompressedTextureLoader.load(o);break;default:e.Log.error(!0,e.Log.info.FUNC_NOT_SUPPORT(n))}return i},__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];e.assert(!e.JudgeUtils.isArrayExactly(t[0]),e.Log.info.FUNC_MUST_BE("url","string"))})],TextureLoader.prototype,"loadAsset",null),TextureLoader=__decorate([e.singleton()],TextureLoader)}(e.Loader);e.TextureLoader=t}(wd||(wd={}));var wd;!function(e){var t=function(){function AjaxLoader(){}return AjaxLoader.load=function(t,r){return wdFrp.fromPromise(new e.RSVP.Promise(function(e,n){wdCb.AjaxUtils.ajax({type:"get",url:t,contentType:"text/plain; charset=utf-8",dataType:r,success:function(t){e(t)},error:function(e,r){n("url:"+t+"\nreadyState:"+e.readyState+"\nstatus:"+e.status+"\nmessage:"+r.message+"\nresponseText:"+e.responseText)}})}))},AjaxLoader}();e.AjaxLoader=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Base64Utils(){}return Base64Utils.createImageFromBase64=function(e,t){var r=new Image;return r.src=e,r},__decorate([e.require(function(t){e.it("base64 should define 'data:image' field",function(){e.expect(t.indexOf("data:image")).gt(-1)})})],Base64Utils,"createImageFromBase64",null),Base64Utils}();e.Base64Utils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function BufferReader(){this._dataView=null,this._offset=0}return BufferReader.create=function(e,t,r){var n=new this;return n.initWhenCreate(e,t,r),n},Object.defineProperty(BufferReader.prototype,"arraybuffer",{get:function(){return this._dataView.buffer},enumerable:!0,configurable:!0}),Object.defineProperty(BufferReader.prototype,"byteLength",{get:function(){return this._dataView.byteLength},enumerable:!0,configurable:!0}),Object.defineProperty(BufferReader.prototype,"byteOffset",{get:function(){return this._dataView.byteOffset},enumerable:!0,configurable:!0}),BufferReader.prototype.initWhenCreate=function(e,t,r){this._dataView=new DataView(e,t,r)},BufferReader.prototype.readInt8=function(){var e=this._dataView.getInt8(this._offset);return this._offset++,e},BufferReader.prototype.readUInt8=function(){var e=this._dataView.getUint8(this._offset);return this._offset++,e},BufferReader.prototype.readInt16=function(){var e=this._dataView.getInt16(this._offset,!0);return this._offset+=2,e},BufferReader.prototype.readUInt16=function(){var e=this._dataView.getUint16(this._offset,!0);return this._offset+=2,e},BufferReader.prototype.readInt32=function(){var e=this._dataView.getInt32(this._offset,!0);return this._offset+=4,e},BufferReader.prototype.readUInt32=function(){var e=this._dataView.getUint32(this._offset,!0);return this._offset+=4,e},BufferReader.prototype.readFloat=function(){var e=this._dataView.getFloat32(this._offset,!0);return this._offset+=4,e},BufferReader.prototype.seek=function(e){this._offset=e},BufferReader}();e.BufferReader=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ImageLoader(){}
return ImageLoader.load=function(t,r){return wdFrp.fromPromise(new e.RSVP.Promise(function(n,i){var o=null;o=new e.root.Image,r.isCrossOrigin&&(o.crossOrigin="anonymous"),o.onload=function(){this.onload=null,n(o)},o.onerror=function(){i("error")},o.src=t}))},ImageLoader}();e.ImageLoader=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ModelLoaderUtils(){}return ModelLoaderUtils.getPath=function(e,t){return wdCb.PathUtils.dirname(e)+"/"+t},ModelLoaderUtils}();e.ModelLoaderUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function CompressedTextureLoader(){}return CompressedTextureLoader.load=function(t){var r=this;return e.AjaxLoader.load(t,"arraybuffer").map(function(t){var n=e.DDSParser.parse(t,!0),i=e.CompressedTextureAsset.create();return i.width=n.width,i.height=n.height,i.mipmaps=n.mipmaps,1==n.mipmapCount&&(i.minFilter=e.ETextureFilterMode.LINEAR),i.format=r._getCompressedFormat(n.format),i})},CompressedTextureLoader._getCompressedFormat=function(t){var r=e.GPUDetector.getInstance().extensionCompressedTextureS3TC;if(t===e.ETextureFormat.RGBA)return t;if(!r)return null;switch(t){case e.ETextureFormat.RGB_S3TC_DXT1:t=r.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case e.ETextureFormat.RGBA_S3TC_DXT1:t=r.COMPRESSED_RGBA_S3TC_DXT1_EXT;break;case e.ETextureFormat.RGBA_S3TC_DXT3:t=r.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case e.ETextureFormat.RGBA_S3TC_DXT5:t=r.COMPRESSED_RGBA_S3TC_DXT5_EXT}return t},CompressedTextureLoader}();e.CompressedTextureLoader=t}(wd||(wd={}));var wd;!function(e){var t=542327876,r=131072,n=512,i=4,o=function(){function DDSParser(){}return DDSParser.parse=function(o,s){void 0===s&&(s=!0);var c=new a,u=this._fourCCToInt32("DXT1"),l=this._fourCCToInt32("DXT3"),h=this._fourCCToInt32("DXT5"),d=31,p=0,f=1,m=2,g=3,_=4,y=7,v=20,b=21,C=22,E=23,S=24,T=25,M=26,D=28,L=new Int32Array(o,0,d),w=null,x=null,O=null,A=null,R=null,I=null,N=null;if(L[p]!==t)return e.Log.error(!0,"Invalid magic number in DDS header."),c;if(!L[v]&i)return e.Log.error(!0,"Unsupported format, must contain a FourCC code."),c;switch(x=L[b],O=!1,x){case u:w=8,c.format=e.ETextureFormat.RGB_S3TC_DXT1;break;case l:w=16,c.format=e.ETextureFormat.RGBA_S3TC_DXT3;break;case h:w=16,c.format=e.ETextureFormat.RGBA_S3TC_DXT5;break;default:if(!(32==L[C]&&16711680&L[E]&&65280&L[S]&&255&L[T]&&4278190080&L[M]))return e.Log.error(!0,"Unsupported FourCC code "+this._int32ToFourCC(x)),c;O=!0,w=64,c.format=e.ETextureFormat.RGBA}c.mipmapCount=1,L[m]&r&&s!==!1&&(c.mipmapCount=Math.max(1,L[y])),c.isCubemap=!!(L[D]&n),c.width=L[_],c.height=L[g],A=L[f]+4,R=c.width,I=c.height,N=c.isCubemap?6:1;for(var B=0;B<N;B++){for(var P=0;P<c.mipmapCount;P++){var U=null,F=null,V=null;O?(F=this._loadARGBMip(o,A,R,I),V=F.length):(V=Math.max(4,R)/4*Math.max(4,I)/4*w,F=new Uint8Array(o,A,V)),U={data:F,width:R,height:I},c.mipmaps.addChild(U),A+=V,R=Math.max(.5*R,1),I=Math.max(.5*I,1)}R=c.width,I=c.height}return c},DDSParser._fourCCToInt32=function(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)},DDSParser._int32ToFourCC=function(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)},DDSParser._loadARGBMip=function(e,t,r,n){for(var i=r*n*4,o=new Uint8Array(e,t,i),a=new Uint8Array(i),s=0,c=0,u=0;u<n;u++)for(var l=0;l<r;l++){var h=null,d=null,p=null,f=null;h=o[c],c++,d=o[c],c++,p=o[c],c++,f=o[c],c++,a[s]=p,s++,a[s]=d,s++,a[s]=h,s++,a[s]=f,s++}return a},DDSParser}();e.DDSParser=o;var a=function(){function DDSData(){this.mipmaps=wdCb.Collection.create(),this.width=0,this.height=0,this.format=null,this.mipmapCount=1,this.isCubemap=!1}return DDSData}();e.DDSData=a}(wd||(wd={}));var wd;!function(e){var t=function(){function TextureAsset(){this._width=null,this._height=null,this.generateMipmaps=!0,this.sourceRegionMethod=e.ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL,this.format=e.ETextureFormat.RGBA,this.source=TextureAsset.defaultTexture,this.repeatRegion=e.RectRegion.create(0,0,1,1),this.sourceRegion=null,this.sourceRegionMapping=e.ETextureSourceRegionMapping.CANVAS,this.packAlignment=4,this.unpackAlignment=4,this.flipY=!0,this.premultiplyAlpha=!1,this.isPremultipliedAlpha=null,this.colorspaceConversion=e.DeviceManager.getInstance().gl.BROWSER_DEFAULT_WEBGL,this.wrapS=e.ETextureWrapMode.CLAMP_TO_EDGE,this.wrapT=e.ETextureWrapMode.CLAMP_TO_EDGE,this.magFilter=e.ETextureFilterMode.LINEAR,this.minFilter=e.ETextureFilterMode.LINEAR_MIPMAP_LINEAR,this.type=e.ETextureType.UNSIGNED_BYTE,this.mipmaps=wdCb.Collection.create(),this.anisotropy=0,this.needUpdate=!0}return Object.defineProperty(TextureAsset.prototype,"width",{get:function(){return null===this._width?this.source?this.source.width:null:this._width},set:function(e){this._width=e},enumerable:!0,configurable:!0}),Object.defineProperty(TextureAsset.prototype,"height",{get:function(){return null===this._height?this.source?this.source.height:null:this._height},set:function(e){this._height=e},enumerable:!0,configurable:!0}),TextureAsset.prototype.clone=function(){return e.CloneUtils.clone(this)},TextureAsset.prototype.cloneToCubemapTexture=function(t){t.generateMipmaps=this.generateMipmaps,t.minFilter=this.minFilter,t.magFilter=this.magFilter,t.width=this.width,t.height=this.height,t.wrapS=this.wrapS,t.wrapT=this.wrapT,t.anisotropy=this.anisotropy,t.premultiplyAlpha=this.premultiplyAlpha,t.isPremultipliedAlpha=this.isPremultipliedAlpha,t.flipY=!1,t.unpackAlignment=this.unpackAlignment,t.packAlignment=this.packAlignment,t.colorspaceConversion=this.colorspaceConversion,t.needUpdate=this.needUpdate,t.mode=e.EEnvMapMode.BASIC},TextureAsset.prototype.cloneTo=function(t){return e.Log.error(!t,e.Log.info.FUNC_MUST_DEFINE("texture")),t.source=this.source,t.width=this.width,t.height=this.height,t.mipmaps=this.mipmaps.clone(),t.wrapS=this.wrapS,t.wrapT=this.wrapT,t.magFilter=this.magFilter,t.minFilter=this.minFilter,t.anisotropy=this.anisotropy,t.format=this.format,t.type=this.type,t.repeatRegion=this.repeatRegion.clone(),t.sourceRegion=this.sourceRegion&&this.sourceRegion.clone(),t.sourceRegionMapping=this.sourceRegionMapping,t.sourceRegionMethod=this.sourceRegionMethod,t.generateMipmaps=this.generateMipmaps,t.premultiplyAlpha=this.premultiplyAlpha,t.isPremultipliedAlpha=this.isPremultipliedAlpha,t.flipY=this.flipY,t.unpackAlignment=this.unpackAlignment,t.packAlignment=this.packAlignment,t.colorspaceConversion=this.colorspaceConversion,t.needUpdate=this.needUpdate,t},TextureAsset.defaultTexture=null,__decorate([e.cloneAttributeAsBasicType()],TextureAsset.prototype,"source",void 0),TextureAsset}();e.TextureAsset=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ImageTextureAsset(e){t.call(this),this.source=e}return __extends(ImageTextureAsset,t),ImageTextureAsset.create=function(e){var t=new this(e);return t},ImageTextureAsset.prototype.toTexture=function(){return e.ImageTexture.create(this)},ImageTextureAsset.prototype.toCubemapFaceTexture=function(){return e.CubemapFaceImageTexture.create(this)},ImageTextureAsset.prototype.cloneToCubemapFaceTexture=function(t){t.source=this.source,t.type=this.type,t.format=this.format,t.width=this.width,t.height=this.height,t.sourceRegion=this.sourceRegion,t.sourceRegionMethod=e.ETextureSourceRegionMethod.DRAW_IN_CANVAS},ImageTextureAsset}(e.TextureAsset);e.ImageTextureAsset=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CompressedTextureAsset(){t.apply(this,arguments)}return __extends(CompressedTextureAsset,t),CompressedTextureAsset.create=function(){var e=new this;return e.initWhenCreate(),e},CompressedTextureAsset.prototype.initWhenCreate=function(){this.generateMipmaps=!1,this.flipY=!1},CompressedTextureAsset.prototype.toTexture=function(){return e.CompressedTexture.create(this)},CompressedTextureAsset.prototype.toCubemapFaceTexture=function(){return e.CubemapFaceCompressedTexture.create(this)},CompressedTextureAsset.prototype.cloneToCubemapFaceTexture=function(e){e.type=this.type,e.format=this.format,e.width=this.width,e.height=this.height,e.mipmaps=this.mipmaps,e.minFilter=this.minFilter},CompressedTextureAsset}(e.TextureAsset);e.CompressedTextureAsset=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.NEAREST="NEAREST"]="NEAREST",e[e.NEAREST_MIPMAP_MEAREST="NEAREST_MIPMAP_MEAREST"]="NEAREST_MIPMAP_MEAREST",e[e.NEAREST_MIPMAP_LINEAR="NEAREST_MIPMAP_LINEAR"]="NEAREST_MIPMAP_LINEAR",e[e.LINEAR="LINEAR"]="LINEAR",e[e.LINEAR_MIPMAP_NEAREST="LINEAR_MIPMAP_NEAREST"]="LINEAR_MIPMAP_NEAREST",e[e.LINEAR_MIPMAP_LINEAR="LINEAR_MIPMAP_LINEAR"]="LINEAR_MIPMAP_LINEAR"}(e.ETextureFilterMode||(e.ETextureFilterMode={}));e.ETextureFilterMode}(wd||(wd={}));var wd;!function(e){!function(e){e[e.REPEAT="REPEAT"]="REPEAT",e[e.MIRRORED_REPEAT="MIRRORED_REPEAT"]="MIRRORED_REPEAT",e[e.CLAMP_TO_EDGE="CLAMP_TO_EDGE"]="CLAMP_TO_EDGE"}(e.ETextureWrapMode||(e.ETextureWrapMode={}));e.ETextureWrapMode}(wd||(wd={}));var wd;!function(e){!function(e){e[e.RGB="RGB"]="RGB",e[e.RGBA="RGBA"]="RGBA",e[e.ALPHA="ALPHA"]="ALPHA",e[e.LUMINANCE="LUMINANCE"]="LUMINANCE",e[e.LUMINANCE_ALPHA="LUMINANCE_ALPHA"]="LUMINANCE_ALPHA",e[e.RGB_S3TC_DXT1="RGB_S3TC_DXT1"]="RGB_S3TC_DXT1",e[e.RGBA_S3TC_DXT1="RGBA_S3TC_DXT1"]="RGBA_S3TC_DXT1",e[e.RGBA_S3TC_DXT3="RGBA_S3TC_DXT3"]="RGBA_S3TC_DXT3",e[e.RGBA_S3TC_DXT5="RGBA_S3TC_DXT5"]="RGBA_S3TC_DXT5"}(e.ETextureFormat||(e.ETextureFormat={}));e.ETextureFormat}(wd||(wd={}));var wd;!function(e){!function(e){e[e.UNSIGNED_BYTE="UNSIGNED_BYTE"]="UNSIGNED_BYTE",e[e.UNSIGNED_SHORT_5_6_5="UNSIGNED_SHORT_5_6_5"]="UNSIGNED_SHORT_5_6_5",e[e.UNSIGNED_SHORT_4_4_4_4="UNSIGNED_SHORT_4_4_4_4"]="UNSIGNED_SHORT_4_4_4_4",e[e.UNSIGNED_SHORT_5_5_5_1="UNSIGNED_SHORT_5_5_5_1"]="UNSIGNED_SHORT_5_5_5_1"}(e.ETextureType||(e.ETextureType={}));e.ETextureType}(wd||(wd={}));var wd;!function(e){!function(e){e[e.BASIC=0]="BASIC",e[e.REFLECTION=1]="REFLECTION",e[e.REFRACTION=2]="REFRACTION",e[e.FRESNEL=3]="FRESNEL"}(e.EEnvMapMode||(e.EEnvMapMode={}));e.EEnvMapMode}(wd||(wd={}));var wd;!function(e){!function(e){e[e.MIX=0]="MIX",e[e.MULTIPLY=1]="MULTIPLY",e[e.ADD=2]="ADD"}(e.ETextureCombineMode||(e.ETextureCombineMode={}));e.ETextureCombineMode}(wd||(wd={}));var wd;!function(e){!function(e){e[e.CANVAS=0]="CANVAS",e[e.UV=1]="UV"}(e.ETextureSourceRegionMapping||(e.ETextureSourceRegionMapping={}));e.ETextureSourceRegionMapping}(wd||(wd={}));var wd;!function(e){!function(e){e[e.CHANGE_TEXCOORDS_IN_GLSL=0]="CHANGE_TEXCOORDS_IN_GLSL",e[e.DRAW_IN_CANVAS=1]="DRAW_IN_CANVAS"}(e.ETextureSourceRegionMethod||(e.ETextureSourceRegionMethod={}));e.ETextureSourceRegionMethod}(wd||(wd={}));var wd;!function(e){!function(e){e[e.TEXTURE_2D="TEXTURE_2D"]="TEXTURE_2D",e[e.TEXTURE_CUBE_MAP="TEXTURE_CUBE_MAP"]="TEXTURE_CUBE_MAP"}(e.ETextureTarget||(e.ETextureTarget={}));e.ETextureTarget}(wd||(wd={}));var wd;!function(e){var t=function(){function LoaderManager(){this.assetCount=0,this.currentLoadedCount=0,this._assetTable=wdCb.Hash.create()}return LoaderManager.getInstance=function(){},LoaderManager.prototype.load=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=this;if(e.JudgeUtils.isString(t[0])){var i=t[0],o=i;return this._createLoadSingleAssetStream(i,o,n._getConfig(null))}var a=this,s=t[0];return wdFrp.fromArray(s).concatMap(function(t){return a._createLoadMultiAssetStream(t.type||e.EAssetType.UNKNOW,t.url,t.id,a._getConfig(t.config))})},LoaderManager.prototype.reset=function(){this.assetCount=0,this.currentLoadedCount=0},LoaderManager.prototype.dispose=function(){this.reset(),e.LoaderFactory.createAllLoader().forEach(function(e){e.dispose()})},LoaderManager.prototype.get=function(e){var t=this._assetTable.getChild(e);return t?t.get(e):null},LoaderManager.prototype.add=function(e,t){this._assetTable.addChild(e,t)},LoaderManager.prototype._createLoadMultiAssetStream=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=e[0],n=e[1],i=e[2],o=e[3],a=this._getLoader(r,n),s=this;return a.has(i)||s.assetCount++,a.load(n,i,o).map(function(){return s.currentLoadedCount++,{currentLoadedCount:s.currentLoadedCount,assetCount:s.assetCount}})},LoaderManager.prototype._createLoadSingleAssetStream=function(t,r,n){var i=this._getLoader(e.EAssetType.UNKNOW,t);return i.load(t,r,n)},LoaderManager.prototype._getLoader=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=t[0],i=null;return i=e.JudgeUtils.isArrayExactly(t[1])?wdCb.PathUtils.extname(t[1][0]):wdCb.PathUtils.extname(t[1]),e.LoaderFactory.create(n,i.toLowerCase())},LoaderManager.prototype._getConfig=function(e){var t={isCrossOrigin:!1};return null===e?t:wdCb.ExtendUtils.extend(t,e)},LoaderManager=__decorate([e.singleton()],LoaderManager)}();e.LoaderManager=t}(wd||(wd={}));var wd;!function(e){var t=function(){function LoaderFactory(){}return LoaderFactory.create=function(t,r){var n=null;switch(t){case e.EAssetType.SCRIPT:n=e.ScriptLoader.getInstance();break;case e.EAssetType.FONT:n=e.FontLoader.getInstance();break;case e.EAssetType.UNKNOW:n=this._getLoaderByExtname(r);break;default:wdCb.Log.error(!0,wdCb.Log.info.FUNC_UNKNOW("asset type:"+t))}return n},LoaderFactory.createAllLoader=function(){var t=wdCb.Collection.create([e.JsLoader.getInstance(),e.GLSLLoader.getInstance(),e.WDLoader.getInstance(),e.TextureLoader.getInstance(),e.FontLoader.getInstance(),e.FntLoader.getInstance()]),r=this._getLoader("SoundLoader"),n=this._getLoader("VideoLoader");return null!==r&&t.addChild(r),null!==n&&t.addChild(n),t},LoaderFactory._getLoaderByExtname=function(t){var r=null;switch(t){case".json":r=e.JSONLoader.getInstance();break;case".js":r=e.JsLoader.getInstance();break;case".glsl":r=e.GLSLLoader.getInstance();break;case".jpg":case".jpeg":case".png":case".dds":case".gif":case".bmp":r=e.TextureLoader.getInstance();break;case".mp4":case".ogv":case".webm":r=this._getLoader("VideoLoader",t);break;case".ogg":case".mp3":case".wav":r=this._getLoader("SoundLoader",t);break;case".wd":r=e.WDLoader.getInstance();break;case".eot":case".ttf":case".woff":case".svg":r=e.FontLoader.getInstance();break;case".fnt":r=e.FntLoader.getInstance();break;default:e.Log.error(!0,e.Log.info.FUNC_UNKNOW("extname:"+t))}return r},LoaderFactory._getLoader=function(t,r){var n=e.ClassUtils.getClass(t);return void 0===n?(r&&e.Log.error(!0,e.Log.info.FUNC_UNKNOW("extname:"+r)),null):n.getInstance()},LoaderFactory}();e.LoaderFactory=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.LINEAR="LINEAR"]="LINEAR",e[e.SWITCH="SWITCH"]="SWITCH"}(e.EKeyFrameInterpolation||(e.EKeyFrameInterpolation={}));e.EKeyFrameInterpolation}(wd||(wd={}));var wd;!function(e){!function(e){e[e.TRANSLATION="position"]="TRANSLATION",e[e.ROTATION="rotation"]="ROTATION",e[e.SCALE="scale"]="SCALE",e[e.TEXTURE_OFFSET="TEXTURE_OFFSET"]="TEXTURE_OFFSET"}(e.EKeyFrameAnimationTarget||(e.EKeyFrameAnimationTarget={}));e.EKeyFrameAnimationTarget}(wd||(wd={}));var wd;!function(e){!function(e){e[e.CONTAINER="CONTAINER"]="CONTAINER"}(e.EWDTag||(e.EWDTag={}));e.EWDTag}(wd||(wd={}));var wd;!function(e){!function(e){e[e.TRANSLATION="translation"]="TRANSLATION",e[e.ROTATION="rotation"]="ROTATION",e[e.SCALE="scale"]="SCALE"}(e.EWDKeyFrameAnimationPath||(e.EWDKeyFrameAnimationPath={}));e.EWDKeyFrameAnimationPath}(wd||(wd={}));var wd;!function(e){var t=function(t){function WDLoader(){t.call(this),this._arrayBufferMap=wdCb.Hash.create(),this._imageMap=wdCb.Hash.create()}return __extends(WDLoader,t),WDLoader.getInstance=function(){},WDLoader.prototype.loadAsset=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=t[0],i=t[2],o=this,a=null;return e.AjaxLoader.load(n,"json").flatMap(function(e){return a=e,o._createLoadAllAssetsStream(n,i,e)}).lastOrDefault().map(function(){return e.WDAssembler.create().build(e.WDParser.create().parse(a,o._arrayBufferMap,o._imageMap))})},WDLoader.prototype._createLoadAllAssetsStream=function(e,t,r){return wdFrp.fromArray([this._createLoadBuffersStream(e,r),this._createLoadImageAssetStream(e,t,r)]).mergeAll()},WDLoader.prototype._createLoadBuffersStream=function(t,r){var n=this._arrayBufferMap;return this._createLoadAssetStream(t,r,r.buffers,function(t,r){n.addChild(t,e.WDUtils.decodeArrayBuffer(r))},function(t,r){return e.AjaxLoader.load(r,"arraybuffer")["do"](function(r){e.Log.error(!(r instanceof ArrayBuffer),e.Log.info.FUNC_SHOULD("Buffer:"+t,"be an array buffer")),e.Log.error(r.byteLength!==r.byteLength,e.Log.info.FUNC_SHOULD("Buffer:"+t+"'s length is "+r.byteLength+", but it","be "+r.byteLength)),n.addChild(t,r)})})},WDLoader.prototype._createLoadImageAssetStream=function(t,r,n){var i=this._imageMap;return this._createLoadAssetStream(t,n,n.images,function(r,n){i.addChild(r,e.Base64Utils.createImageFromBase64(n,t))},function(t,n){return e.TextureLoader.getInstance().load(n,t,r)["do"](function(e){i.addChild(t,e.source)})})},WDLoader.prototype._createLoadAssetStream=function(t,r,n,i,o){var a=[];if(n){var s=null;for(s in n)if(n.hasOwnProperty(s)){var c=n[s];if(e.WDUtils.isBase64(c.uri))i(s,c.uri);else{var u=e.ModelLoaderUtils.getPath(t,c.uri);a.push(o(s,u))}}}return wdFrp.fromArray(a).mergeAll()},__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];e.assert(!e.JudgeUtils.isArrayExactly(t[0]),e.Log.info.FUNC_MUST_BE("url","string"))})],WDLoader.prototype,"loadAsset",null),WDLoader=__decorate([e.singleton()],WDLoader)}(e.Loader);e.WDLoader=t}(wd||(wd={}));var wd;!function(e){var t=function(){function WDParser(){this._data={},this._arrayBufferMap=null,this._imageMap=null,this._json=null,this._geometryParser=e.WDGeometryParser.create(),this._keyFrameAnimationParser=e.WDKeyFrameAnimationParser.create(),this._skinSkeletonAnimationAnimationParser=e.WDSkinSkeletonAnimationParser.create(),this._articulatedAnimationParser=e.WDArticulatedAnimationParser.create(),this._transformParser=e.WDTransformParser.create(),this._skinSkeletonAnimationParser=e.WDSkinSkeletonParser.create(),this._cameraParser=e.WDCameraParser.create(),this._lightParser=e.WDLightParser.create(),this._skinSkeletonAnimationMap=wdCb.Hash.create()}return WDParser.create=function(){var e=new this;return e},WDParser.prototype.parse=function(e,t,r){var n=this;if(this._json=e,this._arrayBufferMap=t,this._imageMap=r,e.asset&&this._parseMetadata(),this._parseObjects(),e.animations){var i=this._keyFrameAnimationParser.parse(e,this._data.objects,this._arrayBufferMap),o=i.nodeWithAnimationMap,a=i.objectWithAnimationMap;this._skinSkeletonAnimationMap.forEach(function(t){t.jointTransformData=n._skinSkeletonAnimationAnimationParser.parse(e,o,t.jointNames)}),this._articulatedAnimationParser.parse(a)}return this._data},WDParser.prototype._parseMetadata=function(){var e={},t=this._json;for(var r in t.asset)t.asset.hasOwnProperty(r)&&(e[r]=t.asset[r]);this._data.metadata=e},WDParser.prototype._parseObjects=function(){var t=this,r=this,n=this._json,i=wdCb.Collection.create(),o=function(i,a){var s=null;if(t._isJointNode(n,a))return null;if(s=e.WDUtils.createObjectData(),s.id=i,a.name&&(s.name=a.name),a.mesh){var c=null;c=n.meshes[a.mesh],!a.name&&c.name&&(s.name=c.name),r._geometryParser.parse(n,s,c,r._arrayBufferMap,r._imageMap)}if(a.light&&s.components.addChild(r._lightParser.parse(n,a.light)),a.camera&&s.components.addChild(r._cameraParser.parse(n,a.camera)),a.matrix?s.components.addChild(r._transformParser.parse(a.matrix)):a.rotation&&a.scale&&a.translation&&s.components.addChild(r._transformParser.parse(a.translation,a.rotation,a.scale)),a.skin&&a.skeletons){var u=r._skinSkeletonAnimationParser.parse(n,a.skin,a.skeletons,s.name,r._arrayBufferMap);r._skinSkeletonAnimationMap.addChild(i,u),s.components.addChild(u)}if(a.children)for(var l=0,h=a.children;l<h.length;l++){var d=h[l],p=o(d,n.nodes[d]);null!==p&&s.children.addChild(p)}return s};if(!n.scenes[n.scene])return void(this._data.objects=i);for(var a=0,s=n.scenes[n.scene].nodes;a<s.length;a++){var c=s[a],u=o(c,n.nodes[c]);null!==u&&i.addChild(u)}this._data.objects=i},WDParser.prototype._isJointNode=function(e,t){return!!t.jointName||!!t.children&&t.children.length>0&&!!e.nodes[t.children[0]].jointName},WDParser}();e.WDParser=t}(wd||(wd={}));var wd;!function(e){var t=function(){function WDComponentParser(){}return WDComponentParser}();e.WDComponentParser=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function WDGeometryParser(){t.apply(this,arguments),this._isGeneratedFromGLTF=!1,this._arrayBufferMap=null,this._imageMap=null,this._json=null,this._materialParser=e.WDMaterialParser.create()}return __extends(WDGeometryParser,t),WDGeometryParser.create=function(){var e=new this;return e},WDGeometryParser.prototype.parse=function(t,r,n,i,o){if(this._json=t,this._arrayBufferMap=i,this._imageMap=o,t.asset&&t.asset.generator&&t.asset.generator.indexOf("GLTF")>-1&&(this._isGeneratedFromGLTF=!0),n.primitives.length>1){for(var a=0,s=n.primitives;a<s.length;a++){var c=s[a],u=e.WDUtils.createObjectData();this._setChildObjectNameWithMultiPrimitives(u,c),u.components.addChild(this._parseGeometry(c)),r.children.addChild(u)}r.isContainer=!0}else 1===n.primitives.length&&r.components.addChild(this._parseGeometry(n.primitives[0]))},WDGeometryParser.prototype._setChildObjectNameWithMultiPrimitives=function(e,t){t.name?e.name=t.name:t.material&&(e.name=t.material)},WDGeometryParser.prototype._parseGeometry=function(t){var r=this._json,n=this._arrayBufferMap,i={},o=null,a=null,s=null,c=null,u=null,l=null,h=null,d=null,p=null;for(var f in t.attributes)if(t.attributes.hasOwnProperty(f)){var m=t.attributes[f],g=r.accessors[m],_=e.WDUtils.getBufferReaderFromAccessor(r,g,n),y=_.bufferReader,v=_.count;"POSITION"===f?(o=[],this._addAttributeData(o,y,v)):"TEXCOORD"===f?(a=[],this._addAttributeData(a,y,v),this._isGeneratedFromGLTF&&this._normalizeTexCoords(a)):"NORMAL"===f?(l=[],this._addAttributeData(l,y,v)):"COLOR"===f?(s=[],this._addAttributeData(s,y,v)):"JOINT"===f?(c=[],this._addAttributeData(c,y,v)):"WEIGHT"===f&&(u=[],this._addWeightAttributeData(u,y,v))}if(h=this._getFaces(r,t.indices,l),void 0!==t.morphTargets){var b=e.WDMorphDataParseUtils.parseMorphData(r,t.morphTargets,this._arrayBufferMap);d=b.morphVertices,p=b.morphNormals}return e.WDUtils.addData(i,"vertices",o),e.WDUtils.addData(i,"colors",s),e.WDUtils.addData(i,"jointIndices",c),e.WDUtils.addData(i,"jointWeights",u),e.WDUtils.addData(i,"texCoords",a),e.WDUtils.addData(i,"faces",h),e.WDUtils.addData(i,"morphVertices",d),e.WDUtils.addData(i,"morphNormals",p),e.WDUtils.addData(i,"drawMode",this._parseDrawMode(t.mode)),i.material=this._materialParser.parse(r,t.material,this._imageMap),i},WDGeometryParser.prototype._addAttributeData=function(e,t,r){for(var n=0;n<r;n++)e.push(t.readFloat())},WDGeometryParser.prototype._addWeightAttributeData=function(t,r,n){for(var i=0;i<n;i+=4){var o=e.Vector4.create(r.readFloat(),r.readFloat(),r.readFloat(),r.readFloat()),a=1/o.lengthManhattan();a!==1/0?o.multiplyScalar(a):o.set(1,0,0,0),t.push(o.x,o.y,o.z,o.w)}},WDGeometryParser.prototype._getFaces=function(t,r,n){var i=null,o=null,a=[];if(!r)return[];i=t.accessors[r];for(var s=e.WDUtils.getBufferReaderFromAccessor(t,i,this._arrayBufferMap),c=s.bufferReader,u=s.count,l=0,h=u;l<h;l+=3){var d=c.readUInt16(),p=c.readUInt16(),f=c.readUInt16(),m=[d,p,f];o=e.Face3.create(d,p,f),e.GeometryUtils.hasData(n)&&this._addNormalData(o.vertexNormals,n,m),a.push(o)}return a},WDGeometryParser.prototype._addNormalData=function(e,t,r){var n=r[0],i=r[1],o=r[2];e.addChildren([this._getThreeComponentData(t,n),this._getThreeComponentData(t,i),this._getThreeComponentData(t,o)])},WDGeometryParser.prototype._getThreeComponentData=function(t,r){var n=3*r;return e.Vector3.create(t[n],t[n+1],t[n+2])},WDGeometryParser.prototype._parseDrawMode=function(t){var r=null;if(!t)return e.EDrawMode.TRIANGLES;switch(t){case 0:r=e.EDrawMode.POINTS;break;case 1:r=e.EDrawMode.LINES;break;case 2:r=e.EDrawMode.LINE_LOOP;break;case 3:r=e.EDrawMode.LINE_STRIP;break;case 4:r=e.EDrawMode.TRIANGLES;break;case 5:r=e.EDrawMode.TRIANGLE_STRIP;break;case 6:r=e.EDrawMode.TRANGLE_FAN;break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("mode:"+t))}return r},WDGeometryParser.prototype._normalizeTexCoords=function(e){if(e)for(var t=0,r=e.length/2;t<r;t++)e[2*t+1]=1-e[2*t+1]},__decorate([e.require(function(t,r,n){e.it("count should 4 times",function(){e.expect(n%4).equals(0)})})],WDGeometryParser.prototype,"_addWeightAttributeData",null),__decorate([e.require(function(t,r,n){var i=this;r&&e.it("indices' count should be 3 times",function(){var n=t.accessors[r],o=e.WDUtils.getBufferReaderFromAccessor(t,n,i._arrayBufferMap),a=(o.bufferReader,o.count);e.expect(a%3).equal(0)},this)})],WDGeometryParser.prototype,"_getFaces",null),WDGeometryParser}(e.WDComponentParser);e.WDGeometryParser=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function WDTransformParser(){t.apply(this,arguments)}return __extends(WDTransformParser,t),WDTransformParser.create=function(){var e=new this;return e},WDTransformParser.prototype.parse=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n={};if(1===t.length){var i=t[0];n.matrix=e.Matrix4.create(new Float32Array(i))}else if(3===t.length){var o=t[0],a=t[1],s=t[2];n.position=e.Vector3.create(o[0],o[1],o[2]),n.rotation=e.Quaternion.create(a[0],a[1],a[2],a[3]),n.scale=e.Vector3.create(s[0],s[1],s[2])}return n},WDTransformParser}(e.WDComponentParser);e.WDTransformParser=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function WDCameraParser(){t.apply(this,arguments)}return __extends(WDCameraParser,t),WDCameraParser.create=function(){var e=new this;return e},WDCameraParser.prototype.parse=function(e,t){var r=e.cameras[t],n={};return this._parseCameraDataByType(n,r),n},WDCameraParser.prototype._parseCameraDataByType=function(t,r){var n=null,i=r.type,o=r[i];switch(i){case"perspective":if(o=r[i],n=e.PerspectiveCamera.create(),n.near=o.znear,n.far=o.zfar,o.aspectRatio)n.aspect=o.aspectRatio;else{var a=e.DeviceManager.getInstance().view;n.aspect=a.width/a.height}n.fovy=e.AngleUtils.convertRadiansToDegree(o.yfov),t.camera=n;break;case"orthographic":n=e.OrthographicCamera.create(),n.near=o.znear,n.far=o.zfar,n.left=-o.xmag,n.right=o.xmag,n.top=o.ymag,n.bottom=-o.ymag,t.camera=n;break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("camera type:"+i))}},__decorate([e.require(function(t,r){e.it("should exist corresponding camera data",function(){var n=t.cameras;e.expect(n).exist,e.expect(n[r]).exist},this)})],WDCameraParser.prototype,"parse",null),WDCameraParser}(e.WDComponentParser);e.WDCameraParser=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function WDLightParser(){t.apply(this,arguments)}return __extends(WDLightParser,t),WDLightParser.create=function(){var e=new this;return e},WDLightParser.prototype.parse=function(t,r){var n=t.lights[r],i={};return e.WDUtils.addData(i,"type",n.type),this._parseLightDataByType(i,n,i.type),i},WDLightParser.prototype._parseLightDataByType=function(t,r,n){var i=r[n];switch(e.WDUtils.addData(t,"intensity",i.intensity),n){case"ambient":case"directional":t.color=e.WDUtils.getColor(i.color);break;case"point":t.color=e.WDUtils.getColor(i.color),e.WDUtils.addData(t,"range",i.range),e.WDUtils.addData(t,"constantAttenuation",i.constantAttenuation),e.WDUtils.addData(t,"linearAttenuation",i.linearAttenuation),e.WDUtils.addData(t,"quadraticAttenuation",i.quadraticAttenuation)}},__decorate([e.require(function(t,r){e.it("should exist corresponding light data",function(){var n=t.lights;e.expect(n).exist,e.expect(n[r]).exist},this)})],WDLightParser.prototype,"parse",null),WDLightParser}(e.WDComponentParser);e.WDLightParser=t}(wd||(wd={}));var wd;!function(e){var t=function(){function WDMaterialParser(){this._imageMap=null,this._json=null,this._glTextureMap=wdCb.Hash.create(),this._textureParser=e.WDTextureParser.create()}return WDMaterialParser.create=function(){var e=new this;return e},WDMaterialParser.prototype.parse=function(t,r,n){var i=null;if(!r)return this._getDefaultMaterialData();this._json=t,this._imageMap=n,this._textureParser.json=this._json,this._textureParser.imageMap=this._imageMap,this._textureParser.glTextureMap=this._glTextureMap;var o={};return i=t.materials[r],e.WDUtils.addData(o,"doubleSided",i.doubleSided),e.WDUtils.addData(o,"transparent",Boolean(i.transparent)),o.type=this._getMaterialType(i.technique),o.lightModel=this._getLightModel(i.technique),this._addMaterialValues(o,i.values),o},WDMaterialParser.prototype._getDefaultMaterialData=function(){return{type:"LightMaterial",lightModel:e.ELightModel.PHONG}},WDMaterialParser.prototype._getMaterialType=function(t){var r=null;switch(t){case"PHONG":case"BLINN":case"CONSTANT":case"LAMBERT":r="LightMaterial";break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("technique:"+t))}return r},WDMaterialParser.prototype._getLightModel=function(t){var r=null;switch(t){case"PHONG":r=e.ELightModel.PHONG;break;case"BLINN":r=e.ELightModel.BLINN;break;case"CONSTANT":r=e.ELightModel.CONSTANT;break;case"LAMBERT":r=e.ELightModel.LAMBERT;break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("technique:"+t))}return r},WDMaterialParser.prototype._addMaterialValues=function(t,r){r&&(this._addMaterialLightColor(t,"diffuse",r.diffuse),this._addMaterialLightColor(t,"specular",r.specular),this._addMaterialLightColor(t,"emission",r.emission),this._addMaterialLightColor(t,"reflective",r.ambient,"reflectionMap"),this._addMaterialLightMap(t,"lightMap",r.lightMap),this._addMaterialLightMap(t,"normalMap",r.normalMap),e.WDUtils.addData(t,"opacity",r.transparency),r.shininess&&(t.shininess=r.shininess))},WDMaterialParser.prototype._addMaterialLightColor=function(t,r,n,i){n&&(e.JudgeUtils.isArrayExactly(n)?t[r+"Color"]=e.WDUtils.getColor(n):(i=i?i:r+"Map",t[i]=this._textureParser.getTexture(n)))},WDMaterialParser.prototype._addMaterialLightMap=function(e,t,r){r&&(e[t]=this._textureParser.getTexture(r))},WDMaterialParser}();e.WDMaterialParser=t}(wd||(wd={}));var wd;!function(e){var t=function(){function WDTextureParser(){this.imageMap=null,this.json=null,this.glTextureMap=wdCb.Hash.create()}return WDTextureParser.create=function(){var e=new this;return e},WDTextureParser.prototype.getTexture=function(t){var r=null,n=null;if(!this.json.textures||!this.json.textures[t])return null;r=this.json.textures[t],n=this._createTextureAsset(r.target,r.source),r.format&&(n.format=this._getTextureFormat(r.format),r.internalFormat&&r.internalFormat!==r.format&&e.Log.warn("textureData.internalFormat("+r.internalFormat+") !== textureData.format("+r.format+"), here take textureData.format value as their value")),r.type&&(n.type=this._getTextureType(r.type)),this._addTextureSampler(n,r.sampler);var i=this._getGLTexture(n,r.source),o=n.toTexture();return null!==i&&(o.glTexture=i),o},WDTextureParser.prototype._getGLTexture=function(t,r){var n=this._buildGLTextureMapKey(t,r),i=null;return this.glTextureMap.hasChild(n)?this.glTextureMap.getChild(n):(i=e.DeviceManager.getInstance().gl.createTexture(),this.glTextureMap.addChild(n,i),i)},WDTextureParser.prototype._buildGLTextureMapKey=function(e,t){var r=null!==e.isPremultipliedAlpha&&e.isPremultipliedAlpha;return t+"_"+r+"_"+e.wrapS+"_"+e.wrapT+"_"+e.magFilter+"_"+e.minFilter},WDTextureParser.prototype._createTextureAsset=function(t,r){var n=null,i=this.imageMap.getChild(r);switch(i||e.Log.warn("no image found in loader(id:"+r+")"),t){case 3553:n=e.ImageTextureAsset.create(i);break;default:e.Log.error(!0,e.Log.info.FUNC_NOT_SUPPORT("target except TEXTURE_2D"))}return n},WDTextureParser.prototype._getTextureType=function(t){var r=null;switch(t){case 5121:r=e.ETextureType.UNSIGNED_BYTE;break;case 33635:r=e.ETextureType.UNSIGNED_SHORT_5_6_5;break;case 32819:r=e.ETextureType.UNSIGNED_SHORT_4_4_4_4;break;case 32820:r=e.ETextureType.UNSIGNED_SHORT_5_5_5_1;break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("texture->type:"+t))}return r},WDTextureParser.prototype._getTextureFormat=function(t){var r=null;switch(t){case 6406:r=e.ETextureFormat.ALPHA;break;case 6407:r=e.ETextureFormat.RGB;break;case 6408:r=e.ETextureFormat.RGBA;break;case 6409:
r=e.ETextureFormat.LUMINANCE;break;case 6410:r=e.ETextureFormat.LUMINANCE_ALPHA;break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("texture->format:"+t))}return r},WDTextureParser.prototype._addTextureSampler=function(t,r){var n=this.json.samplers[r];void 0!==n.isPremultipliedAlpha&&(t.isPremultipliedAlpha=n.isPremultipliedAlpha),n.wrapT?t.wrapT=this._getTextureWrap(n.wrapT):t.wrapT=e.ETextureWrapMode.REPEAT,n.wrapS?t.wrapS=this._getTextureWrap(n.wrapS):t.wrapS=e.ETextureWrapMode.REPEAT,n.minFilter?t.minFilter=this._getTextureFilter(n.minFilter):t.minFilter=e.ETextureFilterMode.LINEAR,n.magFilter?t.magFilter=this._getTextureFilter(n.magFilter):t.magFilter=e.ETextureFilterMode.LINEAR,n.repeatRegion&&(t.repeatRegion=this._getTextureRepeatRegion(n.repeatRegion))},WDTextureParser.prototype._getTextureRepeatRegion=function(t){return e.RectRegion.create(t[0],t[1],t[2],t[3])},WDTextureParser.prototype._getTextureFilter=function(t){var r=null;switch(t){case 9728:r=e.ETextureFilterMode.NEAREST;break;case 9729:r=e.ETextureFilterMode.LINEAR;break;case 9984:r=e.ETextureFilterMode.NEAREST_MIPMAP_MEAREST;break;case 9985:r=e.ETextureFilterMode.LINEAR_MIPMAP_NEAREST;break;case 9986:r=e.ETextureFilterMode.NEAREST_MIPMAP_LINEAR;break;case 9987:r=e.ETextureFilterMode.LINEAR_MIPMAP_LINEAR;break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("texture filter:"+t))}return r},WDTextureParser.prototype._getTextureWrap=function(t){var r=null;switch(t){case 33071:r=e.ETextureWrapMode.CLAMP_TO_EDGE;break;case 33648:r=e.ETextureWrapMode.MIRRORED_REPEAT;break;case 10497:r=e.ETextureWrapMode.REPEAT;break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("texture wrap:"+t))}return r},__decorate([e.require(function(t,r){e.assert(!!this.json.samplers[r],e.Log.info.FUNC_NOT_EXIST("samplerId:"+r))})],WDTextureParser.prototype,"_addTextureSampler",null),WDTextureParser}();e.WDTextureParser=t}(wd||(wd={}));var wd;!function(e){var t=function(){function WDSkinSkeletonParser(){this._json=null,this._arrayBufferMap=null}return WDSkinSkeletonParser.create=function(){var e=new this;return e},WDSkinSkeletonParser.prototype.parse=function(t,r,n,i,o){var a={},s=t.skins[r];return this._json=t,this._arrayBufferMap=o,!s.bindShapeMatrix||this._isIdentiyMatrixValues(s.bindShapeMatrix)?a.bindShapeMatrix=null:a.bindShapeMatrix=e.Matrix4.create(new Float32Array(s.bindShapeMatrix)),a.jointNames=s.jointNames,a.inverseBindMatrices=this._getInverseBindMatrices(s.inverseBindMatrices),a.boneMatrixMap=this._getBoneMatrixMap(n[0]),a.jointTransformData=null,a},WDSkinSkeletonParser.prototype._isIdentiyMatrixValues=function(e){for(var t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],r=0,n=t.length;r<n;r++)if(e[r]!==t[r])return!1;return!0},WDSkinSkeletonParser.prototype._getInverseBindMatrices=function(t){for(var r=this._json,n=[],i=null,o=e.WDUtils.getBufferReaderFromAccessor(r,r.accessors[t],this._arrayBufferMap),a=o.bufferReader,s=o.count,c=0,u=s;c<u;c+=16){i=new Float32Array(16);for(var l=0;l<16;l++)i[l]=a.readFloat();n.push(e.Matrix4.create(i))}return n},WDSkinSkeletonParser.prototype._getBoneMatrixMap=function(t){var r=this,n=this._json.nodes,i=wdCb.Hash.create(),o=function(t,a){var s=n[t],c=r._composeBoneMatrix(s),u=e.BoneMatrix.create(c);if(null!==a&&(u.parent=a),s.jointName?i.addChild(s.jointName,u):i.addChild(t,u),s.children)for(var l=0,h=s.children;l<h.length;l++){var d=h[l];o(d,u)}};return o(this._findRootNodeIdContainRootSkeleton(t),null),i},WDSkinSkeletonParser.prototype._findRootNodeIdContainRootSkeleton=function(e){var t=this._json.nodes,r=null,n=function(e){r=e;for(var i in t)if(t.hasOwnProperty(i)){var o=t[i];if(o.children&&o.children.indexOf(e)>-1){n(i);break}}};return n(e),r},WDSkinSkeletonParser.prototype._composeBoneMatrix=function(t){var r=null;if(t.translation&&t.rotation&&t.scale){var n=t.translation,i=t.rotation,o=t.scale;r=e.Matrix4.create().setTRS(e.Vector3.create(n[0],n[1],n[2]),e.Quaternion.create(i[0],i[1],i[2],i[3]),e.Vector3.create(o[0],o[1],o[2]))}else t.matrix&&(r=e.Matrix4.create(new Float32Array(t.matrix)));return r},__decorate([e.require(function(t,r,n,i){e.it("if has multi root skeletons, warn that only use the first skeleton",function(){n.length>1&&e.Log.warn(i+" has multi root skeletons:"+n+", only use the first skeleton:"+n[0])}),e.it("skin and skeleton should both exist",function(){e.expect(r).exist,e.expect(t.skins).exist,e.expect(t.skins[r]).exist,e.expect(n).exist,e.expect(n.length).gt(0)})})],WDSkinSkeletonParser.prototype,"parse",null),__decorate([e.require(function(t){e.it("should define matrix data",function(){e.expect(!!t.translation&&!!t.rotation&&!!t.scale||!!t.matrix)["true"]})})],WDSkinSkeletonParser.prototype,"_composeBoneMatrix",null),WDSkinSkeletonParser}();e.WDSkinSkeletonParser=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function WDKeyFrameAnimationParser(){t.apply(this,arguments),this._arrayBufferMap=null,this._json=null}return __extends(WDKeyFrameAnimationParser,t),WDKeyFrameAnimationParser.create=function(){var e=new this;return e},WDKeyFrameAnimationParser.prototype.parse=function(t,r,n){var i=this,o=wdCb.Hash.create(),a=wdCb.Hash.create(),s=t.nodes,c=this;this._json=t,this._arrayBufferMap=n;var u=function(u){if(t.animations.hasOwnProperty(u)){for(var l=t.animations[u],h=wdCb.Hash.create(),d=0,p=l.channels.length;d<p;d++){var f=l.channels[d],m=f.target.id;h.appendChild(m,f)}h.forEach(function(h,d){var p=wdCb.Collection.create(),f=null,m=null,g=null;if(m=i._findObject(r,d),null===m&&(f=c._findNode(s,d)),null===f&&null===m)return void e.Log.warn("can't find node or object whose id is "+d+" to attach to animation named "+u);var _=c._getAnimName(l,u);null!==m?c._addAnimationToNode(o,d,m,_,p):c._addAnimationToNode(a,d,f,_,p),g=c._getInputData(l,h);for(var y=e.WDUtils.getBufferReaderFromAccessor(t,t.accessors[g],n),v=y.bufferReader,b=y.count,C=i._getChannelBufferReaderArr(l,h),E=0;E<b;E++){var S=v.readFloat(),T={};T.time=i._convertSecondToMillisecond(S),T.targets=i._getKeyFrameDataTargets(l,h,C),p.addChild(T)}})}};for(var l in t.animations)u(l);return{nodeWithAnimationMap:a,objectWithAnimationMap:o}},WDKeyFrameAnimationParser.prototype._getChannelBufferReaderArr=function(t,r){var n=this,i=[];return r.forEach(function(r){var o=t.samplers[r.sampler],a=null,s=null;if(o){s=r.target.path,a=t.parameters[o.output];var c=e.WDUtils.getBufferReaderFromAccessor(n._json,n._json.accessors[a],n._arrayBufferMap),u=c.bufferReader;c.count;i.push(u)}}),i},WDKeyFrameAnimationParser.prototype._getAnimName=function(e,t){return e.name?e.name:t},WDKeyFrameAnimationParser.prototype._getInputData=function(e,t){var r=null;return t.forEach(function(t){var n=e.samplers[t.sampler];if(n)return r=e.parameters[n.input],wdCb.$BREAK}),r},WDKeyFrameAnimationParser.prototype._addAnimationToNode=function(e,t,r,n,i){e.hasChild(t)||e.addChild(t,{entity:r,animationData:{}}),e.getChild(t).animationData[n]=i},WDKeyFrameAnimationParser.prototype._getKeyFrameDataTargets=function(t,r,n){var i=this,o=wdCb.Collection.create();return r.forEach(function(r,a){var s=t.samplers[r.sampler],c=null,u=null,l={},h=null;if(s){switch(u=r.target.path,c=t.parameters[s.output],h=n[a],l.interpolationMethod=i._convertTointerpolationMethod(s.interpolation),u){case e.EWDKeyFrameAnimationPath.TRANSLATION:l.target=e.EKeyFrameAnimationTarget.TRANSLATION,l.data=e.Vector3.create(h.readFloat(),h.readFloat(),h.readFloat());break;case e.EWDKeyFrameAnimationPath.ROTATION:l.target=e.EKeyFrameAnimationTarget.ROTATION,l.data=e.Quaternion.create(h.readFloat(),h.readFloat(),h.readFloat(),h.readFloat());break;case e.EWDKeyFrameAnimationPath.SCALE:l.target=e.EKeyFrameAnimationTarget.SCALE,l.data=e.Vector3.create(h.readFloat(),h.readFloat(),h.readFloat());break;default:e.Log.error(!0,e.Log.info.FUNC_NOT_SUPPORT("path:"+u))}o.addChild(l)}},this),o},WDKeyFrameAnimationParser.prototype._findNode=function(e,t){return e[t]},WDKeyFrameAnimationParser.prototype._findObject=function(e,t){var r=function(e){var n=e.findOne(function(e){return e.id===t});return n?n:(e.forEach(function(e){if(n=r(e.children))return wdCb.$BREAK}),n)};return r(e)},WDKeyFrameAnimationParser.prototype._convertSecondToMillisecond=function(e){return 1e3*e},WDKeyFrameAnimationParser.prototype._convertTointerpolationMethod=function(t){switch(t){case e.EKeyFrameInterpolation.LINEAR:return e.EKeyFrameInterpolation.LINEAR;default:e.Log.error(!0,e.Log.info.FUNC_NOT_SUPPORT("interpolation:"+t))}},WDKeyFrameAnimationParser}(e.WDComponentParser);e.WDKeyFrameAnimationParser=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function WDSkinSkeletonAnimationParser(){e.apply(this,arguments)}return __extends(WDSkinSkeletonAnimationParser,e),WDSkinSkeletonAnimationParser.create=function(){var e=new this;return e},WDSkinSkeletonAnimationParser.prototype.parse=function(e,t,r){for(var n=wdCb.Hash.create(),i=0,o=r;i<o.length;i++){var a=o[i],s=t.getChild(a),c=null;if(s)for(var u in s.animationData)if(s.animationData.hasOwnProperty(u)){var l=s.animationData[u];n.hasChild(u)?c=n.getChild(u):(c=wdCb.Hash.create(),n.addChild(u,c)),c.addChild(a,l)}}return n},WDSkinSkeletonAnimationParser}(e.WDComponentParser);e.WDSkinSkeletonAnimationParser=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function WDArticulatedAnimationParser(){t.apply(this,arguments)}return __extends(WDArticulatedAnimationParser,t),WDArticulatedAnimationParser.create=function(){var e=new this;return e},WDArticulatedAnimationParser.prototype.parse=function(e){this._addAnimationComponent(e)},WDArticulatedAnimationParser.prototype._addAnimationComponent=function(e){e.forEach(function(e){var t=e.entity,r=e.animationData;t.components.addChild(r),delete e.animationData})},__decorate([e.ensure(function(t,r){e.it("node should only has 1 IWDKeyFrameAnimation component",function(){r.forEach(function(t){var r=t.entity;t.animationData;e.expect(r.components.filter(function(t){return e.WDUtils.isIWDKeyFrameAnimationAssembler(t)}).getCount()).most(1)})})})],WDArticulatedAnimationParser.prototype,"_addAnimationComponent",null),WDArticulatedAnimationParser}(e.WDComponentParser);e.WDArticulatedAnimationParser=t}(wd||(wd={}));var wd;!function(e){var t=function(){function WDUtils(){}return WDUtils.addData=function(e,t,r){void 0!==r&&null!==r&&(e[t]=r)},WDUtils.isBase64=function(e){return/^([A-Za-z0-9+\/]{4})*([A-Za-z0-9+\/]{4}|[A-Za-z0-9+\/]{3}=|[A-Za-z0-9+\/]{2}==)$/.test(e)||"data:"===e.substr(0,5)},WDUtils.decodeArrayBuffer=function(e){for(var t=e.split(","),r=t.length>1?t[1]:t[0],n=atob(r),i=n.length,o=new Uint8Array(new ArrayBuffer(i)),a=0;a<i;a++)o[a]=n.charCodeAt(a);return o.buffer},WDUtils.createObjectData=function(){return{id:null,isContainer:!1,components:wdCb.Collection.create(),children:wdCb.Collection.create()}},WDUtils.getColor=function(t){var r=e.Color.create();return r.r=Number(t[0]),r.g=Number(t[1]),r.b=Number(t[2]),4===t.length&&(r.a=Number(t[3])),r},WDUtils.getBufferReaderFromAccessor=function(t,r,n){var i=t.bufferViews[r.bufferView],o=n.getChild(i.buffer),a=r.byteOffset+i.byteOffset,s=r.count*this.getAccessorTypeSize(r),c=null;switch(r.componentType){case 5120:c=1;break;case 5121:c=1;break;case 5122:c=2;break;case 5123:c=2;break;case 5126:c=4;break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("componentType:"+r.componentType))}return{bufferReader:e.BufferReader.create(o,a,s*c),count:s}},WDUtils.getAccessorTypeSize=function(e){var t=e.type;switch(t){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}},WDUtils.isIWDKeyFrameAnimationAssembler=function(t){if(!e.JudgeUtils.isDirectObject(t))return!1;for(var r in t)return t[r]instanceof wdCb.Collection&&t[r].getCount()>0&&void 0!==t[r].getChild(0).time},WDUtils}();e.WDUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function WDMorphDataParseUtils(){}return WDMorphDataParseUtils.parseMorphData=function(e,t,r){for(var n=wdCb.Hash.create(),i=wdCb.Hash.create(),o=0,a=t;o<a.length;o++){var s=a[o],c=this._getAnimName(s.name);n.appendChild(c,this._getMorphDatas(e,s.vertices,r)),s.normals&&i.appendChild(c,this._getMorphDatas(e,s.normals,r))}return 0===i.getCount()&&(i=null),{morphVertices:n,morphNormals:i}},WDMorphDataParseUtils._getMorphDatas=function(t,r,n){for(var i=t.accessors[r],o=e.WDUtils.getBufferReaderFromAccessor(t,i,n),a=o.bufferReader,s=o.count,c=[],u=0;u<s;u++)c.push(a.readFloat());return c},WDMorphDataParseUtils._getAnimName=function(e){var t=/([a-z]+)_?(\d+)/,r="defaultMorphAnimation",n=e.match(t);return n&&n.length>1?n[1]:r},WDMorphDataParseUtils}();e.WDMorphDataParseUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function WDAssembler(){this._result=wdCb.Hash.create(),this._geometryAssembler=e.WDGeometryAssembler.create(),this._transformAssembler=e.WDTransformAssembler.create(),this._lightAssembler=e.WDLightAssembler.create()}return WDAssembler.create=function(){var e=new this;return e},WDAssembler.prototype.build=function(t){return this._buildMetadata(t),this._buildModels(t),e.EventManager.trigger(e.CustomEvent.create(e.EEngineEvent.AFTER_SCENEGRAPH_BUILD)),this._result},WDAssembler.prototype._buildMetadata=function(e){var t={};for(var r in e.metadata)e.metadata.hasOwnProperty(r)&&(t[r]=e.metadata[r]);this._result.addChild("metadata",t)},WDAssembler.prototype._buildModels=function(t){var r=wdCb.Collection.create(),n=this,i=function(t){var r=e.GameObject.create();return t.name&&(r.name=t.name),n._isModelContainer(t)&&r.addTag(e.EWDTag.CONTAINER),n._addComponentsFromwd(r,t.components),r.addComponent(e.MeshRenderer.create()),t.children&&t.children.forEach(function(e){r.addChild(i(e))}),r};t.objects&&(t.objects.forEach(function(e){r.addChild(i(e))}),this._result.addChild("models",r))},WDAssembler.prototype._isModelContainer=function(e){return e.isContainer},WDAssembler.prototype._addComponentsFromwd=function(t,r){var n=this;r.forEach(function(r){if(n._isTransform(r))t.addComponent(n._transformAssembler.createComponent(r));else if(n._isCamera(r))t.addComponent(n._createCamera(r));else if(n._isLight(r))t.addComponent(n._lightAssembler.createComponent(r));else if(n._isGeometry(r)){var i=n._geometryAssembler.createComponent(r);if(t.addComponent(i),i.morphVertices&&i.morphVertices.getCount()>0){var o=e.ClassUtils.getClass("MorphAnimation");void 0!==o&&t.addComponent(o.create())}}else if(n._isKeyFrameAnimation(r)){var a=e.ClassUtils.getClass("TransformArticulatedAnimation");void 0!==a&&t.addComponent(n._createKeyFrameAnimation(r,a))}else if(n._isSkinSkeleton(r)){var s=e.ClassUtils.getClass("SkinSkeletonAnimation");void 0!==s&&t.addComponent(n._createSkinSkeletonAnimation(r,s))}})},WDAssembler.prototype._isTransform=function(e){return!!e.matrix||!!e.position},WDAssembler.prototype._isCamera=function(e){return!!e.camera},WDAssembler.prototype._isLight=function(e){return!!e.color&&!!e.type},WDAssembler.prototype._isGeometry=function(e){return!!e.material},WDAssembler.prototype._isKeyFrameAnimation=function(t){return e.WDUtils.isIWDKeyFrameAnimationAssembler(t)},WDAssembler.prototype._isSkinSkeleton=function(e){return!!e.jointNames},WDAssembler.prototype._createCamera=function(t){return e.BasicCameraController.create(t.camera)},WDAssembler.prototype._createKeyFrameAnimation=function(e,t){var r=t.create();return r.data=wdCb.Hash.create(e),r},WDAssembler.prototype._createSkinSkeletonAnimation=function(e,t){var r=t.create();return r.bindShapeMatrix=e.bindShapeMatrix,r.inverseBindMatrices=e.inverseBindMatrices,r.boneMatrixMap=e.boneMatrixMap,r.jointNames=e.jointNames,r.jointTransformData=e.jointTransformData,r},WDAssembler}();e.WDAssembler=t}(wd||(wd={}));var wd;!function(e){var t=function(){function WDComponentAssembler(){}return WDComponentAssembler}();e.WDComponentAssembler=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function WDGeometryAssembler(){t.apply(this,arguments)}return __extends(WDGeometryAssembler,t),WDGeometryAssembler.create=function(){var e=new this;return e},WDGeometryAssembler.prototype.createComponent=function(t){var r=e.ModelGeometry.create();return r.vertices=t.vertices,r.faces=t.faces,e.WDUtils.addData(r,"colors",t.colors),e.WDUtils.addData(r,"texCoords",t.texCoords),e.WDUtils.addData(r,"jointIndices",t.jointIndices),e.WDUtils.addData(r,"jointWeights",t.jointWeights),e.WDUtils.addData(r,"morphVertices",t.morphVertices),e.WDUtils.addData(r,"morphNormals",t.morphNormals),r.drawMode=t.drawMode,r.material=this._createMaterial(t.material),r},WDGeometryAssembler.prototype._createMaterial=function(t){var r=null;switch(t.type){case"LightMaterial":r=this._createLightMaterial(t);break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("material type:"+t.type))}return r},WDGeometryAssembler.prototype._createLightMaterial=function(t){return this._createStandardLightMaterial(e.LightMaterial.create(),t)},WDGeometryAssembler.prototype._createStandardLightMaterial=function(t,r){return this._setBasicDataOfMaterial(t,r),r.transparent===!0&&void 0!==r.opacity&&(t.opacity=r.opacity,t.blendType=e.EBlendType.NORMAL),r.lightModel===e.ELightModel.LAMBERT?(e.Log.log(e.Log.info.FUNC_NOT_SUPPORT("LAMBERT light model, use PHONG light model instead")),t.lightModel=e.ELightModel.PHONG):t.lightModel=r.lightModel,e.WDUtils.addData(t,"color",r.diffuseColor),e.WDUtils.addData(t,"specularColor",r.specularColor),e.WDUtils.addData(t,"emissionColor",r.emissionColor),e.WDUtils.addData(t,"diffuseMap",r.diffuseMap),e.WDUtils.addData(t,"specularMap",r.specularMap),e.WDUtils.addData(t,"emissionMap",r.emissionMap),e.WDUtils.addData(t,"lightMap",r.lightMap),e.WDUtils.addData(t,"normalMap",r.normalMap),e.WDUtils.addData(t,"shininess",r.shininess),t},WDGeometryAssembler.prototype._setBasicDataOfMaterial=function(t,r){r.doubleSided&&r.doubleSided===!0?t.side=e.ESide.BOTH:t.side=e.ESide.FRONT},__decorate([e.require(function(t){e.it("material type should always be LightMaterial",function(){e.expect(t.type).equals("LightMaterial")})})],WDGeometryAssembler.prototype,"_createMaterial",null),WDGeometryAssembler}(e.WDComponentAssembler);e.WDGeometryAssembler=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function WDTransformAssembler(){t.apply(this,arguments)}return __extends(WDTransformAssembler,t),WDTransformAssembler.create=function(){var e=new this;return e},WDTransformAssembler.prototype.createComponent=function(t){var r=e.ThreeDTransform.create();return t.matrix?(r.localPosition=t.matrix.getTranslation(),r.localRotation=t.matrix.getRotation(),r.localScale=t.matrix.getScale()):(r.localPosition=t.position,r.localRotation=t.rotation,r.localScale=t.scale),r},WDTransformAssembler}(e.WDComponentAssembler);e.WDTransformAssembler=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function WDLightAssembler(){t.apply(this,arguments)}return __extends(WDLightAssembler,t),WDLightAssembler.create=function(){var e=new this;return e},WDLightAssembler.prototype.createComponent=function(t){var r=null;switch(t.type){case"ambient":r=e.AmbientLight.create(),r.color=t.color;break;case"directional":r=e.DirectionLight.create(),r.color=t.color;break;case"point":r=e.PointLight.create(),r.color=t.color,e.WDUtils.addData(r,"constant",t.constantAttenuation),e.WDUtils.addData(r,"linear",t.linearAttenuation),e.WDUtils.addData(r,"quadratic",t.quadraticAttenuation),e.WDUtils.addData(r,"range",t.range)}return e.WDUtils.addData(r,"intensity",t.intensity),r},WDLightAssembler}(e.WDComponentAssembler);e.WDLightAssembler=t}(wd||(wd={}));var wd;!function(e){var t={".eot":"embedded-opentype",".ttf":"truetype",".woff":"woff",".svg":"svg"},r=function(r){function FontLoader(){r.call(this),this._familyName=null}return __extends(FontLoader,r),FontLoader.getInstance=function(){},FontLoader.prototype.dispose=function(){r.prototype.dispose.call(this),wdCb.DomQuery.create("#"+this._familyName).remove()},FontLoader.prototype.loadAsset=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=t[1],i=this;return this._familyName=n,wdFrp.fromPromise(new e.RSVP.Promise(function(r,o){i._addStyleElement(t,n),document.fonts?document.fonts.load("1em "+n).then(function(){r()},function(e){o(e)}):(e.Log.warn("your browser not support document.fonts api, so it can't ensure that the font is loaded"),r())}))},FontLoader.prototype._getType=function(e){return t[wdCb.PathUtils.extname(e).toLowerCase()]},FontLoader.prototype._addStyleElement=function(t,r){var n=wdCb.DomQuery.create('<style id="'+r+'"></style>'),i=null;if(n.prependTo("body"),i="@font-face { font-family:"+r+"; src:",e.JudgeUtils.isArrayExactly(t[0])){for(var o=t[0],a=0,s=o;a<s.length;a++){var c=s[a];i+="url('"+c+"') format('"+this._getType(c)+"'),"}i=i.replace(/,$/,";")}else{var c=t[0];i+="url('"+c+"') format('"+this._getType(c)+"');"}n.get(0).textContent+=i+"};"},__decorate([e.require(function(r){var n=wdCb.PathUtils.extname(r).toLowerCase();e.assert(!!t[n],e.Log.info.FUNC_UNKNOW("type:"+n))})],FontLoader.prototype,"_getType",null),FontLoader=__decorate([e.singleton()],FontLoader)}(e.Loader);e.FontLoader=r}(wd||(wd={}));var wd;!function(e){var t=/common [^\n]*(\n|$)/gi,r=/page [^\n]*(\n|$)/gi,n=/char [^\n]*(\n|$)/gi,i=/kerning [^\n]*(\n|$)/gi,o=/\w+=[^ \r\n]+/gi,a=/^[\-]?\d+$/,s=function(){function FntParser(){}return FntParser.create=function(){var e=new this;return e},FntParser.prototype.parseFnt=function(n,i){var o={},a=null,s=null;return a=this._parseStrToObj(n.match(t)[0]),o.commonHeight=a.lineHeight,o.commonBase=a.base,o.scaleW=a.scaleW,o.scaleH=a.scaleH,1!==a.pages?o.isMultiPages=!0:o.isMultiPages=!1,s=this._parseStrToObj(n.match(r)[0]),0!==s.id&&e.Log.log("file could not be found"),o.atlasName=wdCb.PathUtils.changeBasename(i,s.file),this._parseChar(n,o),this._parseKerning(n,o),o},FntParser.prototype._parseStrToObj=function(e){var t=e.match(o),r={};if(t)for(var n=0,i=t;n<i.length;n++){var s=i[n],c=s.indexOf("="),u=s.substring(0,c),l=s.substring(c+1);l.match(a)?l=parseInt(l):'"'==l[0]&&(l=l.substring(1,l.length-1)),r[u]=l}return r},FntParser.prototype._parseChar=function(e,t){for(var r=e.match(n),i={},o=0,a=r;o<a.length;o++){var s=a[o],c=this._parseStrToObj(s),u=c.id;i[u]={id:u,rect:{x:c.x,y:c.y,width:c.width,height:c.height},xOffset:c.xoffset,yOffset:c.yoffset,xAdvance:c.xadvance,page:c.page}}t.fontDefDictionary=i},FntParser.prototype._parseKerning=function(e,t){var r=e.match(i),n=[];if(null===r)return void(t.kerningArray=[]);for(var o=0,a=r;o<a.length;o++){var s=a[o],c=this._parseStrToObj(s);n.push({first:c.first,second:c.second,amount:c.amount})}t.kerningArray=n},FntParser}();e.FntParser=s}(wd||(wd={}));var wd;!function(e){var t=function(t){function FntLoader(){t.call(this),this._parser=e.FntParser.create()}return __extends(FntLoader,t),FntLoader.getInstance=function(){},FntLoader.prototype.loadAsset=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=t[0],i=this;return e.AjaxLoader.load(n,"text").map(function(e){return i._parser.parseFnt(e,n)})},__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];e.assert(!e.JudgeUtils.isArrayExactly(t[0]),e.Log.info.FUNC_MUST_BE("url","string"))})],FntLoader.prototype,"loadAsset",null),FntLoader=__decorate([e.singleton()],FntLoader)}(e.Loader);e.FntLoader=t}(wd||(wd={}));var wd;!function(e){var t=function(){function DeviceManager(){this._scissorTest=!1,this._depthTest=null,this._depthFunc=null,this._side=null,this.polygonOffset=null,this._polygonOffsetMode=null,this._depthWrite=null,this._blend=null,this._alphaToCoverage=null,this.view=null,this.gl=null,this.contextConfig=null,this._writeRed=null,this._writeGreen=null,this._writeBlue=null,this._writeAlpha=null,this._blendSrc=null,this._blendDst=null,this._blendEquation=null,this._blendFuncSeparate=null,this._blendEquationSeparate=null,this._scissorRegion=e.RectRegion.create(),this._viewport=e.RectRegion.create(),this._clearColor=null,this._pixelRatio=null}return DeviceManager.getInstance=function(){},Object.defineProperty(DeviceManager.prototype,"scissorTest",{get:function(){return this._scissorTest},set:function(e){var t=this.gl;this._scissorTest!==e&&(e?t.enable(t.SCISSOR_TEST):t.disable(t.SCISSOR_TEST),this._scissorTest=e)},enumerable:!0,configurable:!0}),DeviceManager.prototype.setScissor=function(e,t,r,n){this._scissorRegion.y===t&&this._scissorRegion.width===r&&this._scissorRegion.height===n||(this.gl.scissor(e,t,r,n),this._scissorRegion.set(e,t,r,n),this.scissorTest=!0)},DeviceManager.prototype.setViewport=function(e,t,r,n){this._viewport.x===e&&this._viewport.y===t&&this._viewport.width===r&&this._viewport.height===n||(this._viewport.set(e,t,r,n),this.gl.viewport(e,t,r,n))},DeviceManager.prototype.getViewport=function(){return this._viewport},Object.defineProperty(DeviceManager.prototype,"depthTest",{get:function(){return this._depthTest},set:function(e){var t=this.gl;this._depthTest!==e&&(e?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST),this._depthTest=e)},enumerable:!0,configurable:!0}),Object.defineProperty(DeviceManager.prototype,"depthFunc",{get:function(){return this._depthFunc},set:function(e){var t=this.gl;this._depthFunc!==e&&(t.depthFunc(t[e]),this._depthFunc=e)},enumerable:!0,configurable:!0}),Object.defineProperty(DeviceManager.prototype,"side",{get:function(){return this._side},set:function(t){var n=this.gl;if(this._side!==t){switch(t){case r.NONE:n.enable(n.CULL_FACE),n.cullFace(n.FRONT_AND_BACK);break;case r.BOTH:n.disable(n.CULL_FACE);break;case r.FRONT:n.enable(n.CULL_FACE),n.cullFace(n.BACK);break;case r.BACK:n.enable(n.CULL_FACE),n.cullFace(n.FRONT);break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("side",t))}this._side=t}},enumerable:!0,configurable:!0}),Object.defineProperty(DeviceManager.prototype,"polygonOffsetMode",{get:function(){return this._polygonOffsetMode},set:function(t){var r=this.gl;if(this._polygonOffsetMode!==t){switch(t){case n.NONE:r.polygonOffset(0,0),r.disable(r.POLYGON_OFFSET_FILL);break;case n.IN:r.enable(r.POLYGON_OFFSET_FILL),r.polygonOffset(1,1);break;case n.OUT:r.enable(r.POLYGON_OFFSET_FILL),r.polygonOffset(-1,-1);break;case n.CUSTOM:r.enable(r.POLYGON_OFFSET_FILL),e.Log.error(!this.polygonOffset,e.Log.info.FUNC_MUST_DEFINE("polygonOffset")),r.polygonOffset(this.polygonOffset.x,this.polygonOffset.y)}this._polygonOffsetMode=t}},enumerable:!0,configurable:!0}),Object.defineProperty(DeviceManager.prototype,"depthWrite",{get:function(){return this._depthWrite},set:function(e){this._depthWrite!==e&&(this.gl.depthMask(e),this._depthWrite=e)},enumerable:!0,configurable:!0}),Object.defineProperty(DeviceManager.prototype,"blend",{get:function(){return this._blend},set:function(e){var t=this.gl;this._blend!==e&&(e?t.enable(t.BLEND):t.disable(t.BLEND),this._blend=e)},enumerable:!0,configurable:!0}),Object.defineProperty(DeviceManager.prototype,"alphaToCoverage",{get:function(){return this._alphaToCoverage},set:function(e){var t=this.gl;this._alphaToCoverage!==e&&(e?t.enable(t.SAMPLE_ALPHA_TO_COVERAGE):t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),this._alphaToCoverage=e)},enumerable:!0,configurable:!0}),DeviceManager.prototype.setBlendFunc=function(e,t){this._blendSrc===e&&this._blendDst===t||(this._blend&&this.gl.blendFunc(this.gl[e],this.gl[t]),this._blendSrc=e,this._blendDst=t)},DeviceManager.prototype.setBlendEquation=function(e){this._blendEquation!==e&&(this._blend&&this.gl.blendEquation(this.gl[e]),this._blendEquation=e)},DeviceManager.prototype.setBlendFuncSeparate=function(e){var t=this.gl;this._blendFuncSeparate&&this._blendFuncSeparate[0]===e[0]&&this._blendFuncSeparate[1]===e[1]||(this._blend&&t.blendFuncSeparate(t[e[0]],t[e[1]],t[e[2]],t[e[3]]),this._blendFuncSeparate=e)},DeviceManager.prototype.setBlendEquationSeparate=function(e){var t=this.gl;this._blendEquationSeparate&&this._blendEquationSeparate[0]===e[0]&&this._blendEquationSeparate[1]===e[1]||(this._blend&&t.blendEquationSeparate(t[e[0]],t[e[1]]),this._blendEquationSeparate=e)},DeviceManager.prototype.setColorWrite=function(e,t,r,n){this._writeRed===e&&this._writeGreen===t&&this._writeBlue===r&&this._writeAlpha===n||(this.gl.colorMask(e,t,r,n),this._writeRed=e,this._writeGreen=t,this._writeBlue=r,this._writeAlpha=n)},DeviceManager.prototype.clear=function(e){var t=this.gl,r=e.color;this._setClearColor(r),this.setColorWrite(!0,!0,!0,!0),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT)},DeviceManager.prototype.createGL=function(t,r,n){var i=null;this.contextConfig=r,i=t?wdCb.DomQuery.create(this._getCanvasId(t)).get(0):wdCb.DomQuery.create("<canvas></canvas>").prependTo("body").get(0),this.view=e.ViewWebGL.create(i),n&&this.setPixelRatio(e.root.devicePixelRatio),this.gl=this.view.getContext(r),this.gl||(wdCb.DomQuery.create("<p class='not-support-webgl'></p>").prependTo("body").get(0).innerText="Your device doesn't support WebGL")},DeviceManager.prototype.setScreen=function(){var t=e.Main.screenSize,r=null,n=null,i=null,o=null,a=null,s=null;t===e.EScreenSize.FULL?(r=0,n=0,i=e.root.innerWidth,o=e.root.innerHeight,a="100%",s="100%",wdCb.DomQuery.create("body").css("margin","0")):(r=t.x||0,n=t.y||0,i=t.width||e.root.innerWidth,o=t.height||e.root.innerHeight,a=i+"px",s=o+"px"),this.view.initCanvas(),this.view.x=r,this.view.y=n,this.view.width=i,this.view.height=o,this.view.styleWidth=a,this.view.styleHeight=s,this.setViewport(0,0,i,o)},DeviceManager.prototype.setHardwareScaling=function(e){var t=this.view.width/e,r=this.view.height/e;this.view.width=t,this.view.height=r,this.setViewport(0,0,t,r)},DeviceManager.prototype.setPixelRatio=function(e){this.view.width=Math.round(this.view.width*e),this.view.height=Math.round(this.view.height*e),this._pixelRatio=e},DeviceManager.prototype.getPixelRatio=function(){return this._pixelRatio},DeviceManager.prototype._setClearColor=function(e){this._clearColor&&this._clearColor.isEqual(e)||(this.gl.clearColor(e.r,e.g,e.b,e.a),this._clearColor=e)},DeviceManager.prototype._getCanvasId=function(e){return e.indexOf("#")>-1?e:"#"+e},__decorate([e.require(function(){e.it("should exist Main.screenSize",function(){e.expect(e.Main.screenSize).exist})})],DeviceManager.prototype,"setScreen",null),__decorate([e.require(function(t){e.it("level should > 0, but actual is "+t,function(){e.expect(t).greaterThan(0)})})],DeviceManager.prototype,"setHardwareScaling",null),__decorate([e.ensure(function(t){e.it("canvas id should be #xxx",function(){e.expect(/#[^#]+/.test(t))["true"]})})],DeviceManager.prototype,"_getCanvasId",null),DeviceManager=__decorate([e.singleton()],DeviceManager)}();e.DeviceManager=t,function(e){e[e.NEVER="NEVER"]="NEVER",e[e.ALWAYS="ALWAYS"]="ALWAYS",e[e.LESS="LESS"]="LESS",e[e.LEQUAL="LEQUAL"]="LEQUAL",e[e.EQUAL="EQUAL"]="EQUAL",e[e.GEQUAL="GEQUAL"]="GEQUAL",e[e.GREATER="GREATER"]="GREATER",e[e.NOTEQUAL="NOTEQUAL"]="NOTEQUAL"}(e.EDepthFunction||(e.EDepthFunction={}));e.EDepthFunction;!function(e){e[e.NONE=0]="NONE",e[e.BOTH=1]="BOTH",e[e.BACK=2]="BACK",e[e.FRONT=3]="FRONT"}(e.ESide||(e.ESide={}));var r=e.ESide;!function(e){e[e.NONE=0]="NONE",e[e.IN=1]="IN",e[e.OUT=2]="OUT",e[e.CUSTOM=3]="CUSTOM"}(e.EPolygonOffsetMode||(e.EPolygonOffsetMode={}));var n=e.EPolygonOffsetMode;!function(e){e[e.ZERO="ZEOR"]="ZERO",e[e.ONE="ONE"]="ONE",e[e.SRC_COLOR="SRC_COLOR"]="SRC_COLOR",e[e.ONE_MINUS_SRC_COLOR="ONE_MINUS_SRC_COLOR"]="ONE_MINUS_SRC_COLOR",e[e.DST_COLOR="DST_COLOR"]="DST_COLOR",e[e.ONE_MINUS_DST_COLOR="ONE_MINUS_DST_COLOR"]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA="SRC_ALPHA"]="SRC_ALPHA",e[e.SRC_ALPHA_SATURATE="SRC_ALPHA_SATURATE"]="SRC_ALPHA_SATURATE",e[e.ONE_MINUS_SRC_ALPHA="ONE_MINUS_SRC_ALPHA"]="ONE_MINUS_SRC_ALPHA",e[e.DST_ALPHA="DST_ALPHA"]="DST_ALPHA",e[e.ONE_MINUS_DST_ALPH="ONE_MINUS_DST_ALPHA"]="ONE_MINUS_DST_ALPH"}(e.EBlendFunc||(e.EBlendFunc={}));e.EBlendFunc;!function(e){e[e.ADD="FUNC_ADD"]="ADD",e[e.SUBTRACT="FUNC_SUBTRACT"]="SUBTRACT",e[e.REVERSE_SUBTRAC="FUNC_REVERSE_SUBTRACT"]="REVERSE_SUBTRAC"}(e.EBlendEquation||(e.EBlendEquation={}));e.EBlendEquation;!function(e){e[e.NONE=0]="NONE",e[e.NORMAL=1]="NORMAL",e[e.ADDITIVE=2]="ADDITIVE",e[e.ADDITIVEALPHA=3]="ADDITIVEALPHA",e[e.MULTIPLICATIVE=4]="MULTIPLICATIVE",
e[e.PREMULTIPLIED=5]="PREMULTIPLIED"}(e.EBlendType||(e.EBlendType={}));e.EBlendType;!function(e){e[e.TwoDUI="TwoDUI"]="TwoDUI"}(e.ECanvasType||(e.ECanvasType={}));e.ECanvasType}(wd||(wd={}));var wd;!function(e){var t=function(){function GPUDetector(){this.maxTextureUnit=null,this.maxTextureSize=null,this.maxCubemapTextureSize=null,this.maxAnisotropy=null,this.maxBoneCount=null,this.extensionCompressedTextureS3TC=null,this.extensionTextureFilterAnisotropic=null,this.extensionInstancedArrays=null,this.extensionUintIndices=null,this.extensionDepthTexture=null,this.extensionVAO=null,this.extensionStandardDerivatives=null,this.precision=null,this._isDetected=!1}return GPUDetector.getInstance=function(){},Object.defineProperty(GPUDetector.prototype,"gl",{get:function(){return e.DeviceManager.getInstance().gl},enumerable:!0,configurable:!0}),GPUDetector.prototype.detect=function(){this._isDetected=!0,this._detectExtension(),this._detectCapabilty()},GPUDetector.prototype._detectExtension=function(){this.extensionCompressedTextureS3TC=this._getExtension("WEBGL_compressed_texture_s3tc"),this.extensionTextureFilterAnisotropic=this._getExtension("EXT_texture_filter_anisotropic"),this.extensionInstancedArrays=this._getExtension("ANGLE_instanced_arrays"),this.extensionUintIndices=this._getExtension("element_index_uint"),this.extensionDepthTexture=this._getExtension("depth_texture"),this.extensionVAO=this._getExtension("vao"),this.extensionStandardDerivatives=this._getExtension("standard_derivatives")},GPUDetector.prototype._detectCapabilty=function(){var e=this.gl;this.maxTextureUnit=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.maxCubemapTextureSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxAnisotropy=this._getMaxAnisotropy(),this.maxBoneCount=this._getMaxBoneCount(),alert("maxBoneCount:"+this.maxBoneCount),this._detectPrecision()},GPUDetector.prototype._getExtension=function(e){var t,r=this.gl;switch(e){case"EXT_texture_filter_anisotropic":t=r.getExtension("EXT_texture_filter_anisotropic")||r.getExtension("MOZ_EXT_texture_filter_anisotropic")||r.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":t=r.getExtension("WEBGL_compressed_texture_s3tc")||r.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||r.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":t=r.getExtension("WEBGL_compressed_texture_pvrtc")||r.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;case"ANGLE_instanced_arrays":t=r.getExtension("ANGLE_instanced_arrays");break;case"element_index_uint":t=null!==r.getExtension("OES_element_index_uint");break;case"depth_texture":t=null!==r.getExtension("WEBKIT_WEBGL_depth_texture")||null!==r.getExtension("WEBGL_depth_texture");break;case"vao":t=r.getExtension("OES_vertex_array_object");break;case"standard_derivatives":t=r.getExtension("OES_standard_derivatives");break;default:t=r.getExtension(e)}return t},GPUDetector.prototype._getMaxBoneCount=function(){var e=this.gl,t=null,r=null;return t=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),t-=16,t-=1,t-=16,r=Math.floor(t/4),Math.min(r,128)},GPUDetector.prototype._getMaxAnisotropy=function(){var e=this.extensionTextureFilterAnisotropic,t=this.gl;return null!==e?t.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0},GPUDetector.prototype._detectPrecision=function(){var t=this.gl;if(!t.getShaderPrecisionFormat)return void(this.precision=r.HIGHP);var n=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT),i=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT),o=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT),a=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT),s=n.precision>0&&o.precision>0,c=i.precision>0&&a.precision>0;s?this.precision=r.HIGHP:c?(this.precision=r.MEDIUMP,e.Log.warn(e.Log.info.FUNC_NOT_SUPPORT("gpu","highp, using mediump"))):(this.precision=r.LOWP,e.Log.warn(e.Log.info.FUNC_NOT_SUPPORT("gpu","highp and mediump, using lowp")))},GPUDetector=__decorate([e.singleton()],GPUDetector)}();e.GPUDetector=t,function(e){e[e.HIGHP=0]="HIGHP",e[e.MEDIUMP=1]="MEDIUMP",e[e.LOWP=2]="LOWP"}(e.EGPUPrecision||(e.EGPUPrecision={}));var r=e.EGPUPrecision}(wd||(wd={}));var wd;!function(e){!function(e){e[e.FULL=0]="FULL"}(e.EScreenSize||(e.EScreenSize={}));e.EScreenSize}(wd||(wd={}));var wd;!function(e){var t=function(){function Point(e,t){void 0===e&&(e=null),void 0===t&&(t=null),this.x=null,this.y=null,this.x=e,this.y=t}return Point.create=function(e,t){void 0===e&&(e=null),void 0===t&&(t=null);var r=new this(e,t);return r},Point}();e.Point=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Face3(e,t,r,n,i){this._faceNormal=null,this.aIndex=null,this.bIndex=null,this.cIndex=null,this.vertexNormals=null,this.aIndex=e,this.bIndex=t,this.cIndex=r,this._faceNormal=n,this.vertexNormals=i}return Face3.create=function(e,t,r,n,i){void 0===n&&(n=null),void 0===i&&(i=wdCb.Collection.create());var o=new this(e,t,r,n,i);return o},Object.defineProperty(Face3.prototype,"faceNormal",{get:function(){return null!==this._faceNormal?this._faceNormal:e.Vector3.create(0,0,0)},set:function(e){this._faceNormal=e},enumerable:!0,configurable:!0}),Face3.prototype.clone=function(){return e.CloneUtils.clone(this)},Face3.prototype.hasFaceNormal=function(){return null!==this._faceNormal},Face3.prototype.hasVertexNormal=function(){return this.vertexNormals.getCount()>0},__decorate([e.cloneAttributeAsCloneable()],Face3.prototype,"_faceNormal",void 0),__decorate([e.cloneAttributeAsBasicType()],Face3.prototype,"aIndex",void 0),__decorate([e.cloneAttributeAsBasicType()],Face3.prototype,"bIndex",void 0),__decorate([e.cloneAttributeAsBasicType()],Face3.prototype,"cIndex",void 0),__decorate([e.cloneAttributeAsCustomType(function(e,t,r){t[r]=e[r].clone(!0)})],Face3.prototype,"vertexNormals",void 0),Face3}();e.Face3=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function RectRegion(){e.apply(this,arguments)}return __extends(RectRegion,e),Object.defineProperty(RectRegion.prototype,"width",{get:function(){return this.z},set:function(e){this.z=e},enumerable:!0,configurable:!0}),Object.defineProperty(RectRegion.prototype,"height",{get:function(){return this.w},set:function(e){this.w=e},enumerable:!0,configurable:!0}),RectRegion.prototype.clone=function(){return this.copyHelper(RectRegion.create())},RectRegion.prototype.isNotEmpty=function(){return 0!==this.x||0!==this.y||0!==this.width||0!==this.height},RectRegion}(e.Vector4);e.RectRegion=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ViewWebGL(e){this._dom=null,this._dom=e}return ViewWebGL.create=function(e){var t=new this(e);return t},Object.defineProperty(ViewWebGL.prototype,"offset",{get:function(){for(var e=this._dom,t={x:e.offsetLeft,y:e.offsetTop};e=e.offsetParent;)t.x+=e.offsetLeft,t.y+=e.offsetTop;return t},enumerable:!0,configurable:!0}),Object.defineProperty(ViewWebGL.prototype,"dom",{get:function(){return this._dom},enumerable:!0,configurable:!0}),Object.defineProperty(ViewWebGL.prototype,"width",{get:function(){return this._dom.clientWidth},set:function(e){this._dom.width=e},enumerable:!0,configurable:!0}),Object.defineProperty(ViewWebGL.prototype,"height",{get:function(){return this._dom.clientHeight},set:function(e){this._dom.height=e},enumerable:!0,configurable:!0}),Object.defineProperty(ViewWebGL.prototype,"styleWidth",{get:function(){return this._dom.style.width},set:function(e){this._dom.style.width=e},enumerable:!0,configurable:!0}),Object.defineProperty(ViewWebGL.prototype,"styleHeight",{get:function(){return this._dom.style.height},set:function(e){this._dom.style.height=e},enumerable:!0,configurable:!0}),Object.defineProperty(ViewWebGL.prototype,"x",{get:function(){return Number(this._dom.style.left.slice(0,-2))},set:function(e){this._dom.style.left=e+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(ViewWebGL.prototype,"y",{get:function(){return Number(this._dom.style.top.slice(0,-2))},set:function(e){this._dom.style.top=e+"px"},enumerable:!0,configurable:!0}),ViewWebGL.prototype.initCanvas=function(){this._dom.style.cssText="position:absolute;left:0;top:0;"},ViewWebGL.prototype.getContext=function(e){return this._dom.getContext("webgl",e.options)||this._dom.getContext("experimental-webgl",e.options)},ViewWebGL}();e.ViewWebGL=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Color(){this._r=null,this._g=null,this._b=null,this._a=null,this._colorString=null,this._colorVec3Cache=null,this._colorVec4Cache=null}return Color.create=function(e){var t=new this;return t.initWhenCreate(e),t},Object.defineProperty(Color.prototype,"dirty",{set:function(e){e&&this._clearCache()},enumerable:!0,configurable:!0}),Object.defineProperty(Color.prototype,"r",{get:function(){return this._r},set:function(e){this._r!==e&&(this.dirty=!0,this._r=e)},enumerable:!0,configurable:!0}),Object.defineProperty(Color.prototype,"g",{get:function(){return this._g},set:function(e){this._g!==e&&(this.dirty=!0,this._g=e)},enumerable:!0,configurable:!0}),Object.defineProperty(Color.prototype,"b",{get:function(){return this._b},set:function(e){this._b!==e&&(this.dirty=!0,this._b=e)},enumerable:!0,configurable:!0}),Object.defineProperty(Color.prototype,"a",{get:function(){return this._a},set:function(e){this._a!==e&&(this.dirty=!0,this._a=e)},enumerable:!0,configurable:!0}),Color.prototype.initWhenCreate=function(e){e&&(this._colorString=e,this._setColor(e))},Color.prototype.toVector3=function(){return e.Vector3.create(this.r,this.g,this.b)},Color.prototype.toVector4=function(){return e.Vector4.create(this.r,this.g,this.b,this.a)},Color.prototype.toString=function(){return this._colorString},Color.prototype.clone=function(){return Color.create(this._colorString)},Color.prototype.isEqual=function(e){return this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a},Color.prototype._setColor=function(e){var t=/^rgba\((\d+),\s*(\d+),\s*(\d+),\s*([^\)]+)\)$/i,r=/^rgba\((\d+\.\d+),\s*(\d+\.\d+),\s*(\d+\.\d+),\s*([^\)]+)\)$/i,n=/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/i,i=/^rgb\((\d+\.\d+),\s*(\d+\.\d+),\s*(\d+\.\d+)\)$/i,o=/^\#([0-9a-f]{6})$/i,a=null;return t.test(e)?(a=t.exec(e),this.r=this._getColorValue(a,1),this.g=this._getColorValue(a,2),this.b=this._getColorValue(a,3),this.a=Number(a[4]),this):r.test(e)?(a=r.exec(e),this.r=parseFloat(a[1]),this.g=parseFloat(a[2]),this.b=parseFloat(a[3]),this.a=Number(a[4]),this):n.test(e)?(a=n.exec(e),this.r=this._getColorValue(a,1),this.g=this._getColorValue(a,2),this.b=this._getColorValue(a,3),this.a=1,this):i.test(e)?(a=i.exec(e),this.r=parseFloat(a[1]),this.g=parseFloat(a[2]),this.b=parseFloat(a[3]),this.a=1,this):o.test(e)?(a=o.exec(e),this._setHex(parseInt(a[1],16)),this):void 0},Color.prototype._getColorValue=function(e,t,r){return void 0===r&&(r=255),Math.min(r,parseInt(e[t],10))/r},Color.prototype._setHex=function(e){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,this.a=1,this},Color.prototype._clearCache=function(){this._colorVec3Cache=null,this._colorVec4Cache=null},__decorate([e.ensureGetter(function(t){e.assert(t>=0,e.Log.info.FUNC_SHOULD("r",">= 0, but actual is "+t))})],Color.prototype,"r",null),__decorate([e.ensureGetter(function(t){e.assert(t>=0,e.Log.info.FUNC_SHOULD("g",">= 0, but actual is "+t))})],Color.prototype,"g",null),__decorate([e.ensureGetter(function(t){e.assert(t>=0,e.Log.info.FUNC_SHOULD("b",">= 0, but actual is "+t))})],Color.prototype,"b",null),__decorate([e.ensureGetter(function(t){e.assert(t>=0,e.Log.info.FUNC_SHOULD("a",">= 0, but actual is "+t))})],Color.prototype,"a",null),__decorate([e.cache(function(){return null!==this._colorVec3Cache},function(){return this._colorVec3Cache},function(e){this._colorVec3Cache=e})],Color.prototype,"toVector3",null),__decorate([e.cache(function(){return null!==this._colorVec4Cache},function(){return this._colorVec4Cache},function(e){this._colorVec4Cache=e})],Color.prototype,"toVector4",null),Color}();e.Color=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function Texture(){t.apply(this,arguments),this.name="",this.material=null,this.width=null,this.height=null,this.variableData=null,this.wrapS=null,this.wrapT=null,this.magFilter=null,this.minFilter=null,this.glTexture=null,this.needUpdate=null,this.target=e.ETextureTarget.TEXTURE_2D}return __extends(Texture,t),Object.defineProperty(Texture.prototype,"geometry",{get:function(){return this.material.geometry},enumerable:!0,configurable:!0}),Texture.prototype.clone=function(){return e.CloneUtils.clone(this)},Texture.prototype.bindToUnit=function(t){var r=e.DeviceManager.getInstance().gl;if(!e.TextureCache.isCached(t,this))return e.TextureCache.addActiveTexture(t,this),r.activeTexture(r["TEXTURE"+String(t)]),r.bindTexture(r[this.target],this.glTexture),this},Texture.prototype.sendData=function(e,t,r){e.sendUniformData(t,this.getSamplerType(),r)},Texture.prototype.dispose=function(){var t=e.DeviceManager.getInstance().gl;t.deleteTexture(this.glTexture),delete this.glTexture,this._unBindAllUnit()},Texture.prototype.filterFallback=function(t){return t===e.ETextureFilterMode.NEAREST||t===e.ETextureFilterMode.NEAREST_MIPMAP_MEAREST||t===e.ETextureFilterMode.NEAREST_MIPMAP_LINEAR?e.ETextureFilterMode.NEAREST:e.ETextureFilterMode.LINEAR},Texture.prototype.getSamplerNameByVariableData=function(t,r){var n=null;return this.variableData?this.variableData.samplerVariableName&&(n=this.variableData.samplerVariableName):n=r===e.EVariableType.SAMPLER_2D?"u_sampler2D"+t:"u_samplerCube"+t,n},Texture.prototype.getSamplerType=function(){var t=null;switch(this.target){case e.ETextureTarget.TEXTURE_2D:t=e.EVariableType.SAMPLER_2D;break;case e.ETextureTarget.TEXTURE_CUBE_MAP:t=e.EVariableType.SAMPLER_CUBE}return t},Texture.prototype.isSourcePowerOfTwo=function(){return e.TextureUtils.isPowerOfTwo(this.width,this.height)},Texture.prototype.setTextureParameters=function(t,r){var n=e.DeviceManager.getInstance().gl;r?(n.texParameteri(t,n.TEXTURE_WRAP_S,n[this.wrapS]),n.texParameteri(t,n.TEXTURE_WRAP_T,n[this.wrapT]),n.texParameteri(t,n.TEXTURE_MAG_FILTER,n[this.magFilter]),n.texParameteri(t,n.TEXTURE_MIN_FILTER,n[this.minFilter])):(n.texParameteri(t,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(t,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(t,n.TEXTURE_MAG_FILTER,n[this.filterFallback(this.magFilter)]),n.texParameteri(t,n.TEXTURE_MIN_FILTER,n[this.filterFallback(this.minFilter)]))},Texture.prototype._unBindAllUnit=function(){for(var t=e.DeviceManager.getInstance().gl,r=e.GPUDetector.getInstance().maxTextureUnit,n=0;n<r;n++)t.activeTexture(t["TEXTURE"+n]),t.bindTexture(t.TEXTURE_2D,null),t.bindTexture(t.TEXTURE_CUBE_MAP,null);e.TextureCache.clearAllBindTextureUnitCache()},__decorate([e.cloneAttributeAsBasicType()],Texture.prototype,"name",void 0),__decorate([e.cloneAttributeAsBasicType()],Texture.prototype,"material",void 0),__decorate([e.cloneAttributeAsBasicType()],Texture.prototype,"width",void 0),__decorate([e.cloneAttributeAsBasicType()],Texture.prototype,"height",void 0),__decorate([e.cloneAttributeAsBasicType()],Texture.prototype,"variableData",void 0),__decorate([e.cloneAttributeAsBasicType()],Texture.prototype,"wrapS",void 0),__decorate([e.cloneAttributeAsBasicType()],Texture.prototype,"wrapT",void 0),__decorate([e.cloneAttributeAsBasicType()],Texture.prototype,"magFilter",void 0),__decorate([e.cloneAttributeAsBasicType()],Texture.prototype,"minFilter",void 0),__decorate([e.cloneAttributeAsBasicType()],Texture.prototype,"needUpdate",void 0),__decorate([e.require(function(t,r){var n=e.GPUDetector.getInstance().maxTextureUnit;e.assert(t>=0,e.Log.info.FUNC_SHOULD("texture unit",">= 0, but actual is "+t)),e.assert(t<n,"trying to cache "+t+" texture units, but GPU only supports "+n+" units")})],Texture.prototype,"bindToUnit",null),__decorate([e.virtual],Texture.prototype,"isSourcePowerOfTwo",null),Texture}(e.Entity);e.Texture=t}(wd||(wd={}));var wd;!function(e){var t=function(){function TextureUtils(){}return TextureUtils.isPowerOfTwo=function(t,r){return e.JudgeUtils.isPowerOfTwo(t)&&e.JudgeUtils.isPowerOfTwo(r)},TextureUtils}();e.TextureUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function BasicTextureUtils(){t.apply(this,arguments)}return __extends(BasicTextureUtils,t),BasicTextureUtils.isDrawPartOfTexture=function(t,r){return t&&t.isNotEmpty()&&r===e.ETextureSourceRegionMethod.DRAW_IN_CANVAS},BasicTextureUtils.drawPartOfTextureByCanvas=function(e,t,r,n,i,o,a,s,c,u,l){var h=wdCb.DomQuery.create("<canvas></canvas>").get(0),d=null;return h.width=t,h.height=r,d=h.getContext("2d"),d.drawImage(e,n,i,o,a,s,c,u,l),h},BasicTextureUtils.isSourcePowerOfTwo=function(e,t,r,n){return this.isDrawPartOfTexture(e,t)?this.isPowerOfTwo(e.width,e.height):this.isPowerOfTwo(r,n)},BasicTextureUtils.needClampMaxSize=function(e,t,r){return t>e||r>e},BasicTextureUtils.clampToMaxSize=function(t,r){var n=null,i=null,o=null,a=null;return n=Math.max(t.width,t.height),i=Math.floor(t.width*r/n),o=Math.floor(t.height*r/n),a=this.drawPartOfTextureByCanvas(t,i,o,0,0,t.width,t.height,0,0,i,o),e.Log.log("source is too big (width:"+t.width+", height:"+t.height+"), resize it to be width:"+a.width+", height:"+a.height+"."),a},BasicTextureUtils}(e.TextureUtils);e.BasicTextureUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function RenderTargetTexture(){t.apply(this,arguments),this._renderRate=1}return __extends(RenderTargetTexture,t),Object.defineProperty(RenderTargetTexture.prototype,"renderRate",{get:function(){return this._renderRate},set:function(e){this._renderRate=e},enumerable:!0,configurable:!0}),RenderTargetTexture.prototype.initWhenCreate=function(){this.needUpdate=!1,this.minFilter=e.ETextureFilterMode.LINEAR,this.magFilter=e.ETextureFilterMode.LINEAR,this.wrapS=e.ETextureWrapMode.CLAMP_TO_EDGE,this.wrapT=e.ETextureWrapMode.CLAMP_TO_EDGE},RenderTargetTexture.prototype.init=function(){},RenderTargetTexture.prototype.update=function(){},RenderTargetTexture.prototype.getPosition=function(){return this.geometry.entityObject.transform.position},RenderTargetTexture.prototype.setEmptyTexture=function(t){var r=e.DeviceManager.getInstance().gl;r.bindTexture(r[this.target],t),this.setTextureParameters(r[this.target],this.isSourcePowerOfTwo())},__decorate([e.require(function(t){e.assert(!!t,e.Log.info.FUNC_NOT_EXIST("texture object"))})],RenderTargetTexture.prototype,"setEmptyTexture",null),RenderTargetTexture}(e.Texture);e.RenderTargetTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function TwoDRenderTargetTexture(){t.apply(this,arguments),this._renderList=null}return __extends(TwoDRenderTargetTexture,t),Object.defineProperty(TwoDRenderTargetTexture.prototype,"renderList",{get:function(){return this._renderList},set:function(t){e.JudgeUtils.isArrayExactly(t)?this._renderList=wdCb.Collection.create(t):this._renderList=t},enumerable:!0,configurable:!0}),TwoDRenderTargetTexture.prototype.initWhenCreate=function(){t.prototype.initWhenCreate.call(this),this.width=256,this.height=256},TwoDRenderTargetTexture.prototype.createEmptyTexture=function(){var t=e.DeviceManager.getInstance().gl,r=t.createTexture();this.setEmptyTexture(r),this.texImageEmpty(),this.glTexture=r},TwoDRenderTargetTexture.prototype.texImageEmpty=function(){var t=e.DeviceManager.getInstance().gl;t.texImage2D(t[this.target],0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,null)},__decorate([e.requireSetter(function(t){e.assert(e.JudgeUtils.isArrayExactly(t)||e.JudgeUtils.isCollection(t),e.Log.info.FUNC_MUST_BE("renderList","array or collection"))}),e.cloneAttributeAsCloneable()],TwoDRenderTargetTexture.prototype,"renderList",null),__decorate([e.virtual],TwoDRenderTargetTexture.prototype,"texImageEmpty",null),TwoDRenderTargetTexture}(e.RenderTargetTexture);e.TwoDRenderTargetTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ProceduralTexture(){t.apply(this,arguments),this.repeatRegion=e.RectRegion.create(0,0,1,1)}return __extends(ProceduralTexture,t),Object.defineProperty(ProceduralTexture.prototype,"sourceRegionForGLSL",{get:function(){return e.RectRegion.create(0,0,1,1)},enumerable:!0,configurable:!0}),ProceduralTexture.prototype.initWhenCreate=function(){t.prototype.initWhenCreate.call(this),this.renderRate=0},ProceduralTexture.prototype.getSamplerName=function(t){return this.getSamplerNameByVariableData(t,e.EVariableType.SAMPLER_2D)},__decorate([e.cloneAttributeAsCloneable()],ProceduralTexture.prototype,"repeatRegion",void 0),ProceduralTexture}(e.TwoDRenderTargetTexture);e.ProceduralTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CustomProceduralTexture(){t.apply(this,arguments),this.mapManager=e.MapManager.create(),this.uniformMap=wdCb.Hash.create(),this.fsSource=null}return __extends(CustomProceduralTexture,t),CustomProceduralTexture.create=function(){var e=new this;return e.initWhenCreate(),e},CustomProceduralTexture.prototype.init=function(){return t.prototype.init.call(this),e.Director.getInstance().scene.addProceduralRenderTargetRenderer(e.CustomProceduralRenderTargetRenderer.create(this)),this.mapManager.init(),this},CustomProceduralTexture.prototype.read=function(t){var r=e.LoaderManager.getInstance().get(t),n=r.uniforms;this.fsSource=e.LoaderManager.getInstance().get(r.fsSourceId),this.renderRate=r.renderRate||0;for(var i in n)if(n.hasOwnProperty(i)){var o=n[i];o.type===e.EVariableType.SAMPLER_2D?this.mapManager.addMap(e.LoaderManager.getInstance().get(o.textureId),{samplerVariableName:i}):this.uniformMap.addChild(i,o)}},__decorate([e.cloneAttributeAsCustomType(function(e,t,r){e[r].getMapList().forEach(function(e){t[r].addMap(e.clone())})})],CustomProceduralTexture.prototype,"mapManager",void 0),__decorate([e.cloneAttributeAsCloneable()],CustomProceduralTexture.prototype,"uniformMap",void 0),__decorate([e.cloneAttributeAsBasicType()],CustomProceduralTexture.prototype,"fsSource",void 0),__decorate([e.require(function(t){var r=e.LoaderManager.getInstance().get(t),n=r.uniforms;for(var i in n)if(n.hasOwnProperty(i)){var o=n[i];e.assert(o.type!==e.EVariableType.SAMPLER_CUBE,e.Log.info.FUNC_NOT_SUPPORT("uniforms","EVariableType.SAMPLER_CUBE type"))}}),e.ensure(function(){e.assert(null!==this.fsSource,e.Log.info.FUNC_SHOULD("read fragment glsl source"))})],CustomProceduralTexture.prototype,"read",null),CustomProceduralTexture}(e.ProceduralTexture);e.CustomProceduralTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function LightEffectTexture(){t.apply(this,arguments),this._plane=null}return __extends(LightEffectTexture,t),LightEffectTexture.prototype.getSamplerName=function(t){return this.getSamplerNameByVariableData(t,e.EVariableType.SAMPLER_2D)},LightEffectTexture.prototype.getPlane=function(){var t=null,r=null,n=null;return this._plane&&!this.geometry.entityObject.transform.dirtyLocal?this._plane:(e.Log.error(!(this.geometry instanceof e.PlaneGeometry),e.Log.info.FUNC_MUST_BE("geometry","PlaneGeometry")),t=this.geometry.geometryData.normals,r=this.geometry.entityObject.transform.localRotation.multiplyVector3(e.Vector3.create(t[0],t[1],t[2])).normalize(),n=this.getPosition(),this._plane=e.Plane.create(r.x,r.y,r.z,-n.dot(r)),this._plane)},LightEffectTexture}(e.TwoDRenderTargetTexture);e.LightEffectTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function MirrorTexture(){t.apply(this,arguments)}return __extends(MirrorTexture,t),MirrorTexture.create=function(){var e=new this;return e.initWhenCreate(),e},MirrorTexture.prototype.init=function(){return t.prototype.init.call(this),e.Director.getInstance().scene.addCommonRenderTargetRenderer(e.MirrorRenderTargetRenderer.create(this)),this},MirrorTexture}(e.LightEffectTexture);e.MirrorTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function RefractionTexture(){t.apply(this,arguments)}return __extends(RefractionTexture,t),RefractionTexture.create=function(){var e=new this;return e.initWhenCreate(),e},RefractionTexture.prototype.init=function(){return t.prototype.init.call(this),e.Director.getInstance().scene.addCommonRenderTargetRenderer(e.RefractionRenderTargetRenderer.create(this)),this},RefractionTexture}(e.LightEffectTexture);e.RefractionTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CubemapRenderTargetTexture(){t.apply(this,arguments),this.target=e.ETextureTarget.TEXTURE_CUBE_MAP}return __extends(CubemapRenderTargetTexture,t),CubemapRenderTargetTexture.prototype.createEmptyTexture=function(){var t=e.DeviceManager.getInstance().gl,r=t.createTexture(),n=null;for(this.setEmptyTexture(r),n=0;n<6;n++)t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,null);this.glTexture=r},CubemapRenderTargetTexture}(e.RenderTargetTexture);e.CubemapRenderTargetTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DynamicCubemapTexture(){t.apply(this,arguments),this._renderList=null,this.size=256,this.near=.1,this.far=100,this.mode=null}return __extends(DynamicCubemapTexture,t),DynamicCubemapTexture.create=function(){var e=new this;return e.initWhenCreate(),e},Object.defineProperty(DynamicCubemapTexture.prototype,"renderList",{get:function(){return this._renderList},set:function(t){var r=wdCb.Hash.create();t instanceof wdCb.Hash||(e.JudgeUtils.isDirectObject(t)?t=wdCb.Hash.create(t):e.Log.error(!0,e.Log.info.FUNC_MUST_BE("renderList","array or wdCb.Collection"))),t.forEach(function(t,n){e.JudgeUtils.isArrayExactly(t)?r.addChild(n,wdCb.Collection.create(t)):e.JudgeUtils.isCollection(t)?r.addChild(n,t):e.Log.error(!0,e.Log.info.FUNC_MUST_BE("faceRenderList","array or wdCb.Collection"))}),this._renderList=r},enumerable:!0,configurable:!0}),DynamicCubemapTexture.prototype.init=function(){return t.prototype.init.call(this),this.width=this.size,this.height=this.size,e.Director.getInstance().scene.addCommonRenderTargetRenderer(e.DynamicCubemapRenderTargetRenderer.create(this)),this},DynamicCubemapTexture.prototype.getSamplerName=function(t){return this.getSamplerNameByVariableData(t,e.EVariableType.SAMPLER_CUBE)},__decorate([e.cloneAttributeAsCustomType(function(e,t,r){var n=null;null!==e[r]&&(n=wdCb.Hash.create(),e[r].forEach(function(e,t){n.addChild(t,e.clone())}),t[r]=n)})],DynamicCubemapTexture.prototype,"renderList",null),__decorate([e.cloneAttributeAsBasicType()],DynamicCubemapTexture.prototype,"size",void 0),__decorate([e.cloneAttributeAsBasicType()],DynamicCubemapTexture.prototype,"near",void 0),__decorate([e.cloneAttributeAsBasicType()],DynamicCubemapTexture.prototype,"far",void 0),__decorate([e.cloneAttributeAsBasicType()],DynamicCubemapTexture.prototype,"mode",void 0),DynamicCubemapTexture}(e.CubemapRenderTargetTexture);e.DynamicCubemapTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function BasicTexture(){t.apply(this,arguments),this.p_sourceRegionMethod=null,this._sourceRegion=null,this.generateMipmaps=null,this.format=null,this.source=null,this.repeatRegion=null,this.sourceRegionMapping=null,this.packAlignment=null,this.unpackAlignment=null,this.flipY=null,this.premultiplyAlpha=null,this.isPremultipliedAlpha=null,this.colorspaceConversion=null,this.type=null,this.mipmaps=null,this.anisotropy=null,this._sourceRegionDirty=!1,this._sourceRegionForGLSLCache=null}return __extends(BasicTexture,t),Object.defineProperty(BasicTexture.prototype,"sourceRegionMethod",{get:function(){return this.p_sourceRegionMethod},set:function(e){this.p_sourceRegionMethod=e},enumerable:!0,configurable:!0}),Object.defineProperty(BasicTexture.prototype,"sourceRegion",{get:function(){return this._sourceRegion},set:function(e){this._sourceRegion=e,this._sourceRegionDirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(BasicTexture.prototype,"sourceRegionForGLSL",{get:function(){return this.sourceRegion&&this.sourceRegionMethod===e.ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL?this._convertSourceRegionToUV(this.sourceRegion):e.RectRegion.create(0,0,1,1)},enumerable:!0,configurable:!0}),BasicTexture.prototype.initWhenCreate=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];this.needUpdate=!0},BasicTexture.prototype.init=function(){if(null===this.glTexture){var t=e.DeviceManager.getInstance().gl;this.glTexture=t.createTexture()}},BasicTexture.prototype.dispose=function(){t.prototype.dispose.call(this),this._sourceRegionForGLSLCache=null},BasicTexture.prototype.update=function(){var t=e.DeviceManager.getInstance().gl,r=this.isSourcePowerOfTwo();return t.pixelStorei(t.PACK_ALIGNMENT,this.packAlignment),t.pixelStorei(t.UNPACK_ALIGNMENT,this.unpackAlignment),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,this.flipY),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,this.colorspaceConversion),this.needClampMaxSize()&&(this.clampToMaxSize(),r=this.isSourcePowerOfTwo(),r||e.Log.warn("texture size is not power of two after clampToMaxSize()")),this.setTextureParameters(t[this.target],r),this.allocateSourceToTexture(r),this.generateMipmaps&&r&&t.generateMipmap(t[this.target]),this.needUpdate=!1,this},BasicTexture.prototype.getSamplerName=function(t){return this.getSamplerNameByVariableData(t,e.EVariableType.SAMPLER_2D)},BasicTexture.prototype.needClampMaxSize=function(){return!!this.source&&e.BasicTextureUtils.needClampMaxSize(e.GPUDetector.getInstance().maxTextureSize,this.source.width,this.source.height)},BasicTexture.prototype.clampToMaxSize=function(){this.source=e.BasicTextureUtils.clampToMaxSize(this.source,e.GPUDetector.getInstance().maxTextureSize)},BasicTexture.prototype.setTextureParameters=function(e,r){t.prototype.setTextureParameters.call(this,e,r),this._setAnisotropy(e)},BasicTexture.prototype.isSourcePowerOfTwo=function(){return e.BasicTextureUtils.isSourcePowerOfTwo(this.sourceRegion,this.sourceRegionMethod,this.width,this.height)},BasicTexture.prototype._setAnisotropy=function(t){var r=e.GPUDetector.getInstance(),n=e.DeviceManager.getInstance().gl;r.extensionTextureFilterAnisotropic&&this.anisotropy>1&&n.texParameterf(t,r.extensionTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(this.anisotropy,r.maxAnisotropy))},BasicTexture.prototype._convertSourceRegionToUV=function(t){return this.sourceRegionMapping===e.ETextureSourceRegionMapping.CANVAS?e.GlobalTextureUtils.convertSourceRegionCanvasMapToUV(t,this.width,this.height):this.sourceRegionMapping===e.ETextureSourceRegionMapping.UV?t:void 0},__decorate([e.cloneAttributeAsBasicType()],BasicTexture.prototype,"sourceRegionMethod",null),__decorate([e.cloneAttributeAsCloneable()],BasicTexture.prototype,"sourceRegion",null),__decorate([e.cacheGetter(function(){return!this._sourceRegionDirty&&null!==this._sourceRegionForGLSLCache},function(){return this._sourceRegionForGLSLCache},function(e){this._sourceRegionForGLSLCache=e,this._sourceRegionDirty=!1})],BasicTexture.prototype,"sourceRegionForGLSL",null),__decorate([e.cloneAttributeAsBasicType()],BasicTexture.prototype,"generateMipmaps",void 0),__decorate([e.cloneAttributeAsBasicType()],BasicTexture.prototype,"format",void 0),__decorate([e.cloneAttributeAsBasicType()],BasicTexture.prototype,"source",void 0),__decorate([e.cloneAttributeAsCloneable()],BasicTexture.prototype,"repeatRegion",void 0),__decorate([e.cloneAttributeAsBasicType()],BasicTexture.prototype,"sourceRegionMapping",void 0),__decorate([e.cloneAttributeAsBasicType()],BasicTexture.prototype,"packAlignment",void 0),__decorate([e.cloneAttributeAsBasicType()],BasicTexture.prototype,"unpackAlignment",void 0),__decorate([e.cloneAttributeAsBasicType()],BasicTexture.prototype,"flipY",void 0),__decorate([e.cloneAttributeAsBasicType()],BasicTexture.prototype,"premultiplyAlpha",void 0),__decorate([e.cloneAttributeAsBasicType()],BasicTexture.prototype,"isPremultipliedAlpha",void 0),__decorate([e.cloneAttributeAsBasicType()],BasicTexture.prototype,"colorspaceConversion",void 0),__decorate([e.cloneAttributeAsBasicType()],BasicTexture.prototype,"type",void 0),
__decorate([e.cloneAttributeAsCloneable()],BasicTexture.prototype,"mipmaps",void 0),__decorate([e.cloneAttributeAsBasicType()],BasicTexture.prototype,"anisotropy",void 0),__decorate([e.require(function(t){var r=this;e.it("if repeat texture and draw part of texture by changing texcoords in glsl, warn",function(){e.BasicTextureUtils.isDrawPartOfTexture(r.sourceRegion,r.sourceRegionMethod)||!r.repeatRegion||r.repeatRegion.isEqual(e.Vector4.create(0,0,1,1))||e.Log.warn("the glsl->texCoord data may be wrong due to both repeating texture and drawing part of texture by changing texcoords in glsl")},this)})],BasicTexture.prototype,"update",null),__decorate([e.virtual],BasicTexture.prototype,"needClampMaxSize",null),BasicTexture}(e.Texture);e.BasicTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function TwoDTexture(e){t.call(this),this.asset=null,this.asset=e}return __extends(TwoDTexture,t),TwoDTexture.prototype.clone=function(){return e.CloneUtils.clone(this,null,[this.asset])},TwoDTexture.prototype.initWhenCreate=function(){t.prototype.initWhenCreate.call(this),this.asset.cloneTo(this)},TwoDTexture}(e.BasicTexture);e.TwoDTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CommonTexture(){t.apply(this,arguments)}return __extends(CommonTexture,t),CommonTexture.prototype.allocateSourceToTexture=function(t){var r=null,n=null,i=e.DeviceManager.getInstance().gl;t&&this.mipmaps.getCount()>0?(r=e.DrawMipmapTwoDTextureCommand.create(),r.mipmaps=this.mipmaps,r.format=this.format,r.type=this.type,r.sourceRegion=this.sourceRegion,r.sourceRegionMethod=this.sourceRegionMethod,r.glTarget=i.TEXTURE_2D,r.execute(),this.generateMipmaps=!1):(n=e.DrawNoMipmapTwoDTextureCommand.create(),n.source=this.source,n.format=this.format,n.type=this.type,n.sourceRegion=this.sourceRegion,n.sourceRegionMethod=this.sourceRegionMethod,n.glTarget=i.TEXTURE_2D,n.execute())},CommonTexture}(e.TwoDTexture);e.CommonTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ImageTexture(r){if(r instanceof e.ImageTextureAsset){var n=r;t.call(this,n)}else{var i=r;t.call(this,e.ImageTextureAsset.create(i))}}return __extends(ImageTexture,t),ImageTexture.create=function(e){var t=new this(e);return t.initWhenCreate(),t},ImageTexture}(e.CommonTexture);e.ImageTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CubemapTexture(r){t.call(this),this.assets=null,this.textures=wdCb.Collection.create(),this.mode=null,this.target=e.ETextureTarget.TEXTURE_CUBE_MAP,this._areAllCompressedAsset=!1,this.assets=r}return __extends(CubemapTexture,t),CubemapTexture.create=function(e){var t=new this(e);return t.initWhenCreate(e),t},CubemapTexture.prototype.clone=function(){var t=null;return t=null!==this.assets?[].concat(this.assets):null,e.CloneUtils.clone(this,null,[t])},CubemapTexture.prototype.initWhenCreate=function(e){t.prototype.initWhenCreate.call(this),this._areAssetsAllCompressedAsset(e)?this._areAllCompressedAsset=!0:this._areAllCompressedAsset=!1,this._createTextures(e),this._getRepresentAsset(e).cloneToCubemapTexture(this),this._areAllCompressedAsset?(this.generateMipmaps=!1,this._hasNoMipmapCompressedAsset()&&(this.minFilter=this.filterFallback(this.minFilter))):this.generateMipmaps=!0,this.flipY=!1},CubemapTexture.prototype.getSamplerName=function(t){return this.getSamplerNameByVariableData(t,e.EVariableType.SAMPLER_CUBE)},CubemapTexture.prototype.allocateSourceToTexture=function(e){this._areAllCompressedAsset?this.textures.forEach(function(e,t){e.draw(t)}):this.textures.forEach(function(e,t){e.draw(t)})},CubemapTexture.prototype.needClampMaxSize=function(){var e=!1;return this.textures.forEach(function(t){if(t.needClampMaxSize())return e=!0,wdCb.$BREAK}),e},CubemapTexture.prototype.isSourcePowerOfTwo=function(){var e=!0;return this.textures.forEach(function(t){if(!t.isSourcePowerOfTwo())return e=!1,wdCb.$BREAK}),e},CubemapTexture.prototype.clampToMaxSize=function(){this.textures.forEach(function(e){e.clampToMaxSize()})},CubemapTexture.prototype._hasNoMipmapCompressedAsset=function(){var e=this;return!!this._areAllCompressedAsset&&this.textures.filter(function(t){return!e._isMipmapFilter(t.minFilter)}).getCount()>0},CubemapTexture.prototype._isMipmapFilter=function(t){return t===e.ETextureFilterMode.LINEAR_MIPMAP_LINEAR||t===e.ETextureFilterMode.LINEAR_MIPMAP_NEAREST||t===e.ETextureFilterMode.NEAREST_MIPMAP_LINEAR||t===e.ETextureFilterMode.NEAREST_MIPMAP_MEAREST},CubemapTexture.prototype._getRepresentAsset=function(e){return e[0].asset},CubemapTexture.prototype._areAssetsAllImageAssets=function(t){for(var r=[],n=0,i=t;n<i.length;n++){var o=i[n];o.asset instanceof e.ImageTextureAsset&&r.push(o)}return 6===r.length},CubemapTexture.prototype._areAssetsAllCompressedAsset=function(t){for(var r=[],n=0,i=t;n<i.length;n++){var o=i[n];o.asset instanceof e.CompressedTextureAsset&&r.push(o)}return 6===r.length},CubemapTexture.prototype._createTextures=function(t){for(var r=this,n=0,i=t;n<i.length;n++){var o=i[n],a=o.asset.toCubemapFaceTexture();if(o.sourceRegion&&a instanceof e.CubemapFaceImageTexture){var s=a;s.sourceRegion=o.sourceRegion}o.type&&(a.type=o.type),r.textures.addChild(a)}},CubemapTexture.prototype._areTextureSizOfAllFaceseEqual=function(e){for(var t=[],r=[],n=0,i=e;n<i.length;n++){var o=i[n];o.sourceRegion?(t.push(o.sourceRegion.width),r.push(o.sourceRegion.height)):(t.push(o.asset.width),r.push(o.asset.height))}return this._areAllElementsEqual(t)&&this._areAllElementsEqual(r)},CubemapTexture.prototype._hasSourceRegion=function(e){for(var t=0,r=e;t<r.length;t++){var n=r[t];if(n.sourceRegion)return!0}return!1},CubemapTexture.prototype._areAllElementsEqual=function(e){for(var t=e[0],r=0,n=e;r<n.length;r++){var i=n[r];if(i!==t)return!1}return!0},__decorate([e.cloneAttributeAsBasicType()],CubemapTexture.prototype,"mode",void 0),__decorate([e.require(function(t){e.assert(6===t.length,e.Log.info.FUNC_MUST("cubemap","has 6 assets")),e.assert(this._areAssetsAllImageAssets(t)||this._areAssetsAllCompressedAsset(t),e.Log.info.FUNC_MUST_BE("cubemap six face's assets","all ImageTextureAsset or all CompressedTextureAsset")),this._areAssetsAllCompressedAsset(t)&&e.assert(!this._hasSourceRegion(t),e.Log.info.FUNC_SHOULD_NOT("compressed face","contain sourceRegion data")),e.assert(this._areTextureSizOfAllFaceseEqual(t),e.Log.info.FUNC_MUST_BE("all cubemap faces' texture size","equal"))})],CubemapTexture.prototype,"initWhenCreate",null),CubemapTexture}(e.BasicTexture);e.CubemapTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(){function CubemapFaceTexture(){this.type=e.ETextureType.UNSIGNED_BYTE,this.format=null,this.width=null,this.height=null}return CubemapFaceTexture}();e.CubemapFaceTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CubemapFaceImageTexture(){t.apply(this,arguments),this.sourceRegion=null,this.source=null}return __extends(CubemapFaceImageTexture,t),CubemapFaceImageTexture.create=function(e){var t=new this;return t.initWhenCreate(e),t},Object.defineProperty(CubemapFaceImageTexture.prototype,"sourceRegionMethod",{get:function(){return e.ETextureSourceRegionMethod.DRAW_IN_CANVAS},set:function(e){},enumerable:!0,configurable:!0}),CubemapFaceImageTexture.prototype.initWhenCreate=function(e){e.cloneToCubemapFaceTexture(this)},CubemapFaceImageTexture.prototype.isSourcePowerOfTwo=function(){return e.BasicTextureUtils.isSourcePowerOfTwo(this.sourceRegion,this.sourceRegionMethod,this.width,this.height)},CubemapFaceImageTexture.prototype.needClampMaxSize=function(){return!!this.source&&e.BasicTextureUtils.needClampMaxSize(e.GPUDetector.getInstance().maxCubemapTextureSize,this.source.width,this.source.height)},CubemapFaceImageTexture.prototype.clampToMaxSize=function(){var t=e.GPUDetector.getInstance().maxCubemapTextureSize;this.source=e.BasicTextureUtils.clampToMaxSize(this.source,t)},CubemapFaceImageTexture.prototype.draw=function(t){var r=e.DrawNoMipmapTwoDTextureCommand.create(),n=e.DeviceManager.getInstance().gl;r.source=this.source,r.sourceRegion=this.sourceRegion,r.sourceRegionMethod=this.sourceRegionMethod,r.glTarget=n.TEXTURE_CUBE_MAP_POSITIVE_X+t,r.format=this.format,r.type=this.type,r.execute()},__decorate([e.requireSetter(function(t){e.assert(t===e.ETextureSourceRegionMethod.DRAW_IN_CANVAS,e.Log.info.FUNC_SUPPORT("cubemap twoD face texture->sourceRegionMethod only","DRAW_IN_CANVAS"))})],CubemapFaceImageTexture.prototype,"sourceRegionMethod",null),CubemapFaceImageTexture}(e.CubemapFaceTexture);e.CubemapFaceImageTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CubemapFaceCompressedTexture(){t.apply(this,arguments),this.mipmaps=null,this.minFilter=null}return __extends(CubemapFaceCompressedTexture,t),CubemapFaceCompressedTexture.create=function(e){var t=new this;return t.initWhenCreate(e),t},CubemapFaceCompressedTexture.prototype.initWhenCreate=function(e){e.cloneToCubemapFaceTexture(this)},CubemapFaceCompressedTexture.prototype.isSourcePowerOfTwo=function(){return e.BasicTextureUtils.isSourcePowerOfTwo(null,null,this.width,this.height)},CubemapFaceCompressedTexture.prototype.needClampMaxSize=function(){return e.BasicTextureUtils.needClampMaxSize(e.GPUDetector.getInstance().maxCubemapTextureSize,this.width,this.height)},CubemapFaceCompressedTexture.prototype.clampToMaxSize=function(){e.Log.warn("CubemapFaceCompressedTexture's texture size is over maxCubemapTextureSize")},CubemapFaceCompressedTexture.prototype.draw=function(t){var r=e.DrawCompressedTextureCommand.create(),n=e.DeviceManager.getInstance().gl;r.glTarget=n.TEXTURE_CUBE_MAP_POSITIVE_X+t,r.type=this.type,r.format=this.format,r.mipmaps=this.mipmaps,r.execute()},CubemapFaceCompressedTexture}(e.CubemapFaceTexture);e.CubemapFaceCompressedTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CompressedTexture(){t.apply(this,arguments)}return __extends(CompressedTexture,t),CompressedTexture.create=function(e){var t=new this(e);return t.initWhenCreate(),t},Object.defineProperty(CompressedTexture.prototype,"sourceRegionMethod",{get:function(){return e.ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL},set:function(e){this.p_sourceRegionMethod=e},enumerable:!0,configurable:!0}),CompressedTexture.prototype.allocateSourceToTexture=function(t){var r=e.DeviceManager.getInstance().gl,n=e.DrawCompressedTextureCommand.create();n.glTarget=r.TEXTURE_2D,n.type=this.type,n.format=this.format,n.mipmaps=this.mipmaps,n.sourceRegion=this.sourceRegion,n.sourceRegionMethod=this.sourceRegionMethod,n.execute(),this.mipmaps.getCount()>1&&(this.generateMipmaps=!1)},CompressedTexture.prototype.needClampMaxSize=function(){return!1},__decorate([e.ensureGetter(function(t){e.it("compressed texture not support ETextureSourceRegionMethod.DRAW_IN_CANVAS, will use ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL instead",function(){e.expect(this.p_sourceRegionMethod).not.to.equal(e.ETextureSourceRegionMethod.DRAW_IN_CANVAS),e.expect(t).to.equal(e.ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL)},this)})],CompressedTexture.prototype,"sourceRegionMethod",null),CompressedTexture}(e.TwoDTexture);e.CompressedTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(){function DrawTextureCommand(){this.format=null,this.type=null,this.sourceRegion=null,this.sourceRegionMethod=e.ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL,this.glTarget=null}return DrawTextureCommand.prototype.getDrawTarget=function(t,r){void 0===r&&(r=this.sourceRegion);var n=null;return n=e.BasicTextureUtils.isDrawPartOfTexture(r,this.sourceRegionMethod)?e.BasicTextureUtils.drawPartOfTextureByCanvas(t,r.width,r.height,r.x,r.y,r.width,r.height,0,0,r.width,r.height):t},DrawTextureCommand}();e.DrawTextureCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DrawCompressedTextureCommand(){t.apply(this,arguments),this.mipmaps=null}return __extends(DrawCompressedTextureCommand,t),DrawCompressedTextureCommand.create=function(){var e=new this;return e},DrawCompressedTextureCommand.prototype.execute=function(){var t=e.DeviceManager.getInstance().gl,r=this;e.Log.error(null===this.format,e.Log.info.FUNC_NOT_SUPPORT(this.format)),this.format!==e.ETextureFormat.RGBA?this.mipmaps.forEach(function(e,n){t.compressedTexImage2D(r.glTarget,n,r.format,e.width,e.height,0,r.getDrawTarget(e.data))}):this.mipmaps.forEach(function(e,n){t.texImage2D(r.glTarget,n,t[r.format],e.width,e.height,0,t[r.format],t[r.type],r.getDrawTarget(e.data))})},DrawCompressedTextureCommand}(e.DrawTextureCommand);e.DrawCompressedTextureCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DrawTwoDTextureCommand(){t.apply(this,arguments),this.source=null}return __extends(DrawTwoDTextureCommand,t),DrawTwoDTextureCommand.prototype.drawTexture=function(t,r){var n=e.DeviceManager.getInstance().gl;n.texImage2D(this.glTarget,t,n[this.format],n[this.format],n[this.type],this.getDrawTarget(r))},DrawTwoDTextureCommand}(e.DrawTextureCommand);e.DrawTwoDTextureCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function DrawMipmapTwoDTextureCommand(){e.apply(this,arguments),this.mipmaps=null}return __extends(DrawMipmapTwoDTextureCommand,e),DrawMipmapTwoDTextureCommand.create=function(){var e=new this;return e},DrawMipmapTwoDTextureCommand.prototype.execute=function(){var e=this;this.mipmaps.forEach(function(t,r){e.drawTexture(r,t)})},DrawMipmapTwoDTextureCommand}(e.DrawTwoDTextureCommand);e.DrawMipmapTwoDTextureCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function DrawNoMipmapTwoDTextureCommand(){e.apply(this,arguments)}return __extends(DrawNoMipmapTwoDTextureCommand,e),DrawNoMipmapTwoDTextureCommand.create=function(){var e=new this;return e},DrawNoMipmapTwoDTextureCommand.prototype.execute=function(){this.drawTexture(0,this.source)},DrawNoMipmapTwoDTextureCommand}(e.DrawTwoDTextureCommand);e.DrawNoMipmapTwoDTextureCommand=t}(wd||(wd={}));var wd;!function(e){e.root=null,e.RSVP=null,e.expect=null,e.JudgeUtils.isNodeJs()&&"undefined"!=typeof global?e.root=global:e.root=window,e.root.RSVP?e.RSVP=e.root.RSVP:e.RSVP=e.root,e.root.chai&&(e.expect=e.root.chai.expect)}(wd||(wd={}));var wd;!function(e){!function(e){e[e.NONE=0]="NONE",e[e.PCF=1]="PCF"}(e.EShadowMapSoftType||(e.EShadowMapSoftType={}));e.EShadowMapSoftType}(wd||(wd={}));var wd;!function(e){var t=function(){function GlobalTempMathClass(){}return GlobalTempMathClass.Vector3_1=e.Vector3.create(0,0,0),GlobalTempMathClass.Vector3_Scale_1=e.Vector3.create(1,1,1),GlobalTempMathClass.Quaternion_1=e.Quaternion.create(0,0,0,1),GlobalTempMathClass}();e.GlobalTempMathClass=t}(wd||(wd={}));