<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>run test</title>
</head>

<body>
    <script src="../e2e/js/AssetTool.js"></script>
    <script src="../e2e/js/ReplaceFetchTool.js"></script>
    <script src="../e2e/js/ScheduleTool.js"></script>
    <script src="../e2e/js/BasicBoxesTool.js"></script>
    <script src="../e2e/js/LightBoxesTool.js"></script>
    <script src="../e2e/js/PositionTool.js"></script>
    <script src="../e2e/js/LightTool.js"></script>
    <script src="../e2e/js/CameraTool.js"></script>
    <script src="../e2e/js/GeometryTool.js"></script>
    <script src="../e2e/js/BasicMaterialTool.js"></script>
    <script src="../e2e/js/LightMaterialTool.js"></script>
    <script src="../e2e/js/InstanceBasicBoxesTool.js"></script>
    <script src="../e2e/js/InstanceLightBoxesTool.js"></script>
    <script src="../e2e/js/RedoUndoTool.js"></script>
    <script src="../e2e/js/RandomTool.js"></script>
    <script src="../../dist/wd.js"></script>
    <script>
        window.onload = function () {
            ReplaceFetchTool.replaceFetchForTest();


            return AssetTool.loadConfig(["./data/setting.json", "./data/"], null, function () {


                AssetTool.loadIMGUIAsset("../res/font/Lato-Regular-64.fnt", "../res/font/lato.png",
                    [
                        ["./1.png", "1"],
                        ["./2.jpg", "2"]
                    ],
                    wd.unsafeGetState(), function (state) {












                        return AssetTool.loadStreamWDB(
                            // "../res/wdb/CesiumMilkTruck.wdb",
                            // "../res/wdb/BoxTextured.wdb",
                            // "../res/wdb/AlphaBlendModeTest.wdb",
                            "../res/wdb/Scene1.wdb",

                            // "https://wonder-technology.github.io/wonder-demo.github.io/demo/engine/asset/wdb/BoxTextured.wdb",
                            // "https://wonder-technology.github.io/wonder-demo.github.io/demo/engine/asset/wdb/CesiumMilkTruck.wdb",
                            // "https://wonder-technology.github.io/wonder-demo.github.io/demo/engine/asset/wdb/AlphaBlendModeTest.wdb",


                            // wd.unsafeGetState(), function (state, gameObject) {
                            state, function (state, gameObject) {
                                return handleBeforeStartLoop(state, gameObject);
                            }, function (state, gameObject) {
                                return state;
                            });
                    })
            });


            function _createLightsAndCamera(isCreateCamera, state) {
                var state = LightTool.setAmbientLight(state);



                var record = LightTool.createDirectionLight(state);
                var state = record[0];
                var directionLightObj = record[1];



                var transform = wd.unsafeGetGameObjectTransformComponent(directionLightObj, state);

                state = wd.setTransformLocalPosition(transform, [-10, 0, 20], state);



                var light = wd.unsafeGetGameObjectDirectionLightComponent(directionLightObj, state);

                var state = wd.setDirectionLightColor(light, [1.0, 1.0, 1.0], state);




                var record = LightTool.createPointLight(state);
                var state = record[0];
                var pointLightObj = record[1];



                var transform = wd.unsafeGetGameObjectTransformComponent(pointLightObj, state);

                state = wd.setTransformLocalPosition(transform, [5, 0, 25], state);



                if (isCreateCamera) {

                    var data = LightBoxesTool.createCamera(state);
                    var state = data[0];
                    var camera = data[1];


                    var transform = wd.unsafeGetGameObjectTransformComponent(camera, state);

                    // state = wd.setTransformLocalPosition(transform, [0, 5, 10], state);




                    var [state, cameraController] = wd.createArcballCameraController(state);

                    var state =
                        wd.setArcballCameraControllerDistance(cameraController, 50, state);

                    var state =
                        wd.bindArcballCameraControllerEvent(
                            cameraController, state
                        );


                    var state = wd.addGameObjectArcballCameraControllerComponent(camera, cameraController, state);




                    var state =
                        wd.activeBasicCameraView(
                            wd.unsafeGetGameObjectBasicCameraViewComponent(
                                camera, state
                            ), state
                        );
                }

                return [state, directionLightObj, pointLightObj]
            }

            function handleBeforeStartLoop(state, gameObject) {
                var isCreateLight =
                    wd.getAllDirectionLightComponents(state).length === 0 && wd.getAllPointLightComponents(state).length === 0;

                var isCreateCamera =
                    wd.getAllBasicCameraViewComponents(state).length === 0;

                var state = state;

                if (isCreateLight) {
                    var data = _createLightsAndCamera(isCreateCamera, state);
                    state = data[0];
                }

                return state;
            }

        };
    </script>
</body>

</html>