<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>cube</title>
</head>

<body>
    <script src="../../test/e2e/js/AssetTool.js"></script>
    <script src="../../test/e2e/js/LightBoxesTool.js"></script>
    <script src="../../test/e2e/js/PositionTool.js"></script>
    <script src="../../test/e2e/js/LightTool.js"></script>
    <script src="../../test/e2e/js/CameraTool.js"></script>
    <script src="../../test/e2e/js/LightMaterialTool.js"></script>
    <script src="../../dist/wd.js"></script>

    <script>

        function _convertBase64ToBinary(dataURI) {
            var BASE64_MARKER = ';base64,';

            var base64Index = dataURI.indexOf(BASE64_MARKER) + BASE64_MARKER.length;
            var base64 = dataURI.substring(base64Index);
            var raw = window.atob(base64);
            var rawLength = raw.length;
            var array = new Uint8Array(new ArrayBuffer(rawLength));

            for (var i = 0; i < rawLength; i++) {
                array[i] = raw.charCodeAt(i);
            }
            return array;
        };

        function _convertImageToBase64(image, mimeType) {
            var width = image.width;
            var height = image.height;


            var canvas = document.createElement("canvas");
            var ctx = canvas.getContext("2d");
            var dataURL = null;
            canvas.height = width;
            canvas.width = height;
            ctx.drawImage(image, 0, 0);
            return canvas.toDataURL(mimeType);
        };

        function _convertImageToUint8Array(image, mimeType) {
            var base64 =
                _convertImageToBase64(image, mimeType);

            return _convertBase64ToBinary(base64);
        };

        window.onload = function () {
            return AssetTool.loadConfig(["../config/setting.json", "../config/"], null, function () {


                var image = new Image();
                image.src = "../asset/image/2.png";

                image.onload = function () {
                    var imageName = "image_2";
                    var mimeType = "image/png";

                    image.name = imageName;


                    return initSample(
                        image,
                        imageName,
                        _convertImageToUint8Array(image, mimeType),
                        mimeType,
                        wd.unsafeGetState());

                };




            });


            function createSphere(texture1, state) {
                var record = wd.createLightMaterial(state);
                var state = record[0];
                var material = record[1];

                state = wd.setLightMaterialDiffuseColor(material, [1.0, 0.5, 0.2], state);
                state = wd.setLightMaterialSpecularColor(material, [0.3, 0.1, 0.6], state);

                state = wd.setLightMaterialDiffuseMap(material, texture1, state);


                var record = wd.createMeshRenderer(state);
                var state = record[0];
                var meshRenderer = record[1];

                var record = wd.createGameObject(state);
                var state = record[0];
                var obj = record[1];

                state = wd.addGameObjectLightMaterialComponent(obj, material, state);
                state = wd.addGameObjectMeshRendererComponent(obj, meshRenderer, state);


                var record = wd.createSphereGeometry(5.0, 5, state);
                var state = record[0];
                var geometry = record[1];
                var geometryName = "sphereGeometry";
                var state =
                    wd.setGeometryName(
                        geometry, geometryName, state
                    );




                state = wd.addGameObjectGeometryComponent(obj, geometry, state);




                var transform = wd.unsafeGetGameObjectTransformComponent(obj, state);

                state = wd.setTransformLocalPosition(transform, [0, 20, 0], state);




                return [state, obj, geometry];
            }



            function initSample(image, imageName,
                imageUint8Array,
                mimeType,
                state) {

                var [state, box] = LightBoxesTool.createBox(state);


                var record = wd.createBasicSourceTexture(state)
                var state = record[0];
                var texture1 = record[1];
                var textureName = "texture1";
                var state =
                    wd.setBasicSourceTextureName(
                        texture1, textureName, state
                    );
                var state = wd.setBasicSourceTextureSource(texture1, image, state);



                var [state, sphere, sphereGeometry] = createSphere(texture1, state);


                var state = wd.setAmbientLightColor([0.2, 0.2, 0.2], state);


                var [state, directionLightGameObject] = LightTool.createDirectionLight(state);

                var transform = wd.unsafeGetGameObjectTransformComponent(directionLightGameObject, state);

                var state = wd.setTransformLocalEulerAngles(transform, [0, 180, 0], state);




                var [state, cameraGameObject] = LightBoxesTool.createCamera(state);



                var [state, cameraController] = wd.createArcballCameraController(state);

                var state =
                    wd.setArcballCameraControllerDistance(cameraController, 50, state);



                var state =
                    wd.setArcballCameraControllerWheelSpeed(cameraController, 1, state);

                var state = wd.addGameObjectArcballCameraControllerComponent(cameraGameObject, cameraController, state);


                var state =
                    wd.bindArcballCameraControllerEvent(
                        cameraController, state
                    );

                var state = wd.addSceneChildren(
                    [
                        sphere,
                        box,
                        cameraGameObject,
                        directionLightGameObject
                    ],
                    state
                );


                wd.startDirector(state);




                setTimeout(() => {
                    var state = wd.unsafeGetState();




                    var [state, rab] =
                        wd.generateSingleRAB(
                            wd.buildResourceData(
                                [],
                                [],
                                [
                                    [
                                        texture1,
                                        0
                                    ]
                                ],
                                [
                                    sphereGeometry
                                ],
                                [],
                                [],
                                [
                                    [
                                        imageUint8Array,
                                        imageName, mimeType
                                    ]
                                ],
                            ),
                            state
                        );









                    var [state, sab] =
                        wd.generateSingleSAB(
                            wd.getSceneGameObject(state),
                            [],
                            state
                        );

                    var rabRelativePath = "rab1.rab";
                    var sabRelativePath = "sab1.sab";

                    wd.setState(state);

                    wd.generateAllABs(
                        wd.buildDependencyRelation(
                            [
                                [
                                    sabRelativePath,
                                    rabRelativePath,

                                ]
                            ]
                        ),
                        [
                            [[
                                sabRelativePath, sab
                            ]],
                            [[
                                rabRelativePath, rab
                            ]],
                        ]
                    )
                        .subscribe(
                            {
                                "next": (
                                    [
                                        wab,
                                        newRabDataArr,
                                        newSabDataArr
                                    ]
                                ) => {
                                    console.log("next",
                                        wab,
                                        newRabDataArr,
                                        newSabDataArr
                                    );



                                    AssetTool.download(
                                        wab,

                                        "wab1.wab",
                                    );


                                    AssetTool.download(
                                        newRabDataArr[0][1],

                                        "newRAB1.rab",
                                    );


                                    AssetTool.download(
                                        newSabDataArr[0][1],

                                        "newSAB1.sab",
                                    );

                                },
                                "error": e => {
                                    console.log("error", e);
                                },
                                "complete": () => {
                                    console.log("complete");
                                },
                            }
                        )



                }, 500)
            }
        };
    </script>
</body>

</html>